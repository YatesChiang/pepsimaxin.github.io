<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="全面解析 Android 应用问题 之 ANR, Hexo">
    <meta name="description" content="
不管是系统开发还是应用开发，ANR 一直是挥之不去的存在！本文从 ANR 的触发机制以及一个简单的范例来探讨 ANR 的原理和处理方法！


开篇核心源码


关键类
路径




ActiveServices.java
framewor">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>全面解析 Android 应用问题 之 ANR | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/四大组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/启动阶段/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/通信机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>机制</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>拓展</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术细节/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/四大组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/启动阶段/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/通信机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                机制
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                拓展
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        <li>
            <a href="/categories/技术细节/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('http://poobjb5p7.bkt.clouddn.com/ANR%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        全面解析 Android 应用问题 之 ANR
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ANR/" target="_blank">
                                <span class="chip bg-color">ANR</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/性能优化/" class="post-category" target="_blank">
                                性能优化
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2018-08-26
                </div>

                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p><strong><font color="#AAAAAA">不管是系统开发还是应用开发，ANR 一直是挥之不去的存在！本文从 ANR 的触发机制以及一个简单的范例来探讨 ANR 的原理和处理方法！</font></strong></p>
</blockquote>
<hr>
<h1 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h1><h2 id="核心源码"><a href="#核心源码" class="headerlink" title="核心源码"></a>核心源码</h2><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">ActiveServices.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ActivityManagerService.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</td>
</tr>
<tr>
<td><font color="#D15FEE">AppErrors.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/AppErrors.java</td>
</tr>
<tr>
<td><font color="#D15FEE">BroadcastQueue.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java</td>
</tr>
</tbody>
</table>
<h1 id="ANR概述"><a href="#ANR概述" class="headerlink" title="ANR概述"></a>ANR概述</h1><h2 id="ANR是什么？"><a href="#ANR是什么？" class="headerlink" title="ANR是什么？"></a>ANR是什么？</h2><p><strong><font color="#FF00FF">ANR(Application Not Responding)</font></strong>，应用程序无响应，简单一个定义，却涵盖了很多Android系统的设计思想。</p>
<p>首先，<font color="#FF0000">ANR属于应用程序的范畴，这不同于SNR(System Not Respoding)，SNR反映的问题是系统进程(system_server)失去了响应能力，而ANR明确将问题圈定在应用程序</font>。SNR由Watchdog机制保证，ANR由消息处理机制保证，Android在系统层实现了一套精密的机制来发现ANR，核心原理是消息调度和超时处理。</p>
<p>其次，ANR机制主体实现在系统层。所有与ANR相关的消息，都会经过系统进程(system_server)调度，然后派发到应用进程完成对消息的实际处理，同时，系统进程设计了不同的超时限制来跟踪消息的处理。一旦应用程序处理消息不当，超时限制就起作用了，它收集一些系统状态，例如：CPU/IO使用情况、进程函数调用栈，并且报告用户有进程无响应了(ANR对话框)。</p>
<p>然后，ANR问题本质是一个性能问题。ANR机制实际上对应用程序主线程的限制，要求主线程在限定的时间内处理完一些最常见的操作(启动服务、处理广播、处理输入)，如果处理超时，则认为主线程已经失去了响应其他操作的能力。主线程中的耗时操作，例如：密集CPU运算、大量IO、复杂界面布局等，都会降低应用程序的响应能力。</p>
<p>最后，部分ANR问题是很难分析的，有时候由于系统底层的一些影响，导致消息调度失败，出现问题的场景又难以复现。这类ANR问题往往需要花费大量的时间去了解系统的一些行为，超出了ANR机制本身的范畴。</p>
<h2 id="ANR机制"><a href="#ANR机制" class="headerlink" title="ANR机制"></a>ANR机制</h2><p>分析一些初级的ANR问题，只需要简单理解最终输出的日志即可，但对于一些由系统问题(例如：CPU负载过高、进程卡死)引发的ANR，就需要对整个ANR机制有所了解，才能定位出问题的原因。</p>
<p><strong><font color="#7FF000" size="3">ANR机制可以分为两部分：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 ANR的监测。Android对于不同的ANR类型(Broadcast, Service, InputEvent)都有一套监测机制。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 ANR的报告。在监测到ANR以后，需要显示ANR对话框、输出日志(发生ANR时的进程函数调用栈、CPU使用情况等)。</p>
<h2 id="ANR的触发原因"><a href="#ANR的触发原因" class="headerlink" title="ANR的触发原因"></a>ANR的触发原因</h2><p>出现ANR之后一个直观现象就是系统会展示出一个ANR对话框。</p>
<p><strong><font color="#7FF000" size="3">谷歌文档中对ANR产生的原因是这么描述的：</font></strong></p>
<p>Android系统中的应用被Activity Manager及Window Manager两个系统服务监控着，Android系统会在如下两种情况展示出ANR的对话框<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 KeyDispatchTimeout(<font color="#FF0000"> 5 seconds</font> ) ：按键或触摸事件在特定时间内无响应<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 BroadcastTimeout(<font color="#FF0000"> 10 seconds</font> )：BroadcastReceiver 在特定时间内无法处理完成<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 ServiceTimeout(<font color="#FF0000"> 20 seconds</font> ) ：Service 在特定的时间内无法处理完成</p>
<h1 id="ANR的监测机制"><a href="#ANR的监测机制" class="headerlink" title="ANR的监测机制"></a>ANR的监测机制</h1><h2 id="Service超时处理"><a href="#Service超时处理" class="headerlink" title="Service超时处理"></a>Service超时处理</h2><p>Service 运行在应用程序的主线程，如果 Service 的执行时间超过20秒，则会引发 ANR。</p>
<p>当发生 Service ANR 时，一般可以先排查一下在 Service 的生命周期函数中(onCreate(), onStartCommand()等)有没有做耗时的操作，例如复杂的运算、IO操作等。如果应用程序的代码逻辑查不出问题，就需要深入检查当前系统的状态：CPU的使用情况、系统服务的状态等，判断当时发生ANR进程是否受到系统运行异常的影响。</p>
<p>如何检测Service超时呢？Android是通过设置定时消息实现的。定时消息是由AMS的消息队列处理的(system_server的ActivityManager线程)。AMS有Service运行的上下文信息，所以在AMS中设置一套超时检测机制也是合情合理的。</p>
<p>Service ANR机制相对最为简单，主体实现在<font color="#FF00FF"> ActiveServices </font>中。 当Service的生命周期开始时， <font color="#FF00FF">bumpServiceExecutingLocked()</font> 会被调用：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fg<span class="token punctuation">,</span> String why<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>executeFg <span class="token operator">=</span> fg<span class="token punctuation">;</span>
            ServiceState stracker <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stracker <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stracker<span class="token punctuation">.</span><span class="token function">setExecuting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">.</span><span class="token function">getMemFactorLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">|=</span> fg<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> fg <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 调用scheduleServiceTimeoutLocked()</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>executeFg <span class="token operator">|=</span> fg<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>executeNesting<span class="token operator">++</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>executingStart <span class="token operator">=</span> now<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>紧接着会调用 <font color="#FF00FF">scheduleServiceTimeoutLocked()</font> ：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>ProcessRecord proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Message msg <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
                ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> proc<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 通过AMS.MainHandler抛出一个定时消息</span>
        mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>
                proc<span class="token punctuation">.</span>execServicesFg <span class="token operator">?</span> SERVICE_TIMEOUT <span class="token operator">:</span> SERVICE_BACKGROUND_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/// M: ANR Debug Mechanism</span>
        mAm<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">sendServiceMonitorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>上述方法通过 <font color="#FF00FF">AMS.MainHandler</font> 抛出一个定时消息 <font color="#FF00FF">SERVICE_TIMEOUT_MSG<font> ：</font></font></p>
<font color="#7FF000" size="3">前台进程中执行Service，超时时间是SERVICE_TIMEOUT(20秒)</font>

<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_TIMEOUT <span class="token operator">=</span> <span class="token number">20</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre>
<font color="#7FF000" size="3">后台进程中执行Service，超时时间是SERVICE_BACKGROUND_TIMEOUT(200秒)</font>

<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_BACKGROUND_TIMEOUT <span class="token operator">=</span> SERVICE_TIMEOUT <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre>
<p>当 Service 的生命周期结束时，会调用 <font color="#FF00FF">serviceDoneExecutingLocked()</font> 方法，之前抛出的 <font color="#FF00FF">SERVICE_TIMEOUT_MSG</font> 消息在这个方法中会被清除。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">,</span> <span class="token keyword">int</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> inDestroying <span class="token operator">=</span> mDestroyingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> inDestroying<span class="token punctuation">,</span> inDestroying<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inDestroying<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>如果在超时时间内， <font color="#FF00FF">SERVICE_TIMEOUT_MSG</font> 没有被清除，那么， <font color="#FF00FF">AMS.MainHandler</font> 就会响应这个消息：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MainHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">MainHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">case</span> SERVICE_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">/// M: ANR Debug Mechanism @{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mAnrManager<span class="token punctuation">.</span><span class="token function">delayMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> SERVICE_TIMEOUT_MSG<span class="token punctuation">,</span>
                        ActiveServices<span class="token punctuation">.</span>SERVICE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/// @}</span>
                mServices<span class="token punctuation">.</span><span class="token function">serviceTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ProcessRecord<span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">serviceTimeout</span><span class="token punctuation">(</span>ProcessRecord proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String anrMessage <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mAm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> maxTime <span class="token operator">=</span>  now <span class="token operator">-</span>
                    <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>execServicesFg <span class="token operator">?</span> SERVICE_TIMEOUT <span class="token operator">:</span> SERVICE_BACKGROUND_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceRecord timeout <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">long</span> nextTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 寻找运行超时的Service</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ServiceRecord sr <span class="token operator">=</span> proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sr<span class="token punctuation">.</span>executingStart <span class="token operator">&lt;</span> maxTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    timeout <span class="token operator">=</span> sr<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sr<span class="token punctuation">.</span>executingStart <span class="token operator">></span> nextTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextTime <span class="token operator">=</span> sr<span class="token punctuation">.</span>executingStart<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 判断执行Service超时的进程是否在最近运行进程列表，如果不在，则忽略这个ANR</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mAm<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Timeout executing service: "</span> <span class="token operator">+</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                StringWriter sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PrintWriter pw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastPrintWriter</span><span class="token punctuation">(</span>sw<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                timeout<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>pw<span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mLastAnrDump <span class="token operator">=</span> sw<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mLastAnrDumpClearer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mLastAnrDumpClearer<span class="token punctuation">,</span> LAST_ANR_LIFETIME_DURATION_MSECS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                anrMessage <span class="token operator">=</span> <span class="token string">"executing service "</span> <span class="token operator">+</span> timeout<span class="token punctuation">.</span>shortName<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>anrMessage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAm<span class="token punctuation">.</span>mAppErrors<span class="token punctuation">.</span><span class="token function">appNotResponding</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> anrMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>上述方法会找到当前进程已经超时的 Service ，经过一些判定后，决定要报告 ANR ，最终调用 <font color="#FF00FF">AMS.appNotResponding()</font> 方法。</p>
<p>走到这一步，ANR 机制已经完成了监测报告任务，剩下的任务就是 ANR 结果的输出，我们称之为 ANR 的报告机制。ANR 的报告机制是通过 <font color="#FF00FF">AMS.appNotResponding()</font> 完成的，Broadcast 和 InputEvent 类型的 ANR 最终也都会调用这个方法。</p>
<h2 id="Broadcast超时处理"><a href="#Broadcast超时处理" class="headerlink" title="Broadcast超时处理"></a>Broadcast超时处理</h2><p>应用程序可以注册广播接收器，实现 BroadcastReceiver.onReceive() 方法来完成对广播的处理。通常，这个方法是在主线程执行的，Android 限定它执行时间不能超过10秒，否则，就会引发 ANR。</p>
<p>onReceive()也可以调度在其他线程执行，通过 Context.registerReceiver(BroadcastReceiver, IntentFilter, String, Handler) 这个方法注册广播接收器，可以指定一个处理的 Handler，将 onReceive() 调度在非主线程执行。</p>
<p><strong><font color="#7FF000" size="3">这边我们先抛出两个问题：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 Android如何将广播投递给各个应用程序？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 Android如何检测广播处理超时？</p>
<h3 id="广播消息的调度"><a href="#广播消息的调度" class="headerlink" title="广播消息的调度"></a>广播消息的调度</h3><p>AMS维护了两个广播队列BroadcastQueue:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 foreground queue，前台队列的超时时间是10秒<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 background queue，后台队列的超时时间是60秒</p>
<p>之所以有两个，就是因为要区分不同超时时间。所有发送的广播都会进入到队列中等待调度，在发送广播时，可以通过 <font color="#FF00FF">Intent.FLAG_RECEIVER_FOREGROUND</font> 参数将广播投递到前台队列。</p>
<p>AMS线程会不断地从队列中取出广播消息派发到各个接收器(BroadcastReceiver)。当要派发广播时，AMS 会调用 <font color="#FF00FF">BroadcastQueue.scheduleBroadcastsLocked()</font> 方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBroadcastsScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_INTENT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>上述方法中，往AMS线程的消息队列发送BROADCAST_INTENT_MSG消息，由此也可以看到真正派发广播的是AMS线程(system_server进程中的ActivityManager线程)。由于上述方法可能被并发调用，所以通过mBroadcastsScheduled这个变量来标识BROADCAST_INTENT_MSG是不是已经被AMS线程接收了，当已经抛出的消息还未被接受时，不需要重新抛出。 </p>
<p>该消息被接收后的处理逻辑如下：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">BroadcastHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> BROADCAST_INTENT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> BROADCAST_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>直接调用 <font color="#FF00FF">BroadcastQueue.processNextBroadcast()</font> 方法，fromMsg参数为true表示这是一次来自BROADCAST_INTENT_MSG消息的派发请求。<font color="#FF00FF">BroadcastQueue.processNextBroadcast()</font>是派发广播消息最为核心的函数，代码量自然也不小，我们分成几个部分来分析：</p>
<h4 id="阶段一：处理并行广播信息"><a href="#阶段一：处理并行广播信息" class="headerlink" title="阶段一：处理并行广播信息"></a>阶段一：处理并行广播信息</h4><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段一：处理非串行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            ✨ <span class="token comment" spellcheck="true">// ① 设置mBroadcastsScheduled</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// fromMsg 参数为 true 表示这是一次来自 BROADCAST_INTENT_MSG 消息的派发请求              </span>
                mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ✨ <span class="token comment" spellcheck="true">// ② 处理“并行广播消息”</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Object target <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            ✨ <span class="token comment" spellcheck="true">// ③ 处理阻塞的广播消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// It's still alive, so keep waiting</span>
                    <span class="token comment" spellcheck="true">// isDead表示当前广播消息的进程的存活状态</span>
                    <span class="token comment" spellcheck="true">// 如果还活着，则返回该函数，继续等待下次派发</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>接下来我们详细分析这三部分的函数所做工作：</p>
<p><strong><font color="#7FF000" size="3">1、设置mBroadcastsScheduled</font></strong></p>
<p>该变量在前文说过，是对 BROADCAST_INTENT_MSG 进行控制。 如果是响应 BROADCAST_INTENT_MSG 的派发调用，则将 mBroadcastsScheduled 设为false， 表示本次 BROADCAST_INTENT_MSG 已经处理完毕，可以继续抛出下一次 BROADCAST_INTENT_MSG 消息了。</p>
<p><strong><font color="#7FF000" size="3">2、处理“并行广播消息”</font></strong></p>
<p>我们知道广播接收器有“动态”和“静态”之分，通过 Context.registerReceiver() 注册的广播接收器为“动态”的，通过 AndroidManifest.xml 注册的广播接收器为“静态”的。</p>
<p>广播消息有“并行”和“串行”之分，“并行广播消息”都会派发到“动态”接收器，“串行广播消息”则会根据实际情况派发到两种接收器。我们先不去探究 Android 为什么这么设计，只关注这两种广播消息派发的区别。</p>
<p><strong>在BroadcastQueue维护着两个队列：</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#FF0000">mParallelBroadcasts</font></strong>：“并行广播消息”都会进入到此队列中排队。“并行广播消息”可以一次性派发完毕，即在一个循环中将广播派发到所有的“动态”接收器。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#FF0000">mOrderedBroadcasts</font></strong>：“串行广播消息”都会进入到此队列中排队。“串行广播消息”需要轮侯派发，当一个接收器处理完毕后，会再抛出 BROADCAST_INTENT_MSG 消息，再次进入 BroadcastQueue.processNextBroadcast() 处理下一个。</p>
<p><strong><font color="#7FF000" size="3">3、处理阻塞的广播消息</font></strong></p>
<p>有时候会存在一个广播消息派发不出去的情况，这个广播消息会保存在 mPendingBroadcast 变量中。新一轮的派发启动时，会判断接收该消息的进程是否还活着，如果接收进程还活着，那么就继续等待。否则，就放弃这个广播消息。</p>
<h4 id="阶段二：处理串行广播信息"><a href="#阶段二：处理串行广播信息" class="headerlink" title="阶段二：处理串行广播信息"></a>阶段二：处理串行广播信息</h4><p>接下来是最为复杂的一部分，<strong><font color="#FF7F24">处理“串行广播消息”，ANR 监测机制只在这一类广播消息中才发挥作用</font></strong>，也就是说<strong><font color="#FF0000">“并行广播消息”是不会发生ANR的</font></strong>。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段一：处理并行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段二：处理串行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            <span class="token keyword">boolean</span> looped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> forceReceive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> numReceivers <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

                ✨ <span class="token comment" spellcheck="true">// ① 广播消息的第一个ANR监测机制</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessesReady <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numReceivers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token punctuation">(</span>now <span class="token operator">></span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mTimeoutPeriod<span class="token operator">*</span>numReceivers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token comment" spellcheck="true">/// M: ANR Debug Mechanism</span>
                            <span class="token operator">!</span>mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">isAnrDeferrable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// forcibly finish this broadcast</span>
                        forceReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                ✨ <span class="token comment" spellcheck="true">// ② 判断该广播消息是否处理完毕</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">>=</span> numReceivers
                        <span class="token operator">||</span> r<span class="token punctuation">.</span>resultAbort <span class="token operator">||</span> forceReceive<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                    <span class="token function">cancelBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                    mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    looped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<p>这部分是一个 <font color="#FF00FF">do-while</font> 循环，每次都从 <font color="#FF00FF">mOrderedBroadcasts</font> 队列中取出第一条广播消息进行处理。第一个 <font color="#FF00FF">Broadcast ANR</font> 监测机制千呼万唤总算是出现了：</p>
<p><strong><font color="#7FF000" size="3">1、判定当前时间是否已经超过了 r.dispatchTime + 2×mTimeoutPeriod×numReceivers。</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 dispatchTime 表示这一系列广播消息开始派发的时间。“串行广播消息”是逐个接收器派发的，一个接收器处理完毕后，才开始处理下一个消息派发。开始派发到第一个接收器的时间就是 dispatchTime。 dispatchTime 需要开始等广播消息派发以后才会设定，也就是说，第一次进入processNextBroadcast()时，dispatchTime=0,并不会进入该条件判断。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 mTimeoutPeriod 由当前 BroadcastQueue 的类型决定(forground为10秒，background为60秒)。这个时间在初始化 BroadcastQueue 的时候就设置好了，本意是限定每一个 Receiver 处理广播的时间，这里利用它做了一个超时计算。</p>
<p><strong><font color="#7FF000" size="3">2、如果广播消息已经处理完毕，则从mOrderedBroadcasts中移除，重新循环，处理下一条;否则，就会跳出循环。</font></strong></p>
<h4 id="阶段三：设定定时消息"><a href="#阶段三：设定定时消息" class="headerlink" title="阶段三：设定定时消息"></a>阶段三：设定定时消息</h4><p>以上代码块完成的主要任务是从队列中取一条“串行广播消息”，接下来就准备派发了。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段一：处理并行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段二：处理串行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段三：设定定时消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment" spellcheck="true">// 串行广播消息的第二个ANR监测机制</span>
            r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>取出“串行广播消息”后，一旦要开始派发，第二个ANR检测机制就出现了。</p>
<p><font color="#FF00FF">mPendingBroadcastTimeoutMessage</font> 变量用于标识当前是否有阻塞的超时消息，如果没有则调用 <font color="#FF00FF">BroadcastQueue.setBroadcastTimeoutLocked()</font>：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_TIMEOUT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingBroadcastTimeoutMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">sendBroadcastMonitorMessage</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">,</span> mTimeoutPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>通过设置一个定时消息 <font color="#FF00FF">BROADCAST_TIMEOUT_MSG </font>来跟踪当前广播消息的执行情况，这种超时监测机制跟 Service ANR 很类似，也是抛到 AMS 线程的消息队列。如果所有的接收器都处理完毕了，则会调用 <font color="#FF00FF">cancelBroadcastTimeoutLocked()</font> 清除该消息；否则，该消息就会响应，并调用 <font color="#FF00FF">broadcastTimeoutLocked()</font>，这个方法在第一种 ANR 监测机制的时候调用过，第二种 ANR 监测机制也会调用。</p>
<h4 id="阶段四：向“动态”接收器派发广播消息"><a href="#阶段四：向“动态”接收器派发广播消息" class="headerlink" title="阶段四：向“动态”接收器派发广播消息"></a>阶段四：向“动态”接收器派发广播消息</h4><p>设置完定时消息后，就开始派发广播消息了，首先是“动态”接收器：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段一：处理并行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段二：处理串行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段三：设定定时消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段四：向“动态”接收器派发广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            <span class="token keyword">final</span> BroadcastOptions brOptions <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">;</span>
            <span class="token keyword">final</span> Object nextReceiver <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 动态接收器的类型都是BroadcastFilter</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextReceiver <span class="token keyword">instanceof</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                BroadcastFilter filter <span class="token operator">=</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>
                <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>“动态”接收器的载体进程一般是处于运行状态的，所以向这种类型的接收器派发消息相对简单，调用 <font color="#FF00FF">BroadcastQueue.deliverToRegisteredReceiverLocked()</font> 完成接下来的工作。</p>
<h4 id="阶段五：向“静态”接收器派发广播消息"><a href="#阶段五：向“静态”接收器派发广播消息" class="headerlink" title="阶段五：向“静态”接收器派发广播消息"></a>阶段五：向“静态”接收器派发广播消息</h4><p>“静态”接收器是在AndroidManifest.xml中注册的，派发的时候，可能广播接收器的载体进程还没有启动，所以，这种场景会复杂很多。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段一：处理并行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段二：处理串行广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段三：设定定时消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段四：向“动态”接收器派发广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁 阶段五：向“静态”接收器派发广播消息 🍁🍁🍁🍁🍁🍁🍁🍁🍁🍁

            <span class="token comment" spellcheck="true">// 静态接收器的类型都是 ResolveInfo</span>
            ResolveInfo info <span class="token operator">=</span>
                <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>

            ✨ <span class="token comment" spellcheck="true">// ① 权限检查</span>
            ComponentName component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            String targetProcess <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>

            ✨ <span class="token comment" spellcheck="true">// ② 获取接收器所在的进程</span>
            ProcessRecord app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            ✨ <span class="token comment" spellcheck="true">// ③ 进程已经启动</span>
            <span class="token comment" spellcheck="true">// Is this receiver's application already running?</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            ✨ <span class="token comment" spellcheck="true">// ④ 进程还未启动</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token operator">=</span>mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_FROM_BACKGROUND<span class="token punctuation">,</span>
                    <span class="token string">"broadcast"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ✨ <span class="token comment" spellcheck="true">// ⑤ 进程启动失败</span>
            mPendingBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
            mPendingBroadcastRecvIndex <span class="token operator">=</span> recIdx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
</code></pre>
<p>我们分别看下：</p>
<p><strong><font color="#7FF000" size="3">1、权限检查</font></strong></p>
<p>“静态”接收器是 ResolveInfo ，需要通过 PackageManager 获取包信息，进行权限检查。</p>
<p><strong><font color="#7FF000" size="3">2、获取接收器所在的进程</font></strong></p>
<p>经过一系列复杂的权限检查后，终于可以向目标接收器派发了。通过 AMS.getProcessRecordLocked() 获取广播接收器的进程信息。</p>
<p><strong><font color="#7FF000" size="3">3、进程已经启动</font></strong></p>
<p>如果 app.thread ！= null ，则进程已经启动，就可以调用 BroadcastQueue.processCurBroadcastLocked() 进行接下来的派发处理了。</p>
<p><strong><font color="#7FF000" size="3">4、进程还未启动</font></strong></p>
<p>如果进程还没有启动，则需要通过 AMS.startProcessLocked() 来启动进程，当前消息并未派发，调用 BroadcastQueue.scheduleBroadcastsLocked() 进入下一次的调度。</p>
<p><strong><font color="#7FF000" size="3">5、进程启动失败</font></strong></p>
<p>如果进程启动失败了，则当前消息记录成 mPendingBroadcast ，即阻塞的广播消息，等待下一次调度时处理。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p><strong><font color="#FF7F24">庞大的 processNextBroadcast()终于完结了，它的功能就是对广播消息进行调度，该方法被设计得十分复杂而精巧，用于应对不同的广播消息和接收器的处理。<font></font></font></strong></p>
<h3 id="广播消息的跨进程传递"><a href="#广播消息的跨进程传递" class="headerlink" title="广播消息的跨进程传递"></a>广播消息的跨进程传递</h3><p>调度是完成了，接下来，我们就来分析被调度广播消息如何到达应用程序。上文的分析中，最终有两个方法将广播消息派发出去： <font color="#FF00FF">BroadcastQueue.deliverToRegisteredReceiverLocked()</font> 和 <font color="#FF00FF">BroadcastQueue.processCurBroadcastLocked()</font>。</p>
<p>抛开这两个函数的逻辑，试想要将广播消息从 AMS 所在的 system_server 进程传递到应用程序的进程，该怎么实现？</p>
<p>自然需要用到跨进程调用，Android中最常规的手段就是 <strong><font color="#FF7F24">Binder机制</font></strong>（关于Binder机制，我在别的博文中讲过）。没错，广播消息派发到应用进程就是这么玩的。</p>
<h4 id="应用程序已启动"><a href="#应用程序已启动" class="headerlink" title="应用程序已启动"></a>应用程序已启动</h4><p>我们在上面分析过，对于应用程序已经启动(app.thread != null)的情况，会通过 <font color="#FF00FF">IApplicationThread</font> 发起跨进程调用：</p>
<pre class=" language-java"><code class="language-java">            <span class="token comment" spellcheck="true">// Is this receiver's application already running?</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>我们查看 <font color="#FF00FF">processCurBroadcastLocked</font> 方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span>
            ProcessRecord app<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 通过 IApplicationThread 发起跨进程调用</span>
            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleReceiver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">,</span>
                    mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
            started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>调用关系如下：</p>
<pre><code>ActivityThread.ApplicationThread.scheduleReceiver()
└── ActivityThread.handleReceiver()
    └── BroadcastReceiver.onReceive()

</code></pre><h4 id="应用程序未启动"><a href="#应用程序未启动" class="headerlink" title="应用程序未启动"></a>应用程序未启动</h4><p>对于应用程序还未启动的情况，会调用 <font color="#FF00FF">IIntentReceiver</font> 发起跨进程调用，应用进程的实现在LoadedApk.ReceiverDispatcher.IntentReceiver中，调用关系如下：</p>
<pre><code>LoadedApk.ReceiverDispatcher.IntentReceiver.performReceive()
└── LoadedApk.ReceiverDispatcher.performReceiver()
    └── LoadedApk.ReceiverDispatcher.Args.run()
        └── BroadcastReceiver.onReceive()
</code></pre><p>发现没？最终都会调用到 <font color="#FF00FF">BroadcastReceiver.onReceive()</font> ，在应用进程执行接收广播消息的具体动作。</p>
<p>对于“串行广播消息”而言，执行完了以后，还需要通知 system_server 进程，才能继续将广播消息派发到下一个接收器，这又需要跨进程调用了。 </p>
<p>应用进程在处理完广播消息后，即在 BroadcastReceiver.onReceive() 执行完毕后，会调用 <font color="#FF00FF">BroadcastReceiver.PendingResult.finish()</font> ， 接下来的调用关系如下：</p>
<pre><code>BroadcastReceiver.PendingResult.finish()
└── BroadcastReceiver.PendingResult.sendFinished()
    └── IActivityManager.finishReceiver()
        └── ActivityManagerService.finishReceiver()
            └── BroadcastQueue.processNextBroadcat()
</code></pre><p>通过IActivityManager发起了一个从应用进程到 system_server 进程的调用，最终在AMS线程中，又走到了 <font color="#FF00FF">BroadcastQueue.processNextBroadcat()</font>, 开始下一轮的调度。</p>
<h4 id="broadcastTimeoutLocked"><a href="#broadcastTimeoutLocked" class="headerlink" title="broadcastTimeoutLocked()"></a>broadcastTimeoutLocked()</h4><p>前文说过，两种 ANR 机制最终都会调用 <font color="#FF00FF">BroadcastQueue.broadcastTimeoutLocked()</font> 方法， 第一种 ANR 监测生效时，会将 fromMsg 设置为 false ；第二种 ANR 监测生效时，会将 fromMsg 参数为 true 时，表示当前正在响应 <font color="#FF00FF">BROADCAST_TIMEOUT_MSG</font> 消息。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ✨ <span class="token comment" spellcheck="true">// ① 设置mPendingBroadcastTimeoutMessage</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPendingBroadcastTimeoutMessage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">removeBroadcastMonitorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ✨ <span class="token comment" spellcheck="true">// ② 判断第二种ANR机制是否超时</span>
        BroadcastRecord r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutTime <span class="token operator">></span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        ✨ <span class="token comment" spellcheck="true">// ③ 已经超时，则结束对当前接收器，开始新一轮调度</span>
        <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ✨ <span class="token comment" spellcheck="true">// ④ 抛出绘制ANR对话框的消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anrMessage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Post the ANR to the handler since we do not want to process ANRs while</span>
            <span class="token comment" spellcheck="true">// potentially holding our lock.</span>
            mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AppNotResponding</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> anrMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#7FF000" size="3">1、设置mPendingBroadcastTimeoutMessage</font></strong></p>
<p>mPendingBroadcastTimeoutMessage 标识是否存在未处理的 BROADCAST_TIMEOUT_MSG 消息，将其设置成false，允许继续抛出BROADCAST_TIMEOUT_MSG消息。</p>
<p><strong><font color="#7FF000" size="3">2、判断第二种ANR机制是否超时</font></strong></p>
<p>每次将广播派发到接收器，都会将 r.receiverTime 更新，如果判断当前还未超时，则又抛出一个 BROADCAST_TIMEOUT_MSG 消息。 正常情况下，所有接收器处理完毕后，才会清除 BROADCAST_TIMEOUT_MSG ；否则，每进行一次广播消息的调度，都会抛出 BROADCAST_TIMEOUT_MSG 消息。</p>
<p><strong><font color="#7FF000" size="3">3、已经超时，则结束对当前接收器，开始新一轮调度</font></strong></p>
<p>判断已经超时了，说明当前的广播接收器还未处理完毕，则结束掉当前的接收器，开始新一轮广播调度。</p>
<p><strong><font color="#7FF000" size="3">4、抛出绘制ANR对话框的消息</font></strong></p>
<p>最终，发出绘制 ANR 对话框的消息。</p>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p><strong><font color="#FF0000">至此，我们回答了前文提出的两个问题:</font></strong></p>
<p><strong><font color="#FF7F24">AMS 维护着广播队列 BroadcastQueue ，AMS 线程不断从队列中取出消息进行调度，完成广播消息的派发。在派发“串行广播消息”时，会抛出一个定时消息 BROADCAST_TIMEOUT_MSG ，在广播接收器处理完毕后，AMS 会将定时消息清除。如果 BROADCAST_TIMEOUT_MSG 得到了响应，就会判断是否广播消息处理超时，最终通知ANR的发生。</font></strong></p>
<h2 id="Input超时处理"><a href="#Input超时处理" class="headerlink" title="Input超时处理"></a>Input超时处理</h2><p>应用程序可以接收输入事件(按键、触屏、轨迹球等)，当 <strong><font color="#FF0000">5秒</font></strong> 内没有处理完毕时，则会引发 ANR。</p>
<p><strong><font color="#7FF000" size="3">和分析 Broadcast ANR 一样，我们先抛出 Input ANR 两个问题：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 输入事件经历了一些什么工序才能被派发到应用的界面？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 如何检测输入事件处理超时？</p>
<p>我们先来看看第一个问题。</p>
<h3 id="输入事件派发工序"><a href="#输入事件派发工序" class="headerlink" title="输入事件派发工序"></a>输入事件派发工序</h3><p>输入事件最开始由硬件设备（如按键或触摸屏幕）发起，Android 有一套输入子系统来发现各种输入事件，这些事件最终都会被 <font color="#FF00FF">InputDispatcher</font> 分发到各个需要接收事件的窗口。那么，窗口如何告之 InputDispatcher 自己需要处理输入事件呢？Android 通过 <font color="#FF00FF">InputChannel</font> 连接 InputDispatcher 和窗口，<font color="#FF7F24">InputChannel 其实是封装后的 Linux管道(Pipe)。每一个窗口都会有一个独立的 InputChannel ，窗口需要将这个 InputChannel 注册到 InputDispatcher 中</font>:</p>
<pre class=" language-cpp"><code class="language-cpp">status_t InputDispatcher<span class="token operator">::</span><span class="token function">registerInputChannel</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputChannel<span class="token operator">></span><span class="token operator">&amp;</span> inputChannel<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> inputWindowHandle<span class="token punctuation">,</span> <span class="token keyword">bool</span> monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    sp<span class="token operator">&lt;</span>Connection<span class="token operator">></span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Connection</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">,</span> inputWindowHandle<span class="token punctuation">,</span> monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> inputChannel<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConnectionsByFd<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ALOOPER_EVENT_INPUT<span class="token punctuation">,</span> handleReceiveCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于 InputDispatcher 而言，每注册一个 InputChannel 都被视为一个 Connection ，通过文件描述符来区别。InputDispatcher 是一个消息处理循环，当有新的 Connection 时，就需要唤醒消息循环队列进行处理。</p>
<p>输入事件的类型有很多，按键、轨迹球、触屏等，Android 对这些事件进行了分类，处理这些事件的窗口也被赋予了一个类型(targetType)：Foucused 或 Touched。</p>
<p>如果当前输入事件是按键类型，则寻找 Focused 类型的窗口。如果当前输入事件类型是触摸类型，则寻找 Touched 类型的窗口。</p>
<p>InputDispatcher 需要经过以下复杂的调用关系，才能把一个输入事件派发出去(调用关系以按键事件为例，触屏事件的调用关系类似)：</p>
<pre><code>InputDispatcherThread::threadLoop()
└── InputDispatcher::dispatchOnce()
    └── InputDispatcher::dispatchOnceInnerLocked()
        └── InputDispatcher::dispatchKeyLocked()
            └── InputDispatcher::dispatchEventLocked()
                └── InputDispatcher::prepareDispatchCycleLocked()
                    └── InputDispatcher::enqueueDispatchEntriesLocked()
                        └── InputDispatcher::startDispatchCycleLocked()
                            └── InputPublisher::publishKeyEvent()
</code></pre><p>具体每个函数的实现逻辑此处不表。我们提炼出几个关键点：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 InputDispatcherThread 是一个线程，它处理一次消息的派发。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 输入事件作为一个消息，需要排队等待派发，每一个 Connection 都维护两个队列：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;· outboundQueue: 等待发送给窗口的事件。每一个新消息到来，都会先进入到此队列。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;· waitQueue: 已经发送给窗口的事件。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 publishKeyEvent 完成后，表示事件已经派发了，就将事件从 outboundQueue 挪到了 waitQueue。</p>
<p>事件经过这么一轮处理，就算是从 InputDispatcher 派发出去了，但事件是不是被窗口收到了，还需要等待接收方的 <font color="#FF00FF">“finished”</font> 通知。在向 InputDispatcher 注册 InputChannel 的时候，同时会注册一个回调函数 handleReceiveCallback():</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> InputDispatcher<span class="token operator">::</span><span class="token function">handleReceiveCallback</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        status <span class="token operator">=</span> connection<span class="token operator">-</span><span class="token operator">></span>inputPublisher<span class="token punctuation">.</span><span class="token function">receiveFinishedSignal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>seq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        d<span class="token operator">-</span><span class="token operator">></span><span class="token function">finishDispatchCycleLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> handled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    d<span class="token operator">-</span><span class="token operator">></span><span class="token function">unregisterInputChannelLocked</span><span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>inputChannel<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当收到的 status 为 OK 时，会调用 <font color="#FF00FF">finishDispatchCycleLocked()</font> 来完成一个消息的处理：</p>
<pre><code>InputDispatcher::finishDispatchCycleLocked()
└── InputDispatcher::onDispatchCycleFinishedLocked()
    └── InputDispatcher::doDispatchCycleFinishedLockedInterruptible()
        └── InputDispatcher::startDispatchCycleLocked()
</code></pre><p>调用到 <font color="#FF00FF">doDispatchCycleFinishedLockedInterruptible()</font> 方法时，会将已经成功派发的消息从 <font color="#FF00FF">waitQueue</font> 中移除， 进一步调用会 <font color="#FF00FF">startDispatchCycleLocked</font> 开始派发新的事件。</p>
<p><strong><font color="#FF0000">至此，我们回答了第一个问题：</font></strong></p>
<p><strong><font color="#FF7F24">一个正常的输入事件会经过从 outboundQueue 挪到 waitQueue 的过程，表示消息已经派发出去；再经过从 waitQueue 中移除的过程，表示消息已经被窗口接收。InputDispatcher 作为中枢，不停地在递送着输入事件，当一个事件无法得到处理的时候，InputDispatcher 不能就此死掉啊，否则系统也太容易崩溃了。InputDispatcher 的策略是放弃掉处理不过来的事件，并发出通知(这个通知机制就是ANR)，继续进行下一轮消息的处理。</font></strong></p>
<p><strong><font color="#FF0000">理解输入事件分发模型，我们可以举一个生活中的例子：</font></strong></p>
<pre><code>每一个输入事件可以比做一个快递，InputDispatcher 就像一个快递中转站，窗口就像是收件人，InputChannel 就像是快递员。
所有快递都会经过中转站中处理，中转站需要知道每一个快递的收件人是谁，通过快递员将快递发送到具体的收件人。
这其中有很多场景导致快递不能及时送到：譬如联系不到收件人;快递很多，快递员会忙不过来;快递员受伤休假了等等…
这时候快递员就需要告知中转站：有快递无法及时送到了。中转站在收到快递员的通知后，一边继续派发其他快递，一边报告上级。
</code></pre><h3 id="检测输入事件处理超时"><a href="#检测输入事件处理超时" class="headerlink" title="检测输入事件处理超时"></a>检测输入事件处理超时</h3><p>在了解输入事件分发模型之后，我们可以见识一下ANR机制了。在派发事件时，<font color="#FF00FF">dispatchKeyLocked()</font> 和 <font color="#FF00FF">dispatchMotionLocked()</font>，需要找到当前的焦点窗口，焦点窗口才是最终接收事件的地方，找窗口的过程就会判断是否已经发生了ANR：</p>
<pre><code>InputDispatcher::findFocusedWindowTargetsLocked()
InputDispatcher::findTouchedWindowTargetsLocked()
└── InputDispatcher::handleTargetsNotReadyLocked()
    └── InputDispatcher::onANRLocked()
        └── InputDispatcher::doNotifyANRLockedInterruptible()
            └── NativeInputManager::notifyANR()
</code></pre><p>（1）首先，会调用 <font color="#FF00FF">findFocusedWindowTargetsLocked()</font> 或 <font color="#FF00FF">findTouchedWindowTargetsLocked()</font> 寻找接收输入事件的窗口。</p>
<p>在找到窗口以后，会调用 <font color="#FF00FF">checkWindowReadyForMoreInputLocked()</font> 检查窗口是否有能力再接收新的输入事件，会有一系列的场景阻碍事件的继续派发：</p>
<p><strong><font color="#7FF000" size="3">场景1: 窗口处于paused状态，不能处理输入事件</font></strong></p>
<p>“Waiting because the [targetType] window is paused.”</p>
<p><strong><font color="#7FF000" size="3">场景2: 窗口还未向InputDispatcher注册，无法将事件派发到窗口</font></strong></p>
<p>“Waiting because the [targetType] window’s input channel is not registered with the input dispatcher. The window may be in the process of being removed.”</p>
<p><strong><font color="#7FF000" size="3">场景3: 窗口和InputDispatcher的连接已经中断，即InputChannel不能正常工作</font></strong></p>
<p>“Waiting because the [targetType] window’s input connection is [status]. The window may be in the process of being removed.”</p>
<p><strong><font color="#7FF000" size="3">场景4: InputChannel已经饱和，不能再处理新的事件</font></strong></p>
<p>“Waiting because the [targetType] window’s input channel is full. Outbound queue length: %d. Wait queue length: %d.”</p>
<p><strong><font color="#7FF000" size="3">场景5: 对于按键类型(KeyEvent)的输入事件，需要等待上一个事件处理完毕</font></strong></p>
<p>“Waiting to send key event because the [targetType] window has not finished processing all of the input events that were previously delivered to it. Outbound queue length: %d. Wait queue length: %d.”</p>
<p><strong><font color="#7FF000" size="3">场景6: 对于触摸类型(TouchEvent)的输入事件，可以立即派发到当前的窗口，因为TouchEvent都是发生在用户当前可见的窗口。但有一种情况， 如果当前应用由于队列有太多的输入事件等待派发，导致发生了ANR，那TouchEvent事件就需要排队等待派发。</font></strong></p>
<p>“Waiting to send non-key event because the %s window has not finished processing certain input events that were delivered to it over %0.1fms ago. Wait queue length: %d. Wait queue head age: %0.1fms.”</p>
<p>（2）然后，上述有任何一个场景发生了，则输入事件需要继续等待，紧接着就会调用 <font color="#FF00FF">handleTargetsNotReadyLocked()</font> 来判断是不是已经的等待超时了：</p>
<pre class=" language-cpp"><code class="language-cpp">int32_t InputDispatcher<span class="token operator">::</span><span class="token function">handleTargetsNotReadyLocked</span><span class="token punctuation">(</span>nsecs_t currentTime<span class="token punctuation">,</span>
        <span class="token keyword">const</span> EventEntry<span class="token operator">*</span> entry<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputApplicationHandle<span class="token operator">></span><span class="token operator">&amp;</span> applicationHandle<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> windowHandle<span class="token punctuation">,</span>
        nsecs_t<span class="token operator">*</span> nextWakeupTime<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">>=</span> mInputTargetWaitTimeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onANRLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> applicationHandle<span class="token punctuation">,</span> windowHandle<span class="token punctuation">,</span>
            entry<span class="token operator">-</span><span class="token operator">></span>eventTime<span class="token punctuation">,</span> mInputTargetWaitStartTime<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>nextWakeupTime <span class="token operator">=</span> LONG_LONG_MIN<span class="token punctuation">;</span>
        <span class="token keyword">return</span> INPUT_EVENT_INJECTION_PENDING<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre>
<p>最后，如果当前事件派发已经超时，则说明已经检测到了 ANR ，调用 <font color="#FF00FF">onANRLocked()</font> 方法，然后将 <font color="#FF00FF">nextWakeupTime</font> 设置为最小值，马上开始下一轮调度。在 onANRLocked() 方法中， 会保存 ANR 的一些状态信息，调用 <font color="#FF00FF">doNotifyANRLockedInterruptible()</font> ，进一步会调用到 JNI 层的 <font color="#FF00FF">NativeInputManager::notifyANR()</font> 方法，它的主要功能就是衔接 Native 层和 Java 层，直接调用 Java 层的 <font color="#FF00FF">InputManagerService.notifyANR()</font> 方法。</p>
<p><strong><font color="#FF0000">至此，ANR的处理逻辑转交到了Java层。</font></strong>底层(Native)发现一旦有输入事件派发超时，就会通知上层(Java)，上层收到ANR通知后，决定是否终止当前输入事件的派发。</p>
<p>发生ANR时，Java层最开始的入口是 <font color="#FF00FF">InputManagerService.notifyANR()</font> ，它是直接被 Native 层调用的。我们先把 ANR 的Java层调用关系列出来：</p>
<pre><code>InputManagerService.notifyANR()
└── InputMonitor.notifyANR()
    ├── IApplicationToken.keyDispatchingTimedOut()
    │   └── ActivityRecord.keyDispatchingTimedOut()
    │       └── AMS.inputDispatchingTimedOut()
    │           └── AMS.appNotResponding()
    │
    └── AMS.inputDispatchingTimedOut()
        └── AMS.appNotResponding()
</code></pre><p><font color="#FF00FF">InputManagerService.notifyANR()</font> 只是为 Native层 定义了一个接口，它直接调用 <font color="#FF00FF">InputMonitor.notifyANR()</font>。如果该方法的返回值等于0，则放弃本次输入事件；如果大于0，则表示需要继续等待的时间。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">notifyANR</span><span class="token punctuation">(</span>InputApplicationHandle inputApplicationHandle<span class="token punctuation">,</span>
      InputWindowHandle inputWindowHandle<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appWindowToken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> appWindowToken<span class="token punctuation">.</span>appToken <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// appToken实际上就是当前的ActivityRecord。</span>
        <span class="token comment" spellcheck="true">// 如果发生ANR的Activity还存在，则直接通过ActivityRecord通知事件派发超时</span>
        <span class="token keyword">boolean</span> abort <span class="token operator">=</span> appWindowToken<span class="token punctuation">.</span>appToken<span class="token punctuation">.</span><span class="token function">keyDispatchingTimedOut</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> abort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> appWindowToken<span class="token punctuation">.</span>inputDispatchingTimeoutNanos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果发生ANR的Activity已经销毁了，则通过AMS通知事件派发超时</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>
                        windowState<span class="token punctuation">.</span>mSession<span class="token punctuation">.</span>mPid<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// abort dispatching</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上述方法中有两种不同的调用方式，但最终都会交由 <font color="#FF00FF">AMS.inputDispatchingTimedOut()</font> 处理。AMS 有重载的 <font color="#FF00FF">inputDispatchingTimedOut()</font> 方法，他们的参数不一样。ActivityRecord 调用时，可以传入的信息更多一点(当前发生ANR的界面是哪一个)。</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 根据进程号获取到ProcessRecord</span>
    proc <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// 2. 获取超时时间</span>
    <span class="token comment" spellcheck="true">// 测试环境下的超时时间是INSTRUMENTATION_KEY_DISPATCHING_TIMEOUT(60秒)，</span>
    <span class="token comment" spellcheck="true">// 正常环境下的超时时间是KEY_DISPATCHING_TIMEOUT(5秒)</span>
    timeout <span class="token operator">=</span> <span class="token function">getInputDispatchingTimeoutLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 调用重载的函数，如果返回True，则表示需要中断当前的事件派发;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 3. 返回继续等待的时间，这个值会传递到Native层</span>
    <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">final</span> ProcessRecord proc<span class="token punctuation">,</span>
        <span class="token keyword">final</span> ActivityRecord activity<span class="token punctuation">,</span> <span class="token keyword">final</span> ActivityRecord parent<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// 1. 发生ANR进程正处于调试状态，不需要中断事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>debugging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 2. 当前正在做dexopt操作，这会比较耗时，不需要中断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDidDexOpt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Give more time since we were dexopting.</span>
        mDidDexOpt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 3. 发生ANR的进程是测试进程，需要中断，但不在UI界面显示ANR信息判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>instrumentationClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">finishInstrumentationLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 4. 通知UI界面显示ANR信息</span>
    mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">appNotResponding</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#FF0000">至此，我们回答了第二个问题：</font></strong></p>
<p><strong><font color="#FF7F24">在 InputDispatcher 派发输入事件时，会寻找接收事件的窗口，如果无法正常派发，则可能会导致当前需要派发的事件超时(默认是5秒)。Native层发现超时了，会通知Java层，Java层经过一些处理后，会反馈给Native层，是继续等待还是丢弃当前派发的事件。</font></strong></p>
<h2 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h2><p><strong>ANR监测机制包含三种：</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#7FF000">Service ANR</font></strong>，前台进程中Service生命周期不能超过 <strong><font color="#FF0000">20秒</font></strong>，后台进程中Service的生命周期不能超过<strong><font color="#FF0000"> 200秒</font></strong>。 在启动Service时，抛出定时消息 <strong><font color="#FF34B3">SERVICE_TIMEOUT_MSG</font></strong> 或 <strong><font color="#FF34B3">SERVICE_BACKGOURND_TIMEOUT_MSG</font></strong>，如果定时消息响应了，则说明发生了ANR。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#7FF000">Broadcast ANR</font></strong>，前台的“串行广播消息”必须在 <strong><font color="#FF0000">10秒</font></strong> 内处理完毕，后台的“串行广播消息”必须在<strong><font color="#FF0000"> 60秒 </font></strong>处理完毕， 每派发串行广播消息到一个接收器时，都会抛出一个定时消息 <strong><font color="#FF34B3">BROADCAST_TIMEOUT_MSG</font></strong>，如果定时消息响应，则判断是否广播消息处理超时，超时就说明发生了ANR。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#7FF000">Input ANR</font></strong>，输入事件必须在 <strong><font color="#FF0000">5秒</font></strong> 内处理完毕。在派发一个输入事件时，会判断当前输入事件是否需要等待，如果需要等待，则判断是否等待已经超时，超时就说明发生了ANR。</p>
<p>ANR监测机制实际上是对应用程序主线程的要求，要求主线成必须在限定的时间内，完成对几种操作的响应；否则，就可以认为应用程序主线程失去响应能力。</p>
<p><strong>从ANR的三种监测机制中，我们看到不同超时机制的设计：</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 Service 和 Broadcast 都是由 AMS 调度，利用 Handler 和 Looper，设计了一个 TIMEOUT 消息交由 AMS 线程来处理，整个超时机制的实现都是在Java层；<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 InputEvent 由 InputDispatcher 调度，待处理的输入事件都会进入队列中等待，设计了一个等待超时的判断，超时机制的实现在Native层。</p>
<h1 id="ANR的报告机制"><a href="#ANR的报告机制" class="headerlink" title="ANR的报告机制"></a>ANR的报告机制</h1><h2 id="ANR日志输出原理"><a href="#ANR日志输出原理" class="headerlink" title="ANR日志输出原理"></a>ANR日志输出原理</h2><p>无论哪种类型的ANR发生以后，最终都会调用 <font color="#FF00FF">AMS.appNotResponding()</font> 方法，所谓“殊途同归”。</p>
<p>这个方法的职能就是向用户或开发者报告ANR发生了。最终的表现形式是：弹出一个对话框，告诉用户当前某个程序无响应；输入一大堆与 ANR 相关的日志，便于开发者解决问题。</p>
<p>最终形式我们见过很多，但输出日志的原理是什么，未必所有人都了解，下面我们就来认识一下是如何输出 ANR 日志的。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*
     * app: 当前发生ANR的进程
     * activity: 发生ANR的界面
     * parent: 发生ANR的界面的上一级界面
     * aboveSystem:
     * annotation: 发生ANR的原因
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">appNotResponding</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> ActivityRecord activity<span class="token punctuation">,</span>
            ActivityRecord parent<span class="token punctuation">,</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> <span class="token keyword">final</span> String annotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> firstPids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SparseArray<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> lastPids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">long</span> anrTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>MONITOR_CPU_USAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         ✨ <span class="token comment" spellcheck="true">// ① 更新CPU使用信息，ANR的第一次CPU信息采样</span>
            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

         ✨ <span class="token comment" spellcheck="true">// ② 填充firstPids和lastPids数组。从最近运行进程(Last Recently Used)中挑选</span>
            <span class="token comment" spellcheck="true">//    firstPids：用于保存ANR进程及其父进程，system_server进程和persistent的进程</span>
            <span class="token comment" spellcheck="true">//    lastPids：用于保存除firstPids外的其他进程</span>
            firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Don't dump other PIDs if it's a background ANR</span>
            isSilentANR <span class="token operator">=</span> <span class="token operator">!</span>showBackground <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isInterestingForBackgroundTraces</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSilentANR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> parentPid <span class="token operator">=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    parentPid <span class="token operator">=</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentPid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parentPid<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>MY_PID <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid <span class="token operator">&amp;&amp;</span> MY_PID <span class="token operator">!=</span> parentPid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>MY_PID<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ProcessRecord r <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> pid <span class="token operator">=</span> r<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> parentPid <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> MY_PID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>treatLikeActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                lastPids<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     ✨ <span class="token comment" spellcheck="true">// ③ 打印调用栈</span>
        File tracesFile <span class="token operator">=</span> ActivityManagerService<span class="token punctuation">.</span><span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span> firstPids<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> processCpuTracker<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> lastPids<span class="token punctuation">,</span>
                nativePids<span class="token punctuation">)</span><span class="token punctuation">;</span>

        String cpuInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>MONITOR_CPU_USAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         ✨ <span class="token comment" spellcheck="true">// ④ 更新CPU使用信息，ANR的第二次CPU信息采样</span>
            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

         ✨ <span class="token comment" spellcheck="true">// ⑤ 显示ANR对话框</span>
            Message msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>what <span class="token operator">=</span> ActivityManagerService<span class="token punctuation">.</span>SHOW_NOT_RESPONDING_UI_MSG<span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> map<span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> aboveSystem <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">,</span> activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mService<span class="token punctuation">.</span>mUiHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#7FF000" size="3">该方法的主体逻辑可以分成五个部分来看：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 1、更新CPU的统计信息。这是发生 ANR 时，第一次CPU使用信息的采样，采样数据会保存在 <font color="#FF00FF">mProcessStats</font> 这个变量中。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 2、填充 <font color="#FF00FF">firstPids</font> 和 <font color="#FF00FF">lastPids</font> 数组。当前发生 ANR 的应用会首先被添加到 firstPids 中，这样打印函数栈的时候，当前进程总是在trace文件的最前面。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 3、打印函数调用栈 <font color="#FF00FF">(StackTrace)</font>。具体实现由 <font color="#FF00FF">dumpStackTraces() </font>函数完成。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 4、更新 CPU 的统计信息。这是发生ANR时，第二次CPU使用信息的采样，两次采样的数据分别对应 ANR 发生前后的 CPU 使用情况。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 5、显示 ANR 对话框。抛出 <font color="#FF00FF">SHOW_NOT_RESPONDING_MSG</font> 消息，AMS.MainHandler会处理这条消息，<font color="#FF00FF">显示AppNotRespondingDialog</font>。</p>
<p><strong><font color="#7FF000" size="3">当然，除了主体逻辑，发生ANR时还会输出各种类别的日志：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#FF7F00">event log</font></strong>：通过检索 <strong>“am_anr”</strong> 关键字，可以找到发生ANR的应用。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#FF7F00">main log</font></strong>：通过检索 <strong>“ANR in”</strong> 关键字，可以找到ANR的信息，日志的上下文会包含CPU的使用情况。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#FF7F00">dropbox</font></strong>：通过检索 <strong>“anr”</strong> 类型，可以找到ANR的信息。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong><font color="#FF7F00">traces</font></strong>：发生ANR时，各进程的函数调用栈信息。</p>
<p>我们分析 ANR 问题，往往是从 main log 中的 <font color="#FF00FF">“CPU使用情况”</font> 和 <font color="#FF00FF">“traces中的函数调用栈”</font> 开始。所以，更新CPU的使用信息 <font color="#FF00FF">updateCpuStatsNow()</font> 方法和打印函数栈 <font color="#FF00FF">dumpStackTraces()</font> 方法，是系统报告 ANR 问题关键所在。</p>
<h2 id="CPU的使用情况"><a href="#CPU的使用情况" class="headerlink" title="CPU的使用情况"></a>CPU的使用情况</h2><p><font color="#FF00FF">AMS.updateCpuStatsNow() </font>方法的实现我们不作讲解，只需要知道更新CPU使用信息的间隔最小是5秒，即如果5秒内连续调用 updateCpuStatsNow() 方法，其实是没有更新CPU使用信息的。</p>
<p>CPU使用信息由 <font color="#FF00FF">ProcessCpuTracker</font> 这个类维护，每次调用 <font color="#FF00FF">ProcessCpuTracker.update()</font> 方法，就会读取设备节点 <font color="#FF7F00">/proc</font> 下的文件，来更新CPU使用信息，具体有以下几个维度：</p>
<p><strong><font color="#7FF000" size="3">🍁 CPU的使用时间: </font></strong>&nbsp;<strong>读取 /proc/stat</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong>user：</strong> 用户进程的CPU使用时间。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong>nice：</strong> 降低过优先级进程的CPU使用时间。Linux进程都有优先级，这个优先级可以进行动态调整。例如：进程初始优先级的值设为10，运行时降低为8，那么，修正值-2就定义为nice。 Android将user和nice这两个时间归类成user。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong>sys：</strong> 内核进程的CPU使用时间。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong>idle：</strong> CPU空闲的时间。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong>wait：</strong> CPU等待IO的时间。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong>hw irq：</strong> 硬件中断的时间。如果外设（例如：硬盘）出现故障，需要通过硬件终端通知CPU保存现场，发生上下文切换的时间就是CPU的硬件中断时间。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 <strong>sw irg：</strong> 软件中断的时间。同硬件中断一样，如果软件要求CPU中断，则上下文切换的时间就是CPU的软件中断时间。</p>
<p><strong><font color="#7FF000" size="3">🍁 CPU负载: </font></strong>&nbsp;<strong>读取 /proc/loadavg</strong></p>
<p>统计最近1分钟，5分钟，15分钟内，CPU的平均活动进程数。CPU的负载可以比喻成超市收银员负载，如果有1个人正在买单，有2个人在排队，那么该收银员的负载就是3。在收银员工作时，不断会有人买单完成，也不断会有人排队，可以在固定的时间间隔内(例如：每隔5秒)统计一次负载，那么，就可以统计出一段时间内的平均负载。</p>
<p><strong><font color="#7FF000" size="3">🍁 页错误信息：</font></strong></p>
<p>进程的CPU使用率最后输出的 “faults: xxx minor/major” 部分表示的是页错误次数，当次数为0时不显示。major是指 Major Page Fault(主要页错误，简称MPF)，内核在读取数据时会先后查找CPU的高速缓存和物理内存，如果找不到会发出一个MPF信息，请求将数据加载到内存。minor是指 Minor Page Fault(次要页错误，简称MnPF)，磁盘数据被加载到内存后，内核再次读取时，会发出一个MnPF信息。一个文件第一次被读写时会有很多的MPF，被缓存到内存后再次访问MPF就会很少，MnPF反而变多，这是内核为减少效率低下的磁盘I/O操作采用的缓存技术的结果。</p>
<h2 id="函数调用栈"><a href="#函数调用栈" class="headerlink" title="函数调用栈"></a>函数调用栈</h2><p><font color="#FF00FF">AMS.dumpStackTraces()</font> 方法用于打印进程的函数调用栈，该方法的主体逻辑如下：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> File <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> clearTraces<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> firstPids<span class="token punctuation">,</span>
            ProcessCpuTracker processCpuTracker<span class="token punctuation">,</span> SparseArray<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> lastPids<span class="token punctuation">,</span>
            ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> nativePids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> extraPids <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>tracesFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> firstPids<span class="token punctuation">,</span> nativePids<span class="token punctuation">,</span> extraPids<span class="token punctuation">,</span>
                useTombstonedForJavaTraces<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>继续跟踪 <font color="#FF00FF">dumpStackTraces()</font> 方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>String tracesFile<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> firstPids<span class="token punctuation">,</span>
            ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> nativePids<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> extraPids<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// We must complete all stack dumps within 20 seconds.</span>
        <span class="token keyword">long</span> remainingTime <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                observer<span class="token punctuation">.</span><span class="token function">startWatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// First collect all of the stacks of the most important pids.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstPids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 对 firstPids 数组中的进程发送 SIGNAL_QUIT，进程在收到 SIGNAL_QUIT 后，会打印函数调用栈</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> firstPids<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> <span class="token function">dumpJavaTracesTombstoned</span><span class="token punctuation">(</span>firstPids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> tracesFile<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> observer<span class="token punctuation">.</span><span class="token function">dumpWithTimeout</span><span class="token punctuation">(</span>firstPids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 发送 SIGNAL_QUIT</span>
                    <span class="token punctuation">}</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Next collect the stacks of the native pids</span>
            <span class="token comment" spellcheck="true">// 打印Native进程的函数调用栈</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nativePids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pid <span class="token operator">:</span> nativePids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> nativeDumpTimeoutMs <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>NATIVE_DUMP_TIMEOUT_MS<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">final</span> <span class="token keyword">long</span> start <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>

                    remainingTime <span class="token operator">-=</span> timeTaken<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Aborting stack trace dump (current native pid="</span> <span class="token operator">+</span> pid <span class="token operator">+</span>
                            <span class="token string">"); deadline exceeded."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Lastly, dump stacks for all extra PIDs from the CPU tracker.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extraPids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 对 extraPids 数组中的进程发送 SIGNAL_QUIT，只有处于工作状态的 extraPids 进程，才会收到 SIGNAL_QUIT，打印函数调用栈</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pid <span class="token operator">:</span> extraPids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> <span class="token function">dumpJavaTracesTombstoned</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> tracesFile<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> observer<span class="token punctuation">.</span><span class="token function">dumpWithTimeout</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                observer<span class="token punctuation">.</span><span class="token function">stopWatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#7FF000" size="3">该方法有几个重要的逻辑(Native进程的函数调用栈此处我们不分析)：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 向进程发送 SIGNAL_QUIT 信号，进程在收到这个信号后，就会打印函数调用栈，默认输出到 <font color="#FF00FF">/data/anr/traces.txt</font> 文件中，当然也可以配置 <font color="#FF00FF">dalvik.vm.stack-trace-file</font> 这个系统属性来指定输出函数调用栈的位置。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 traces文件中包含很多进程的函数调用栈，这是由 firstPids 和 lastPids 数组控制的，在最终的traces文件中，<font color="#FF00FF">firstPids中的进程是先打印的</font>，而且<font color="#FF00FF">当前发生 ANR 的进程又是排在 firstPids 的第一个</font>，所以，当我们打开traces文件，<font color="#FF00FF">第一个看到的就是当前发生ANR的应用进程</font>。</p>
<h1 id="ANR的问题分析"><a href="#ANR的问题分析" class="headerlink" title="ANR的问题分析"></a>ANR的问题分析</h1><p>分析ANR问题，有三大利器：<font color="#7FF000">Logcat</font>，<font color="#7FF000">traces</font> 和 <font color="#7FF000">StrictMode</font>（不作讨论）。分析 ANR 问题需要经过<font color="#FF00FF">日志获取</font>、<font color="#FF00FF">问题定位</font> 和 <font color="#FF00FF">场景还原</font> 三个步骤。</p>
<h2 id="日志获取"><a href="#日志获取" class="headerlink" title="日志获取"></a>日志获取</h2><p>如何获取日志，我们暂时不去详细分析，后面打算通过Watchdog机制加以详解。</p>
<h2 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h2><p>我们现在以一份ANR日志为例，分析如何定位ANR。</p>
<p>通过在 event log 中检索 “am_anr” 关键字，就可以找到发生ANR的进程：</p>
<pre class=" language-log"><code class="language-log">08-26 00:48:27 820 907 I am_anr: [0,29533,com.android.systemui,1082670605,Broadcast of Intent { act=android.intent.action.TIME_TICK flg=0x50000114 (has extras) }]
</code></pre>
<p>接下来可以在 system log 检索 ANR in 关键字，找到发生 ANR 前后的CPU使用情况：</p>
<pre class=" language-log"><code class="language-log">08-26 00:50:10 820 907 E ActivityManager: ANR in com.android.systemui, time=130090695
08-26 00:50:10 820 907 E ActivityManager: Reason: Broadcast of Intent { act=android.intent.action.TIME_TICK flg=0x50000114 (has extras) }
08-26 00:50:10 820 907 E ActivityManager: Load: 30.4 / 22.34 / 19.94
08-26 00:50:10 820 907 E ActivityManager: Android time :[2015-08-26 00:50:05.76] [130191,266]
08-26 00:50:10 820 907 E ActivityManager: CPU usage from 6753ms to -4ms ago:
08-26 00:50:10 820 907 E ActivityManager:   47% 320/netd: 3.1% user + 44% kernel / faults: 14886 minor 3 major
08-26 00:50:10 820 907 E ActivityManager:   15% 10007/com.sohu.sohuvideo: 2.8% user + 12% kernel / faults: 1144 minor
08-26 00:50:10 820 907 E ActivityManager:   13% 10654/hif_thread: 0% user + 13% kernel
08-26 00:50:10 820 907 E ActivityManager:   11% 175/mmcqd/0: 0% user + 11% kernel
08-26 00:50:10 820 907 E ActivityManager:   5.1% 12165/app_process: 1.6% user + 3.5% kernel / faults: 9703 minor 540 major
08-26 00:50:10 820 907 E ActivityManager:   3.3% 29533/com.android.systemui: 2.6% user + 0.7% kernel / faults: 8402 minor 343 major
08-26 00:50:10 820 907 E ActivityManager:   3.2% 820/system_server: 0.8% user + 2.3% kernel / faults: 5120 minor 523 major
08-26 00:50:10 820 907 E ActivityManager:   2.5% 11817/com.netease.pomelo.push.l.messageservice_V2: 0.7% user + 1.7% kernel / faults: 7728 minor 687 major
08-26 00:50:10 820 907 E ActivityManager:   1.6% 11887/com.android.email: 0.5% user + 1% kernel / faults: 6259 minor 587 major
08-26 00:50:10 820 907 E ActivityManager:   1.4% 11854/com.android.settings: 0.7% user + 0.7% kernel / faults: 5404 minor 471 major
08-26 00:50:10 820 907 E ActivityManager:   1.4% 11869/android.process.acore: 0.7% user + 0.7% kernel / faults: 6131 minor 561 major
08-26 00:50:10 820 907 E ActivityManager:   1.3% 11860/com.tencent.mobileqq: 0.1% user + 1.1% kernel / faults: 5542 minor 470 major
...
08-26 00:50:10 820 907 E ActivityManager:  +0% 12832/cat: 0% user + 0% kernel
08-26 00:50:10 820 907 E ActivityManager:  +0% 13211/zygote64: 0% user + 0% kernel
08-26 00:50:10 820 907 E ActivityManager: 87% TOTAL: 3% user + 18% kernel + 64% iowait + 0.5% softirq
</code></pre>
<p>以上日志的信息量就很大了，我们分析下：</p>
<p><strong><font color="#7FF000" size="3">发生 ANR 的时间: </font></strong>event log中，ANR的时间是 00：48：27，因为 AMS.appNotResponding()首先会打印 event log，然后再打印 system log，所以，在 system log 中，找到 ANR 的时间是 00:50:10。可以从这个时间点之前的日志中，还原 ANR 出现时系统的运行状态。</p>
<p><strong><font color="#7FF000" size="3">打印ANR日志的进程：</font></strong>ANR 日志都是在 system_server 进程中的 AMS 打印的，在 event log 和 system log 中，都能看到 820和 907，所以 system_server 的 PID 是 802，AMS 线程的 TID 是 907。ANR的监测机制实现在 AMS 线程，分析一些受系统影响的 ANR，需要知道 system_server 进程的运行状态。</p>
<p><strong><font color="#7FF000" size="3">发生ANR的进程：</font></strong>ANR in 关键字就表明了当前 ANR 的进程是 com.android.system.ui，通过event log，知道进程的PID是 29533。</p>
<p><strong><font color="#7FF000" size="3">发生ANR的原因：</font></strong>Reason 关键字表明了当前发生 ANR 的原因：处理 TIME_TICK 广播消息超时。隐含的意思是 TIME_TICK 是一个串行广播消息，在 29533 的主线程中，执行 BroadcastReceiver.onReceive() 方法已经超过10秒。</p>
<p><strong><font color="#7FF000" size="3">CPU负载：</font></strong>Load关键字表明了最近1分钟、5分钟、15分钟内的 CPU负载 分别是30.4、22.3、19.94。CPU最近1分钟的负载最具参考价值，因为 ANR 的超时限制基本都是1分钟以内，这可以近似的理解为 CPU 最近1分钟平均有 30.4 个任务要处理，这个负载值是比较高的。</p>
<p><strong><font color="#7FF000" size="3">CPU使用统计时间段：</font></strong>CPU usage from XX to XX ago关键字表明了这是在 ANR 发生之前一段时间内的CPU统计。类似的还有CPU usage from XX to XX after关键字，表明是 ANR 发生之后一段时间内的 CPU 统计。</p>
<p><strong><font color="#7FF000" size="3">各进程的CPU使用率：</font></strong>我们以 com.android.systemui 进程的CPU使用率为例，它包含以下信息：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 总的CPU使用率: 3.3%，其中 systemui 进程在用户态的 CPU 使用率是2.6%，在内核态的使用率是0.7%</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 缺页次数fault：8402 minor表示高速缓存中的缺页次数，343 major表示内存的缺页次数。minor可以理解为进程在做内存访问，major可以理解为进程在做IO操作。当前minor和major值都是比较高的，从侧面反映了发生 ANR 之前，systemui进程有有较多的内存访问操作，引发的IO次数也会较多</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 CPU使用率前面的 “+”。部分进程的 CPU 使用率前面有 “+” 号，例如：cat和zygote64，表示在上一次CPU统计的时间片段内，还没有这些进程，而这一次CPU统计的时间片段内，运行了这些进程。类似的还有 “-” 号，表示两次CPU统计时间片段时，这些进程消亡了</p>
<p><strong><font color="#7FF000" size="3">CPU使用汇总：</font></strong>TOTAL关键字表明了CPU使用的汇总，87%是总的CPU使用率，其中有一项 iowait 表明 CPU 在等待 IO 的时间，占到64%，说明发生ANR以前，有大量的IO操作。app_process、 system_server, com.android.systemui这几个进程的major值都比较大，说明这些进程的IO操作较为频繁，从而拉升了整个iowait的时间。</p>
<p>从以上日志可以看出的信息为：在 08-26 00:48:27 这个时刻，PID 为 29533 的进程发生了ANR，进程名是 com.android.systemui。</p>
<p>信息量是如此的庞大，以致于我们都要下结论了：CPU大量的时间都在等待IO，导致systemui进程分配不到CPU时间，从而主线程处理广播消息超时，发生了ANR。</p>
<p><strong><font color="#FF0000">对于一个严谨的开发人员而言，这种结论下得有点早，因为还有太多的疑问：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 systemui进程也分到了一些CPU时间(3.3%)，难道BroadcastReceiver.onReceive()方法就一直无法执行吗？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 为什么iowait的时间会这么多，而且多个进程的major值都很高？</p>
<h2 id="场景还原"><a href="#场景还原" class="headerlink" title="场景还原"></a>场景还原</h2><p>针对以上两个疑问点，我们进一步分析！</p>
<h3 id="第一个疑点"><a href="#第一个疑点" class="headerlink" title="第一个疑点"></a>第一个疑点</h3><p>我们先来做一个假设：如果 systemui 进程正在执行 BroadcatReceiver.onReceive() 方法，那么从 traces.txt 文件中，应该可以看到主线程的函数调用栈正在执行这个方法。</p>
<p>接下来，我们首先从 traces 文件中，找到发生 ANR 时(00:48:27)，sysemtui 进程的函数调用栈信息。</p>
<pre class=" language-log"><code class="language-log">----- pid 29533 at 2018-08-26 00:48:06 -----
Cmd line: com.android.systemui

DALVIK THREADS (53):
"main" prio=5 tid=1 Native
  | group="main" sCount=1 dsCount=0 obj=0x75bd5818 self=0x7f8549a000
  | sysTid=29533 nice=0 cgrp=bg_non_interactive sched=0/0 handle=0x7f894bbe58
  | state=S schedstat=( 288625433917 93454573244 903419 ) utm=20570 stm=8292 core=3 HZ=100
  | stack=0x7fdffda000-0x7fdffdc000 stackSize=8MB
  | held mutexes=
  native: #00 pc 00060b0c  /system/lib64/libc.so (__epoll_pwait+8)
  native: #01 pc 0001bb54  /system/lib64/libc.so (epoll_pwait+32)
  native: #02 pc 0001b3d8  /system/lib64/libutils.so (android::Looper::pollInner(int)+144)
  native: #03 pc 0001b75c  /system/lib64/libutils.so (android::Looper::pollOnce(int, int*, int*, void**)+76)
  native: #04 pc 000d7194  /system/lib64/libandroid_runtime.so (android::NativeMessageQueue::pollOnce(_JNIEnv*, int)+48)
  at android.os.MessageQueue.nativePollOnce(Native method)
  at android.os.MessageQueue.next(MessageQueue.java:148)
  at android.os.Looper.loop(Looper.java:151)
  at android.app.ActivityThread.main(ActivityThread.java:5718)
  at java.lang.reflect.Method.invoke!(Native method)
  at java.lang.reflect.Method.invoke(Method.java:372)
  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:975)
  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:770)

----- pid 29533 at 2018-08-26 00:48:29 -----
Cmd line: com.android.systemui

DALVIK THREADS (54):
"main" prio=5 tid=1 Blocked
  | group="main" sCount=1 dsCount=0 obj=0x75bd5818 self=0x7f8549a000
  | sysTid=29533 nice=0 cgrp=bg_non_interactive sched=0/0 handle=0x7f894bbe58
  | state=S schedstat=( 289080040422 93461978317 904874 ) utm=20599 stm=8309 core=0 HZ=100
  | stack=0x7fdffda000-0x7fdffdc000 stackSize=8MB
  | held mutexes=
  at com.mediatek.anrappmanager.MessageLogger.println(SourceFile:77)
  - waiting to lock <0x26b337a3> (a com.mediatek.anrappmanager.MessageLogger) held by thread 49
  at android.os.Looper.loop(Looper.java:195)
  at android.app.ActivityThread.main(ActivityThread.java:5718)
  at java.lang.reflect.Method.invoke!(Native method)
  at java.lang.reflect.Method.invoke(Method.java:372)
  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:975)
  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:770)
...
"Binder_5" prio=5 tid=49 Native
  | group="main" sCount=1 dsCount=0 obj=0x136760a0 self=0x7f7e453000
  | sysTid=6945 nice=0 cgrp=default sched=0/0 handle=0x7f6e3ce000
  | state=S schedstat=( 5505571091 4567508913 30743 ) utm=264 stm=286 core=4 HZ=100
  | stack=0x7f6b83f000-0x7f6b841000 stackSize=1008KB
  | held mutexes=
  native: #00 pc 00019d14  /system/lib64/libc.so (syscall+28)
  native: #01 pc 0005b5d8  /system/lib64/libaoc.so (???)
  native: #02 pc 002c6f18  /system/lib64/libaoc.so (???)
  native: #03 pc 00032c40  /system/lib64/libaoc.so (???)
  at libcore.io.Posix.getpid(Native method)
  at libcore.io.ForwardingOs.getpid(ForwardingOs.java:83)
  at android.system.Os.getpid(Os.java:176)
  at android.os.Process.myPid(Process.java:754)
  at com.mediatek.anrappmanager.MessageLogger.dump(SourceFile:219)
  - locked <0x26b337a3> (a com.mediatek.anrappmanager.MessageLogger)
  at com.mediatek.anrappmanager.ANRAppManager.dumpMessageHistory(SourceFile:65)
  at android.app.ActivityThread$ApplicationThread.dumpMessageHistory(ActivityThread.java:1302)
  at android.app.ApplicationThreadNative.onTransact(ApplicationThreadNative.java:682)
  at android.os.Binder.execTransact(Binder.java:451)
</0x26b337a3></0x26b337a3></code></pre>
<p>最终，我们找到 systemui 进程 ANR 时刻(00:48:27)附近的两个函数调用栈:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 在 ANR 发生之前(00:48:06)，主线程的函数调用栈处于正常状态：消息队列中，循环处理消息</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 在 ANR 发生之后2秒(00:48:29)，主线程处于 Blocked 状态，在等待一个被49号线程持有的锁。而49号线程是一个Binder线程，anrappmanager正在做dump操作。</p>
<p>至此，systemui 进程发生 ANR 的直接原因我们已经找到了，systemui 进程正在打印 traces，存在较长时间的 IO 操作，导致主线程阻塞，从而无法处理 TIME_TICK 广播消息，所以发生了 ANR。</p>
<p>要避免这种场景下的 ANR，我们就需要打破主线程中 Blocked 的逻辑。其实本例是由于 MTK 在 AOSP 的 android.os.Looper.loop() 扩展了打印消息队列的功能，该功能存在设计缺陷，会导致锁等待的情况。</p>
<h3 id="第二个疑点"><a href="#第二个疑点" class="headerlink" title="第二个疑点"></a>第二个疑点</h3><p>我们进一步挖掘在 systemui 还没有发生 ANR 时，就在打印 traces 的原因。带着上文提出的第二个疑问，我们来做另一个假设：iowait较高，而且多个进程的major都很高，可能是由于当前正在调用 AMS.dumpStackTraces() 方法，很多进程都需要将自己的函数调用栈写到 traces文件，所以 IO 就会较高。如果当前正在调用 AMS.dumpStackTraces() 方法，那说明当时系统已经发生了异常，要么已经有 ANR 发生，要么有 SNR 发生。</p>
<p>从event log中，我们检索到了另一个ANR：</p>
<pre class=" language-log"><code class="language-log">08-26 00:47:58 820 907 I am_anr  : [0,10464,com.android.settings,1086864965,Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)]
</code></pre>
<p>在 00:47:58 这个时刻，com.android.settings 进程发生了 ANR，而且 ANR 的时间在 systemui 之前(00:48:27)。这一下，我们就找到佐证了，正是因为 settings 进程先发生了 ANR，调用 AMS.dumpStackTraces()， 从而很多进程都开始了打印 traces 的操作，所以系统的整个 iowait 比较高，大量进程的 major 值也比较高，systemui 就在其列。在 MTK 逻辑的影响下，打印 ANR 日志会导致主线程阻塞，从而就连带引发了其他应用的 ANR。</p>
<p>在system log中，我们检索到了 settings 进程 ANR 的 CPU 使用信息：</p>
<pre class=" language-log"><code class="language-log">08-26 00:48:12 820 907 E ActivityManager: ANR in com.android.settings (com.android.settings/.SubSettings), time=130063718
08-26 00:48:12 820 907 E ActivityManager: Reason: Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)
08-26 00:48:12 820 907 E ActivityManager: Load: 21.37 / 19.25 / 18.84
08-26 00:48:12 820 907 E ActivityManager: Android time :[2015-08-26 00:48:12.24] [130077,742]
08-26 00:48:12 820 907 E ActivityManager: CPU usage from 0ms to 7676ms later:
08-26 00:48:12 820 907 E ActivityManager:   91% 820/system_server: 16% user + 75% kernel / faults: 13192 minor 167 major
08-26 00:48:12 820 907 E ActivityManager:   3.2% 175/mmcqd/0: 0% user + 3.2% kernel
08-26 00:48:12 820 907 E ActivityManager:   2.9% 29533/com.android.systemui: 2.3% user + 0.6% kernel / faults: 1352 minor 10 major
08-26 00:48:12 820 907 E ActivityManager:   2.2% 1736/com.android.phone: 0.9% user + 1.3% kernel / faults: 1225 minor 1 major
08-26 00:48:12 820 907 E ActivityManager:   2.2% 10464/com.android.settings: 0.7% user + 1.4% kernel / faults: 2801 minor 105 major
08-26 00:48:12 820 907 E ActivityManager:   0% 1785/com.meizu.experiencedatasync: 0% user + 0% kernel / faults: 3478 minor 2 major
08-26 00:48:12 820 907 E ActivityManager:   1.8% 11333/com.meizu.media.video: 1% user + 0.7% kernel / faults: 3843 minor 89 major
08-26 00:48:12 820 907 E ActivityManager:   1.5% 332/mobile_log_d: 0.5% user + 1% kernel / faults: 94 minor 1 major
08-26 00:48:12 820 907 E ActivityManager:   1% 11306/com.meizu.media.gallery: 0.7% user + 0.2% kernel / faults: 2204 minor 55 major
...
08-26 00:48:12 820 907 E ActivityManager:  +0% 11397/sh: 0% user + 0% kernel
08-26 00:48:12 820 907 E ActivityManager:  +0% 11398/app_process: 0% user + 0% kernel
08-26 00:48:12 820 907 E ActivityManager: 29% TOTAL: 5.1% user + 15% kernel + 9.5% iowait + 0% softirq
</code></pre>
<p>具体的涵义我们不再赘述了，只关注一下 ANR 的原因:</p>
<pre class=" language-log"><code class="language-log">Reason: Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)
</code></pre>
<p>之前对 Input ANR 机制的分析派上用长了，我们轻松知道这种 ANR 的原因是什么。 Wait queue length：1 表示之前的输入事件已经派发到 Settings 进程了，但 Settings 进程还没有处理完毕，新来的 KeyEvent 事件已经等待超过了5秒，所以ANR产生了。</p>
<p>接下来，又需要找到Settings的traces，分析Settings主线程处理输入事件超时的原因，这边不再详细分析。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong><font color="#7FF000" size="3">本文对 Android ANR 机制进行了深入的分析：</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 ANR的监测机制：从Service，Broadcast，InputEvent三种不同的ANR监测机制的源码实现开始，分析了 Android 如何发现各类 ANR。在启动服务、派发广播消息和输入事件时，植入超时检测，用于发现 ANR。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 ANR的报告机制：分析 Android 如何输出ANR日志。当 ANR 被发现后，两个很重要的日志输出是：CPU使用情况 和 进程的函数调用栈，这两类日志是我们解决ANR问题的利器。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;💥 ANR的解决方法：通过一个案例，对 ANR 日志进行了深入解读，梳理了分析ANR问题的思路和途径。</p>
<p>最后，致各位读者，从日志出发解决 ANR 问题，理解 ANR 机制背后的实现原理，碰到再难的 ANR 问题也无需惊慌。</p>
<h1 id="参考Blog"><a href="#参考Blog" class="headerlink" title="参考Blog"></a>参考Blog</h1><p>&nbsp;01. <a href="https://blog.csdn.net/wds1181977/article/details/78330212" target="_blank" rel="noopener">https://blog.csdn.net/wds1181977/article/details/78330212</a></p>
<h1 id="索引链接"><a href="#索引链接" class="headerlink" title="索引链接"></a>索引链接</h1><p>推荐跳转：<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">博客索引（Android 9.0）</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Hexo</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2018/08/26/07.xing-neng-you-hua-xi-lie-quan-mian-jie-xi-android-ying-yong-wen-ti-zhi-anr/" class="b-link-green">全面解析 Android 应用问题 之 ANR</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript。</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2018/09/03/07.xing-neng-you-hua-xi-lie-dai-ni-ling-lue-android-nei-cun-xie-lou-de-qian-shi-jin-sheng/">
                    <div class="card-image">
                        
                        <img src="http://poobjb5p7.bkt.clouddn.com/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg" class="responsive-img" alt="带你领略 Android 内存泄漏的前世今生">
                        
                        <span class="card-title">带你领略 Android 内存泄漏的前世今生</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
内存泄漏在项目的开发过程中是常见的问题，本章节对常见的泄漏原因，如：永远的单例、static 关键字、AsyncTask等作了详细的说明！


基础了解什么是内存泄漏？内存泄漏是当程序不再使用到的内存时，释放内存失败而产生了无用的内存消耗</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2018-09-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/性能优化/" class="post-category" target="_blank">
                                    性能优化
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/内存泄漏/" target="_blank">
                        <span class="chip bg-color">内存泄漏</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/08/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-yuan-li-zhi-jin-cheng-bei-sha/">
                    <div class="card-image">
                        
                        <img src="http://poobjb5p7.bkt.clouddn.com/%E6%9D%80%E8%BF%9B%E7%A8%8B%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg" class="responsive-img" alt="深入钻研 Android 核心原理 之 进程被杀">
                        
                        <span class="card-title">深入钻研 Android 核心原理 之 进程被杀</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
通过 killProcess、killProcessQuiet、killProcessGroup 三个杀进程的方法分析进程被杀的实现原理！


一、开篇1.1 核心源码


关键类
路径




Process.java
framewor</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-08-20
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/核心技术/" class="post-category" target="_blank">
                                    核心技术
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Process/" target="_blank">
                        <span class="chip bg-color">Process</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Hexo<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>