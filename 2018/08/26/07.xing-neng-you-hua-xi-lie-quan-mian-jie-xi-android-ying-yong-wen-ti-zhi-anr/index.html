<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="å…¨é¢è§£æ Android åº”ç”¨é—®é¢˜ ä¹‹ ANR, Hexo">
    <meta name="description" content="
ä¸ç®¡æ˜¯ç³»ç»Ÿå¼€å‘è¿˜æ˜¯åº”ç”¨å¼€å‘ï¼ŒANR ä¸€ç›´æ˜¯æŒ¥ä¹‹ä¸å»çš„å­˜åœ¨ï¼æœ¬æ–‡ä» ANR çš„è§¦å‘æœºåˆ¶ä»¥åŠä¸€ä¸ªç®€å•çš„èŒƒä¾‹æ¥æ¢è®¨ ANR çš„åŸç†å’Œå¤„ç†æ–¹æ³•ï¼


å¼€ç¯‡æ ¸å¿ƒæºç 


å…³é”®ç±»
è·¯å¾„




ActiveServices.java
framewor">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å…¨é¢è§£æ Android åº”ç”¨é—®é¢˜ ä¹‹ ANR | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>é¦–é¡µ</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>ç›®å½•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>æ ‡ç­¾</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>ç»„ä»¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å¯åŠ¨é˜¶æ®µ/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>å¼€æœº</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>æ¡†æ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/é€šä¿¡æœºåˆ¶/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>æœºåˆ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>ä¼˜åŒ–</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>æ¨¡å¼</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>ç®—æ³•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>æ‹“å±•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>ä½œè€…</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="æœç´¢"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                é¦–é¡µ
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                ç›®å½•
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                æ ‡ç­¾
            </a>
        </li>
        
        <li>
            <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                ç»„ä»¶
            </a>
        </li>
        
        <li>
            <a href="/categories/å¯åŠ¨é˜¶æ®µ/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                å¼€æœº
            </a>
        </li>
        
        <li>
            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                æ¡†æ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/é€šä¿¡æœºåˆ¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                æœºåˆ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                ä¼˜åŒ–
            </a>
        </li>
        
        <li>
            <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                æ¨¡å¼
            </a>
        </li>
        
        <li>
            <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                ç®—æ³•
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                æ‹“å±•
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                ä½œè€…
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('http://poobjb5p7.bkt.clouddn.com/ANR%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        å…¨é¢è§£æ Android åº”ç”¨é—®é¢˜ ä¹‹ ANR
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ANR/" target="_blank">
                                <span class="chip bg-color">ANR</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="post-category" target="_blank">
                                æ€§èƒ½ä¼˜åŒ–
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2018-08-26
                </div>

                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p><strong><font color="#AAAAAA">ä¸ç®¡æ˜¯ç³»ç»Ÿå¼€å‘è¿˜æ˜¯åº”ç”¨å¼€å‘ï¼ŒANR ä¸€ç›´æ˜¯æŒ¥ä¹‹ä¸å»çš„å­˜åœ¨ï¼æœ¬æ–‡ä» ANR çš„è§¦å‘æœºåˆ¶ä»¥åŠä¸€ä¸ªç®€å•çš„èŒƒä¾‹æ¥æ¢è®¨ ANR çš„åŸç†å’Œå¤„ç†æ–¹æ³•ï¼</font></strong></p>
</blockquote>
<hr>
<h1 id="å¼€ç¯‡"><a href="#å¼€ç¯‡" class="headerlink" title="å¼€ç¯‡"></a>å¼€ç¯‡</h1><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><table>
<thead>
<tr>
<th>å…³é”®ç±»</th>
<th>è·¯å¾„</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">ActiveServices.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ActivityManagerService.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</td>
</tr>
<tr>
<td><font color="#D15FEE">AppErrors.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/AppErrors.java</td>
</tr>
<tr>
<td><font color="#D15FEE">BroadcastQueue.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java</td>
</tr>
</tbody>
</table>
<h1 id="ANRæ¦‚è¿°"><a href="#ANRæ¦‚è¿°" class="headerlink" title="ANRæ¦‚è¿°"></a>ANRæ¦‚è¿°</h1><h2 id="ANRæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ANRæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ANRæ˜¯ä»€ä¹ˆï¼Ÿ"></a>ANRæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><strong><font color="#FF00FF">ANR(Application Not Responding)</font></strong>ï¼Œåº”ç”¨ç¨‹åºæ— å“åº”ï¼Œç®€å•ä¸€ä¸ªå®šä¹‰ï¼Œå´æ¶µç›–äº†å¾ˆå¤šAndroidç³»ç»Ÿçš„è®¾è®¡æ€æƒ³ã€‚</p>
<p>é¦–å…ˆï¼Œ<font color="#FF0000">ANRå±äºåº”ç”¨ç¨‹åºçš„èŒƒç•´ï¼Œè¿™ä¸åŒäºSNR(System Not Respoding)ï¼ŒSNRåæ˜ çš„é—®é¢˜æ˜¯ç³»ç»Ÿè¿›ç¨‹(system_server)å¤±å»äº†å“åº”èƒ½åŠ›ï¼Œè€ŒANRæ˜ç¡®å°†é—®é¢˜åœˆå®šåœ¨åº”ç”¨ç¨‹åº</font>ã€‚SNRç”±Watchdogæœºåˆ¶ä¿è¯ï¼ŒANRç”±æ¶ˆæ¯å¤„ç†æœºåˆ¶ä¿è¯ï¼ŒAndroidåœ¨ç³»ç»Ÿå±‚å®ç°äº†ä¸€å¥—ç²¾å¯†çš„æœºåˆ¶æ¥å‘ç°ANRï¼Œæ ¸å¿ƒåŸç†æ˜¯æ¶ˆæ¯è°ƒåº¦å’Œè¶…æ—¶å¤„ç†ã€‚</p>
<p>å…¶æ¬¡ï¼ŒANRæœºåˆ¶ä¸»ä½“å®ç°åœ¨ç³»ç»Ÿå±‚ã€‚æ‰€æœ‰ä¸ANRç›¸å…³çš„æ¶ˆæ¯ï¼Œéƒ½ä¼šç»è¿‡ç³»ç»Ÿè¿›ç¨‹(system_server)è°ƒåº¦ï¼Œç„¶åæ´¾å‘åˆ°åº”ç”¨è¿›ç¨‹å®Œæˆå¯¹æ¶ˆæ¯çš„å®é™…å¤„ç†ï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿè¿›ç¨‹è®¾è®¡äº†ä¸åŒçš„è¶…æ—¶é™åˆ¶æ¥è·Ÿè¸ªæ¶ˆæ¯çš„å¤„ç†ã€‚ä¸€æ—¦åº”ç”¨ç¨‹åºå¤„ç†æ¶ˆæ¯ä¸å½“ï¼Œè¶…æ—¶é™åˆ¶å°±èµ·ä½œç”¨äº†ï¼Œå®ƒæ”¶é›†ä¸€äº›ç³»ç»ŸçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šCPU/IOä½¿ç”¨æƒ…å†µã€è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆï¼Œå¹¶ä¸”æŠ¥å‘Šç”¨æˆ·æœ‰è¿›ç¨‹æ— å“åº”äº†(ANRå¯¹è¯æ¡†)ã€‚</p>
<p>ç„¶åï¼ŒANRé—®é¢˜æœ¬è´¨æ˜¯ä¸€ä¸ªæ€§èƒ½é—®é¢˜ã€‚ANRæœºåˆ¶å®é™…ä¸Šå¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„é™åˆ¶ï¼Œè¦æ±‚ä¸»çº¿ç¨‹åœ¨é™å®šçš„æ—¶é—´å†…å¤„ç†å®Œä¸€äº›æœ€å¸¸è§çš„æ“ä½œ(å¯åŠ¨æœåŠ¡ã€å¤„ç†å¹¿æ’­ã€å¤„ç†è¾“å…¥)ï¼Œå¦‚æœå¤„ç†è¶…æ—¶ï¼Œåˆ™è®¤ä¸ºä¸»çº¿ç¨‹å·²ç»å¤±å»äº†å“åº”å…¶ä»–æ“ä½œçš„èƒ½åŠ›ã€‚ä¸»çº¿ç¨‹ä¸­çš„è€—æ—¶æ“ä½œï¼Œä¾‹å¦‚ï¼šå¯†é›†CPUè¿ç®—ã€å¤§é‡IOã€å¤æ‚ç•Œé¢å¸ƒå±€ç­‰ï¼Œéƒ½ä¼šé™ä½åº”ç”¨ç¨‹åºçš„å“åº”èƒ½åŠ›ã€‚</p>
<p>æœ€åï¼Œéƒ¨åˆ†ANRé—®é¢˜æ˜¯å¾ˆéš¾åˆ†æçš„ï¼Œæœ‰æ—¶å€™ç”±äºç³»ç»Ÿåº•å±‚çš„ä¸€äº›å½±å“ï¼Œå¯¼è‡´æ¶ˆæ¯è°ƒåº¦å¤±è´¥ï¼Œå‡ºç°é—®é¢˜çš„åœºæ™¯åˆéš¾ä»¥å¤ç°ã€‚è¿™ç±»ANRé—®é¢˜å¾€å¾€éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´å»äº†è§£ç³»ç»Ÿçš„ä¸€äº›è¡Œä¸ºï¼Œè¶…å‡ºäº†ANRæœºåˆ¶æœ¬èº«çš„èŒƒç•´ã€‚</p>
<h2 id="ANRæœºåˆ¶"><a href="#ANRæœºåˆ¶" class="headerlink" title="ANRæœºåˆ¶"></a>ANRæœºåˆ¶</h2><p>åˆ†æä¸€äº›åˆçº§çš„ANRé—®é¢˜ï¼Œåªéœ€è¦ç®€å•ç†è§£æœ€ç»ˆè¾“å‡ºçš„æ—¥å¿—å³å¯ï¼Œä½†å¯¹äºä¸€äº›ç”±ç³»ç»Ÿé—®é¢˜(ä¾‹å¦‚ï¼šCPUè´Ÿè½½è¿‡é«˜ã€è¿›ç¨‹å¡æ­»)å¼•å‘çš„ANRï¼Œå°±éœ€è¦å¯¹æ•´ä¸ªANRæœºåˆ¶æœ‰æ‰€äº†è§£ï¼Œæ‰èƒ½å®šä½å‡ºé—®é¢˜çš„åŸå› ã€‚</p>
<p><strong><font color="#7FF000" size="3">ANRæœºåˆ¶å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ANRçš„ç›‘æµ‹ã€‚Androidå¯¹äºä¸åŒçš„ANRç±»å‹(Broadcast, Service, InputEvent)éƒ½æœ‰ä¸€å¥—ç›‘æµ‹æœºåˆ¶ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ANRçš„æŠ¥å‘Šã€‚åœ¨ç›‘æµ‹åˆ°ANRä»¥åï¼Œéœ€è¦æ˜¾ç¤ºANRå¯¹è¯æ¡†ã€è¾“å‡ºæ—¥å¿—(å‘ç”ŸANRæ—¶çš„è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆã€CPUä½¿ç”¨æƒ…å†µç­‰)ã€‚</p>
<h2 id="ANRçš„è§¦å‘åŸå› "><a href="#ANRçš„è§¦å‘åŸå› " class="headerlink" title="ANRçš„è§¦å‘åŸå› "></a>ANRçš„è§¦å‘åŸå› </h2><p>å‡ºç°ANRä¹‹åä¸€ä¸ªç›´è§‚ç°è±¡å°±æ˜¯ç³»ç»Ÿä¼šå±•ç¤ºå‡ºä¸€ä¸ªANRå¯¹è¯æ¡†ã€‚</p>
<p><strong><font color="#7FF000" size="3">è°·æ­Œæ–‡æ¡£ä¸­å¯¹ANRäº§ç”Ÿçš„åŸå› æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</font></strong></p>
<p>Androidç³»ç»Ÿä¸­çš„åº”ç”¨è¢«Activity ManageråŠWindow Managerä¸¤ä¸ªç³»ç»ŸæœåŠ¡ç›‘æ§ç€ï¼ŒAndroidç³»ç»Ÿä¼šåœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µå±•ç¤ºå‡ºANRçš„å¯¹è¯æ¡†<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ KeyDispatchTimeout(<font color="#FF0000"> 5 seconds</font> ) ï¼šæŒ‰é”®æˆ–è§¦æ‘¸äº‹ä»¶åœ¨ç‰¹å®šæ—¶é—´å†…æ— å“åº”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ BroadcastTimeout(<font color="#FF0000"> 10 seconds</font> )ï¼šBroadcastReceiver åœ¨ç‰¹å®šæ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ServiceTimeout(<font color="#FF0000"> 20 seconds</font> ) ï¼šService åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ</p>
<h1 id="ANRçš„ç›‘æµ‹æœºåˆ¶"><a href="#ANRçš„ç›‘æµ‹æœºåˆ¶" class="headerlink" title="ANRçš„ç›‘æµ‹æœºåˆ¶"></a>ANRçš„ç›‘æµ‹æœºåˆ¶</h1><h2 id="Serviceè¶…æ—¶å¤„ç†"><a href="#Serviceè¶…æ—¶å¤„ç†" class="headerlink" title="Serviceè¶…æ—¶å¤„ç†"></a>Serviceè¶…æ—¶å¤„ç†</h2><p>Service è¿è¡Œåœ¨åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹ï¼Œå¦‚æœ Service çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡20ç§’ï¼Œåˆ™ä¼šå¼•å‘ ANRã€‚</p>
<p>å½“å‘ç”Ÿ Service ANR æ—¶ï¼Œä¸€èˆ¬å¯ä»¥å…ˆæ’æŸ¥ä¸€ä¸‹åœ¨ Service çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­(onCreate(), onStartCommand()ç­‰)æœ‰æ²¡æœ‰åšè€—æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚å¤æ‚çš„è¿ç®—ã€IOæ“ä½œç­‰ã€‚å¦‚æœåº”ç”¨ç¨‹åºçš„ä»£ç é€»è¾‘æŸ¥ä¸å‡ºé—®é¢˜ï¼Œå°±éœ€è¦æ·±å…¥æ£€æŸ¥å½“å‰ç³»ç»Ÿçš„çŠ¶æ€ï¼šCPUçš„ä½¿ç”¨æƒ…å†µã€ç³»ç»ŸæœåŠ¡çš„çŠ¶æ€ç­‰ï¼Œåˆ¤æ–­å½“æ—¶å‘ç”ŸANRè¿›ç¨‹æ˜¯å¦å—åˆ°ç³»ç»Ÿè¿è¡Œå¼‚å¸¸çš„å½±å“ã€‚</p>
<p>å¦‚ä½•æ£€æµ‹Serviceè¶…æ—¶å‘¢ï¼ŸAndroidæ˜¯é€šè¿‡è®¾ç½®å®šæ—¶æ¶ˆæ¯å®ç°çš„ã€‚å®šæ—¶æ¶ˆæ¯æ˜¯ç”±AMSçš„æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†çš„(system_serverçš„ActivityManagerçº¿ç¨‹)ã€‚AMSæœ‰Serviceè¿è¡Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨AMSä¸­è®¾ç½®ä¸€å¥—è¶…æ—¶æ£€æµ‹æœºåˆ¶ä¹Ÿæ˜¯åˆæƒ…åˆç†çš„ã€‚</p>
<p>Service ANRæœºåˆ¶ç›¸å¯¹æœ€ä¸ºç®€å•ï¼Œä¸»ä½“å®ç°åœ¨<font color="#FF00FF"> ActiveServices </font>ä¸­ã€‚ å½“Serviceçš„ç”Ÿå‘½å‘¨æœŸå¼€å§‹æ—¶ï¼Œ <font color="#FF00FF">bumpServiceExecutingLocked()</font> ä¼šè¢«è°ƒç”¨ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fg<span class="token punctuation">,</span> String why<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>executeFg <span class="token operator">=</span> fg<span class="token punctuation">;</span>
            ServiceState stracker <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stracker <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stracker<span class="token punctuation">.</span><span class="token function">setExecuting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">.</span><span class="token function">getMemFactorLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">|=</span> fg<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> fg <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨scheduleServiceTimeoutLocked()</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>executeFg <span class="token operator">|=</span> fg<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>executeNesting<span class="token operator">++</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>executingStart <span class="token operator">=</span> now<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ç´§æ¥ç€ä¼šè°ƒç”¨ <font color="#FF00FF">scheduleServiceTimeoutLocked()</font> ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>ProcessRecord proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Message msg <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
                ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> proc<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡AMS.MainHandleræŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯</span>
        mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>
                proc<span class="token punctuation">.</span>execServicesFg <span class="token operator">?</span> SERVICE_TIMEOUT <span class="token operator">:</span> SERVICE_BACKGROUND_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/// M: ANR Debug Mechanism</span>
        mAm<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">sendServiceMonitorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šè¿°æ–¹æ³•é€šè¿‡ <font color="#FF00FF">AMS.MainHandler</font> æŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ <font color="#FF00FF">SERVICE_TIMEOUT_MSG<font> ï¼š</font></font></p>
<font color="#7FF000" size="3">å‰å°è¿›ç¨‹ä¸­æ‰§è¡ŒServiceï¼Œè¶…æ—¶æ—¶é—´æ˜¯SERVICE_TIMEOUT(20ç§’)</font>

<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_TIMEOUT <span class="token operator">=</span> <span class="token number">20</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre>
<font color="#7FF000" size="3">åå°è¿›ç¨‹ä¸­æ‰§è¡ŒServiceï¼Œè¶…æ—¶æ—¶é—´æ˜¯SERVICE_BACKGROUND_TIMEOUT(200ç§’)</font>

<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_BACKGROUND_TIMEOUT <span class="token operator">=</span> SERVICE_TIMEOUT <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre>
<p>å½“ Service çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">serviceDoneExecutingLocked()</font> æ–¹æ³•ï¼Œä¹‹å‰æŠ›å‡ºçš„ <font color="#FF00FF">SERVICE_TIMEOUT_MSG</font> æ¶ˆæ¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šè¢«æ¸…é™¤ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">,</span> <span class="token keyword">int</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> inDestroying <span class="token operator">=</span> mDestroyingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> inDestroying<span class="token punctuation">,</span> inDestroying<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inDestroying<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>å¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…ï¼Œ <font color="#FF00FF">SERVICE_TIMEOUT_MSG</font> æ²¡æœ‰è¢«æ¸…é™¤ï¼Œé‚£ä¹ˆï¼Œ <font color="#FF00FF">AMS.MainHandler</font> å°±ä¼šå“åº”è¿™ä¸ªæ¶ˆæ¯ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MainHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">MainHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">case</span> SERVICE_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">/// M: ANR Debug Mechanism @{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mAnrManager<span class="token punctuation">.</span><span class="token function">delayMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> SERVICE_TIMEOUT_MSG<span class="token punctuation">,</span>
                        ActiveServices<span class="token punctuation">.</span>SERVICE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/// @}</span>
                mServices<span class="token punctuation">.</span><span class="token function">serviceTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ProcessRecord<span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">serviceTimeout</span><span class="token punctuation">(</span>ProcessRecord proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String anrMessage <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mAm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> maxTime <span class="token operator">=</span>  now <span class="token operator">-</span>
                    <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>execServicesFg <span class="token operator">?</span> SERVICE_TIMEOUT <span class="token operator">:</span> SERVICE_BACKGROUND_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceRecord timeout <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">long</span> nextTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// å¯»æ‰¾è¿è¡Œè¶…æ—¶çš„Service</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ServiceRecord sr <span class="token operator">=</span> proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sr<span class="token punctuation">.</span>executingStart <span class="token operator">&lt;</span> maxTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    timeout <span class="token operator">=</span> sr<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sr<span class="token punctuation">.</span>executingStart <span class="token operator">></span> nextTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextTime <span class="token operator">=</span> sr<span class="token punctuation">.</span>executingStart<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// åˆ¤æ–­æ‰§è¡ŒServiceè¶…æ—¶çš„è¿›ç¨‹æ˜¯å¦åœ¨æœ€è¿‘è¿è¡Œè¿›ç¨‹åˆ—è¡¨ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™å¿½ç•¥è¿™ä¸ªANR</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mAm<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Timeout executing service: "</span> <span class="token operator">+</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                StringWriter sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PrintWriter pw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastPrintWriter</span><span class="token punctuation">(</span>sw<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                timeout<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>pw<span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mLastAnrDump <span class="token operator">=</span> sw<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mLastAnrDumpClearer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mLastAnrDumpClearer<span class="token punctuation">,</span> LAST_ANR_LIFETIME_DURATION_MSECS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                anrMessage <span class="token operator">=</span> <span class="token string">"executing service "</span> <span class="token operator">+</span> timeout<span class="token punctuation">.</span>shortName<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>anrMessage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAm<span class="token punctuation">.</span>mAppErrors<span class="token punctuation">.</span><span class="token function">appNotResponding</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> anrMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šè¿°æ–¹æ³•ä¼šæ‰¾åˆ°å½“å‰è¿›ç¨‹å·²ç»è¶…æ—¶çš„ Service ï¼Œç»è¿‡ä¸€äº›åˆ¤å®šåï¼Œå†³å®šè¦æŠ¥å‘Š ANR ï¼Œæœ€ç»ˆè°ƒç”¨ <font color="#FF00FF">AMS.appNotResponding()</font> æ–¹æ³•ã€‚</p>
<p>èµ°åˆ°è¿™ä¸€æ­¥ï¼ŒANR æœºåˆ¶å·²ç»å®Œæˆäº†ç›‘æµ‹æŠ¥å‘Šä»»åŠ¡ï¼Œå‰©ä¸‹çš„ä»»åŠ¡å°±æ˜¯ ANR ç»“æœçš„è¾“å‡ºï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º ANR çš„æŠ¥å‘Šæœºåˆ¶ã€‚ANR çš„æŠ¥å‘Šæœºåˆ¶æ˜¯é€šè¿‡ <font color="#FF00FF">AMS.appNotResponding()</font> å®Œæˆçš„ï¼ŒBroadcast å’Œ InputEvent ç±»å‹çš„ ANR æœ€ç»ˆä¹Ÿéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p>
<h2 id="Broadcastè¶…æ—¶å¤„ç†"><a href="#Broadcastè¶…æ—¶å¤„ç†" class="headerlink" title="Broadcastè¶…æ—¶å¤„ç†"></a>Broadcastè¶…æ—¶å¤„ç†</h2><p>åº”ç”¨ç¨‹åºå¯ä»¥æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ï¼Œå®ç° BroadcastReceiver.onReceive() æ–¹æ³•æ¥å®Œæˆå¯¹å¹¿æ’­çš„å¤„ç†ã€‚é€šå¸¸ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼ŒAndroid é™å®šå®ƒæ‰§è¡Œæ—¶é—´ä¸èƒ½è¶…è¿‡10ç§’ï¼Œå¦åˆ™ï¼Œå°±ä¼šå¼•å‘ ANRã€‚</p>
<p>onReceive()ä¹Ÿå¯ä»¥è°ƒåº¦åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼Œé€šè¿‡ Context.registerReceiver(BroadcastReceiver, IntentFilter, String, Handler) è¿™ä¸ªæ–¹æ³•æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªå¤„ç†çš„ Handlerï¼Œå°† onReceive() è°ƒåº¦åœ¨éä¸»çº¿ç¨‹æ‰§è¡Œã€‚</p>
<p><strong><font color="#7FF000" size="3">è¿™è¾¹æˆ‘ä»¬å…ˆæŠ›å‡ºä¸¤ä¸ªé—®é¢˜ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ Androidå¦‚ä½•å°†å¹¿æ’­æŠ•é€’ç»™å„ä¸ªåº”ç”¨ç¨‹åºï¼Ÿ</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ Androidå¦‚ä½•æ£€æµ‹å¹¿æ’­å¤„ç†è¶…æ—¶ï¼Ÿ</p>
<h3 id="å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦"><a href="#å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦" class="headerlink" title="å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦"></a>å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦</h3><p>AMSç»´æŠ¤äº†ä¸¤ä¸ªå¹¿æ’­é˜Ÿåˆ—BroadcastQueue:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ foreground queueï¼Œå‰å°é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´æ˜¯10ç§’<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ background queueï¼Œåå°é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´æ˜¯60ç§’</p>
<p>ä¹‹æ‰€ä»¥æœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å› ä¸ºè¦åŒºåˆ†ä¸åŒè¶…æ—¶æ—¶é—´ã€‚æ‰€æœ‰å‘é€çš„å¹¿æ’­éƒ½ä¼šè¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦ï¼Œåœ¨å‘é€å¹¿æ’­æ—¶ï¼Œå¯ä»¥é€šè¿‡ <font color="#FF00FF">Intent.FLAG_RECEIVER_FOREGROUND</font> å‚æ•°å°†å¹¿æ’­æŠ•é€’åˆ°å‰å°é˜Ÿåˆ—ã€‚</p>
<p>AMSçº¿ç¨‹ä¼šä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡ºå¹¿æ’­æ¶ˆæ¯æ´¾å‘åˆ°å„ä¸ªæ¥æ”¶å™¨(BroadcastReceiver)ã€‚å½“è¦æ´¾å‘å¹¿æ’­æ—¶ï¼ŒAMS ä¼šè°ƒç”¨ <font color="#FF00FF">BroadcastQueue.scheduleBroadcastsLocked()</font> æ–¹æ³•ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBroadcastsScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_INTENT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå¾€AMSçº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€BROADCAST_INTENT_MSGæ¶ˆæ¯ï¼Œç”±æ­¤ä¹Ÿå¯ä»¥çœ‹åˆ°çœŸæ­£æ´¾å‘å¹¿æ’­çš„æ˜¯AMSçº¿ç¨‹(system_serverè¿›ç¨‹ä¸­çš„ActivityManagerçº¿ç¨‹)ã€‚ç”±äºä¸Šè¿°æ–¹æ³•å¯èƒ½è¢«å¹¶å‘è°ƒç”¨ï¼Œæ‰€ä»¥é€šè¿‡mBroadcastsScheduledè¿™ä¸ªå˜é‡æ¥æ ‡è¯†BROADCAST_INTENT_MSGæ˜¯ä¸æ˜¯å·²ç»è¢«AMSçº¿ç¨‹æ¥æ”¶äº†ï¼Œå½“å·²ç»æŠ›å‡ºçš„æ¶ˆæ¯è¿˜æœªè¢«æ¥å—æ—¶ï¼Œä¸éœ€è¦é‡æ–°æŠ›å‡ºã€‚ </p>
<p>è¯¥æ¶ˆæ¯è¢«æ¥æ”¶åçš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">BroadcastHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> BROADCAST_INTENT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> BROADCAST_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ç›´æ¥è°ƒç”¨ <font color="#FF00FF">BroadcastQueue.processNextBroadcast()</font> æ–¹æ³•ï¼ŒfromMsgå‚æ•°ä¸ºtrueè¡¨ç¤ºè¿™æ˜¯ä¸€æ¬¡æ¥è‡ªBROADCAST_INTENT_MSGæ¶ˆæ¯çš„æ´¾å‘è¯·æ±‚ã€‚<font color="#FF00FF">BroadcastQueue.processNextBroadcast()</font>æ˜¯æ´¾å‘å¹¿æ’­æ¶ˆæ¯æœ€ä¸ºæ ¸å¿ƒçš„å‡½æ•°ï¼Œä»£ç é‡è‡ªç„¶ä¹Ÿä¸å°ï¼Œæˆ‘ä»¬åˆ†æˆå‡ ä¸ªéƒ¨åˆ†æ¥åˆ†æï¼š</p>
<h4 id="é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­ä¿¡æ¯"><a href="#é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­ä¿¡æ¯" class="headerlink" title="é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­ä¿¡æ¯"></a>é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­ä¿¡æ¯</h4><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†éä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            âœ¨ <span class="token comment" spellcheck="true">// â‘  è®¾ç½®mBroadcastsScheduled</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// fromMsg å‚æ•°ä¸º true è¡¨ç¤ºè¿™æ˜¯ä¸€æ¬¡æ¥è‡ª BROADCAST_INTENT_MSG æ¶ˆæ¯çš„æ´¾å‘è¯·æ±‚              </span>
                mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            âœ¨ <span class="token comment" spellcheck="true">// â‘¡ å¤„ç†â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Object target <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            âœ¨ <span class="token comment" spellcheck="true">// â‘¢ å¤„ç†é˜»å¡çš„å¹¿æ’­æ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// It's still alive, so keep waiting</span>
                    <span class="token comment" spellcheck="true">// isDeadè¡¨ç¤ºå½“å‰å¹¿æ’­æ¶ˆæ¯çš„è¿›ç¨‹çš„å­˜æ´»çŠ¶æ€</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœè¿˜æ´»ç€ï¼Œåˆ™è¿”å›è¯¥å‡½æ•°ï¼Œç»§ç»­ç­‰å¾…ä¸‹æ¬¡æ´¾å‘</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†åˆ†æè¿™ä¸‰éƒ¨åˆ†çš„å‡½æ•°æ‰€åšå·¥ä½œï¼š</p>
<p><strong><font color="#7FF000" size="3">1ã€è®¾ç½®mBroadcastsScheduled</font></strong></p>
<p>è¯¥å˜é‡åœ¨å‰æ–‡è¯´è¿‡ï¼Œæ˜¯å¯¹ BROADCAST_INTENT_MSG è¿›è¡Œæ§åˆ¶ã€‚ å¦‚æœæ˜¯å“åº” BROADCAST_INTENT_MSG çš„æ´¾å‘è°ƒç”¨ï¼Œåˆ™å°† mBroadcastsScheduled è®¾ä¸ºfalseï¼Œ è¡¨ç¤ºæœ¬æ¬¡ BROADCAST_INTENT_MSG å·²ç»å¤„ç†å®Œæ¯•ï¼Œå¯ä»¥ç»§ç»­æŠ›å‡ºä¸‹ä¸€æ¬¡ BROADCAST_INTENT_MSG æ¶ˆæ¯äº†ã€‚</p>
<p><strong><font color="#7FF000" size="3">2ã€å¤„ç†â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€</font></strong></p>
<p>æˆ‘ä»¬çŸ¥é“å¹¿æ’­æ¥æ”¶å™¨æœ‰â€œåŠ¨æ€â€å’Œâ€œé™æ€â€ä¹‹åˆ†ï¼Œé€šè¿‡ Context.registerReceiver() æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸ºâ€œåŠ¨æ€â€çš„ï¼Œé€šè¿‡ AndroidManifest.xml æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸ºâ€œé™æ€â€çš„ã€‚</p>
<p>å¹¿æ’­æ¶ˆæ¯æœ‰â€œå¹¶è¡Œâ€å’Œâ€œä¸²è¡Œâ€ä¹‹åˆ†ï¼Œâ€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€éƒ½ä¼šæ´¾å‘åˆ°â€œåŠ¨æ€â€æ¥æ”¶å™¨ï¼Œâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€åˆ™ä¼šæ ¹æ®å®é™…æƒ…å†µæ´¾å‘åˆ°ä¸¤ç§æ¥æ”¶å™¨ã€‚æˆ‘ä»¬å…ˆä¸å»æ¢ç©¶ Android ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œåªå…³æ³¨è¿™ä¸¤ç§å¹¿æ’­æ¶ˆæ¯æ´¾å‘çš„åŒºåˆ«ã€‚</p>
<p><strong>åœ¨BroadcastQueueç»´æŠ¤ç€ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF0000">mParallelBroadcasts</font></strong>ï¼šâ€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€éƒ½ä¼šè¿›å…¥åˆ°æ­¤é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€å¯ä»¥ä¸€æ¬¡æ€§æ´¾å‘å®Œæ¯•ï¼Œå³åœ¨ä¸€ä¸ªå¾ªç¯ä¸­å°†å¹¿æ’­æ´¾å‘åˆ°æ‰€æœ‰çš„â€œåŠ¨æ€â€æ¥æ”¶å™¨ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF0000">mOrderedBroadcasts</font></strong>ï¼šâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€éƒ½ä¼šè¿›å…¥åˆ°æ­¤é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€éœ€è¦è½®ä¾¯æ´¾å‘ï¼Œå½“ä¸€ä¸ªæ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼Œä¼šå†æŠ›å‡º BROADCAST_INTENT_MSG æ¶ˆæ¯ï¼Œå†æ¬¡è¿›å…¥ BroadcastQueue.processNextBroadcast() å¤„ç†ä¸‹ä¸€ä¸ªã€‚</p>
<p><strong><font color="#7FF000" size="3">3ã€å¤„ç†é˜»å¡çš„å¹¿æ’­æ¶ˆæ¯</font></strong></p>
<p>æœ‰æ—¶å€™ä¼šå­˜åœ¨ä¸€ä¸ªå¹¿æ’­æ¶ˆæ¯æ´¾å‘ä¸å‡ºå»çš„æƒ…å†µï¼Œè¿™ä¸ªå¹¿æ’­æ¶ˆæ¯ä¼šä¿å­˜åœ¨ mPendingBroadcast å˜é‡ä¸­ã€‚æ–°ä¸€è½®çš„æ´¾å‘å¯åŠ¨æ—¶ï¼Œä¼šåˆ¤æ–­æ¥æ”¶è¯¥æ¶ˆæ¯çš„è¿›ç¨‹æ˜¯å¦è¿˜æ´»ç€ï¼Œå¦‚æœæ¥æ”¶è¿›ç¨‹è¿˜æ´»ç€ï¼Œé‚£ä¹ˆå°±ç»§ç»­ç­‰å¾…ã€‚å¦åˆ™ï¼Œå°±æ”¾å¼ƒè¿™ä¸ªå¹¿æ’­æ¶ˆæ¯ã€‚</p>
<h4 id="é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­ä¿¡æ¯"><a href="#é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­ä¿¡æ¯" class="headerlink" title="é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­ä¿¡æ¯"></a>é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­ä¿¡æ¯</h4><p>æ¥ä¸‹æ¥æ˜¯æœ€ä¸ºå¤æ‚çš„ä¸€éƒ¨åˆ†ï¼Œ<strong><font color="#FF7F24">å¤„ç†â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€ï¼ŒANR ç›‘æµ‹æœºåˆ¶åªåœ¨è¿™ä¸€ç±»å¹¿æ’­æ¶ˆæ¯ä¸­æ‰å‘æŒ¥ä½œç”¨</font></strong>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong><font color="#FF0000">â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€æ˜¯ä¸ä¼šå‘ç”ŸANRçš„</font></strong>ã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            <span class="token keyword">boolean</span> looped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> forceReceive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> numReceivers <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

                âœ¨ <span class="token comment" spellcheck="true">// â‘  å¹¿æ’­æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªANRç›‘æµ‹æœºåˆ¶</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessesReady <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numReceivers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token punctuation">(</span>now <span class="token operator">></span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mTimeoutPeriod<span class="token operator">*</span>numReceivers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token comment" spellcheck="true">/// M: ANR Debug Mechanism</span>
                            <span class="token operator">!</span>mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">isAnrDeferrable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// forcibly finish this broadcast</span>
                        forceReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                âœ¨ <span class="token comment" spellcheck="true">// â‘¡ åˆ¤æ–­è¯¥å¹¿æ’­æ¶ˆæ¯æ˜¯å¦å¤„ç†å®Œæ¯•</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">>=</span> numReceivers
                        <span class="token operator">||</span> r<span class="token punctuation">.</span>resultAbort <span class="token operator">||</span> forceReceive<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                    <span class="token function">cancelBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                    mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    looped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<p>è¿™éƒ¨åˆ†æ˜¯ä¸€ä¸ª <font color="#FF00FF">do-while</font> å¾ªç¯ï¼Œæ¯æ¬¡éƒ½ä» <font color="#FF00FF">mOrderedBroadcasts</font> é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€æ¡å¹¿æ’­æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚ç¬¬ä¸€ä¸ª <font color="#FF00FF">Broadcast ANR</font> ç›‘æµ‹æœºåˆ¶åƒå‘¼ä¸‡å”¤æ€»ç®—æ˜¯å‡ºç°äº†ï¼š</p>
<p><strong><font color="#7FF000" size="3">1ã€åˆ¤å®šå½“å‰æ—¶é—´æ˜¯å¦å·²ç»è¶…è¿‡äº† r.dispatchTime + 2Ã—mTimeoutPeriodÃ—numReceiversã€‚</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ dispatchTime è¡¨ç¤ºè¿™ä¸€ç³»åˆ—å¹¿æ’­æ¶ˆæ¯å¼€å§‹æ´¾å‘çš„æ—¶é—´ã€‚â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€æ˜¯é€ä¸ªæ¥æ”¶å™¨æ´¾å‘çš„ï¼Œä¸€ä¸ªæ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼Œæ‰å¼€å§‹å¤„ç†ä¸‹ä¸€ä¸ªæ¶ˆæ¯æ´¾å‘ã€‚å¼€å§‹æ´¾å‘åˆ°ç¬¬ä¸€ä¸ªæ¥æ”¶å™¨çš„æ—¶é—´å°±æ˜¯ dispatchTimeã€‚ dispatchTime éœ€è¦å¼€å§‹ç­‰å¹¿æ’­æ¶ˆæ¯æ´¾å‘ä»¥åæ‰ä¼šè®¾å®šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€æ¬¡è¿›å…¥processNextBroadcast()æ—¶ï¼ŒdispatchTime=0,å¹¶ä¸ä¼šè¿›å…¥è¯¥æ¡ä»¶åˆ¤æ–­ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ mTimeoutPeriod ç”±å½“å‰ BroadcastQueue çš„ç±»å‹å†³å®š(forgroundä¸º10ç§’ï¼Œbackgroundä¸º60ç§’)ã€‚è¿™ä¸ªæ—¶é—´åœ¨åˆå§‹åŒ– BroadcastQueue çš„æ—¶å€™å°±è®¾ç½®å¥½äº†ï¼Œæœ¬æ„æ˜¯é™å®šæ¯ä¸€ä¸ª Receiver å¤„ç†å¹¿æ’­çš„æ—¶é—´ï¼Œè¿™é‡Œåˆ©ç”¨å®ƒåšäº†ä¸€ä¸ªè¶…æ—¶è®¡ç®—ã€‚</p>
<p><strong><font color="#7FF000" size="3">2ã€å¦‚æœå¹¿æ’­æ¶ˆæ¯å·²ç»å¤„ç†å®Œæ¯•ï¼Œåˆ™ä»mOrderedBroadcastsä¸­ç§»é™¤ï¼Œé‡æ–°å¾ªç¯ï¼Œå¤„ç†ä¸‹ä¸€æ¡;å¦åˆ™ï¼Œå°±ä¼šè·³å‡ºå¾ªç¯ã€‚</font></strong></p>
<h4 id="é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯"><a href="#é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯" class="headerlink" title="é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯"></a>é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯</h4><p>ä»¥ä¸Šä»£ç å—å®Œæˆçš„ä¸»è¦ä»»åŠ¡æ˜¯ä»é˜Ÿåˆ—ä¸­å–ä¸€æ¡â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€ï¼Œæ¥ä¸‹æ¥å°±å‡†å¤‡æ´¾å‘äº†ã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment" spellcheck="true">// ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯çš„ç¬¬äºŒä¸ªANRç›‘æµ‹æœºåˆ¶</span>
            r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>å–å‡ºâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€åï¼Œä¸€æ—¦è¦å¼€å§‹æ´¾å‘ï¼Œç¬¬äºŒä¸ªANRæ£€æµ‹æœºåˆ¶å°±å‡ºç°äº†ã€‚</p>
<p><font color="#FF00FF">mPendingBroadcastTimeoutMessage</font> å˜é‡ç”¨äºæ ‡è¯†å½“å‰æ˜¯å¦æœ‰é˜»å¡çš„è¶…æ—¶æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨ <font color="#FF00FF">BroadcastQueue.setBroadcastTimeoutLocked()</font>ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_TIMEOUT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingBroadcastTimeoutMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">sendBroadcastMonitorMessage</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">,</span> mTimeoutPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>é€šè¿‡è®¾ç½®ä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ <font color="#FF00FF">BROADCAST_TIMEOUT_MSG </font>æ¥è·Ÿè¸ªå½“å‰å¹¿æ’­æ¶ˆæ¯çš„æ‰§è¡Œæƒ…å†µï¼Œè¿™ç§è¶…æ—¶ç›‘æµ‹æœºåˆ¶è·Ÿ Service ANR å¾ˆç±»ä¼¼ï¼Œä¹Ÿæ˜¯æŠ›åˆ° AMS çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœæ‰€æœ‰çš„æ¥æ”¶å™¨éƒ½å¤„ç†å®Œæ¯•äº†ï¼Œåˆ™ä¼šè°ƒç”¨ <font color="#FF00FF">cancelBroadcastTimeoutLocked()</font> æ¸…é™¤è¯¥æ¶ˆæ¯ï¼›å¦åˆ™ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šå“åº”ï¼Œå¹¶è°ƒç”¨ <font color="#FF00FF">broadcastTimeoutLocked()</font>ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ç¬¬ä¸€ç§ ANR ç›‘æµ‹æœºåˆ¶çš„æ—¶å€™è°ƒç”¨è¿‡ï¼Œç¬¬äºŒç§ ANR ç›‘æµ‹æœºåˆ¶ä¹Ÿä¼šè°ƒç”¨ã€‚</p>
<h4 id="é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯"><a href="#é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯" class="headerlink" title="é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯"></a>é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯</h4><p>è®¾ç½®å®Œå®šæ—¶æ¶ˆæ¯åï¼Œå°±å¼€å§‹æ´¾å‘å¹¿æ’­æ¶ˆæ¯äº†ï¼Œé¦–å…ˆæ˜¯â€œåŠ¨æ€â€æ¥æ”¶å™¨ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            <span class="token keyword">final</span> BroadcastOptions brOptions <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">;</span>
            <span class="token keyword">final</span> Object nextReceiver <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// åŠ¨æ€æ¥æ”¶å™¨çš„ç±»å‹éƒ½æ˜¯BroadcastFilter</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextReceiver <span class="token keyword">instanceof</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                BroadcastFilter filter <span class="token operator">=</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>
                <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre>
<p>â€œåŠ¨æ€â€æ¥æ”¶å™¨çš„è½½ä½“è¿›ç¨‹ä¸€èˆ¬æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€çš„ï¼Œæ‰€ä»¥å‘è¿™ç§ç±»å‹çš„æ¥æ”¶å™¨æ´¾å‘æ¶ˆæ¯ç›¸å¯¹ç®€å•ï¼Œè°ƒç”¨ <font color="#FF00FF">BroadcastQueue.deliverToRegisteredReceiverLocked()</font> å®Œæˆæ¥ä¸‹æ¥çš„å·¥ä½œã€‚</p>
<h4 id="é˜¶æ®µäº”ï¼šå‘â€œé™æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯"><a href="#é˜¶æ®µäº”ï¼šå‘â€œé™æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯" class="headerlink" title="é˜¶æ®µäº”ï¼šå‘â€œé™æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯"></a>é˜¶æ®µäº”ï¼šå‘â€œé™æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯</h4><p>â€œé™æ€â€æ¥æ”¶å™¨æ˜¯åœ¨AndroidManifest.xmlä¸­æ³¨å†Œçš„ï¼Œæ´¾å‘çš„æ—¶å€™ï¼Œå¯èƒ½å¹¿æ’­æ¥æ”¶å™¨çš„è½½ä½“è¿›ç¨‹è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥ï¼Œè¿™ç§åœºæ™¯ä¼šå¤æ‚å¾ˆå¤šã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BroadcastRecord r<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäº”ï¼šå‘â€œé™æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ

            <span class="token comment" spellcheck="true">// é™æ€æ¥æ”¶å™¨çš„ç±»å‹éƒ½æ˜¯ ResolveInfo</span>
            ResolveInfo info <span class="token operator">=</span>
                <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>

            âœ¨ <span class="token comment" spellcheck="true">// â‘  æƒé™æ£€æŸ¥</span>
            ComponentName component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            String targetProcess <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>

            âœ¨ <span class="token comment" spellcheck="true">// â‘¡ è·å–æ¥æ”¶å™¨æ‰€åœ¨çš„è¿›ç¨‹</span>
            ProcessRecord app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            âœ¨ <span class="token comment" spellcheck="true">// â‘¢ è¿›ç¨‹å·²ç»å¯åŠ¨</span>
            <span class="token comment" spellcheck="true">// Is this receiver's application already running?</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            âœ¨ <span class="token comment" spellcheck="true">// â‘£ è¿›ç¨‹è¿˜æœªå¯åŠ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token operator">=</span>mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_FROM_BACKGROUND<span class="token punctuation">,</span>
                    <span class="token string">"broadcast"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            âœ¨ <span class="token comment" spellcheck="true">// â‘¤ è¿›ç¨‹å¯åŠ¨å¤±è´¥</span>
            mPendingBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
            mPendingBroadcastRecvIndex <span class="token operator">=</span> recIdx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
</code></pre>
<p>æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹ï¼š</p>
<p><strong><font color="#7FF000" size="3">1ã€æƒé™æ£€æŸ¥</font></strong></p>
<p>â€œé™æ€â€æ¥æ”¶å™¨æ˜¯ ResolveInfo ï¼Œéœ€è¦é€šè¿‡ PackageManager è·å–åŒ…ä¿¡æ¯ï¼Œè¿›è¡Œæƒé™æ£€æŸ¥ã€‚</p>
<p><strong><font color="#7FF000" size="3">2ã€è·å–æ¥æ”¶å™¨æ‰€åœ¨çš„è¿›ç¨‹</font></strong></p>
<p>ç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„æƒé™æ£€æŸ¥åï¼Œç»ˆäºå¯ä»¥å‘ç›®æ ‡æ¥æ”¶å™¨æ´¾å‘äº†ã€‚é€šè¿‡ AMS.getProcessRecordLocked() è·å–å¹¿æ’­æ¥æ”¶å™¨çš„è¿›ç¨‹ä¿¡æ¯ã€‚</p>
<p><strong><font color="#7FF000" size="3">3ã€è¿›ç¨‹å·²ç»å¯åŠ¨</font></strong></p>
<p>å¦‚æœ app.thread ï¼= null ï¼Œåˆ™è¿›ç¨‹å·²ç»å¯åŠ¨ï¼Œå°±å¯ä»¥è°ƒç”¨ BroadcastQueue.processCurBroadcastLocked() è¿›è¡Œæ¥ä¸‹æ¥çš„æ´¾å‘å¤„ç†äº†ã€‚</p>
<p><strong><font color="#7FF000" size="3">4ã€è¿›ç¨‹è¿˜æœªå¯åŠ¨</font></strong></p>
<p>å¦‚æœè¿›ç¨‹è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™éœ€è¦é€šè¿‡ AMS.startProcessLocked() æ¥å¯åŠ¨è¿›ç¨‹ï¼Œå½“å‰æ¶ˆæ¯å¹¶æœªæ´¾å‘ï¼Œè°ƒç”¨ BroadcastQueue.scheduleBroadcastsLocked() è¿›å…¥ä¸‹ä¸€æ¬¡çš„è°ƒåº¦ã€‚</p>
<p><strong><font color="#7FF000" size="3">5ã€è¿›ç¨‹å¯åŠ¨å¤±è´¥</font></strong></p>
<p>å¦‚æœè¿›ç¨‹å¯åŠ¨å¤±è´¥äº†ï¼Œåˆ™å½“å‰æ¶ˆæ¯è®°å½•æˆ mPendingBroadcast ï¼Œå³é˜»å¡çš„å¹¿æ’­æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶å¤„ç†ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p><strong><font color="#FF7F24">åºå¤§çš„ processNextBroadcast()ç»ˆäºå®Œç»“äº†ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯å¯¹å¹¿æ’­æ¶ˆæ¯è¿›è¡Œè°ƒåº¦ï¼Œè¯¥æ–¹æ³•è¢«è®¾è®¡å¾—ååˆ†å¤æ‚è€Œç²¾å·§ï¼Œç”¨äºåº”å¯¹ä¸åŒçš„å¹¿æ’­æ¶ˆæ¯å’Œæ¥æ”¶å™¨çš„å¤„ç†ã€‚<font></font></font></strong></p>
<h3 id="å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’"><a href="#å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’" class="headerlink" title="å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’"></a>å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’</h3><p>è°ƒåº¦æ˜¯å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æè¢«è°ƒåº¦å¹¿æ’­æ¶ˆæ¯å¦‚ä½•åˆ°è¾¾åº”ç”¨ç¨‹åºã€‚ä¸Šæ–‡çš„åˆ†æä¸­ï¼Œæœ€ç»ˆæœ‰ä¸¤ä¸ªæ–¹æ³•å°†å¹¿æ’­æ¶ˆæ¯æ´¾å‘å‡ºå»ï¼š <font color="#FF00FF">BroadcastQueue.deliverToRegisteredReceiverLocked()</font> å’Œ <font color="#FF00FF">BroadcastQueue.processCurBroadcastLocked()</font>ã€‚</p>
<p>æŠ›å¼€è¿™ä¸¤ä¸ªå‡½æ•°çš„é€»è¾‘ï¼Œè¯•æƒ³è¦å°†å¹¿æ’­æ¶ˆæ¯ä» AMS æ‰€åœ¨çš„ system_server è¿›ç¨‹ä¼ é€’åˆ°åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ï¼Œè¯¥æ€ä¹ˆå®ç°ï¼Ÿ</p>
<p>è‡ªç„¶éœ€è¦ç”¨åˆ°è·¨è¿›ç¨‹è°ƒç”¨ï¼ŒAndroidä¸­æœ€å¸¸è§„çš„æ‰‹æ®µå°±æ˜¯ <strong><font color="#FF7F24">Binderæœºåˆ¶</font></strong>ï¼ˆå…³äºBinderæœºåˆ¶ï¼Œæˆ‘åœ¨åˆ«çš„åšæ–‡ä¸­è®²è¿‡ï¼‰ã€‚æ²¡é”™ï¼Œå¹¿æ’­æ¶ˆæ¯æ´¾å‘åˆ°åº”ç”¨è¿›ç¨‹å°±æ˜¯è¿™ä¹ˆç©çš„ã€‚</p>
<h4 id="åº”ç”¨ç¨‹åºå·²å¯åŠ¨"><a href="#åº”ç”¨ç¨‹åºå·²å¯åŠ¨" class="headerlink" title="åº”ç”¨ç¨‹åºå·²å¯åŠ¨"></a>åº”ç”¨ç¨‹åºå·²å¯åŠ¨</h4><p>æˆ‘ä»¬åœ¨ä¸Šé¢åˆ†æè¿‡ï¼Œå¯¹äºåº”ç”¨ç¨‹åºå·²ç»å¯åŠ¨(app.thread != null)çš„æƒ…å†µï¼Œä¼šé€šè¿‡ <font color="#FF00FF">IApplicationThread</font> å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨ï¼š</p>
<pre class=" language-java"><code class="language-java">            <span class="token comment" spellcheck="true">// Is this receiver's application already running?</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>æˆ‘ä»¬æŸ¥çœ‹ <font color="#FF00FF">processCurBroadcastLocked</font> æ–¹æ³•ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span>
            ProcessRecord app<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mService<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡ IApplicationThread å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨</span>
            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleReceiver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">,</span>
                    mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
            started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<pre><code>ActivityThread.ApplicationThread.scheduleReceiver()
â””â”€â”€ ActivityThread.handleReceiver()
    â””â”€â”€ BroadcastReceiver.onReceive()

</code></pre><h4 id="åº”ç”¨ç¨‹åºæœªå¯åŠ¨"><a href="#åº”ç”¨ç¨‹åºæœªå¯åŠ¨" class="headerlink" title="åº”ç”¨ç¨‹åºæœªå¯åŠ¨"></a>åº”ç”¨ç¨‹åºæœªå¯åŠ¨</h4><p>å¯¹äºåº”ç”¨ç¨‹åºè¿˜æœªå¯åŠ¨çš„æƒ…å†µï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">IIntentReceiver</font> å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨ï¼Œåº”ç”¨è¿›ç¨‹çš„å®ç°åœ¨LoadedApk.ReceiverDispatcher.IntentReceiverä¸­ï¼Œè°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<pre><code>LoadedApk.ReceiverDispatcher.IntentReceiver.performReceive()
â””â”€â”€ LoadedApk.ReceiverDispatcher.performReceiver()
    â””â”€â”€ LoadedApk.ReceiverDispatcher.Args.run()
        â””â”€â”€ BroadcastReceiver.onReceive()
</code></pre><p>å‘ç°æ²¡ï¼Ÿæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <font color="#FF00FF">BroadcastReceiver.onReceive()</font> ï¼Œåœ¨åº”ç”¨è¿›ç¨‹æ‰§è¡Œæ¥æ”¶å¹¿æ’­æ¶ˆæ¯çš„å…·ä½“åŠ¨ä½œã€‚</p>
<p>å¯¹äºâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€è€Œè¨€ï¼Œæ‰§è¡Œå®Œäº†ä»¥åï¼Œè¿˜éœ€è¦é€šçŸ¥ system_server è¿›ç¨‹ï¼Œæ‰èƒ½ç»§ç»­å°†å¹¿æ’­æ¶ˆæ¯æ´¾å‘åˆ°ä¸‹ä¸€ä¸ªæ¥æ”¶å™¨ï¼Œè¿™åˆéœ€è¦è·¨è¿›ç¨‹è°ƒç”¨äº†ã€‚ </p>
<p>åº”ç”¨è¿›ç¨‹åœ¨å¤„ç†å®Œå¹¿æ’­æ¶ˆæ¯åï¼Œå³åœ¨ BroadcastReceiver.onReceive() æ‰§è¡Œå®Œæ¯•åï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">BroadcastReceiver.PendingResult.finish()</font> ï¼Œ æ¥ä¸‹æ¥çš„è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<pre><code>BroadcastReceiver.PendingResult.finish()
â””â”€â”€ BroadcastReceiver.PendingResult.sendFinished()
    â””â”€â”€ IActivityManager.finishReceiver()
        â””â”€â”€ ActivityManagerService.finishReceiver()
            â””â”€â”€ BroadcastQueue.processNextBroadcat()
</code></pre><p>é€šè¿‡IActivityManagerå‘èµ·äº†ä¸€ä¸ªä»åº”ç”¨è¿›ç¨‹åˆ° system_server è¿›ç¨‹çš„è°ƒç”¨ï¼Œæœ€ç»ˆåœ¨AMSçº¿ç¨‹ä¸­ï¼Œåˆèµ°åˆ°äº† <font color="#FF00FF">BroadcastQueue.processNextBroadcat()</font>, å¼€å§‹ä¸‹ä¸€è½®çš„è°ƒåº¦ã€‚</p>
<h4 id="broadcastTimeoutLocked"><a href="#broadcastTimeoutLocked" class="headerlink" title="broadcastTimeoutLocked()"></a>broadcastTimeoutLocked()</h4><p>å‰æ–‡è¯´è¿‡ï¼Œä¸¤ç§ ANR æœºåˆ¶æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <font color="#FF00FF">BroadcastQueue.broadcastTimeoutLocked()</font> æ–¹æ³•ï¼Œ ç¬¬ä¸€ç§ ANR ç›‘æµ‹ç”Ÿæ•ˆæ—¶ï¼Œä¼šå°† fromMsg è®¾ç½®ä¸º false ï¼›ç¬¬äºŒç§ ANR ç›‘æµ‹ç”Ÿæ•ˆæ—¶ï¼Œä¼šå°† fromMsg å‚æ•°ä¸º true æ—¶ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨å“åº” <font color="#FF00FF">BROADCAST_TIMEOUT_MSG</font> æ¶ˆæ¯ã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        âœ¨ <span class="token comment" spellcheck="true">// â‘  è®¾ç½®mPendingBroadcastTimeoutMessage</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPendingBroadcastTimeoutMessage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">removeBroadcastMonitorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        âœ¨ <span class="token comment" spellcheck="true">// â‘¡ åˆ¤æ–­ç¬¬äºŒç§ANRæœºåˆ¶æ˜¯å¦è¶…æ—¶</span>
        BroadcastRecord r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutTime <span class="token operator">></span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        âœ¨ <span class="token comment" spellcheck="true">// â‘¢ å·²ç»è¶…æ—¶ï¼Œåˆ™ç»“æŸå¯¹å½“å‰æ¥æ”¶å™¨ï¼Œå¼€å§‹æ–°ä¸€è½®è°ƒåº¦</span>
        <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        âœ¨ <span class="token comment" spellcheck="true">// â‘£ æŠ›å‡ºç»˜åˆ¶ANRå¯¹è¯æ¡†çš„æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anrMessage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Post the ANR to the handler since we do not want to process ANRs while</span>
            <span class="token comment" spellcheck="true">// potentially holding our lock.</span>
            mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AppNotResponding</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> anrMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#7FF000" size="3">1ã€è®¾ç½®mPendingBroadcastTimeoutMessage</font></strong></p>
<p>mPendingBroadcastTimeoutMessage æ ‡è¯†æ˜¯å¦å­˜åœ¨æœªå¤„ç†çš„ BROADCAST_TIMEOUT_MSG æ¶ˆæ¯ï¼Œå°†å…¶è®¾ç½®æˆfalseï¼Œå…è®¸ç»§ç»­æŠ›å‡ºBROADCAST_TIMEOUT_MSGæ¶ˆæ¯ã€‚</p>
<p><strong><font color="#7FF000" size="3">2ã€åˆ¤æ–­ç¬¬äºŒç§ANRæœºåˆ¶æ˜¯å¦è¶…æ—¶</font></strong></p>
<p>æ¯æ¬¡å°†å¹¿æ’­æ´¾å‘åˆ°æ¥æ”¶å™¨ï¼Œéƒ½ä¼šå°† r.receiverTime æ›´æ–°ï¼Œå¦‚æœåˆ¤æ–­å½“å‰è¿˜æœªè¶…æ—¶ï¼Œåˆ™åˆæŠ›å‡ºä¸€ä¸ª BROADCAST_TIMEOUT_MSG æ¶ˆæ¯ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼Œæ‰ä¼šæ¸…é™¤ BROADCAST_TIMEOUT_MSG ï¼›å¦åˆ™ï¼Œæ¯è¿›è¡Œä¸€æ¬¡å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦ï¼Œéƒ½ä¼šæŠ›å‡º BROADCAST_TIMEOUT_MSG æ¶ˆæ¯ã€‚</p>
<p><strong><font color="#7FF000" size="3">3ã€å·²ç»è¶…æ—¶ï¼Œåˆ™ç»“æŸå¯¹å½“å‰æ¥æ”¶å™¨ï¼Œå¼€å§‹æ–°ä¸€è½®è°ƒåº¦</font></strong></p>
<p>åˆ¤æ–­å·²ç»è¶…æ—¶äº†ï¼Œè¯´æ˜å½“å‰çš„å¹¿æ’­æ¥æ”¶å™¨è¿˜æœªå¤„ç†å®Œæ¯•ï¼Œåˆ™ç»“æŸæ‰å½“å‰çš„æ¥æ”¶å™¨ï¼Œå¼€å§‹æ–°ä¸€è½®å¹¿æ’­è°ƒåº¦ã€‚</p>
<p><strong><font color="#7FF000" size="3">4ã€æŠ›å‡ºç»˜åˆ¶ANRå¯¹è¯æ¡†çš„æ¶ˆæ¯</font></strong></p>
<p>æœ€ç»ˆï¼Œå‘å‡ºç»˜åˆ¶ ANR å¯¹è¯æ¡†çš„æ¶ˆæ¯ã€‚</p>
<h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†å‰æ–‡æå‡ºçš„ä¸¤ä¸ªé—®é¢˜:</font></strong></p>
<p><strong><font color="#FF7F24">AMS ç»´æŠ¤ç€å¹¿æ’­é˜Ÿåˆ— BroadcastQueue ï¼ŒAMS çº¿ç¨‹ä¸æ–­ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œè°ƒåº¦ï¼Œå®Œæˆå¹¿æ’­æ¶ˆæ¯çš„æ´¾å‘ã€‚åœ¨æ´¾å‘â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€æ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ BROADCAST_TIMEOUT_MSG ï¼Œåœ¨å¹¿æ’­æ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼ŒAMS ä¼šå°†å®šæ—¶æ¶ˆæ¯æ¸…é™¤ã€‚å¦‚æœ BROADCAST_TIMEOUT_MSG å¾—åˆ°äº†å“åº”ï¼Œå°±ä¼šåˆ¤æ–­æ˜¯å¦å¹¿æ’­æ¶ˆæ¯å¤„ç†è¶…æ—¶ï¼Œæœ€ç»ˆé€šçŸ¥ANRçš„å‘ç”Ÿã€‚</font></strong></p>
<h2 id="Inputè¶…æ—¶å¤„ç†"><a href="#Inputè¶…æ—¶å¤„ç†" class="headerlink" title="Inputè¶…æ—¶å¤„ç†"></a>Inputè¶…æ—¶å¤„ç†</h2><p>åº”ç”¨ç¨‹åºå¯ä»¥æ¥æ”¶è¾“å…¥äº‹ä»¶(æŒ‰é”®ã€è§¦å±ã€è½¨è¿¹çƒç­‰)ï¼Œå½“ <strong><font color="#FF0000">5ç§’</font></strong> å†…æ²¡æœ‰å¤„ç†å®Œæ¯•æ—¶ï¼Œåˆ™ä¼šå¼•å‘ ANRã€‚</p>
<p><strong><font color="#7FF000" size="3">å’Œåˆ†æ Broadcast ANR ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆæŠ›å‡º Input ANR ä¸¤ä¸ªé—®é¢˜ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ è¾“å…¥äº‹ä»¶ç»å†äº†ä¸€äº›ä»€ä¹ˆå·¥åºæ‰èƒ½è¢«æ´¾å‘åˆ°åº”ç”¨çš„ç•Œé¢ï¼Ÿ</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ å¦‚ä½•æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶ï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p>
<h3 id="è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº"><a href="#è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº" class="headerlink" title="è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº"></a>è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº</h3><p>è¾“å…¥äº‹ä»¶æœ€å¼€å§‹ç”±ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚æŒ‰é”®æˆ–è§¦æ‘¸å±å¹•ï¼‰å‘èµ·ï¼ŒAndroid æœ‰ä¸€å¥—è¾“å…¥å­ç³»ç»Ÿæ¥å‘ç°å„ç§è¾“å…¥äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶æœ€ç»ˆéƒ½ä¼šè¢« <font color="#FF00FF">InputDispatcher</font> åˆ†å‘åˆ°å„ä¸ªéœ€è¦æ¥æ”¶äº‹ä»¶çš„çª—å£ã€‚é‚£ä¹ˆï¼Œçª—å£å¦‚ä½•å‘Šä¹‹ InputDispatcher è‡ªå·±éœ€è¦å¤„ç†è¾“å…¥äº‹ä»¶å‘¢ï¼ŸAndroid é€šè¿‡ <font color="#FF00FF">InputChannel</font> è¿æ¥ InputDispatcher å’Œçª—å£ï¼Œ<font color="#FF7F24">InputChannel å…¶å®æ˜¯å°è£…åçš„ Linuxç®¡é“(Pipe)ã€‚æ¯ä¸€ä¸ªçª—å£éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„ InputChannel ï¼Œçª—å£éœ€è¦å°†è¿™ä¸ª InputChannel æ³¨å†Œåˆ° InputDispatcher ä¸­</font>:</p>
<pre class=" language-cpp"><code class="language-cpp">status_t InputDispatcher<span class="token operator">::</span><span class="token function">registerInputChannel</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputChannel<span class="token operator">></span><span class="token operator">&amp;</span> inputChannel<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> inputWindowHandle<span class="token punctuation">,</span> <span class="token keyword">bool</span> monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    sp<span class="token operator">&lt;</span>Connection<span class="token operator">></span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Connection</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">,</span> inputWindowHandle<span class="token punctuation">,</span> monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> inputChannel<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConnectionsByFd<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ALOOPER_EVENT_INPUT<span class="token punctuation">,</span> handleReceiveCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯¹äº InputDispatcher è€Œè¨€ï¼Œæ¯æ³¨å†Œä¸€ä¸ª InputChannel éƒ½è¢«è§†ä¸ºä¸€ä¸ª Connection ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥åŒºåˆ«ã€‚InputDispatcher æ˜¯ä¸€ä¸ªæ¶ˆæ¯å¤„ç†å¾ªç¯ï¼Œå½“æœ‰æ–°çš„ Connection æ—¶ï¼Œå°±éœ€è¦å”¤é†’æ¶ˆæ¯å¾ªç¯é˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚</p>
<p>è¾“å…¥äº‹ä»¶çš„ç±»å‹æœ‰å¾ˆå¤šï¼ŒæŒ‰é”®ã€è½¨è¿¹çƒã€è§¦å±ç­‰ï¼ŒAndroid å¯¹è¿™äº›äº‹ä»¶è¿›è¡Œäº†åˆ†ç±»ï¼Œå¤„ç†è¿™äº›äº‹ä»¶çš„çª—å£ä¹Ÿè¢«èµ‹äºˆäº†ä¸€ä¸ªç±»å‹(targetType)ï¼šFoucused æˆ– Touchedã€‚</p>
<p>å¦‚æœå½“å‰è¾“å…¥äº‹ä»¶æ˜¯æŒ‰é”®ç±»å‹ï¼Œåˆ™å¯»æ‰¾ Focused ç±»å‹çš„çª—å£ã€‚å¦‚æœå½“å‰è¾“å…¥äº‹ä»¶ç±»å‹æ˜¯è§¦æ‘¸ç±»å‹ï¼Œåˆ™å¯»æ‰¾ Touched ç±»å‹çš„çª—å£ã€‚</p>
<p>InputDispatcher éœ€è¦ç»è¿‡ä»¥ä¸‹å¤æ‚çš„è°ƒç”¨å…³ç³»ï¼Œæ‰èƒ½æŠŠä¸€ä¸ªè¾“å…¥äº‹ä»¶æ´¾å‘å‡ºå»(è°ƒç”¨å…³ç³»ä»¥æŒ‰é”®äº‹ä»¶ä¸ºä¾‹ï¼Œè§¦å±äº‹ä»¶çš„è°ƒç”¨å…³ç³»ç±»ä¼¼)ï¼š</p>
<pre><code>InputDispatcherThread::threadLoop()
â””â”€â”€ InputDispatcher::dispatchOnce()
    â””â”€â”€ InputDispatcher::dispatchOnceInnerLocked()
        â””â”€â”€ InputDispatcher::dispatchKeyLocked()
            â””â”€â”€ InputDispatcher::dispatchEventLocked()
                â””â”€â”€ InputDispatcher::prepareDispatchCycleLocked()
                    â””â”€â”€ InputDispatcher::enqueueDispatchEntriesLocked()
                        â””â”€â”€ InputDispatcher::startDispatchCycleLocked()
                            â””â”€â”€ InputPublisher::publishKeyEvent()
</code></pre><p>å…·ä½“æ¯ä¸ªå‡½æ•°çš„å®ç°é€»è¾‘æ­¤å¤„ä¸è¡¨ã€‚æˆ‘ä»¬æç‚¼å‡ºå‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ InputDispatcherThread æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒå¤„ç†ä¸€æ¬¡æ¶ˆæ¯çš„æ´¾å‘ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ è¾“å…¥äº‹ä»¶ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ï¼Œéœ€è¦æ’é˜Ÿç­‰å¾…æ´¾å‘ï¼Œæ¯ä¸€ä¸ª Connection éƒ½ç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼š<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Â· outboundQueue: ç­‰å¾…å‘é€ç»™çª—å£çš„äº‹ä»¶ã€‚æ¯ä¸€ä¸ªæ–°æ¶ˆæ¯åˆ°æ¥ï¼Œéƒ½ä¼šå…ˆè¿›å…¥åˆ°æ­¤é˜Ÿåˆ—ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Â· waitQueue: å·²ç»å‘é€ç»™çª—å£çš„äº‹ä»¶ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ publishKeyEvent å®Œæˆåï¼Œè¡¨ç¤ºäº‹ä»¶å·²ç»æ´¾å‘äº†ï¼Œå°±å°†äº‹ä»¶ä» outboundQueue æŒªåˆ°äº† waitQueueã€‚</p>
<p>äº‹ä»¶ç»è¿‡è¿™ä¹ˆä¸€è½®å¤„ç†ï¼Œå°±ç®—æ˜¯ä» InputDispatcher æ´¾å‘å‡ºå»äº†ï¼Œä½†äº‹ä»¶æ˜¯ä¸æ˜¯è¢«çª—å£æ”¶åˆ°äº†ï¼Œè¿˜éœ€è¦ç­‰å¾…æ¥æ”¶æ–¹çš„ <font color="#FF00FF">â€œfinishedâ€</font> é€šçŸ¥ã€‚åœ¨å‘ InputDispatcher æ³¨å†Œ InputChannel çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•° handleReceiveCallback():</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> InputDispatcher<span class="token operator">::</span><span class="token function">handleReceiveCallback</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        status <span class="token operator">=</span> connection<span class="token operator">-</span><span class="token operator">></span>inputPublisher<span class="token punctuation">.</span><span class="token function">receiveFinishedSignal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>seq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        d<span class="token operator">-</span><span class="token operator">></span><span class="token function">finishDispatchCycleLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> handled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    d<span class="token operator">-</span><span class="token operator">></span><span class="token function">unregisterInputChannelLocked</span><span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>inputChannel<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å½“æ”¶åˆ°çš„ status ä¸º OK æ—¶ï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">finishDispatchCycleLocked()</font> æ¥å®Œæˆä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ï¼š</p>
<pre><code>InputDispatcher::finishDispatchCycleLocked()
â””â”€â”€ InputDispatcher::onDispatchCycleFinishedLocked()
    â””â”€â”€ InputDispatcher::doDispatchCycleFinishedLockedInterruptible()
        â””â”€â”€ InputDispatcher::startDispatchCycleLocked()
</code></pre><p>è°ƒç”¨åˆ° <font color="#FF00FF">doDispatchCycleFinishedLockedInterruptible()</font> æ–¹æ³•æ—¶ï¼Œä¼šå°†å·²ç»æˆåŠŸæ´¾å‘çš„æ¶ˆæ¯ä» <font color="#FF00FF">waitQueue</font> ä¸­ç§»é™¤ï¼Œ è¿›ä¸€æ­¥è°ƒç”¨ä¼š <font color="#FF00FF">startDispatchCycleLocked</font> å¼€å§‹æ´¾å‘æ–°çš„äº‹ä»¶ã€‚</p>
<p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</font></strong></p>
<p><strong><font color="#FF7F24">ä¸€ä¸ªæ­£å¸¸çš„è¾“å…¥äº‹ä»¶ä¼šç»è¿‡ä» outboundQueue æŒªåˆ° waitQueue çš„è¿‡ç¨‹ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»æ´¾å‘å‡ºå»ï¼›å†ç»è¿‡ä» waitQueue ä¸­ç§»é™¤çš„è¿‡ç¨‹ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»è¢«çª—å£æ¥æ”¶ã€‚InputDispatcher ä½œä¸ºä¸­æ¢ï¼Œä¸åœåœ°åœ¨é€’é€ç€è¾“å…¥äº‹ä»¶ï¼Œå½“ä¸€ä¸ªäº‹ä»¶æ— æ³•å¾—åˆ°å¤„ç†çš„æ—¶å€™ï¼ŒInputDispatcher ä¸èƒ½å°±æ­¤æ­»æ‰å•Šï¼Œå¦åˆ™ç³»ç»Ÿä¹Ÿå¤ªå®¹æ˜“å´©æºƒäº†ã€‚InputDispatcher çš„ç­–ç•¥æ˜¯æ”¾å¼ƒæ‰å¤„ç†ä¸è¿‡æ¥çš„äº‹ä»¶ï¼Œå¹¶å‘å‡ºé€šçŸ¥(è¿™ä¸ªé€šçŸ¥æœºåˆ¶å°±æ˜¯ANR)ï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€è½®æ¶ˆæ¯çš„å¤„ç†ã€‚</font></strong></p>
<p><strong><font color="#FF0000">ç†è§£è¾“å…¥äº‹ä»¶åˆ†å‘æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š</font></strong></p>
<pre><code>æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶å¯ä»¥æ¯”åšä¸€ä¸ªå¿«é€’ï¼ŒInputDispatcher å°±åƒä¸€ä¸ªå¿«é€’ä¸­è½¬ç«™ï¼Œçª—å£å°±åƒæ˜¯æ”¶ä»¶äººï¼ŒInputChannel å°±åƒæ˜¯å¿«é€’å‘˜ã€‚
æ‰€æœ‰å¿«é€’éƒ½ä¼šç»è¿‡ä¸­è½¬ç«™ä¸­å¤„ç†ï¼Œä¸­è½¬ç«™éœ€è¦çŸ¥é“æ¯ä¸€ä¸ªå¿«é€’çš„æ”¶ä»¶äººæ˜¯è°ï¼Œé€šè¿‡å¿«é€’å‘˜å°†å¿«é€’å‘é€åˆ°å…·ä½“çš„æ”¶ä»¶äººã€‚
è¿™å…¶ä¸­æœ‰å¾ˆå¤šåœºæ™¯å¯¼è‡´å¿«é€’ä¸èƒ½åŠæ—¶é€åˆ°ï¼šè­¬å¦‚è”ç³»ä¸åˆ°æ”¶ä»¶äºº;å¿«é€’å¾ˆå¤šï¼Œå¿«é€’å‘˜ä¼šå¿™ä¸è¿‡æ¥;å¿«é€’å‘˜å—ä¼¤ä¼‘å‡äº†ç­‰ç­‰â€¦
è¿™æ—¶å€™å¿«é€’å‘˜å°±éœ€è¦å‘ŠçŸ¥ä¸­è½¬ç«™ï¼šæœ‰å¿«é€’æ— æ³•åŠæ—¶é€åˆ°äº†ã€‚ä¸­è½¬ç«™åœ¨æ”¶åˆ°å¿«é€’å‘˜çš„é€šçŸ¥åï¼Œä¸€è¾¹ç»§ç»­æ´¾å‘å…¶ä»–å¿«é€’ï¼Œä¸€è¾¹æŠ¥å‘Šä¸Šçº§ã€‚
</code></pre><h3 id="æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶"><a href="#æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶" class="headerlink" title="æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶"></a>æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶</h3><p>åœ¨äº†è§£è¾“å…¥äº‹ä»¶åˆ†å‘æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è§è¯†ä¸€ä¸‹ANRæœºåˆ¶äº†ã€‚åœ¨æ´¾å‘äº‹ä»¶æ—¶ï¼Œ<font color="#FF00FF">dispatchKeyLocked()</font> å’Œ <font color="#FF00FF">dispatchMotionLocked()</font>ï¼Œéœ€è¦æ‰¾åˆ°å½“å‰çš„ç„¦ç‚¹çª—å£ï¼Œç„¦ç‚¹çª—å£æ‰æ˜¯æœ€ç»ˆæ¥æ”¶äº‹ä»¶çš„åœ°æ–¹ï¼Œæ‰¾çª—å£çš„è¿‡ç¨‹å°±ä¼šåˆ¤æ–­æ˜¯å¦å·²ç»å‘ç”Ÿäº†ANRï¼š</p>
<pre><code>InputDispatcher::findFocusedWindowTargetsLocked()
InputDispatcher::findTouchedWindowTargetsLocked()
â””â”€â”€ InputDispatcher::handleTargetsNotReadyLocked()
    â””â”€â”€ InputDispatcher::onANRLocked()
        â””â”€â”€ InputDispatcher::doNotifyANRLockedInterruptible()
            â””â”€â”€ NativeInputManager::notifyANR()
</code></pre><p>ï¼ˆ1ï¼‰é¦–å…ˆï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">findFocusedWindowTargetsLocked()</font> æˆ– <font color="#FF00FF">findTouchedWindowTargetsLocked()</font> å¯»æ‰¾æ¥æ”¶è¾“å…¥äº‹ä»¶çš„çª—å£ã€‚</p>
<p>åœ¨æ‰¾åˆ°çª—å£ä»¥åï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">checkWindowReadyForMoreInputLocked()</font> æ£€æŸ¥çª—å£æ˜¯å¦æœ‰èƒ½åŠ›å†æ¥æ”¶æ–°çš„è¾“å…¥äº‹ä»¶ï¼Œä¼šæœ‰ä¸€ç³»åˆ—çš„åœºæ™¯é˜»ç¢äº‹ä»¶çš„ç»§ç»­æ´¾å‘ï¼š</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯1: çª—å£å¤„äºpausedçŠ¶æ€ï¼Œä¸èƒ½å¤„ç†è¾“å…¥äº‹ä»¶</font></strong></p>
<p>â€œWaiting because the [targetType] window is paused.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯2: çª—å£è¿˜æœªå‘InputDispatcheræ³¨å†Œï¼Œæ— æ³•å°†äº‹ä»¶æ´¾å‘åˆ°çª—å£</font></strong></p>
<p>â€œWaiting because the [targetType] windowâ€™s input channel is not registered with the input dispatcher. The window may be in the process of being removed.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯3: çª—å£å’ŒInputDispatcherçš„è¿æ¥å·²ç»ä¸­æ–­ï¼Œå³InputChannelä¸èƒ½æ­£å¸¸å·¥ä½œ</font></strong></p>
<p>â€œWaiting because the [targetType] windowâ€™s input connection is [status]. The window may be in the process of being removed.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯4: InputChannelå·²ç»é¥±å’Œï¼Œä¸èƒ½å†å¤„ç†æ–°çš„äº‹ä»¶</font></strong></p>
<p>â€œWaiting because the [targetType] windowâ€™s input channel is full. Outbound queue length: %d. Wait queue length: %d.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯5: å¯¹äºæŒ‰é”®ç±»å‹(KeyEvent)çš„è¾“å…¥äº‹ä»¶ï¼Œéœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªäº‹ä»¶å¤„ç†å®Œæ¯•</font></strong></p>
<p>â€œWaiting to send key event because the [targetType] window has not finished processing all of the input events that were previously delivered to it. Outbound queue length: %d. Wait queue length: %d.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯6: å¯¹äºè§¦æ‘¸ç±»å‹(TouchEvent)çš„è¾“å…¥äº‹ä»¶ï¼Œå¯ä»¥ç«‹å³æ´¾å‘åˆ°å½“å‰çš„çª—å£ï¼Œå› ä¸ºTouchEventéƒ½æ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·å½“å‰å¯è§çš„çª—å£ã€‚ä½†æœ‰ä¸€ç§æƒ…å†µï¼Œ å¦‚æœå½“å‰åº”ç”¨ç”±äºé˜Ÿåˆ—æœ‰å¤ªå¤šçš„è¾“å…¥äº‹ä»¶ç­‰å¾…æ´¾å‘ï¼Œå¯¼è‡´å‘ç”Ÿäº†ANRï¼Œé‚£TouchEventäº‹ä»¶å°±éœ€è¦æ’é˜Ÿç­‰å¾…æ´¾å‘ã€‚</font></strong></p>
<p>â€œWaiting to send non-key event because the %s window has not finished processing certain input events that were delivered to it over %0.1fms ago. Wait queue length: %d. Wait queue head age: %0.1fms.â€</p>
<p>ï¼ˆ2ï¼‰ç„¶åï¼Œä¸Šè¿°æœ‰ä»»ä½•ä¸€ä¸ªåœºæ™¯å‘ç”Ÿäº†ï¼Œåˆ™è¾“å…¥äº‹ä»¶éœ€è¦ç»§ç»­ç­‰å¾…ï¼Œç´§æ¥ç€å°±ä¼šè°ƒç”¨ <font color="#FF00FF">handleTargetsNotReadyLocked()</font> æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»çš„ç­‰å¾…è¶…æ—¶äº†ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp">int32_t InputDispatcher<span class="token operator">::</span><span class="token function">handleTargetsNotReadyLocked</span><span class="token punctuation">(</span>nsecs_t currentTime<span class="token punctuation">,</span>
        <span class="token keyword">const</span> EventEntry<span class="token operator">*</span> entry<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputApplicationHandle<span class="token operator">></span><span class="token operator">&amp;</span> applicationHandle<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> windowHandle<span class="token punctuation">,</span>
        nsecs_t<span class="token operator">*</span> nextWakeupTime<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">>=</span> mInputTargetWaitTimeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onANRLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> applicationHandle<span class="token punctuation">,</span> windowHandle<span class="token punctuation">,</span>
            entry<span class="token operator">-</span><span class="token operator">></span>eventTime<span class="token punctuation">,</span> mInputTargetWaitStartTime<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>nextWakeupTime <span class="token operator">=</span> LONG_LONG_MIN<span class="token punctuation">;</span>
        <span class="token keyword">return</span> INPUT_EVENT_INJECTION_PENDING<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre>
<p>æœ€åï¼Œå¦‚æœå½“å‰äº‹ä»¶æ´¾å‘å·²ç»è¶…æ—¶ï¼Œåˆ™è¯´æ˜å·²ç»æ£€æµ‹åˆ°äº† ANR ï¼Œè°ƒç”¨ <font color="#FF00FF">onANRLocked()</font> æ–¹æ³•ï¼Œç„¶åå°† <font color="#FF00FF">nextWakeupTime</font> è®¾ç½®ä¸ºæœ€å°å€¼ï¼Œé©¬ä¸Šå¼€å§‹ä¸‹ä¸€è½®è°ƒåº¦ã€‚åœ¨ onANRLocked() æ–¹æ³•ä¸­ï¼Œ ä¼šä¿å­˜ ANR çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œè°ƒç”¨ <font color="#FF00FF">doNotifyANRLockedInterruptible()</font> ï¼Œè¿›ä¸€æ­¥ä¼šè°ƒç”¨åˆ° JNI å±‚çš„ <font color="#FF00FF">NativeInputManager::notifyANR()</font> æ–¹æ³•ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è¡”æ¥ Native å±‚å’Œ Java å±‚ï¼Œç›´æ¥è°ƒç”¨ Java å±‚çš„ <font color="#FF00FF">InputManagerService.notifyANR()</font> æ–¹æ³•ã€‚</p>
<p><strong><font color="#FF0000">è‡³æ­¤ï¼ŒANRçš„å¤„ç†é€»è¾‘è½¬äº¤åˆ°äº†Javaå±‚ã€‚</font></strong>åº•å±‚(Native)å‘ç°ä¸€æ—¦æœ‰è¾“å…¥äº‹ä»¶æ´¾å‘è¶…æ—¶ï¼Œå°±ä¼šé€šçŸ¥ä¸Šå±‚(Java)ï¼Œä¸Šå±‚æ”¶åˆ°ANRé€šçŸ¥åï¼Œå†³å®šæ˜¯å¦ç»ˆæ­¢å½“å‰è¾“å…¥äº‹ä»¶çš„æ´¾å‘ã€‚</p>
<p>å‘ç”ŸANRæ—¶ï¼ŒJavaå±‚æœ€å¼€å§‹çš„å…¥å£æ˜¯ <font color="#FF00FF">InputManagerService.notifyANR()</font> ï¼Œå®ƒæ˜¯ç›´æ¥è¢« Native å±‚è°ƒç”¨çš„ã€‚æˆ‘ä»¬å…ˆæŠŠ ANR çš„Javaå±‚è°ƒç”¨å…³ç³»åˆ—å‡ºæ¥ï¼š</p>
<pre><code>InputManagerService.notifyANR()
â””â”€â”€ InputMonitor.notifyANR()
    â”œâ”€â”€ IApplicationToken.keyDispatchingTimedOut()
    â”‚   â””â”€â”€ ActivityRecord.keyDispatchingTimedOut()
    â”‚       â””â”€â”€ AMS.inputDispatchingTimedOut()
    â”‚           â””â”€â”€ AMS.appNotResponding()
    â”‚
    â””â”€â”€ AMS.inputDispatchingTimedOut()
        â””â”€â”€ AMS.appNotResponding()
</code></pre><p><font color="#FF00FF">InputManagerService.notifyANR()</font> åªæ˜¯ä¸º Nativeå±‚ å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œå®ƒç›´æ¥è°ƒç”¨ <font color="#FF00FF">InputMonitor.notifyANR()</font>ã€‚å¦‚æœè¯¥æ–¹æ³•çš„è¿”å›å€¼ç­‰äº0ï¼Œåˆ™æ”¾å¼ƒæœ¬æ¬¡è¾“å…¥äº‹ä»¶ï¼›å¦‚æœå¤§äº0ï¼Œåˆ™è¡¨ç¤ºéœ€è¦ç»§ç»­ç­‰å¾…çš„æ—¶é—´ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">notifyANR</span><span class="token punctuation">(</span>InputApplicationHandle inputApplicationHandle<span class="token punctuation">,</span>
      InputWindowHandle inputWindowHandle<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appWindowToken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> appWindowToken<span class="token punctuation">.</span>appToken <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// appTokenå®é™…ä¸Šå°±æ˜¯å½“å‰çš„ActivityRecordã€‚</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå‘ç”ŸANRçš„Activityè¿˜å­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡ActivityRecordé€šçŸ¥äº‹ä»¶æ´¾å‘è¶…æ—¶</span>
        <span class="token keyword">boolean</span> abort <span class="token operator">=</span> appWindowToken<span class="token punctuation">.</span>appToken<span class="token punctuation">.</span><span class="token function">keyDispatchingTimedOut</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> abort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> appWindowToken<span class="token punctuation">.</span>inputDispatchingTimeoutNanos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå‘ç”ŸANRçš„Activityå·²ç»é”€æ¯äº†ï¼Œåˆ™é€šè¿‡AMSé€šçŸ¥äº‹ä»¶æ´¾å‘è¶…æ—¶</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>
                        windowState<span class="token punctuation">.</span>mSession<span class="token punctuation">.</span>mPid<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// abort dispatching</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šè¿°æ–¹æ³•ä¸­æœ‰ä¸¤ç§ä¸åŒçš„è°ƒç”¨æ–¹å¼ï¼Œä½†æœ€ç»ˆéƒ½ä¼šäº¤ç”± <font color="#FF00FF">AMS.inputDispatchingTimedOut()</font> å¤„ç†ã€‚AMS æœ‰é‡è½½çš„ <font color="#FF00FF">inputDispatchingTimedOut()</font> æ–¹æ³•ï¼Œä»–ä»¬çš„å‚æ•°ä¸ä¸€æ ·ã€‚ActivityRecord è°ƒç”¨æ—¶ï¼Œå¯ä»¥ä¼ å…¥çš„ä¿¡æ¯æ›´å¤šä¸€ç‚¹(å½“å‰å‘ç”ŸANRçš„ç•Œé¢æ˜¯å“ªä¸€ä¸ª)ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. æ ¹æ®è¿›ç¨‹å·è·å–åˆ°ProcessRecord</span>
    proc <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// 2. è·å–è¶…æ—¶æ—¶é—´</span>
    <span class="token comment" spellcheck="true">// æµ‹è¯•ç¯å¢ƒä¸‹çš„è¶…æ—¶æ—¶é—´æ˜¯INSTRUMENTATION_KEY_DISPATCHING_TIMEOUT(60ç§’)ï¼Œ</span>
    <span class="token comment" spellcheck="true">// æ­£å¸¸ç¯å¢ƒä¸‹çš„è¶…æ—¶æ—¶é—´æ˜¯KEY_DISPATCHING_TIMEOUT(5ç§’)</span>
    timeout <span class="token operator">=</span> <span class="token function">getInputDispatchingTimeoutLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è°ƒç”¨é‡è½½çš„å‡½æ•°ï¼Œå¦‚æœè¿”å›Trueï¼Œåˆ™è¡¨ç¤ºéœ€è¦ä¸­æ–­å½“å‰çš„äº‹ä»¶æ´¾å‘;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 3. è¿”å›ç»§ç»­ç­‰å¾…çš„æ—¶é—´ï¼Œè¿™ä¸ªå€¼ä¼šä¼ é€’åˆ°Nativeå±‚</span>
    <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">final</span> ProcessRecord proc<span class="token punctuation">,</span>
        <span class="token keyword">final</span> ActivityRecord activity<span class="token punctuation">,</span> <span class="token keyword">final</span> ActivityRecord parent<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// 1. å‘ç”ŸANRè¿›ç¨‹æ­£å¤„äºè°ƒè¯•çŠ¶æ€ï¼Œä¸éœ€è¦ä¸­æ–­äº‹ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>debugging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 2. å½“å‰æ­£åœ¨åšdexoptæ“ä½œï¼Œè¿™ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œä¸éœ€è¦ä¸­æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDidDexOpt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Give more time since we were dexopting.</span>
        mDidDexOpt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 3. å‘ç”ŸANRçš„è¿›ç¨‹æ˜¯æµ‹è¯•è¿›ç¨‹ï¼Œéœ€è¦ä¸­æ–­ï¼Œä½†ä¸åœ¨UIç•Œé¢æ˜¾ç¤ºANRä¿¡æ¯åˆ¤æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>instrumentationClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">finishInstrumentationLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 4. é€šçŸ¥UIç•Œé¢æ˜¾ç¤ºANRä¿¡æ¯</span>
    mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">appNotResponding</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†ç¬¬äºŒä¸ªé—®é¢˜ï¼š</font></strong></p>
<p><strong><font color="#FF7F24">åœ¨ InputDispatcher æ´¾å‘è¾“å…¥äº‹ä»¶æ—¶ï¼Œä¼šå¯»æ‰¾æ¥æ”¶äº‹ä»¶çš„çª—å£ï¼Œå¦‚æœæ— æ³•æ­£å¸¸æ´¾å‘ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´å½“å‰éœ€è¦æ´¾å‘çš„äº‹ä»¶è¶…æ—¶(é»˜è®¤æ˜¯5ç§’)ã€‚Nativeå±‚å‘ç°è¶…æ—¶äº†ï¼Œä¼šé€šçŸ¥Javaå±‚ï¼ŒJavaå±‚ç»è¿‡ä¸€äº›å¤„ç†åï¼Œä¼šåé¦ˆç»™Nativeå±‚ï¼Œæ˜¯ç»§ç»­ç­‰å¾…è¿˜æ˜¯ä¸¢å¼ƒå½“å‰æ´¾å‘çš„äº‹ä»¶ã€‚</font></strong></p>
<h2 id="å°ç»“-2"><a href="#å°ç»“-2" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p><strong>ANRç›‘æµ‹æœºåˆ¶åŒ…å«ä¸‰ç§ï¼š</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Service ANR</font></strong>ï¼Œå‰å°è¿›ç¨‹ä¸­Serviceç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡ <strong><font color="#FF0000">20ç§’</font></strong>ï¼Œåå°è¿›ç¨‹ä¸­Serviceçš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡<strong><font color="#FF0000"> 200ç§’</font></strong>ã€‚ åœ¨å¯åŠ¨Serviceæ—¶ï¼ŒæŠ›å‡ºå®šæ—¶æ¶ˆæ¯ <strong><font color="#FF34B3">SERVICE_TIMEOUT_MSG</font></strong> æˆ– <strong><font color="#FF34B3">SERVICE_BACKGOURND_TIMEOUT_MSG</font></strong>ï¼Œå¦‚æœå®šæ—¶æ¶ˆæ¯å“åº”äº†ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Broadcast ANR</font></strong>ï¼Œå‰å°çš„â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€å¿…é¡»åœ¨ <strong><font color="#FF0000">10ç§’</font></strong> å†…å¤„ç†å®Œæ¯•ï¼Œåå°çš„â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€å¿…é¡»åœ¨<strong><font color="#FF0000"> 60ç§’ </font></strong>å¤„ç†å®Œæ¯•ï¼Œ æ¯æ´¾å‘ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯åˆ°ä¸€ä¸ªæ¥æ”¶å™¨æ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ <strong><font color="#FF34B3">BROADCAST_TIMEOUT_MSG</font></strong>ï¼Œå¦‚æœå®šæ—¶æ¶ˆæ¯å“åº”ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å¹¿æ’­æ¶ˆæ¯å¤„ç†è¶…æ—¶ï¼Œè¶…æ—¶å°±è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Input ANR</font></strong>ï¼Œè¾“å…¥äº‹ä»¶å¿…é¡»åœ¨ <strong><font color="#FF0000">5ç§’</font></strong> å†…å¤„ç†å®Œæ¯•ã€‚åœ¨æ´¾å‘ä¸€ä¸ªè¾“å…¥äº‹ä»¶æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰è¾“å…¥äº‹ä»¶æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œå¦‚æœéœ€è¦ç­‰å¾…ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ç­‰å¾…å·²ç»è¶…æ—¶ï¼Œè¶…æ—¶å°±è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p>
<p>ANRç›‘æµ‹æœºåˆ¶å®é™…ä¸Šæ˜¯å¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„è¦æ±‚ï¼Œè¦æ±‚ä¸»çº¿æˆå¿…é¡»åœ¨é™å®šçš„æ—¶é—´å†…ï¼Œå®Œæˆå¯¹å‡ ç§æ“ä½œçš„å“åº”ï¼›å¦åˆ™ï¼Œå°±å¯ä»¥è®¤ä¸ºåº”ç”¨ç¨‹åºä¸»çº¿ç¨‹å¤±å»å“åº”èƒ½åŠ›ã€‚</p>
<p><strong>ä»ANRçš„ä¸‰ç§ç›‘æµ‹æœºåˆ¶ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸åŒè¶…æ—¶æœºåˆ¶çš„è®¾è®¡ï¼š</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ Service å’Œ Broadcast éƒ½æ˜¯ç”± AMS è°ƒåº¦ï¼Œåˆ©ç”¨ Handler å’Œ Looperï¼Œè®¾è®¡äº†ä¸€ä¸ª TIMEOUT æ¶ˆæ¯äº¤ç”± AMS çº¿ç¨‹æ¥å¤„ç†ï¼Œæ•´ä¸ªè¶…æ—¶æœºåˆ¶çš„å®ç°éƒ½æ˜¯åœ¨Javaå±‚ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ InputEvent ç”± InputDispatcher è°ƒåº¦ï¼Œå¾…å¤„ç†çš„è¾“å…¥äº‹ä»¶éƒ½ä¼šè¿›å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œè®¾è®¡äº†ä¸€ä¸ªç­‰å¾…è¶…æ—¶çš„åˆ¤æ–­ï¼Œè¶…æ—¶æœºåˆ¶çš„å®ç°åœ¨Nativeå±‚ã€‚</p>
<h1 id="ANRçš„æŠ¥å‘Šæœºåˆ¶"><a href="#ANRçš„æŠ¥å‘Šæœºåˆ¶" class="headerlink" title="ANRçš„æŠ¥å‘Šæœºåˆ¶"></a>ANRçš„æŠ¥å‘Šæœºåˆ¶</h1><h2 id="ANRæ—¥å¿—è¾“å‡ºåŸç†"><a href="#ANRæ—¥å¿—è¾“å‡ºåŸç†" class="headerlink" title="ANRæ—¥å¿—è¾“å‡ºåŸç†"></a>ANRæ—¥å¿—è¾“å‡ºåŸç†</h2><p>æ— è®ºå“ªç§ç±»å‹çš„ANRå‘ç”Ÿä»¥åï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <font color="#FF00FF">AMS.appNotResponding()</font> æ–¹æ³•ï¼Œæ‰€è°“â€œæ®Šé€”åŒå½’â€ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•çš„èŒèƒ½å°±æ˜¯å‘ç”¨æˆ·æˆ–å¼€å‘è€…æŠ¥å‘ŠANRå‘ç”Ÿäº†ã€‚æœ€ç»ˆçš„è¡¨ç°å½¢å¼æ˜¯ï¼šå¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œå‘Šè¯‰ç”¨æˆ·å½“å‰æŸä¸ªç¨‹åºæ— å“åº”ï¼›è¾“å…¥ä¸€å¤§å †ä¸ ANR ç›¸å…³çš„æ—¥å¿—ï¼Œä¾¿äºå¼€å‘è€…è§£å†³é—®é¢˜ã€‚</p>
<p>æœ€ç»ˆå½¢å¼æˆ‘ä»¬è§è¿‡å¾ˆå¤šï¼Œä½†è¾“å‡ºæ—¥å¿—çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œæœªå¿…æ‰€æœ‰äººéƒ½äº†è§£ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥è®¤è¯†ä¸€ä¸‹æ˜¯å¦‚ä½•è¾“å‡º ANR æ—¥å¿—çš„ã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*
     * app: å½“å‰å‘ç”ŸANRçš„è¿›ç¨‹
     * activity: å‘ç”ŸANRçš„ç•Œé¢
     * parent: å‘ç”ŸANRçš„ç•Œé¢çš„ä¸Šä¸€çº§ç•Œé¢
     * aboveSystem:
     * annotation: å‘ç”ŸANRçš„åŸå› 
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">appNotResponding</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> ActivityRecord activity<span class="token punctuation">,</span>
            ActivityRecord parent<span class="token punctuation">,</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> <span class="token keyword">final</span> String annotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> firstPids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SparseArray<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> lastPids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">long</span> anrTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>MONITOR_CPU_USAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         âœ¨ <span class="token comment" spellcheck="true">// â‘  æ›´æ–°CPUä½¿ç”¨ä¿¡æ¯ï¼ŒANRçš„ç¬¬ä¸€æ¬¡CPUä¿¡æ¯é‡‡æ ·</span>
            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

         âœ¨ <span class="token comment" spellcheck="true">// â‘¡ å¡«å……firstPidså’ŒlastPidsæ•°ç»„ã€‚ä»æœ€è¿‘è¿è¡Œè¿›ç¨‹(Last Recently Used)ä¸­æŒ‘é€‰</span>
            <span class="token comment" spellcheck="true">//    firstPidsï¼šç”¨äºä¿å­˜ANRè¿›ç¨‹åŠå…¶çˆ¶è¿›ç¨‹ï¼Œsystem_serverè¿›ç¨‹å’Œpersistentçš„è¿›ç¨‹</span>
            <span class="token comment" spellcheck="true">//    lastPidsï¼šç”¨äºä¿å­˜é™¤firstPidså¤–çš„å…¶ä»–è¿›ç¨‹</span>
            firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Don't dump other PIDs if it's a background ANR</span>
            isSilentANR <span class="token operator">=</span> <span class="token operator">!</span>showBackground <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isInterestingForBackgroundTraces</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSilentANR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> parentPid <span class="token operator">=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    parentPid <span class="token operator">=</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentPid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parentPid<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>MY_PID <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid <span class="token operator">&amp;&amp;</span> MY_PID <span class="token operator">!=</span> parentPid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>MY_PID<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ProcessRecord r <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> pid <span class="token operator">=</span> r<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> parentPid <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> MY_PID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>treatLikeActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                lastPids<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     âœ¨ <span class="token comment" spellcheck="true">// â‘¢ æ‰“å°è°ƒç”¨æ ˆ</span>
        File tracesFile <span class="token operator">=</span> ActivityManagerService<span class="token punctuation">.</span><span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span> firstPids<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> processCpuTracker<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> lastPids<span class="token punctuation">,</span>
                nativePids<span class="token punctuation">)</span><span class="token punctuation">;</span>

        String cpuInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>MONITOR_CPU_USAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         âœ¨ <span class="token comment" spellcheck="true">// â‘£ æ›´æ–°CPUä½¿ç”¨ä¿¡æ¯ï¼ŒANRçš„ç¬¬äºŒæ¬¡CPUä¿¡æ¯é‡‡æ ·</span>
            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

         âœ¨ <span class="token comment" spellcheck="true">// â‘¤ æ˜¾ç¤ºANRå¯¹è¯æ¡†</span>
            Message msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>what <span class="token operator">=</span> ActivityManagerService<span class="token punctuation">.</span>SHOW_NOT_RESPONDING_UI_MSG<span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> map<span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> aboveSystem <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">,</span> activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mService<span class="token punctuation">.</span>mUiHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#7FF000" size="3">è¯¥æ–¹æ³•çš„ä¸»ä½“é€»è¾‘å¯ä»¥åˆ†æˆäº”ä¸ªéƒ¨åˆ†æ¥çœ‹ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ 1ã€æ›´æ–°CPUçš„ç»Ÿè®¡ä¿¡æ¯ã€‚è¿™æ˜¯å‘ç”Ÿ ANR æ—¶ï¼Œç¬¬ä¸€æ¬¡CPUä½¿ç”¨ä¿¡æ¯çš„é‡‡æ ·ï¼Œé‡‡æ ·æ•°æ®ä¼šä¿å­˜åœ¨ <font color="#FF00FF">mProcessStats</font> è¿™ä¸ªå˜é‡ä¸­ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ 2ã€å¡«å…… <font color="#FF00FF">firstPids</font> å’Œ <font color="#FF00FF">lastPids</font> æ•°ç»„ã€‚å½“å‰å‘ç”Ÿ ANR çš„åº”ç”¨ä¼šé¦–å…ˆè¢«æ·»åŠ åˆ° firstPids ä¸­ï¼Œè¿™æ ·æ‰“å°å‡½æ•°æ ˆçš„æ—¶å€™ï¼Œå½“å‰è¿›ç¨‹æ€»æ˜¯åœ¨traceæ–‡ä»¶çš„æœ€å‰é¢ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ 3ã€æ‰“å°å‡½æ•°è°ƒç”¨æ ˆ <font color="#FF00FF">(StackTrace)</font>ã€‚å…·ä½“å®ç°ç”± <font color="#FF00FF">dumpStackTraces() </font>å‡½æ•°å®Œæˆã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ 4ã€æ›´æ–° CPU çš„ç»Ÿè®¡ä¿¡æ¯ã€‚è¿™æ˜¯å‘ç”ŸANRæ—¶ï¼Œç¬¬äºŒæ¬¡CPUä½¿ç”¨ä¿¡æ¯çš„é‡‡æ ·ï¼Œä¸¤æ¬¡é‡‡æ ·çš„æ•°æ®åˆ†åˆ«å¯¹åº” ANR å‘ç”Ÿå‰åçš„ CPU ä½¿ç”¨æƒ…å†µã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ 5ã€æ˜¾ç¤º ANR å¯¹è¯æ¡†ã€‚æŠ›å‡º <font color="#FF00FF">SHOW_NOT_RESPONDING_MSG</font> æ¶ˆæ¯ï¼ŒAMS.MainHandlerä¼šå¤„ç†è¿™æ¡æ¶ˆæ¯ï¼Œ<font color="#FF00FF">æ˜¾ç¤ºAppNotRespondingDialog</font>ã€‚</p>
<p><strong><font color="#7FF000" size="3">å½“ç„¶ï¼Œé™¤äº†ä¸»ä½“é€»è¾‘ï¼Œå‘ç”ŸANRæ—¶è¿˜ä¼šè¾“å‡ºå„ç§ç±»åˆ«çš„æ—¥å¿—ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF7F00">event log</font></strong>ï¼šé€šè¿‡æ£€ç´¢ <strong>â€œam_anrâ€</strong> å…³é”®å­—ï¼Œå¯ä»¥æ‰¾åˆ°å‘ç”ŸANRçš„åº”ç”¨ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF7F00">main log</font></strong>ï¼šé€šè¿‡æ£€ç´¢ <strong>â€œANR inâ€</strong> å…³é”®å­—ï¼Œå¯ä»¥æ‰¾åˆ°ANRçš„ä¿¡æ¯ï¼Œæ—¥å¿—çš„ä¸Šä¸‹æ–‡ä¼šåŒ…å«CPUçš„ä½¿ç”¨æƒ…å†µã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF7F00">dropbox</font></strong>ï¼šé€šè¿‡æ£€ç´¢ <strong>â€œanrâ€</strong> ç±»å‹ï¼Œå¯ä»¥æ‰¾åˆ°ANRçš„ä¿¡æ¯ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF7F00">traces</font></strong>ï¼šå‘ç”ŸANRæ—¶ï¼Œå„è¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ã€‚</p>
<p>æˆ‘ä»¬åˆ†æ ANR é—®é¢˜ï¼Œå¾€å¾€æ˜¯ä» main log ä¸­çš„ <font color="#FF00FF">â€œCPUä½¿ç”¨æƒ…å†µâ€</font> å’Œ <font color="#FF00FF">â€œtracesä¸­çš„å‡½æ•°è°ƒç”¨æ ˆâ€</font> å¼€å§‹ã€‚æ‰€ä»¥ï¼Œæ›´æ–°CPUçš„ä½¿ç”¨ä¿¡æ¯ <font color="#FF00FF">updateCpuStatsNow()</font> æ–¹æ³•å’Œæ‰“å°å‡½æ•°æ ˆ <font color="#FF00FF">dumpStackTraces()</font> æ–¹æ³•ï¼Œæ˜¯ç³»ç»ŸæŠ¥å‘Š ANR é—®é¢˜å…³é”®æ‰€åœ¨ã€‚</p>
<h2 id="CPUçš„ä½¿ç”¨æƒ…å†µ"><a href="#CPUçš„ä½¿ç”¨æƒ…å†µ" class="headerlink" title="CPUçš„ä½¿ç”¨æƒ…å†µ"></a>CPUçš„ä½¿ç”¨æƒ…å†µ</h2><p><font color="#FF00FF">AMS.updateCpuStatsNow() </font>æ–¹æ³•çš„å®ç°æˆ‘ä»¬ä¸ä½œè®²è§£ï¼Œåªéœ€è¦çŸ¥é“æ›´æ–°CPUä½¿ç”¨ä¿¡æ¯çš„é—´éš”æœ€å°æ˜¯5ç§’ï¼Œå³å¦‚æœ5ç§’å†…è¿ç»­è°ƒç”¨ updateCpuStatsNow() æ–¹æ³•ï¼Œå…¶å®æ˜¯æ²¡æœ‰æ›´æ–°CPUä½¿ç”¨ä¿¡æ¯çš„ã€‚</p>
<p>CPUä½¿ç”¨ä¿¡æ¯ç”± <font color="#FF00FF">ProcessCpuTracker</font> è¿™ä¸ªç±»ç»´æŠ¤ï¼Œæ¯æ¬¡è°ƒç”¨ <font color="#FF00FF">ProcessCpuTracker.update()</font> æ–¹æ³•ï¼Œå°±ä¼šè¯»å–è®¾å¤‡èŠ‚ç‚¹ <font color="#FF7F00">/proc</font> ä¸‹çš„æ–‡ä»¶ï¼Œæ¥æ›´æ–°CPUä½¿ç”¨ä¿¡æ¯ï¼Œå…·ä½“æœ‰ä»¥ä¸‹å‡ ä¸ªç»´åº¦ï¼š</p>
<p><strong><font color="#7FF000" size="3">ğŸ CPUçš„ä½¿ç”¨æ—¶é—´: </font></strong>&nbsp;<strong>è¯»å– /proc/stat</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong>userï¼š</strong> ç”¨æˆ·è¿›ç¨‹çš„CPUä½¿ç”¨æ—¶é—´ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong>niceï¼š</strong> é™ä½è¿‡ä¼˜å…ˆçº§è¿›ç¨‹çš„CPUä½¿ç”¨æ—¶é—´ã€‚Linuxè¿›ç¨‹éƒ½æœ‰ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªä¼˜å…ˆçº§å¯ä»¥è¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€‚ä¾‹å¦‚ï¼šè¿›ç¨‹åˆå§‹ä¼˜å…ˆçº§çš„å€¼è®¾ä¸º10ï¼Œè¿è¡Œæ—¶é™ä½ä¸º8ï¼Œé‚£ä¹ˆï¼Œä¿®æ­£å€¼-2å°±å®šä¹‰ä¸ºniceã€‚ Androidå°†userå’Œniceè¿™ä¸¤ä¸ªæ—¶é—´å½’ç±»æˆuserã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong>sysï¼š</strong> å†…æ ¸è¿›ç¨‹çš„CPUä½¿ç”¨æ—¶é—´ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong>idleï¼š</strong> CPUç©ºé—²çš„æ—¶é—´ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong>waitï¼š</strong> CPUç­‰å¾…IOçš„æ—¶é—´ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong>hw irqï¼š</strong> ç¡¬ä»¶ä¸­æ–­çš„æ—¶é—´ã€‚å¦‚æœå¤–è®¾ï¼ˆä¾‹å¦‚ï¼šç¡¬ç›˜ï¼‰å‡ºç°æ•…éšœï¼Œéœ€è¦é€šè¿‡ç¡¬ä»¶ç»ˆç«¯é€šçŸ¥CPUä¿å­˜ç°åœºï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´å°±æ˜¯CPUçš„ç¡¬ä»¶ä¸­æ–­æ—¶é—´ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong>sw irgï¼š</strong> è½¯ä»¶ä¸­æ–­çš„æ—¶é—´ã€‚åŒç¡¬ä»¶ä¸­æ–­ä¸€æ ·ï¼Œå¦‚æœè½¯ä»¶è¦æ±‚CPUä¸­æ–­ï¼Œåˆ™ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´å°±æ˜¯CPUçš„è½¯ä»¶ä¸­æ–­æ—¶é—´ã€‚</p>
<p><strong><font color="#7FF000" size="3">ğŸ CPUè´Ÿè½½: </font></strong>&nbsp;<strong>è¯»å– /proc/loadavg</strong></p>
<p>ç»Ÿè®¡æœ€è¿‘1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿå†…ï¼ŒCPUçš„å¹³å‡æ´»åŠ¨è¿›ç¨‹æ•°ã€‚CPUçš„è´Ÿè½½å¯ä»¥æ¯”å–»æˆè¶…å¸‚æ”¶é“¶å‘˜è´Ÿè½½ï¼Œå¦‚æœæœ‰1ä¸ªäººæ­£åœ¨ä¹°å•ï¼Œæœ‰2ä¸ªäººåœ¨æ’é˜Ÿï¼Œé‚£ä¹ˆè¯¥æ”¶é“¶å‘˜çš„è´Ÿè½½å°±æ˜¯3ã€‚åœ¨æ”¶é“¶å‘˜å·¥ä½œæ—¶ï¼Œä¸æ–­ä¼šæœ‰äººä¹°å•å®Œæˆï¼Œä¹Ÿä¸æ–­ä¼šæœ‰äººæ’é˜Ÿï¼Œå¯ä»¥åœ¨å›ºå®šçš„æ—¶é—´é—´éš”å†…(ä¾‹å¦‚ï¼šæ¯éš”5ç§’)ç»Ÿè®¡ä¸€æ¬¡è´Ÿè½½ï¼Œé‚£ä¹ˆï¼Œå°±å¯ä»¥ç»Ÿè®¡å‡ºä¸€æ®µæ—¶é—´å†…çš„å¹³å‡è´Ÿè½½ã€‚</p>
<p><strong><font color="#7FF000" size="3">ğŸ é¡µé”™è¯¯ä¿¡æ¯ï¼š</font></strong></p>
<p>è¿›ç¨‹çš„CPUä½¿ç”¨ç‡æœ€åè¾“å‡ºçš„ â€œfaults: xxx minor/majorâ€ éƒ¨åˆ†è¡¨ç¤ºçš„æ˜¯é¡µé”™è¯¯æ¬¡æ•°ï¼Œå½“æ¬¡æ•°ä¸º0æ—¶ä¸æ˜¾ç¤ºã€‚majoræ˜¯æŒ‡ Major Page Fault(ä¸»è¦é¡µé”™è¯¯ï¼Œç®€ç§°MPF)ï¼Œå†…æ ¸åœ¨è¯»å–æ•°æ®æ—¶ä¼šå…ˆåæŸ¥æ‰¾CPUçš„é«˜é€Ÿç¼“å­˜å’Œç‰©ç†å†…å­˜ï¼Œå¦‚æœæ‰¾ä¸åˆ°ä¼šå‘å‡ºä¸€ä¸ªMPFä¿¡æ¯ï¼Œè¯·æ±‚å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ã€‚minoræ˜¯æŒ‡ Minor Page Fault(æ¬¡è¦é¡µé”™è¯¯ï¼Œç®€ç§°MnPF)ï¼Œç£ç›˜æ•°æ®è¢«åŠ è½½åˆ°å†…å­˜åï¼Œå†…æ ¸å†æ¬¡è¯»å–æ—¶ï¼Œä¼šå‘å‡ºä¸€ä¸ªMnPFä¿¡æ¯ã€‚ä¸€ä¸ªæ–‡ä»¶ç¬¬ä¸€æ¬¡è¢«è¯»å†™æ—¶ä¼šæœ‰å¾ˆå¤šçš„MPFï¼Œè¢«ç¼“å­˜åˆ°å†…å­˜åå†æ¬¡è®¿é—®MPFå°±ä¼šå¾ˆå°‘ï¼ŒMnPFåè€Œå˜å¤šï¼Œè¿™æ˜¯å†…æ ¸ä¸ºå‡å°‘æ•ˆç‡ä½ä¸‹çš„ç£ç›˜I/Oæ“ä½œé‡‡ç”¨çš„ç¼“å­˜æŠ€æœ¯çš„ç»“æœã€‚</p>
<h2 id="å‡½æ•°è°ƒç”¨æ ˆ"><a href="#å‡½æ•°è°ƒç”¨æ ˆ" class="headerlink" title="å‡½æ•°è°ƒç”¨æ ˆ"></a>å‡½æ•°è°ƒç”¨æ ˆ</h2><p><font color="#FF00FF">AMS.dumpStackTraces()</font> æ–¹æ³•ç”¨äºæ‰“å°è¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œè¯¥æ–¹æ³•çš„ä¸»ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> File <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> clearTraces<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> firstPids<span class="token punctuation">,</span>
            ProcessCpuTracker processCpuTracker<span class="token punctuation">,</span> SparseArray<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> lastPids<span class="token punctuation">,</span>
            ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> nativePids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> extraPids <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>tracesFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> firstPids<span class="token punctuation">,</span> nativePids<span class="token punctuation">,</span> extraPids<span class="token punctuation">,</span>
                useTombstonedForJavaTraces<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ç»§ç»­è·Ÿè¸ª <font color="#FF00FF">dumpStackTraces()</font> æ–¹æ³•ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>String tracesFile<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> firstPids<span class="token punctuation">,</span>
            ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> nativePids<span class="token punctuation">,</span> ArrayList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> extraPids<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// We must complete all stack dumps within 20 seconds.</span>
        <span class="token keyword">long</span> remainingTime <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                observer<span class="token punctuation">.</span><span class="token function">startWatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// First collect all of the stacks of the most important pids.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstPids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¯¹ firstPids æ•°ç»„ä¸­çš„è¿›ç¨‹å‘é€ SIGNAL_QUITï¼Œè¿›ç¨‹åœ¨æ”¶åˆ° SIGNAL_QUIT åï¼Œä¼šæ‰“å°å‡½æ•°è°ƒç”¨æ ˆ</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> firstPids<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> <span class="token function">dumpJavaTracesTombstoned</span><span class="token punctuation">(</span>firstPids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> tracesFile<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> observer<span class="token punctuation">.</span><span class="token function">dumpWithTimeout</span><span class="token punctuation">(</span>firstPids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å‘é€ SIGNAL_QUIT</span>
                    <span class="token punctuation">}</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Next collect the stacks of the native pids</span>
            <span class="token comment" spellcheck="true">// æ‰“å°Nativeè¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nativePids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pid <span class="token operator">:</span> nativePids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> nativeDumpTimeoutMs <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>NATIVE_DUMP_TIMEOUT_MS<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">final</span> <span class="token keyword">long</span> start <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>

                    remainingTime <span class="token operator">-=</span> timeTaken<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Aborting stack trace dump (current native pid="</span> <span class="token operator">+</span> pid <span class="token operator">+</span>
                            <span class="token string">"); deadline exceeded."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Lastly, dump stacks for all extra PIDs from the CPU tracker.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extraPids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¯¹ extraPids æ•°ç»„ä¸­çš„è¿›ç¨‹å‘é€ SIGNAL_QUITï¼Œåªæœ‰å¤„äºå·¥ä½œçŠ¶æ€çš„ extraPids è¿›ç¨‹ï¼Œæ‰ä¼šæ”¶åˆ° SIGNAL_QUITï¼Œæ‰“å°å‡½æ•°è°ƒç”¨æ ˆ</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pid <span class="token operator">:</span> extraPids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> <span class="token function">dumpJavaTracesTombstoned</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> tracesFile<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        timeTaken <span class="token operator">=</span> observer<span class="token punctuation">.</span><span class="token function">dumpWithTimeout</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                observer<span class="token punctuation">.</span><span class="token function">stopWatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#7FF000" size="3">è¯¥æ–¹æ³•æœ‰å‡ ä¸ªé‡è¦çš„é€»è¾‘(Nativeè¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆæ­¤å¤„æˆ‘ä»¬ä¸åˆ†æ)ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ å‘è¿›ç¨‹å‘é€ SIGNAL_QUIT ä¿¡å·ï¼Œè¿›ç¨‹åœ¨æ”¶åˆ°è¿™ä¸ªä¿¡å·åï¼Œå°±ä¼šæ‰“å°å‡½æ•°è°ƒç”¨æ ˆï¼Œé»˜è®¤è¾“å‡ºåˆ° <font color="#FF00FF">/data/anr/traces.txt</font> æ–‡ä»¶ä¸­ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é…ç½® <font color="#FF00FF">dalvik.vm.stack-trace-file</font> è¿™ä¸ªç³»ç»Ÿå±æ€§æ¥æŒ‡å®šè¾“å‡ºå‡½æ•°è°ƒç”¨æ ˆçš„ä½ç½®ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ tracesæ–‡ä»¶ä¸­åŒ…å«å¾ˆå¤šè¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œè¿™æ˜¯ç”± firstPids å’Œ lastPids æ•°ç»„æ§åˆ¶çš„ï¼Œåœ¨æœ€ç»ˆçš„tracesæ–‡ä»¶ä¸­ï¼Œ<font color="#FF00FF">firstPidsä¸­çš„è¿›ç¨‹æ˜¯å…ˆæ‰“å°çš„</font>ï¼Œè€Œä¸”<font color="#FF00FF">å½“å‰å‘ç”Ÿ ANR çš„è¿›ç¨‹åˆæ˜¯æ’åœ¨ firstPids çš„ç¬¬ä¸€ä¸ª</font>ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬æ‰“å¼€tracesæ–‡ä»¶ï¼Œ<font color="#FF00FF">ç¬¬ä¸€ä¸ªçœ‹åˆ°çš„å°±æ˜¯å½“å‰å‘ç”ŸANRçš„åº”ç”¨è¿›ç¨‹</font>ã€‚</p>
<h1 id="ANRçš„é—®é¢˜åˆ†æ"><a href="#ANRçš„é—®é¢˜åˆ†æ" class="headerlink" title="ANRçš„é—®é¢˜åˆ†æ"></a>ANRçš„é—®é¢˜åˆ†æ</h1><p>åˆ†æANRé—®é¢˜ï¼Œæœ‰ä¸‰å¤§åˆ©å™¨ï¼š<font color="#7FF000">Logcat</font>ï¼Œ<font color="#7FF000">traces</font> å’Œ <font color="#7FF000">StrictMode</font>ï¼ˆä¸ä½œè®¨è®ºï¼‰ã€‚åˆ†æ ANR é—®é¢˜éœ€è¦ç»è¿‡<font color="#FF00FF">æ—¥å¿—è·å–</font>ã€<font color="#FF00FF">é—®é¢˜å®šä½</font> å’Œ <font color="#FF00FF">åœºæ™¯è¿˜åŸ</font> ä¸‰ä¸ªæ­¥éª¤ã€‚</p>
<h2 id="æ—¥å¿—è·å–"><a href="#æ—¥å¿—è·å–" class="headerlink" title="æ—¥å¿—è·å–"></a>æ—¥å¿—è·å–</h2><p>å¦‚ä½•è·å–æ—¥å¿—ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å»è¯¦ç»†åˆ†æï¼Œåé¢æ‰“ç®—é€šè¿‡Watchdogæœºåˆ¶åŠ ä»¥è¯¦è§£ã€‚</p>
<h2 id="é—®é¢˜å®šä½"><a href="#é—®é¢˜å®šä½" class="headerlink" title="é—®é¢˜å®šä½"></a>é—®é¢˜å®šä½</h2><p>æˆ‘ä»¬ç°åœ¨ä»¥ä¸€ä»½ANRæ—¥å¿—ä¸ºä¾‹ï¼Œåˆ†æå¦‚ä½•å®šä½ANRã€‚</p>
<p>é€šè¿‡åœ¨ event log ä¸­æ£€ç´¢ â€œam_anrâ€ å…³é”®å­—ï¼Œå°±å¯ä»¥æ‰¾åˆ°å‘ç”ŸANRçš„è¿›ç¨‹ï¼š</p>
<pre class=" language-log"><code class="language-log">08-26 00:48:27 820 907 I am_anr: [0,29533,com.android.systemui,1082670605,Broadcast of Intent { act=android.intent.action.TIME_TICK flg=0x50000114 (has extras) }]
</code></pre>
<p>æ¥ä¸‹æ¥å¯ä»¥åœ¨ system log æ£€ç´¢ ANR in å…³é”®å­—ï¼Œæ‰¾åˆ°å‘ç”Ÿ ANR å‰åçš„CPUä½¿ç”¨æƒ…å†µï¼š</p>
<pre class=" language-log"><code class="language-log">08-26 00:50:10 820 907 E ActivityManager: ANR in com.android.systemui, time=130090695
08-26 00:50:10 820 907 E ActivityManager: Reason: Broadcast of Intent { act=android.intent.action.TIME_TICK flg=0x50000114 (has extras) }
08-26 00:50:10 820 907 E ActivityManager: Load: 30.4 / 22.34 / 19.94
08-26 00:50:10 820 907 E ActivityManager: Android time :[2015-08-26 00:50:05.76] [130191,266]
08-26 00:50:10 820 907 E ActivityManager: CPU usage from 6753ms to -4ms ago:
08-26 00:50:10 820 907 E ActivityManager:   47% 320/netd: 3.1% user + 44% kernel / faults: 14886 minor 3 major
08-26 00:50:10 820 907 E ActivityManager:   15% 10007/com.sohu.sohuvideo: 2.8% user + 12% kernel / faults: 1144 minor
08-26 00:50:10 820 907 E ActivityManager:   13% 10654/hif_thread: 0% user + 13% kernel
08-26 00:50:10 820 907 E ActivityManager:   11% 175/mmcqd/0: 0% user + 11% kernel
08-26 00:50:10 820 907 E ActivityManager:   5.1% 12165/app_process: 1.6% user + 3.5% kernel / faults: 9703 minor 540 major
08-26 00:50:10 820 907 E ActivityManager:   3.3% 29533/com.android.systemui: 2.6% user + 0.7% kernel / faults: 8402 minor 343 major
08-26 00:50:10 820 907 E ActivityManager:   3.2% 820/system_server: 0.8% user + 2.3% kernel / faults: 5120 minor 523 major
08-26 00:50:10 820 907 E ActivityManager:   2.5% 11817/com.netease.pomelo.push.l.messageservice_V2: 0.7% user + 1.7% kernel / faults: 7728 minor 687 major
08-26 00:50:10 820 907 E ActivityManager:   1.6% 11887/com.android.email: 0.5% user + 1% kernel / faults: 6259 minor 587 major
08-26 00:50:10 820 907 E ActivityManager:   1.4% 11854/com.android.settings: 0.7% user + 0.7% kernel / faults: 5404 minor 471 major
08-26 00:50:10 820 907 E ActivityManager:   1.4% 11869/android.process.acore: 0.7% user + 0.7% kernel / faults: 6131 minor 561 major
08-26 00:50:10 820 907 E ActivityManager:   1.3% 11860/com.tencent.mobileqq: 0.1% user + 1.1% kernel / faults: 5542 minor 470 major
...
08-26 00:50:10 820 907 E ActivityManager:  +0% 12832/cat: 0% user + 0% kernel
08-26 00:50:10 820 907 E ActivityManager:  +0% 13211/zygote64: 0% user + 0% kernel
08-26 00:50:10 820 907 E ActivityManager: 87% TOTAL: 3% user + 18% kernel + 64% iowait + 0.5% softirq
</code></pre>
<p>ä»¥ä¸Šæ—¥å¿—çš„ä¿¡æ¯é‡å°±å¾ˆå¤§äº†ï¼Œæˆ‘ä»¬åˆ†æä¸‹ï¼š</p>
<p><strong><font color="#7FF000" size="3">å‘ç”Ÿ ANR çš„æ—¶é—´: </font></strong>event logä¸­ï¼ŒANRçš„æ—¶é—´æ˜¯ 00ï¼š48ï¼š27ï¼Œå› ä¸º AMS.appNotResponding()é¦–å…ˆä¼šæ‰“å° event logï¼Œç„¶åå†æ‰“å° system logï¼Œæ‰€ä»¥ï¼Œåœ¨ system log ä¸­ï¼Œæ‰¾åˆ° ANR çš„æ—¶é—´æ˜¯ 00:50:10ã€‚å¯ä»¥ä»è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„æ—¥å¿—ä¸­ï¼Œè¿˜åŸ ANR å‡ºç°æ—¶ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€‚</p>
<p><strong><font color="#7FF000" size="3">æ‰“å°ANRæ—¥å¿—çš„è¿›ç¨‹ï¼š</font></strong>ANR æ—¥å¿—éƒ½æ˜¯åœ¨ system_server è¿›ç¨‹ä¸­çš„ AMS æ‰“å°çš„ï¼Œåœ¨ event log å’Œ system log ä¸­ï¼Œéƒ½èƒ½çœ‹åˆ° 820å’Œ 907ï¼Œæ‰€ä»¥ system_server çš„ PID æ˜¯ 802ï¼ŒAMS çº¿ç¨‹çš„ TID æ˜¯ 907ã€‚ANRçš„ç›‘æµ‹æœºåˆ¶å®ç°åœ¨ AMS çº¿ç¨‹ï¼Œåˆ†æä¸€äº›å—ç³»ç»Ÿå½±å“çš„ ANRï¼Œéœ€è¦çŸ¥é“ system_server è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚</p>
<p><strong><font color="#7FF000" size="3">å‘ç”ŸANRçš„è¿›ç¨‹ï¼š</font></strong>ANR in å…³é”®å­—å°±è¡¨æ˜äº†å½“å‰ ANR çš„è¿›ç¨‹æ˜¯ com.android.system.uiï¼Œé€šè¿‡event logï¼ŒçŸ¥é“è¿›ç¨‹çš„PIDæ˜¯ 29533ã€‚</p>
<p><strong><font color="#7FF000" size="3">å‘ç”ŸANRçš„åŸå› ï¼š</font></strong>Reason å…³é”®å­—è¡¨æ˜äº†å½“å‰å‘ç”Ÿ ANR çš„åŸå› ï¼šå¤„ç† TIME_TICK å¹¿æ’­æ¶ˆæ¯è¶…æ—¶ã€‚éšå«çš„æ„æ€æ˜¯ TIME_TICK æ˜¯ä¸€ä¸ªä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ï¼Œåœ¨ 29533 çš„ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œ BroadcastReceiver.onReceive() æ–¹æ³•å·²ç»è¶…è¿‡10ç§’ã€‚</p>
<p><strong><font color="#7FF000" size="3">CPUè´Ÿè½½ï¼š</font></strong>Loadå…³é”®å­—è¡¨æ˜äº†æœ€è¿‘1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿå†…çš„ CPUè´Ÿè½½ åˆ†åˆ«æ˜¯30.4ã€22.3ã€19.94ã€‚CPUæœ€è¿‘1åˆ†é’Ÿçš„è´Ÿè½½æœ€å…·å‚è€ƒä»·å€¼ï¼Œå› ä¸º ANR çš„è¶…æ—¶é™åˆ¶åŸºæœ¬éƒ½æ˜¯1åˆ†é’Ÿä»¥å†…ï¼Œè¿™å¯ä»¥è¿‘ä¼¼çš„ç†è§£ä¸º CPU æœ€è¿‘1åˆ†é’Ÿå¹³å‡æœ‰ 30.4 ä¸ªä»»åŠ¡è¦å¤„ç†ï¼Œè¿™ä¸ªè´Ÿè½½å€¼æ˜¯æ¯”è¾ƒé«˜çš„ã€‚</p>
<p><strong><font color="#7FF000" size="3">CPUä½¿ç”¨ç»Ÿè®¡æ—¶é—´æ®µï¼š</font></strong>CPU usage from XX to XX agoå…³é”®å­—è¡¨æ˜äº†è¿™æ˜¯åœ¨ ANR å‘ç”Ÿä¹‹å‰ä¸€æ®µæ—¶é—´å†…çš„CPUç»Ÿè®¡ã€‚ç±»ä¼¼çš„è¿˜æœ‰CPU usage from XX to XX afterå…³é”®å­—ï¼Œè¡¨æ˜æ˜¯ ANR å‘ç”Ÿä¹‹åä¸€æ®µæ—¶é—´å†…çš„ CPU ç»Ÿè®¡ã€‚</p>
<p><strong><font color="#7FF000" size="3">å„è¿›ç¨‹çš„CPUä½¿ç”¨ç‡ï¼š</font></strong>æˆ‘ä»¬ä»¥ com.android.systemui è¿›ç¨‹çš„CPUä½¿ç”¨ç‡ä¸ºä¾‹ï¼Œå®ƒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ æ€»çš„CPUä½¿ç”¨ç‡: 3.3%ï¼Œå…¶ä¸­ systemui è¿›ç¨‹åœ¨ç”¨æˆ·æ€çš„ CPU ä½¿ç”¨ç‡æ˜¯2.6%ï¼Œåœ¨å†…æ ¸æ€çš„ä½¿ç”¨ç‡æ˜¯0.7%</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ç¼ºé¡µæ¬¡æ•°faultï¼š8402 minorè¡¨ç¤ºé«˜é€Ÿç¼“å­˜ä¸­çš„ç¼ºé¡µæ¬¡æ•°ï¼Œ343 majorè¡¨ç¤ºå†…å­˜çš„ç¼ºé¡µæ¬¡æ•°ã€‚minorå¯ä»¥ç†è§£ä¸ºè¿›ç¨‹åœ¨åšå†…å­˜è®¿é—®ï¼Œmajorå¯ä»¥ç†è§£ä¸ºè¿›ç¨‹åœ¨åšIOæ“ä½œã€‚å½“å‰minorå’Œmajorå€¼éƒ½æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œä»ä¾§é¢åæ˜ äº†å‘ç”Ÿ ANR ä¹‹å‰ï¼Œsystemuiè¿›ç¨‹æœ‰æœ‰è¾ƒå¤šçš„å†…å­˜è®¿é—®æ“ä½œï¼Œå¼•å‘çš„IOæ¬¡æ•°ä¹Ÿä¼šè¾ƒå¤š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ CPUä½¿ç”¨ç‡å‰é¢çš„ â€œ+â€ã€‚éƒ¨åˆ†è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡å‰é¢æœ‰ â€œ+â€ å·ï¼Œä¾‹å¦‚ï¼šcatå’Œzygote64ï¼Œè¡¨ç¤ºåœ¨ä¸Šä¸€æ¬¡CPUç»Ÿè®¡çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œè¿˜æ²¡æœ‰è¿™äº›è¿›ç¨‹ï¼Œè€Œè¿™ä¸€æ¬¡CPUç»Ÿè®¡çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œè¿è¡Œäº†è¿™äº›è¿›ç¨‹ã€‚ç±»ä¼¼çš„è¿˜æœ‰ â€œ-â€ å·ï¼Œè¡¨ç¤ºä¸¤æ¬¡CPUç»Ÿè®¡æ—¶é—´ç‰‡æ®µæ—¶ï¼Œè¿™äº›è¿›ç¨‹æ¶ˆäº¡äº†</p>
<p><strong><font color="#7FF000" size="3">CPUä½¿ç”¨æ±‡æ€»ï¼š</font></strong>TOTALå…³é”®å­—è¡¨æ˜äº†CPUä½¿ç”¨çš„æ±‡æ€»ï¼Œ87%æ˜¯æ€»çš„CPUä½¿ç”¨ç‡ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹ iowait è¡¨æ˜ CPU åœ¨ç­‰å¾… IO çš„æ—¶é—´ï¼Œå åˆ°64%ï¼Œè¯´æ˜å‘ç”ŸANRä»¥å‰ï¼Œæœ‰å¤§é‡çš„IOæ“ä½œã€‚app_processã€ system_server, com.android.systemuiè¿™å‡ ä¸ªè¿›ç¨‹çš„majorå€¼éƒ½æ¯”è¾ƒå¤§ï¼Œè¯´æ˜è¿™äº›è¿›ç¨‹çš„IOæ“ä½œè¾ƒä¸ºé¢‘ç¹ï¼Œä»è€Œæ‹‰å‡äº†æ•´ä¸ªiowaitçš„æ—¶é—´ã€‚</p>
<p>ä»ä»¥ä¸Šæ—¥å¿—å¯ä»¥çœ‹å‡ºçš„ä¿¡æ¯ä¸ºï¼šåœ¨ 08-26 00:48:27 è¿™ä¸ªæ—¶åˆ»ï¼ŒPID ä¸º 29533 çš„è¿›ç¨‹å‘ç”Ÿäº†ANRï¼Œè¿›ç¨‹åæ˜¯ com.android.systemuiã€‚</p>
<p>ä¿¡æ¯é‡æ˜¯å¦‚æ­¤çš„åºå¤§ï¼Œä»¥è‡´äºæˆ‘ä»¬éƒ½è¦ä¸‹ç»“è®ºäº†ï¼šCPUå¤§é‡çš„æ—¶é—´éƒ½åœ¨ç­‰å¾…IOï¼Œå¯¼è‡´systemuiè¿›ç¨‹åˆ†é…ä¸åˆ°CPUæ—¶é—´ï¼Œä»è€Œä¸»çº¿ç¨‹å¤„ç†å¹¿æ’­æ¶ˆæ¯è¶…æ—¶ï¼Œå‘ç”Ÿäº†ANRã€‚</p>
<p><strong><font color="#FF0000">å¯¹äºä¸€ä¸ªä¸¥è°¨çš„å¼€å‘äººå‘˜è€Œè¨€ï¼Œè¿™ç§ç»“è®ºä¸‹å¾—æœ‰ç‚¹æ—©ï¼Œå› ä¸ºè¿˜æœ‰å¤ªå¤šçš„ç–‘é—®ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ systemuiè¿›ç¨‹ä¹Ÿåˆ†åˆ°äº†ä¸€äº›CPUæ—¶é—´(3.3%)ï¼Œéš¾é“BroadcastReceiver.onReceive()æ–¹æ³•å°±ä¸€ç›´æ— æ³•æ‰§è¡Œå—ï¼Ÿ</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ä¸ºä»€ä¹ˆiowaitçš„æ—¶é—´ä¼šè¿™ä¹ˆå¤šï¼Œè€Œä¸”å¤šä¸ªè¿›ç¨‹çš„majorå€¼éƒ½å¾ˆé«˜ï¼Ÿ</p>
<h2 id="åœºæ™¯è¿˜åŸ"><a href="#åœºæ™¯è¿˜åŸ" class="headerlink" title="åœºæ™¯è¿˜åŸ"></a>åœºæ™¯è¿˜åŸ</h2><p>é’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªç–‘é—®ç‚¹ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥åˆ†æï¼</p>
<h3 id="ç¬¬ä¸€ä¸ªç–‘ç‚¹"><a href="#ç¬¬ä¸€ä¸ªç–‘ç‚¹" class="headerlink" title="ç¬¬ä¸€ä¸ªç–‘ç‚¹"></a>ç¬¬ä¸€ä¸ªç–‘ç‚¹</h3><p>æˆ‘ä»¬å…ˆæ¥åšä¸€ä¸ªå‡è®¾ï¼šå¦‚æœ systemui è¿›ç¨‹æ­£åœ¨æ‰§è¡Œ BroadcatReceiver.onReceive() æ–¹æ³•ï¼Œé‚£ä¹ˆä» traces.txt æ–‡ä»¶ä¸­ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°ä¸»çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆæ­£åœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é¦–å…ˆä» traces æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°å‘ç”Ÿ ANR æ—¶(00:48:27)ï¼Œsysemtui è¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ã€‚</p>
<pre class=" language-log"><code class="language-log">----- pid 29533 at 2018-08-26 00:48:06 -----
Cmd line: com.android.systemui

DALVIK THREADS (53):
"main" prio=5 tid=1 Native
  | group="main" sCount=1 dsCount=0 obj=0x75bd5818 self=0x7f8549a000
  | sysTid=29533 nice=0 cgrp=bg_non_interactive sched=0/0 handle=0x7f894bbe58
  | state=S schedstat=( 288625433917 93454573244 903419 ) utm=20570 stm=8292 core=3 HZ=100
  | stack=0x7fdffda000-0x7fdffdc000 stackSize=8MB
  | held mutexes=
  native: #00 pc 00060b0c  /system/lib64/libc.so (__epoll_pwait+8)
  native: #01 pc 0001bb54  /system/lib64/libc.so (epoll_pwait+32)
  native: #02 pc 0001b3d8  /system/lib64/libutils.so (android::Looper::pollInner(int)+144)
  native: #03 pc 0001b75c  /system/lib64/libutils.so (android::Looper::pollOnce(int, int*, int*, void**)+76)
  native: #04 pc 000d7194  /system/lib64/libandroid_runtime.so (android::NativeMessageQueue::pollOnce(_JNIEnv*, int)+48)
  at android.os.MessageQueue.nativePollOnce(Native method)
  at android.os.MessageQueue.next(MessageQueue.java:148)
  at android.os.Looper.loop(Looper.java:151)
  at android.app.ActivityThread.main(ActivityThread.java:5718)
  at java.lang.reflect.Method.invoke!(Native method)
  at java.lang.reflect.Method.invoke(Method.java:372)
  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:975)
  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:770)

----- pid 29533 at 2018-08-26 00:48:29 -----
Cmd line: com.android.systemui

DALVIK THREADS (54):
"main" prio=5 tid=1 Blocked
  | group="main" sCount=1 dsCount=0 obj=0x75bd5818 self=0x7f8549a000
  | sysTid=29533 nice=0 cgrp=bg_non_interactive sched=0/0 handle=0x7f894bbe58
  | state=S schedstat=( 289080040422 93461978317 904874 ) utm=20599 stm=8309 core=0 HZ=100
  | stack=0x7fdffda000-0x7fdffdc000 stackSize=8MB
  | held mutexes=
  at com.mediatek.anrappmanager.MessageLogger.println(SourceFile:77)
  - waiting to lock <0x26b337a3> (a com.mediatek.anrappmanager.MessageLogger) held by thread 49
  at android.os.Looper.loop(Looper.java:195)
  at android.app.ActivityThread.main(ActivityThread.java:5718)
  at java.lang.reflect.Method.invoke!(Native method)
  at java.lang.reflect.Method.invoke(Method.java:372)
  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:975)
  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:770)
...
"Binder_5" prio=5 tid=49 Native
  | group="main" sCount=1 dsCount=0 obj=0x136760a0 self=0x7f7e453000
  | sysTid=6945 nice=0 cgrp=default sched=0/0 handle=0x7f6e3ce000
  | state=S schedstat=( 5505571091 4567508913 30743 ) utm=264 stm=286 core=4 HZ=100
  | stack=0x7f6b83f000-0x7f6b841000 stackSize=1008KB
  | held mutexes=
  native: #00 pc 00019d14  /system/lib64/libc.so (syscall+28)
  native: #01 pc 0005b5d8  /system/lib64/libaoc.so (???)
  native: #02 pc 002c6f18  /system/lib64/libaoc.so (???)
  native: #03 pc 00032c40  /system/lib64/libaoc.so (???)
  at libcore.io.Posix.getpid(Native method)
  at libcore.io.ForwardingOs.getpid(ForwardingOs.java:83)
  at android.system.Os.getpid(Os.java:176)
  at android.os.Process.myPid(Process.java:754)
  at com.mediatek.anrappmanager.MessageLogger.dump(SourceFile:219)
  - locked <0x26b337a3> (a com.mediatek.anrappmanager.MessageLogger)
  at com.mediatek.anrappmanager.ANRAppManager.dumpMessageHistory(SourceFile:65)
  at android.app.ActivityThread$ApplicationThread.dumpMessageHistory(ActivityThread.java:1302)
  at android.app.ApplicationThreadNative.onTransact(ApplicationThreadNative.java:682)
  at android.os.Binder.execTransact(Binder.java:451)
</0x26b337a3></0x26b337a3></code></pre>
<p>æœ€ç»ˆï¼Œæˆ‘ä»¬æ‰¾åˆ° systemui è¿›ç¨‹ ANR æ—¶åˆ»(00:48:27)é™„è¿‘çš„ä¸¤ä¸ªå‡½æ•°è°ƒç”¨æ ˆ:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ åœ¨ ANR å‘ç”Ÿä¹‹å‰(00:48:06)ï¼Œä¸»çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆå¤„äºæ­£å¸¸çŠ¶æ€ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¾ªç¯å¤„ç†æ¶ˆæ¯</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ åœ¨ ANR å‘ç”Ÿä¹‹å2ç§’(00:48:29)ï¼Œä¸»çº¿ç¨‹å¤„äº Blocked çŠ¶æ€ï¼Œåœ¨ç­‰å¾…ä¸€ä¸ªè¢«49å·çº¿ç¨‹æŒæœ‰çš„é”ã€‚è€Œ49å·çº¿ç¨‹æ˜¯ä¸€ä¸ªBinderçº¿ç¨‹ï¼Œanrappmanageræ­£åœ¨åšdumpæ“ä½œã€‚</p>
<p>è‡³æ­¤ï¼Œsystemui è¿›ç¨‹å‘ç”Ÿ ANR çš„ç›´æ¥åŸå› æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†ï¼Œsystemui è¿›ç¨‹æ­£åœ¨æ‰“å° tracesï¼Œå­˜åœ¨è¾ƒé•¿æ—¶é—´çš„ IO æ“ä½œï¼Œå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ï¼Œä»è€Œæ— æ³•å¤„ç† TIME_TICK å¹¿æ’­æ¶ˆæ¯ï¼Œæ‰€ä»¥å‘ç”Ÿäº† ANRã€‚</p>
<p>è¦é¿å…è¿™ç§åœºæ™¯ä¸‹çš„ ANRï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰“ç ´ä¸»çº¿ç¨‹ä¸­ Blocked çš„é€»è¾‘ã€‚å…¶å®æœ¬ä¾‹æ˜¯ç”±äº MTK åœ¨ AOSP çš„ android.os.Looper.loop() æ‰©å±•äº†æ‰“å°æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å­˜åœ¨è®¾è®¡ç¼ºé™·ï¼Œä¼šå¯¼è‡´é”ç­‰å¾…çš„æƒ…å†µã€‚</p>
<h3 id="ç¬¬äºŒä¸ªç–‘ç‚¹"><a href="#ç¬¬äºŒä¸ªç–‘ç‚¹" class="headerlink" title="ç¬¬äºŒä¸ªç–‘ç‚¹"></a>ç¬¬äºŒä¸ªç–‘ç‚¹</h3><p>æˆ‘ä»¬è¿›ä¸€æ­¥æŒ–æ˜åœ¨ systemui è¿˜æ²¡æœ‰å‘ç”Ÿ ANR æ—¶ï¼Œå°±åœ¨æ‰“å° traces çš„åŸå› ã€‚å¸¦ç€ä¸Šæ–‡æå‡ºçš„ç¬¬äºŒä¸ªç–‘é—®ï¼Œæˆ‘ä»¬æ¥åšå¦ä¸€ä¸ªå‡è®¾ï¼šiowaitè¾ƒé«˜ï¼Œè€Œä¸”å¤šä¸ªè¿›ç¨‹çš„majoréƒ½å¾ˆé«˜ï¼Œå¯èƒ½æ˜¯ç”±äºå½“å‰æ­£åœ¨è°ƒç”¨ AMS.dumpStackTraces() æ–¹æ³•ï¼Œå¾ˆå¤šè¿›ç¨‹éƒ½éœ€è¦å°†è‡ªå·±çš„å‡½æ•°è°ƒç”¨æ ˆå†™åˆ° tracesæ–‡ä»¶ï¼Œæ‰€ä»¥ IO å°±ä¼šè¾ƒé«˜ã€‚å¦‚æœå½“å‰æ­£åœ¨è°ƒç”¨ AMS.dumpStackTraces() æ–¹æ³•ï¼Œé‚£è¯´æ˜å½“æ—¶ç³»ç»Ÿå·²ç»å‘ç”Ÿäº†å¼‚å¸¸ï¼Œè¦ä¹ˆå·²ç»æœ‰ ANR å‘ç”Ÿï¼Œè¦ä¹ˆæœ‰ SNR å‘ç”Ÿã€‚</p>
<p>ä»event logä¸­ï¼Œæˆ‘ä»¬æ£€ç´¢åˆ°äº†å¦ä¸€ä¸ªANRï¼š</p>
<pre class=" language-log"><code class="language-log">08-26 00:47:58 820 907 I am_anr  : [0,10464,com.android.settings,1086864965,Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)]
</code></pre>
<p>åœ¨ 00:47:58 è¿™ä¸ªæ—¶åˆ»ï¼Œcom.android.settings è¿›ç¨‹å‘ç”Ÿäº† ANRï¼Œè€Œä¸” ANR çš„æ—¶é—´åœ¨ systemui ä¹‹å‰(00:48:27)ã€‚è¿™ä¸€ä¸‹ï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°ä½è¯äº†ï¼Œæ­£æ˜¯å› ä¸º settings è¿›ç¨‹å…ˆå‘ç”Ÿäº† ANRï¼Œè°ƒç”¨ AMS.dumpStackTraces()ï¼Œ ä»è€Œå¾ˆå¤šè¿›ç¨‹éƒ½å¼€å§‹äº†æ‰“å° traces çš„æ“ä½œï¼Œæ‰€ä»¥ç³»ç»Ÿçš„æ•´ä¸ª iowait æ¯”è¾ƒé«˜ï¼Œå¤§é‡è¿›ç¨‹çš„ major å€¼ä¹Ÿæ¯”è¾ƒé«˜ï¼Œsystemui å°±åœ¨å…¶åˆ—ã€‚åœ¨ MTK é€»è¾‘çš„å½±å“ä¸‹ï¼Œæ‰“å° ANR æ—¥å¿—ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ï¼Œä»è€Œå°±è¿å¸¦å¼•å‘äº†å…¶ä»–åº”ç”¨çš„ ANRã€‚</p>
<p>åœ¨system logä¸­ï¼Œæˆ‘ä»¬æ£€ç´¢åˆ°äº† settings è¿›ç¨‹ ANR çš„ CPU ä½¿ç”¨ä¿¡æ¯ï¼š</p>
<pre class=" language-log"><code class="language-log">08-26 00:48:12 820 907 E ActivityManager: ANR in com.android.settings (com.android.settings/.SubSettings), time=130063718
08-26 00:48:12 820 907 E ActivityManager: Reason: Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)
08-26 00:48:12 820 907 E ActivityManager: Load: 21.37 / 19.25 / 18.84
08-26 00:48:12 820 907 E ActivityManager: Android time :[2015-08-26 00:48:12.24] [130077,742]
08-26 00:48:12 820 907 E ActivityManager: CPU usage from 0ms to 7676ms later:
08-26 00:48:12 820 907 E ActivityManager:   91% 820/system_server: 16% user + 75% kernel / faults: 13192 minor 167 major
08-26 00:48:12 820 907 E ActivityManager:   3.2% 175/mmcqd/0: 0% user + 3.2% kernel
08-26 00:48:12 820 907 E ActivityManager:   2.9% 29533/com.android.systemui: 2.3% user + 0.6% kernel / faults: 1352 minor 10 major
08-26 00:48:12 820 907 E ActivityManager:   2.2% 1736/com.android.phone: 0.9% user + 1.3% kernel / faults: 1225 minor 1 major
08-26 00:48:12 820 907 E ActivityManager:   2.2% 10464/com.android.settings: 0.7% user + 1.4% kernel / faults: 2801 minor 105 major
08-26 00:48:12 820 907 E ActivityManager:   0% 1785/com.meizu.experiencedatasync: 0% user + 0% kernel / faults: 3478 minor 2 major
08-26 00:48:12 820 907 E ActivityManager:   1.8% 11333/com.meizu.media.video: 1% user + 0.7% kernel / faults: 3843 minor 89 major
08-26 00:48:12 820 907 E ActivityManager:   1.5% 332/mobile_log_d: 0.5% user + 1% kernel / faults: 94 minor 1 major
08-26 00:48:12 820 907 E ActivityManager:   1% 11306/com.meizu.media.gallery: 0.7% user + 0.2% kernel / faults: 2204 minor 55 major
...
08-26 00:48:12 820 907 E ActivityManager:  +0% 11397/sh: 0% user + 0% kernel
08-26 00:48:12 820 907 E ActivityManager:  +0% 11398/app_process: 0% user + 0% kernel
08-26 00:48:12 820 907 E ActivityManager: 29% TOTAL: 5.1% user + 15% kernel + 9.5% iowait + 0% softirq
</code></pre>
<p>å…·ä½“çš„æ¶µä¹‰æˆ‘ä»¬ä¸å†èµ˜è¿°äº†ï¼Œåªå…³æ³¨ä¸€ä¸‹ ANR çš„åŸå› :</p>
<pre class=" language-log"><code class="language-log">Reason: Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)
</code></pre>
<p>ä¹‹å‰å¯¹ Input ANR æœºåˆ¶çš„åˆ†ææ´¾ä¸Šç”¨é•¿äº†ï¼Œæˆ‘ä»¬è½»æ¾çŸ¥é“è¿™ç§ ANR çš„åŸå› æ˜¯ä»€ä¹ˆã€‚ Wait queue lengthï¼š1 è¡¨ç¤ºä¹‹å‰çš„è¾“å…¥äº‹ä»¶å·²ç»æ´¾å‘åˆ° Settings è¿›ç¨‹äº†ï¼Œä½† Settings è¿›ç¨‹è¿˜æ²¡æœ‰å¤„ç†å®Œæ¯•ï¼Œæ–°æ¥çš„ KeyEvent äº‹ä»¶å·²ç»ç­‰å¾…è¶…è¿‡äº†5ç§’ï¼Œæ‰€ä»¥ANRäº§ç”Ÿäº†ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œåˆéœ€è¦æ‰¾åˆ°Settingsçš„tracesï¼Œåˆ†æSettingsä¸»çº¿ç¨‹å¤„ç†è¾“å…¥äº‹ä»¶è¶…æ—¶çš„åŸå› ï¼Œè¿™è¾¹ä¸å†è¯¦ç»†åˆ†æã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><strong><font color="#7FF000" size="3">æœ¬æ–‡å¯¹ Android ANR æœºåˆ¶è¿›è¡Œäº†æ·±å…¥çš„åˆ†æï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ANRçš„ç›‘æµ‹æœºåˆ¶ï¼šä»Serviceï¼ŒBroadcastï¼ŒInputEventä¸‰ç§ä¸åŒçš„ANRç›‘æµ‹æœºåˆ¶çš„æºç å®ç°å¼€å§‹ï¼Œåˆ†æäº† Android å¦‚ä½•å‘ç°å„ç±» ANRã€‚åœ¨å¯åŠ¨æœåŠ¡ã€æ´¾å‘å¹¿æ’­æ¶ˆæ¯å’Œè¾“å…¥äº‹ä»¶æ—¶ï¼Œæ¤å…¥è¶…æ—¶æ£€æµ‹ï¼Œç”¨äºå‘ç° ANRã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ANRçš„æŠ¥å‘Šæœºåˆ¶ï¼šåˆ†æ Android å¦‚ä½•è¾“å‡ºANRæ—¥å¿—ã€‚å½“ ANR è¢«å‘ç°åï¼Œä¸¤ä¸ªå¾ˆé‡è¦çš„æ—¥å¿—è¾“å‡ºæ˜¯ï¼šCPUä½¿ç”¨æƒ…å†µ å’Œ è¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œè¿™ä¸¤ç±»æ—¥å¿—æ˜¯æˆ‘ä»¬è§£å†³ANRé—®é¢˜çš„åˆ©å™¨ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ ANRçš„è§£å†³æ–¹æ³•ï¼šé€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå¯¹ ANR æ—¥å¿—è¿›è¡Œäº†æ·±å…¥è§£è¯»ï¼Œæ¢³ç†äº†åˆ†æANRé—®é¢˜çš„æ€è·¯å’Œé€”å¾„ã€‚</p>
<p>æœ€åï¼Œè‡´å„ä½è¯»è€…ï¼Œä»æ—¥å¿—å‡ºå‘è§£å†³ ANR é—®é¢˜ï¼Œç†è§£ ANR æœºåˆ¶èƒŒåçš„å®ç°åŸç†ï¼Œç¢°åˆ°å†éš¾çš„ ANR é—®é¢˜ä¹Ÿæ— éœ€æƒŠæ…Œã€‚</p>
<h1 id="å‚è€ƒBlog"><a href="#å‚è€ƒBlog" class="headerlink" title="å‚è€ƒBlog"></a>å‚è€ƒBlog</h1><p>&nbsp;01. <a href="https://blog.csdn.net/wds1181977/article/details/78330212" target="_blank" rel="noopener">https://blog.csdn.net/wds1181977/article/details/78330212</a></p>
<h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>å¾®ä¿¡é‡Œç‚¹â€œå‘ç°â€->â€œæ‰«ä¸€æ‰«â€äºŒç»´ç ä¾¿å¯æŸ¥çœ‹åˆ†äº«ã€‚</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;è½¬è½½è¯·æ³¨æ˜:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Hexo</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2018/08/26/07.xing-neng-you-hua-xi-lie-quan-mian-jie-xi-android-ying-yong-wen-ti-zhi-anr/" class="b-link-green">å…¨é¢è§£æ Android åº”ç”¨é—®é¢˜ ä¹‹ ANR</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScriptã€‚</noscript>
    </div>
    <!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2018/09/03/07.xing-neng-you-hua-xi-lie-dai-ni-ling-lue-android-nei-cun-xie-lou-de-qian-shi-jin-sheng/">
                    <div class="card-image">
                        
                        <img src="http://poobjb5p7.bkt.clouddn.com/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg" class="responsive-img" alt="å¸¦ä½ é¢†ç•¥ Android å†…å­˜æ³„æ¼çš„å‰ä¸–ä»Šç”Ÿ">
                        
                        <span class="card-title">å¸¦ä½ é¢†ç•¥ Android å†…å­˜æ³„æ¼çš„å‰ä¸–ä»Šç”Ÿ</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
å†…å­˜æ³„æ¼åœ¨é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­æ˜¯å¸¸è§çš„é—®é¢˜ï¼Œæœ¬ç« èŠ‚å¯¹å¸¸è§çš„æ³„æ¼åŸå› ï¼Œå¦‚ï¼šæ°¸è¿œçš„å•ä¾‹ã€static å…³é”®å­—ã€AsyncTaskç­‰ä½œäº†è¯¦ç»†çš„è¯´æ˜ï¼


åŸºç¡€äº†è§£ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿå†…å­˜æ³„æ¼æ˜¯å½“ç¨‹åºä¸å†ä½¿ç”¨åˆ°çš„å†…å­˜æ—¶ï¼Œé‡Šæ”¾å†…å­˜å¤±è´¥è€Œäº§ç”Ÿäº†æ— ç”¨çš„å†…å­˜æ¶ˆè€—</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2018-09-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="post-category" target="_blank">
                                    æ€§èƒ½ä¼˜åŒ–
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/å†…å­˜æ³„æ¼/" target="_blank">
                        <span class="chip bg-color">å†…å­˜æ³„æ¼</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/08/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-yuan-li-zhi-jin-cheng-bei-sha/">
                    <div class="card-image">
                        
                        <img src="http://poobjb5p7.bkt.clouddn.com/%E6%9D%80%E8%BF%9B%E7%A8%8B%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg" class="responsive-img" alt="æ·±å…¥é’»ç ” Android æ ¸å¿ƒåŸç† ä¹‹ è¿›ç¨‹è¢«æ€">
                        
                        <span class="card-title">æ·±å…¥é’»ç ” Android æ ¸å¿ƒåŸç† ä¹‹ è¿›ç¨‹è¢«æ€</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
é€šè¿‡ killProcessã€killProcessQuietã€killProcessGroup ä¸‰ä¸ªæ€è¿›ç¨‹çš„æ–¹æ³•åˆ†æè¿›ç¨‹è¢«æ€çš„å®ç°åŸç†ï¼


ä¸€ã€å¼€ç¯‡1.1 æ ¸å¿ƒæºç 


å…³é”®ç±»
è·¯å¾„




Process.java
framewor</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-08-20
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ ¸å¿ƒæŠ€æœ¯/" class="post-category" target="_blank">
                                    æ ¸å¿ƒæŠ€æœ¯
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Process/" target="_blank">
                        <span class="chip bg-color">Process</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: Hexo<br />'
            + 'ä½œè€…: Marco<br />'
            + 'é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQè”ç³»æˆ‘: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>