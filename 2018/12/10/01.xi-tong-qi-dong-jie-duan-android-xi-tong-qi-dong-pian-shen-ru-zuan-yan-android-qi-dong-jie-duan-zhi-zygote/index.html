<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote, Thinking in Android">
    <meta name="description" content="
ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€Android å¯åŠ¨é˜¶æ®µç³»åˆ—ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ï¿½">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color-header-marco nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>é¦–é¡µ</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>ç›®å½•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>æ ‡ç­¾</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>ç»„ä»¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>å¼€æœº</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>æ¡†æ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>æœºåˆ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>ä¼˜åŒ–</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>æ¨¡å¼</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>ç®—æ³•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>æ‹“å±•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>ä½œè€…</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="æ£€ç´¢åšæ–‡"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                é¦–é¡µ
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                ç›®å½•
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                æ ‡ç­¾
            </a>
        </li>
        
        <li>
            <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                ç»„ä»¶
            </a>
        </li>
        
        <li>
            <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                å¼€æœº
            </a>
        </li>
        
        <li>
            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                æ¡†æ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                æœºåˆ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                ä¼˜åŒ–
            </a>
        </li>
        
        <li>
            <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                æ¨¡å¼
            </a>
        </li>
        
        <li>
            <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                ç®—æ³•
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                æ‹“å±•
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                ä½œè€…
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/ç³»ç»Ÿå¯åŠ¨-02.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="container content">

    
    <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/å¯åŠ¨é˜¶æ®µ/" target="_blank">
                                <span class="chip bg-color">å¯åŠ¨é˜¶æ®µ</span>
                            </a>
                        
                            <a href="/tags/zygote/" target="_blank">
                                <span class="chip bg-color">zygote</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="post-category" target="_blank">
                                ç³»ç»Ÿå¯åŠ¨
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;å‘å¸ƒæ—¥æœŸ :&nbsp;
                    2018-12-10
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;æ–‡ç« å­—æ•° :&nbsp;
                        2.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;é˜…è¯»æ—¶é•¿ :&nbsp;
                        10 åˆ†é’Ÿ
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;é˜…è¯»æ¬¡æ•° :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€</center><br><center><strong><font color="#1874CD"><font color="#3A5FCD" size="4">Android å¯åŠ¨é˜¶æ®µç³»åˆ—</font></font></strong></center><br><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€</center>

<p><br></p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€å¯åŠ¨é˜¶æ®µã€‘</font></strong></th>
<th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th>
<th style="text-align:center"><strong><font color="#9932CC" size="3">æºç ç‰ˆæœ¬</font></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">init</font></strong></td>
<td style="text-align:center"><a href="https://superandroid.pro/2018/12/01/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20init/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">zygote</font></strong></td>
<td style="text-align:center"><a href="https://superandroid.pro/2018/12/10/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20zygote/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">systemserver</font></strong></td>
<td style="text-align:center"><a href="https://superandroid.pro/2018/12/18/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20systemserver/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">Launcher</font></strong></td>
<td style="text-align:center"><a href="https://superandroid.pro/2018/12/26/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20Launcher/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨åŠåŠ è½½æµç¨‹</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong><font color="#3A5FCD" size="4">åšæ–‡ä¿®æ”¹æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† zygote æºç ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br><br></p>
<hr>
<h1 id="å¼€ç¯‡"><a href="#å¼€ç¯‡" class="headerlink" title="å¼€ç¯‡"></a>å¼€ç¯‡</h1><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><table>
<thead>
<tr>
<th>å…³é”®ç±»</th>
<th>è·¯å¾„</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">init.rc</font></td>
<td>system/core/rootdir/init.rc</td>
</tr>
<tr>
<td><font color="#D15FEE">init.cpp</font></td>
<td>system/core/init/init.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">init.zygote64.rc</font></td>
<td>system/core/rootdir/init.zygote64.rc</td>
</tr>
<tr>
<td><font color="#D15FEE">builtins.cpp</font></td>
<td>system/core/init/builtins.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">service.cpp</font></td>
<td>system/core/init/service.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">app_main.cpp</font></td>
<td>frameworks/base/cmds/app_process/app_main.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">AndroidRuntime.cpp</font></td>
<td>frameworks/base/core/jni/AndroidRuntime.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">JniInvocation.cpp</font></td>
<td>libnativehelper/JniInvocation.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">ZygoteInit.java</font></td>
<td>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ZygoteServer.java</font></td>
<td>frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</td>
</tr>
</tbody>
</table>
<h2 id="Zygoteç®€ä»‹"><a href="#Zygoteç®€ä»‹" class="headerlink" title="Zygoteç®€ä»‹"></a>Zygoteç®€ä»‹</h2><p>åœ¨Androidç³»ç»Ÿä¸­ï¼ŒJavaVM(Javaè™šæ‹Ÿæœº)ã€åº”ç”¨ç¨‹åºè¿›ç¨‹ä»¥åŠè¿è¡Œç³»ç»Ÿçš„å…³é”®æœåŠ¡çš„SystemServerè¿›ç¨‹éƒ½æ˜¯ç”±Zygoteè¿›ç¨‹æ¥åˆ›å»ºçš„ï¼Œæˆ‘ä»¬ä¹Ÿå°†å®ƒç§°ä¸ºå­µåŒ–å™¨ã€‚å®ƒé€šè¿‡fock(å¤åˆ¶è¿›ç¨‹)çš„å½¢å¼æ¥åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹ï¼Œç”±äºZygoteè¿›ç¨‹åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºJavaVMï¼Œå› æ­¤é€šè¿‡fockè€Œåˆ›å»ºçš„åº”ç”¨ç¨‹åºè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹å¯ä»¥åœ¨å†…éƒ¨è·å–ä¸€ä¸ªJavaVMçš„å®ä¾‹æ‹·è´ã€‚</p>
<h1 id="Read-The-Fucking-Code"><a href="#Read-The-Fucking-Code" class="headerlink" title="Read The Fucking Code"></a>Read The Fucking Code</h1><h2 id="Zygoteè§¦å‘"><a href="#Zygoteè§¦å‘" class="headerlink" title="Zygoteè§¦å‘"></a>Zygoteè§¦å‘</h2><p>åœ¨åˆ†æinitè¿›ç¨‹æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“initè¿›ç¨‹å¯åŠ¨åï¼Œä¼šè§£æinit.rcæ–‡ä»¶ï¼Œç„¶ååˆ›å»ºå’ŒåŠ è½½serviceå­—æ®µæŒ‡å®šçš„è¿›ç¨‹ã€‚zygoteè¿›ç¨‹å°±æ˜¯ä»¥è¿™ç§æ–¹å¼ï¼Œè¢«initè¿›ç¨‹åŠ è½½çš„ã€‚</p>
<p>åœ¨system/core/rootdir/init.rcçš„å¼€å§‹éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code>import /init.environ.rc
import /init.usb.rc
import /init.${ro.hardware}.rc
import /vendor/etc/init/hw/init.${ro.hardware}.rc
import /init.usb.configfs.rc
import /init.${ro.zygote}.rc           // ${ro.zygote}ç”±å‚å•†å®šä¹‰ï¼Œä¸å¹³å°ç›¸å…³

on early-init
    # Set init and its forked children&#39;s oom_adj.
    write /proc/1/oom_score_adj -1000
</code></pre><h3 id="init-zygoteXX-rc"><a href="#init-zygoteXX-rc" class="headerlink" title="init.zygoteXX.rc"></a>init.zygoteXX.rc</h3><p>ä»ä¹‹å‰åˆ†æçš„initç¯‡ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä¸åŒçš„å¹³å°ï¼ˆ32ã€64åŠ64_32ï¼‰ä¸Šï¼Œinit.rcå°†åŒ…å«ä¸åŒçš„zygote.rcæ–‡ä»¶ã€‚åœ¨system/core/rootdirç›®å½•ä¸‹ï¼Œæœ‰init.zygote32_64.rcã€init.zyote64.rcã€ init.zyote32.rcã€init.zygote64_32.rcã€‚ </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote32.rc</font>ï¼šzygote è¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯ app_process (çº¯ 32bit æ¨¡å¼)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote64.rc</font>ï¼šzygote è¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯ app_process64 (çº¯ 64bit æ¨¡å¼)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote32_64.rc</font>ï¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ (åä¸º zygote å’Œ zygote_secondary)ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯ app_process32 (ä¸»æ¨¡å¼)ã€app_process64<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote64_32.rc</font>ï¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ (åä¸º zygote å’Œ zygote_secondary)ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯ app_process64 (ä¸»æ¨¡å¼)ã€app_process32</p>
<p>ä¸ºä»€ä¹ˆè¦å®šä¹‰è¿™ä¹ˆå¤šç§æƒ…å†µå‘¢ï¼Ÿç›´æ¥å®šä¹‰ä¸€ä¸ªä¸å°±å¥½äº†ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºAndroid 5.0ä»¥åå¼€å§‹æ”¯æŒ64ä½ç¨‹åºï¼Œä¸ºäº†å…¼å®¹32ä½å’Œ64ä½æ‰è¿™æ ·å®šä¹‰ã€‚ä¸åŒçš„zygote.rcå†…å®¹å¤§è‡´ç›¸åŒï¼Œä¸»è¦åŒºåˆ«ä½“ç°åœ¨å¯åŠ¨çš„æ˜¯32ä½ï¼Œè¿˜æ˜¯64ä½çš„è¿›ç¨‹ã€‚init.zygote32_64.rcå’Œinit.zygote64_32.rcä¼šå¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸”å­˜åœ¨ä¸»æ¬¡ä¹‹åˆ†ã€‚</p>
<p>è¿™é‡Œæ‹¿64ä½å¤„ç†å™¨ä¸ºä¾‹ï¼Œinit.zygote64_32.rcçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>// è¿›ç¨‹åç§°æ˜¯zygote,è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨/system/bin/app_process64
// å¯åŠ¨å‚æ•°æ˜¯ -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote
service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote
    class main
    priority -20
    user root
    group root readproc
    socket zygote stream 660 root system                               // åˆ›å»ºä¸€ä¸ªsocketï¼Œåå­—å«zygoteï¼Œä»¥tcpå½¢å¼
    onrestart write /sys/android_power/request_state wake              // onrestart æŒ‡å½“è¿›ç¨‹é‡å¯æ—¶æ‰§è¡Œåé¢çš„å‘½ä»¤
    onrestart write /sys/power/state on
    onrestart restart audioserver
    onrestart restart cameraserver
    onrestart restart media
    onrestart restart netd
    onrestart restart wificond
    writepid /dev/cpuset/foreground/tasks                              // åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œå‘ /dev/cpuset/foreground/tasks å†™å…¥pid

// å¦ä¸€ä¸ªservice ,åå­— zygote_secondary
service zygote_secondary /system/bin/app_process32 -Xzygote /system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload
    class main
    priority -20
    user root
    group root readproc
    socket zygote_secondary stream 660 root system
    onrestart restart zygote
    writepid /dev/cpuset/foreground/tasks

</code></pre><h3 id="start-zygote"><a href="#start-zygote" class="headerlink" title="start zygote"></a>start zygote</h3><p>å®šä¹‰äº†serviceï¼Œè‚¯å®šæœ‰åœ°æ–¹è°ƒç”¨ start zygoteã€‚åœ¨ä¹‹å‰initè§£æçš„åšå®¢ä¸­ï¼Œæˆ‘ä»¬åˆ†æè¿‡initè¿›ç¨‹çš„å¯åŠ¨ã€‚initè¿›ç¨‹å¯åŠ¨çš„æœ€åï¼Œä¼šäº§ç”Ÿâ€late-initâ€äº‹ä»¶ã€‚</p>
<pre class=" language-C++"><code class="language-C++">    // Don't mount filesystems or start core system services in charger mode.
    std::string bootmode = GetProperty("ro.bootmode", "");
    if (bootmode == "charger") {
        am.QueueEventTrigger("charger");
    } else {
        am.QueueEventTrigger("late-init");
    }
</code></pre>
<p>å¯¹åº”äºinit.rcé…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code># Mount filesystems and start core system services.
on late-init
    trigger early-fs
    ... ...
    # Now we can start zygote for devices with file based encryption
    trigger zygote-start                 // è§¦å‘äº†zygote-startäº‹ä»¶åï¼Œå°±ä¼šå¯åŠ¨zygoteè¿›ç¨‹
    ... ...
</code></pre><p>å¯¹åº”äºinit.rcé…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code># It is recommended to put unnecessary data/ initialization from post-fs-data
# to start-zygote in device&#39;s init.rc to unblock zygote start.
on zygote-start &amp;&amp; property:ro.crypto.state=unencrypted
    # A/B update verifier that marks a successful boot.
    exec_start update_verifier_nonencrypted       
    start netd                    // startå¯¹åº”çš„æ˜ å°„å…³ç³»å®šä¹‰äºsystem/core/init/builtins.cppä¸­
    start zygote                  // è°ƒç”¨startå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¯åŠ¨åä¸ºzygoteçš„æœåŠ¡ï¼ˆä¼ å…¥å‰æ–‡init.zygote.rcä¸­å®šä¹‰çš„å‚æ•°ï¼‰
    start zygote_secondary

on zygote-start &amp;&amp; property:ro.crypto.state=unsupported
    # A/B update verifier that marks a successful boot.
    exec_start update_verifier_nonencrypted
    start netd
    start zygote
    start zygote_secondary

on zygote-start &amp;&amp; property:ro.crypto.state=encrypted &amp;&amp; property:ro.crypto.type=file
    # A/B update verifier that marks a successful boot.
    exec_start update_verifier_nonencrypted
    start netd
    start zygote
    start zygote_secondary
</code></pre><p>startå‘½ä»¤æœ‰ä¸€ä¸ªå¯¹åº”çš„æ‰§è¡Œå‡½æ•°do_startï¼Œå®šä¹‰åœ¨platform/system/core/init/builtins.cppä¸­</p>
<pre class=" language-C++"><code class="language-C++">const BuiltinFunctionMap::Map& BuiltinFunctionMap::map() const {
    constexpr std::size_t kMax = std::numeric_limits<std::size_t>::max();
    // clang-format off
    static const Map builtin_functions = {
        ... ...
        {"start",                   {1,     1,    do_start}},
        ... ...
    };
    // clang-format on
    return builtin_functions;
}
</std::size_t></code></pre>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹do_start()ï¼š</p>
<pre class=" language-C++"><code class="language-C++">static int do_start(const std::vector<std::string>& args) {
    Service* svc = ServiceManager::GetInstance().FindServiceByName(args[1]);    // æ‰¾åˆ°zygote serviceå¯¹åº”ä¿¡æ¯
    if (!svc) {
        LOG(ERROR) << "do_start: Service " << args[1] << " not found";
        return -1;
    }
    if (!svc->Start())         // å¯åŠ¨å¯¹åº”çš„è¿›ç¨‹
        return -1;
    return 0;
}
</std::string></code></pre>
<p>do_starté¦–å…ˆæ˜¯é€šè¿‡FindServiceByNameå»serviceæ•°ç»„ä¸­éå†ï¼Œæ ¹æ®åå­—åŒ¹é…å‡ºå¯¹åº”çš„serviceï¼Œç„¶åè°ƒç”¨serviceçš„Startå‡½æ•°ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹service.cppä¸­å®šä¹‰Startå‡½æ•°ï¼š</p>
<pre class=" language-C++"><code class="language-C++">bool Service::Start() {

    ... ...

    pid_t pid = -1;
    if (namespace_flags_) {
        pid = clone(nullptr, nullptr, namespace_flags_ | SIGCHLD, nullptr);
    } else {
        pid = fork();         // ä»initè¿›ç¨‹ä¸­ï¼Œforkå‡ºzygoteè¿›ç¨‹
    }

    ... ...
}
</code></pre>
<p>Startå‡½æ•°ä¸»è¦æ˜¯forkå‡ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç„¶åæ‰§è¡Œserviceå¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†å‚æ•°ä¼ é€’è¿›å»ã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬ä»¥init.zygote64.rcä¸ºä¾‹è¿›è¡Œåˆ†æã€‚</p>
<h2 id="app-process"><a href="#app-process" class="headerlink" title="app_process"></a>app_process</h2><p>ä»ä¸Šé¢æˆ‘ä»¬åˆ†æçš„init.zygote64.rcå¯ä»¥çœ‹å‡ºï¼Œzygote64å¯åŠ¨æ–‡ä»¶çš„åœ°å€ä¸ºapp_process64ã€‚app_process64å¯¹åº”çš„ä»£ç å®šä¹‰åœ¨frameworks/base/cmds/app_processä¸­ï¼Œ </p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹åº”çš„Android.mkï¼š frameworks/base/cmds/app_process</p>
<pre class=" language-mk"><code class="language-mk">LOCAL_PATH:= $(call my-dir)

... ...

app_process_src_files := \
    app_main.cpp \

... ...

LOCAL_MODULE:= app_process
LOCAL_MULTILIB := both
LOCAL_MODULE_STEM_32 := app_process32
LOCAL_MODULE_STEM_64 := app_process64
</code></pre>
<p>å…¶å®ä¸ç®¡æ˜¯app_processã€app_process32è¿˜æ˜¯app_process64ï¼Œå¯¹åº”çš„æºæ–‡ä»¶éƒ½æ˜¯app_main.cppã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹app_processå¯¹åº”çš„mainå‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äºapp_main.cppä¸­ã€‚</p>
<p>åœ¨app_main.cppçš„mainå‡½æ•°ä¸­ï¼Œä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯å‚æ•°è§£æ. è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ç§å¯åŠ¨æ¨¡å¼ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä¸€ç§æ˜¯zygoteæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–zygoteè¿›ç¨‹ï¼Œä¼ é€’çš„å‚æ•°æœ‰â€“start-system-server â€“socket-name=zygoteï¼Œå‰è€…è¡¨ç¤ºå¯åŠ¨SystemServerï¼Œåè€…æŒ‡å®šsocketçš„åç§°ï¼ˆZygote64_32ï¼‰ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä¸€ç§æ˜¯applicationæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å¯åŠ¨æ™®é€šåº”ç”¨ç¨‹åºï¼Œä¼ é€’çš„å‚æ•°æœ‰classåå­—ä»¥åŠclasså¸¦çš„å‚æ•°ã€‚</p>
<p>ä¸¤è€…æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨AppRuntimeå¯¹è±¡çš„startå‡½æ•°ï¼ŒåŠ è½½ZygoteInitæˆ–RuntimeInitä¸¤ä¸ªJavaç±»ï¼Œå¹¶å°†ä¹‹å‰æ•´ç†çš„å‚æ•°ä¼ å…¥è¿›å»ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œæš‚æ—¶åªè®²è§£ZygoteInitçš„åŠ è½½æµç¨‹ã€‚</p>
<pre class=" language-C++"><code class="language-C++">int main(int argc, char* const argv[])
{
    // å°†å‚æ•°argvæ”¾åˆ°argv_Stringå­—ç¬¦ä¸²ä¸­ï¼Œç„¶åæ‰“å°å‡ºæ¥
    // ä¹‹å‰start zygoteä¼ å…¥çš„å‚æ•°æ˜¯ -Xzygote /system/bin --zygote --start-system-server
    if (!LOG_NDEBUG) {
      String8 argv_String;
      for (int i = 0; i < argc; ++i) {
        argv_String.append("\"");
        argv_String.append(argv[i]);
        argv_String.append("\" ");
      }
      ALOGV("app_process main with argv: %s", argv_String.string());
    }

    // AppRuntimeå®šä¹‰äºapp_main.cppä¸­ï¼Œç»§æ‰¿è‡ªAndroidRuntime
    // å°±æ˜¯å¯¹Androidè¿è¡Œç¯å¢ƒçš„ä¸€ç§æŠ½è±¡ï¼Œç±»ä¼¼äºjavaè™šæ‹Ÿæœºå¯¹Javaç¨‹åºçš„ä½œç”¨
    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));
    // Process command line arguments
    // ignore argv[0]
    argc--;
    argv++;

    // è¿™ä¸¤ä¸ªå‚æ•°æ˜¯Javaç¨‹åºéœ€è¦ä¾èµ–çš„JaråŒ…ï¼Œç›¸å½“äºimport
    const char* spaced_commands[] = { "-cp", "-classpath" };
    // Allow "spaced commands" to be succeeded by exactly 1 argument (regardless of -s).
    bool known_command = false;

    int i;
    // æ‰¾åˆ°è§£æå‚æ•°çš„èµ·ç‚¹
    for (i = 0; i < argc; i++) {
        // å°†spaced_commandsä¸­çš„å‚æ•°é¢å¤–åŠ å…¥VM
        if (known_command == true) {
          runtime.addOption(strdup(argv[i]));
          // The static analyzer gets upset that we don't ever free the above
          // string. Since the allocation is from main, leaking it doesn't seem
          // problematic. NOLINTNEXTLINE
          ALOGV("app_process main add known option '%s'", argv[i]);
          known_command = false;
          continue;
        }

        for (int j = 0;
             j < static_cast<int>(sizeof(spaced_commands) / sizeof(spaced_commands[0]));
             ++j) {
            // æ¯”è¾ƒå‚æ•°æ˜¯å¦æ˜¯spaced_commandsä¸­çš„å‚æ•°
          if (strcmp(argv[i], spaced_commands[j]) == 0) {
            known_command = true;
            ALOGV("app_process main found known command '%s'", argv[i]);
          }
        }

        // å¦‚æœå‚æ•°ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯'-'ï¼Œç›´æ¥è·³å‡ºå¾ªç¯ï¼Œä¹‹å‰ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ -Xzygoteï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°è¿™å„¿å°±è·³å‡ºäº†
        if (argv[i][0] != '-') {
            break;
        }
        if (argv[i][1] == '-' && argv[i][2] == 0) {
            ++i; // Skip --.
            break;
        }

        runtime.addOption(strdup(argv[i]));
        // The static analyzer gets upset that we don't ever free the above
        // string. Since the allocation is from main, leaking it doesn't seem
        // problematic. NOLINTNEXTLINE
        ALOGV("app_process main add option '%s'", argv[i]);
    }

    // Parse runtime arguments.  Stop at first unrecognized option.
    // ä»è¿™é‡Œå…¶å®å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡app_mainå¯ä»¥å¯åŠ¨zygoteã€system-serveråŠæ™®é€šapkè¿›ç¨‹
    // è¿™ä¸ªå¯ä»¥é€šè¿‡init.rcæ¥é…ç½®
    bool zygote = false;
    bool startSystemServer = false;
    bool application = false;
    String8 niceName;                              // app_processçš„åç§°æ”¹ä¸ºzygote
    String8 className;                             // å¯åŠ¨apkè¿›ç¨‹æ—¶ï¼Œå¯¹åº”çš„ç±»å

    ++i;  // Skip unused "parent dir" argument.
    // è·³è¿‡ä¸€ä¸ªå‚æ•°ï¼Œä¹‹å‰è·³è¿‡äº†-Xzygoteï¼Œè¿™é‡Œç»§ç»­è·³è¿‡ /system/bin ,ä¹Ÿå°±æ˜¯æ‰€è°“çš„ "parent dir"
    while (i < argc) {                             // å¼€å§‹è§£æè¾“å…¥å‚æ•°
        const char* arg = argv[i++];
        if (strcmp(arg, "--zygote") == 0) {        // è¡¨ç¤ºæ˜¯zygoteå¯åŠ¨æ¨¡å¼
            zygote = true;
            niceName = ZYGOTE_NICE_NAME;           // è¿™ä¸ªå€¼æ ¹æ®å¹³å°å¯èƒ½æ˜¯zygote64æˆ–zygote
        } else if (strcmp(arg, "--start-system-server") == 0) {
            startSystemServer = true;              // init.zygote.rcä¸­å®šä¹‰äº†è¯¥å­—æ®µï¼Œå¯åŠ¨zygoteåä¼šå¯åŠ¨system-server
        } else if (strcmp(arg, "--application") == 0) {
            application = true;                    // è¡¨ç¤ºæ˜¯applicationå¯åŠ¨æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ™®é€šåº”ç”¨ç¨‹åº
        } else if (strncmp(arg, "--nice-name=", 12) == 0) {
            niceName.setTo(arg + 12);              // è¿›ç¨‹åˆ«åï¼Œå¯ä»¥è‡ªå·±æŒ‡å®šè¿›ç¨‹å
        } else if (strncmp(arg, "--", 2) != 0) {
            className.setTo(arg);                  // ä¸--applicationé…ç½®ï¼Œå¯åŠ¨æŒ‡å®šçš„ç±»ï¼Œapplicationå¯åŠ¨çš„class
            break;
        } else {
            --i;
            break;
        }
    }

    // å‡†å¤‡å‚æ•°
    Vector<string8> args;
    if (!className.isEmpty()) {                    // classNameä¸ä¸ºç©ºï¼Œè¯´æ˜æ˜¯applicationå¯åŠ¨æ¨¡å¼
        // We're not in zygote mode, the only argument we need to pass
        // to RuntimeInit is the application argument.
        //
        // The Remainder of args get passed to startup class main(). Make
        // copies of them before we overwrite them with the process name.
        args.add(application ? String8("application") : String8("tool"));
        runtime.setClassNameAndArgs(className, argc - i, argv + i);    // å°†classNameå’Œå‚æ•°è®¾ç½®ç»™runtime

        ... ...

    } else {                                       // zygoteå¯åŠ¨æ¨¡å¼
        // We're in zygote mode.
        maybeCreateDalvikCache();                  // åˆ›å»ºDalvikçš„ç¼“å­˜ç›®å½•å¹¶å®šä¹‰æƒé™

        if (startSystemServer) {                   // å¢åŠ start-system-serverå‚æ•°ï¼Œé»˜è®¤å¯åŠ¨zygoteåï¼Œå°±ä¼šå¯åŠ¨system_server
            args.add(String8("start-system-server"));
        }

        char prop[PROP_VALUE_MAX];                 // è·å–å¹³å°å¯¹åº”çš„abiä¿¡æ¯
        if (property_get(ABI_LIST_PROPERTY, prop, NULL) == 0) {
            LOG_ALWAYS_FATAL("app_process: Unable to determine ABI list from property %s.",
                ABI_LIST_PROPERTY);
            return 11;
        }

        String8 abiFlag("--abi-list=");            // å‚æ•°éœ€è¦åˆ¶å®šabi
        abiFlag.append(prop);
        args.add(abiFlag);                         // åŠ å…¥--abi-list=å‚æ•°

        // In zygote mode, pass all remaining arguments to the zygote
        // main() method.
        for (; i < argc; ++i) {
            args.add(String8(argv[i]));            // å°†å‰©ä¸‹çš„å‚æ•°åŠ å…¥args
        }
    }

    if (!niceName.isEmpty()) {                     // å°†app_processçš„è¿›ç¨‹åï¼Œæ›¿æ¢ä¸ºniceName
        runtime.setArgv0(niceName.string(), true /* setProcName */);
    }

    if (zygote) {                                  // è°ƒç”¨Runtimeçš„startå‡½æ•°, å¯åŠ¨ZygoteInit
        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);
    } else if (className) {                        // å¯åŠ¨zygoteæ²¡æœ‰è¿›å…¥è¿™ä¸ªåˆ†æ”¯
        // ä½†è¿™ä¸ªåˆ†æ”¯è¯´æ˜ï¼Œé€šè¿‡é…ç½®init.rcæ–‡ä»¶ï¼Œå…¶å®æ˜¯å¯ä»¥ä¸é€šè¿‡zygoteæ¥å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹
        // å¦‚æœæ˜¯applicationå¯åŠ¨æ¨¡å¼ï¼Œåˆ™åŠ è½½RuntimeInit
        runtime.start("com.android.internal.os.RuntimeInit", args, zygote);
    } else {
        // erroræƒ…å†µ
        fprintf(stderr, "Error: no class name or --zygote supplied.\n");
        app_usage();
        LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");
    }
}

</string8></int></code></pre>
<h2 id="AndroidRuntime"><a href="#AndroidRuntime" class="headerlink" title="AndroidRuntime"></a>AndroidRuntime</h2><p>ç”±äºAppRuntimeç»§æ‰¿è‡ªAndroidRuntimeï¼Œä¸”æ²¡æœ‰é‡å†™startæ–¹æ³•ï¼Œå› æ­¤zygoteçš„æµç¨‹è¿›å…¥åˆ°äº†AndroidRuntime.cppã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹AndroidRuntimeçš„startå‡½æ•°çš„æµç¨‹ã€‚</p>
<h3 id="åˆ›å»ºJavaè™šæ‹Ÿæœº"><a href="#åˆ›å»ºJavaè™šæ‹Ÿæœº" class="headerlink" title="åˆ›å»ºJavaè™šæ‹Ÿæœº"></a>åˆ›å»ºJavaè™šæ‹Ÿæœº</h3><pre class=" language-C++"><code class="language-C++">/*
 * Start the Android runtime.  This involves starting the virtual machine
 * and calling the "static void main(String[] args)" method in the class
 * named by "className".
 *
 * Passes the main function two arguments, the class name and the specified
 * options string.
 */
void AndroidRuntime::start(const char* className, const Vector<string8>& options, bool zygote)
{
    ... ...                                   // æ‰“å°ä¸€äº›æ—¥å¿—ï¼Œè·å–ANDROID_ROOTç¯å¢ƒå˜é‡

    /* start the virtual machine */
    JniInvocation jni_invocation;
    jni_invocation.Init(NULL);                // åˆå§‹åŒ–JNI,åŠ è½½libart.so
    JNIEnv* env;
    // åˆ›å»ºè™šæ‹Ÿæœºï¼Œå…¶ä¸­å¤§å¤šæ•°å‚æ•°ç”±ç³»ç»Ÿå±æ€§å†³å®š
    // æœ€ç»ˆï¼ŒstartVmåˆ©ç”¨JNI_CreateJavaVMåˆ›å»ºå‡ºè™šæ‹Ÿæœº
    if (startVm(&mJavaVM, &env, zygote) != 0) {
        return;
    }
    // å›è°ƒAppRuntimeçš„onVmCreatedå‡½æ•°
    // å¯¹äºzygoteè¿›ç¨‹çš„å¯åŠ¨æµç¨‹è€Œè¨€ï¼Œæ— å®é™…æ“ä½œï¼Œè¡¨ç¤ºè™šæ‹Ÿåˆ›å»ºå®Œæˆï¼Œä½†æ˜¯é‡Œé¢æ˜¯ç©ºå®ç°
    onVmCreated(env);

    ... ...
}
</string8></code></pre>
<p>è¿™è¾¹æˆ‘ä»¬è·Ÿä¸€ä¸‹jni_invocation.Init()ï¼šlibnativehelper/JniInvocation.cpp</p>
<p>Initå‡½æ•°ä¸»è¦ä½œç”¨æ˜¯åˆå§‹åŒ–JNIï¼Œå…·ä½“å·¥ä½œæ˜¯é¦–å…ˆé€šè¿‡dlopenåŠ è½½libart.soè·å¾—å…¶å¥æŸ„ï¼Œç„¶åè°ƒç”¨dlsymä»libart.soä¸­æ‰¾åˆ°JNI_GetDefaultJavaVMInitArgsã€JNI_CreateJavaVMã€JNI_GetCreatedJavaVMsä¸‰ä¸ªå‡½æ•°åœ°å€ï¼Œèµ‹å€¼ç»™å¯¹åº”æˆå‘˜å±æ€§ï¼Œè¿™ä¸‰ä¸ªå‡½æ•°ä¼šåœ¨åç»­è™šæ‹Ÿæœºåˆ›å»ºä¸­è°ƒç”¨ã€‚</p>
<pre class=" language-C++"><code class="language-C++">bool JniInvocation::Init(const char* library) {
#ifdef __ANDROID__
  char buffer[PROP_VALUE_MAX];
#else
  char* buffer = NULL;
#endif
  library = GetLibrary(library, buffer);              // é»˜è®¤è¿”å› libart.so
  // Load with RTLD_NODELETE in order to ensure that libart.so is not unmapped when it is closed.
  // This is due to the fact that it is possible that some threads might have yet to finish
  // exiting even after JNI_DeleteJavaVM returns, which can lead to segfaults if the library is
  // unloaded.
  const int kDlopenFlags = RTLD_NOW | RTLD_NODELETE;

  /*
   * 1.dlopenåŠŸèƒ½æ˜¯ä»¥æŒ‡å®šæ¨¡å¼æ‰“å¼€æŒ‡å®šçš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¥æŸ„
   * 2.RTLD_NOWè¡¨ç¤ºéœ€è¦åœ¨dlopenè¿”å›å‰ï¼Œè§£æå‡ºæ‰€æœ‰æœªå®šä¹‰ç¬¦å·ï¼Œå¦‚æœè§£æä¸å‡ºæ¥ï¼Œåœ¨dlopenä¼šè¿”å›NULL
   * 3.RTLD_NODELETEè¡¨ç¤ºåœ¨dlclose()æœŸé—´ä¸å¸è½½åº“ï¼Œå¹¶ä¸”åœ¨ä»¥åä½¿ç”¨dlopen()é‡æ–°åŠ è½½åº“æ—¶ä¸åˆå§‹åŒ–åº“ä¸­çš„é™æ€å˜é‡
   */
  handle_ = dlopen(library, kDlopenFlags);            // è·å–libart.soçš„å¥æŸ„
  if (handle_ == NULL) {                              // è·å–å¤±è´¥æ‰“å°é”™è¯¯æ—¥å¿—å¹¶å°è¯•å†æ¬¡æ‰“å¼€libart.so
    if (strcmp(library, kLibraryFallback) == 0) {
      // Nothing else to try.
      ALOGE("Failed to dlopen %s: %s", library, dlerror());
      return false;
    }
    // Note that this is enough to get something like the zygote
    // running, we can't property_set here to fix this for the future
    // because we are root and not the system user. See
    // RuntimeInit.commonInit for where we fix up the property to
    // avoid future fallbacks. http://b/11463182
    ALOGW("Falling back from %s to %s after dlopen error: %s",
          library, kLibraryFallback, dlerror());
    library = kLibraryFallback;
    handle_ = dlopen(library, kDlopenFlags);
    if (handle_ == NULL) {
      ALOGE("Failed to dlopen %s: %s", library, dlerror());
      return false;
    }
  }

  /*
   * 1.FindSymbolå‡½æ•°å†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯dlsym
   * 2.dlsymä½œç”¨æ˜¯æ ¹æ® åŠ¨æ€é“¾æ¥åº“ æ“ä½œå¥æŸ„(handle)ä¸ç¬¦å·(symbol)ï¼Œè¿”å›ç¬¦å·å¯¹åº”çš„åœ°å€
   * 3.è¿™é‡Œå®é™…å°±æ˜¯ä»libart.soä¸­å°†JNI_GetDefaultJavaVMInitArgsç­‰å¯¹åº”çš„åœ°å€å­˜å…¥&JNI_GetDefaultJavaVMInitArgs_ä¸­
   */
  if (!FindSymbol(reinterpret_cast<void**>(&JNI_GetDefaultJavaVMInitArgs_),
                  "JNI_GetDefaultJavaVMInitArgs")) {
    return false;
  }
  if (!FindSymbol(reinterpret_cast<void**>(&JNI_CreateJavaVM_),
                  "JNI_CreateJavaVM")) {
    return false;
  }
  if (!FindSymbol(reinterpret_cast<void**>(&JNI_GetCreatedJavaVMs_),
                  "JNI_GetCreatedJavaVMs")) {
    return false;
  }
  return true;
}
</void**></void**></void**></code></pre>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬å†è·Ÿä¸€ä¸‹startVm()ï¼š</p>
<p>è¿™ä¸ªå‡½æ•°ç‰¹åˆ«é•¿ï¼Œä½†æ˜¯é‡Œé¢åšçš„äº‹æƒ…å¾ˆå•ä¸€ï¼Œå…¶å®å°±æ˜¯ä»å„ç§ç³»ç»Ÿå±æ€§ä¸­è¯»å–ä¸€äº›å‚æ•°ï¼Œç„¶åé€šè¿‡addOptionè®¾ç½®åˆ°AndroidRuntimeçš„mOptionsæ•°ç»„ä¸­å­˜èµ·æ¥ï¼Œå¦å¤–å°±æ˜¯è°ƒç”¨ä¹‹å‰ä»libart.soä¸­æ‰¾åˆ°JNI_CreateJavaVMå‡½æ•°ï¼Œå¹¶å°†è¿™äº›å‚æ•°ä¼ å…¥ï¼Œç”±äºæœ¬ç¯‡ä¸»è¦è®²zygoteå¯åŠ¨æµç¨‹ï¼Œå› æ­¤å…³äºè™šæ‹Ÿæœºçš„å®ç°å°±ä¸æ·±å…¥æ¢ç©¶äº†ã€‚</p>
<pre class=" language-C++"><code class="language-C++">int AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, bool zygote)
{
    JavaVMInitArgs initArgs;
    char propBuf[PROPERTY_VALUE_MAX];
    char stackTraceFileBuf[sizeof("-Xstacktracefile:")-1 + PROPERTY_VALUE_MAX];
    char jniOptsBuf[sizeof("-Xjniopts:")-1 + PROPERTY_VALUE_MAX];

    ... ...

    /* route exit() to our handler */
    addOption("exit", (void*) runtime_exit);                                    // å°†å‚æ•°æ”¾å…¥mOptionsæ•°ç»„ä¸­

    ... ...

    initArgs.version = JNI_VERSION_1_4;
    initArgs.options = mOptions.editArray();                                    // å°†mOptionsèµ‹å€¼ç»™initArgs
    initArgs.nOptions = mOptions.size();
    initArgs.ignoreUnrecognized = JNI_FALSE;

    /*
     * Initialize the VM.
     *
     * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread.
     * If this call succeeds, the VM is ready, and we can start issuing
     * JNI calls.
     */
    if (JNI_CreateJavaVM(pJavaVM, pEnv, &initArgs) < 0) {                       // è°ƒç”¨libart.soçš„JNI_CreateJavaVMå‡½æ•°
        ALOGE("JNI_CreateJavaVM failed\n");
        return -1;
    }

    return 0;
}
</code></pre>
<h3 id="æ³¨å†ŒJNIå‡½æ•°"><a href="#æ³¨å†ŒJNIå‡½æ•°" class="headerlink" title="æ³¨å†ŒJNIå‡½æ•°"></a>æ³¨å†ŒJNIå‡½æ•°</h3><p>æˆ‘ä»¬å›åˆ°AndroidRuntimeçš„startå‡½æ•°ã€‚åˆå§‹åŒ–JVMåï¼Œæ¥ä¸‹æ¥å°±ä¼šè°ƒç”¨startRegå‡½æ•°ã€‚</p>
<pre class=" language-C++"><code class="language-C++">void AndroidRuntime::start(const char* className, const Vector<string8>& options, bool zygote)
{
    ... ...

    /* 01. åˆ›å»ºJavaè™šæ‹Ÿæœº*/

    /*
     * Register android functions.
     */
    if (startReg(env) < 0) {         // æ³¨å†ŒJNIå‡½æ•°
        ALOGE("Unable to register all android natives\n");
        return;
    }
    ... ...
}
</string8></code></pre>
<p>startRegé¦–å…ˆæ˜¯è®¾ç½®äº†Androidåˆ›å»ºçº¿ç¨‹çš„å¤„ç†å‡½æ•°ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª200å®¹é‡çš„å±€éƒ¨å¼•ç”¨ä½œç”¨åŸŸï¼Œç”¨äºç¡®ä¿ä¸ä¼šå‡ºç°OutOfMemoryExceptionï¼Œæœ€åå°±æ˜¯è°ƒç”¨register_jni_procsè¿›è¡ŒJNIæ³¨å†Œã€‚</p>
<p>æˆ‘ä»¬è·Ÿè¿›startReg()ï¼š</p>
<pre class=" language-C++"><code class="language-C++">/*
 * Register android native functions with the VM.
 */
/*static*/ int AndroidRuntime::startReg(JNIEnv* env)
{
    ATRACE_NAME("RegisterAndroidNatives");
    /*
     * This hook causes all future threads created in this process to be
     * attached to the JavaVM.  (This needs to go away in favor of JNI
     * Attach calls.)
     */

    // å®šä¹‰Androidåˆ›å»ºçº¿ç¨‹çš„funcï¼šjavaCreateThreadEtcï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨æ˜¯é€šè¿‡Linuxçš„cloneæ¥åˆ›å»ºçº¿ç¨‹çš„
    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);       

    ALOGV("--- registering native functions ---\n");

    /*
     * Every "register" function calls one or more things that return
     * a local reference (e.g. FindClass).  Because we haven't really
     * started the VM yet, they're all getting stored in the base frame
     * and never released.  Use Push/Pop to manage the storage.
     */
    env->PushLocalFrame(200);        // åˆ›å»ºä¸€ä¸ª200å®¹é‡çš„å±€éƒ¨å¼•ç”¨ä½œç”¨åŸŸ,è¿™ä¸ªå±€éƒ¨å¼•ç”¨å…¶å®å°±æ˜¯å±€éƒ¨å˜é‡

    if (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) < 0) {       // æ³¨å†ŒJNIå‡½æ•°
        env->PopLocalFrame(NULL);
        return -1;
    }

    env->PopLocalFrame(NULL);                                         // é‡Šæ”¾å±€éƒ¨å¼•ç”¨ä½œç”¨åŸŸ

    //createJavaThread("fubar", quickTest, (void*) "hello");

    return 0;
}
</code></pre>
<p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒstartRegå‡½æ•°ä¸­ä¸»è¦æ˜¯é€šè¿‡register_jni_procsæ¥æ³¨å†ŒJNIå‡½æ•°ã€‚å…¶ä¸­ï¼ŒgRegJNIæ˜¯ä¸€ä¸ªå…¨å±€æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre class=" language-C++"><code class="language-C++">static const RegJNIRec gRegJNI[] = {                                  // é‡Œé¢å°±æ˜¯ä¸€å †çš„å‡½æ•°æŒ‡é’ˆ
    REG_JNI(register_com_android_internal_os_RuntimeInit),
    REG_JNI(register_com_android_internal_os_ZygoteInit_nativeZygoteInit),
    REG_JNI(register_android_os_SystemClock),
    REG_JNI(register_android_util_EventLog),
    REG_JNI(register_android_util_Log),
    ... ...
};

</code></pre>
<p>æˆ‘ä»¬æŒ‘ä¸€ä¸ªregister_com_android_internal_os_ZygoteInit_nativeZygoteInitï¼Œè¿™å®é™…ä¸Šæ˜¯è‡ªå®šä¹‰JNIå‡½æ•°å¹¶è¿›è¡ŒåŠ¨æ€æ³¨å†Œçš„æ ‡å‡†å†™æ³•,<br>å†…éƒ¨æ˜¯è°ƒç”¨JNIçš„RegisterNativesï¼Œè¿™æ ·æ³¨å†Œåï¼ŒJavaç±»ZygoteInitçš„nativeæ–¹æ³•nativeZygoteInitå°±ä¼šè°ƒç”¨com_android_internal_os_ZygoteInit_nativeZygoteInitå‡½æ•°ã€‚</p>
<pre class=" language-C++"><code class="language-C++">int register_com_android_internal_os_ZygoteInit_nativeZygoteInit(JNIEnv* env)
{
    const JNINativeMethod methods[] = {
        { "nativeZygoteInit", "()V",
            (void*) com_android_internal_os_ZygoteInit_nativeZygoteInit },
    };
    return jniRegisterNativeMethods(env, "com/android/internal/os/ZygoteInit",
        methods, NELEM(methods));
}
</code></pre>
<p>REG_JNIå¯¹åº”çš„å®å®šä¹‰åŠRegJNIRecç»“æ„ä½“çš„å®šä¹‰ä¸ºï¼š</p>
<pre class=" language-C++"><code class="language-C++">#ifdef NDEBUG
    #define REG_JNI(name)      { name }
    struct RegJNIRec {
        int (*mProc)(JNIEnv*);
    };
#else
    #define REG_JNI(name)      { name, #name }
    struct RegJNIRec {
        int (*mProc)(JNIEnv*);
        const char* mName;
    };
#endif
</code></pre>
<p>æ ¹æ®å®å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œå®REG_JNIå°†å¾—åˆ°å‡½æ•°åï¼›å®šä¹‰RegJNIRecæ•°ç»„æ—¶ï¼Œå‡½æ•°åè¢«èµ‹å€¼ç»™RegJNIRecç»“æ„ä½“ï¼Œäºæ˜¯æ¯ä¸ªå‡½æ•°åè¢«å¼ºè¡Œè½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆã€‚<br>å› æ­¤ï¼Œregister_jni_procsçš„å‚æ•°å°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„å¤§å°å’ŒJNIEnvã€‚</p>
<p>æˆ‘ä»¬æ¥è·Ÿè¿›ä¸€ä¸‹register_jni_procså‡½æ•°ï¼š</p>
<pre class=" language-C++"><code class="language-C++">static int register_jni_procs(const RegJNIRec array[], size_t count, JNIEnv* env)
{
    for (size_t i = 0; i < count; i++) {
        if (array[i].mProc(env) < 0) {              // è°ƒç”¨mProc
#ifndef NDEBUG
            ALOGD("----------!!! %s failed to load\n", array[i].mName);
#endif
            return -1;
        }
    }
    return 0;
}
</code></pre>
<p>ç»“åˆå‰é¢çš„åˆ†æï¼Œå®¹æ˜“çŸ¥é“register_jni_procså‡½æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨å‡½æ•°æŒ‡é’ˆï¼ˆmProcï¼‰å¯¹åº”çš„å‡½æ•°ï¼Œä»¥è¿›è¡Œå®é™…çš„JNIå‡½æ•°æ³¨å†Œã€‚</p>
<h3 id="åå°„å¯åŠ¨ZygoteInit"><a href="#åå°„å¯åŠ¨ZygoteInit" class="headerlink" title="åå°„å¯åŠ¨ZygoteInit"></a>åå°„å¯åŠ¨ZygoteInit</h3><p>ç»§ç»­åˆ†æAndroidRuntime.cppçš„startå‡½æ•°ï¼š</p>
<pre class=" language-C++"><code class="language-C++">void AndroidRuntime::start(const char* className, const Vector<string8>& options, bool zygote)
{
    ... ...

    /* 01. åˆ›å»ºJavaè™šæ‹Ÿæœº*/
    /* 02. æ³¨å†ŒJNIå‡½æ•° */

    /*
     * Start VM.  This thread becomes the main thread of the VM, and will
     * not return until the VM exits.
     */

    // æ›¿æ¢stringä¸ºå®é™…è·¯å¾„
    // ä¾‹å¦‚ï¼šå°† "com.android.internal.os.ZygoteInit" æ›¿æ¢ä¸º "com/android/internal/os/ZygoteInit"
    char* slashClassName = toSlashClassName(className != NULL ? className : "");

    jclass startClass = env->FindClass(slashClassName);                    // æ‰¾åˆ°classæ–‡ä»¶
    if (startClass == NULL) {
        ALOGE("JavaVM unable to locate class '%s'\n", slashClassName);
        /* keep going */
    } else {
        jmethodID startMeth = env->GetStaticMethodID(startClass, "main",
            "([Ljava/lang/String;)V");                                     // é€šè¿‡åå°„æ‰¾åˆ°ZygoteInitçš„mainå‡½æ•°
        if (startMeth == NULL) {
            ALOGE("JavaVM unable to find main() in '%s'\n", className);
            /* keep going */
        } else {
            env->CallStaticVoidMethod(startClass, startMeth, strArray);    // è°ƒç”¨ZygoteInitçš„mainå‡½æ•°
            ... ...
        }
    }
    free(slashClassName);

    ALOGD("Shutting down VM\n");
    if (mJavaVM->DetachCurrentThread() != JNI_OK)                          // é€€å‡ºå½“å‰çº¿ç¨‹
        ALOGW("Warning: unable to detach main thread\n");
    if (mJavaVM->DestroyJavaVM() != 0)                                     // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹ç»“æŸåå…³é—­è™šæ‹Ÿæœº
        ALOGW("Warning: VM did not shut down cleanly\n");
}
</string8></code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨AndroidRuntimeçš„æœ€åï¼Œå°†é€šè¿‡åå°„è°ƒç”¨ZygoteInitçš„mainå‡½æ•°ã€‚è‡³æ­¤ï¼Œ<strong><font color="#87CEFA">zygoteè¿›ç¨‹è¿›å…¥äº†javaä¸–ç•Œ</font></strong>ã€‚ </p>
<p>å…¶å®æˆ‘ä»¬ä»”ç»†æƒ³ä¸€æƒ³ï¼Œå°±ä¼šè§‰å¾—zygoteçš„æ•´ä¸ªæµç¨‹å®é™…ä¸Šæ˜¯éå¸¸ç¬¦åˆå®é™…æƒ…å†µçš„ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;âœ¨âœ¨ åœ¨Androidä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¿è¡Œåœ¨å¯¹åº”çš„è™šæ‹Ÿæœºä¸Šï¼Œå› æ­¤zygoteé¦–å…ˆå°±è´Ÿè´£åˆ›å»ºå‡ºè™šæ‹Ÿæœºã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;âœ¨âœ¨ ç„¶åï¼Œä¸ºäº†åå°„è°ƒç”¨javaä»£ç ï¼Œå¿…é¡»æœ‰å¯¹åº”çš„JNIå‡½æ•°ï¼Œäºæ˜¯zygoteè¿›è¡Œäº†JNIå‡½æ•°çš„æ³¨å†Œã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;âœ¨âœ¨ å½“ä¸€åˆ‡å‡†å¤‡å¦¥å½“åï¼Œzygoteè¿›ç¨‹æ‰è¿›å…¥åˆ°äº†javaä¸–ç•Œã€‚</p>
<h2 id="ZygoteInit"><a href="#ZygoteInit" class="headerlink" title="ZygoteInit"></a>ZygoteInit</h2><p>ç°åœ¨æˆ‘ä»¬è·Ÿè¿›ZygoteInit.javaçš„mainå‡½æ•°ã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//åˆ›å»ºZygoteServerå¯¹è±¡</span>
        ZygoteServer zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             

        <span class="token comment" spellcheck="true">// Mark zygote start. This ensures that thread creation will throw</span>
        <span class="token comment" spellcheck="true">// an error.</span>
        <span class="token comment" spellcheck="true">// è°ƒç”¨nativeå‡½æ•°ï¼Œç¡®ä¿å½“å‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹åœ¨è¿è¡Œ</span>
        <span class="token comment" spellcheck="true">// ä¸»è¦è¿˜æ˜¯å¤„äºå®‰å…¨çš„è€ƒè™‘</span>
        ZygoteHooks<span class="token punctuation">.</span><span class="token function">startZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Zygote goes into its own process group.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Os<span class="token punctuation">.</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to setpgid(0,0)"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> Runnable caller<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            RuntimeInit<span class="token punctuation">.</span><span class="token function">enableDdms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            String socketName <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span>
            String abiList <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> enableLazyPreload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æå‚æ•°ï¼Œå¾—åˆ°ä¸Šè¿°å˜é‡çš„å€¼</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"--enable-lazy-preload"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    enableLazyPreload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    abiList <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socketName <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unknown command line argument: "</span> <span class="token operator">+</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>abiList <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No ABI list supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            zygoteServer<span class="token punctuation">.</span><span class="token function">registerServerSocket</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ³¨å†Œserver socket</span>
            <span class="token comment" spellcheck="true">// In some configurations, we avoid preloading resources and classes eagerly.</span>
            <span class="token comment" spellcheck="true">// In such cases, we will preload things prior to our first fork.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableLazyPreload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">preload</span><span class="token punctuation">(</span>bootTimingsTraceLog<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// é»˜è®¤æƒ…å†µï¼Œé¢„åŠ è½½ä¿¡æ¯</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æ³¨é‡Šï¼Œå»¶è¿Ÿé¢„åŠ è½½</span>
            <span class="token comment" spellcheck="true">// å˜æ›´Zygoteè¿›ç¨‹ä¼˜å…ˆçº§ä¸ºNORMALçº§åˆ«</span>
            <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡forkæ—¶æ‰ä¼špreload</span>
                Zygote<span class="token punctuation">.</span><span class="token function">resetNicePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Do an initial gc to clean up after startup</span>
            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"PostZygoteInitGC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">gcAndFinalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment" spellcheck="true">// å¦‚æœé¢„åŠ è½½äº†ï¼Œå¾ˆæœ‰å¿…è¦GCä¸€æ³¢</span>
            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// PostZygoteInitGC</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment" spellcheck="true">// Zygote process unmounts root storage spaces.</span>
            Zygote<span class="token punctuation">.</span><span class="token function">nativeUnmountStorageOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Set seccomp policy</span>
            <span class="token comment" spellcheck="true">// åŠ è½½seccompçš„è¿‡æ»¤è§„åˆ™</span>
            <span class="token comment" spellcheck="true">// æ‰€æœ‰ Android è½¯ä»¶éƒ½ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼ˆç®€ç§°ä¸º syscallï¼‰ä¸ Linux å†…æ ¸è¿›è¡Œé€šä¿¡</span>
            <span class="token comment" spellcheck="true">// å†…æ ¸æä¾›è®¸å¤šç‰¹å®šäºè®¾å¤‡å’ŒSOCçš„ç³»ç»Ÿè°ƒç”¨ï¼Œè®©ç”¨æˆ·ç©ºé—´è¿›ç¨‹ï¼ˆåŒ…æ‹¬åº”ç”¨ï¼‰å¯ä»¥ç›´æ¥ä¸å†…æ ¸è¿›è¡Œäº¤äº’</span>
            <span class="token comment" spellcheck="true">// ä¸è¿‡ï¼Œå…¶ä¸­è®¸å¤šç³»ç»Ÿè°ƒç”¨Androidæœªäºˆä½¿ç”¨æˆ–æœªäºˆæ­£å¼æ”¯æŒ</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡seccompï¼ŒAndroidå¯ä½¿åº”ç”¨è½¯ä»¶æ— æ³•è®¿é—®æœªä½¿ç”¨çš„å†…æ ¸ç³»ç»Ÿè°ƒç”¨</span>
            <span class="token comment" spellcheck="true">// ç”±äºåº”ç”¨æ— æ³•è®¿é—®è¿™äº›ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤ï¼Œå®ƒä»¬ä¸ä¼šè¢«æ½œåœ¨çš„æœ‰å®³åº”ç”¨åˆ©ç”¨</span>
            <span class="token comment" spellcheck="true">// è¯¥è¿‡æ»¤å™¨å®‰è£…åˆ°zygoteè¿›ç¨‹ä¸­ï¼Œç”±äºæ‰€æœ‰Androidåº”ç”¨å‡è¡ç”Ÿè‡ªè¯¥è¿›ç¨‹</span>
            <span class="token comment" spellcheck="true">// å› è€Œä¼šå½±å“åˆ°æ‰€æœ‰åº”ç”¨</span>
            Seccomp<span class="token punctuation">.</span><span class="token function">setPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/// M: Added for BOOTPROF</span>
            <span class="token function">addBootEvent</span><span class="token punctuation">(</span><span class="token string">"Zygote:Preload End"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/// @}</span>
            ZygoteHooks<span class="token punctuation">.</span><span class="token function">stopZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// å…è®¸æœ‰å…¶å®ƒçº¿ç¨‹äº†</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Runnable r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> socketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// forkå‡ºsystem server</span>

                <span class="token comment" spellcheck="true">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
                <span class="token comment" spellcheck="true">// child (system_server) process.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// The select loop returns early in the child process after a fork and</span>
            <span class="token comment" spellcheck="true">// loops forever in the zygote.</span>
            caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// zygoteè¿›ç¨‹è¿›å…¥æ— é™å¾ªç¯ï¼Œå¤„ç†è¯·æ±‚</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// We're in the child process and have exited the select loop. Proceed to execute the</span>
        <span class="token comment" spellcheck="true">// command.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            caller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šé¢æ˜¯ZygoteInitçš„mainå‡½æ•°çš„ä¸»å¹²éƒ¨åˆ†ï¼Œé™¤äº†å®‰å…¨ç›¸å…³çš„å†…å®¹å¤–ï¼Œæœ€ä¸»è¦çš„å·¥ä½œå°±æ˜¯æ³¨å†Œserver socketã€é¢„åŠ è½½ã€å¯åŠ¨system serveråŠè¿›å…¥æ— é™å¾ªç¯å¤„ç†è¯·æ±‚æ¶ˆæ¯ã€‚ </p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†å››éƒ¨åˆ†åˆ†åˆ«è®¨è®ºï¼</p>
<h3 id="åˆ›å»ºserver-socket"><a href="#åˆ›å»ºserver-socket" class="headerlink" title="åˆ›å»ºserver socket"></a>åˆ›å»ºserver socket</h3><p>Android Oå°†server socketç›¸å…³çš„å·¥ä½œæŠ½è±¡åˆ°ZygoteServer.javaä¸­äº†ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å…¶ä¸­çš„registerZygoteSocketå‡½æ•°ï¼š</p>
<pre class=" language-C++"><code class="language-C++">    /**
     * Registers a server socket for zygote command connections
     *
     * @throws RuntimeException when open fails
     */
    void registerServerSocket(String socketName) {
        if (mServerSocket == null) {
            int fileDesc;
            // ANDROID_SOCKET_PREFIXä¸º"ANDROID_SOCKET_"
            // æ­¤å¤„çš„socket nameï¼Œå°±æ˜¯zygote
            final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;
            try {
                // è¿˜è®°å¾—ä¹ˆï¼Ÿåœ¨init.zygote.rcè¢«åŠ è½½æ—¶ï¼ŒæŒ‡å®šäº†åä¸ºzygoteçš„socket
                // åœ¨è¿›ç¨‹è¢«åˆ›å»ºæ—¶ï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶åŠ å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­
                // å› æ­¤ï¼Œæ­¤æ—¶å¯ä»¥å–å‡ºå¯¹åº”çš„ç¯å¢ƒå˜é‡
                String env = System.getenv(fullSocketName);
                fileDesc = Integer.parseInt(env);
            } catch (RuntimeException ex) {
                throw new RuntimeException(fullSocketName + " unset or invalid", ex);
            }

            try {
                FileDescriptor fd = new FileDescriptor();
                fd.setInt$(fileDesc);                           // è·å–zygote socketçš„æ–‡ä»¶æè¿°ç¬¦
                mServerSocket = new LocalServerSocket(fd);      // å°†socketåŒ…è£…æˆä¸€ä¸ªserver socket
            } catch (IOException ex) {
                throw new RuntimeException(
                        "Error binding to local socket '" + fileDesc + "'", ex);
            }
        }
    }
</code></pre>
<p>æˆ‘ä»¬è·Ÿè¸ªLocalServerSocket()ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">LocalServerSocket</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException
    <span class="token punctuation">{</span>
        impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocketImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        impl<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>LocalSocket<span class="token punctuation">.</span>SOCKET_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">// åˆ›å»ºSOCKET_STREAMç±»å‹çš„AF_UNIX socket</span>

        localAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocketAddress</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        impl<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment" spellcheck="true">// ç»‘å®šåˆ°æŒ‡å®šåœ°å€</span>

        impl<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>LISTEN_BACKLOG<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// å¼€å§‹ç›‘å¬</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="é¢„åŠ è½½"><a href="#é¢„åŠ è½½" class="headerlink" title="é¢„åŠ è½½"></a>é¢„åŠ è½½</h3><p>æˆ‘ä»¬çœ‹çœ‹é¢„åŠ è½½çš„å†…å®¹ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preload</span><span class="token punctuation">(</span>TimingsTraceLog bootTimingsTraceLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">beginIcuCachePinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment" spellcheck="true">// Pin ICU Data, è·å–å­—ç¬¦é›†è½¬æ¢èµ„æºç­‰</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    

        <span class="token function">preloadClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                             <span class="token comment" spellcheck="true">// è¯»å–æ–‡ä»¶system/etc/preloaded-classesï¼Œç„¶åé€šè¿‡åå°„åŠ è½½å¯¹åº”çš„ç±»</span>
                                                                      <span class="token comment" spellcheck="true">// ä¸€èˆ¬ç”±å‚å•†æ¥å®šä¹‰ï¼Œæœ‰æ—¶éœ€è¦åŠ è½½æ•°åƒä¸ªç±»ï¼Œå¯åŠ¨æ…¢çš„åŸå› ä¹‹ä¸€</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">preloadResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                           <span class="token comment" spellcheck="true">// è´Ÿè´£åŠ è½½ä¸€äº›å¸¸ç”¨çš„ç³»ç»Ÿèµ„æº</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">nativePreloadAppProcessHALs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">preloadOpenGL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment" spellcheck="true">// å›¾å½¢ç›¸å…³</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">preloadSharedLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token comment" spellcheck="true">// ä¸€äº›å¿…è¦åº“</span>
        <span class="token function">preloadTextResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment" spellcheck="true">// è¯­è¨€ç›¸å…³çš„å­—ç¬¦ä¿¡æ¯</span>
        <span class="token comment" spellcheck="true">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span>
        <span class="token comment" spellcheck="true">// for memory sharing purposes.</span>
        WebViewFactory<span class="token punctuation">.</span><span class="token function">prepareWebViewInZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">endIcuCachePinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">warmUpJcaProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment" spellcheck="true">// å®‰å…¨ç›¸å…³çš„</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"end preload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        sPreloadComplete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ä¸ºäº†è®©ç³»ç»Ÿå®é™…è¿è¡Œæ—¶æ›´åŠ æµç•…ï¼Œåœ¨zygoteå¯åŠ¨æ—¶å€™ï¼Œè°ƒç”¨preloadå‡½æ•°è¿›è¡Œäº†ä¸€äº›é¢„åŠ è½½æ“ä½œã€‚Android é€šè¿‡zygote forkçš„æ–¹å¼åˆ›å»ºå­è¿›ç¨‹ã€‚zygoteè¿›ç¨‹é¢„åŠ è½½è¿™äº›ç±»å’Œèµ„æºï¼Œåœ¨forkå­è¿›ç¨‹æ—¶ï¼Œä»…éœ€è¦åšä¸€ä¸ªå¤åˆ¶å³å¯ã€‚<br>è¿™æ ·å¯ä»¥èŠ‚çº¦å­è¿›ç¨‹çš„å¯åŠ¨æ—¶é—´ã€‚åŒæ—¶ï¼Œæ ¹æ®forkçš„copy-on-writeæœºåˆ¶å¯çŸ¥ï¼Œæœ‰äº›ç±»å¦‚æœä¸åšæ”¹å˜ï¼Œç”šè‡³éƒ½ä¸ç”¨å¤åˆ¶ï¼Œå­è¿›ç¨‹å¯ä»¥å’Œçˆ¶è¿›ç¨‹å…±äº«è¿™éƒ¨åˆ†æ•°æ®ï¼Œä»è€Œçœå»ä¸å°‘å†…å­˜çš„å ç”¨ã€‚</p>
<h3 id="å¯åŠ¨SystemServerè¿›ç¨‹"><a href="#å¯åŠ¨SystemServerè¿›ç¨‹" class="headerlink" title="å¯åŠ¨SystemServerè¿›ç¨‹"></a>å¯åŠ¨SystemServerè¿›ç¨‹</h3><p>å†æ¥çœ‹çœ‹å¯åŠ¨System Serverçš„æµç¨‹ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Prepare the arguments and forks for the system server process.
     *
     * Returns an {@code Runnable} that provides an entrypoint into system_server code in the
     * child process, and {@code null} in the parent.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Runnable <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>String abiList<span class="token punctuation">,</span> String socketName<span class="token punctuation">,</span>
            ZygoteServer zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> capabilities <span class="token operator">=</span> <span class="token function">posixCapabilitiesAsBits</span><span class="token punctuation">(</span>
            OsConstants<span class="token punctuation">.</span>CAP_IPC_LOCK<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_KILL<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_NET_ADMIN<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_NET_BIND_SERVICE<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_NET_BROADCAST<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_NET_RAW<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_SYS_MODULE<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_SYS_NICE<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_SYS_PTRACE<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_SYS_TIME<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_SYS_TTY_CONFIG<span class="token punctuation">,</span>
            OsConstants<span class="token punctuation">.</span>CAP_WAKE_ALARM
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Containers run without this capability, so avoid setting it in that case */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemProperties<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>PROPERTY_RUNNING_IN_CONTAINER<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            capabilities <span class="token operator">|=</span> <span class="token function">posixCapabilitiesAsBits</span><span class="token punctuation">(</span>OsConstants<span class="token punctuation">.</span>CAP_BLOCK_SUSPEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/* Hardcoded command line to start the system server */</span>
        String args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"--setuid=1000"</span><span class="token punctuation">,</span>
            <span class="token string">"--setgid=1000"</span><span class="token punctuation">,</span>
            <span class="token string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010"</span><span class="token punctuation">,</span>
            <span class="token string">"--capabilities="</span> <span class="token operator">+</span> capabilities <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> capabilities<span class="token punctuation">,</span>
            <span class="token string">"--nice-name=system_server"</span><span class="token punctuation">,</span>
            <span class="token string">"--runtime-args"</span><span class="token punctuation">,</span>
            <span class="token string">"com.android.server.SystemServer"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        ZygoteConnection<span class="token punctuation">.</span>Arguments parsedArgs <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">int</span> pid<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parsedArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteConnection<span class="token punctuation">.</span>Arguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å°†ä¸Šé¢å‡†å¤‡çš„å‚æ•°ï¼ŒæŒ‰ç…§ZygoteConnectionçš„é£æ ¼è¿›è¡Œå°è£…</span>
            ZygoteConnection<span class="token punctuation">.</span><span class="token function">applyDebuggerSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ZygoteConnection<span class="token punctuation">.</span><span class="token function">applyInvokeWithSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* Request to fork the system server process */</span>
            pid <span class="token operator">=</span> Zygote<span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>                                <span class="token comment" spellcheck="true">// é€šè¿‡fork"åˆ†è£‚"å‡ºsystem_server</span>
                    parsedArgs<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>gids<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>debugFlags<span class="token punctuation">,</span>
                    null<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>permittedCapabilities<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>effectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/* For child process */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¤„ç†32_64å’Œ64_32çš„æƒ…å†µ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// forkæ—¶ä¼šcopy socketï¼Œsystem serveréœ€è¦ä¸»åŠ¨å…³é—­</span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// system serverè¿›ç¨‹å¤„ç†è‡ªå·±çš„å·¥ä½œ</span>
            <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="å¤„ç†è¯·æ±‚ä¿¡æ¯"><a href="#å¤„ç†è¯·æ±‚ä¿¡æ¯" class="headerlink" title="å¤„ç†è¯·æ±‚ä¿¡æ¯"></a>å¤„ç†è¯·æ±‚ä¿¡æ¯</h3><p>åˆ›å»ºå‡ºSystemServerè¿›ç¨‹åï¼Œzygoteè¿›ç¨‹è°ƒç”¨ZygoteServerä¸­çš„å‡½æ•°runSelectLoopï¼Œå¤„ç†server socketæ”¶åˆ°çš„å‘½ä»¤ã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Runs the zygote process's select loop. Accepts new connections as
     * they happen, and reads commands from connections one spawn-request's
     * worth at a time.
     */</span>
    Runnable <span class="token function">runSelectLoop</span><span class="token punctuation">(</span>String abiList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ArrayList<span class="token operator">&lt;</span>FileDescriptor<span class="token operator">></span> fds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>FileDescriptor<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ArrayList<span class="token operator">&lt;</span>ZygoteConnection<span class="token operator">></span> peers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ZygoteConnection<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// é¦–å…ˆå°†server socketåŠ å…¥åˆ°fds</span>
        fds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mServerSocket<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¯æ¬¡å¾ªç¯ï¼Œéƒ½é‡æ–°åˆ›å»ºéœ€è¦ç›‘å¬çš„pollFds</span>
            StructPollfd<span class="token punctuation">[</span><span class="token punctuation">]</span> pollFds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">[</span>fds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pollFds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…³æ³¨äº‹ä»¶åˆ°æ¥</span>
                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> POLLIN<span class="token punctuation">;</span>                
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç­‰å¾…äº‹ä»¶åˆ°æ¥</span>
                Os<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollFds<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"poll failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// æ³¨æ„è¿™é‡Œæ˜¯å€’åºçš„ï¼Œå³ä¼˜å…ˆå¤„ç†å·²å»ºç«‹é“¾æ¥çš„ä¿¡æ¯ï¼Œåå¤„ç†æ–°å»ºé“¾æ¥çš„è¯·æ±‚</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> pollFds<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// server socketæœ€å…ˆåŠ å…¥fdsï¼Œ å› æ­¤è¿™é‡Œæ˜¯server socketæ”¶åˆ°æ•°æ®</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ”¶åˆ°æ–°çš„å»ºç«‹é€šä¿¡çš„è¯·æ±‚ï¼Œå»ºç«‹é€šä¿¡è¿æ¥</span>
                    ZygoteConnection newPeer <span class="token operator">=</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åŠ å…¥åˆ°peerså’Œfds, å³ä¸‹ä¸€æ¬¡ä¹Ÿå¼€å§‹ç›‘å¬</span>
                    peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">.</span><span class="token function">getFileDesciptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//å…¶å®ƒé€šä¿¡è¿æ¥æ”¶åˆ°æ•°æ®</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ä»ä¸Šé¢ä»£ç å¯çŸ¥ï¼Œåˆå§‹æ—¶fdsä¸­ä»…æœ‰server socketï¼Œå› æ­¤å½“æœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œå°†æ‰§è¡Œiç­‰äº0çš„åˆ†æ”¯ã€‚æ­¤æ—¶ï¼Œæ˜¾ç„¶æ˜¯éœ€è¦åˆ›å»ºæ–°çš„é€šä¿¡è¿æ¥ï¼Œå› æ­¤acceptCommandPeerå°†è¢«è°ƒç”¨ã€‚</p>
<p>æˆ‘ä»¬çœ‹çœ‹acceptCommandPeerå‡½æ•°ï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Waits for and accepts a single command connection. Throws
     * RuntimeException on failure.
     */</span>
    <span class="token keyword">private</span> ZygoteConnection <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>String abiList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// socketç¼–ç¨‹ä¸­ï¼Œaccept()è°ƒç”¨ä¸»è¦ç”¨åœ¨åŸºäºè¿æ¥çš„å¥—æ¥å­—ç±»å‹ï¼Œæ¯”å¦‚SOCK_STREAMå’ŒSOCK_SEQPACKET</span>
            <span class="token comment" spellcheck="true">// å®ƒæå–å‡ºæ‰€ç›‘å¬å¥—æ¥å­—çš„ç­‰å¾…è¿æ¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å¥—æ¥å­—ï¼Œå¹¶è¿”å›æŒ‡å‘è¯¥å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦</span>
            <span class="token comment" spellcheck="true">// æ–°å»ºç«‹çš„å¥—æ¥å­—ä¸åœ¨ç›‘å¬çŠ¶æ€ï¼ŒåŸæ¥æ‰€ç›‘å¬çš„å¥—æ¥å­—çš„çŠ¶æ€ä¹Ÿä¸å—accept()è°ƒç”¨çš„å½±å“</span>
            <span class="token keyword">return</span> <span class="token function">createNewConnection</span><span class="token punctuation">(</span>mServerSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"IOException during accept()"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> ZygoteConnection <span class="token function">createNewConnection</span><span class="token punctuation">(</span>LocalSocket socket<span class="token punctuation">,</span> String abiList<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteConnection</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ä»ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºacceptCommandPeerè°ƒç”¨äº†server socketçš„accpetå‡½æ•°ã€‚äºæ˜¯å½“æ–°çš„è¿æ¥å»ºç«‹æ—¶ï¼Œzygoteå°†ä¼šåˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„socketä¸å…¶é€šä¿¡ï¼Œå¹¶å°†è¯¥socketåŠ å…¥åˆ°fdsä¸­ã€‚å› æ­¤ï¼Œä¸€æ—¦é€šä¿¡è¿æ¥å»ºç«‹åï¼Œfdsä¸­å°†ä¼šåŒ…å«æœ‰å¤šä¸ªsocketã€‚</p>
<p>å½“pollç›‘å¬åˆ°è¿™ä¸€ç»„socketsä¸Šæœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œå°±ä¼šä»é˜»å¡ä¸­æ¢å¤ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸ªsocketæ”¶åˆ°äº†æ•°æ®ã€‚</p>
<p>åœ¨runSelectLoopä¸­é‡‡ç”¨å€’åºçš„æ–¹å¼è½®è¯¢ã€‚ç”±äºserver socketç¬¬ä¸€ä¸ªè¢«åŠ å…¥åˆ°fdsï¼Œå› æ­¤æœ€åè½®è¯¢åˆ°çš„socketæ‰éœ€è¦å¤„ç†æ–°å»ºè¿æ¥çš„æ“ä½œï¼›å…¶å®ƒsocketæ”¶åˆ°æ•°æ®æ—¶ï¼Œä»…éœ€è¦è°ƒç”¨zygoteConnectionçš„runonceå‡½æ•°æ‰§è¡Œæ•°æ®å¯¹åº”çš„æ“ä½œã€‚è‹¥ä¸€ä¸ªè¿æ¥å¤„ç†å®Œæ‰€æœ‰å¯¹åº”æ¶ˆæ¯åï¼Œè¯¥è¿æ¥å¯¹åº”çš„socketå’Œè¿æ¥ç­‰å°†è¢«ç§»é™¤ã€‚</p>
<h1 id="å®Œç»“"><a href="#å®Œç»“" class="headerlink" title="å®Œç»“"></a>å®Œç»“</h1><p><center><strong><font color="#87CEFA" size="4">Zygoteå¯åŠ¨æµç¨‹åˆ°æ­¤ç»“æŸï¼ŒZygoteè¿›ç¨‹å…±åšäº†å¦‚ä¸‹å‡ ä»¶äº‹</font></strong></center><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 1. åˆ›å»ºAppRuntimeå¹¶è°ƒç”¨å…¶startæ–¹æ³•ï¼Œå¯åŠ¨Zygoteè¿›ç¨‹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 2. åˆ›å»ºJavaVMå¹¶ä¸ºJavaVMæ³¨å†ŒJNI.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 3. é€šè¿‡JNIè°ƒç”¨ZygoteInitçš„mainå‡½æ•°è¿›å…¥Zygoteçš„Javaæ¡†æ¶å±‚ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 4. é€šè¿‡registerZygoteSocketå‡½æ•°åˆ›å»ºæœåŠ¡ç«¯Socketï¼Œé¢„åŠ è½½ç±»å’Œèµ„æºï¼Œå¹¶é€šè¿‡runSelectLoopå‡½æ•°ç­‰å¾…å¦‚ActivityManagerServiceç­‰çš„è¯·æ±‚ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 5. å¯åŠ¨SystemServerè¿›ç¨‹ã€‚</p>
<h1 id="å‚è€ƒBlog"><a href="#å‚è€ƒBlog" class="headerlink" title="å‚è€ƒBlog"></a>å‚è€ƒBlog</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01. <a href="https://blog.csdn.net/tfygg/article/details/52086621" target="_blank" rel="noopener">https://blog.csdn.net/tfygg/article/details/52086621</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 02. <a href="https://www.jianshu.com/p/cbc6b84aee08" target="_blank" rel="noopener">https://www.jianshu.com/p/cbc6b84aee08</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 03. <a href="https://www.jianshu.com/p/ab9b83a77af6" target="_blank" rel="noopener">https://www.jianshu.com/p/ab9b83a77af6</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>å¾®ä¿¡é‡Œç‚¹â€œå‘ç°â€->â€œæ‰«ä¸€æ‰«â€äºŒç»´ç ä¾¿å¯æŸ¥çœ‹åˆ†äº«ã€‚</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;è½¬è½½è¯·æ³¨æ˜:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2018/12/10/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-zygote/" class="b-link-green">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2018/12/18/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-systemserver/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/ç³»ç»Ÿå¯åŠ¨-02.jpg" class="responsive-img" alt="æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver">
                        
                        <span class="card-title">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€Android å¯åŠ¨é˜¶æ®µç³»åˆ—ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ï¿½</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2018-12-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="post-category" target="_blank">
                                    ç³»ç»Ÿå¯åŠ¨
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/å¯åŠ¨é˜¶æ®µ/" target="_blank">
                        <span class="chip bg-color">å¯åŠ¨é˜¶æ®µ</span>
                    </a>
                    
                    <a href="/tags/SystemServer/" target="_blank">
                        <span class="chip bg-color">SystemServer</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/12/01/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-init/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/ç³»ç»Ÿå¯åŠ¨-02.jpg" class="responsive-img" alt="æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init">
                        
                        <span class="card-title">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœâ€œAndroid å¯åŠ¨é˜¶æ®µâ€ç³»åˆ—æ–‡ç« âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ âœ </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-12-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="post-category" target="_blank">
                                    ç³»ç»Ÿå¯åŠ¨
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/å¯åŠ¨é˜¶æ®µ/" target="_blank">
                        <span class="chip bg-color">å¯åŠ¨é˜¶æ®µ</span>
                    </a>
                    
                    <a href="/tags/init/" target="_blank">
                        <span class="chip bg-color">init</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: Thinking in Android<br />'
            + 'ä½œè€…: Marco<br />'
            + 'é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    

</main>


<footer class="page-footer bg-color-foot-marco">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQè”ç³»æˆ‘: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


<!--
    <a href="https://blog.csdn.net/pepsimaxin" class="tooltipped" data-tooltip="è®¿é—®æˆ‘çš„CSDN" data-position="top" data-delay="50">
        <i class="fa fa-chain-broken"></i>
    </a>
-->


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<!--<div class="progress-bar"></div>-->

<!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;æ£€ç´¢åšæ–‡</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„æŠ€æœ¯å…³é”®å­—" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<!--<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>-->


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>