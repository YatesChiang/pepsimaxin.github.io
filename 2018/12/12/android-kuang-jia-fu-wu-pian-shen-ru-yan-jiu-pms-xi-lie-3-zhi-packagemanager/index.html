<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Framework 核心服务之 PMS 钻研 ( 3 ) - PackageManager, Hexo">
    <meta name="description" content="PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&amp;nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Package">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Framework 核心服务之 PMS 钻研 ( 3 ) - PackageManager | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/四大组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/启动阶段/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/通信机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>通信</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>拓展</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术细节/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/四大组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/启动阶段/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/通信机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                通信
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                拓展
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        <li>
            <a href="/categories/技术细节/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('http://poobjb5p7.bkt.clouddn.com/PMS%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Framework 核心服务之 PMS 钻研 ( 3 ) - PackageManager
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/PackageManager/" target="_blank">
                                <span class="chip bg-color">PackageManager</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                框架服务
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2018-12-12
                </div>

                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><strong><center><font color="#3A5FCD" size="4">PackageManagerService 系列文章如下（基于 Android 9.0 源码）</font><center></center></center></strong><br></p>
<table>
<thead>
<tr>
<th style="text-align:center">&nbsp;</th>
<th style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（1）- 启动流程</font></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（2）- 构造函数</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（3）- PackageManager</font></a></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（4）- PackageInstaller</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（5）- APK 安装流程（1）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（6）- APK 安装流程（2）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（7）- PackageParser</font></a></td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong><font color="#3A5FCD" size="4">修订日志</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1、博文格式，文章排版等优化；</font></p>
<hr>
<h1 id="一、开篇"><a href="#一、开篇" class="headerlink" title="一、开篇"></a>一、开篇</h1><h2 id="1-1-核心源码"><a href="#1-1-核心源码" class="headerlink" title="1.1 核心源码"></a>1.1 核心源码</h2><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">Context.java</font></td>
<td>frameworks/base/core/java/android/content/Context.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ContextImpl.java</font></td>
<td>frameworks/base/core/java/android/app/ContextImpl.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ActivityThread.java</font></td>
<td>frameworks/base/core/java/android/app/ActivityThread.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageManager.java</font></td>
<td>frameworks/base/core/java/android/content/pm/PackageManager.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ApplicationPackageManager.java</font></td>
<td>frameworks/base/core/java/android/app/ApplicationPackageManager.java</td>
</tr>
</tbody>
</table>
<p><br></p>
<h1 id="二、PackageManager"><a href="#二、PackageManager" class="headerlink" title="二、PackageManager"></a>二、PackageManager</h1><h2 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h2><p>PackageManager 是一个抽象类：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Class for retrieving various kinds of information related to the application
 * packages that are currently installed on the device.
 *
 * You can find this class through {@link Context#getPackageManager}.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span>
</code></pre>
<p>注释可以看出：PackageManager 这个类是检测当前已经安装在当前设备上的应用程序包的信息。你可以调用 Context 类的 getPackageManager() 方法来获取 PackageManager。</p>
<h2 id="2-2-安装-APK"><a href="#2-2-安装-APK" class="headerlink" title="2.2 安装 APK"></a>2.2 安装 APK</h2><p>PackageManager 是一个实际上管理应用程序安装、卸载和升级的 API。当我们安装 APK 文件时，PackageManager 会解析 APK 包文件和显示确认信息。当我们点击 OK 按钮后，PackageManager 会调用一个叫 “InstallPackage” 的方法，这个方法有 4 个参数，也就是 uri、installFlags、observer、installPackagename。PackageManager 会启动一个叫 “package” 的 servcie 服务，现在所有模糊的东西会发生在这个 service 中。<br><br></p>
<center><img src="https://upload-images.jianshu.io/upload_images/3517194-f195e3a3c47103fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5713484-0a2df5e912885229.png"></center>

<h2 id="2-3-实现功能"><a href="#2-3-实现功能" class="headerlink" title="2.3 实现功能"></a>2.3 实现功能</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;1、安装、卸载应用<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;2、查询 permission 相关信息<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;3、查询 Application 相关信息(application、activity、receiver、service、provider 及相应属性等)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;4、查询已安装应用<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;5、增加、删除 permission<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;6、清除用户数据、缓存、代码等</p>
<h2 id="2-4-抽象方法"><a href="#2-4-抽象方法" class="headerlink" title="2.4 抽象方法"></a>2.4 抽象方法</h2><h3 id="2-4-1-getPackageInfo"><a href="#2-4-1-getPackageInfo" class="headerlink" title="2.4.1 getPackageInfo"></a>2.4.1 getPackageInfo</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve overall information about an application package that is
     * installed on the system.
     *
     * @param packageName The full name (i.e. com.google.apps.contacts) of the
     *            desired package.
     * @param flags Additional option flags to modify the data returned.
     * @return A PackageInfo object containing information about the package. If
     *         flag {@code MATCH_UNINSTALLED_PACKAGES} is set and if the package
     *         is not found in the list of installed applications, the package
     *         information is retrieved from the list of uninstalled
     *         applications (which includes installed applications as well as
     *         applications with data directory i.e. applications which had been
     *         deleted with {@code DONT_DELETE_DATA} flag set).
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     * 
     * 通过包名获取该包名对应的应用程序的 PackageInfo 对象，
     * PackageInfo 类包含了从 AndroidManifest.xml 文件中收集的所有信息。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> PackageInfo <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">,</span> <span class="token annotation punctuation">@PackageInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-2-getApplicationInfo"><a href="#2-4-2-getApplicationInfo" class="headerlink" title="2.4.2 getApplicationInfo"></a>2.4.2 getApplicationInfo</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve all of the information we know about a particular
     * package/application.
     *
     * @param packageName The full name (i.e. com.google.apps.contacts) of an
     *            application.
     * @param flags Additional option flags to modify the data returned.
     * @return An {@link ApplicationInfo} containing information about the
     *         package. If flag {@code MATCH_UNINSTALLED_PACKAGES} is set and if
     *         the package is not found in the list of installed applications,
     *         the application information is retrieved from the list of
     *         uninstalled applications (which includes installed applications
     *         as well as applications with data directory i.e. applications
     *         which had been deleted with {@code DONT_DELETE_DATA} flag set).
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     *
     * 根据包名返回其对应的 ApplicationInfo 信息。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> ApplicationInfo <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApplicationInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-3-getActivityInfo"><a href="#2-4-3-getActivityInfo" class="headerlink" title="2.4.3 getActivityInfo"></a>2.4.3 getActivityInfo</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve all of the information we know about a particular activity
     * class.
     *
     * @param component The full component name (i.e.
     *            com.google.apps.contacts/com.google.apps.contacts.
     *            ContactsList) of an Activity class.
     * @param flags Additional option flags to modify the data returned.
     * @return An {@link ActivityInfo} containing information about the
     *         activity.
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     *
     * 检索出一个特定的 Activity 类的所有信息。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> ActivityInfo <span class="token function">getActivityInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-4-getReceiverInfo"><a href="#2-4-4-getReceiverInfo" class="headerlink" title="2.4.4 getReceiverInfo"></a>2.4.4 getReceiverInfo</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve all of the information we know about a particular receiver
     * class.
     *
     * @param component The full component name (i.e.
     *            com.google.apps.calendar/com.google.apps.calendar.
     *            CalendarAlarm) of a Receiver class.
     * @param flags Additional option flags to modify the data returned.
     * @return An {@link ActivityInfo} containing information about the
     *         receiver.
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     *
     * 检索出一个特定的 Receiver 类的所有信息(这里主要指 ActivityInfo)。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> ActivityInfo <span class="token function">getReceiverInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-5-getServiceInfo"><a href="#2-4-5-getServiceInfo" class="headerlink" title="2.4.5 getServiceInfo"></a>2.4.5 getServiceInfo</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve all of the information we know about a particular service class.
     *
     * @param component The full component name (i.e.
     *            com.google.apps.media/com.google.apps.media.
     *            BackgroundPlayback) of a Service class.
     * @param flags Additional option flags to modify the data returned.
     * @return A {@link ServiceInfo} object containing information about the
     *         service.
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     *
     * 检索出一个特定的 Service 类的所有信息(这里主要指 ServiceInfo)。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> ServiceInfo <span class="token function">getServiceInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-6-getProviderInfo"><a href="#2-4-6-getProviderInfo" class="headerlink" title="2.4.6 getProviderInfo"></a>2.4.6 getProviderInfo</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve all of the information we know about a particular content
     * provider class.
     *
     * @param component The full component name (i.e.
     *            com.google.providers.media/com.google.providers.media.
     *            MediaProvider) of a ContentProvider class.
     * @param flags Additional option flags to modify the data returned.
     * @return A {@link ProviderInfo} object containing information about the
     *         provider.
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     *
     * 检索出一个特定的 content provider 类的所有信息(这里主要指 ProviderInfo)。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> ProviderInfo <span class="token function">getProviderInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-7-getInstalledPackages"><a href="#2-4-7-getInstalledPackages" class="headerlink" title="2.4.7 getInstalledPackages"></a>2.4.7 getInstalledPackages</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Return a List of all packages that are installed for the current user.
     *
     * @param flags Additional option flags to modify the data returned.
     * @return A List of PackageInfo objects, one for each installed package,
     *         containing information about the package. In the unlikely case
     *         there are no installed packages, an empty list is returned. If
     *         flag {@code MATCH_UNINSTALLED_PACKAGES} is set, the package
     *         information is retrieved from the list of uninstalled
     *         applications (which includes installed applications as well as
     *         applications with data directory i.e. applications which had been
     *         deleted with {@code DONT_DELETE_DATA} flag set).
     *
     * 获取设备上安装的所有软件包。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> List<span class="token operator">&lt;</span>PackageInfo<span class="token operator">></span> <span class="token function">getInstalledPackages</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PackageInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-8-currentToCanonicalPackageNames"><a href="#2-4-8-currentToCanonicalPackageNames" class="headerlink" title="2.4.8 currentToCanonicalPackageNames"></a>2.4.8 currentToCanonicalPackageNames</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Map from the current package names in use on the device to whatever
     * the current canonical name of that package is.
     * @param names Array of current names to be mapped.
     * @return Returns an array of the same size as the original, containing
     * the canonical name for each package.
     *
     * 从设备上使用当前包名映射到该软件包名的当前规范名称，
     * 如果修改包名会用到，没有修改过包名一般不会用到。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">currentToCanonicalPackageNames</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-9-canonicalToCurrentPackageNames"><a href="#2-4-9-canonicalToCurrentPackageNames" class="headerlink" title="2.4.9 canonicalToCurrentPackageNames"></a>2.4.9 canonicalToCurrentPackageNames</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Map from a packages canonical name to the current name in use on the device.
     * @param names Array of new names to be mapped.
     * @return Returns an array of the same size as the original, containing
     * the current name for each package.
     *
     * 将软件包规范名称映射到设备上正在使用的当前名称，
     * 我们发现：canonicalToCurrentPackageNames() 和 currentToCanonicalPackageNames() 方法是相反的两个方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">canonicalToCurrentPackageNames</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-10-getPermissionInfo"><a href="#2-4-10-getPermissionInfo" class="headerlink" title="2.4.10 getPermissionInfo"></a>2.4.10 getPermissionInfo</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve all of the information we know about a particular permission.
     *
     * @param name The fully qualified name (i.e. com.google.permission.LOGIN)
     *            of the permission you are interested in.
     * @param flags Additional option flags to modify the data returned.
     * @return Returns a {@link PermissionInfo} containing information about the
     *         permission.
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     *
     * 检测出我们想要知道的所有关于权限的信息。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> PermissionInfo <span class="token function">getPermissionInfo</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token annotation punctuation">@PermissionInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-11-queryPermissionsByGroup"><a href="#2-4-11-queryPermissionsByGroup" class="headerlink" title="2.4.11 queryPermissionsByGroup"></a>2.4.11 queryPermissionsByGroup</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Query for all of the permissions associated with a particular group.
     *
     * @param group The fully qualified name (i.e. com.google.permission.LOGIN)
     *            of the permission group you are interested in. Use null to
     *            find all of the permissions not associated with a group.
     * @param flags Additional option flags to modify the data returned.
     * @return Returns a list of {@link PermissionInfo} containing information
     *         about all of the permissions in the given group.
     * @throws NameNotFoundException if a package with the given name cannot be
     *             found on the system.
     *
     * 查询与特定组相关的所有权限。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> List<span class="token operator">&lt;</span>PermissionInfo<span class="token operator">></span> <span class="token function">queryPermissionsByGroup</span><span class="token punctuation">(</span>String group<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@PermissionInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<h3 id="2-4-12-getAllPermissionGroups"><a href="#2-4-12-getAllPermissionGroups" class="headerlink" title="2.4.12 getAllPermissionGroups"></a>2.4.12 getAllPermissionGroups</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Retrieve all of the known permission groups in the system.
     *
     * @param flags Additional option flags to modify the data returned.
     * @return Returns a list of {@link PermissionGroupInfo} containing
     *         information about all of the known permission groups.
     *
     * 检索出系统中所有已知的权限。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> List<span class="token operator">&lt;</span>PermissionGroupInfo<span class="token operator">></span> <span class="token function">getAllPermissionGroups</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@PermissionGroupInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>当然除了上面列举出来的方法以外，还有其他很多方法，我们不再一一列出来，如果后面分析遇到会再单独拿出来分析！</p>
<h2 id="2-5-安装方法"><a href="#2-5-安装方法" class="headerlink" title="2.5 安装方法"></a>2.5 安装方法</h2><p>接下来我们来看看 PackageManager 中关于安装的几个方法！</p>
<h3 id="2-5-1-InstallPackage"><a href="#2-5-1-InstallPackage" class="headerlink" title="2.5.1 InstallPackage"></a>2.5.1 InstallPackage</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * packageURI：表示安装的路径，可以是 "file:" 或者 "content:" 的 URI
     * observer：  一个回调的观察者，有了这个观察者，就可以在软件包安装完成后得到安装结果的通知。
     *             如果安装完成会调用这个观察者 IPackageInstallObserver 的 packageInstalled(String，int)方法，observer这个入参不能为空。
     * flags：     标志位参数
     * nstallerPackageName：正在进行安装的安装包包名
     */</span>

    <span class="token comment" spellcheck="true">/**
     * @deprecated replaced by {@link PackageInstaller}
     * @hide
     */</span>
    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">installPackage</span><span class="token punctuation">(</span>      <span class="token comment" spellcheck="true">// 弃用</span>
            Uri packageURI<span class="token punctuation">,</span>
            IPackageInstallObserver observer<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@InstallFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            String installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * @deprecated replaced by {@link PackageInstaller}
     * @hide
     */</span>
    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">installPackage</span><span class="token punctuation">(</span>      <span class="token comment" spellcheck="true">// 弃用</span>
            Uri packageURI<span class="token punctuation">,</span>
            PackageInstallObserver observer<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@InstallFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            String installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>从 8.1 开始，已经弃用了 installPackage 方法（9.0 的代码中已经去除 installPackage 代码了），而是使用 PackageInstaller 执行应用的安装、升级和删除操作。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Return interface that offers the ability to install, upgrade, and remove
     * applications on the device.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token annotation punctuation">@NonNull</span> PackageInstaller <span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="2-5-2-installExistingPackage"><a href="#2-5-2-installExistingPackage" class="headerlink" title="2.5.2 installExistingPackage"></a>2.5.2 installExistingPackage</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * If there is already an application with the given package name installed
     * on the system for other users, also install it for the calling user.
     * @hide
     */</span>
    <span class="token annotation punctuation">@SystemApi</span>   <span class="token comment" spellcheck="true">// 系统 API</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">installExistingPackage</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span>
</code></pre>
<p>通过注释可以看出这个方法的用途：如果系统上已经安装相同包名的应用程序，则重复重新安装。</p>
<h2 id="2-6-具体实现类"><a href="#2-6-具体实现类" class="headerlink" title="2.6 具体实现类"></a>2.6 具体实现类</h2><p>我们知道 PackageManager 是一个抽象类，它里面很重要的方法都是抽象的，所以在具体执行的时候，肯定是它的实现子类，那么我们就来看下它的具体实现类。</p>
<p>前面我们讲解 PackageManager 类的时候，官网推荐获取 PackageManager 对象的方法是 Context 的 Context#getPackageManager() 方法，那我们来看下：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/core/java/android/content/Context.java</span>

    <span class="token comment" spellcheck="true">/** Return PackageManager instance to find global package information. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> PackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>我们知道 Context 也是一个抽象类，而它的 getPackageManager() 也是抽象方法，但 Context 的具体实现类是 ContextImpl，那我们就去 ContextImpl 里面看下：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Common implementation of Context API, which provides the base
 * context object for Activity and other application components.
 * @hide
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextImpl</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> PackageManager mPackageManager<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> PackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 判断 mPackageManager 是否为空，如果为空，则说明是第一次调用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mPackageManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 调用 ActivityThread 的静态方法 getPackageManager() 获取一个 IPackageManager 对象</span>
        IPackageManager pm <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 如果获取的 IPackageManager 对象不为空，则构造一个 ApplicationPackageManager 对象，ApplicationPackageManager 是 PackageManager 的子类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Doesn't matter if we make more than one instance.</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>所以，在我们平时调用 Context 的 getPackageManager()方法后，其实返回的是 ApplicationPackageManager 这个类。</p>
<h1 id="三、ApplicationPackageManager"><a href="#三、ApplicationPackageManager" class="headerlink" title="三、ApplicationPackageManager"></a>三、ApplicationPackageManager</h1><h2 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1 简介"></a>3.1 简介</h2><p>我们先来看下 ApplicationPackageManager 类的源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** @hide */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span>
</code></pre>
<p>通过源码我们知道 ApplicationPackageManager 继承自PackageManager，而且 ApplicationPackageManager 类不是抽象的，所以 ApplicationPackageManager 必然实现了 PackageManager 的所有抽象方法。</p>
<h2 id="3-2-构造函数"><a href="#3-2-构造函数" class="headerlink" title="3.2 构造函数"></a>3.2 构造函数</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token function">ApplicationPackageManager</span><span class="token punctuation">(</span>ContextImpl context<span class="token punctuation">,</span> IPackageManager pm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        mPM <span class="token operator">=</span> pm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="3-3-InstallPackage"><a href="#3-3-InstallPackage" class="headerlink" title="3.3 InstallPackage"></a>3.3 InstallPackage</h2><p>在讲解 PackageManager 的时候，我们提到过安装 APK 会调用 InstallPackage 方法（Android 8.1，9.0 已弃用），我们看下在 ApplicationPackageManager 中的具体实现：</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">installPackage</span><span class="token punctuation">(</span>Uri packageURI<span class="token punctuation">,</span> IPackageInstallObserver observer<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                               String installerPackageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">installCommon</span><span class="token punctuation">(</span>packageURI<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LegacyPackageInstallObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                installerPackageName<span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="3-4-installCommon"><a href="#3-4-installCommon" class="headerlink" title="3.4 installCommon"></a>3.4 installCommon</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 源码来自：Android 8.1，9.0 已弃用</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installCommon</span><span class="token punctuation">(</span>Uri packageURI<span class="token punctuation">,</span>
            PackageInstallObserver observer<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String installerPackageName<span class="token punctuation">,</span>
            <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// scheme 判断，如果非 "file" 则抛异常，因为只支持 file 格式的 URI</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"file"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>packageURI<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Only file:// URIs are supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 获取相应的路径</span>
        <span class="token keyword">final</span> String originPath <span class="token operator">=</span> packageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 调用 installPackageAsUser 方法</span>
            mPM<span class="token punctuation">.</span><span class="token function">installPackageAsUser</span><span class="token punctuation">(</span>originPath<span class="token punctuation">,</span> observer<span class="token punctuation">.</span><span class="token function">getBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>可以发现，public abstract void installPackage() 方法其内部本质是调用的 IPackageManager 的 installPackageAsUser() 方法。</p>
<h1 id="四、IPackageManager"><a href="#四、IPackageManager" class="headerlink" title="四、IPackageManager"></a>四、IPackageManager</h1><h2 id="4-1-ActivityThread"><a href="#4-1-ActivityThread" class="headerlink" title="4.1 ActivityThread"></a>4.1 ActivityThread</h2><p>我们先来看看如下代码（上面没有分析）：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 调用 ActivityThread 的静态方法 getPackageManager() 获取一个 IPackageManager 对象</span>
IPackageManager pm <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>跟踪 getPackageManager()：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">volatile</span> IPackageManager sPackageManager<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> IPackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 判断 sPackageManager 是否为空，如果为空，则说明是的第一次调用，走第二步，如果不为空，则直接返回 sPackageManager</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sPackageManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> sPackageManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 能走到第二步，说明这是第一次调用，则调用 ServiceManager 的 getService(String) 方法获取一个 IBinder 对象</span>
        IBinder b <span class="token operator">=</span> ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 调用 IPackageManager.Stub.asInterface(IBinder) 获取一个 sPackageManager 对象</span>
        sPackageManager <span class="token operator">=</span> IPackageManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sPackageManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h1 id="五、IPM-PM-PMS-三者关联"><a href="#五、IPM-PM-PMS-三者关联" class="headerlink" title="五、IPM/PM/PMS 三者关联"></a>五、IPM/PM/PMS 三者关联</h1><h2 id="5-1-APM-PMS-IPM"><a href="#5-1-APM-PMS-IPM" class="headerlink" title="5.1 APM/PMS/IPM"></a>5.1 APM/PMS/IPM</h2><p>在上面分析 ContextImpl 的 getPackageManager() 方法里面，我们知道：</p>
<pre class=" language-java"><code class="language-java">        IPackageManager pm <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Doesn't matter if we make more than one instance.</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>而在 ActivityThread 的静态方法 getPackageManager() 里面：</p>
<pre class=" language-java"><code class="language-java">        sPackageManager <span class="token operator">=</span> IPackageManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sPackageManager<span class="token punctuation">;</span>
</code></pre>
<p>所以在 ApplicationPackageManager 里面的 mPM 其实就是 IPackageManager.Stub 内部类 Proxy 对象。</p>
<p>那对应的 IPackageManager.Stub 是什么？其实就是 <strong><font color="#FF0000">PackageManagerService.java</font></strong> 。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>
</code></pre>
<p>如下图所示：<br><br></p>
<center><img src="https://upload-images.jianshu.io/upload_images/3517194-74ae1197e39297b8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5713484-3e75d4de4b56b02f.png"></center>

<h2 id="5-2-小结"><a href="#5-2-小结" class="headerlink" title="5.2 小结"></a>5.2 小结</h2><p>结合上面的知识，再结合 PackageManager、ApplicationPackageManager 和 PackageManagerService 总结如下：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨ <strong>&nbsp;IPackageManager 负责通信</strong>：IPackageManager 接口类中定义了很多业务方法，但是由于安全等方面的考虑，Android 对外(即SDK)提供的仅仅是一个子集，该子集被封装在抽象类 PackageManager 中。客户端一般通过 Context 的 getPackageManager 函数返回一个类型为 PackageManager 的对象，该对象的实际类型是 PackageManager 的子类 ApplicationPackageManager 。ApplicationPackageManager 并没有直接参与 Binder 通信，而是通过 mPM 成员变量指向了一个 IPackageManager.Stub.Proxy 类型的对象。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨ &nbsp;<strong>AIDL中 的 Binder 服务端是 PackageManagerService</strong>，因为 PackageManagerService 继承自 IPackageManager.Stub 。由于 IPackageManager.Stub 类从 Binder 派生，所以 PackageManagerService 将作为服务端参与 Binder 通信。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨ &nbsp;<strong>AIDL中 的 Binder 客户端是 ApplicationPackageManager 中成员变量 mPM</strong>，因为mPM内部指向的是 IPackageManager.Stub.Proxy。</p>
<p>整体流程的 Binder 结构大致如下：<br><br></p>
<center><img src="https://upload-images.jianshu.io/upload_images/3517194-09c7bb4e6a03b74a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5713484-5bc8b7f82efd3cf3.png"></center>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01. <a href="https://www.jianshu.com/p/c56376916d5e" target="_blank" rel="noopener">https://www.jianshu.com/p/c56376916d5e</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 02. <a href="https://www.jianshu.com/p/a301291ca845" target="_blank" rel="noopener">https://www.jianshu.com/p/a301291ca845</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Hexo</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2018/12/12/android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-3-zhi-packagemanager/" class="b-link-green">Framework 核心服务之 PMS 钻研 ( 3 ) - PackageManager</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript。</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2018/12/18/android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-4-zhi-packageinstaller/">
                    <div class="card-image">
                        
                        <img src="http://poobjb5p7.bkt.clouddn.com/PMS%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg" class="responsive-img" alt="Framework 核心服务之 PMS 钻研 ( 4 )- PackageInstaller">
                        
                        <span class="card-title">Framework 核心服务之 PMS 钻研 ( 4 )- PackageInstaller</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Package</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2018-12-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务""
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageInstaller/" target="_blank">
                        <span class="chip bg-color">PackageInstaller</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/12/05/android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-2-zhi-gou-zao-han-shu/">
                    <div class="card-image">
                        
                        <img src="http://poobjb5p7.bkt.clouddn.com/PMS%EF%BC%88%E5%B0%81%E9%9D%A2%EF%BC%89.jpg" class="responsive-img" alt="Framework 核心服务之 PMS 钻研 ( 2 ) - 构造函数">
                        
                        <span class="card-title">Framework 核心服务之 PMS 钻研 ( 2 ) - 构造函数</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Package</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-12-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Hexo<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>