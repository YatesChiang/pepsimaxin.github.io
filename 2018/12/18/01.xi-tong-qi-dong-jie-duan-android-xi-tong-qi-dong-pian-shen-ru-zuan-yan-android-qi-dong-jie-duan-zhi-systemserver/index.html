<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="深入钻研 Android 启动阶段 之 systemserver, Thinking in Android">
    <meta name="description" content="
✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏“Android 启动阶段”系列文章✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>深入钻研 Android 启动阶段 之 systemserver | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color-header-marco nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/四大组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/系统启动/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/核心机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>机制</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>拓展</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术细节/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="检索博文"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/四大组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/系统启动/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/核心机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                机制
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                拓展
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        <li>
            <a href="/categories/技术细节/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/系统启动-02.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        深入钻研 Android 启动阶段 之 systemserver
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/启动阶段/" target="_blank">
                                <span class="chip bg-color">启动阶段</span>
                            </a>
                        
                            <a href="/tags/SystemServer/" target="_blank">
                                <span class="chip bg-color">SystemServer</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/系统启动/" class="post-category" target="_blank">
                                系统启动
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;发布日期 :&nbsp;
                    2018-12-18
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;文章字数 :&nbsp;
                        5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;阅读时长 :&nbsp;
                        23 分钟
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;阅读次数 :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<center>✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏</center><br><center><strong><font color="#1874CD"><font color="#3A5FCD" size="4">“Android 启动阶段”系列文章</font></font></strong></center><br><center>✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏</center>

<p><br></p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong><font color="#EE2C2C" size="3">【启动阶段】</font></strong></th>
<th style="text-align:center"><strong><font color="#0000FF" size="3">【相关文章】</font></strong></th>
<th style="text-align:center"><strong><font color="#9932CC" size="3">源码版本</font></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">init</font></strong></td>
<td style="text-align:center"><a href>深入钻研 Android 启动阶段 之 init</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">zygote</font></strong></td>
<td style="text-align:center"><a href>深入钻研 Android 启动阶段 之 zygote</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">systemserver</font></strong></td>
<td style="text-align:center"><a href>深入钻研 Android 启动阶段 之 systemserver</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#FF7F00" size="3">Launcher</font></strong></td>
<td style="text-align:center"><a href>深入钻研 Android 启动阶段 之 Launcher 启动及加载流程</a></td>
<td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td>
</tr>
</tbody>
</table>
<p><br></p>
<hr>
<h1 id="一、开篇"><a href="#一、开篇" class="headerlink" title="一、开篇"></a>一、开篇</h1><h2 id="1-1-核心源码"><a href="#1-1-核心源码" class="headerlink" title="1.1 核心源码"></a>1.1 核心源码</h2><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">com_android_internal_os_Zygote.cpp</font></td>
<td>frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">AndroidRuntime.cpp</font></td>
<td>frameworks/base/core/jni/AndroidRuntime.cpp</td>
</tr>
<tr>
<td><font color="#D15FEE">ZygoteInit.java</font></td>
<td>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</td>
</tr>
<tr>
<td><font color="#D15FEE">Zygote.java</font></td>
<td>frameworks/base/core/java/com/android/internal/os/Zygote.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ActivityThread.java</font></td>
<td>frameworks/base/core/java/android/app/ActivityThread.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ContextImpl.java.java</font></td>
<td>frameworks/base/core/java/android/app/ContextImpl.java</td>
</tr>
<tr>
<td><font color="#D15FEE">LoadedApk.java.java</font></td>
<td>frameworks/base/core/java/android/app/LoadedApk.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SystemServer.java</font></td>
<td>frameworks/base/services/java/com/android/server/SystemServer.java</td>
</tr>
<tr>
<td><font color="#D15FEE">RuntimeInit.java</font></td>
<td>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</td>
</tr>
</tbody>
</table>
<h2 id="1-2-概述"><a href="#1-2-概述" class="headerlink" title="1.2 概述"></a>1.2 概述</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemServer 是什么？它是 Android Java 的两大支柱之一。另外一个支柱是专门负责孵化 Java 进程的 Zygote（Zygote 进程是整个 Android 系统的根进程）。这两个支柱倒了任何一个，都会导致 Android Java 的崩溃（所有由 Zygote 孵化的 Java 进程都会被销毁，而 SystemServer 就是由 Zygote 孵化而来）。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;若 Android Java 真的崩溃了，那么 Linux 系统中的进程 init 会重新启动“两大支柱”以重建 Android Java。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemServer 和系统服务有着重要的关系，Android 系统中几乎所有的核心服务都是在这个进程中，如：ActivityManagerService、PackageManagerService 和 WindowManagerService 等。当我们的应用需要使用各种系统服务的时候，其实也是通过与 SystemServer 进程通讯获取各种服务对象的句柄，进而执行相应的操作。</p>
<h1 id="二、SystemServer"><a href="#二、SystemServer" class="headerlink" title="二、SystemServer"></a>二、SystemServer</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemServer 是由 Zygote 孵化而来的一个进程，通过 ps 命令，我们发现其进程名为：system_server。</p>
<h2 id="2-1-启动进程"><a href="#2-1-启动进程" class="headerlink" title="2.1 启动进程"></a>2.1 启动进程</h2><p>在分析 zygote 进程时，我们知道当 zygote 进程进入到 java 世界后，在 ZygoteInit.java 中，将调用 startSystemServer 函数启动 SystemServer 进程：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Runnable r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> socketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// fork 出 system_server</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* Request to fork the system server process */</span>
    pid <span class="token operator">=</span> Zygote<span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>
            parsedArgs<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>
            parsedArgs<span class="token punctuation">.</span>gids<span class="token punctuation">,</span>
            parsedArgs<span class="token punctuation">.</span>debugFlags<span class="token punctuation">,</span>
            null<span class="token punctuation">,</span>
            parsedArgs<span class="token punctuation">.</span>permittedCapabilities<span class="token punctuation">,</span>
            parsedArgs<span class="token punctuation">.</span>effectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>跟踪 forkSystemServer()：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> debugFlags<span class="token punctuation">,</span>
            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rlimits<span class="token punctuation">,</span> <span class="token keyword">long</span> permittedCapabilities<span class="token punctuation">,</span> <span class="token keyword">long</span> effectiveCapabilities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        VM_HOOKS<span class="token punctuation">.</span><span class="token function">preFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Resets nice priority for zygote process.</span>
        <span class="token function">resetNicePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">nativeForkSystemServer</span><span class="token punctuation">(</span>
                  uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> debugFlags<span class="token punctuation">,</span> rlimits<span class="token punctuation">,</span> permittedCapabilities<span class="token punctuation">,</span> effectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Enable tracing as soon as we enter the system_server.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Trace<span class="token punctuation">.</span><span class="token function">setTracingEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> debugFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        VM_HOOKS<span class="token punctuation">.</span><span class="token function">postForkCommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>容易看出，该函数通过调用 native 方法，完成实际的创建操作。该 Native 方法定义于 frameworks/base/core/jni/com_android_internal_os_Zygote.cpp 中。 我们来看看对应的 native 函数。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> jint <span class="token function">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="token punctuation">(</span>
            JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass<span class="token punctuation">,</span> uid_t uid<span class="token punctuation">,</span> gid_t gid<span class="token punctuation">,</span> jintArray gids<span class="token punctuation">,</span>
            jint debug_flags<span class="token punctuation">,</span> jobjectArray rlimits<span class="token punctuation">,</span> jlong permittedCapabilities<span class="token punctuation">,</span>
            jlong effectiveCapabilities<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// 进行实际的“分裂”工作</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">ForkAndSpecializeCommon</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                                        debug_flags<span class="token punctuation">,</span> rlimits<span class="token punctuation">,</span>
                                        permittedCapabilities<span class="token punctuation">,</span> effectiveCapabilities<span class="token punctuation">,</span>
                                        MOUNT_EXTERNAL_DEFAULT<span class="token punctuation">,</span> NULL<span class="token punctuation">,</span> NULL<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> NULL<span class="token punctuation">,</span>
                                        NULL<span class="token punctuation">,</span> NULL<span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// The zygote process checks whether the child process has died or not.</span>
        <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"System server process %d has been created"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 这里 SystemServer 进程已经创建出来，pid > 0 说明在父进程中</span>
        <span class="token comment" spellcheck="true">// 将子进程 SystemServer 的pid存在 zygote 进程的全局变量中</span>
        gSystemServerPid <span class="token operator">=</span> pid<span class="token punctuation">;</span>

        <span class="token keyword">int</span> status<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 小概率，SystemServer 进程刚创建，就 crash；此时需要重启 zygote</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"System server process %d has died. Restarting Zygote!"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">RuntimeAbort</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> __LINE__<span class="token punctuation">,</span> <span class="token string">"System server process has died. Restarting Zygote!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上述代码中，实际的“分裂”工作，由函数 <code>ForAndSpecializeCommon</code> 完成。</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Utility routine to fork zygote and specialize the child process.</span>
<span class="token keyword">static</span> pid_t <span class="token function">ForkAndSpecializeCommon</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> uid_t uid<span class="token punctuation">,</span> gid_t gid<span class="token punctuation">,</span> jintArray javaGids<span class="token punctuation">,</span>
                                     jint debug_flags<span class="token punctuation">,</span> jobjectArray javaRlimits<span class="token punctuation">,</span>
                                     jlong permittedCapabilities<span class="token punctuation">,</span> jlong effectiveCapabilities<span class="token punctuation">,</span>
                                     jint mount_external<span class="token punctuation">,</span>
                                     jstring java_se_info<span class="token punctuation">,</span> jstring java_se_name<span class="token punctuation">,</span>
                                     bool is_system_server<span class="token punctuation">,</span> jintArray fdsToClose<span class="token punctuation">,</span>
                                     jintArray fdsToIgnore<span class="token punctuation">,</span>
                                     jstring instructionSet<span class="token punctuation">,</span> jstring dataDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SetSignalHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// 注册信号监听器</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>从上面的代码可以看出，<code>ForkAndSpecializeCommon 最终是通过 fork 的方式，分裂出子进程</code>。</p>
<p>这里需要关注一下的是，在 zygote 进程 fork 之前，调用 SetSignalHandlers 函数注册了一个<code>子进程信号监听器</code>。</p>
<h2 id="2-2-SetSignalHandlers"><a href="#2-2-SetSignalHandlers" class="headerlink" title="2.2 SetSignalHandlers"></a>2.2 SetSignalHandlers</h2><p>我们看看 SetSignalHandlers 进行了哪些操作：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SetSignalHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    struct sigaction sig_chld <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    sig_chld<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SigChldHandler<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 该信号监听器关注子进程结束，对应的处理函数为SigChldHandler</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sig_chld<span class="token punctuation">,</span> NULL<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Error setting SIGCHLD handler: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    struct sigaction sig_hup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    sig_hup<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_IGN<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>SIGHUP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sig_hup<span class="token punctuation">,</span> NULL<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Error setting SIGHUP handler: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>从上面的代码可以看出，SetSignalHandlers 函数将注册一个信号处理器，来监听子进程的死亡。当子进程死亡后，利用 SigChldHandler 进行操作。需要注意的是，zygote 的信号监听器，关注的是 zygote 所有的子进程，而不只是 SystemServer 进程（每次创建一个新的进程时，zygote 都会注册对应的监听器）。</p>
<p>那就继续分析一下 SigChldHandler：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SigChldHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token comment" spellcheck="true">/*signal_number*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pid_t pid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 通过 status 判断子进程结束的原因，并打印相应的 log</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// If the just-crashed process is the system_server, bring down zygote</span>
        <span class="token comment" spellcheck="true">// so that it is restarted by init and system server will be restarted</span>
        <span class="token comment" spellcheck="true">// from there.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> gSystemServerPid<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// 上文已经介绍过，gSystemServerPid 中记录了 SystemServer 的 pid</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Exit zygote because system server (%d) has terminated"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">kill</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 如果结束的子进程为 SystemServer，Zygote 也将结束自己</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre>
<p>发现没？所有 zygote 的子进程中，zygote 只关心了 SystemServer 的死活。当其它子进程 crash 时，zygote 只打印了 log 信息。</p>
<h2 id="2-3-SystemServer-工作流程"><a href="#2-3-SystemServer-工作流程" class="headerlink" title="2.3 SystemServer 工作流程"></a>2.3 SystemServer 工作流程</h2><p>在分析 zygote 进程时，我们知道当 ZygoteInit 的 startSystemServer 通过 fork 创建出 SystemServer 进程后，SystemServer 进程调用 handleSystemServerProcess 函数，开始执行自己的工作。</p>
<h3 id="2-3-1-handleSystemServerProcess"><a href="#2-3-1-handleSystemServerProcess" class="headerlink" title="2.3.1 handleSystemServerProcess"></a>2.3.1 handleSystemServerProcess</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/* For child process */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// 关闭从 zygote 进程那里继承下来 server socket</span>
        <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>接下来，我们来看看 handleSystemServerProcess 函数的主要内容。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Finish remaining work for the newly forked system server process.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Runnable <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>ZygoteConnection<span class="token punctuation">.</span>Arguments parsedArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 加载 SystemServer 对应的文件</span>
        <span class="token keyword">final</span> String systemServerClasspath <span class="token operator">=</span> Os<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SYSTEMSERVERCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>systemServerClasspath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">performSystemServerDexOpt</span><span class="token punctuation">(</span>systemServerClasspath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>invokeWith <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 利用 systemServerClass 对应的路径构建对应的 ClassLoader</span>
            ClassLoader cl <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>systemServerClasspath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cl <span class="token operator">=</span> <span class="token function">createPathClassLoader</span><span class="token punctuation">(</span>systemServerClasspath<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>

                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">/*
             * Pass the remaining arguments to SystemServer.
             */</span>
            <span class="token comment" spellcheck="true">// 将剩余参数及 classLoader 递交给 ZygoteInit 的 zygoteInit 函数</span>
            <span class="token keyword">return</span> ZygoteInit<span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>remainingArgs<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/* should never reach here */</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>从上面的代码可以看出，接下来的流程进入到 ZygoteInit 的 zygoteInit 函数。zygoteInit 函数将根据 classLoader 和参数，完成不同进程所需要的初始化工作（SystemServer 进程与 zygote 的其它子进程均将使用 zygoteInit 函数）。</p>
<h3 id="2-3-2-zygoteInit"><a href="#2-3-2-zygoteInit" class="headerlink" title="2.3.2 zygoteInit"></a>2.3.2 zygoteInit</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Runnable <span class="token function">zygoteInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RuntimeInit<span class="token punctuation">.</span><span class="token function">redirectLogStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RuntimeInit<span class="token punctuation">.</span><span class="token function">commonInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 常规初始化操作，暂时不做深入</span>
        ZygoteInit<span class="token punctuation">.</span><span class="token function">nativeZygoteInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 为 Binder 通信做好准备</span>
        <span class="token keyword">return</span> RuntimeInit<span class="token punctuation">.</span><span class="token function">applicationInit</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="2-3-3-nativeZygoteInit"><a href="#2-3-3-nativeZygoteInit" class="headerlink" title="2.3.3 nativeZygoteInit"></a>2.3.3 nativeZygoteInit</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/core/jni/AndroidRuntime.cpp</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">com_android_internal_os_ZygoteInit_nativeZygoteInit</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    gCurRuntime<span class="token operator">-</span><span class="token operator">></span><span class="token function">onZygoteInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// gCurRuntime 指的是什么？</span>
<span class="token punctuation">}</span>
</code></pre>
<p>实际上在 zygote 进程启动时，在 app_main.cpp 的 main 函数中，创建出了 AppRuntime：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    AppRuntime <span class="token function">runtime</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">computeArgBlockSize</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>AppRuntime 定义如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">AppRuntime</span> <span class="token operator">:</span> <span class="token keyword">public</span> AndroidRuntime
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">AppRuntime</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> argBlockStart<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t argBlockLength<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">AndroidRuntime</span><span class="token punctuation">(</span>argBlockStart<span class="token punctuation">,</span> argBlockLength<span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token function">mClass</span><span class="token punctuation">(</span>NULL<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>看看 AppRuntime 的父类 AndroidRuntime：</p>
<pre class=" language-java"><code class="language-java">AndroidRuntime<span class="token operator">:</span><span class="token operator">:</span><span class="token function">AndroidRuntime</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> argBlockStart<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t argBlockLength<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">mExitWithoutCleanup</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mArgBlockStart</span><span class="token punctuation">(</span>argBlockStart<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mArgBlockLength</span><span class="token punctuation">(</span>argBlockLength<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    SkGraphics<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Pre-allocate enough space to hold a fair number of options.</span>
    mOptions<span class="token punctuation">.</span><span class="token function">setCapacity</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">assert</span><span class="token punctuation">(</span>gCurRuntime <span class="token operator">==</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// one per process</span>
    gCurRuntime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>从代码可以看出，AndroidRuntime 初始化时定义了 gCurRuntime。<code>gCurRuntime 指向对象自身，也就是说 gCurRuntime 指向的是 AppRuntime 对象</code>。</p>
<p>由于 SystemServer 进程由 zygote 进程 fork 出来，于是 system server 进程中也存在 gCurRuntime 对象，类型为 AppRuntime。</p>
<p>至此我们知道，Native 函数中 gCurRuntime-&gt;onZygoteInit 将调用 AppRuntime 中的 onZygoteInit。</p>
<pre class=" language-java"><code class="language-java">    virtual <span class="token keyword">void</span> <span class="token function">onZygoteInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> proc <span class="token operator">=</span> ProcessState<span class="token operator">:</span><span class="token operator">:</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"App process: starting thread pool.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proc<span class="token operator">-</span><span class="token operator">></span><span class="token function">startThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 启动一个线程，用于binder通信</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-4-applicationInit"><a href="#2-2-4-applicationInit" class="headerlink" title="2.2.4 applicationInit"></a>2.2.4 applicationInit</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">static</span> Runnable <span class="token function">applicationInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 设置一些进程退出的处理策略，可用堆栈上限等</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// Remaining arguments are passed to the start class's static main</span>
        <span class="token keyword">return</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>startClass<span class="token punctuation">,</span> args<span class="token punctuation">.</span>startArgs<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>跟踪 findStaticMain()：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> Runnable <span class="token function">findStaticMain</span><span class="token punctuation">(</span>String className<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>
            ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// className 为进行初始化工作的进程类名</span>
        <span class="token comment" spellcheck="true">// 在 SystemServer 初始化时，为 com.android.server.SystemServer</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cl<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 下面就是通过反射得到对应类的 main 方法</span>
            cl <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Missing class when invoking static main "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span>
                    ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 捕获 MethodAndArgsCaller 异常</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-3-main-函数"><a href="#2-3-main-函数" class="headerlink" title="2.3 main 函数"></a>2.3 main 函数</h2><p>接下来就进入了SystemServer.java 的 main 函数，其代码如下：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * The main entry point from zygote.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">SystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 创建并运行，简单粗暴！</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这里比较简单，只是 new 出一个 SystemServer 对象并执行其 run 方法。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"InitBeforeStartServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如何系统时钟早于1970年，则设置系统始终从1970年开始</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> EARLIEST_SUPPORTED_TIME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System clock is before 1970; setting to 1970."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// private static final long EARLIEST_SUPPORTED_TIME = 86400 * 1000;</span>
                SystemClock<span class="token punctuation">.</span><span class="token function">setCurrentTimeMillis</span><span class="token punctuation">(</span>EARLIEST_SUPPORTED_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"persist.sys.language"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置区域，语言等选项            </span>
                <span class="token keyword">final</span> String languageTag <span class="token operator">=</span> Locale<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLanguageTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.locale"</span><span class="token punctuation">,</span> languageTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.language"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.country"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.localevar"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment" spellcheck="true">// 清除 vm 内存增长上限，由于启动过程需要较多的虚拟机内存空间</span>
            VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearGrowthLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     

            <span class="token comment" spellcheck="true">// 设置堆栈利用率，GC 后会重新计算堆栈空间大小</span>
            VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTargetHeapUtilization</span><span class="token punctuation">(</span><span class="token number">0.8f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         

            <span class="token comment" spellcheck="true">// 针对部分设备依赖于运行时就产生指纹信息，因此需要在开机完成前已经定义</span>
            Build<span class="token punctuation">.</span><span class="token function">ensureFingerprintProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                             

            <span class="token comment" spellcheck="true">// 访问环境变量前，需要明确地指定用户</span>
            Environment<span class="token punctuation">.</span><span class="token function">setUserRequired</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                             

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment" spellcheck="true">// 加载动态库 libandroid_services.so</span>
            System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"android_servers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         

            <span class="token comment" spellcheck="true">// 检测上次关机过程是否失败，该方法可能不会返回</span>
            <span class="token function">performPendingShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                        

            <span class="token comment" spellcheck="true">// 在 SystemServer 进程中也需要创建 Context 对象，初始化系统上下文</span>
            <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                         

            <span class="token comment" spellcheck="true">// 通过 SystemServiceManager 的构造方法创建了一个新的 SystemServiceManager 对象</span>
            mSystemServiceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemServiceManager</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  

            <span class="token comment" spellcheck="true">// SystemServer 进程主要是用来构建系统各种 service 服务，而 SystemServiceManager 就是这些服务的管理对象            </span>
            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">setStartInfo</span><span class="token punctuation">(</span>mRuntimeRestart<span class="token punctuation">,</span> mRuntimeStartElapsedTime<span class="token punctuation">,</span> mRuntimeStartUptime<span class="token punctuation">)</span><span class="token punctuation">;</span>         

            <span class="token comment" spellcheck="true">// 将 SystemServiceManager 对象保存到 SystemServer 进程中的一个数据结构中            </span>
            LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>SystemServiceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>   

            <span class="token comment" spellcheck="true">// Prepare the thread pool for init tasks that can be parallelized</span>
            SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// InitBeforeStartServices</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Start services.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 主要用于启动系统 Boot 级服务        </span>
            <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// 主要用于启动系统核心的服务       </span>
            <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// 主要用于启动一些非紧要或者非需要及时启动的服务    </span>
            SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"******************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"************ Failure starting system services"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 启动looper，以处理到来的消息，一直循环执行</span>
        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                       
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>以上就是 SystemServer 的 run 函数整个流程，我们做个简化，如下：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Initialize the system context.</span>
            <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment" spellcheck="true">// 01.初始化系统上下文</span>

            <span class="token comment" spellcheck="true">// Create the system service manager.                                          </span>
            mSystemServiceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemServiceManager</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 02.创建系统服务管理</span>
            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">setRuntimeRestarted</span><span class="token punctuation">(</span>mRuntimeRestart<span class="token punctuation">)</span><span class="token punctuation">;</span>                  
            LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>SystemServiceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>   
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// InitBeforeStartServices</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Start services.                                                    // 03.启动系统各种服务</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment" spellcheck="true">// 启动引导服务</span>
            <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment" spellcheck="true">// 启动核心服务</span>
            <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                             <span class="token comment" spellcheck="true">// 启动其他服务</span>
            SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Loop forever.</span>
        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                        <span class="token comment" spellcheck="true">// 一直循环执行  </span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OK，接下来我们针对SystemServer所做的三部分工作，进行逐个分析！</p>
<h2 id="2-4-初始化上下文"><a href="#2-4-初始化上下文" class="headerlink" title="2.4 初始化上下文"></a>2.4 初始化上下文</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ActivityThread activityThread <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">systemMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystemContext <span class="token operator">=</span> activityThread<span class="token punctuation">.</span><span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSystemContext<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>DEFAULT_SYSTEM_THEME<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Context systemUiContext <span class="token operator">=</span> activityThread<span class="token punctuation">.</span><span class="token function">getSystemUiContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        systemUiContext<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>DEFAULT_SYSTEM_THEME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>跟踪 systemMain()：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> ActivityThread <span class="token function">systemMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityManager<span class="token punctuation">.</span><span class="token function">isHighEndGfx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ThreadedRenderer<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">// 对于低内存的设备，禁用硬件加速</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ThreadedRenderer<span class="token punctuation">.</span><span class="token function">enableForegroundTrimming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ActivityThread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>继续跟踪 attach()：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sCurrentActivityThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        mSystemThread <span class="token operator">=</span> system<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 设置 SystemServer 进程在 DDMS 中显示的名字为 "system_process" </span>
            android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span>DdmHandleAppName<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"system_process"</span><span class="token punctuation">,</span>                      
                    UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 如不设置，则显示"?"，无法调试该进程</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 首先通过 getSystemContext() 创建系统上下文，然后创建应用上下文</span>
                ContextImpl context <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 创建 Application</span>
                mInitialApplication <span class="token operator">=</span> context<span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 调用 Application的 onCreate()                </span>
                mInitialApplication<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unable to instantiate Application():"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// add dropbox logging to libcore</span>
        DropBox<span class="token punctuation">.</span><span class="token function">setReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DropBoxReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ViewRootImpl<span class="token punctuation">.</span>ConfigChangedCallback configChangedCallback
                <span class="token operator">=</span> <span class="token punctuation">(</span>Configuration globalConfig<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// We need to apply this change to the resources immediately, because upon returning</span>
                <span class="token comment" spellcheck="true">// the view hierarchy will be informed about it.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">applyConfigurationToResourcesLocked</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">,</span>
                        null <span class="token comment" spellcheck="true">/* compat */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>mInitialApplication<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// This actually changed the resources! Tell everyone about it.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingConfiguration <span class="token operator">==</span> null
                            <span class="token operator">||</span> mPendingConfiguration<span class="token punctuation">.</span><span class="token function">isOtherSeqNewer</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mPendingConfiguration <span class="token operator">=</span> globalConfig<span class="token punctuation">;</span>
                        <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>CONFIGURATION_CHANGED<span class="token punctuation">,</span> globalConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 添加回调</span>
        ViewRootImpl<span class="token punctuation">.</span><span class="token function">addConfigCallback</span><span class="token punctuation">(</span>configChangedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>                             
    <span class="token punctuation">}</span>
</code></pre>
<p>可以看出，attach 主要做了三件事：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（1）创建系统上下文：getSystemContext() –&gt; createSystemContext() –&gt; new ContextImpl()；<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（2）创建应用上下文：ContextImpl.createAppContext() –&gt; new ContextImpl()；<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（3）添加回调 configChangedCallback 到 ViewRootImpl。</p>
<h3 id="2-4-1-创建系统上下文"><a href="#2-4-1-创建系统上下文" class="headerlink" title="2.4.1 创建系统上下文"></a>2.4.1 创建系统上下文</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ContextImpl <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSystemContext <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSystemContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mSystemContext<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> ContextImpl <span class="token function">createSystemContext</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 这边 new 出来的 LoadedApk 将作为创建应用上下文的参数 packageInfo</span>
        LoadedApk packageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoadedApk</span><span class="token punctuation">(</span>mainThread<span class="token punctuation">)</span><span class="token punctuation">;</span>             
        <span class="token comment" spellcheck="true">// ContextImpl() 创建系统上下文         </span>
        ContextImpl context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>mResources<span class="token punctuation">.</span><span class="token function">updateConfiguration</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                context<span class="token punctuation">.</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="2-4-2-创建应用上下文"><a href="#2-4-2-创建应用上下文" class="headerlink" title="2.4.2 创建应用上下文"></a>2.4.2 创建应用上下文</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> ContextImpl <span class="token function">createAppContext</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">,</span> LoadedApk packageInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"packageInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ContextImpl()创建应用上下文</span>
        ContextImpl context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>                 
                null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>我们可以看出：new ContextImpl 时，系统上下文和应用上下文的参数是一样的，createAppContext() 中的参数 packageInfo，就是 createSystemContext() 中 new 的 LoadedApk。</p>
<p>创建完成之后，系统上下文赋值给了 ActivityThread 的成员变量 mSystemContext，而应用上下文只是作为函数中的局部变量临时使用。</p>
<h3 id="2-4-3-创建-Application"><a href="#2-4-3-创建-Application" class="headerlink" title="2.4.3 创建 Application"></a>2.4.3 创建 Application</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Application <span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceDefaultAppClass<span class="token punctuation">,</span> Instrumentation instrumentation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mApplication <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mApplication<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Application app <span class="token operator">=</span> null<span class="token punctuation">;</span>

        String appClass <span class="token operator">=</span> mApplicationInfo<span class="token punctuation">.</span>className<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceDefaultAppClass <span class="token operator">||</span> <span class="token punctuation">(</span>appClass <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// forceDefaultAppClass 为 true                               </span>
            appClass <span class="token operator">=</span> <span class="token string">"android.app.Application"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 此 LoadedApk 对象是 createSystemContext 时 new 的，mPackageName="android"</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                         
                <span class="token function">initializeJavaContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 又创建了一个局部应用上下文</span>
            ContextImpl appContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token comment" spellcheck="true">// 创建 Application </span>
            app <span class="token operator">=</span> mActivityThread<span class="token punctuation">.</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">newApplication</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> appClass<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 将前面创建的 app 添加到应用列表</span>
        mActivityThread<span class="token punctuation">.</span>mAllApplications<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> app<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-5-创建系统服务管理"><a href="#2-5-创建系统服务管理" class="headerlink" title="2.5 创建系统服务管理"></a>2.5 创建系统服务管理</h2><p>我们回顾下相关代码：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// Create the system service manager.</span>
    mSystemServiceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemServiceManager</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSystemServiceManager<span class="token punctuation">.</span><span class="token function">setRuntimeRestarted</span><span class="token punctuation">(</span>mRuntimeRestart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>SystemServiceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这一步比较简单，只是 new 了一个 SystemServiceManager，并将其添加到本地服务列表中。mSystemContext 为第一步中创建的系统上下文。本地服务列表是以类为 key 保存的一个列表，即列表中某种类型的对象最多只能有一个。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemServiceManager</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 系统服务列表，系统服务必须继承 SystemService</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>SystemService<span class="token operator">></span> mServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>SystemService<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 当前处于开机过程的哪个阶段，SystemService.PHASE_XXXXX</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> mCurrentPhase <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">SystemServiceManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 通过类名启动系统服务，可能会找不到类而抛异常</span>
    <span class="token keyword">public</span> SystemService <span class="token function">startService</span><span class="token punctuation">(</span>String className<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Class<span class="token operator">&lt;</span>SystemService<span class="token operator">></span> serviceClass<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            serviceClass <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>SystemService<span class="token operator">></span><span class="token punctuation">)</span>Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting "</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create service "</span> <span class="token operator">+</span> className
                    <span class="token operator">+</span> <span class="token string">": service class not found, usually indicates that the caller should "</span>
                    <span class="token operator">+</span> <span class="token string">"have called PackageManager.hasSystemFeature() to check whether the "</span>
                    <span class="token operator">+</span> <span class="token string">"feature is available on this device before trying to start the "</span>
                    <span class="token operator">+</span> <span class="token string">"services that implement it"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">startService</span><span class="token punctuation">(</span>serviceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 创建并启动系统服务，系统服务类必须继承 SystemService</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">SystemService</span><span class="token operator">></span> T <span class="token function">startService</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> serviceClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String name <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">,</span> <span class="token string">"StartService "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Create the service.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>serviceClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create "</span> <span class="token operator">+</span> name
                        <span class="token operator">+</span> <span class="token string">": service must extend "</span> <span class="token operator">+</span> SystemService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> T service<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                Constructor<span class="token operator">&lt;</span>T<span class="token operator">></span> constructor <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                service <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token function">startService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> service<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startService</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> SystemService service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 通知系统服务到了开机的哪个阶段，会遍历调用所有系统服务的 onBootPhase() 函数</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startBootPhase</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> phase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-6-启动系统各种服务"><a href="#2-6-启动系统各种服务" class="headerlink" title="2.6 启动系统各种服务"></a>2.6 启动系统各种服务</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">// 启动引导服务</span>
        <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// 启动核心服务</span>
        <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// 启动其他服务</span>
</code></pre>
<h3 id="2-6-1-启动引导服务"><a href="#2-6-1-启动引导服务" class="headerlink" title="2.6.1 启动引导服务"></a>2.6.1 启动引导服务</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 启动 Installer 服务，阻塞等待与 installd 建立 socket 通道</span>
        Installer installer <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>Installer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>DeviceIdentifiersPolicyService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 启动 ActivityManagerService</span>
        mActivityManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>
                ActivityManagerService<span class="token punctuation">.</span>Lifecycle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setSystemServiceManager</span><span class="token punctuation">(</span>mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setInstaller</span><span class="token punctuation">(</span>installer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 启动 PowerManagerService</span>
        mPowerManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>PowerManagerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// PowerManagerService 就绪，AMS 初始化电源管理</span>
        mActivityManagerService<span class="token punctuation">.</span><span class="token function">initPowerManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>RecoverySystemService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RescueParty<span class="token punctuation">.</span><span class="token function">noteBoot</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 启动 LightsService</span>
        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>LightsService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 启动 DisplayManagerService</span>
        mDisplayManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>DisplayManagerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// We need the default display before we can initialize the package manager.</span>
        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startBootPhase</span><span class="token punctuation">(</span>SystemService<span class="token punctuation">.</span>PHASE_WAIT_FOR_DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 当设备正在加密时，仅运行核心应用</span>
        String cryptState <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"vold.decrypt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ENCRYPTING_STATE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cryptState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Detected encryption in progress - only parsing core apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOnlyCore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ENCRYPTED_STATE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cryptState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Device encrypted - only parsing core apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOnlyCore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Start the package manager.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRuntimeRestart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MetricsLogger<span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"boot_package_manager_init_start"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 启动 PackageManagerService</span>
        mPackageManagerService <span class="token operator">=</span> PackageManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>
                mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_OFF<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFirstBoot <span class="token operator">=</span> mPackageManagerService<span class="token punctuation">.</span><span class="token function">isFirstBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPackageManager <span class="token operator">=</span> mSystemContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 将 UserManagerService 添加到服务列表，该服务是在 PackageManagerService 中初始化的        </span>
        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>UserManagerService<span class="token punctuation">.</span>LifeCycle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">// 初始化用来缓存包资源的属性缓存</span>
        AttributeCache<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Set up the Application instance for the system process and get started.</span>
        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        mSensorServiceStart <span class="token operator">=</span> SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            TimingsTraceLog traceLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimingsTraceLog</span><span class="token punctuation">(</span>
                    SYSTEM_SERVER_TIMING_ASYNC_TAG<span class="token punctuation">,</span> Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            traceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>START_SENSOR_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 启动传感器服务</span>
            <span class="token function">startSensorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            traceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> START_SENSOR_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>首先等待 installd 启动完成，然后启动一些相互依赖的关键服务。所创建的服务包括：ActivityManagerService，PowerManagerService，LightsService，DisplayManagerService，PackageManagerService，UserManagerService，sensor服务。</p>
<h3 id="2-6-2-启动核心服务"><a href="#2-6-2-启动核心服务" class="headerlink" title="2.6.2 启动核心服务"></a>2.6.2 启动核心服务</h3><p>接下来继续看下核心服务：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Starts some essential services that are not tangled up in the bootstrap process.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 启动 BatteryService，用于统计电池电量，需要 LightService</span>
        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>BatteryService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 启动 UsageStatsService，用于统计应用使用情况</span>
        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>UsageStatsService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setUsageStatsManager</span><span class="token punctuation">(</span>
                LocalServices<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>UsageStatsManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 启动 WebViewUpdateService</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageManager<span class="token punctuation">.</span><span class="token function">hasSystemFeature</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>FEATURE_WEBVIEW<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWebViewUpdateService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>WebViewUpdateService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Tracks cpu time spent in binder calls</span>
        BinderCallsStatsService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="2-6-3-启动其他服务"><a href="#2-6-3-启动其他服务" class="headerlink" title="2.6.3 启动其他服务"></a>2.6.3 启动其他服务</h3><p>代码很长（1200多行…），但是逻辑简单，主要是启动各种服务。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * Starts a miscellaneous grab bag of stuff that has yet to be refactored
     * and organized.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartSchedulingPolicyService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 调度策略</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"scheduling_policy"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SchedulingPolicyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartTelecomLoaderService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>TelecomLoaderService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartTelephonyRegistry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 提供电话注册、管理服务，可以获取电话的链接状态、信号强度等</span>
            telephonyRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelephonyRegistry</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"telephony.registry"</span><span class="token punctuation">,</span> telephonyRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartEntropyMixer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// 随机数相关，原名EntropyService</span>
            mEntropyMixer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntropyMixer</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mContentResolver <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// The AccountManager must come before the ContentService</span>
            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartAccountManagerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 提供所有账号、密码、认证管理等等的服务</span>
            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>ACCOUNT_SERVICE_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartContentService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ContentProvider服务，提供跨进程数据交换</span>
            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>CONTENT_SERVICE_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"InstallSystemProviders"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mActivityManagerService<span class="token punctuation">.</span><span class="token function">installSystemProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartVibratorService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// 振动器服务</span>
            vibrator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VibratorService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"vibrator"</span><span class="token punctuation">,</span> vibrator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"InitWatchdog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// 初始化 Watchdog</span>
            <span class="token keyword">final</span> Watchdog watchdog <span class="token operator">=</span> Watchdog<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            watchdog<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mActivityManagerService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartInputManagerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// 事件传递分发服务</span>
            inputManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartWindowManagerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 窗口管理服务</span>
            <span class="token comment" spellcheck="true">// WMS needs sensor service ready</span>
            ConcurrentUtils<span class="token punctuation">.</span><span class="token function">waitForFutureNoInterrupt</span><span class="token punctuation">(</span>mSensorServiceStart<span class="token punctuation">,</span> START_SENSOR_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mSensorServiceStart <span class="token operator">=</span> null<span class="token punctuation">;</span>
            wm <span class="token operator">=</span> WindowManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> inputManager<span class="token punctuation">,</span>
                    mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_LOW_LEVEL<span class="token punctuation">,</span>
                    <span class="token operator">!</span>mFirstBoot<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">,</span> wm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>INPUT_SERVICE<span class="token punctuation">,</span> inputManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        LockSettingsService               <span class="token comment" spellcheck="true">// 屏幕锁定服务，管理每个用户的相关锁屏信息</span>
        DeviceIdleController              <span class="token comment" spellcheck="true">// Doze模式的主要驱动，参考“深入Android 'M' Doze”</span>
        DevicePolicyManagerService        <span class="token comment" spellcheck="true">// 提供一些系统级别的设置及属性</span>
        StatusBarManagerService           <span class="token comment" spellcheck="true">// 状态栏管理服务</span>
        ClipboardService                  <span class="token comment" spellcheck="true">// 系统剪切板服务</span>
        NetworkManagementService          <span class="token comment" spellcheck="true">// 网络管理服务</span>
        TextServicesManagerService        <span class="token comment" spellcheck="true">// 文本服务，例如文本检查等</span>
        NetworkScoreService               <span class="token comment" spellcheck="true">// 网络评分服务</span>
        NetworkStatsService               <span class="token comment" spellcheck="true">// 网络状态服务</span>
        NetworkPolicyManagerService       <span class="token comment" spellcheck="true">// 网络策略服务</span>
        WifiP2pService                    <span class="token comment" spellcheck="true">// Wifi Direct服务</span>
        WifiService                       <span class="token comment" spellcheck="true">// Wifi服务</span>
        WifiScanningService               <span class="token comment" spellcheck="true">// Wifi扫描服务</span>
        RttService                        <span class="token comment" spellcheck="true">// Wifi相关</span>
        EthernetService                   <span class="token comment" spellcheck="true">// 以太网服务</span>
        ConnectivityService               <span class="token comment" spellcheck="true">// 网络连接管理服务</span>
        NsdService                        <span class="token comment" spellcheck="true">// 网络发现服务</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        NotificationManagerService        <span class="token comment" spellcheck="true">// 通知栏管理服务</span>
        DeviceStorageMonitorService       <span class="token comment" spellcheck="true">// 磁盘空间状态检测服务</span>
        LocationManagerService            <span class="token comment" spellcheck="true">// 位置服务，GPS、定位等</span>
        CountryDetectorService            <span class="token comment" spellcheck="true">// 检测用户国家</span>
        SearchManagerService              <span class="token comment" spellcheck="true">// 搜索管理服务</span>
        DropBoxManagerService             <span class="token comment" spellcheck="true">// 用于系统运行时日志的存储于管理</span>
        WallpaperManagerService           <span class="token comment" spellcheck="true">// 壁纸管理服务</span>
        AudioService                      <span class="token comment" spellcheck="true">// AudioFlinger的上层管理封装，主要是音量、音效、声道及铃声等的管理</span>
        DockObserver                      <span class="token comment" spellcheck="true">// 如果系统有个座子，当手机装上或拔出这个座子的话，就得靠他来管理了</span>
        WiredAccessoryManager             <span class="token comment" spellcheck="true">// 监视手机和底座上的耳机</span>
        UsbService                        <span class="token comment" spellcheck="true">// USB服务</span>
        SerialService                     <span class="token comment" spellcheck="true">// 串口服务</span>
        TwilightService                   <span class="token comment" spellcheck="true">// 指出用户当前所在位置是否为晚上，被UiModeManager等用来调整夜间模式。</span>
        BackupManagerService              <span class="token comment" spellcheck="true">// 备份服务</span>
        AppWidgetService                  <span class="token comment" spellcheck="true">// 提供Widget的管理和相关服务</span>
        VoiceInteractionManagerService    <span class="token comment" spellcheck="true">// 语音交互管理服务</span>
        DiskStatsService                  <span class="token comment" spellcheck="true">// 磁盘统计服务，供dumpsys使用</span>
        SamplingProfilerService           <span class="token comment" spellcheck="true">// 用于耗时统计等</span>
        NetworkTimeUpdateService          <span class="token comment" spellcheck="true">// 监视网络时间，当网络时间变化时更新本地时间。</span>
        CommonTimeManagementService       <span class="token comment" spellcheck="true">// 管理本地常见的时间服务的配置，在网络配置变化时重新配置本地服务。</span>
        CertBlacklister                   <span class="token comment" spellcheck="true">// 提供一种机制更新SSL certificate blacklist</span>
        DreamManagerService               <span class="token comment" spellcheck="true">// 屏幕保护</span>
        AssetAtlasService                 <span class="token comment" spellcheck="true">// 负责将预加载的bitmap组装成纹理贴图，生成的纹理贴图可以被用来跨进程使用，以减少内存。</span>
        PrintManagerService               <span class="token comment" spellcheck="true">// 打印服务</span>
        HdmiControlService                <span class="token comment" spellcheck="true">// HDMI控制服务</span>
        FingerprintService                <span class="token comment" spellcheck="true">// 指纹服务</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>以上代码仅按顺序列出启动的服务，有些服务根据条件，如是否是工厂模式，或系统属性配置，选择性启动，这里不考虑条件判断和异常处理。</p>
<p><strong><font color="#ff0000">自此，SystemServer 相关源码分析完毕。</font></strong></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2018/12/18/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-systemserver/" class="b-link-green">深入钻研 Android 启动阶段 之 systemserver</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2018/12/26/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-launcher/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/系统启动-02.jpg" class="responsive-img" alt="深入钻研 Android 启动阶段 之 Launcher 启动和加载">
                        
                        <span class="card-title">深入钻研 Android 启动阶段 之 Launcher 启动和加载</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏“Android 启动阶段”系列文章✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2018-12-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/系统启动/" class="post-category" target="_blank">
                                    系统启动
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Launcher/" target="_blank">
                        <span class="chip bg-color">Launcher</span>
                    </a>
                    
                    <a href="/tags/启动阶段/" target="_blank">
                        <span class="chip bg-color">启动阶段</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/12/10/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-zygote/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/系统启动-02.jpg" class="responsive-img" alt="深入钻研 Android 启动阶段 之 zygote">
                        
                        <span class="card-title">深入钻研 Android 启动阶段 之 zygote</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏“Android 启动阶段”系列文章✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ ✏ </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-12-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/系统启动/" class="post-category" target="_blank">
                                    系统启动
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/启动阶段/" target="_blank">
                        <span class="chip bg-color">启动阶段</span>
                    </a>
                    
                    <a href="/tags/zygote/" target="_blank">
                        <span class="chip bg-color">zygote</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Thinking in Android<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    

</main>


<footer class="page-footer bg-color-foot-marco">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


<!--
    <a href="https://blog.csdn.net/pepsimaxin" class="tooltipped" data-tooltip="访问我的CSDN" data-position="top" data-delay="50">
        <i class="fa fa-chain-broken"></i>
    </a>
-->


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<!--<div class="progress-bar"></div>-->

<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;检索博文</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的技术关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<!--<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>-->


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>