<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ LowMemoryKiller, Thinking in Android">
    <meta name="description" content="ä¸€ã€æ ¸å¿ƒæºç 


å…³é”®ç±»
è·¯å¾„




lmkd.c
system/core/lmkd/lmkd.c


lmkd.rc
system/core/lmkd/lmkd.rc


lowmemorykiller.c
kernel-3.18/dr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ LowMemoryKiller | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>é¦–é¡µ</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>ç›®å½•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>æ ‡ç­¾</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>ç»„ä»¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å¯åŠ¨é˜¶æ®µ/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>å¼€æœº</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>æ¡†æ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>æœºåˆ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>ä¼˜åŒ–</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>æ¨¡å¼</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>ç®—æ³•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>æ‹“å±•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>ä½œè€…</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="æ£€ç´¢åšæ–‡"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                é¦–é¡µ
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                ç›®å½•
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                æ ‡ç­¾
            </a>
        </li>
        
        <li>
            <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                ç»„ä»¶
            </a>
        </li>
        
        <li>
            <a href="/categories/å¯åŠ¨é˜¶æ®µ/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                å¼€æœº
            </a>
        </li>
        
        <li>
            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                æ¡†æ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                æœºåˆ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                ä¼˜åŒ–
            </a>
        </li>
        
        <li>
            <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                æ¨¡å¼
            </a>
        </li>
        
        <li>
            <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                ç®—æ³•
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                æ‹“å±•
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                ä½œè€…
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/LowMemoryKiller.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ LowMemoryKiller
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/LowMemoryKiller/" target="_blank">
                                <span class="chip bg-color">LowMemoryKiller</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/æ ¸å¿ƒæŠ€æœ¯/" class="post-category" target="_blank">
                                æ ¸å¿ƒæŠ€æœ¯
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;å‘å¸ƒæ—¥æœŸ :&nbsp;
                    2018-11-01
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;æ–‡ç« å­—æ•° :&nbsp;
                        6.4k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;é˜…è¯»æ—¶é•¿ :&nbsp;
                        28 åˆ†é’Ÿ
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;é˜…è¯»æ¬¡æ•° :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="ä¸€ã€æ ¸å¿ƒæºç "><a href="#ä¸€ã€æ ¸å¿ƒæºç " class="headerlink" title="ä¸€ã€æ ¸å¿ƒæºç "></a>ä¸€ã€æ ¸å¿ƒæºç </h1><table>
<thead>
<tr>
<th>å…³é”®ç±»</th>
<th>è·¯å¾„</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">lmkd.c</font></td>
<td>system/core/lmkd/lmkd.c</td>
</tr>
<tr>
<td><font color="#D15FEE">lmkd.rc</font></td>
<td>system/core/lmkd/lmkd.rc</td>
</tr>
<tr>
<td><font color="#D15FEE">lowmemorykiller.c</font></td>
<td>kernel-3.18/drivers/staging/android/lowmemorykiller.c</td>
</tr>
<tr>
<td><font color="#D15FEE">ProcessList.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/ProcessList.java</td>
</tr>
</tbody>
</table>
<h1 id="äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ"><a href="#äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ"></a>äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ</h1><p>Android ç³»ç»Ÿçš„è®¾è®¡ç†å¿µæ­£æ˜¯å¸Œæœ›åº”ç”¨è¿›ç¨‹èƒ½å°½é‡é•¿æ—¶é—´åœ°å­˜æ´»ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚åº”ç”¨é¦–æ¬¡æ‰“å¼€æ¯”è¾ƒæ…¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰è¿›ç¨‹åˆ›å»ºä»¥åŠ Application ç­‰ä¿¡æ¯çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥åº”ç”¨åœ¨å¯åŠ¨ä¹‹åï¼Œå³ä¾¿é€€åˆ°åå°å¹¶éç«‹åˆ»æ€æ­»ï¼Œè€Œæ˜¯å­˜æ´»ä¸€æ®µæ—¶é—´ï¼Œè¿™æ ·ä¸‹æ¬¡å†ä½¿ç”¨åˆ™ä¼šéå¸¸å¿«ã€‚å¯¹äº APP åŒæ ·å¸Œæœ›è‡ªèº«å°½å¯èƒ½å­˜æ´»æ›´é•¿çš„æ—¶é—´ï¼Œç°åœ¨å¾ˆå¤šå¼€å‘è€…éƒ½åœ¨æ¢ç´¢å„ç§ä¿æ´»é»‘ç§‘æŠ€ã€‚</p>
<p>ä½†ç‰©æå¿…åï¼Œå¦‚æœç³»ç»Ÿç»§ç»­æ”¾ä»»æ‰€æœ‰è¿›ç¨‹ä¸€ç›´å­˜æ´»ï¼Œé‚£ä¹ˆç³»ç»Ÿå¤„äºä½å†…å­˜çš„çŠ¶æ€ä¸‹ï¼Œæ€§èƒ½å°±ä¼šæœ‰æ‰€ä¸‹é™ï¼Œå†…å­˜ä¹Ÿä¼šå¾ˆå¿«æ¯ç«­è€Œäº¡ã€‚æ­¤æ—¶æˆ‘ä»¬å°±éœ€è¦è¿›ç¨‹å›æ”¶æœºåˆ¶å¸®åŠ©æˆ‘ä»¬åˆç†çš„æŠŠæ§é‚£äº›è¿›ç¨‹æ”¹å›æ”¶ï¼Œå“ªäº›ä¸è¯¥å›æ”¶ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç³»ç»Ÿå¦‚ä½•åˆ¤æ–­ï¼Ÿåˆ°åº•è¯¥å›æ”¶å“ªä¸ªè¿›ç¨‹ï¼Ÿ<strong><font color="#FF0000">å…¶å®ç³»ç»Ÿä¼šæ ¹æ®è¿›ç¨‹çš„ç»„ä»¶çŠ¶æ€æ¥å†³å®šæ¯ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆçº§å€¼ â€œADJâ€ï¼Œæ ¹æ®ä¸€å®šç­–ç•¥å…ˆæ€ä¼˜å…ˆçº§æœ€ä½çš„è¿›ç¨‹ï¼Œç„¶åé€æ­¥æ€ä¼˜å…ˆçº§æ›´ä½çš„è¿›ç¨‹ã€‚</font></strong>ä»¥æ­¤ç±»æ¨ï¼Œä»¥å›æ”¶é¢„æœŸçš„å¯ç”¨ç³»ç»Ÿèµ„æºï¼Œä»è€Œä¿è¯ç³»ç»Ÿæ­£å¸¸è¿è½¬ã€‚</p>
<p>æ¥ä¸‹æ¥å°±è¦å¼•å…¥æˆ‘ä»¬æœ¬æ–‡éœ€è¦è®¨è®ºçš„ä¸»è§’äº†ï¼š<strong><font color="#1874CD">LowMemoryKiller</font></strong>ï¼ˆç³»ç»Ÿç”¨äºåˆ¤å®šæ˜¯å¦éœ€è¦æ€è¿›ç¨‹å’Œæ€å“ªäº›è¿›ç¨‹çš„ä¸€ä¸ªæœºåˆ¶ï¼‰ã€‚</p>
<h1 id="ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§"></a>ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§</h1><p>ç³»ç»Ÿå†…è¿›ç¨‹ä¼˜å…ˆçº§åˆ† 5 çº§ï¼š</p>
<table>
<thead>
<tr>
<th>è¿›ç¨‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>å‰å°è¿›ç¨‹ï¼ˆForeground processï¼‰</td>
<td>ç”¨æˆ·å½“å‰æ“ä½œæ‰€å¿…éœ€çš„è¿›ç¨‹ã€‚</td>
</tr>
<tr>
<td>å¯è§è¿›ç¨‹ï¼ˆVisible processï¼‰</td>
<td>æ²¡æœ‰ä»»ä½•å‰å°ç»„ä»¶ã€ä½†ä»ä¼šå½±å“ç”¨æˆ·åœ¨å±å¹•ä¸Šæ‰€è§å†…å®¹çš„è¿›ç¨‹ã€‚<br>å¯è§è¿›ç¨‹è¢«è§†ä¸ºæ˜¯æå…¶é‡è¦çš„è¿›ç¨‹ï¼Œ<br>é™¤éä¸ºäº†ç»´æŒæ‰€æœ‰å‰å°è¿›ç¨‹åŒæ—¶è¿è¡Œè€Œå¿…é¡»ç»ˆæ­¢ï¼Œå¦åˆ™ç³»ç»Ÿä¸ä¼šç»ˆæ­¢è¿™äº›è¿›ç¨‹ã€‚</td>
</tr>
<tr>
<td>æœåŠ¡è¿›ç¨‹ï¼ˆService processï¼‰</td>
<td>æ­£åœ¨è¿è¡Œå·²ä½¿ç”¨ startService() æ–¹æ³•å¯åŠ¨çš„æœåŠ¡ä¸”ä¸å±äºä¸Šè¿°ä¸¤ä¸ªæ›´é«˜ç±»åˆ«è¿›ç¨‹çš„è¿›ç¨‹ã€‚<br>å°½ç®¡æœåŠ¡è¿›ç¨‹ä¸ç”¨æˆ·æ‰€è§å†…å®¹æ²¡æœ‰ç›´æ¥å…³è”ï¼Œä½†æ˜¯å®ƒä»¬é€šå¸¸åœ¨æ‰§è¡Œä¸€äº›ç”¨æˆ·å…³å¿ƒçš„æ“ä½œ<br>ï¼ˆä¾‹å¦‚ï¼Œåœ¨åå°æ’­æ”¾éŸ³ä¹æˆ–ä»ç½‘ç»œä¸‹è½½æ•°æ®ï¼‰ã€‚<br>å› æ­¤ï¼Œé™¤éå†…å­˜ä¸è¶³ä»¥ç»´æŒæ‰€æœ‰å‰å°è¿›ç¨‹å’Œå¯è§è¿›ç¨‹åŒæ—¶è¿è¡Œï¼Œå¦åˆ™ç³»ç»Ÿä¼šè®©æœåŠ¡è¿›ç¨‹ä¿æŒè¿è¡ŒçŠ¶æ€ã€‚</td>
</tr>
<tr>
<td>åå°è¿›ç¨‹ï¼ˆBackground processï¼‰</td>
<td>åŒ…å«ç›®å‰å¯¹ç”¨æˆ·ä¸å¯è§çš„ Activity çš„è¿›ç¨‹ï¼ˆå·²è°ƒç”¨ Activity çš„ onStop() æ–¹æ³•ï¼‰ã€‚<br>è¿™äº›è¿›ç¨‹å¯¹ç”¨æˆ·ä½“éªŒæ²¡æœ‰ç›´æ¥å½±å“ï¼Œç³»ç»Ÿå¯èƒ½éšæ—¶ç»ˆæ­¢å®ƒä»¬ã€‚</td>
</tr>
<tr>
<td>ç©ºè¿›ç¨‹ ï¼ˆEmpty processï¼‰</td>
<td>ä¸å«ä»»ä½•æ´»åŠ¨åº”ç”¨ç»„ä»¶çš„è¿›ç¨‹ã€‚<br>ä¿ç•™è¿™ç§è¿›ç¨‹çš„çš„å”¯ä¸€ç›®çš„æ˜¯ç”¨ä½œç¼“å­˜ï¼Œä»¥ç¼©çŸ­ä¸‹æ¬¡åœ¨å…¶ä¸­è¿è¡Œç»„ä»¶æ‰€éœ€çš„å¯åŠ¨æ—¶é—´ã€‚<br>ä¸ºä½¿æ€»ä½“ç³»ç»Ÿèµ„æºåœ¨è¿›ç¨‹ç¼“å­˜å’Œåº•å±‚å†…æ ¸ç¼“å­˜ä¹‹é—´ä¿æŒå¹³è¡¡ï¼Œç³»ç»Ÿå¾€å¾€ä¼šç»ˆæ­¢è¿™äº›è¿›ç¨‹ã€‚</td>
</tr>
</tbody>
</table>
<h1 id="å››ã€Framework-OOM-Adjustment"><a href="#å››ã€Framework-OOM-Adjustment" class="headerlink" title="å››ã€Framework OOM Adjustment"></a>å››ã€Framework OOM Adjustment</h1><h2 id="4-1-ADJ-çº§åˆ«"><a href="#4-1-ADJ-çº§åˆ«" class="headerlink" title="4.1 ADJ çº§åˆ«"></a>4.1 ADJ çº§åˆ«</h2><p>ADJ å®šä¹‰åœ¨ <strong><font color="#1874CD">ProcessList.java</font></strong> ä¸­ï¼š<strong><font color="#FF0000">oom_adj</font></strong> åˆ’åˆ†ä¸º16çº§ï¼Œå–å€¼èŒƒå›´[-1000~1001]</p>
<table>
<thead>
<tr>
<th>ADJ çº§åˆ«</th>
<th>å–å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>UNKNOWN_ADJ</td>
<td>1001</td>
<td>ä¸€èˆ¬æŒ‡å°†è¦ä¼šç¼“å­˜è¿›ç¨‹ï¼Œæ— æ³•è·å–ç¡®å®šå€¼</td>
</tr>
<tr>
<td>CACHED_APP_MAX_ADJ</td>
<td>906</td>
<td>ä¸å¯è§è¿›ç¨‹çš„ adj æœ€å¤§å€¼</td>
</tr>
<tr>
<td>CACHED_APP_MIN_ADJ</td>
<td>900</td>
<td>ä¸å¯è§è¿›ç¨‹çš„ adj æœ€å°å€¼</td>
</tr>
<tr>
<td>SERVICE_B_AD</td>
<td>800</td>
<td>B Listä¸­çš„Serviceï¼ˆè¾ƒè€çš„ã€ä½¿ç”¨å¯èƒ½æ€§æ›´å°ï¼‰</td>
</tr>
<tr>
<td>PREVIOUS_APP_ADJ</td>
<td>700</td>
<td>ä¸Šä¸€ä¸ªAppçš„è¿›ç¨‹(å¾€å¾€é€šè¿‡æŒ‰è¿”å›é”®)</td>
</tr>
<tr>
<td>HOME_APP_ADJ</td>
<td>600</td>
<td>Homeè¿›ç¨‹</td>
</tr>
<tr>
<td>SERVICE_ADJ</td>
<td>500</td>
<td>æœåŠ¡è¿›ç¨‹(Service process)</td>
</tr>
<tr>
<td>HEAVY_WEIGHT_APP_ADJ</td>
<td>400</td>
<td>åå°çš„é‡é‡çº§è¿›ç¨‹ï¼Œsystem/rootdir/init.rcæ–‡ä»¶ä¸­è®¾ç½®</td>
</tr>
<tr>
<td>BACKUP_APP_ADJ</td>
<td>300</td>
<td>å¤‡ä»½è¿›ç¨‹</td>
</tr>
<tr>
<td>PERCEPTIBLE_APP_ADJ</td>
<td>200</td>
<td>å¯æ„ŸçŸ¥è¿›ç¨‹ï¼Œæ¯”å¦‚åå°éŸ³ä¹æ’­æ”¾</td>
</tr>
<tr>
<td>VISIBLE_APP_ADJ</td>
<td>100</td>
<td>å¯è§è¿›ç¨‹(Visible process) </td>
</tr>
<tr>
<td>FOREGROUND_APP_ADJ</td>
<td>0</td>
<td>å‰å°è¿›ç¨‹ï¼ˆForeground processï¼‰</td>
</tr>
<tr>
<td>PERSISTENT_SERVICE_ADJ</td>
<td>-700</td>
<td>å…³è”ç€ç³»ç»Ÿæˆ– persistent è¿›ç¨‹</td>
</tr>
<tr>
<td>PERSISTENT_PROC_ADJ</td>
<td>-800</td>
<td>ç³»ç»Ÿ persistent è¿›ç¨‹ï¼Œæ¯”å¦‚ telephony</td>
</tr>
<tr>
<td>SYSTEM_ADJ</td>
<td>-900</td>
<td>ç³»ç»Ÿè¿›ç¨‹ï¼Œä»…æŒ‡system_serverè¿›ç¨‹</td>
</tr>
<tr>
<td>NATIVE_ADJ</td>
<td>-1000</td>
<td>nativeè¿›ç¨‹ï¼ˆä¸è¢«ç³»ç»Ÿç®¡ç†ï¼‰</td>
</tr>
</tbody>
</table>
<p>ä» Android 7.0 å¼€å§‹ï¼ŒADJ é‡‡ç”¨ 100ã€200ã€300 ç­‰æ•°å€¼ï¼›åœ¨è¿™ä¹‹å‰çš„ç‰ˆæœ¬ AD Jé‡‡ç”¨æ•°å­— 1ã€2ã€3 ç­‰æ•°å€¼ï¼Œè¿™æ ·çš„è°ƒæ•´æ˜¯ä¸ºäº†å¯ä»¥æ›´è¿›ä¸€æ­¥åœ°ç»†åŒ–è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œæ¯”å¦‚åœ¨ VISIBLE_APP_ADJ(100) ä¸ PERCEPTIBLE_APP_ADJ(200) ä¹‹é—´ï¼Œå¯ä»¥è®¾å®š ADJ = 101ã€ADJ = 102 çº§åˆ«çš„è¿›ç¨‹ã€‚</p>
<h2 id="4-2-STATE-çº§åˆ«"><a href="#4-2-STATE-çº§åˆ«" class="headerlink" title="4.2 STATE çº§åˆ«"></a>4.2 STATE çº§åˆ«</h2><p>STATE å®šä¹‰åœ¨ <strong><font color="#1874CD">ActivityManager.java</font></strong> ä¸­ï¼š<strong><font color="#FF0000">process_state</font></strong> åˆ’åˆ†20ç±»ï¼Œå–å€¼èŒƒå›´[-1~18]</p>
<table>
<thead>
<tr>
<th>STATE çº§åˆ«</th>
<th>å–å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>PROCESS_STATE_NONEXISTENT</td>
<td>18</td>
<td>ä¸å­˜åœ¨çš„è¿›ç¨‹</td>
</tr>
<tr>
<td>PROCESS_STATE_CACHED_EMPTY</td>
<td>17</td>
<td>è¿›ç¨‹å¤„äºcachedçŠ¶æ€ï¼Œä¸”ä¸ºç©ºè¿›ç¨‹</td>
</tr>
<tr>
<td>PROCESS_STATE_CACHED_ACTIVITY_CLIENT</td>
<td>16</td>
<td>è¿›ç¨‹å¤„äºcachedçŠ¶æ€ï¼Œä¸”ä¸ºå¦ä¸€ä¸ªcachedè¿›ç¨‹(å†…å«Activity)çš„clientè¿›ç¨‹ adj æœ€å¤§å€¼</td>
</tr>
<tr>
<td>PROCESS_STATE_CACHED_ACTIVITY</td>
<td>15</td>
<td>è¿›ç¨‹å¤„äºcachedçŠ¶æ€ï¼Œä¸”å†…å«Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_LAST_ACTIVITY</td>
<td>14</td>
<td>åå°è¿›ç¨‹ï¼Œä¸”æ‹¥æœ‰ä¸Šä¸€æ¬¡æ˜¾ç¤ºçš„Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_HOME</td>
<td>14</td>
<td>åå°è¿›ç¨‹ï¼Œä¸”æ‹¥æœ‰home Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_RECEIVER</td>
<td>12</td>
<td>åå°è¿›ç¨‹ï¼Œä¸”æ­£åœ¨è¿è¡Œreceiver</td>
</tr>
<tr>
<td>PROCESS_STATE_SERVICE</td>
<td>11</td>
<td>åå°è¿›ç¨‹ï¼Œä¸”æ­£åœ¨è¿è¡Œservice</td>
</tr>
<tr>
<td>PROCESS_STATE_HEAVY_WEIGHT</td>
<td>10</td>
<td>åå°è¿›ç¨‹ï¼Œä½†æ— æ³•æ‰§è¡Œrestoreï¼Œå› æ­¤å°½é‡é¿å…killè¯¥è¿›ç¨‹</td>
</tr>
<tr>
<td>PROCESS_STATE_BACKUP</td>
<td>9</td>
<td>åå°è¿›ç¨‹ï¼Œæ­£åœ¨è¿è¡Œbackup/restoreæ“ä½œ</td>
</tr>
<tr>
<td>PROCESS_STATE_TRANSIENT_BACKGROUND</td>
<td>8</td>
<td>è¿›ç¨‹çŸ­æš‚è¿›å…¥åå°ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä¿æŒè¿è¡Œ</td>
</tr>
<tr>
<td>PROCESS_STATE_IMPORTANT_BACKGROUND</td>
<td>7</td>
<td>å¯¹ç”¨æˆ·å¾ˆé‡è¦çš„è¿›ç¨‹ï¼Œç”¨æˆ·ä¸å¯æ„ŸçŸ¥å…¶å­˜åœ¨</td>
</tr>
<tr>
<td>PROCESS_STATE_IMPORTANT_FOREGROUND</td>
<td>6</td>
<td>å¯¹ç”¨æˆ·å¾ˆé‡è¦çš„è¿›ç¨‹ï¼Œç”¨æˆ·å¯æ„ŸçŸ¥å…¶å­˜åœ¨</td>
</tr>
<tr>
<td>PROCESS_STATE_TOP_SLEEPING</td>
<td>5</td>
<td>ä¸PROCESS_STATE_TOPä¸€æ ·ï¼Œä½†æ­¤æ—¶è®¾å¤‡æ­£å¤„äºä¼‘çœ çŠ¶æ€</td>
</tr>
<tr>
<td>PROCESS_STATE_FOREGROUND_SERVICE</td>
<td>4</td>
<td>æ‹¥æœ‰ç»™ä¸€ä¸ªå‰å°Service</td>
</tr>
<tr>
<td>PROCESS_STATE_BOUND_FOREGROUND_SERVICE</td>
<td>3</td>
<td>æ‹¥æœ‰ç»™ä¸€ä¸ªå‰å°Serviceï¼Œä¸”ç”±ç³»ç»Ÿç»‘å®š</td>
</tr>
<tr>
<td>PROCESS_STATE_TOP</td>
<td>2</td>
<td>æ‹¥æœ‰å½“å‰ç”¨æˆ·å¯è§çš„top Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_PERSISTENT_UI</td>
<td>1</td>
<td>persistentç³»ç»Ÿè¿›ç¨‹ï¼Œå¹¶æ­£åœ¨æ‰§è¡ŒUIæ“ä½œ</td>
</tr>
<tr>
<td>PROCESS_STATE_PERSISTENT</td>
<td>0</td>
<td>persistentç³»ç»Ÿè¿›ç¨‹</td>
</tr>
<tr>
<td>PROCESS_STATE_UNKNOWN</td>
<td>-1</td>
<td>ä¸å¯çŸ¥çš„è¿›ç¨‹</td>
</tr>
</tbody>
</table>
<h1 id="äº”ã€Read-The-Fucking-Code"><a href="#äº”ã€Read-The-Fucking-Code" class="headerlink" title="äº”ã€Read The Fucking Code"></a>äº”ã€Read The Fucking Code</h1><h2 id="5-1-lmkd"><a href="#5-1-lmkd" class="headerlink" title="5.1 lmkd"></a>5.1 lmkd</h2><p>é€šè¿‡å‰é¢çš„è¡¨æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼šProcessList ä¸­å®šä¹‰æœ‰è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œ<strong><font color="#FF0000">è¶Šé‡è¦çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§è¶Šä½</font></strong> ï¼Œå‰å° APP çš„ä¼˜å…ˆçº§ä¸º 0ï¼Œç³»ç»Ÿ APP çš„ä¼˜å…ˆçº§ä¸€èˆ¬éƒ½æ˜¯è´Ÿå€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹ç®¡ç†ä»¥åŠæ€è¿›ç¨‹éƒ½æ˜¯é’ˆå¯¹ä¸Šå±‚ APP æ¥è¯´çš„ã€‚</p>
<p><strong><font color="#FF0000">è¿›ç¨‹çš„ä¼˜å…ˆçº§è°ƒæ•´éƒ½åœ¨ ActivityManagerService é‡Œé¢</font></strong> ï¼ŒActivityManagerService æ ¹æ®è¿›ç¨‹ä¸­ç»„ä»¶çš„çŠ¶æ€å»ä¸æ–­çš„è®¡ç®—æ¯ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè®¡ç®—ä¹‹åä¼šåŠæ—¶æ›´æ–°åˆ°å¯¹åº”è¿›ç¨‹çš„æ–‡ä»¶èŠ‚ç‚¹ä¸­ï¼Œ<strong><font color="#FF0000">è€Œè¿™ä¸ªå¯¹æ–‡ä»¶èŠ‚ç‚¹çš„æ›´æ–°å¹¶ä¸æ˜¯ AMS å®Œæˆçš„ï¼Œè€Œæ˜¯ lmkd ï¼Œå®ƒä»¬ä¹‹é—´é€šè¿‡ socket é€šä¿¡</font></strong>ã€‚ </p>
<p>lmkd åœ¨æ‰‹æœºä¸­æ˜¯ä¸€ä¸ªå¸¸é©»è¿›ç¨‹ï¼Œç”¨æ¥å¤„ç†ä¸Šå±‚ ActivityManager åœ¨è¿›è¡Œ updateOomAdj ä¹‹åï¼Œé€šè¿‡ socket ä¸ lmkd è¿›è¡Œé€šä¿¡ï¼Œæ›´æ–°è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœå¿…è¦åˆ™æ€æ‰è¿›ç¨‹é‡Šæ”¾å†…å­˜ã€‚</p>
<p>lmkd æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™å¯åŠ¨çš„ï¼Œé€šè¿‡è§£æ init.rc æ–‡ä»¶æ¥å¯åŠ¨ lmkd å®ˆæŠ¤è¿›ç¨‹ã€‚åœ¨ lmkd ä¸­æœ‰å®šä¹‰ lmkd.rc:</p>
<pre class=" language-rc"><code class="language-rc">service lmkd /system/bin/lmkd
    class core
    group root readproc
    critical
    socket lmkd seqpacket 0660 system system
    writepid /dev/cpuset/system-background/tasks
</code></pre>
<p>lmkd ä¼šåˆ›å»ºåä¸º lmkd çš„ socketï¼ŒèŠ‚ç‚¹ä½äº/dev/socket/lmkdï¼Œè¯¥ socket ç”¨äºè·Ÿä¸Šå±‚ framework äº¤äº’ã€‚</p>
<p>ä¸Šå±‚ AMS è·Ÿ lmkd é€šä¿¡ä¸»è¦åˆ†ä¸ºä¸‰ç§ commandï¼Œæ¯ç§ command ä»£è¡¨ä¸€ç§æ•°æ®æ§åˆ¶æ–¹å¼ï¼Œåœ¨ ProcessList ä»¥åŠ lmkd ä¸­éƒ½æœ‰å®šä¹‰ï¼ŒProcessList æ–‡ä»¶ä¸­çš„å®šä¹‰å¿…é¡»è·Ÿ lmkd.c å®šä¹‰å®Œå…¨ä¸€è‡´ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// LMK_TARGET &lt;minfree> &lt;minkillprio> ... (up to 6 pairs)</span>
<span class="token comment" spellcheck="true">// LMK_PROCPRIO &lt;pid> &lt;uid> &lt;prio></span>
<span class="token comment" spellcheck="true">// LMK_PROCREMOVE &lt;pid></span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_TARGET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_PROCPRIO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_PROCREMOVE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * Supported LMKD commands
 */</span>
<span class="token keyword">enum</span> lmk_cmd <span class="token punctuation">{</span>
    LMK_TARGET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">/* Associate minfree with oom_adj_score */</span>
    LMK_PROCPRIO<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* Register a process and set its oom_adj_score */</span>
    LMK_PROCREMOVE<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">/* Unregister a process */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>ä¸Šè¿°3ä¸ªå‘½ä»¤çš„ä½¿ç”¨éƒ½é€šè¿‡ ProcessList.java ä¸­çš„å¦‚ä¸‹æ–¹æ³•:</p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>å‘½ä»¤</th>
<th>å¯¹åº”æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>LMK_TARGET</td>
<td>æ›´æ–° oom_adj</td>
<td>PorcessList.updateOomLevels()</td>
</tr>
<tr>
<td>LMK_PROCPRIO</td>
<td>è®¾ç½®è¿›ç¨‹ adj</td>
<td>PorcessList.setOomAdj()</td>
</tr>
<tr>
<td>LMK_PROCREMOVE</td>
<td>ç§»é™¤è¿›ç¨‹</td>
<td>PorcessList.remove()</td>
</tr>
</tbody>
</table>
<p>åœ¨å¼€å§‹åˆ†æ lmkd çš„å¤„ç†é€»è¾‘ä¹‹å‰ï¼Œlmkd.c ä¸­æœ‰å‡ ä¸ªé‡è¦çš„å˜é‡ä¸æ•°æ®ç»“æ„æå‰è¯´æ˜ä¸€ä¸‹ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true">// å†…å­˜çº§åˆ«é™é¢</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"</span>
<span class="token comment" spellcheck="true">// ä¸åŒçº§åˆ«å†…å­˜å¯¹åº”è¦æ€çš„çš„ä¼˜å…ˆçº§</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_ADJ_PATH "/sys/module/lowmemorykiller/parameters/adj"</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true">/* OOM score values used by both kernel and framework */</span>
<span class="token comment" spellcheck="true">// ä¼˜å…ˆçº§çš„æœ€å°å€¼</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OOM_SCORE_ADJ_MIN       (-1000)</span>

<span class="token comment" spellcheck="true">// ä¼˜å…ˆçº§çš„æœ€å¤§å€¼</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OOM_SCORE_ADJ_MAX       1000</span>

<span class="token comment" spellcheck="true">/* A threshold of minfree adjustment toward VMPRESS_LEVEL_CRITICAL (36MB) */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CACHED_THRESHOLD    (9216)</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_adj<span class="token punctuation">[</span>MAX_TARGETS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_minfree<span class="token punctuation">[</span>MAX_TARGETS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> CACHED_THRESHOLD <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_targets_size<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true">// åŒå‘é“¾è¡¨ç»“æ„ä½“</span>
<span class="token keyword">struct</span> adjslot_list <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> adjslot_list <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> adjslot_list <span class="token operator">*</span>prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// è¿›ç¨‹åœ¨ lmkd ä¸­çš„æ•°æ®ç»“æ„ä½“</span>
<span class="token keyword">struct</span> proc <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> adjslot_list asl<span class="token punctuation">;</span>
    <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
    uid_t uid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oomadj<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>pidhash_next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// å­˜æ”¾è¿›ç¨‹ proc çš„ hashtable ï¼Œindex æ˜¯é€šè¿‡ pid çš„è®¡ç®—å¾—å‡º</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PIDHASH_SZ 1024</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> proc <span class="token operator">*</span>pidhash<span class="token punctuation">[</span>PIDHASH_SZ<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// æ ¹æ® pid è®¡ç®— index çš„ hash ç®—æ³•</span>
<span class="token macro property">#<span class="token directive keyword">define</span> pid_hashfn(x) ((((x) >> 8) ^ (x)) &amp; (PIDHASH_SZ - 1))</span>

<span class="token comment" spellcheck="true">// è¿›ç¨‹ä¼˜å…ˆçº§åˆ°æ•°ç»„çš„ index ä¹‹é—´çš„è½¬æ¢</span>
<span class="token comment" spellcheck="true">// å› ä¸ºè¿›ç¨‹çš„ä¼˜å…ˆçº§å¯ä»¥æ˜¯è´Ÿå€¼ï¼Œä½†æ˜¯æ•°ç»„çš„ index ä¸èƒ½ä¸ºè´Ÿå€¼</span>
<span class="token comment" spellcheck="true">// ä¸è¿‡å› ä¸ºè¿™ä¸ªè½¬æ¢åªæ˜¯ç®€å•åŠ äº† 1000ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œåé¢çš„æè¿°ä¸­å°±è®¤ä¸ºæ˜¯ä¼˜å…ˆçº§ç›´æ¥åšäº† index</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ADJTOSLOT(adj) ((adj) + -OOM_SCORE_ADJ_MIN)</span>

<span class="token comment" spellcheck="true">// tableï¼Œç±»ä¼¼ hashtable ï¼Œä¸è¿‡è®¡ç®— index çš„æ–¹å¼ä¸æ˜¯ hash ï¼Œè€Œæ˜¯ oom_score_adj ç»è¿‡è½¬æ¢åç›´æ¥ä½œä¸º index</span>
<span class="token comment" spellcheck="true">// æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯åŒå‘å¾ªç¯é“¾è¡¨</span>
<span class="token comment" spellcheck="true">// è¿›ç¨‹çš„ä¼˜å…ˆçº§ä½œä¸ºæ•°ç»„çš„ index</span>
<span class="token comment" spellcheck="true">// å³ä»¥è¿›ç¨‹çš„ä¼˜å…ˆçº§ä¸º indexï¼Œä» -1000 åˆ° +1000 + 1 å¤§å°çš„æ•°ç»„ï¼Œæ ¹æ®ä¼˜å…ˆçº§ï¼ŒåŒä¼˜å…ˆçº§çš„è¿›ç¨‹ index ç›¸åŒ</span>
<span class="token comment" spellcheck="true">// æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ä¸Šçš„æ‰€æœ‰ proc çš„ä¼˜å…ˆçº§éƒ½ç›¸åŒ</span>
<span class="token comment" spellcheck="true">// è¿™æ ·æ ¹æ®ä¼˜å…ˆçº§æ€è¿›ç¨‹çš„æ—¶å€™å°±ä¼šéå¸¸æ–¹ä¾¿ï¼Œè¦æ€æŒ‡å®šä¼˜å…ˆçº§çš„è¿›ç¨‹å¯ä»¥æ ¹æ®ä¼˜å…ˆçº§è·å–åˆ°ä¸€ä¸ªè¿›ç¨‹é“¾è¡¨ï¼Œé€ä¸ªå»æ€</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> adjslot_list procadjslot_list<span class="token punctuation">[</span><span class="token function">ADJTOSLOT</span><span class="token punctuation">(</span>OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p><strong><font color="#FF0000">æ¥ä¸‹æ¥æˆ‘ä»¬æ­£å¼è®¨è®ºlmkdï¼</font></strong></p>
<h3 id="5-1-1-main"><a href="#5-1-1-main" class="headerlink" title="5.1.1 main()"></a>5.1.1 main()</h3><p>lmkd å¯åŠ¨åï¼Œæ¥ä¸‹é‡Œçš„æ“ä½œéƒ½åœ¨ /system/core/lmkd/lmkd.c æ–‡ä»¶ï¼Œé¦–å…ˆè¿›å…¥ main() æ–¹æ³•ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc __unused<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mlockall</span><span class="token punctuation">(</span>MCL_CURRENT <span class="token operator">|</span> MCL_FUTURE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"mlockall failed: errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è®¾ç½®æ­¤çº¿ç¨‹çš„è°ƒåº¦ç­–ç•¥ä¸º SCHED_FIFOï¼Œfirst-in-first-outï¼Œparam ä¸­ä¸»è¦è®¾ç½® sched_priority</span>
    <span class="token comment" spellcheck="true">// ç”±äº SCHED_FIFO æ˜¯ä¸€ç§å®æ—¶è°ƒåº¦ç­–ç•¥ï¼Œåœ¨è¿™ä¸ªç­–ç•¥ä¸‹ä¼˜å…ˆçº§ä»1(low) -> 99(high)</span>
    <span class="token comment" spellcheck="true">// å®æ—¶çº¿ç¨‹é€šå¸¸ä¼šæ¯”æ™®é€šçº¿ç¨‹æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§</span>
    <span class="token function">sched_setscheduler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// åˆå§‹åŒ– epoll åŠä¸ ActivityManager çš„ socket è¿æ¥ï¼Œç­‰å¾… cmd å’Œ data</span>
    <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// è¿›å…¥æ­»å¾ªç¯ epoll_wait ç­‰å¾…fdäº‹ä»¶</span>
        <span class="token function">mainloop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>

    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å‰é¢å·²ç»æåˆ°ï¼Œè¿™ä¸ªè¿›ç¨‹å­˜åœ¨çš„ä¸»è¦ä½œç”¨æ˜¯è·Ÿ AMS è¿›è¡Œé€šä¿¡ï¼Œæ›´æ–° oomAdj ï¼Œåœ¨å¿…è¦çš„æ—¶å€™æ€æ‰è¿›ç¨‹ã€‚æ‰€ä»¥åœ¨ main å‡½æ•°ä¸­ä¸»è¦å°±æ˜¯åˆ›å»ºäº† epoll ä»¥åŠåˆå§‹åŒ– socket å¹¶è¿æ¥ ActivityManager ï¼Œç„¶åé˜»å¡ç­‰å¾…ä¸Šå±‚ä¼ é€’ cmd ä»¥åŠ data è¿‡æ¥ã€‚</p>
<h4 id="5-1-1-1-init"><a href="#5-1-1-1-init" class="headerlink" title="5.1.1.1 init()"></a>5.1.1.1 init()</h4><p>æ¥çœ‹çœ‹ init çš„é€»è¾‘ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event epev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    page_k <span class="token operator">=</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>page_k <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        page_k <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>
    page_k <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// åˆ›å»º epoll ç›‘å¬æ–‡ä»¶å¥æŸ„</span>
    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span>MAX_EPOLL_EVENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>epollfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_create failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// è·å– lmkd çš„ socket fd</span>
    ctrl_lfd <span class="token operator">=</span> <span class="token function">android_get_control_socket</span><span class="token punctuation">(</span><span class="token string">"lmkd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl_lfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"get lmkd control socket failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ç›‘å¬ lmkd socket</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>ctrl_lfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"lmkd control socket listen failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    epev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ctrl_connect_handler é‡Œé¢å®Œæˆäº† soclet çš„ accpet ä»¥åŠ read æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œç›¸åº”çš„å¤„ç†</span>
    <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ä¸‹é¢ä¼šé‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>
    ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_connect_handler<span class="token punctuation">;</span>
    epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> ctrl_sock<span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl for lmkd control socket failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    maxevents<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è¯¥è·¯å¾„æ˜¯å¦å…·æœ‰å¯å†™çš„æƒé™</span>
    <span class="token comment" spellcheck="true">/*
     * è¿™é‡Œï¼Œé€šè¿‡æ£€éªŒ /sys/module/lowmemorykiller/parameters/minfree èŠ‚ç‚¹æ˜¯å¦å…·æœ‰å¯å†™æƒé™
     *
     *     #define INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"
     * 
     * æ¥åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ kernel æ¥å£æ¥ç®¡ç† lmk äº‹ä»¶ã€‚
     * é»˜è®¤è¯¥èŠ‚ç‚¹æ˜¯å…·æœ‰ç³»ç»Ÿå¯å†™çš„æƒé™ï¼Œä¹Ÿå°±æ„å‘³ç€ use_inkernel_interface = 1
     */</span>
    has_inkernel_module <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>INKERNEL_MINFREE_PATH<span class="token punctuation">,</span> W_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    use_inkernel_interface <span class="token operator">=</span> has_inkernel_module<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è¿™ä¸ª use_inkernel_interface æ˜¯æ ¹æ®æ˜¯å¦æœ‰ â€œ/sys/module/lowmemorykiller/parameters/minfreeâ€ çš„å†™æƒé™æ¥åˆ¤æ–­çš„ï¼Œæ²¡æœ‰çš„æƒ…å†µä¸‹å°±ä½¿ç”¨ kernel ç©ºé—´çš„é€»è¾‘</span>
    <span class="token comment" spellcheck="true">// ç›®å‰é‡åˆ°çš„éƒ½æ˜¯ use_inkernel_interface</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Using in-kernel low memory killer interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_LOW<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_MEDIUM<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_CRITICAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Kernel does not support memory pressure events or in-kernel low memory killer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// åŒå‘é“¾è¡¨åˆå§‹åŒ–</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token function">ADJTOSLOT</span><span class="token punctuation">(</span>OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="5-1-1-2-mainloop"><a href="#5-1-1-2-mainloop" class="headerlink" title="5.1.1.2 mainloop()"></a>5.1.1.2 mainloop()</h4><p>æ¥çœ‹çœ‹ mainloop çš„é€»è¾‘ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// è¿›å…¥æ­»å¾ªç¯ï¼Œç„¶åè°ƒç”¨ epoll_wait é˜»å¡ç­‰å¾…äº‹ä»¶çš„åˆ°æ¥</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mainloop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           
        <span class="token keyword">struct</span> epoll_event events<span class="token punctuation">[</span>maxevents<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nevents<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> timespec t1<span class="token punctuation">,</span> t2<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> elapsed_ms<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// ç­‰å¾… epoll_wait ä¸Šçš„äº‹ä»¶</span>
        nevents <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> maxevents<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nevents <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_wait failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nevents<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLERR<span class="token punctuation">)</span>
                <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"EPOLLERR on event #%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å½“äº‹ä»¶åˆ°æ¥ï¼Œåˆ™è°ƒç”¨ ctrl_connect_handler æ–¹æ³•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">)</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸»å¾ªç¯è°ƒç”¨ epoll_wait()ï¼Œç­‰å¾… epollfd ä¸Šçš„äº‹ä»¶ï¼Œå½“æ¥æ”¶åˆ°ä¸­æ–­æˆ–è€…ä¸å­˜åœ¨äº‹ä»¶ï¼Œåˆ™æ‰§è¡Œ continue æ“ä½œã€‚å½“äº‹ä»¶åˆ°æ¥ï¼Œåˆ™è°ƒç”¨çš„ ctrl_connect_handler æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ç”± init() è¿‡ç¨‹ä¸­è®¾å®šçš„æ–¹æ³•ï¼ˆæˆ‘ä»¬ä¹‹å‰åœ¨åˆ†æ init() çš„æ—¶å€™æè¿‡ï¼‰ã€‚</p>
<h3 id="5-1-2-ctrl-connect-handler"><a href="#5-1-2-ctrl-connect-handler" class="headerlink" title="5.1.2 ctrl_connect_handler()"></a>5.1.2 ctrl_connect_handler()</h3><p>æˆ‘ä»¬ä¹‹å‰åœ¨ init() ä¸­çœ‹åˆ°ä»¥ä¸‹ä»£ç ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// ctrl_connect_handler é‡Œé¢å®Œæˆäº† soclet çš„ accpet ä»¥åŠ read æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œç›¸åº”çš„å¤„ç†</span>
ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_connect_handler<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨ ctrl_connect_handler()</span>
epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>å®ƒæ˜¯ä¸“é—¨å¤„ç† Socket ä¼ é€’è¿‡æ¥çš„æ•°æ®çš„ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_connect_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> data __unused<span class="token punctuation">,</span> uint32_t events __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event epev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> free_dscock_idx <span class="token operator">=</span> <span class="token function">get_free_dsock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>free_dscock_idx <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_DATA_CONN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ctrl_data_close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        free_dscock_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"lmkd control socket accept failed; errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"lmkd data connection established"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* use data to store data connection idx */</span>
    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>data <span class="token operator">=</span> free_dscock_idx<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è°ƒç”¨ ctrl_data_handler()</span>
    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_data_handler<span class="token punctuation">;</span>

    epev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
    epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl for data connection socket failed; errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ctrl_data_close</span><span class="token punctuation">(</span>free_dscock_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    maxevents<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-1-3-ctrl-data-handler"><a href="#5-1-3-ctrl-data-handler" class="headerlink" title="5.1.3 ctrl_data_handler"></a>5.1.3 ctrl_data_handler</h3><p>å½“äº‹ä»¶è§¦å‘ï¼Œåˆ™è°ƒç”¨ ctrl_data_handler()ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_data_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">,</span> uint32_t events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ctrl_command_handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-1-4-ctrl-command-handler"><a href="#5-1-4-ctrl-command-handler" class="headerlink" title="5.1.4 ctrl_command_handler"></a>5.1.4 ctrl_command_handler</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_command_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> dsock_idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LMKD_CTRL_PACKET packet<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> lmk_cmd cmd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nargs<span class="token punctuation">;</span>
    <span class="token keyword">int</span> targets<span class="token punctuation">;</span>

    len <span class="token operator">=</span> <span class="token function">ctrl_data_read</span><span class="token punctuation">(</span>dsock_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>packet<span class="token punctuation">,</span> CTRL_PACKET_MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Wrong control socket read length len=%d"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cmd <span class="token operator">=</span> <span class="token function">lmkd_pack_get_cmd</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nargs <span class="token operator">=</span> len <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å°†ç½‘ç»œå­—èŠ‚é¡ºåºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚é¡ºåº</span>
    cmd <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>ibuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ä¸€å…±ä¸‰ç§command</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// æ›´æ–°å†…å­˜çº§åˆ«ä»¥åŠå¯¹åº”çº§åˆ«çš„è¿›ç¨‹ adj</span>
    <span class="token keyword">case</span> LMK_TARGET<span class="token operator">:</span>
        targets <span class="token operator">=</span> nargs <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">&amp;</span> <span class="token number">0x1</span> <span class="token operator">||</span> targets <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>
        <span class="token function">cmd_target</span><span class="token punctuation">(</span>targets<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// æ ¹æ® pid æ›´æ–° adj</span>
    <span class="token keyword">case</span> LMK_PROCPRIO<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ä¸‹é¢ä¼šé‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>
        <span class="token function">cmd_procprio</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// æ ¹æ® pid ç§»é™¤ proc</span>
    <span class="token keyword">case</span> LMK_PROCREMOVE<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>
        <span class="token function">cmd_procremove</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Received unknown command code %d"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>

wronglen<span class="token operator">:</span>
    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Wrong control socket read length cmd=%d len=%d"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>è·å– framework ä¼ é€’è¿‡æ¥çš„ buf æ•°æ®åï¼Œæ ¹æ® 3 ç§ä¸åŒçš„å‘½ä»¤ï¼Œè¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹ï¼š</p>
<h2 id="5-2-ä¸‰ç§æ•°æ®"><a href="#5-2-ä¸‰ç§æ•°æ®" class="headerlink" title="5.2 ä¸‰ç§æ•°æ®"></a>5.2 ä¸‰ç§æ•°æ®</h2><h3 id="5-2-1-LMK-TARGET"><a href="#5-2-1-LMK-TARGET" class="headerlink" title="5.2.1 LMK_TARGET"></a>5.2.1 LMK_TARGET</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä¸Šå±‚é€»è¾‘æ˜¯åœ¨ ProcessList.updateOomLevels ä¸­</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateOomLevels</span><span class="token punctuation">(</span><span class="token keyword">int</span> displayWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> displayHeight<span class="token punctuation">,</span> <span class="token keyword">boolean</span> write<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mOomAdj<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_TARGET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mOomAdj<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mOomMinFree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token operator">/</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>mOomAdj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"sys.sysctl.extra_free_kbytes"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>reserve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd å¤„ç†é€»è¾‘</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_ADJ_PATH "/sys/module/lowmemorykiller/parameters/adj"</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_target</span><span class="token punctuation">(</span><span class="token keyword">int</span> ntargets<span class="token punctuation">,</span> LMKD_CTRL_PACKET packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> lmk_target target<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ntargets <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è¿™ä¸ª for å¾ªç¯å¯¹åº”ä¸Šé¢çš„ for å¾ªç¯ï¼Œå°†æ•°æ®è¯»å‡ºè£…è¿›æ•°ç»„ä¸­</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ntargets<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lmkd_pack_get_target</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>minfree<span class="token punctuation">;</span>
        lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>oom_adj_score<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    lowmem_targets_size <span class="token operator">=</span> ntargets<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ä½¿ç”¨ kernel ç©ºé—´çš„å¤„ç†é€»è¾‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>has_inkernel_module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> minfreestr<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> killpriostr<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        minfreestr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        killpriostr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// å–å‡ºä¸¤ä¸ªæ•°ç»„ä¸­çš„æ•°æ®ï¼Œä»¥","åˆ†éš”ï¼Œåˆ†åˆ«æ‹¼æ¥æˆ string</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lowmem_targets_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">strlcat</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strlcat</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> use_inkernel_interface <span class="token operator">?</span> lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strlcat</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> use_inkernel_interface <span class="token operator">?</span> lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strlcat</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// å°†ç”Ÿæˆå¥½çš„ string å†™å…¥åˆ°æ–‡ä»¶èŠ‚ç‚¹ minfree ä»¥åŠ adj</span>
        <span class="token function">writefilestring</span><span class="token punctuation">(</span>INKERNEL_MINFREE_PATH<span class="token punctuation">,</span> minfreestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writefilestring</span><span class="token punctuation">(</span>INKERNEL_ADJ_PATH<span class="token punctuation">,</span> killpriostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šé¢çš„å¤„ç†é€»è¾‘ä¸»è¦æ˜¯ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1. æŒ‰ç…§é¡ºåºå–å‡ºæ•°æ®ï¼Œè£…è¿› lmkd çš„æ•°ç»„ä¸­ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2. åˆ†åˆ«å°†ä¸¤ä¸ªæ•°ç»„ä¸­çš„æ•°å–å‡ºï¼Œç”¨â€,â€åˆ†éš”ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3. lowmem_minfree ä¸­çš„æ•°æ®æ‹¼æˆçš„ string å†™åˆ° â€œ/sys/module/lowmemorykiller/parameters/minfreeâ€ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;4. lowmem_adj ä¸­çš„æ•°æ®æ‹¼æˆçš„ string å†™åˆ° â€œ/sys/module/lowmemorykiller/parameters/adjâ€ã€‚</p>
<h3 id="5-2-2-LMK-PROCPRIO"><a href="#5-2-2-LMK-PROCPRIO" class="headerlink" title="5.2.2 LMK_PROCPRIO"></a>5.2.2 LMK_PROCPRIO</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä¸Šå±‚é€»è¾‘æ˜¯åœ¨ ProcessList.setOomAdj ä¸­</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setOomAdj</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> amt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// This indicates that the process is not started yet and so no need to proceed further.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>amt <span class="token operator">==</span> UNKNOWN_ADJ<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> start <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_PROCPRIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>amt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// å°† 16Byte å­—èŠ‚å†™å…¥ socketï¼Œbuf å¤§å°ä¸º 16 ä¸ªå­—èŠ‚</span>
    <span class="token comment" spellcheck="true">// ä¾æ¬¡å†™å…¥ LMK_PROCPRIO(å‘½ä»¤ç±»å‹), pid(è¿›ç¨‹pid), uid(è¿›ç¨‹uid), amt(ç›®æ ‡adj)ï¼Œå°†è¿™äº›å­—èŠ‚é€šè¿‡ socket å‘é€ç»™ lmkd.</span>
    <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>now<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">250</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"ActivityManager"</span><span class="token punctuation">,</span> <span class="token string">"SLOW OOM ADJ: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms for pid "</span> <span class="token operator">+</span> pid <span class="token operator">+</span> <span class="token string">" = "</span> <span class="token operator">+</span> amt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd å¤„ç†é€»è¾‘</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_procprio</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> oomadj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> path<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> soft_limit_mult<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> lmk_procprio params<span class="token punctuation">;</span>

    <span class="token function">lmkd_pack_get_procprio</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oomadj <span class="token operator">&lt;</span> OOM_SCORE_ADJ_MIN <span class="token operator">||</span> oomadj <span class="token operator">></span> OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Invalid PROCPRIO oomadj argument %d"</span><span class="token punctuation">,</span> oomadj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// LMK_PROCPRIO çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ›´æ–°è¿›ç¨‹çš„ oomAdj</span>
    <span class="token comment" spellcheck="true">// å°†ä¸Šå±‚ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼ˆpidä»¥åŠä¼˜å…ˆçº§ï¼‰å†™åˆ°è¯¥è¿›ç¨‹å¯¹åº”çš„æ–‡ä»¶èŠ‚ç‚¹ï¼š/proc/pid/oom_score_adj</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/proc/%d/oom_score_adj"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> oomadj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å‘èŠ‚ç‚¹ /proc/&lt;pid>/oom_score_adj å†™å…¥ oomAdj</span>
    <span class="token function">writefilestring</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å¦‚æœä½¿ç”¨ kernel çš„é€»è¾‘ï¼Œåˆ™ return</span>
    <span class="token comment" spellcheck="true">// å³è¿™ä¸ª command ä¼ é€’è¿‡æ¥åªæ˜¯æ›´æ–°äº†å¯¹åº”æ–‡ä»¶èŠ‚ç‚¹çš„ oom_score_adj</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>low_ram_device<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">900</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">800</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">700</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Launcher should be perceptible, don't kill it.</span>
            params<span class="token punctuation">.</span>oomadj <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span>   <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Persistent processes will have a large</span>
            <span class="token comment" spellcheck="true">// soft limit 512MB.</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">snprintf</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token string">"/dev/memcg/apps/uid_%d/pid_%d/memory.soft_limit_in_bytes"</span><span class="token punctuation">,</span>
             params<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> soft_limit_mult <span class="token operator">*</span> EIGHT_MEGA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writefilestring</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ä» hashtable ä¸­æŸ¥æ‰¾ proc</span>
    procp <span class="token operator">=</span> <span class="token function">pid_lookup</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿›ç¨‹æ˜¯æ–°åˆ›å»ºçš„ï¼Œlmkd ç»´æŠ¤çš„æ•°æ®ç»“æ„ä¸­è¿˜æ²¡æœ‰è¿™ä¸ª procï¼Œå› æ­¤éœ€è¦æ–°å»ºå¹¶æ·»åŠ åˆ° hashtable ä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            procp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> proc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Oh, the irony.  May need to rebuild our state.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">=</span> params<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
            procp<span class="token operator">-</span><span class="token operator">></span>uid <span class="token operator">=</span> params<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
            procp<span class="token operator">-</span><span class="token operator">></span>oomadj <span class="token operator">=</span> params<span class="token punctuation">.</span>oomadj<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å°† proc æ’å…¥åˆ° lmkd ä¸­çš„æ•°æ®ç»“æ„ä¸­ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ•°æ®ç»“æ„</span>
            <span class="token comment" spellcheck="true">// æ›´æ–° hashtableï¼Œé€šè¿‡ pid è®¡ç®— hash å€¼ï¼Œç„¶åå­˜å‚¨ï¼Œè§£å†³å†²çªæ˜¯è®©æ–°æ¥çš„ä½œä¸ºæ•°ç»„å…ƒç´ é“¾è¡¨çš„å¤´ç»“ç‚¹</span>
            <span class="token comment" spellcheck="true">// ä¼˜å…ˆçº§ä¸º index çš„åŒå‘é“¾è¡¨ç»„æˆçš„ table</span>
            <span class="token function">proc_insert</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// hashtable ä¸­å·²ç»æœ‰è¿™ä¸ª proc</span>
        <span class="token comment" spellcheck="true">// ä½†æ˜¯å› ä¸ºä¼˜å…ˆçº§çš„å˜åŒ–ï¼Œéœ€è¦å…ˆæŠŠè¿™ä¸ª proc ä»åŸå…ˆçš„ä¼˜å…ˆçº§ table ä¸­å¯¹åº”ä½ç½®çš„åŒå‘é“¾è¡¨ä¸­ remove</span>
        <span class="token comment" spellcheck="true">// ç„¶åæ–°åŠ åˆ°æ–°çš„ä¼˜å…ˆçº§å¯¹åº”çš„åŒå‘é“¾è¡¨ä¸­</span>
        <span class="token comment" spellcheck="true">// åŒå‘é“¾è¡¨çš„æ·»åŠ æ˜¯æ–°æ¥çš„æ”¾åœ¨å¤´éƒ¨</span>
        <span class="token function">proc_unslot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        procp<span class="token operator">-</span><span class="token operator">></span>oomadj <span class="token operator">=</span> params<span class="token punctuation">.</span>oomadj<span class="token punctuation">;</span>
        <span class="token function">proc_slot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// å…¶ä¸­ pid_lookupï¼šæŸ¥è¯¢ hashtableï¼Œå› ä¸ºè¿›ç¨‹çš„ pid æ˜¯å”¯ä¸€çš„ï¼Œç„¶åä»ä¸­å–å‡ºè¯¥ pid åœ¨ lmkd ä¸­çš„ proc ç»“æ„ä½“</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> proc <span class="token operator">*</span><span class="token function">pid_lookup</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>procp <span class="token operator">=</span> pidhash<span class="token punctuation">[</span><span class="token function">pid_hashfn</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> procp <span class="token operator">&amp;&amp;</span> procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">!=</span> pid<span class="token punctuation">;</span>
         procp <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">)</span>
            <span class="token punctuation">;</span>

    <span class="token keyword">return</span> procp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-2-3-LMK-PROCREMOVE"><a href="#5-2-3-LMK-PROCREMOVE" class="headerlink" title="5.2.3 LMK_PROCREMOVE"></a>5.2.3 LMK_PROCREMOVE</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä¸Šå±‚å¤„ç†é€»è¾‘åœ¨ ProcessList.remove ä¸­</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// This indicates that the process is not started yet and so no need to proceed further.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_PROCREMOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd å¤„ç†é€»è¾‘</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_procremove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> lmk_procremove params<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å¦‚æœä½¿ç”¨ kernel æ¥å£ï¼Œreturn</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token function">lmkd_pack_get_procremove</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// æ›´æ–°æ•°æ®ç»“æ„ï¼Œpid çš„ hashtable ä»¥åŠè¿›ç¨‹ä¼˜å…ˆçº§çš„åŒå‘é“¾è¡¨ table</span>
    <span class="token function">pid_remove</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pid_remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> hval <span class="token operator">=</span> <span class="token function">pid_hashfn</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>prevp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>procp <span class="token operator">=</span> pidhash<span class="token punctuation">[</span>hval<span class="token punctuation">]</span><span class="token punctuation">,</span> prevp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> procp <span class="token operator">&amp;&amp;</span> procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">!=</span> pid<span class="token punctuation">;</span>
         procp <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">)</span>
            prevp <span class="token operator">=</span> procp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevp<span class="token punctuation">)</span>
        pidhash<span class="token punctuation">[</span>hval<span class="token punctuation">]</span> <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        prevp<span class="token operator">-</span><span class="token operator">></span>pidhash_next <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">;</span>

    <span class="token function">proc_unslot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä»ä¸Šé¢çš„å¤„ç†é€»è¾‘å°±èƒ½çœ‹å‡ºæ¥ï¼Œä¸‰ç§ command çš„å¤„ç†é€»è¾‘ä¸­éƒ½å¯¹ use_inkernel_interface çš„æƒ…å†µä¸‹åšäº†ç‰¹æ®Šå¤„ç†ï¼Œåœ¨ use_inkernel_interface çš„æƒ…å†µä¸‹ï¼Œåšçš„äº‹æƒ…éƒ½æ˜¯å¾ˆç®€å•çš„ï¼Œåªæ˜¯æ›´æ–°ä¸€ä¸‹æ–‡ä»¶èŠ‚ç‚¹ã€‚å¦‚æœä¸ä½¿ç”¨ kernel interfaceï¼Œå°±éœ€è¦ lmkd è‡ªå·±ç»´æŠ¤ä¸¤ä¸ª tableï¼Œåœ¨æ¯æ¬¡æ›´æ–° adj çš„æ—¶å€™å»æ›´æ–° tableã€‚ ä¸”åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿèƒ½çœ‹åˆ°ï¼Œå¦‚æœä¸ä½¿ç”¨ kernel çš„ lowmemorykillerï¼Œåˆ™éœ€è¦ lmkd è‡ªå·±è·å–æ‰‹æœºå†…å­˜çŠ¶æ€ï¼Œå¦‚æœåŒ¹é…åˆ°äº† minfree ä¸­çš„ç­‰çº§ï¼Œåˆ™éœ€è¦é€šè¿‡æ€æ‰ä¸€äº›è¿›ç¨‹é‡Šæ”¾å†…å­˜ã€‚</p>
<p>åœ¨ä¸‰ç§æ•°æ®çš„ä»£ç åˆ†æä¸­ï¼Œæˆ‘ä»¬éƒ½çœ‹åˆ°äº† writeLmkd å‡½æ•°ï¼Œæ¥ä¸‹æ¥ç®€å•çœ‹ä¸‹ï¼</p>
<h3 id="5-2-4-writeLmkd"><a href="#5-2-4-writeLmkd" class="headerlink" title="5.2.4 writeLmkd"></a>5.2.4 writeLmkd</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeLmkd</span><span class="token punctuation">(</span>ByteBuffer buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// å½“ socket æ‰“å¼€å¤±è´¥ä¼šå°è¯• 3 æ¬¡</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sLmkdSocket <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰“å¼€ socket</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">openLmkdSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            å°† buf ä¿¡æ¯å†™å…¥ lmkd socket
            sLmkdOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error writing to lowmemorykiller socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                sLmkdSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

            sLmkdSocket <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æŸ¥çœ‹æ‰“å¼€ socket çš„å‡½æ•°ï¼š</p>
<h3 id="5-2-5-openLmkdSocket"><a href="#5-2-5-openLmkdSocket" class="headerlink" title="5.2.5 openLmkdSocket"></a>5.2.5 openLmkdSocket</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">openLmkdSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            sLmkdSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocket</span><span class="token punctuation">(</span>LocalSocket<span class="token punctuation">.</span>SOCKET_SEQPACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸è¿œç¨‹ lmkd å®ˆæŠ¤è¿›ç¨‹å»ºç«‹ socket è¿æ¥</span>
            sLmkdSocket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">LocalSocketAddress</span><span class="token punctuation">(</span><span class="token string">"lmkd"</span><span class="token punctuation">,</span>
                        LocalSocketAddress<span class="token punctuation">.</span>Namespace<span class="token punctuation">.</span>RESERVED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sLmkdOutputStream <span class="token operator">=</span> sLmkdSocket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"lowmemorykiller daemon socket open failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sLmkdSocket <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>è¯¥æ–¹æ³•æ˜¯æ‰“å¼€ä¸€ä¸ªåä¸º lmkd çš„ socketï¼Œç±»å‹ä¸º LocalSocket.SOCKET_SEQPACKETï¼Œè¿™åªæ˜¯ä¸€ä¸ªå°è£…ï¼ŒçœŸå®ç±»å‹å°±æ˜¯ SOCK_SEQPACKETã€‚å…ˆè·Ÿè¿œç¨‹ lmkd å®ˆæŠ¤è¿›ç¨‹å»ºç«‹è¿æ¥ï¼Œå†å‘å…¶é€šè¿‡ write() å°†æ•°æ®å†™å…¥è¯¥ socketï¼Œå†æ¥ä¸‹æ¥è¿›å…¥ lmkd è¿‡ç¨‹ã€‚</p>
<h2 id="5-3-Kernel"><a href="#5-3-Kernel" class="headerlink" title="5.3 Kernel"></a>5.3 Kernel</h2><p>å‰é¢æè¿‡ï¼Œ<strong><font color="#FF0000">å¤§å¤šæƒ…å†µå…¶å®æ˜¯ä½¿ç”¨ kernel interface çš„ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ kernel ä¸­çš„ lowmemorykiller</font></strong>ã€‚</p>
<p>lowmemorykiller driver ä½äº kernel-x.xx/drivers/staging/android/lowmemorykiller.cã€‚</p>
<p>lowmemorykiller ä¸­æ˜¯é€šè¿‡ linux çš„ shrinker å®ç°çš„ï¼Œè¿™ä¸ªæ˜¯ linux çš„å†…å­˜å›æ”¶æœºåˆ¶çš„ä¸€ç§ï¼Œç”±å†…æ ¸çº¿ç¨‹ kswapd è´Ÿè´£ç›‘æ§ï¼Œåœ¨ lowmemorykiller åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œ register_shrinkerã€‚</p>
<h3 id="5-3-1-lowmemorykiller-åˆå§‹åŒ–"><a href="#5-3-1-lowmemorykiller-åˆå§‹åŒ–" class="headerlink" title="5.3.1 lowmemorykiller åˆå§‹åŒ–"></a>5.3.1 lowmemorykiller åˆå§‹åŒ–</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> shrinker lowmem_shrinker <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>scan_objects <span class="token operator">=</span> lowmem_scan<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>count_objects <span class="token operator">=</span> lowmem_count<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>seeks <span class="token operator">=</span> DEFAULT_SEEKS <span class="token operator">*</span> <span class="token number">16</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">lowmem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">register_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// åˆå§‹åŒ–</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">lowmem_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">unregister_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// é€€å‡º</span>
<span class="token punctuation">}</span>
</code></pre>
<p>é€šè¿‡ register_shrinker å’Œ unregister_shrinker åˆ†åˆ«ç”¨äºåˆå§‹åŒ–å’Œé€€å‡ºã€‚</p>
<h3 id="5-3-2-minfree-min-adj"><a href="#5-3-2-minfree-min-adj" class="headerlink" title="5.3.2 minfree/min_adj"></a>5.3.2 minfree/min_adj</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// ä¸‹é¢ä¸¤ä¸ªæ•°ç»„åˆ†åˆ«ä»£è¡¨äº†ä¸¤ä¸ªå‚æ•°æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼ï¼Œæ•°ç»„é»˜è®¤çš„ size éƒ½æ˜¯ 9</span>
<span class="token comment" spellcheck="true">// å¯¹åº” "/sys/module/lowmemorykiller/parameters/adj"</span>
<span class="token keyword">static</span> <span class="token keyword">short</span> lowmem_adj<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">12</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// å¯¹åº” "/sys/module/lowmemorykiller/parameters/minfree"</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_adj_size <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> lowmem_minfree<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">512</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 6MB */</span>
    <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 8MB */</span>
    <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 16MB */</span>
    <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 64MB */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_minfree_size <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="5-3-3-shrinker"><a href="#5-3-3-shrinker" class="headerlink" title="5.3.3 shrinker"></a>5.3.3 shrinker</h3><p>å½“å†…å­˜ä¸è¶³æ—¶ kswapd çº¿ç¨‹ä¼šéå†ä¸€å¼  shrinker é“¾è¡¨ï¼Œå¹¶å›è°ƒå·²æ³¨å†Œçš„ shrinker å‡½æ•°æ¥å›æ”¶å†…å­˜ pageï¼Œkswapd è¿˜ä¼šå‘¨æœŸæ€§å”¤é†’æ¥æ‰§è¡Œå†…å­˜æ“ä½œã€‚æ¯ä¸ª zone ç»´æŠ¤ active_list å’Œ inactive_list é“¾è¡¨ï¼Œå†…æ ¸æ ¹æ®é¡µé¢æ´»åŠ¨çŠ¶æ€å°† page åœ¨è¿™ä¸¤ä¸ªé“¾è¡¨ä¹‹é—´ç§»åŠ¨ï¼Œæœ€ç»ˆé€šè¿‡ shrink_slab å’Œ shrink_zone æ¥å›æ”¶å†…å­˜é¡µï¼Œæœ‰å…´è¶£æƒ³è¿›ä¸€æ­¥äº†è§£ linux å†…å­˜å›æ”¶æœºåˆ¶ï¼Œå¯è‡ªè¡Œç ”ç©¶ã€‚</p>
<h3 id="5-3-4-lowmem-count"><a href="#5-3-4-lowmem-count" class="headerlink" title="5.3.4 lowmem_count"></a>5.3.4 lowmem_count</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">lowmem_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> shrinker <span class="token operator">*</span>s<span class="token punctuation">,</span>
                  <span class="token keyword">struct</span> shrink_control <span class="token operator">*</span>sc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment" spellcheck="true">// ANONä»£è¡¨åŒ¿åæ˜ å°„ï¼Œæ²¡æœ‰åå¤‡å­˜å‚¨å™¨ï¼›</span>
  <span class="token comment" spellcheck="true">// FILE ä»£è¡¨æ–‡ä»¶æ˜ å°„ï¼› å†…å­˜è®¡ç®—å…¬å¼ = æ´»åŠ¨åŒ¿åå†…å­˜ + æ´»åŠ¨æ–‡ä»¶å†…å­˜ + ä¸æ´»åŠ¨åŒ¿åå†…å­˜ + ä¸æ´»åŠ¨æ–‡ä»¶å†…å­˜</span>
  <span class="token keyword">return</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_ACTIVE_ANON<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_ACTIVE_FILE<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_INACTIVE_ANON<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_INACTIVE_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-3-5-lowmem-scan"><a href="#5-3-5-lowmem-scan" class="headerlink" title="5.3.5 lowmem_scan"></a>5.3.5 lowmem_scan</h3><p>å½“è§¦å‘ lmkdï¼Œåˆ™å…ˆæ€ oom_score_adj æœ€å¤§çš„è¿›ç¨‹ï¼Œå½“ oom_adj ç›¸ç­‰æ—¶ï¼Œåˆ™é€‰æ‹© rss æœ€å¤§çš„è¿›ç¨‹ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> unsigned <span class="token keyword">long</span> <span class="token function">lowmem_scan</span><span class="token punctuation">(</span>struct shrinker <span class="token operator">*</span>s<span class="token punctuation">,</span> struct shrink_control <span class="token operator">*</span>sc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct task_struct <span class="token operator">*</span>tsk<span class="token punctuation">;</span>
    struct task_struct <span class="token operator">*</span>selected <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
    unsigned <span class="token keyword">long</span> rem <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tasksize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">short</span> min_score_adj <span class="token operator">=</span> OOM_SCORE_ADJ_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> minfree <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> selected_tasksize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">short</span> selected_oom_score_adj<span class="token punctuation">;</span>
    <span class="token keyword">int</span> array_size <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è·å–å½“å‰å‰©ä½™å†…å­˜å¤§å°</span>
    <span class="token keyword">int</span> other_free <span class="token operator">=</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_FREE_PAGES<span class="token punctuation">)</span> <span class="token operator">-</span> totalreserve_pages<span class="token punctuation">;</span>
    <span class="token keyword">int</span> other_file <span class="token operator">=</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_FILE_PAGES<span class="token punctuation">)</span> <span class="token operator">-</span>
                        <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_SHMEM<span class="token punctuation">)</span> <span class="token operator">-</span>
                        <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_UNEVICTABLE<span class="token punctuation">)</span> <span class="token operator">-</span>
                        <span class="token function">total_swapcache_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// è·å–æ•°ç»„å¤§å°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lowmem_adj_size <span class="token operator">&lt;</span> array_size<span class="token punctuation">)</span>
        array_size <span class="token operator">=</span> lowmem_adj_size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lowmem_minfree_size <span class="token operator">&lt;</span> array_size<span class="token punctuation">)</span>
        array_size <span class="token operator">=</span> lowmem_minfree_size<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// éå† lowmem_minfree æ•°ç»„æ‰¾å‡ºç›¸åº”çš„æœ€å° adj å€¼</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        minfree <span class="token operator">=</span> lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>other_free <span class="token operator">&lt;</span> minfree <span class="token operator">&amp;&amp;</span> other_file <span class="token operator">&lt;</span> minfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            min_score_adj <span class="token operator">=</span> lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>min_score_adj <span class="token operator">==</span> OOM_SCORE_ADJ_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    selected_oom_score_adj <span class="token operator">=</span> min_score_adj<span class="token punctuation">;</span>


    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">for_each_process</span><span class="token punctuation">(</span>tsk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        struct task_struct <span class="token operator">*</span>p<span class="token punctuation">;</span>
        <span class="token keyword">short</span> oom_score_adj<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tsk<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> PF_KTHREAD<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        p <span class="token operator">=</span> <span class="token function">find_lock_task_mm</span><span class="token punctuation">(</span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_tsk_thread_flag</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> TIF_MEMDIE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">time_before_eq</span><span class="token punctuation">(</span>jiffies<span class="token punctuation">,</span> lowmem_deathpending_timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrink_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> SHRINK_STOP<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        oom_score_adj <span class="token operator">=</span> p<span class="token operator">-</span><span class="token operator">></span>signal<span class="token operator">-</span><span class="token operator">></span>oom_score_adj<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// å°äºç›®æ ‡adjçš„è¿›ç¨‹ï¼Œåˆ™å¿½ç•¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">&lt;</span> min_score_adj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// è·å–çš„æ˜¯è¿›ç¨‹çš„ Resident Set Sizeï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹ç‹¬å å†…å­˜ + å…±äº«åº“å¤§å°</span>
        tasksize <span class="token operator">=</span> <span class="token function">get_mm_rss</span><span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token operator">></span>mm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tasksize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç®—æ³•å…³é”®ï¼Œé€‰æ‹© oom_score_adj æœ€å¤§çš„è¿›ç¨‹ä¸­ï¼Œå¹¶ä¸” rss å†…å­˜æœ€å¤§çš„è¿›ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">&lt;</span> selected_oom_score_adj<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">==</span> selected_oom_score_adj <span class="token operator">&amp;&amp;</span>
                tasksize <span class="token operator">&lt;=</span> selected_tasksize<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        selected <span class="token operator">=</span> p<span class="token punctuation">;</span>
        selected_tasksize <span class="token operator">=</span> tasksize<span class="token punctuation">;</span>
        selected_oom_score_adj <span class="token operator">=</span> oom_score_adj<span class="token punctuation">;</span>
        <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"select '%s' (%d), adj %d, score_adj %hd, size %d, to kill\n"</span><span class="token punctuation">,</span>
                 p<span class="token operator">-</span><span class="token operator">></span>comm<span class="token punctuation">,</span> p<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> <span class="token function">REVERT_ADJ</span><span class="token punctuation">(</span>oom_score_adj<span class="token punctuation">)</span><span class="token punctuation">,</span> oom_score_adj<span class="token punctuation">,</span> tasksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> cache_size <span class="token operator">=</span> other_file <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> cache_limit <span class="token operator">=</span> minfree <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> free <span class="token operator">=</span> other_free <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">trace_lowmemory_kill</span><span class="token punctuation">(</span>selected<span class="token punctuation">,</span> cache_size<span class="token punctuation">,</span> cache_limit<span class="token punctuation">,</span> free<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// è¾“å‡º kill çš„ log</span>
        <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Killing '%s' (%d), adj %d, score_adj %hd, state(%ld)\n"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lowmem_deathpending_timeout <span class="token operator">=</span> jiffies <span class="token operator">+</span> LOWMEM_DEATHPENDING_TIMEOUT<span class="token punctuation">;</span>
        <span class="token function">set_tsk_thread_flag</span><span class="token punctuation">(</span>selected<span class="token punctuation">,</span> TIF_MEMDIE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// å‘é€‰ä¸­çš„ç›®æ ‡è¿›ç¨‹å‘é€ signal 9 æ¥æ€æ‰ç›®æ ‡è¿›ç¨‹</span>
        <span class="token function">send_sig</span><span class="token punctuation">(</span>SIGKILL<span class="token punctuation">,</span> selected<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rem <span class="token operator">+=</span> selected_tasksize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d_state_is_found <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"No selected (full of D-state processes at %d)\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>min_score_adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"lowmem_scan %lu, %x, return %lu\n"</span><span class="token punctuation">,</span>
             sc<span class="token operator">-</span><span class="token operator">></span>nr_to_scan<span class="token punctuation">,</span> sc<span class="token operator">-</span><span class="token operator">></span>gfp_mask<span class="token punctuation">,</span> rem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrink_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å½“å¦‚ä¸‹èŠ‚ç‚¹æ•°æ®å‘é€å˜åŒ–æ—¶ï¼Œä¼šé€šè¿‡ä¿®æ”¹ lowmem_minfree[ ] å’Œ lowmem_adj[ ] æ•°ç»„ï¼š</p>
<pre><code>/sys/module/lowmemorykiller/parameters/minfree
/sys/module/lowmemorykiller/parameters/adj
</code></pre><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡ä¸»è¦è®¨è®º frameworks çš„ ProcessList.java è°ƒæ•´ adjï¼Œé€šè¿‡ socket é€šä¿¡å°†äº‹ä»¶å‘é€ç»™ native çš„å®ˆæŠ¤è¿›ç¨‹ lmkdï¼›lmkd å†æ ¹æ®å…·ä½“çš„å‘½ä»¤æ¥æ‰§è¡Œç›¸åº”æ“ä½œï¼Œå…¶ä¸»è¦åŠŸèƒ½ æ›´æ–°è¿›ç¨‹çš„ oom_score_adj å€¼ä»¥åŠ lowmemorykiller é©±åŠ¨çš„ parameters (åŒ…æ‹¬ minfree å’Œ adj )ï¼›</p>
<p>æœ€åè®²åˆ°äº† lowmemorykiller é©±åŠ¨ï¼Œé€šè¿‡æ³¨å†Œ shrinkerï¼Œå€ŸåŠ© linux æ ‡å‡†çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œæ ¹æ®å½“å‰ç³»ç»Ÿå¯ç”¨å†…å­˜ä»¥åŠ parameters é…ç½®å‚æ•°( adj , minfree )æ¥é€‰å–åˆé€‚çš„ selected_oom_score_adjï¼Œå†ä»æ‰€æœ‰è¿›ç¨‹ä¸­é€‰æ‹© adj å¤§äºè¯¥ç›®æ ‡å€¼çš„å¹¶ä¸”å ç”¨ rss å†…å­˜æœ€å¤§çš„è¿›ç¨‹ï¼Œå°†å…¶æ€æ‰ï¼Œä»è€Œé‡Šæ”¾å‡ºå†…å­˜ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>&nbsp;01. <a href="http://gityuan.com/2016/09/17/android-lowmemorykiller/" target="_blank" rel="noopener">http://gityuan.com/2016/09/17/android-lowmemorykiller/</a><br>&nbsp;02. <a href="https://blog.csdn.net/u011733869/article/details/78820240" target="_blank" rel="noopener">https://blog.csdn.net/u011733869/article/details/78820240</a><br>&nbsp;03. <a href="https://blog.csdn.net/su749520/article/details/78595367" target="_blank" rel="noopener">https://blog.csdn.net/su749520/article/details/78595367</a><br>&nbsp;04. <a href="http://gityuan.com/2018/05/19/android-process-adj/" target="_blank" rel="noopener">http://gityuan.com/2018/05/19/android-process-adj/</a></p>
<h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>å¾®ä¿¡é‡Œç‚¹â€œå‘ç°â€->â€œæ‰«ä¸€æ‰«â€äºŒç»´ç ä¾¿å¯æŸ¥çœ‹åˆ†äº«ã€‚</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;è½¬è½½è¯·æ³¨æ˜:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2018/11/01/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhu-zhi-lowmemorykiller/" class="b-link-green">æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ LowMemoryKiller</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScriptã€‚</noscript>
    </div>
    <!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2018/11/10/04.he-xin-ji-zhi-xi-lie-shen-ru-zuan-yan-android-he-xin-ji-zhu-zhi-jni/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/JNI.jpg" class="responsive-img" alt="æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ JNI">
                        
                        <span class="card-title">æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ JNI</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">1. å¼€ç¯‡1.1 æ ¸å¿ƒæºç 


å…³é”®ç±»
è·¯å¾„




MediaScanner.java
frameworks/base/media/java/android/media/MediaScanner.java


android_media_</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2018-11-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ ¸å¿ƒæŠ€æœ¯/" class="post-category" target="_blank">
                                    æ ¸å¿ƒæŠ€æœ¯
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/æ ¸å¿ƒæŠ€æœ¯/" target="_blank">
                        <span class="chip bg-color">æ ¸å¿ƒæŠ€æœ¯</span>
                    </a>
                    
                    <a href="/tags/JNI/" target="_blank">
                        <span class="chip bg-color">JNI</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/09/26/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-shi-jian-fen-fa/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/äº‹ä»¶åˆ†å‘.jpg" class="responsive-img" alt="æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ äº‹ä»¶åˆ†å‘">
                        
                        <span class="card-title">æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ äº‹ä»¶åˆ†å‘</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">1. æ ¸å¿ƒæºç 


å…³é”®ç±»
è·¯å¾„




Activity.java
frameworks/base/core/java/android/app/Activity.java


DecorView.java
frameworks/base/</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-09-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="post-category" target="_blank">
                                    æ ¸å¿ƒæœºåˆ¶
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/äº‹ä»¶åˆ†å‘/" target="_blank">
                        <span class="chip bg-color">äº‹ä»¶åˆ†å‘</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: Thinking in Android<br />'
            + 'ä½œè€…: Marco<br />'
            + 'é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQè”ç³»æˆ‘: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;æ£€ç´¢åšæ–‡</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„æŠ€æœ¯å…³é”®å­—" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>