<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</title>
      <link href="/2019/12/31/00.thinking-in-android-01.bo-ke-suo-yin/"/>
      <url>/2019/12/31/00.thinking-in-android-01.bo-ke-suo-yin/</url>
      
        <content type="html"><![CDATA[<h4 id="Thinking-in-Android-â€“-â€œç³»ç»Ÿå¯åŠ¨â€"><a href="#Thinking-in-Android-â€“-â€œç³»ç»Ÿå¯åŠ¨â€" class="headerlink" title="Thinking in Android â€“ â€œç³»ç»Ÿå¯åŠ¨â€"></a><center>Thinking in Android â€“ â€œç³»ç»Ÿå¯åŠ¨â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€å¯åŠ¨é˜¶æ®µã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th><th style="text-align:center"><strong>æºç ç‰ˆæœ¬</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">init</font></strong></td><td style="text-align:center"><a href>æ·±å…¥ç ”ç©¶ Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">zygote</font></strong></td><td style="text-align:center"><a href>æ·±å…¥ç ”ç©¶ Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">systemserver</font></strong></td><td style="text-align:center"><a href>æ·±å…¥ç ”ç©¶ Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Launcher</font></strong></td><td style="text-align:center"><a href>æ·±å…¥ç ”ç©¶ Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨åŠåŠ è½½æµç¨‹</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œæ¡†æ¶æœåŠ¡â€"><a href="#Thinking-in-Android-â€“-â€œæ¡†æ¶æœåŠ¡â€" class="headerlink" title="Thinking in Android â€“ â€œæ¡†æ¶æœåŠ¡â€"></a><center>Thinking in Android â€“ â€œæ¡†æ¶æœåŠ¡â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€æ¡†æ¶æœåŠ¡ã€‘</font></strong></th><th style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th><th style="text-align:center"><strong>æºç ç‰ˆæœ¬</strong></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">PackageManagerService</font></strong></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- PackageParser</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…ï¼ˆä¸Šï¼‰</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- APK å®‰è£…ï¼ˆä¸­ï¼‰</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"></td><td style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href>PackageManagerService é’»ç ”ï¼ˆ8ï¼‰- APK å®‰è£…ï¼ˆä¸‹ï¼‰</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr></tbody></table><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€æ ¸å¿ƒæœºåˆ¶ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th><th style="text-align:center"><strong>æºç ç‰ˆæœ¬</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Binder</font></strong></td><td style="text-align:center"><a href>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Binderï¼ˆåŸºç¡€ç¯‡ï¼‰</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">JNI</font></strong></td><td style="text-align:center"><a href>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ JNI</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">LowMemoryKiller</font></strong></td><td style="text-align:center"><a href>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ LowMemoryKiller</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">äº‹ä»¶åˆ†å‘</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/09/26/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-shi-jian-fen-fa/">æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ äº‹ä»¶åˆ†å‘</a></td><td style="text-align:center"><font color="#0000ff" size="3">å®Œç»“</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Handler</font></strong></td><td style="text-align:center"><a href>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Handlerï¼ˆç”¨æ³•ç¯‡ï¼‰</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Handler</font></strong></td><td style="text-align:center"><a href>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Handlerï¼ˆåŸç†ç¯‡ï¼‰</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">æ€è¿›ç¨‹</font></strong></td><td style="text-align:center"><a href>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ è¿›ç¨‹è¢«æ€</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œæ€§èƒ½ä¼˜åŒ–â€"><a href="#Thinking-in-Android-â€“-â€œæ€§èƒ½ä¼˜åŒ–â€" class="headerlink" title="Thinking in Android â€“ â€œæ€§èƒ½ä¼˜åŒ–â€"></a><center>Thinking in Android â€“ â€œæ€§èƒ½ä¼˜åŒ–â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€æ€§èƒ½ä¼˜åŒ–ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th><th style="text-align:center"><strong>æºç ç‰ˆæœ¬</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">å†…å­˜æ³„éœ²</font></strong></td><td style="text-align:center"><a href>å¸¦ä½ é¢†ç•¥ Android å†…å­˜æ³„æ¼çš„å‰ä¸–ä»Šç”Ÿ</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3"></font></strong></td><td style="text-align:center"><a href>èŠèŠ ANR ä¹‹ Input è¶…æ—¶</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">ANR</font></strong></td><td style="text-align:center"><a href>èŠèŠ ANR ä¹‹ Broadcast è¶…æ—¶</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3"></font></strong></td><td style="text-align:center"><a href>èŠèŠ ANR ä¹‹ Service è¶…æ—¶</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œè¿›ç¨‹çº¿ç¨‹â€"><a href="#Thinking-in-Android-â€“-â€œè¿›ç¨‹çº¿ç¨‹â€" class="headerlink" title="Thinking in Android â€“ â€œè¿›ç¨‹çº¿ç¨‹â€"></a><center>Thinking in Android â€“ â€œè¿›ç¨‹çº¿ç¨‹â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€è¿›ç¨‹çº¿ç¨‹ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th><th style="text-align:center"><strong>æºç ç‰ˆæœ¬</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">AsyncTask</font></strong></td><td style="text-align:center"><a href>AsyncTask è¯¦è§£ï¼ˆç”¨æ³•ç¯‡ï¼‰</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">åŒæ­¥å’Œæ­»é”</font></strong></td><td style="text-align:center"><a href>æµ…æå¤šçº¿ç¨‹ä¸­çš„ â€œåŒæ­¥â€ å’Œ â€œæ­»é”â€</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œå¸¸ç”¨ç»„ä»¶â€"><a href="#Thinking-in-Android-â€“-â€œå¸¸ç”¨ç»„ä»¶â€" class="headerlink" title="Thinking in Android â€“ â€œå¸¸ç”¨ç»„ä»¶â€"></a><center>Thinking in Android â€“ â€œå¸¸ç”¨ç»„ä»¶â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€å¸¸ç”¨ç»„ä»¶ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th><th style="text-align:center"><strong>æºç ç‰ˆæœ¬</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Activity</font></strong></td><td style="text-align:center"><a href>æ¢è®¨ Activity çš„å¯åŠ¨æ¨¡å¼</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Activity</font></strong></td><td style="text-align:center"><a href>æ¢è®¨ Activity çš„ç”Ÿå‘½å‘¨æœŸ</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Fragment</font></strong></td><td style="text-align:center"><a href>æ¢è®¨ Fragment çš„ç”Ÿå‘½å‘¨æœŸ</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Service</font></strong></td><td style="text-align:center"><a href>æ¢è®¨ Service çš„ä½¿ç”¨æ–¹æ³•</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Broadcast</font></strong></td><td style="text-align:center"><a href>æ¢è®¨ â€œåŠ¨æ€å¹¿æ’­â€ å’Œ â€œé™æ€å¹¿æ’­â€ çš„ç”¨æ³•å’ŒåŒºåˆ«</a></td><td style="text-align:center"><font color="#FF0000" size="3">ä¿®è®¢ä¸­</font></td><td style="text-align:center"><strong>Android 9.0</strong></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œè°·æ­Œè®¤è¯â€"><a href="#Thinking-in-Android-â€“-â€œè°·æ­Œè®¤è¯â€" class="headerlink" title="Thinking in Android â€“ â€œè°·æ­Œè®¤è¯â€"></a><center>Thinking in Android â€“ â€œè°·æ­Œè®¤è¯â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€è°·æ­Œè®¤è¯ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong>ç‰ˆæœ¬</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">GMS</font></strong></td><td style="text-align:center"><a href>æ·±å…¥è§£è¯» GMS è®¤è¯</a></td><td style="text-align:center"><font color="#FF0000" size="3">P ç‰ˆæœ¬ï¼Œcts_r17ï¼Œgts_6.0 r4</font></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œç»éªŒæ€»ç»“â€"><a href="#Thinking-in-Android-â€“-â€œç»éªŒæ€»ç»“â€" class="headerlink" title="Thinking in Android â€“ â€œç»éªŒæ€»ç»“â€"></a><center>Thinking in Android â€“ â€œç»éªŒæ€»ç»“â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€ç»éªŒæ€»ç»“ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Bug/éœ€æ±‚</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2019/04/15/10.jing-yan-zong-jie-xi-lie-android-kai-fa-chang-jian-wen-ti-ji-chu-pian/">Android å¼€å‘å¸¸è§é—®é¢˜æ€»ç»“ï¼ˆåŸºç¡€ç¯‡ï¼‰</a></td><td style="text-align:center"><font color="#0000ff" size="3">æŒç»­æ›´æ–°</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">é¢è¯•é¢˜</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2019/04/23/10.jing-yan-zong-jie-xi-lie-guan-yu-shi-jian-fen-fa-ji-zhi-de-mian-shi-ti-ji/">â€œäº‹ä»¶åˆ†å‘æœºåˆ¶â€ - é¢è¯•é¢˜é›†</a></td><td style="text-align:center"><font color="#0000ff" size="3">æŒç»­æ›´æ–°</font></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œç®—æ³•ä¸“æ â€"><a href="#Thinking-in-Android-â€“-â€œç®—æ³•ä¸“æ â€" class="headerlink" title="Thinking in Android â€“ â€œç®—æ³•ä¸“æ â€"></a><center>Thinking in Android â€“ â€œç®—æ³•ä¸“æ â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€ç®—æ³•ä¸“æ ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">çŠ¶æ€</font></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">ç®—æ³•å¤æ‚åº¦</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2019/03/01/11.suan-fa-zhuan-lan-xi-lie-tan-tan-shi-jian-fu-za-du/">è°ˆè°ˆç®—æ³•ä¸­çš„ â€œæ—¶é—´å¤æ‚åº¦â€</a></td><td style="text-align:center"><font color="#0000ff" size="3">å®Œç»“</font></td></tr></tbody></table><p><br></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¡†æ¶æœåŠ¡ </tag>
            
            <tag> é€šä¿¡æœºåˆ¶ </tag>
            
            <tag> æ€§èƒ½ä¼˜åŒ– </tag>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>èµ„æºæ”¶è—</title>
      <link href="/2019/12/30/00.thinking-in-android-02.zi-yuan-shou-cang/"/>
      <url>/2019/12/30/00.thinking-in-android-02.zi-yuan-shou-cang/</url>
      
        <content type="html"><![CDATA[<h4 id="Android-å®˜æ–¹"><a href="#Android-å®˜æ–¹" class="headerlink" title="Android å®˜æ–¹"></a><center>Android å®˜æ–¹</center></h4><p><br></p><style>table th:first-of-type {    width: 490px;}</style><table><thead><tr><th style="text-align:center"><strong><a href="https://source.android.com/" target="_blank" rel="noopener">AOSP</a></strong></th><th style="text-align:center"><strong><a href="https://developer.android.google.cn/index.html" target="_blank" rel="noopener">Android Developers</a></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><a href="http://www.android-studio.org/" target="_blank" rel="noopener">Android Studio - ä¸­æ–‡ç¤¾åŒº</a></strong></td><td style="text-align:center"><strong><a href="http://androidxref.com/" target="_blank" rel="noopener">Android æºç  - åœ¨çº¿æ£€ç´¢</a></strong></td></tr><tr><td style="text-align:center"><strong><a href="http://hukai.me/android-training-course-in-chinese/index.html" target="_blank" rel="noopener">Androidå®˜æ–¹åŸ¹è®­è¯¾ç¨‹ä¸­æ–‡ç‰ˆ</a></strong></td><td style="text-align:center"><strong>â€¦ â€¦</strong></td></tr></tbody></table><p><br></p><hr><h4 id="Android-çŸ¥ååšä¸»"><a href="#Android-çŸ¥ååšä¸»" class="headerlink" title="Android çŸ¥ååšä¸»"></a><center>Android çŸ¥ååšä¸»</center></h4><p><br></p><style>table th:first-of-type {    width: 490px;}</style><table><thead><tr><th style="text-align:center"><strong><a href="http://gityuan.com/" target="_blank" rel="noopener">Gityuan</a></strong></th><th style="text-align:center"><strong><a href="https://blog.csdn.net/innost?viewmode=contents" target="_blank" rel="noopener">Innost çš„ä¸“æ </a></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><a href="https://blog.csdn.net/luoshengyang/article/details/8923485" target="_blank" rel="noopener">è€ç½—çš„ Android ä¹‹æ—…</a></strong></td><td style="text-align:center"><strong><a href="http://blog.csdn.net/guolin_blog/" target="_blank" rel="noopener">éƒ­éœ–</a></strong></td></tr><tr><td style="text-align:center"><strong><a href="http://liuwangshu.cn/system/" target="_blank" rel="noopener">åˆ˜æœ›èˆ’</a></strong></td><td style="text-align:center"><strong><a href="https://me.csdn.net/cjpx00008" target="_blank" rel="noopener">é¦™è¾£ç‰›è‚‰é¢</a></strong></td></tr><tr><td style="text-align:center"><strong><a href="https://www.jianshu.com/u/77699cd41b28" target="_blank" rel="noopener">iæ ¡é•¿</a></strong></td><td style="text-align:center"><strong><a href="http://guoyangard.cn/" target="_blank" rel="noopener">ArrayBy</a></strong></td></tr><tr><td style="text-align:center"><strong><a href="http://blog.csdn.net/Android_Tutor/" target="_blank" rel="noopener">é­ç¥æ—</a></strong></td><td style="text-align:center"><strong><a href="https://www.jianshu.com/u/3b1099674c2c" target="_blank" rel="noopener">çœ‹ä¹¦çš„å°èœ—ç‰›</a></strong></td></tr><tr><td style="text-align:center"><strong><a href="https://blog.csdn.net/Gaugamela/article/details/78655546" target="_blank" rel="noopener">ZhangJianIsAStark</a></strong></td><td style="text-align:center"><strong><a href="https://www.jianshu.com/u/8b9c629f69dd" target="_blank" rel="noopener">éš”å£è€æå¤´</a></strong></td></tr></tbody></table><p><br></p><hr><h4 id="Android-ç²¾å“æŠ€æœ¯è´´"><a href="#Android-ç²¾å“æŠ€æœ¯è´´" class="headerlink" title="Android ç²¾å“æŠ€æœ¯è´´"></a><center>Android ç²¾å“æŠ€æœ¯è´´</center></h4><p><br></p><style>table th:first-of-type {    width: 490px;}</style><table><thead><tr><th style="text-align:center"><strong><a href="https://www.cnblogs.com/vincent0519/p/6060114.html" target="_blank" rel="noopener">Android æ€§èƒ½ä¼˜åŒ–æµ…è°ˆ</a></strong></th><th style="text-align:center"><strong><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2017/0526/7973.html" target="_blank" rel="noopener">31ä¸ª Android å¼€å‘å·¥å…·</a></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><a href="https://meedamian.com/post/deuglifying-android-studio/" target="_blank" rel="noopener">Making Android Studio pretty</a></strong></td><td style="text-align:center"><strong><a href="https://blog.csdn.net/QQxiaoqiang1573/article/details/72903237" target="_blank" rel="noopener">Android Studio å¯¼å…¥æ•´ä¸ª Android ç³»ç»Ÿæºç </a></strong></td></tr><tr><td style="text-align:center"><strong><a href="https://github.com/BolexLiu/AutoEx" target="_blank" rel="noopener">å¸®åŠ© Android å¼€å‘è€…ï¼Œè‡ªåŠ¨å¯»æ‰¾ Stack Overflow çš„è§£å†³æ–¹æ¡ˆ</a></strong></td><td style="text-align:center"><strong><a href="https://androidweekly.cn/" target="_blank" rel="noopener">Android å¼€å‘æŠ€æœ¯å‘¨æŠ¥</a></strong></td></tr></tbody></table><p><br></p><p><br></p><hr><h4 id="Linux-ä¸“åŒº"><a href="#Linux-ä¸“åŒº" class="headerlink" title="Linux ä¸“åŒº"></a><center>Linux ä¸“åŒº</center></h4><p><br></p><style>table th:first-of-type {    width: 490px;}</style><table><thead><tr><th style="text-align:center"><strong><a href="http://linux.vbird.org/" target="_blank" rel="noopener">é¸Ÿå“¥çš„ Linux ç§æˆ¿èœ</a></strong></th><th style="text-align:center"><strong><a href="https://blog.csdn.net/u010746357/article/details/81813739" target="_blank" rel="noopener">Ubuntu é¢‘ç¹å¡æ­»è§£å†³</a></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><a href="https://www.cnblogs.com/wmr95/p/7574615.html" target="_blank" rel="noopener">Ubuntu16.04 å®‰è£… Teamviewer</a></strong></td><td style="text-align:center"><strong>â€¦ â€¦</strong></td></tr></tbody></table><p><br></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®˜æ–¹èµ„æ–™ </tag>
            
            <tag> ä¼˜ç§€åšä¸» </tag>
            
            <tag> å¹²è´§èµ„æº </tag>
            
            <tag> å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åšå®¢æ—¥å¿—</title>
      <link href="/2019/12/29/00.thinking-in-android-03.xiu-gai-ri-zhi/"/>
      <url>/2019/12/29/00.thinking-in-android-03.xiu-gai-ri-zhi/</url>
      
        <content type="html"><![CDATA[<h4 id="Thinking-in-Android-â€“-â€œæ–°å¢â€"><a href="#Thinking-in-Android-â€“-â€œæ–°å¢â€" class="headerlink" title="Thinking in Android â€“ â€œæ–°å¢â€"></a><center>Thinking in Android â€“ â€œæ–°å¢â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center">æ—¥æœŸ</th><th style="text-align:center">æ–°å¢åšæ–‡</th></tr></thead><tbody><tr><td style="text-align:center">2019.05.26</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šè°ˆè°ˆ ANR ä¹‹ Input è¶…æ—¶ã€‹ </font></td></tr><tr><td style="text-align:center">2019.05.10</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šè°ˆè°ˆ ANR ä¹‹ Broadcast è¶…æ—¶ã€‹ </font></td></tr><tr><td style="text-align:center">2019.04.29</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šè°ˆè°ˆ ANR ä¹‹ Service è¶…æ—¶ã€‹ </font></td></tr><tr><td style="text-align:center">2019.04.24</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šåº”ç”¨ ANR åˆ†æå®å½•ã€‹ </font></td></tr><tr><td style="text-align:center">2019.04.23</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šâ€œäº‹ä»¶åˆ†å‘æœºåˆ¶â€ - é¢è¯•é¢˜é›†ã€‹ </font></td></tr><tr><td style="text-align:center">2019.04.15</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠAndroid æ—¥å¸¸å¼€å‘é—®é¢˜æ€»ç»“ã€‹ </font></td></tr><tr><td style="text-align:center">2019.04.01</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥è§£è¯» GMS è®¤è¯ã€‹ </font></td></tr><tr><td style="text-align:center">2019.03.01</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šè°ˆè°ˆç®—æ³•ä¸­çš„ â€œæ—¶é—´å¤æ‚åº¦ã€‹ </font></td></tr><tr><td style="text-align:center">2019.02.06</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ8ï¼‰- APK å®‰è£…ï¼ˆä¸‹ï¼‰ã€‹ </font></td></tr><tr><td style="text-align:center">2019.02.01</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ7ï¼‰- APK å®‰è£…ï¼ˆä¸­ï¼‰ã€‹ </font></td></tr><tr><td style="text-align:center">2019.01.26</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…ï¼ˆä¸Šï¼‰ã€‹ </font></td></tr><tr><td style="text-align:center">2019.01.22</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ5ï¼‰- PackageParserã€‹ </font></td></tr><tr><td style="text-align:center">2019.01.16</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstallerã€‹ </font></td></tr><tr><td style="text-align:center">2019.01.12</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManagerã€‹ </font></td></tr><tr><td style="text-align:center">2019.01.05</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°ã€‹ </font></td></tr><tr><td style="text-align:center">2019.01.01</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠPackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹ã€‹ </font></td></tr><tr><td style="text-align:center">2018.12.26</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨å’ŒåŠ è½½ã€‹ </font></td></tr><tr><td style="text-align:center">2018.12.18</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserverã€‹ </font></td></tr><tr><td style="text-align:center">2018.12.10</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygoteã€‹ </font></td></tr><tr><td style="text-align:center">2018.12.01</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ initã€‹ </font></td></tr><tr><td style="text-align:center">2018.11.20</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Binderï¼ˆåŸºç¡€ç¯‡ï¼‰ã€‹ </font></td></tr><tr><td style="text-align:center">2018.11.10</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ JNIã€‹ </font></td></tr><tr><td style="text-align:center">2018.11.01</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ LowMemoryKillerã€‹ </font></td></tr><tr><td style="text-align:center">2018.09.26</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ äº‹ä»¶åˆ†å‘ã€‹ </font></td></tr><tr><td style="text-align:center">2018.09.13</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Handlerï¼ˆåŸç†ç¯‡ï¼‰ã€‹ </font></td></tr><tr><td style="text-align:center">2018.09.10</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Handlerï¼ˆç”¨æ³•ç¯‡ï¼‰ã€‹ </font></td></tr><tr><td style="text-align:center">2018.09.03</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šå¸¦ä½ é¢†ç•¥ Android å†…å­˜æ³„æ¼çš„å‰ä¸–ä»Šç”Ÿã€‹ </font></td></tr><tr><td style="text-align:center">2018.08.20</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ è¿›ç¨‹è¢«æ€ã€‹ </font></td></tr><tr><td style="text-align:center">2018.08.10</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android è®¾è®¡æ¨¡å¼ ä¹‹ å•ä¾‹æ¨¡å¼ã€‹ </font></td></tr><tr><td style="text-align:center">2018.08.08</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€ŠAsyncTask è¯¦è§£ï¼ˆç”¨æ³•ç¯‡ï¼‰ã€‹ </font></td></tr><tr><td style="text-align:center">2018.08.06</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæµ…æå¤šçº¿ç¨‹ä¸­çš„ â€œåŒæ­¥â€ å’Œ â€œæ­»é”â€ã€‹ </font></td></tr><tr><td style="text-align:center">2018.07.28</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ¢è®¨ â€œåŠ¨æ€å¹¿æ’­â€ å’Œ â€œé™æ€å¹¿æ’­â€ çš„ç”¨æ³•å’ŒåŒºåˆ«ã€‹ </font></td></tr><tr><td style="text-align:center">2018.07.25</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ¢è®¨ Service çš„ä½¿ç”¨æ–¹æ³•ã€‹ </font></td></tr><tr><td style="text-align:center">2018.07.22</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ¢è®¨ Fragment çš„ç”Ÿå‘½å‘¨æœŸã€‹ </font></td></tr><tr><td style="text-align:center">2018.07.20</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ¢è®¨ Activity çš„ç”Ÿå‘½å‘¨æœŸã€‹ </font></td></tr><tr><td style="text-align:center">2018.07.18</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ¢è®¨ Activity çš„å¯åŠ¨æ¨¡å¼ã€‹ </font></td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œä¿®è®¢â€"><a href="#Thinking-in-Android-â€“-â€œä¿®è®¢â€" class="headerlink" title="Thinking in Android â€“ â€œä¿®è®¢â€"></a><center>Thinking in Android â€“ â€œä¿®è®¢â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center">æ—¥æœŸ</th><th style="text-align:center">ä¿®è®¢åšæ–‡</th><th style="text-align:center">ç»†èŠ‚è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:center">2019.04.24</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šâ€œäº‹ä»¶åˆ†å‘æœºåˆ¶â€ - é¢è¯•é¢˜é›†ã€‹ </font></td><td style="text-align:center">æ–°å¢é¢è¯•é¢˜</td></tr><tr><td style="text-align:center">2019.04.23</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ äº‹ä»¶åˆ†å‘ã€‹</font></td><td style="text-align:center">æ›´åŠ ç»†åŒ–æºç æµç¨‹</td></tr><tr><td style="text-align:center">2019.02.02</td><td style="text-align:center"><font color="#87CEEB" size="3"> ã€Šè°ˆè°ˆç®—æ³•ä¸­çš„ â€œæ—¶é—´å¤æ‚åº¦â€ã€‹ </font></td><td style="text-align:center">ä¼˜åŒ–ç»†èŠ‚</td></tr></tbody></table><p><br></p><h4 id="Thinking-in-Android-â€“-â€œä¼˜åŒ–â€"><a href="#Thinking-in-Android-â€“-â€œä¼˜åŒ–â€" class="headerlink" title="Thinking in Android â€“ â€œä¼˜åŒ–â€"></a><center>Thinking in Android â€“ â€œä¼˜åŒ–â€</center></h4><p><br></p><table><thead><tr><th style="text-align:center">æ—¥æœŸ</th><th style="text-align:center">ä¿®æ”¹è®°å½• </th></tr></thead><tbody><tr><td style="text-align:center">2019.04.23</td><td style="text-align:center"><font color="#87CEEB" size="3">UI ç»†èŠ‚ä¼˜åŒ–</font></td></tr><tr><td style="text-align:center">2019.04.14</td><td style="text-align:center"><font color="#87CEEB" size="3">é‡æ„åšå®¢å¸ƒå±€åŠæ–‡ç« </font></td></tr><tr><td style="text-align:center">2019.01.24</td><td style="text-align:center"><font color="#87CEEB" size="3">ä¼˜åŒ–å¸ƒå±€ï¼Œå¯¼èˆªæ æ–°å¢é¡¹</font></td></tr><tr><td style="text-align:center">2019.01.07</td><td style="text-align:center"><font color="#87CEEB" size="3">Blogè®¡åˆ’æ›´æ–°ï¼Œéƒ¨åˆ†ç»†èŠ‚ä¼˜åŒ–</font></td></tr><tr><td style="text-align:center">2019.01.02</td><td style="text-align:center"><font color="#87CEEB" size="3">å±€éƒ¨ä¿®æ”¹UIç»†èŠ‚</font></td></tr><tr><td style="text-align:center">2018.12.29</td><td style="text-align:center"><font color="#87CEEB" size="3">æ–°å¢ Links é¡µï¼Œå±€éƒ¨ä¿®æ”¹UIç»†èŠ‚</font></td></tr><tr><td style="text-align:center">2018.12.13</td><td style="text-align:center"><font color="#87CEEB" size="3">å…³äºä½œè€…é¡µé¢ â€“ ä¸»é¢˜ä¼˜åŒ–</font></td></tr><tr><td style="text-align:center">2018.12.11</td><td style="text-align:center"><font color="#87CEEB" size="3">ä¼˜åŒ– Blog â€“ æ ‡ç­¾é¡µ</font></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><font color="#87CEEB" size="3">ä¼˜åŒ– Blog â€“ ç›®å½•é¡µ</font></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><font color="#87CEEB" size="3">æ–°å¢ Blog â€“   æ—¶é—´æºè¿½æº¯</font></td></tr><tr><td style="text-align:center">2018.12.03</td><td style="text-align:center"><font color="#87CEEB" size="3">Blog ä¸»é¢˜æ”¹ç‰ˆ â€“ å¡ç‰‡å¼é£æ ¼</font></td></tr><tr><td style="text-align:center">2018.07.01</td><td style="text-align:center"><font color="#87CEEB" size="3">ã€ŠThinking in Androidã€‹åšå®¢å¯ç¨‹</font></td></tr></tbody></table><p><br></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ä¼˜åŒ– </tag>
            
            <tag> ä¿®è®¢è®°å½• </tag>
            
            <tag> æ–¹å‘è§„åˆ’ </tag>
            
            <tag> æ—¥å¿— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è°ˆè°ˆ ANR ä¹‹ Input è¶…æ—¶</title>
      <link href="/2019/05/26/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-input-chao-shi/"/>
      <url>/2019/05/26/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-input-chao-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="1-æ ¸å¿ƒæºç "><a href="#1-æ ¸å¿ƒæºç " class="headerlink" title="1. æ ¸å¿ƒæºç "></a>1. æ ¸å¿ƒæºç </h1><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„ï¼ˆ/frameworks/base/ï¼‰</th></tr></thead><tbody><tr><td><font color="#D15FEE">ActiveServices.java</font></td><td>services/core/java/com/android/server/am/ActiveServices.java</td></tr><tr><td><font color="#D15FEE">ActivityManagerService.java</font></td><td>services/core/java/com/android/server/am/ActivityManagerService.java</td></tr><tr><td><font color="#D15FEE">AppErrors.java</font></td><td>services/core/java/com/android/server/am/AppErrors.java</td></tr><tr><td><font color="#D15FEE">BroadcastQueue.java</font></td><td>services/core/java/com/android/server/am/BroadcastQueue.java</td></tr></tbody></table><p><br></p><hr><h1 id="2-ANR-åŸºç¡€è®¤çŸ¥"><a href="#2-ANR-åŸºç¡€è®¤çŸ¥" class="headerlink" title="2. ANR åŸºç¡€è®¤çŸ¥"></a>2. ANR åŸºç¡€è®¤çŸ¥</h1><h2 id="2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><strong><font color="#FF00FF">ANR(Application Not Responding)</font></strong>ï¼Œåº”ç”¨ç¨‹åºæ— å“åº”ï¼Œç®€å•ä¸€ä¸ªå®šä¹‰ï¼Œå´æ¶µç›–äº†å¾ˆå¤š Android ç³»ç»Ÿçš„è®¾è®¡æ€æƒ³ã€‚</p><p>é¦–å…ˆï¼Œ<font color="#0000FF">ANR å±äºåº”ç”¨ç¨‹åºçš„èŒƒç•´</font>ï¼Œè¿™ä¸åŒäº SNR(System Not Respoding)ï¼ŒSNR åæ˜ çš„é—®é¢˜æ˜¯ç³»ç»Ÿè¿›ç¨‹(system_server)å¤±å»äº†å“åº”èƒ½åŠ›ï¼Œè€Œ ANR æ˜ç¡®å°†é—®é¢˜åœˆå®šåœ¨åº”ç”¨ç¨‹åºã€‚<strong><code>SNR ç”± Watchdog æœºåˆ¶ä¿è¯ï¼ŒANR ç”±æ¶ˆæ¯å¤„ç†æœºåˆ¶ä¿è¯</code></strong>ï¼ŒAndroid åœ¨ç³»ç»Ÿå±‚å®ç°äº†ä¸€å¥—ç²¾å¯†çš„æœºåˆ¶æ¥å‘ç° ANRï¼Œæ ¸å¿ƒåŸç†æ˜¯<strong><code>æ¶ˆæ¯è°ƒåº¦</code></strong>å’Œ<strong><code>è¶…æ—¶å¤„ç†</code></strong>ã€‚</p><p>å…¶æ¬¡ï¼ŒANR æœºåˆ¶<strong><code>ä¸»ä½“å®ç°åœ¨ç³»ç»Ÿå±‚</code></strong>ã€‚æ‰€æœ‰ä¸ ANR ç›¸å…³çš„æ¶ˆæ¯ï¼Œéƒ½ä¼šç»è¿‡ç³»ç»Ÿè¿›ç¨‹(system_server)è°ƒåº¦ï¼Œç„¶åæ´¾å‘åˆ°åº”ç”¨è¿›ç¨‹å®Œæˆå¯¹æ¶ˆæ¯çš„å®é™…å¤„ç†ï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿè¿›ç¨‹è®¾è®¡äº†ä¸åŒçš„è¶…æ—¶é™åˆ¶æ¥è·Ÿè¸ªæ¶ˆæ¯çš„å¤„ç†ã€‚ä¸€æ—¦åº”ç”¨ç¨‹åºå¤„ç†æ¶ˆæ¯ä¸å½“ï¼Œè¶…æ—¶é™åˆ¶å°±èµ·ä½œç”¨äº†ï¼Œå®ƒæ”¶é›†ä¸€äº›ç³»ç»ŸçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šCPU/IOä½¿ç”¨æƒ…å†µã€è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆï¼Œå¹¶ä¸”æŠ¥å‘Šç”¨æˆ·æœ‰è¿›ç¨‹<strong><code>æ— å“åº”äº†ï¼ˆANR å¯¹è¯æ¡†ï¼‰</code></strong>ã€‚</p><p>ç„¶åï¼ŒANR é—®é¢˜<strong><code>æœ¬è´¨æ˜¯ä¸€ä¸ªæ€§èƒ½é—®é¢˜</code></strong>ã€‚ANR æœºåˆ¶å®é™…ä¸Šå¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„é™åˆ¶ï¼Œè¦æ±‚ä¸»çº¿ç¨‹åœ¨é™å®šçš„æ—¶é—´å†…å¤„ç†å®Œä¸€äº›æœ€å¸¸è§çš„æ“ä½œ(å¯åŠ¨æœåŠ¡ã€å¤„ç†å¹¿æ’­ã€å¤„ç†è¾“å…¥)ï¼Œå¦‚æœå¤„ç†è¶…æ—¶ï¼Œåˆ™è®¤ä¸ºä¸»çº¿ç¨‹å·²ç»å¤±å»äº†å“åº”å…¶ä»–æ“ä½œçš„èƒ½åŠ›ã€‚ä¸»çº¿ç¨‹ä¸­çš„<strong><code>è€—æ—¶æ“ä½œ</code></strong>ï¼Œä¾‹å¦‚ï¼šå¯†é›†CPUè¿ç®—ã€å¤§é‡IOã€å¤æ‚ç•Œé¢å¸ƒå±€ç­‰ï¼Œéƒ½ä¼šé™ä½åº”ç”¨ç¨‹åºçš„å“åº”èƒ½åŠ›ã€‚</p><p>æœ€åï¼Œéƒ¨åˆ† ANR é—®é¢˜æ˜¯å¾ˆéš¾åˆ†æçš„ï¼Œæœ‰æ—¶å€™ç”±äºç³»ç»Ÿåº•å±‚çš„ä¸€äº›å½±å“ï¼Œå¯¼è‡´æ¶ˆæ¯è°ƒåº¦å¤±è´¥ï¼Œå‡ºç°é—®é¢˜çš„åœºæ™¯åˆéš¾ä»¥å¤ç°ã€‚è¿™ç±» ANR é—®é¢˜å¾€å¾€éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´å»äº†è§£ç³»ç»Ÿçš„ä¸€äº›è¡Œä¸ºï¼Œè¶…å‡ºäº† ANR æœºåˆ¶æœ¬èº«çš„èŒƒç•´ã€‚</p><h2 id="2-2-ANR-æœºåˆ¶"><a href="#2-2-ANR-æœºåˆ¶" class="headerlink" title="2.2 ANR æœºåˆ¶"></a>2.2 ANR æœºåˆ¶</h2><p>åˆ†æä¸€äº›åˆçº§çš„ ANR é—®é¢˜ï¼Œåªéœ€è¦ç®€å•ç†è§£æœ€ç»ˆè¾“å‡ºçš„æ—¥å¿—å³å¯ï¼Œä½†å¯¹äºä¸€äº›ç”±ç³»ç»Ÿé—®é¢˜(ä¾‹å¦‚ï¼šCPU è´Ÿè½½è¿‡é«˜ã€è¿›ç¨‹å¡æ­»)å¼•å‘çš„ ANRï¼Œå°±éœ€è¦å¯¹æ•´ä¸ª ANR æœºåˆ¶æœ‰æ‰€äº†è§£ï¼Œæ‰èƒ½å®šä½å‡ºé—®é¢˜çš„åŸå› ã€‚</p><p><strong><font color="#FF0000" size="3">ANR æœºåˆ¶å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„ç›‘æµ‹</strong>ï¼šAndroid å¯¹äºä¸åŒçš„ ANR ç±»å‹(Broadcastï¼ŒServiceï¼ŒInputEvent)éƒ½æœ‰ä¸€å¥—ç›‘æµ‹æœºåˆ¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„æŠ¥å‘Š</strong>ï¼šåœ¨ç›‘æµ‹åˆ° ANR ä»¥åï¼Œéœ€è¦æ˜¾ç¤º ANR å¯¹è¯æ¡†ã€è¾“å‡ºæ—¥å¿—(å‘ç”Ÿ ANR æ—¶çš„è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆã€CPU ä½¿ç”¨æƒ…å†µç­‰)ã€‚</p><h2 id="2-3-ANR-çš„è§¦å‘åŸå› "><a href="#2-3-ANR-çš„è§¦å‘åŸå› " class="headerlink" title="2.3 ANR çš„è§¦å‘åŸå› "></a>2.3 ANR çš„è§¦å‘åŸå› </h2><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œå‡ºç° ANR ä¹‹åä¸€ä¸ªç›´è§‚ç°è±¡å°±æ˜¯ç³»ç»Ÿä¼šå±•ç¤ºå‡ºä¸€ä¸ª ANR å¯¹è¯æ¡†ã€‚</p><p><strong><font color="#FF0000" size="3">è°·æ­Œæ–‡æ¡£ä¸­å¯¹ ANR äº§ç”Ÿçš„åŸå› æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</font></strong></p><p>Android ç³»ç»Ÿä¸­çš„åº”ç”¨è¢« <code>ActivityManagerService</code> åŠ <code>WindowManagerService</code> ä¸¤ä¸ªç³»ç»ŸæœåŠ¡ç›‘æ§ç€ï¼Œç³»ç»Ÿä¼šåœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µå±•ç¤ºå‡º ANR çš„å¯¹è¯æ¡†ï¼</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">KeyDispatchTimeout</font>&nbsp;(<font color="#FF0000"> 5 seconds</font> ) ï¼šæŒ‰é”®æˆ–è§¦æ‘¸äº‹ä»¶åœ¨ç‰¹å®šæ—¶é—´å†…æ— å“åº”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">BroadcastTimeout</font>&nbsp;(<font color="#FF0000"> 10 seconds</font> )ï¼šBroadcastReceiver åœ¨ç‰¹å®šæ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">ServiceTimeout</font>&nbsp;(<font color="#FF0000"> 20 seconds</font> ) ï¼šService åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ</p><h1 id="3-ANR-çš„ç›‘æµ‹æœºåˆ¶"><a href="#3-ANR-çš„ç›‘æµ‹æœºåˆ¶" class="headerlink" title="3. ANR çš„ç›‘æµ‹æœºåˆ¶"></a>3. ANR çš„ç›‘æµ‹æœºåˆ¶</h1><h2 id="3-3-Input-è¶…æ—¶å¤„ç†"><a href="#3-3-Input-è¶…æ—¶å¤„ç†" class="headerlink" title="3.3 Input è¶…æ—¶å¤„ç†"></a>3.3 Input è¶…æ—¶å¤„ç†</h2><p>åº”ç”¨ç¨‹åºå¯ä»¥æ¥æ”¶è¾“å…¥äº‹ä»¶(æŒ‰é”®ã€è§¦å±ã€è½¨è¿¹çƒç­‰)ï¼Œå½“ <strong><font color="#FF0000">5ç§’</font></strong> å†…æ²¡æœ‰å¤„ç†å®Œæ¯•æ—¶ï¼Œåˆ™ä¼šå¼•å‘ ANRã€‚</p><p><strong><font color="#7FF000" size="3">å’Œåˆ†æ Broadcast ANR ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆæŠ›å‡º Input ANR ä¸¤ä¸ªé—®é¢˜ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ è¾“å…¥äº‹ä»¶ç»å†äº†ä¸€äº›ä»€ä¹ˆå·¥åºæ‰èƒ½è¢«æ´¾å‘åˆ°åº”ç”¨çš„ç•Œé¢ï¼Ÿ</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ å¦‚ä½•æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p><h3 id="è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº"><a href="#è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº" class="headerlink" title="è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº"></a>è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº</h3><p>è¾“å…¥äº‹ä»¶æœ€å¼€å§‹ç”±ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚æŒ‰é”®æˆ–è§¦æ‘¸å±å¹•ï¼‰å‘èµ·ï¼ŒAndroid æœ‰ä¸€å¥—è¾“å…¥å­ç³»ç»Ÿæ¥å‘ç°å„ç§è¾“å…¥äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶æœ€ç»ˆéƒ½ä¼šè¢« <font color="#FF00FF">InputDispatcher</font> åˆ†å‘åˆ°å„ä¸ªéœ€è¦æ¥æ”¶äº‹ä»¶çš„çª—å£ã€‚é‚£ä¹ˆï¼Œçª—å£å¦‚ä½•å‘Šä¹‹ InputDispatcher è‡ªå·±éœ€è¦å¤„ç†è¾“å…¥äº‹ä»¶å‘¢ï¼ŸAndroid é€šè¿‡ <font color="#FF00FF">InputChannel</font> è¿æ¥ InputDispatcher å’Œçª—å£ï¼Œ<font color="#FF7F24">InputChannel å…¶å®æ˜¯å°è£…åçš„ Linuxç®¡é“(Pipe)ã€‚æ¯ä¸€ä¸ªçª—å£éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„ InputChannel ï¼Œçª—å£éœ€è¦å°†è¿™ä¸ª InputChannel æ³¨å†Œåˆ° InputDispatcher ä¸­</font>:</p><pre class=" language-cpp"><code class="language-cpp">status_t InputDispatcher<span class="token operator">::</span><span class="token function">registerInputChannel</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputChannel<span class="token operator">></span><span class="token operator">&amp;</span> inputChannel<span class="token punctuation">,</span>        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> inputWindowHandle<span class="token punctuation">,</span> <span class="token keyword">bool</span> monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    sp<span class="token operator">&lt;</span>Connection<span class="token operator">></span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Connection</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">,</span> inputWindowHandle<span class="token punctuation">,</span> monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> inputChannel<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mConnectionsByFd<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ALOOPER_EVENT_INPUT<span class="token punctuation">,</span> handleReceiveCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> OK<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å¯¹äº InputDispatcher è€Œè¨€ï¼Œæ¯æ³¨å†Œä¸€ä¸ª InputChannel éƒ½è¢«è§†ä¸ºä¸€ä¸ª Connection ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥åŒºåˆ«ã€‚InputDispatcher æ˜¯ä¸€ä¸ªæ¶ˆæ¯å¤„ç†å¾ªç¯ï¼Œå½“æœ‰æ–°çš„ Connection æ—¶ï¼Œå°±éœ€è¦å”¤é†’æ¶ˆæ¯å¾ªç¯é˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚</p><p>è¾“å…¥äº‹ä»¶çš„ç±»å‹æœ‰å¾ˆå¤šï¼ŒæŒ‰é”®ã€è½¨è¿¹çƒã€è§¦å±ç­‰ï¼ŒAndroid å¯¹è¿™äº›äº‹ä»¶è¿›è¡Œäº†åˆ†ç±»ï¼Œå¤„ç†è¿™äº›äº‹ä»¶çš„çª—å£ä¹Ÿè¢«èµ‹äºˆäº†ä¸€ä¸ªç±»å‹(targetType)ï¼šFoucused æˆ– Touchedã€‚</p><p>å¦‚æœå½“å‰è¾“å…¥äº‹ä»¶æ˜¯æŒ‰é”®ç±»å‹ï¼Œåˆ™å¯»æ‰¾ Focused ç±»å‹çš„çª—å£ã€‚å¦‚æœå½“å‰è¾“å…¥äº‹ä»¶ç±»å‹æ˜¯è§¦æ‘¸ç±»å‹ï¼Œåˆ™å¯»æ‰¾ Touched ç±»å‹çš„çª—å£ã€‚</p><p>InputDispatcher éœ€è¦ç»è¿‡ä»¥ä¸‹å¤æ‚çš„è°ƒç”¨å…³ç³»ï¼Œæ‰èƒ½æŠŠä¸€ä¸ªè¾“å…¥äº‹ä»¶æ´¾å‘å‡ºå»(è°ƒç”¨å…³ç³»ä»¥æŒ‰é”®äº‹ä»¶ä¸ºä¾‹ï¼Œè§¦å±äº‹ä»¶çš„è°ƒç”¨å…³ç³»ç±»ä¼¼)ï¼š</p><pre><code>InputDispatcherThread::threadLoop()â””â”€â”€ InputDispatcher::dispatchOnce()    â””â”€â”€ InputDispatcher::dispatchOnceInnerLocked()        â””â”€â”€ InputDispatcher::dispatchKeyLocked()            â””â”€â”€ InputDispatcher::dispatchEventLocked()                â””â”€â”€ InputDispatcher::prepareDispatchCycleLocked()                    â””â”€â”€ InputDispatcher::enqueueDispatchEntriesLocked()                        â””â”€â”€ InputDispatcher::startDispatchCycleLocked()                            â””â”€â”€ InputPublisher::publishKeyEvent()</code></pre><p>å…·ä½“æ¯ä¸ªå‡½æ•°çš„å®ç°é€»è¾‘æ­¤å¤„ä¸è¡¨ã€‚æˆ‘ä»¬æç‚¼å‡ºå‡ ä¸ªå…³é”®ç‚¹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ InputDispatcherThread æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒå¤„ç†ä¸€æ¬¡æ¶ˆæ¯çš„æ´¾å‘ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ è¾“å…¥äº‹ä»¶ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ï¼Œéœ€è¦æ’é˜Ÿç­‰å¾…æ´¾å‘ï¼Œæ¯ä¸€ä¸ª Connection éƒ½ç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼š<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Â· outboundQueue: ç­‰å¾…å‘é€ç»™çª—å£çš„äº‹ä»¶ã€‚æ¯ä¸€ä¸ªæ–°æ¶ˆæ¯åˆ°æ¥ï¼Œéƒ½ä¼šå…ˆè¿›å…¥åˆ°æ­¤é˜Ÿåˆ—ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Â· waitQueue: å·²ç»å‘é€ç»™çª—å£çš„äº‹ä»¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ publishKeyEvent å®Œæˆåï¼Œè¡¨ç¤ºäº‹ä»¶å·²ç»æ´¾å‘äº†ï¼Œå°±å°†äº‹ä»¶ä» outboundQueue æŒªåˆ°äº† waitQueueã€‚</p><p>äº‹ä»¶ç»è¿‡è¿™ä¹ˆä¸€è½®å¤„ç†ï¼Œå°±ç®—æ˜¯ä» InputDispatcher æ´¾å‘å‡ºå»äº†ï¼Œä½†äº‹ä»¶æ˜¯ä¸æ˜¯è¢«çª—å£æ”¶åˆ°äº†ï¼Œè¿˜éœ€è¦ç­‰å¾…æ¥æ”¶æ–¹çš„ <font color="#FF00FF">â€œfinishedâ€</font> é€šçŸ¥ã€‚åœ¨å‘ InputDispatcher æ³¨å†Œ InputChannel çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•° handleReceiveCallback():</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> InputDispatcher<span class="token operator">::</span><span class="token function">handleReceiveCallback</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        status <span class="token operator">=</span> connection<span class="token operator">-</span><span class="token operator">></span>inputPublisher<span class="token punctuation">.</span><span class="token function">receiveFinishedSignal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>seq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handled<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        d<span class="token operator">-</span><span class="token operator">></span><span class="token function">finishDispatchCycleLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> handled<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    d<span class="token operator">-</span><span class="token operator">></span><span class="token function">unregisterInputChannelLocked</span><span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>inputChannel<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å½“æ”¶åˆ°çš„ status ä¸º OK æ—¶ï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">finishDispatchCycleLocked()</font> æ¥å®Œæˆä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ï¼š</p><pre><code>InputDispatcher::finishDispatchCycleLocked()â””â”€â”€ InputDispatcher::onDispatchCycleFinishedLocked()    â””â”€â”€ InputDispatcher::doDispatchCycleFinishedLockedInterruptible()        â””â”€â”€ InputDispatcher::startDispatchCycleLocked()</code></pre><p>è°ƒç”¨åˆ° <font color="#FF00FF">doDispatchCycleFinishedLockedInterruptible()</font> æ–¹æ³•æ—¶ï¼Œä¼šå°†å·²ç»æˆåŠŸæ´¾å‘çš„æ¶ˆæ¯ä» <font color="#FF00FF">waitQueue</font> ä¸­ç§»é™¤ï¼Œ è¿›ä¸€æ­¥è°ƒç”¨ä¼š <font color="#FF00FF">startDispatchCycleLocked</font> å¼€å§‹æ´¾å‘æ–°çš„äº‹ä»¶ã€‚</p><p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</font></strong></p><p><strong><font color="#FF7F24">ä¸€ä¸ªæ­£å¸¸çš„è¾“å…¥äº‹ä»¶ä¼šç»è¿‡ä» outboundQueue æŒªåˆ° waitQueue çš„è¿‡ç¨‹ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»æ´¾å‘å‡ºå»ï¼›å†ç»è¿‡ä» waitQueue ä¸­ç§»é™¤çš„è¿‡ç¨‹ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»è¢«çª—å£æ¥æ”¶ã€‚InputDispatcher ä½œä¸ºä¸­æ¢ï¼Œä¸åœåœ°åœ¨é€’é€ç€è¾“å…¥äº‹ä»¶ï¼Œå½“ä¸€ä¸ªäº‹ä»¶æ— æ³•å¾—åˆ°å¤„ç†çš„æ—¶å€™ï¼ŒInputDispatcher ä¸èƒ½å°±æ­¤æ­»æ‰å•Šï¼Œå¦åˆ™ç³»ç»Ÿä¹Ÿå¤ªå®¹æ˜“å´©æºƒäº†ã€‚InputDispatcher çš„ç­–ç•¥æ˜¯æ”¾å¼ƒæ‰å¤„ç†ä¸è¿‡æ¥çš„äº‹ä»¶ï¼Œå¹¶å‘å‡ºé€šçŸ¥(è¿™ä¸ªé€šçŸ¥æœºåˆ¶å°±æ˜¯ANR)ï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€è½®æ¶ˆæ¯çš„å¤„ç†ã€‚</font></strong></p><p><strong><font color="#FF0000">ç†è§£è¾“å…¥äº‹ä»¶åˆ†å‘æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š</font></strong></p><pre><code>æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶å¯ä»¥æ¯”åšä¸€ä¸ªå¿«é€’ï¼ŒInputDispatcher å°±åƒä¸€ä¸ªå¿«é€’ä¸­è½¬ç«™ï¼Œçª—å£å°±åƒæ˜¯æ”¶ä»¶äººï¼ŒInputChannel å°±åƒæ˜¯å¿«é€’å‘˜ã€‚æ‰€æœ‰å¿«é€’éƒ½ä¼šç»è¿‡ä¸­è½¬ç«™ä¸­å¤„ç†ï¼Œä¸­è½¬ç«™éœ€è¦çŸ¥é“æ¯ä¸€ä¸ªå¿«é€’çš„æ”¶ä»¶äººæ˜¯è°ï¼Œé€šè¿‡å¿«é€’å‘˜å°†å¿«é€’å‘é€åˆ°å…·ä½“çš„æ”¶ä»¶äººã€‚è¿™å…¶ä¸­æœ‰å¾ˆå¤šåœºæ™¯å¯¼è‡´å¿«é€’ä¸èƒ½åŠæ—¶é€åˆ°ï¼šè­¬å¦‚è”ç³»ä¸åˆ°æ”¶ä»¶äºº;å¿«é€’å¾ˆå¤šï¼Œå¿«é€’å‘˜ä¼šå¿™ä¸è¿‡æ¥;å¿«é€’å‘˜å—ä¼¤ä¼‘å‡äº†ç­‰ç­‰â€¦è¿™æ—¶å€™å¿«é€’å‘˜å°±éœ€è¦å‘ŠçŸ¥ä¸­è½¬ç«™ï¼šæœ‰å¿«é€’æ— æ³•åŠæ—¶é€åˆ°äº†ã€‚ä¸­è½¬ç«™åœ¨æ”¶åˆ°å¿«é€’å‘˜çš„é€šçŸ¥åï¼Œä¸€è¾¹ç»§ç»­æ´¾å‘å…¶ä»–å¿«é€’ï¼Œä¸€è¾¹æŠ¥å‘Šä¸Šçº§ã€‚</code></pre><h3 id="æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶"><a href="#æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶" class="headerlink" title="æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶"></a>æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶</h3><p>åœ¨äº†è§£è¾“å…¥äº‹ä»¶åˆ†å‘æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è§è¯†ä¸€ä¸‹ANRæœºåˆ¶äº†ã€‚åœ¨æ´¾å‘äº‹ä»¶æ—¶ï¼Œ<font color="#FF00FF">dispatchKeyLocked()</font> å’Œ <font color="#FF00FF">dispatchMotionLocked()</font>ï¼Œéœ€è¦æ‰¾åˆ°å½“å‰çš„ç„¦ç‚¹çª—å£ï¼Œç„¦ç‚¹çª—å£æ‰æ˜¯æœ€ç»ˆæ¥æ”¶äº‹ä»¶çš„åœ°æ–¹ï¼Œæ‰¾çª—å£çš„è¿‡ç¨‹å°±ä¼šåˆ¤æ–­æ˜¯å¦å·²ç»å‘ç”Ÿäº†ANRï¼š</p><pre><code>InputDispatcher::findFocusedWindowTargetsLocked()InputDispatcher::findTouchedWindowTargetsLocked()â””â”€â”€ InputDispatcher::handleTargetsNotReadyLocked()    â””â”€â”€ InputDispatcher::onANRLocked()        â””â”€â”€ InputDispatcher::doNotifyANRLockedInterruptible()            â””â”€â”€ NativeInputManager::notifyANR()</code></pre><p>ï¼ˆ1ï¼‰é¦–å…ˆï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">findFocusedWindowTargetsLocked()</font> æˆ– <font color="#FF00FF">findTouchedWindowTargetsLocked()</font> å¯»æ‰¾æ¥æ”¶è¾“å…¥äº‹ä»¶çš„çª—å£ã€‚</p><p>åœ¨æ‰¾åˆ°çª—å£ä»¥åï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">checkWindowReadyForMoreInputLocked()</font> æ£€æŸ¥çª—å£æ˜¯å¦æœ‰èƒ½åŠ›å†æ¥æ”¶æ–°çš„è¾“å…¥äº‹ä»¶ï¼Œä¼šæœ‰ä¸€ç³»åˆ—çš„åœºæ™¯é˜»ç¢äº‹ä»¶çš„ç»§ç»­æ´¾å‘ï¼š</p><p><strong><font color="#7FF000" size="3">åœºæ™¯1: çª—å£å¤„äºpausedçŠ¶æ€ï¼Œä¸èƒ½å¤„ç†è¾“å…¥äº‹ä»¶</font></strong></p><p>â€œWaiting because the [targetType] window is paused.â€</p><p><strong><font color="#7FF000" size="3">åœºæ™¯2: çª—å£è¿˜æœªå‘InputDispatcheræ³¨å†Œï¼Œæ— æ³•å°†äº‹ä»¶æ´¾å‘åˆ°çª—å£</font></strong></p><p>â€œWaiting because the [targetType] windowâ€™s input channel is not registered with the input dispatcher. The window may be in the process of being removed.â€</p><p><strong><font color="#7FF000" size="3">åœºæ™¯3: çª—å£å’ŒInputDispatcherçš„è¿æ¥å·²ç»ä¸­æ–­ï¼Œå³InputChannelä¸èƒ½æ­£å¸¸å·¥ä½œ</font></strong></p><p>â€œWaiting because the [targetType] windowâ€™s input connection is [status]. The window may be in the process of being removed.â€</p><p><strong><font color="#7FF000" size="3">åœºæ™¯4: InputChannelå·²ç»é¥±å’Œï¼Œä¸èƒ½å†å¤„ç†æ–°çš„äº‹ä»¶</font></strong></p><p>â€œWaiting because the [targetType] windowâ€™s input channel is full. Outbound queue length: %d. Wait queue length: %d.â€</p><p><strong><font color="#7FF000" size="3">åœºæ™¯5: å¯¹äºæŒ‰é”®ç±»å‹(KeyEvent)çš„è¾“å…¥äº‹ä»¶ï¼Œéœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªäº‹ä»¶å¤„ç†å®Œæ¯•</font></strong></p><p>â€œWaiting to send key event because the [targetType] window has not finished processing all of the input events that were previously delivered to it. Outbound queue length: %d. Wait queue length: %d.â€</p><p><strong><font color="#7FF000" size="3">åœºæ™¯6: å¯¹äºè§¦æ‘¸ç±»å‹(TouchEvent)çš„è¾“å…¥äº‹ä»¶ï¼Œå¯ä»¥ç«‹å³æ´¾å‘åˆ°å½“å‰çš„çª—å£ï¼Œå› ä¸ºTouchEventéƒ½æ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·å½“å‰å¯è§çš„çª—å£ã€‚ä½†æœ‰ä¸€ç§æƒ…å†µï¼Œ å¦‚æœå½“å‰åº”ç”¨ç”±äºé˜Ÿåˆ—æœ‰å¤ªå¤šçš„è¾“å…¥äº‹ä»¶ç­‰å¾…æ´¾å‘ï¼Œå¯¼è‡´å‘ç”Ÿäº†ANRï¼Œé‚£TouchEventäº‹ä»¶å°±éœ€è¦æ’é˜Ÿç­‰å¾…æ´¾å‘ã€‚</font></strong></p><p>â€œWaiting to send non-key event because the %s window has not finished processing certain input events that were delivered to it over %0.1fms ago. Wait queue length: %d. Wait queue head age: %0.1fms.â€</p><p>ï¼ˆ2ï¼‰ç„¶åï¼Œä¸Šè¿°æœ‰ä»»ä½•ä¸€ä¸ªåœºæ™¯å‘ç”Ÿäº†ï¼Œåˆ™è¾“å…¥äº‹ä»¶éœ€è¦ç»§ç»­ç­‰å¾…ï¼Œç´§æ¥ç€å°±ä¼šè°ƒç”¨ <font color="#FF00FF">handleTargetsNotReadyLocked()</font> æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»çš„ç­‰å¾…è¶…æ—¶äº†ï¼š</p><pre class=" language-cpp"><code class="language-cpp">int32_t InputDispatcher<span class="token operator">::</span><span class="token function">handleTargetsNotReadyLocked</span><span class="token punctuation">(</span>nsecs_t currentTime<span class="token punctuation">,</span>        <span class="token keyword">const</span> EventEntry<span class="token operator">*</span> entry<span class="token punctuation">,</span>        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputApplicationHandle<span class="token operator">></span><span class="token operator">&amp;</span> applicationHandle<span class="token punctuation">,</span>        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> windowHandle<span class="token punctuation">,</span>        nsecs_t<span class="token operator">*</span> nextWakeupTime<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">>=</span> mInputTargetWaitTimeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">onANRLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> applicationHandle<span class="token punctuation">,</span> windowHandle<span class="token punctuation">,</span>            entry<span class="token operator">-</span><span class="token operator">></span>eventTime<span class="token punctuation">,</span> mInputTargetWaitStartTime<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>nextWakeupTime <span class="token operator">=</span> LONG_LONG_MIN<span class="token punctuation">;</span>        <span class="token keyword">return</span> INPUT_EVENT_INJECTION_PENDING<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æœ€åï¼Œå¦‚æœå½“å‰äº‹ä»¶æ´¾å‘å·²ç»è¶…æ—¶ï¼Œåˆ™è¯´æ˜å·²ç»æ£€æµ‹åˆ°äº† ANR ï¼Œè°ƒç”¨ <font color="#FF00FF">onANRLocked()</font> æ–¹æ³•ï¼Œç„¶åå°† <font color="#FF00FF">nextWakeupTime</font> è®¾ç½®ä¸ºæœ€å°å€¼ï¼Œé©¬ä¸Šå¼€å§‹ä¸‹ä¸€è½®è°ƒåº¦ã€‚åœ¨ onANRLocked() æ–¹æ³•ä¸­ï¼Œ ä¼šä¿å­˜ ANR çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œè°ƒç”¨ <font color="#FF00FF">doNotifyANRLockedInterruptible()</font> ï¼Œè¿›ä¸€æ­¥ä¼šè°ƒç”¨åˆ° JNI å±‚çš„ <font color="#FF00FF">NativeInputManager::notifyANR()</font> æ–¹æ³•ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è¡”æ¥ Native å±‚å’Œ Java å±‚ï¼Œç›´æ¥è°ƒç”¨ Java å±‚çš„ <font color="#FF00FF">InputManagerService.notifyANR()</font> æ–¹æ³•ã€‚</p><p><strong><font color="#FF0000">è‡³æ­¤ï¼ŒANRçš„å¤„ç†é€»è¾‘è½¬äº¤åˆ°äº†Javaå±‚ã€‚</font></strong>åº•å±‚(Native)å‘ç°ä¸€æ—¦æœ‰è¾“å…¥äº‹ä»¶æ´¾å‘è¶…æ—¶ï¼Œå°±ä¼šé€šçŸ¥ä¸Šå±‚(Java)ï¼Œä¸Šå±‚æ”¶åˆ°ANRé€šçŸ¥åï¼Œå†³å®šæ˜¯å¦ç»ˆæ­¢å½“å‰è¾“å…¥äº‹ä»¶çš„æ´¾å‘ã€‚</p><p>å‘ç”ŸANRæ—¶ï¼ŒJavaå±‚æœ€å¼€å§‹çš„å…¥å£æ˜¯ <font color="#FF00FF">InputManagerService.notifyANR()</font> ï¼Œå®ƒæ˜¯ç›´æ¥è¢« Native å±‚è°ƒç”¨çš„ã€‚æˆ‘ä»¬å…ˆæŠŠ ANR çš„Javaå±‚è°ƒç”¨å…³ç³»åˆ—å‡ºæ¥ï¼š</p><pre><code>InputManagerService.notifyANR()â””â”€â”€ InputMonitor.notifyANR()    â”œâ”€â”€ IApplicationToken.keyDispatchingTimedOut()    â”‚   â””â”€â”€ ActivityRecord.keyDispatchingTimedOut()    â”‚       â””â”€â”€ AMS.inputDispatchingTimedOut()    â”‚           â””â”€â”€ AMS.appNotResponding()    â”‚    â””â”€â”€ AMS.inputDispatchingTimedOut()        â””â”€â”€ AMS.appNotResponding()</code></pre><p><font color="#FF00FF">InputManagerService.notifyANR()</font> åªæ˜¯ä¸º Nativeå±‚ å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œå®ƒç›´æ¥è°ƒç”¨ <font color="#FF00FF">InputMonitor.notifyANR()</font>ã€‚å¦‚æœè¯¥æ–¹æ³•çš„è¿”å›å€¼ç­‰äº0ï¼Œåˆ™æ”¾å¼ƒæœ¬æ¬¡è¾“å…¥äº‹ä»¶ï¼›å¦‚æœå¤§äº0ï¼Œåˆ™è¡¨ç¤ºéœ€è¦ç»§ç»­ç­‰å¾…çš„æ—¶é—´ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">notifyANR</span><span class="token punctuation">(</span>InputApplicationHandle inputApplicationHandle<span class="token punctuation">,</span>      InputWindowHandle inputWindowHandle<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>appWindowToken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> appWindowToken<span class="token punctuation">.</span>appToken <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// appTokenå®é™…ä¸Šå°±æ˜¯å½“å‰çš„ActivityRecordã€‚</span>        <span class="token comment" spellcheck="true">// å¦‚æœå‘ç”ŸANRçš„Activityè¿˜å­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡ActivityRecordé€šçŸ¥äº‹ä»¶æ´¾å‘è¶…æ—¶</span>        <span class="token keyword">boolean</span> abort <span class="token operator">=</span> appWindowToken<span class="token punctuation">.</span>appToken<span class="token punctuation">.</span><span class="token function">keyDispatchingTimedOut</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> abort<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> appWindowToken<span class="token punctuation">.</span>inputDispatchingTimeoutNanos<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœå‘ç”ŸANRçš„Activityå·²ç»é”€æ¯äº†ï¼Œåˆ™é€šè¿‡AMSé€šçŸ¥äº‹ä»¶æ´¾å‘è¶…æ—¶</span>        <span class="token keyword">long</span> timeout <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>                        windowState<span class="token punctuation">.</span>mSession<span class="token punctuation">.</span>mPid<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>         <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// abort dispatching</span><span class="token punctuation">}</span></code></pre><p>ä¸Šè¿°æ–¹æ³•ä¸­æœ‰ä¸¤ç§ä¸åŒçš„è°ƒç”¨æ–¹å¼ï¼Œä½†æœ€ç»ˆéƒ½ä¼šäº¤ç”± <font color="#FF00FF">AMS.inputDispatchingTimedOut()</font> å¤„ç†ã€‚AMS æœ‰é‡è½½çš„ <font color="#FF00FF">inputDispatchingTimedOut()</font> æ–¹æ³•ï¼Œä»–ä»¬çš„å‚æ•°ä¸ä¸€æ ·ã€‚ActivityRecord è°ƒç”¨æ—¶ï¼Œå¯ä»¥ä¼ å…¥çš„ä¿¡æ¯æ›´å¤šä¸€ç‚¹(å½“å‰å‘ç”ŸANRçš„ç•Œé¢æ˜¯å“ªä¸€ä¸ª)ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1. æ ¹æ®è¿›ç¨‹å·è·å–åˆ°ProcessRecord</span>    proc <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// 2. è·å–è¶…æ—¶æ—¶é—´</span>    <span class="token comment" spellcheck="true">// æµ‹è¯•ç¯å¢ƒä¸‹çš„è¶…æ—¶æ—¶é—´æ˜¯INSTRUMENTATION_KEY_DISPATCHING_TIMEOUT(60ç§’)ï¼Œ</span>    <span class="token comment" spellcheck="true">// æ­£å¸¸ç¯å¢ƒä¸‹çš„è¶…æ—¶æ—¶é—´æ˜¯KEY_DISPATCHING_TIMEOUT(5ç§’)</span>    timeout <span class="token operator">=</span> <span class="token function">getInputDispatchingTimeoutLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨é‡è½½çš„å‡½æ•°ï¼Œå¦‚æœè¿”å›Trueï¼Œåˆ™è¡¨ç¤ºéœ€è¦ä¸­æ–­å½“å‰çš„äº‹ä»¶æ´¾å‘;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 3. è¿”å›ç»§ç»­ç­‰å¾…çš„æ—¶é—´ï¼Œè¿™ä¸ªå€¼ä¼šä¼ é€’åˆ°Nativeå±‚</span>    <span class="token keyword">return</span> timeout<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">final</span> ProcessRecord proc<span class="token punctuation">,</span>        <span class="token keyword">final</span> ActivityRecord activity<span class="token punctuation">,</span> <span class="token keyword">final</span> ActivityRecord parent<span class="token punctuation">,</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// 1. å‘ç”ŸANRè¿›ç¨‹æ­£å¤„äºè°ƒè¯•çŠ¶æ€ï¼Œä¸éœ€è¦ä¸­æ–­äº‹ä»¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>debugging<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 2. å½“å‰æ­£åœ¨åšdexoptæ“ä½œï¼Œè¿™ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œä¸éœ€è¦ä¸­æ–­</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDidDexOpt<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Give more time since we were dexopting.</span>        mDidDexOpt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 3. å‘ç”ŸANRçš„è¿›ç¨‹æ˜¯æµ‹è¯•è¿›ç¨‹ï¼Œéœ€è¦ä¸­æ–­ï¼Œä½†ä¸åœ¨UIç•Œé¢æ˜¾ç¤ºANRä¿¡æ¯åˆ¤æ–­</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>instrumentationClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">finishInstrumentationLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 4. é€šçŸ¥UIç•Œé¢æ˜¾ç¤ºANRä¿¡æ¯</span>    mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">appNotResponding</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†ç¬¬äºŒä¸ªé—®é¢˜ï¼š</font></strong></p><p><strong><font color="#FF7F24">åœ¨ InputDispatcher æ´¾å‘è¾“å…¥äº‹ä»¶æ—¶ï¼Œä¼šå¯»æ‰¾æ¥æ”¶äº‹ä»¶çš„çª—å£ï¼Œå¦‚æœæ— æ³•æ­£å¸¸æ´¾å‘ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´å½“å‰éœ€è¦æ´¾å‘çš„äº‹ä»¶è¶…æ—¶(é»˜è®¤æ˜¯5ç§’)ã€‚Nativeå±‚å‘ç°è¶…æ—¶äº†ï¼Œä¼šé€šçŸ¥Javaå±‚ï¼ŒJavaå±‚ç»è¿‡ä¸€äº›å¤„ç†åï¼Œä¼šåé¦ˆç»™Nativeå±‚ï¼Œæ˜¯ç»§ç»­ç­‰å¾…è¿˜æ˜¯ä¸¢å¼ƒå½“å‰æ´¾å‘çš„äº‹ä»¶ã€‚</font></strong></p><h2 id="3-4-å°ç»“"><a href="#3-4-å°ç»“" class="headerlink" title="3.4 å°ç»“"></a>3.4 å°ç»“</h2><p><strong>ANRç›‘æµ‹æœºåˆ¶åŒ…å«ä¸‰ç§ï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Service ANR</font></strong>ï¼Œå‰å°è¿›ç¨‹ä¸­Serviceç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡ <strong><font color="#FF0000">20ç§’</font></strong>ï¼Œåå°è¿›ç¨‹ä¸­Serviceçš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡<strong><font color="#FF0000"> 200ç§’</font></strong>ã€‚ åœ¨å¯åŠ¨Serviceæ—¶ï¼ŒæŠ›å‡ºå®šæ—¶æ¶ˆæ¯ <strong><font color="#FF34B3">SERVICE_TIMEOUT_MSG</font></strong> æˆ– <strong><font color="#FF34B3">SERVICE_BACKGOURND_TIMEOUT_MSG</font></strong>ï¼Œå¦‚æœå®šæ—¶æ¶ˆæ¯å“åº”äº†ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Broadcast ANR</font></strong>ï¼Œå‰å°çš„â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€å¿…é¡»åœ¨ <strong><font color="#FF0000">10ç§’</font></strong> å†…å¤„ç†å®Œæ¯•ï¼Œåå°çš„â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€å¿…é¡»åœ¨<strong><font color="#FF0000"> 60ç§’ </font></strong>å¤„ç†å®Œæ¯•ï¼Œ æ¯æ´¾å‘ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯åˆ°ä¸€ä¸ªæ¥æ”¶å™¨æ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ <strong><font color="#FF34B3">BROADCAST_TIMEOUT_MSG</font></strong>ï¼Œå¦‚æœå®šæ—¶æ¶ˆæ¯å“åº”ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å¹¿æ’­æ¶ˆæ¯å¤„ç†è¶…æ—¶ï¼Œè¶…æ—¶å°±è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Input ANR</font></strong>ï¼Œè¾“å…¥äº‹ä»¶å¿…é¡»åœ¨ <strong><font color="#FF0000">5ç§’</font></strong> å†…å¤„ç†å®Œæ¯•ã€‚åœ¨æ´¾å‘ä¸€ä¸ªè¾“å…¥äº‹ä»¶æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰è¾“å…¥äº‹ä»¶æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œå¦‚æœéœ€è¦ç­‰å¾…ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ç­‰å¾…å·²ç»è¶…æ—¶ï¼Œè¶…æ—¶å°±è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p><p>ANRç›‘æµ‹æœºåˆ¶å®é™…ä¸Šæ˜¯å¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„è¦æ±‚ï¼Œè¦æ±‚ä¸»çº¿æˆå¿…é¡»åœ¨é™å®šçš„æ—¶é—´å†…ï¼Œå®Œæˆå¯¹å‡ ç§æ“ä½œçš„å“åº”ï¼›å¦åˆ™ï¼Œå°±å¯ä»¥è®¤ä¸ºåº”ç”¨ç¨‹åºä¸»çº¿ç¨‹å¤±å»å“åº”èƒ½åŠ›ã€‚</p><p><strong>ä»ANRçš„ä¸‰ç§ç›‘æµ‹æœºåˆ¶ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸åŒè¶…æ—¶æœºåˆ¶çš„è®¾è®¡ï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ Service å’Œ Broadcast éƒ½æ˜¯ç”± AMS è°ƒåº¦ï¼Œåˆ©ç”¨ Handler å’Œ Looperï¼Œè®¾è®¡äº†ä¸€ä¸ª TIMEOUT æ¶ˆæ¯äº¤ç”± AMS çº¿ç¨‹æ¥å¤„ç†ï¼Œæ•´ä¸ªè¶…æ—¶æœºåˆ¶çš„å®ç°éƒ½æ˜¯åœ¨Javaå±‚ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ InputEvent ç”± InputDispatcher è°ƒåº¦ï¼Œå¾…å¤„ç†çš„è¾“å…¥äº‹ä»¶éƒ½ä¼šè¿›å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œè®¾è®¡äº†ä¸€ä¸ªç­‰å¾…è¶…æ—¶çš„åˆ¤æ–­ï¼Œè¶…æ—¶æœºåˆ¶çš„å®ç°åœ¨Nativeå±‚ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ€§èƒ½ä¼˜åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ€§èƒ½ä¼˜åŒ– </tag>
            
            <tag> ANR </tag>
            
            <tag> æ— å“åº” </tag>
            
            <tag> Input </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è°ˆè°ˆ ANR ä¹‹ Broadcast è¶…æ—¶</title>
      <link href="/2019/05/10/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-broadcast-chao-shi/"/>
      <url>/2019/05/10/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-broadcast-chao-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="1-æ ¸å¿ƒæºç "><a href="#1-æ ¸å¿ƒæºç " class="headerlink" title="1. æ ¸å¿ƒæºç "></a>1. æ ¸å¿ƒæºç </h1><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„ï¼ˆ/frameworks/base/ï¼‰</th></tr></thead><tbody><tr><td><font color="#D15FEE">ActiveServices.java</font></td><td>services/core/java/com/android/server/am/ActiveServices.java</td></tr><tr><td><font color="#D15FEE">ActivityManagerService.java</font></td><td>services/core/java/com/android/server/am/ActivityManagerService.java</td></tr><tr><td><font color="#D15FEE">AppErrors.java</font></td><td>services/core/java/com/android/server/am/AppErrors.java</td></tr><tr><td><font color="#D15FEE">BroadcastQueue.java</font></td><td>services/core/java/com/android/server/am/BroadcastQueue.java</td></tr></tbody></table><p><br></p><hr><h1 id="2-ANR-åŸºç¡€è®¤çŸ¥"><a href="#2-ANR-åŸºç¡€è®¤çŸ¥" class="headerlink" title="2. ANR åŸºç¡€è®¤çŸ¥"></a>2. ANR åŸºç¡€è®¤çŸ¥</h1><h2 id="2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><strong><font color="#FF00FF">ANR(Application Not Responding)</font></strong>ï¼Œåº”ç”¨ç¨‹åºæ— å“åº”ï¼Œç®€å•ä¸€ä¸ªå®šä¹‰ï¼Œå´æ¶µç›–äº†å¾ˆå¤š Android ç³»ç»Ÿçš„è®¾è®¡æ€æƒ³ã€‚</p><p>é¦–å…ˆï¼Œ<font color="#0000FF">ANR å±äºåº”ç”¨ç¨‹åºçš„èŒƒç•´</font>ï¼Œè¿™ä¸åŒäº SNR(System Not Respoding)ï¼ŒSNR åæ˜ çš„é—®é¢˜æ˜¯ç³»ç»Ÿè¿›ç¨‹(system_server)å¤±å»äº†å“åº”èƒ½åŠ›ï¼Œè€Œ ANR æ˜ç¡®å°†é—®é¢˜åœˆå®šåœ¨åº”ç”¨ç¨‹åºã€‚<strong><code>SNR ç”± Watchdog æœºåˆ¶ä¿è¯ï¼ŒANR ç”±æ¶ˆæ¯å¤„ç†æœºåˆ¶ä¿è¯</code></strong>ï¼ŒAndroid åœ¨ç³»ç»Ÿå±‚å®ç°äº†ä¸€å¥—ç²¾å¯†çš„æœºåˆ¶æ¥å‘ç° ANRï¼Œæ ¸å¿ƒåŸç†æ˜¯<strong><code>æ¶ˆæ¯è°ƒåº¦</code></strong>å’Œ<strong><code>è¶…æ—¶å¤„ç†</code></strong>ã€‚</p><p>å…¶æ¬¡ï¼ŒANR æœºåˆ¶<strong><code>ä¸»ä½“å®ç°åœ¨ç³»ç»Ÿå±‚</code></strong>ã€‚æ‰€æœ‰ä¸ ANR ç›¸å…³çš„æ¶ˆæ¯ï¼Œéƒ½ä¼šç»è¿‡ç³»ç»Ÿè¿›ç¨‹(system_server)è°ƒåº¦ï¼Œç„¶åæ´¾å‘åˆ°åº”ç”¨è¿›ç¨‹å®Œæˆå¯¹æ¶ˆæ¯çš„å®é™…å¤„ç†ï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿè¿›ç¨‹è®¾è®¡äº†ä¸åŒçš„è¶…æ—¶é™åˆ¶æ¥è·Ÿè¸ªæ¶ˆæ¯çš„å¤„ç†ã€‚ä¸€æ—¦åº”ç”¨ç¨‹åºå¤„ç†æ¶ˆæ¯ä¸å½“ï¼Œè¶…æ—¶é™åˆ¶å°±èµ·ä½œç”¨äº†ï¼Œå®ƒæ”¶é›†ä¸€äº›ç³»ç»ŸçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šCPU/IOä½¿ç”¨æƒ…å†µã€è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆï¼Œå¹¶ä¸”æŠ¥å‘Šç”¨æˆ·æœ‰è¿›ç¨‹<strong><code>æ— å“åº”äº†ï¼ˆANR å¯¹è¯æ¡†ï¼‰</code></strong>ã€‚</p><p>ç„¶åï¼ŒANR é—®é¢˜<strong><code>æœ¬è´¨æ˜¯ä¸€ä¸ªæ€§èƒ½é—®é¢˜</code></strong>ã€‚ANR æœºåˆ¶å®é™…ä¸Šå¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„é™åˆ¶ï¼Œè¦æ±‚ä¸»çº¿ç¨‹åœ¨é™å®šçš„æ—¶é—´å†…å¤„ç†å®Œä¸€äº›æœ€å¸¸è§çš„æ“ä½œ(å¯åŠ¨æœåŠ¡ã€å¤„ç†å¹¿æ’­ã€å¤„ç†è¾“å…¥)ï¼Œå¦‚æœå¤„ç†è¶…æ—¶ï¼Œåˆ™è®¤ä¸ºä¸»çº¿ç¨‹å·²ç»å¤±å»äº†å“åº”å…¶ä»–æ“ä½œçš„èƒ½åŠ›ã€‚ä¸»çº¿ç¨‹ä¸­çš„<strong><code>è€—æ—¶æ“ä½œ</code></strong>ï¼Œä¾‹å¦‚ï¼šå¯†é›†CPUè¿ç®—ã€å¤§é‡IOã€å¤æ‚ç•Œé¢å¸ƒå±€ç­‰ï¼Œéƒ½ä¼šé™ä½åº”ç”¨ç¨‹åºçš„å“åº”èƒ½åŠ›ã€‚</p><p>æœ€åï¼Œéƒ¨åˆ† ANR é—®é¢˜æ˜¯å¾ˆéš¾åˆ†æçš„ï¼Œæœ‰æ—¶å€™ç”±äºç³»ç»Ÿåº•å±‚çš„ä¸€äº›å½±å“ï¼Œå¯¼è‡´æ¶ˆæ¯è°ƒåº¦å¤±è´¥ï¼Œå‡ºç°é—®é¢˜çš„åœºæ™¯åˆéš¾ä»¥å¤ç°ã€‚è¿™ç±» ANR é—®é¢˜å¾€å¾€éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´å»äº†è§£ç³»ç»Ÿçš„ä¸€äº›è¡Œä¸ºï¼Œè¶…å‡ºäº† ANR æœºåˆ¶æœ¬èº«çš„èŒƒç•´ã€‚</p><h2 id="2-2-ANR-æœºåˆ¶"><a href="#2-2-ANR-æœºåˆ¶" class="headerlink" title="2.2 ANR æœºåˆ¶"></a>2.2 ANR æœºåˆ¶</h2><p>åˆ†æä¸€äº›åˆçº§çš„ ANR é—®é¢˜ï¼Œåªéœ€è¦ç®€å•ç†è§£æœ€ç»ˆè¾“å‡ºçš„æ—¥å¿—å³å¯ï¼Œä½†å¯¹äºä¸€äº›ç”±ç³»ç»Ÿé—®é¢˜(ä¾‹å¦‚ï¼šCPU è´Ÿè½½è¿‡é«˜ã€è¿›ç¨‹å¡æ­»)å¼•å‘çš„ ANRï¼Œå°±éœ€è¦å¯¹æ•´ä¸ª ANR æœºåˆ¶æœ‰æ‰€äº†è§£ï¼Œæ‰èƒ½å®šä½å‡ºé—®é¢˜çš„åŸå› ã€‚</p><p><strong><font color="#FF0000" size="3">ANR æœºåˆ¶å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„ç›‘æµ‹</strong>ï¼šAndroid å¯¹äºä¸åŒçš„ ANR ç±»å‹(Broadcastï¼ŒServiceï¼ŒInputEvent)éƒ½æœ‰ä¸€å¥—ç›‘æµ‹æœºåˆ¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„æŠ¥å‘Š</strong>ï¼šåœ¨ç›‘æµ‹åˆ° ANR ä»¥åï¼Œéœ€è¦æ˜¾ç¤º ANR å¯¹è¯æ¡†ã€è¾“å‡ºæ—¥å¿—(å‘ç”Ÿ ANR æ—¶çš„è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆã€CPU ä½¿ç”¨æƒ…å†µç­‰)ã€‚</p><h2 id="2-3-ANR-çš„è§¦å‘åŸå› "><a href="#2-3-ANR-çš„è§¦å‘åŸå› " class="headerlink" title="2.3 ANR çš„è§¦å‘åŸå› "></a>2.3 ANR çš„è§¦å‘åŸå› </h2><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œå‡ºç° ANR ä¹‹åä¸€ä¸ªç›´è§‚ç°è±¡å°±æ˜¯ç³»ç»Ÿä¼šå±•ç¤ºå‡ºä¸€ä¸ª ANR å¯¹è¯æ¡†ã€‚</p><p><strong><font color="#FF0000" size="3">è°·æ­Œæ–‡æ¡£ä¸­å¯¹ ANR äº§ç”Ÿçš„åŸå› æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</font></strong></p><p>Android ç³»ç»Ÿä¸­çš„åº”ç”¨è¢« <code>ActivityManagerService</code> åŠ <code>WindowManagerService</code> ä¸¤ä¸ªç³»ç»ŸæœåŠ¡ç›‘æ§ç€ï¼Œç³»ç»Ÿä¼šåœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µå±•ç¤ºå‡º ANR çš„å¯¹è¯æ¡†ï¼</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">KeyDispatchTimeout</font>&nbsp;(<font color="#FF0000"> 5 seconds</font> ) ï¼šæŒ‰é”®æˆ–è§¦æ‘¸äº‹ä»¶åœ¨ç‰¹å®šæ—¶é—´å†…æ— å“åº”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">BroadcastTimeout</font>&nbsp;(<font color="#FF0000"> 10 seconds</font> )ï¼šBroadcastReceiver åœ¨ç‰¹å®šæ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">ServiceTimeout</font>&nbsp;(<font color="#FF0000"> 20 seconds</font> ) ï¼šService åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ</p><h1 id="3-ANR-çš„ç›‘æµ‹æœºåˆ¶"><a href="#3-ANR-çš„ç›‘æµ‹æœºåˆ¶" class="headerlink" title="3. ANR çš„ç›‘æµ‹æœºåˆ¶"></a>3. ANR çš„ç›‘æµ‹æœºåˆ¶</h1><h2 id="3-1-Broadcast-è¶…æ—¶å¤„ç†"><a href="#3-1-Broadcast-è¶…æ—¶å¤„ç†" class="headerlink" title="3.1 Broadcast è¶…æ—¶å¤„ç†"></a>3.1 Broadcast è¶…æ—¶å¤„ç†</h2><p>åº”ç”¨ç¨‹åºå¯ä»¥æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ï¼Œå®ç° BroadcastReceiver.onReceive() æ–¹æ³•æ¥å®Œæˆå¯¹å¹¿æ’­çš„å¤„ç†ã€‚é€šå¸¸ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼ŒAndroid é™å®šå®ƒæ‰§è¡Œæ—¶é—´ä¸èƒ½è¶…è¿‡10ç§’ï¼Œå¦åˆ™ï¼Œå°±ä¼šå¼•å‘ ANRã€‚</p><p>onReceive() ä¹Ÿå¯ä»¥è°ƒåº¦åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼Œé€šè¿‡ Context.registerReceiver(BroadcastReceiver, IntentFilter, String, Handler) è¿™ä¸ªæ–¹æ³•æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªå¤„ç†çš„ Handlerï¼Œå°† onReceive() è°ƒåº¦åœ¨éä¸»çº¿ç¨‹æ‰§è¡Œã€‚</p><p><strong><font color="#ff0000" size="3">è¿™è¾¹æˆ‘ä»¬å…ˆæŠ›å‡ºä¸¤ä¸ªé—®é¢˜ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ Android å¦‚ä½•å°†å¹¿æ’­æŠ•é€’ç»™å„ä¸ªåº”ç”¨ç¨‹åºï¼Ÿ</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ Android å¦‚ä½•æ£€æµ‹å¹¿æ’­å¤„ç†è¶…æ—¶ï¼Ÿ</p><h3 id="3-1-1-å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦"><a href="#3-1-1-å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦" class="headerlink" title="3.1.1 å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦"></a>3.1.1 å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦</h3><p>AMS ç»´æŠ¤äº†ä¸¤ä¸ªå¹¿æ’­é˜Ÿåˆ— BroadcastQueue:</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ <font color="#ff00ff" size="3">foreground queue</font>ï¼Œå‰å°é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´æ˜¯ 10 ç§’ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ <font color="#ff00ff" size="3">background queue</font>ï¼Œåå°é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´æ˜¯ 60 ç§’ã€‚</p><p>ä¹‹æ‰€ä»¥æœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å› ä¸ºè¦åŒºåˆ†ä¸åŒè¶…æ—¶æ—¶é—´ã€‚æ‰€æœ‰å‘é€çš„å¹¿æ’­éƒ½ä¼šè¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦ï¼Œåœ¨å‘é€å¹¿æ’­æ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>Intent.FLAG_RECEIVER_FOREGROUND</code> å‚æ•°å°†å¹¿æ’­æŠ•é€’åˆ°å‰å°é˜Ÿåˆ—ã€‚</p><p>AMS ä¼šä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡ºå¹¿æ’­æ¶ˆæ¯æ´¾å‘åˆ°å„ä¸ª BroadcastReceiverã€‚å½“è¦æ´¾å‘å¹¿æ’­æ—¶ï¼ŒAMS ä¼šè°ƒç”¨ <code>BroadcastQueue.scheduleBroadcastsLocked()</code> æ–¹æ³•ï¼</p><h4 id="3-1-1-1-scheduleBroadcastsLocked"><a href="#3-1-1-1-scheduleBroadcastsLocked" class="headerlink" title="3.1.1.1 scheduleBroadcastsLocked"></a>3.1.1.1 scheduleBroadcastsLocked</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastQueue</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBroadcastsScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_INTENT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå¾€ AMS çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€ BROADCAST_INTENT_MSG æ¶ˆæ¯ï¼Œç”±æ­¤ä¹Ÿå¯ä»¥çœ‹åˆ°çœŸæ­£æ´¾å‘å¹¿æ’­çš„æ˜¯ AMS çº¿ç¨‹ã€‚ç”±äºä¸Šè¿°æ–¹æ³•å¯èƒ½è¢«å¹¶å‘è°ƒç”¨ï¼Œæ‰€ä»¥é€šè¿‡ <code>mBroadcastsScheduled</code> è¿™ä¸ªå˜é‡æ¥æ ‡è¯† <code>BROADCAST_INTENT_MSG</code> æ˜¯ä¸æ˜¯å·²ç»è¢« <code>AMS</code> æ¥æ”¶äº†ï¼Œå½“å·²ç»æŠ›å‡ºçš„æ¶ˆæ¯è¿˜æœªè¢«æ¥å—æ—¶ï¼Œä¸éœ€è¦é‡æ–°æŠ›å‡ºã€‚ </p><p>æˆ‘ä»¬çœ‹çœ‹è¯¥æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ï¼</p><h4 id="3-1-1-2-BroadcastHandler"><a href="#3-1-1-2-BroadcastHandler" class="headerlink" title="3.1.1.2 BroadcastHandler"></a>3.1.1.2 BroadcastHandler</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastQueue</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token function">BroadcastHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> BROADCAST_INTENT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> BROADCAST_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>BroadcastQueue.processNextBroadcast()</code> æ–¹æ³•ï¼Œå‚æ•°ä¸º true è¡¨ç¤ºè¿™æ˜¯ä¸€æ¬¡æ¥è‡ª <code>BROADCAST_INTENT_MSG</code> æ¶ˆæ¯çš„æ´¾å‘è¯·æ±‚ã€‚</p><p><code>processNextBroadcast()</code> æ˜¯æ´¾å‘å¹¿æ’­æ¶ˆæ¯æœ€ä¸ºæ ¸å¿ƒçš„å‡½æ•°ï¼Œä»£ç é‡è‡ªç„¶ä¹Ÿä¸å°ï¼Œæˆ‘ä»¬åˆ†æˆå‡ ä¸ªéƒ¨åˆ†æ¥åˆ†æï¼</p><blockquote><p>é˜¶æ®µ 1ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­ä¿¡æ¯</p></blockquote><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>            BroadcastRecord r<span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†éä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            âœ¨ <span class="token comment" spellcheck="true">// â‘  è®¾ç½®mBroadcastsScheduled</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// fromMsg å‚æ•°ä¸º true è¡¨ç¤ºè¿™æ˜¯ä¸€æ¬¡æ¥è‡ª BROADCAST_INTENT_MSG æ¶ˆæ¯çš„æ´¾å‘è¯·æ±‚              </span>                mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            âœ¨ <span class="token comment" spellcheck="true">// â‘¡ å¤„ç†â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Object target <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            âœ¨ <span class="token comment" spellcheck="true">// â‘¢ å¤„ç†é˜»å¡çš„å¹¿æ’­æ¶ˆæ¯</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDead<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// It's still alive, so keep waiting</span>                    <span class="token comment" spellcheck="true">// isDeadè¡¨ç¤ºå½“å‰å¹¿æ’­æ¶ˆæ¯çš„è¿›ç¨‹çš„å­˜æ´»çŠ¶æ€</span>                    <span class="token comment" spellcheck="true">// å¦‚æœè¿˜æ´»ç€ï¼Œåˆ™è¿”å›è¯¥å‡½æ•°ï¼Œç»§ç»­ç­‰å¾…ä¸‹æ¬¡æ´¾å‘</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†åˆ†æè¿™ä¸‰éƒ¨åˆ†çš„å‡½æ•°æ‰€åšå·¥ä½œï¼š</p><p><strong><font color="#7FF000" size="3">1ã€è®¾ç½®mBroadcastsScheduled</font></strong></p><p>è¯¥å˜é‡åœ¨å‰æ–‡è¯´è¿‡ï¼Œæ˜¯å¯¹ BROADCAST_INTENT_MSG è¿›è¡Œæ§åˆ¶ã€‚ å¦‚æœæ˜¯å“åº” BROADCAST_INTENT_MSG çš„æ´¾å‘è°ƒç”¨ï¼Œåˆ™å°† mBroadcastsScheduled è®¾ä¸ºfalseï¼Œ è¡¨ç¤ºæœ¬æ¬¡ BROADCAST_INTENT_MSG å·²ç»å¤„ç†å®Œæ¯•ï¼Œå¯ä»¥ç»§ç»­æŠ›å‡ºä¸‹ä¸€æ¬¡ BROADCAST_INTENT_MSG æ¶ˆæ¯äº†ã€‚</p><p><strong><font color="#7FF000" size="3">2ã€å¤„ç†â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€</font></strong></p><p>æˆ‘ä»¬çŸ¥é“å¹¿æ’­æ¥æ”¶å™¨æœ‰â€œåŠ¨æ€â€å’Œâ€œé™æ€â€ä¹‹åˆ†ï¼Œé€šè¿‡ Context.registerReceiver() æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸ºâ€œåŠ¨æ€â€çš„ï¼Œé€šè¿‡ AndroidManifest.xml æ³¨å†Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¸ºâ€œé™æ€â€çš„ã€‚</p><p>å¹¿æ’­æ¶ˆæ¯æœ‰â€œå¹¶è¡Œâ€å’Œâ€œä¸²è¡Œâ€ä¹‹åˆ†ï¼Œâ€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€éƒ½ä¼šæ´¾å‘åˆ°â€œåŠ¨æ€â€æ¥æ”¶å™¨ï¼Œâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€åˆ™ä¼šæ ¹æ®å®é™…æƒ…å†µæ´¾å‘åˆ°ä¸¤ç§æ¥æ”¶å™¨ã€‚æˆ‘ä»¬å…ˆä¸å»æ¢ç©¶ Android ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œåªå…³æ³¨è¿™ä¸¤ç§å¹¿æ’­æ¶ˆæ¯æ´¾å‘çš„åŒºåˆ«ã€‚</p><p><strong>åœ¨BroadcastQueueç»´æŠ¤ç€ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF0000">mParallelBroadcasts</font></strong>ï¼šâ€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€éƒ½ä¼šè¿›å…¥åˆ°æ­¤é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€å¯ä»¥ä¸€æ¬¡æ€§æ´¾å‘å®Œæ¯•ï¼Œå³åœ¨ä¸€ä¸ªå¾ªç¯ä¸­å°†å¹¿æ’­æ´¾å‘åˆ°æ‰€æœ‰çš„â€œåŠ¨æ€â€æ¥æ”¶å™¨ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#FF0000">mOrderedBroadcasts</font></strong>ï¼šâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€éƒ½ä¼šè¿›å…¥åˆ°æ­¤é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€éœ€è¦è½®ä¾¯æ´¾å‘ï¼Œå½“ä¸€ä¸ªæ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼Œä¼šå†æŠ›å‡º BROADCAST_INTENT_MSG æ¶ˆæ¯ï¼Œå†æ¬¡è¿›å…¥ BroadcastQueue.processNextBroadcast() å¤„ç†ä¸‹ä¸€ä¸ªã€‚</p><p><strong><font color="#7FF000" size="3">3ã€å¤„ç†é˜»å¡çš„å¹¿æ’­æ¶ˆæ¯</font></strong></p><p>æœ‰æ—¶å€™ä¼šå­˜åœ¨ä¸€ä¸ªå¹¿æ’­æ¶ˆæ¯æ´¾å‘ä¸å‡ºå»çš„æƒ…å†µï¼Œè¿™ä¸ªå¹¿æ’­æ¶ˆæ¯ä¼šä¿å­˜åœ¨ mPendingBroadcast å˜é‡ä¸­ã€‚æ–°ä¸€è½®çš„æ´¾å‘å¯åŠ¨æ—¶ï¼Œä¼šåˆ¤æ–­æ¥æ”¶è¯¥æ¶ˆæ¯çš„è¿›ç¨‹æ˜¯å¦è¿˜æ´»ç€ï¼Œå¦‚æœæ¥æ”¶è¿›ç¨‹è¿˜æ´»ç€ï¼Œé‚£ä¹ˆå°±ç»§ç»­ç­‰å¾…ã€‚å¦åˆ™ï¼Œå°±æ”¾å¼ƒè¿™ä¸ªå¹¿æ’­æ¶ˆæ¯ã€‚</p><blockquote><p>é˜¶æ®µ 2ï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­ä¿¡æ¯</p></blockquote><p>æ¥ä¸‹æ¥æ˜¯æœ€ä¸ºå¤æ‚çš„ä¸€éƒ¨åˆ†ï¼Œ<strong><font color="#FF7F24">å¤„ç†â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€ï¼ŒANR ç›‘æµ‹æœºåˆ¶åªåœ¨è¿™ä¸€ç±»å¹¿æ’­æ¶ˆæ¯ä¸­æ‰å‘æŒ¥ä½œç”¨</font></strong>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong><font color="#FF0000">â€œå¹¶è¡Œå¹¿æ’­æ¶ˆæ¯â€æ˜¯ä¸ä¼šå‘ç”ŸANRçš„</font></strong>ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>            BroadcastRecord r<span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            <span class="token keyword">boolean</span> looped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">do</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">boolean</span> forceReceive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> numReceivers <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>                âœ¨ <span class="token comment" spellcheck="true">// â‘  å¹¿æ’­æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªANRç›‘æµ‹æœºåˆ¶</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessesReady <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numReceivers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                            <span class="token punctuation">(</span>now <span class="token operator">></span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mTimeoutPeriod<span class="token operator">*</span>numReceivers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                            <span class="token comment" spellcheck="true">/// M: ANR Debug Mechanism</span>                            <span class="token operator">!</span>mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">isAnrDeferrable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// forcibly finish this broadcast</span>                        forceReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                        r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                âœ¨ <span class="token comment" spellcheck="true">// â‘¡ åˆ¤æ–­è¯¥å¹¿æ’­æ¶ˆæ¯æ˜¯å¦å¤„ç†å®Œæ¯•</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">>=</span> numReceivers                        <span class="token operator">||</span> r<span class="token punctuation">.</span>resultAbort <span class="token operator">||</span> forceReceive<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token function">cancelBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    r <span class="token operator">=</span> null<span class="token punctuation">;</span>                    looped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>è¿™éƒ¨åˆ†æ˜¯ä¸€ä¸ª <font color="#FF00FF">do-while</font> å¾ªç¯ï¼Œæ¯æ¬¡éƒ½ä» <font color="#FF00FF">mOrderedBroadcasts</font> é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€æ¡å¹¿æ’­æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚ç¬¬ä¸€ä¸ª <font color="#FF00FF">Broadcast ANR</font> ç›‘æµ‹æœºåˆ¶åƒå‘¼ä¸‡å”¤æ€»ç®—æ˜¯å‡ºç°äº†ï¼š</p><p><strong><font color="#7FF000" size="3">1ã€åˆ¤å®šå½“å‰æ—¶é—´æ˜¯å¦å·²ç»è¶…è¿‡äº† r.dispatchTime + 2Ã—mTimeoutPeriodÃ—numReceiversã€‚</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ dispatchTime è¡¨ç¤ºè¿™ä¸€ç³»åˆ—å¹¿æ’­æ¶ˆæ¯å¼€å§‹æ´¾å‘çš„æ—¶é—´ã€‚â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€æ˜¯é€ä¸ªæ¥æ”¶å™¨æ´¾å‘çš„ï¼Œä¸€ä¸ªæ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼Œæ‰å¼€å§‹å¤„ç†ä¸‹ä¸€ä¸ªæ¶ˆæ¯æ´¾å‘ã€‚å¼€å§‹æ´¾å‘åˆ°ç¬¬ä¸€ä¸ªæ¥æ”¶å™¨çš„æ—¶é—´å°±æ˜¯ dispatchTimeã€‚ dispatchTime éœ€è¦å¼€å§‹ç­‰å¹¿æ’­æ¶ˆæ¯æ´¾å‘ä»¥åæ‰ä¼šè®¾å®šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€æ¬¡è¿›å…¥processNextBroadcast()æ—¶ï¼ŒdispatchTime=0,å¹¶ä¸ä¼šè¿›å…¥è¯¥æ¡ä»¶åˆ¤æ–­ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ mTimeoutPeriod ç”±å½“å‰ BroadcastQueue çš„ç±»å‹å†³å®š(forgroundä¸º10ç§’ï¼Œbackgroundä¸º60ç§’)ã€‚è¿™ä¸ªæ—¶é—´åœ¨åˆå§‹åŒ– BroadcastQueue çš„æ—¶å€™å°±è®¾ç½®å¥½äº†ï¼Œæœ¬æ„æ˜¯é™å®šæ¯ä¸€ä¸ª Receiver å¤„ç†å¹¿æ’­çš„æ—¶é—´ï¼Œè¿™é‡Œåˆ©ç”¨å®ƒåšäº†ä¸€ä¸ªè¶…æ—¶è®¡ç®—ã€‚</p><p><strong><font color="#7FF000" size="3">2ã€å¦‚æœå¹¿æ’­æ¶ˆæ¯å·²ç»å¤„ç†å®Œæ¯•ï¼Œåˆ™ä»mOrderedBroadcastsä¸­ç§»é™¤ï¼Œé‡æ–°å¾ªç¯ï¼Œå¤„ç†ä¸‹ä¸€æ¡;å¦åˆ™ï¼Œå°±ä¼šè·³å‡ºå¾ªç¯ã€‚</font></strong></p><blockquote><p>é˜¶æ®µ 3ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯</p></blockquote><p>ä»¥ä¸Šä»£ç å—å®Œæˆçš„ä¸»è¦ä»»åŠ¡æ˜¯ä»é˜Ÿåˆ—ä¸­å–ä¸€æ¡â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€ï¼Œæ¥ä¸‹æ¥å°±å‡†å¤‡æ´¾å‘äº†ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>            BroadcastRecord r<span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯çš„ç¬¬äºŒä¸ªANRç›‘æµ‹æœºåˆ¶</span>            r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span></code></pre><p>å–å‡ºâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€åï¼Œä¸€æ—¦è¦å¼€å§‹æ´¾å‘ï¼Œç¬¬äºŒä¸ªANRæ£€æµ‹æœºåˆ¶å°±å‡ºç°äº†ã€‚</p><p><font color="#FF00FF">mPendingBroadcastTimeoutMessage</font> å˜é‡ç”¨äºæ ‡è¯†å½“å‰æ˜¯å¦æœ‰é˜»å¡çš„è¶…æ—¶æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨ <font color="#FF00FF">BroadcastQueue.setBroadcastTimeoutLocked()</font>ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_TIMEOUT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            mPendingBroadcastTimeoutMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">sendBroadcastMonitorMessage</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">,</span> mTimeoutPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>é€šè¿‡è®¾ç½®ä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ <font color="#FF00FF">BROADCAST_TIMEOUT_MSG </font>æ¥è·Ÿè¸ªå½“å‰å¹¿æ’­æ¶ˆæ¯çš„æ‰§è¡Œæƒ…å†µï¼Œè¿™ç§è¶…æ—¶ç›‘æµ‹æœºåˆ¶è·Ÿ Service ANR å¾ˆç±»ä¼¼ï¼Œä¹Ÿæ˜¯æŠ›åˆ° AMS çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœæ‰€æœ‰çš„æ¥æ”¶å™¨éƒ½å¤„ç†å®Œæ¯•äº†ï¼Œåˆ™ä¼šè°ƒç”¨ <font color="#FF00FF">cancelBroadcastTimeoutLocked()</font> æ¸…é™¤è¯¥æ¶ˆæ¯ï¼›å¦åˆ™ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šå“åº”ï¼Œå¹¶è°ƒç”¨ <font color="#FF00FF">broadcastTimeoutLocked()</font>ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ç¬¬ä¸€ç§ ANR ç›‘æµ‹æœºåˆ¶çš„æ—¶å€™è°ƒç”¨è¿‡ï¼Œç¬¬äºŒç§ ANR ç›‘æµ‹æœºåˆ¶ä¹Ÿä¼šè°ƒç”¨ã€‚</p><blockquote><p>é˜¶æ®µ 4ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯</p></blockquote><p>è®¾ç½®å®Œå®šæ—¶æ¶ˆæ¯åï¼Œå°±å¼€å§‹æ´¾å‘å¹¿æ’­æ¶ˆæ¯äº†ï¼Œé¦–å…ˆæ˜¯â€œåŠ¨æ€â€æ¥æ”¶å™¨ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>            BroadcastRecord r<span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            <span class="token keyword">final</span> BroadcastOptions brOptions <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">;</span>            <span class="token keyword">final</span> Object nextReceiver <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// åŠ¨æ€æ¥æ”¶å™¨çš„ç±»å‹éƒ½æ˜¯BroadcastFilter</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextReceiver <span class="token keyword">instanceof</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                BroadcastFilter filter <span class="token operator">=</span> <span class="token punctuation">(</span>BroadcastFilter<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>                <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span></code></pre><p>â€œåŠ¨æ€â€æ¥æ”¶å™¨çš„è½½ä½“è¿›ç¨‹ä¸€èˆ¬æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€çš„ï¼Œæ‰€ä»¥å‘è¿™ç§ç±»å‹çš„æ¥æ”¶å™¨æ´¾å‘æ¶ˆæ¯ç›¸å¯¹ç®€å•ï¼Œè°ƒç”¨ <font color="#FF00FF">BroadcastQueue.deliverToRegisteredReceiverLocked()</font> å®Œæˆæ¥ä¸‹æ¥çš„å·¥ä½œã€‚</p><blockquote><p>é˜¶æ®µ 5ï¼šå‘â€œé™æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯</p></blockquote><p>â€œé™æ€â€æ¥æ”¶å™¨æ˜¯åœ¨AndroidManifest.xmlä¸­æ³¨å†Œçš„ï¼Œæ´¾å‘çš„æ—¶å€™ï¼Œå¯èƒ½å¹¿æ’­æ¥æ”¶å™¨çš„è½½ä½“è¿›ç¨‹è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥ï¼Œè¿™ç§åœºæ™¯ä¼šå¤æ‚å¾ˆå¤šã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>            BroadcastRecord r<span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸€ï¼šå¤„ç†å¹¶è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäºŒï¼šå¤„ç†ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µä¸‰ï¼šè®¾å®šå®šæ—¶æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µå››ï¼šå‘â€œåŠ¨æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ é˜¶æ®µäº”ï¼šå‘â€œé™æ€â€æ¥æ”¶å™¨æ´¾å‘å¹¿æ’­æ¶ˆæ¯ ğŸğŸğŸğŸğŸğŸğŸğŸğŸğŸ            <span class="token comment" spellcheck="true">// é™æ€æ¥æ”¶å™¨çš„ç±»å‹éƒ½æ˜¯ ResolveInfo</span>            ResolveInfo info <span class="token operator">=</span>                <span class="token punctuation">(</span>ResolveInfo<span class="token punctuation">)</span>nextReceiver<span class="token punctuation">;</span>            âœ¨ <span class="token comment" spellcheck="true">// â‘  æƒé™æ£€æŸ¥</span>            ComponentName component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            String targetProcess <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>            âœ¨ <span class="token comment" spellcheck="true">// â‘¡ è·å–æ¥æ”¶å™¨æ‰€åœ¨çš„è¿›ç¨‹</span>            ProcessRecord app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            âœ¨ <span class="token comment" spellcheck="true">// â‘¢ è¿›ç¨‹å·²ç»å¯åŠ¨</span>            <span class="token comment" spellcheck="true">// Is this receiver's application already running?</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>                            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            âœ¨ <span class="token comment" spellcheck="true">// â‘£ è¿›ç¨‹è¿˜æœªå¯åŠ¨</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token operator">=</span>mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                    r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_FROM_BACKGROUND<span class="token punctuation">,</span>                    <span class="token string">"broadcast"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">,</span>                    <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>                        r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                r<span class="token punctuation">.</span>state <span class="token operator">=</span> BroadcastRecord<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            âœ¨ <span class="token comment" spellcheck="true">// â‘¤ è¿›ç¨‹å¯åŠ¨å¤±è´¥</span>            mPendingBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>            mPendingBroadcastRecvIndex <span class="token operator">=</span> recIdx<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    </code></pre><p>æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹ï¼š</p><p><strong><font color="#7FF000" size="3">1ã€æƒé™æ£€æŸ¥</font></strong></p><p>â€œé™æ€â€æ¥æ”¶å™¨æ˜¯ ResolveInfo ï¼Œéœ€è¦é€šè¿‡ PackageManager è·å–åŒ…ä¿¡æ¯ï¼Œè¿›è¡Œæƒé™æ£€æŸ¥ã€‚</p><p><strong><font color="#7FF000" size="3">2ã€è·å–æ¥æ”¶å™¨æ‰€åœ¨çš„è¿›ç¨‹</font></strong></p><p>ç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„æƒé™æ£€æŸ¥åï¼Œç»ˆäºå¯ä»¥å‘ç›®æ ‡æ¥æ”¶å™¨æ´¾å‘äº†ã€‚é€šè¿‡ AMS.getProcessRecordLocked() è·å–å¹¿æ’­æ¥æ”¶å™¨çš„è¿›ç¨‹ä¿¡æ¯ã€‚</p><p><strong><font color="#7FF000" size="3">3ã€è¿›ç¨‹å·²ç»å¯åŠ¨</font></strong></p><p>å¦‚æœ app.thread ï¼= null ï¼Œåˆ™è¿›ç¨‹å·²ç»å¯åŠ¨ï¼Œå°±å¯ä»¥è°ƒç”¨ BroadcastQueue.processCurBroadcastLocked() è¿›è¡Œæ¥ä¸‹æ¥çš„æ´¾å‘å¤„ç†äº†ã€‚</p><p><strong><font color="#7FF000" size="3">4ã€è¿›ç¨‹è¿˜æœªå¯åŠ¨</font></strong></p><p>å¦‚æœè¿›ç¨‹è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™éœ€è¦é€šè¿‡ AMS.startProcessLocked() æ¥å¯åŠ¨è¿›ç¨‹ï¼Œå½“å‰æ¶ˆæ¯å¹¶æœªæ´¾å‘ï¼Œè°ƒç”¨ BroadcastQueue.scheduleBroadcastsLocked() è¿›å…¥ä¸‹ä¸€æ¬¡çš„è°ƒåº¦ã€‚</p><p><strong><font color="#7FF000" size="3">5ã€è¿›ç¨‹å¯åŠ¨å¤±è´¥</font></strong></p><p>å¦‚æœè¿›ç¨‹å¯åŠ¨å¤±è´¥äº†ï¼Œåˆ™å½“å‰æ¶ˆæ¯è®°å½•æˆ mPendingBroadcast ï¼Œå³é˜»å¡çš„å¹¿æ’­æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶å¤„ç†ã€‚</p><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p><strong><font color="#FF7F24">åºå¤§çš„ processNextBroadcast()ç»ˆäºå®Œç»“äº†ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯å¯¹å¹¿æ’­æ¶ˆæ¯è¿›è¡Œè°ƒåº¦ï¼Œè¯¥æ–¹æ³•è¢«è®¾è®¡å¾—ååˆ†å¤æ‚è€Œç²¾å·§ï¼Œç”¨äºåº”å¯¹ä¸åŒçš„å¹¿æ’­æ¶ˆæ¯å’Œæ¥æ”¶å™¨çš„å¤„ç†ã€‚<font></font></font></strong></p><h3 id="å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’"><a href="#å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’" class="headerlink" title="å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’"></a>å¹¿æ’­æ¶ˆæ¯çš„è·¨è¿›ç¨‹ä¼ é€’</h3><p>è°ƒåº¦æ˜¯å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æè¢«è°ƒåº¦å¹¿æ’­æ¶ˆæ¯å¦‚ä½•åˆ°è¾¾åº”ç”¨ç¨‹åºã€‚ä¸Šæ–‡çš„åˆ†æä¸­ï¼Œæœ€ç»ˆæœ‰ä¸¤ä¸ªæ–¹æ³•å°†å¹¿æ’­æ¶ˆæ¯æ´¾å‘å‡ºå»ï¼š <font color="#FF00FF">BroadcastQueue.deliverToRegisteredReceiverLocked()</font> å’Œ <font color="#FF00FF">BroadcastQueue.processCurBroadcastLocked()</font>ã€‚</p><p>æŠ›å¼€è¿™ä¸¤ä¸ªå‡½æ•°çš„é€»è¾‘ï¼Œè¯•æƒ³è¦å°†å¹¿æ’­æ¶ˆæ¯ä» AMS æ‰€åœ¨çš„ system_server è¿›ç¨‹ä¼ é€’åˆ°åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ï¼Œè¯¥æ€ä¹ˆå®ç°ï¼Ÿ</p><p>è‡ªç„¶éœ€è¦ç”¨åˆ°è·¨è¿›ç¨‹è°ƒç”¨ï¼ŒAndroidä¸­æœ€å¸¸è§„çš„æ‰‹æ®µå°±æ˜¯ <strong><font color="#FF7F24">Binderæœºåˆ¶</font></strong>ï¼ˆå…³äºBinderæœºåˆ¶ï¼Œæˆ‘åœ¨åˆ«çš„åšæ–‡ä¸­è®²è¿‡ï¼‰ã€‚æ²¡é”™ï¼Œå¹¿æ’­æ¶ˆæ¯æ´¾å‘åˆ°åº”ç”¨è¿›ç¨‹å°±æ˜¯è¿™ä¹ˆç©çš„ã€‚</p><h4 id="åº”ç”¨ç¨‹åºå·²å¯åŠ¨"><a href="#åº”ç”¨ç¨‹åºå·²å¯åŠ¨" class="headerlink" title="åº”ç”¨ç¨‹åºå·²å¯åŠ¨"></a>åº”ç”¨ç¨‹åºå·²å¯åŠ¨</h4><p>æˆ‘ä»¬åœ¨ä¸Šé¢åˆ†æè¿‡ï¼Œå¯¹äºåº”ç”¨ç¨‹åºå·²ç»å¯åŠ¨(app.thread != null)çš„æƒ…å†µï¼Œä¼šé€šè¿‡ <font color="#FF00FF">IApplicationThread</font> å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨ï¼š</p><pre class=" language-java"><code class="language-java">            <span class="token comment" spellcheck="true">// Is this receiver's application already running?</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>                            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>æˆ‘ä»¬æŸ¥çœ‹ <font color="#FF00FF">processCurBroadcastLocked</font> æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>BroadcastRecord r<span class="token punctuation">,</span>            ProcessRecord app<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            mService<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                      PackageManager<span class="token punctuation">.</span>NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// é€šè¿‡ IApplicationThread å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨</span>            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleReceiver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">,</span>                    mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>                    r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>                    app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>            started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><pre><code>ActivityThread.ApplicationThread.scheduleReceiver()â””â”€â”€ ActivityThread.handleReceiver()    â””â”€â”€ BroadcastReceiver.onReceive()</code></pre><h4 id="åº”ç”¨ç¨‹åºæœªå¯åŠ¨"><a href="#åº”ç”¨ç¨‹åºæœªå¯åŠ¨" class="headerlink" title="åº”ç”¨ç¨‹åºæœªå¯åŠ¨"></a>åº”ç”¨ç¨‹åºæœªå¯åŠ¨</h4><p>å¯¹äºåº”ç”¨ç¨‹åºè¿˜æœªå¯åŠ¨çš„æƒ…å†µï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">IIntentReceiver</font> å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨ï¼Œåº”ç”¨è¿›ç¨‹çš„å®ç°åœ¨LoadedApk.ReceiverDispatcher.IntentReceiverä¸­ï¼Œè°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><pre><code>LoadedApk.ReceiverDispatcher.IntentReceiver.performReceive()â””â”€â”€ LoadedApk.ReceiverDispatcher.performReceiver()    â””â”€â”€ LoadedApk.ReceiverDispatcher.Args.run()        â””â”€â”€ BroadcastReceiver.onReceive()</code></pre><p>å‘ç°æ²¡ï¼Ÿæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <font color="#FF00FF">BroadcastReceiver.onReceive()</font> ï¼Œåœ¨åº”ç”¨è¿›ç¨‹æ‰§è¡Œæ¥æ”¶å¹¿æ’­æ¶ˆæ¯çš„å…·ä½“åŠ¨ä½œã€‚</p><p>å¯¹äºâ€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€è€Œè¨€ï¼Œæ‰§è¡Œå®Œäº†ä»¥åï¼Œè¿˜éœ€è¦é€šçŸ¥ system_server è¿›ç¨‹ï¼Œæ‰èƒ½ç»§ç»­å°†å¹¿æ’­æ¶ˆæ¯æ´¾å‘åˆ°ä¸‹ä¸€ä¸ªæ¥æ”¶å™¨ï¼Œè¿™åˆéœ€è¦è·¨è¿›ç¨‹è°ƒç”¨äº†ã€‚ </p><p>åº”ç”¨è¿›ç¨‹åœ¨å¤„ç†å®Œå¹¿æ’­æ¶ˆæ¯åï¼Œå³åœ¨ BroadcastReceiver.onReceive() æ‰§è¡Œå®Œæ¯•åï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">BroadcastReceiver.PendingResult.finish()</font> ï¼Œ æ¥ä¸‹æ¥çš„è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><pre><code>BroadcastReceiver.PendingResult.finish()â””â”€â”€ BroadcastReceiver.PendingResult.sendFinished()    â””â”€â”€ IActivityManager.finishReceiver()        â””â”€â”€ ActivityManagerService.finishReceiver()            â””â”€â”€ BroadcastQueue.processNextBroadcat()</code></pre><p>é€šè¿‡IActivityManagerå‘èµ·äº†ä¸€ä¸ªä»åº”ç”¨è¿›ç¨‹åˆ° system_server è¿›ç¨‹çš„è°ƒç”¨ï¼Œæœ€ç»ˆåœ¨AMSçº¿ç¨‹ä¸­ï¼Œåˆèµ°åˆ°äº† <font color="#FF00FF">BroadcastQueue.processNextBroadcat()</font>, å¼€å§‹ä¸‹ä¸€è½®çš„è°ƒåº¦ã€‚</p><h4 id="broadcastTimeoutLocked"><a href="#broadcastTimeoutLocked" class="headerlink" title="broadcastTimeoutLocked()"></a>broadcastTimeoutLocked()</h4><p>å‰æ–‡è¯´è¿‡ï¼Œä¸¤ç§ ANR æœºåˆ¶æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <font color="#FF00FF">BroadcastQueue.broadcastTimeoutLocked()</font> æ–¹æ³•ï¼Œ ç¬¬ä¸€ç§ ANR ç›‘æµ‹ç”Ÿæ•ˆæ—¶ï¼Œä¼šå°† fromMsg è®¾ç½®ä¸º false ï¼›ç¬¬äºŒç§ ANR ç›‘æµ‹ç”Ÿæ•ˆæ—¶ï¼Œä¼šå°† fromMsg å‚æ•°ä¸º true æ—¶ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨å“åº” <font color="#FF00FF">BROADCAST_TIMEOUT_MSG</font> æ¶ˆæ¯ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        âœ¨ <span class="token comment" spellcheck="true">// â‘  è®¾ç½®mPendingBroadcastTimeoutMessage</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mPendingBroadcastTimeoutMessage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            mService<span class="token punctuation">.</span>mAnrManager<span class="token punctuation">.</span><span class="token function">removeBroadcastMonitorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        âœ¨ <span class="token comment" spellcheck="true">// â‘¡ åˆ¤æ–­ç¬¬äºŒç§ANRæœºåˆ¶æ˜¯å¦è¶…æ—¶</span>        BroadcastRecord r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutTime <span class="token operator">></span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        âœ¨ <span class="token comment" spellcheck="true">// â‘¢ å·²ç»è¶…æ—¶ï¼Œåˆ™ç»“æŸå¯¹å½“å‰æ¥æ”¶å™¨ï¼Œå¼€å§‹æ–°ä¸€è½®è°ƒåº¦</span>        <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>                r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        âœ¨ <span class="token comment" spellcheck="true">// â‘£ æŠ›å‡ºç»˜åˆ¶ANRå¯¹è¯æ¡†çš„æ¶ˆæ¯</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>anrMessage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Post the ANR to the handler since we do not want to process ANRs while</span>            <span class="token comment" spellcheck="true">// potentially holding our lock.</span>            mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AppNotResponding</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> anrMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p><strong><font color="#7FF000" size="3">1ã€è®¾ç½®mPendingBroadcastTimeoutMessage</font></strong></p><p>mPendingBroadcastTimeoutMessage æ ‡è¯†æ˜¯å¦å­˜åœ¨æœªå¤„ç†çš„ BROADCAST_TIMEOUT_MSG æ¶ˆæ¯ï¼Œå°†å…¶è®¾ç½®æˆfalseï¼Œå…è®¸ç»§ç»­æŠ›å‡ºBROADCAST_TIMEOUT_MSGæ¶ˆæ¯ã€‚</p><p><strong><font color="#7FF000" size="3">2ã€åˆ¤æ–­ç¬¬äºŒç§ANRæœºåˆ¶æ˜¯å¦è¶…æ—¶</font></strong></p><p>æ¯æ¬¡å°†å¹¿æ’­æ´¾å‘åˆ°æ¥æ”¶å™¨ï¼Œéƒ½ä¼šå°† r.receiverTime æ›´æ–°ï¼Œå¦‚æœåˆ¤æ–­å½“å‰è¿˜æœªè¶…æ—¶ï¼Œåˆ™åˆæŠ›å‡ºä¸€ä¸ª BROADCAST_TIMEOUT_MSG æ¶ˆæ¯ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼Œæ‰ä¼šæ¸…é™¤ BROADCAST_TIMEOUT_MSG ï¼›å¦åˆ™ï¼Œæ¯è¿›è¡Œä¸€æ¬¡å¹¿æ’­æ¶ˆæ¯çš„è°ƒåº¦ï¼Œéƒ½ä¼šæŠ›å‡º BROADCAST_TIMEOUT_MSG æ¶ˆæ¯ã€‚</p><p><strong><font color="#7FF000" size="3">3ã€å·²ç»è¶…æ—¶ï¼Œåˆ™ç»“æŸå¯¹å½“å‰æ¥æ”¶å™¨ï¼Œå¼€å§‹æ–°ä¸€è½®è°ƒåº¦</font></strong></p><p>åˆ¤æ–­å·²ç»è¶…æ—¶äº†ï¼Œè¯´æ˜å½“å‰çš„å¹¿æ’­æ¥æ”¶å™¨è¿˜æœªå¤„ç†å®Œæ¯•ï¼Œåˆ™ç»“æŸæ‰å½“å‰çš„æ¥æ”¶å™¨ï¼Œå¼€å§‹æ–°ä¸€è½®å¹¿æ’­è°ƒåº¦ã€‚</p><p><strong><font color="#7FF000" size="3">4ã€æŠ›å‡ºç»˜åˆ¶ANRå¯¹è¯æ¡†çš„æ¶ˆæ¯</font></strong></p><p>æœ€ç»ˆï¼Œå‘å‡ºç»˜åˆ¶ ANR å¯¹è¯æ¡†çš„æ¶ˆæ¯ã€‚</p><h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†å‰æ–‡æå‡ºçš„ä¸¤ä¸ªé—®é¢˜:</font></strong></p><p><strong><font color="#FF7F24">AMS ç»´æŠ¤ç€å¹¿æ’­é˜Ÿåˆ— BroadcastQueue ï¼ŒAMS çº¿ç¨‹ä¸æ–­ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œè°ƒåº¦ï¼Œå®Œæˆå¹¿æ’­æ¶ˆæ¯çš„æ´¾å‘ã€‚åœ¨æ´¾å‘â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€æ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ BROADCAST_TIMEOUT_MSG ï¼Œåœ¨å¹¿æ’­æ¥æ”¶å™¨å¤„ç†å®Œæ¯•åï¼ŒAMS ä¼šå°†å®šæ—¶æ¶ˆæ¯æ¸…é™¤ã€‚å¦‚æœ BROADCAST_TIMEOUT_MSG å¾—åˆ°äº†å“åº”ï¼Œå°±ä¼šåˆ¤æ–­æ˜¯å¦å¹¿æ’­æ¶ˆæ¯å¤„ç†è¶…æ—¶ï¼Œæœ€ç»ˆé€šçŸ¥ANRçš„å‘ç”Ÿã€‚</font></strong></p>]]></content>
      
      
      <categories>
          
          <category> æ€§èƒ½ä¼˜åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ€§èƒ½ä¼˜åŒ– </tag>
            
            <tag> Broadcast </tag>
            
            <tag> ANR </tag>
            
            <tag> æ— å“åº” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è°ˆè°ˆ ANR ä¹‹ Service è¶…æ—¶</title>
      <link href="/2019/04/29/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-service-chao-shi/"/>
      <url>/2019/04/29/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-service-chao-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="1-æ ¸å¿ƒæºç "><a href="#1-æ ¸å¿ƒæºç " class="headerlink" title="1. æ ¸å¿ƒæºç "></a>1. æ ¸å¿ƒæºç </h1><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„ï¼ˆ/frameworks/base/ï¼‰</th></tr></thead><tbody><tr><td><font color="#D15FEE">ActiveServices.java</font></td><td>services/core/java/com/android/server/am/ActiveServices.java</td></tr><tr><td><font color="#D15FEE">ActivityManagerService.java</font></td><td>services/core/java/com/android/server/am/ActivityManagerService.java</td></tr><tr><td><font color="#D15FEE">AppErrors.java</font></td><td>services/core/java/com/android/server/am/AppErrors.java</td></tr></tbody></table><p><br></p><hr><h1 id="2-ANR-åŸºç¡€è®¤çŸ¥"><a href="#2-ANR-åŸºç¡€è®¤çŸ¥" class="headerlink" title="2. ANR åŸºç¡€è®¤çŸ¥"></a>2. ANR åŸºç¡€è®¤çŸ¥</h1><h2 id="2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><strong><font color="#FF00FF">ANR(Application Not Responding)</font></strong>ï¼Œåº”ç”¨ç¨‹åºæ— å“åº”ï¼Œç®€å•ä¸€ä¸ªå®šä¹‰ï¼Œå´æ¶µç›–äº†å¾ˆå¤š Android ç³»ç»Ÿçš„è®¾è®¡æ€æƒ³ã€‚</p><p>é¦–å…ˆï¼Œ<font color="#0000FF">ANR å±äºåº”ç”¨ç¨‹åºçš„èŒƒç•´</font>ï¼Œè¿™ä¸åŒäº SNR(System Not Respoding)ï¼ŒSNR åæ˜ çš„é—®é¢˜æ˜¯ç³»ç»Ÿè¿›ç¨‹(system_server)å¤±å»äº†å“åº”èƒ½åŠ›ï¼Œè€Œ ANR æ˜ç¡®å°†é—®é¢˜åœˆå®šåœ¨åº”ç”¨ç¨‹åºã€‚<strong><code>SNR ç”± Watchdog æœºåˆ¶ä¿è¯ï¼ŒANR ç”±æ¶ˆæ¯å¤„ç†æœºåˆ¶ä¿è¯</code></strong>ï¼ŒAndroid åœ¨ç³»ç»Ÿå±‚å®ç°äº†ä¸€å¥—ç²¾å¯†çš„æœºåˆ¶æ¥å‘ç° ANRï¼Œæ ¸å¿ƒåŸç†æ˜¯<strong><code>æ¶ˆæ¯è°ƒåº¦</code></strong>å’Œ<strong><code>è¶…æ—¶å¤„ç†</code></strong>ã€‚</p><p>å…¶æ¬¡ï¼ŒANR æœºåˆ¶<strong><code>ä¸»ä½“å®ç°åœ¨ç³»ç»Ÿå±‚</code></strong>ã€‚æ‰€æœ‰ä¸ ANR ç›¸å…³çš„æ¶ˆæ¯ï¼Œéƒ½ä¼šç»è¿‡ç³»ç»Ÿè¿›ç¨‹(system_server)è°ƒåº¦ï¼Œç„¶åæ´¾å‘åˆ°åº”ç”¨è¿›ç¨‹å®Œæˆå¯¹æ¶ˆæ¯çš„å®é™…å¤„ç†ï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿè¿›ç¨‹è®¾è®¡äº†ä¸åŒçš„è¶…æ—¶é™åˆ¶æ¥è·Ÿè¸ªæ¶ˆæ¯çš„å¤„ç†ã€‚ä¸€æ—¦åº”ç”¨ç¨‹åºå¤„ç†æ¶ˆæ¯ä¸å½“ï¼Œè¶…æ—¶é™åˆ¶å°±èµ·ä½œç”¨äº†ï¼Œå®ƒæ”¶é›†ä¸€äº›ç³»ç»ŸçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šCPU/IOä½¿ç”¨æƒ…å†µã€è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆï¼Œå¹¶ä¸”æŠ¥å‘Šç”¨æˆ·æœ‰è¿›ç¨‹<strong><code>æ— å“åº”äº†ï¼ˆANR å¯¹è¯æ¡†ï¼‰</code></strong>ã€‚</p><p>ç„¶åï¼ŒANR é—®é¢˜<strong><code>æœ¬è´¨æ˜¯ä¸€ä¸ªæ€§èƒ½é—®é¢˜</code></strong>ã€‚ANR æœºåˆ¶å®é™…ä¸Šå¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„é™åˆ¶ï¼Œè¦æ±‚ä¸»çº¿ç¨‹åœ¨é™å®šçš„æ—¶é—´å†…å¤„ç†å®Œä¸€äº›æœ€å¸¸è§çš„æ“ä½œ(å¯åŠ¨æœåŠ¡ã€å¤„ç†å¹¿æ’­ã€å¤„ç†è¾“å…¥)ï¼Œå¦‚æœå¤„ç†è¶…æ—¶ï¼Œåˆ™è®¤ä¸ºä¸»çº¿ç¨‹å·²ç»å¤±å»äº†å“åº”å…¶ä»–æ“ä½œçš„èƒ½åŠ›ã€‚ä¸»çº¿ç¨‹ä¸­çš„<strong><code>è€—æ—¶æ“ä½œ</code></strong>ï¼Œä¾‹å¦‚ï¼šå¯†é›†CPUè¿ç®—ã€å¤§é‡IOã€å¤æ‚ç•Œé¢å¸ƒå±€ç­‰ï¼Œéƒ½ä¼šé™ä½åº”ç”¨ç¨‹åºçš„å“åº”èƒ½åŠ›ã€‚</p><p>æœ€åï¼Œéƒ¨åˆ† ANR é—®é¢˜æ˜¯å¾ˆéš¾åˆ†æçš„ï¼Œæœ‰æ—¶å€™ç”±äºç³»ç»Ÿåº•å±‚çš„ä¸€äº›å½±å“ï¼Œå¯¼è‡´æ¶ˆæ¯è°ƒåº¦å¤±è´¥ï¼Œå‡ºç°é—®é¢˜çš„åœºæ™¯åˆéš¾ä»¥å¤ç°ã€‚è¿™ç±» ANR é—®é¢˜å¾€å¾€éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´å»äº†è§£ç³»ç»Ÿçš„ä¸€äº›è¡Œä¸ºï¼Œè¶…å‡ºäº† ANR æœºåˆ¶æœ¬èº«çš„èŒƒç•´ã€‚</p><h2 id="2-2-ANR-æœºåˆ¶"><a href="#2-2-ANR-æœºåˆ¶" class="headerlink" title="2.2 ANR æœºåˆ¶"></a>2.2 ANR æœºåˆ¶</h2><p>åˆ†æä¸€äº›åˆçº§çš„ ANR é—®é¢˜ï¼Œåªéœ€è¦ç®€å•ç†è§£æœ€ç»ˆè¾“å‡ºçš„æ—¥å¿—å³å¯ï¼Œä½†å¯¹äºä¸€äº›ç”±ç³»ç»Ÿé—®é¢˜(ä¾‹å¦‚ï¼šCPU è´Ÿè½½è¿‡é«˜ã€è¿›ç¨‹å¡æ­»)å¼•å‘çš„ ANRï¼Œå°±éœ€è¦å¯¹æ•´ä¸ª ANR æœºåˆ¶æœ‰æ‰€äº†è§£ï¼Œæ‰èƒ½å®šä½å‡ºé—®é¢˜çš„åŸå› ã€‚</p><p><strong><font color="#FF0000" size="3">ANR æœºåˆ¶å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„ç›‘æµ‹</strong>ï¼šAndroid å¯¹äºä¸åŒçš„ ANR ç±»å‹(Broadcastï¼ŒServiceï¼ŒInputEvent)éƒ½æœ‰ä¸€å¥—ç›‘æµ‹æœºåˆ¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„æŠ¥å‘Š</strong>ï¼šåœ¨ç›‘æµ‹åˆ° ANR ä»¥åï¼Œéœ€è¦æ˜¾ç¤º ANR å¯¹è¯æ¡†ã€è¾“å‡ºæ—¥å¿—(å‘ç”Ÿ ANR æ—¶çš„è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆã€CPU ä½¿ç”¨æƒ…å†µç­‰)ã€‚</p><h2 id="2-3-ANR-çš„è§¦å‘åŸå› "><a href="#2-3-ANR-çš„è§¦å‘åŸå› " class="headerlink" title="2.3 ANR çš„è§¦å‘åŸå› "></a>2.3 ANR çš„è§¦å‘åŸå› </h2><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œå‡ºç° ANR ä¹‹åä¸€ä¸ªç›´è§‚ç°è±¡å°±æ˜¯ç³»ç»Ÿä¼šå±•ç¤ºå‡ºä¸€ä¸ª ANR å¯¹è¯æ¡†ã€‚</p><p><strong><font color="#FF0000" size="3">è°·æ­Œæ–‡æ¡£ä¸­å¯¹ ANR äº§ç”Ÿçš„åŸå› æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</font></strong></p><p>Android ç³»ç»Ÿä¸­çš„åº”ç”¨è¢« <code>ActivityManagerService</code> åŠ <code>WindowManagerService</code> ä¸¤ä¸ªç³»ç»ŸæœåŠ¡ç›‘æ§ç€ï¼Œç³»ç»Ÿä¼šåœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µå±•ç¤ºå‡º ANR çš„å¯¹è¯æ¡†ï¼</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">KeyDispatchTimeout</font>&nbsp;(<font color="#FF0000"> 5 seconds</font> ) ï¼šæŒ‰é”®æˆ–è§¦æ‘¸äº‹ä»¶åœ¨ç‰¹å®šæ—¶é—´å†…æ— å“åº”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">BroadcastTimeout</font>&nbsp;(<font color="#FF0000"> 10 seconds</font> )ï¼šBroadcastReceiver åœ¨ç‰¹å®šæ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">ServiceTimeout</font>&nbsp;(<font color="#FF0000"> 20 seconds</font> ) ï¼šService åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ</p><p>æœ¬ç¯‡åšæ–‡é‡ç‚¹è°ˆè°ˆ <strong><font color="#0000ff" size="3">Service è¶…æ—¶å¤„ç†çš„ç›¸å…³å†…å®¹</font></strong>ï¼Œå…³äº <strong><font color="#0000ff" size="3">Broadcast</font></strong> å’Œ <strong><font color="#0000ff" size="3">KeyDispatchTimeout</font></strong> å¯ä»¥æŸ¥çœ‹ï¼š</p><p><a href="https://superandroid.pro/2019/05/10/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-broadcast-chao-shi/">ã€è°ˆè°ˆ ANR ä¹‹ Broadcast è¶…æ—¶ã€‘</a> å’Œ <a href="https://superandroid.pro/2019/05/26/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-input-chao-shi/">ã€è°ˆè°ˆ ANR ä¹‹ Input è¶…æ—¶ã€‘</a> ä¸¤ç¯‡æ–‡ç« ã€‚</p><h1 id="3-Service-è¶…æ—¶ç›‘æµ‹æœºåˆ¶"><a href="#3-Service-è¶…æ—¶ç›‘æµ‹æœºåˆ¶" class="headerlink" title="3. Service è¶…æ—¶ç›‘æµ‹æœºåˆ¶"></a>3. Service è¶…æ—¶ç›‘æµ‹æœºåˆ¶</h1><p>Service è¿è¡Œåœ¨åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹ï¼Œå¦‚æœ Service çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡ 20 ç§’ï¼Œåˆ™ä¼šå¼•å‘ ANRã€‚</p><p>å½“å‘ç”Ÿ Service ANR æ—¶ï¼Œä¸€èˆ¬å¯ä»¥å…ˆæ’æŸ¥ä¸€ä¸‹åœ¨ Service çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­æœ‰æ²¡æœ‰åš<strong><code>è€—æ—¶çš„æ“ä½œ</code></strong>ï¼Œä¾‹å¦‚å¤æ‚çš„è¿ç®—ã€IO æ“ä½œç­‰ã€‚å¦‚æœåº”ç”¨ç¨‹åºçš„ä»£ç é€»è¾‘æŸ¥ä¸å‡ºé—®é¢˜ï¼Œå°±éœ€è¦æ·±å…¥æ£€æŸ¥å½“å‰ç³»ç»Ÿçš„çŠ¶æ€ï¼šCPU çš„ä½¿ç”¨æƒ…å†µã€ç³»ç»ŸæœåŠ¡çš„çŠ¶æ€ç­‰ï¼Œåˆ¤æ–­å½“æ—¶å‘ç”Ÿ ANR è¿›ç¨‹æ˜¯å¦å—åˆ°<strong><code>ç³»ç»Ÿè¿è¡Œå¼‚å¸¸</code></strong>çš„å½±å“ã€‚</p><p>é‚£ä¹ˆï¼Œç³»ç»Ÿæ˜¯å¦‚ä½•æ£€æµ‹ Service è¶…æ—¶çš„å‘¢ï¼Ÿ<strong><font color="#ff0000">Android æ˜¯é€šè¿‡è®¾ç½®å®šæ—¶æ¶ˆæ¯å®ç°çš„</font></strong>ã€‚å®šæ—¶æ¶ˆæ¯æ˜¯ç”± AMS çš„æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†çš„ï¼ŒAMS æœ‰ Service è¿è¡Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ AMS ä¸­è®¾ç½®ä¸€å¥—è¶…æ—¶æ£€æµ‹æœºåˆ¶ä¹Ÿæ˜¯åˆæƒ…åˆç†çš„ã€‚</p><p>Service ANR æœºåˆ¶ç›¸å¯¹æœ€ä¸ºç®€å•ï¼Œä¸»ä½“å®ç°åœ¨<code>ActiveServices</code>ä¸­ã€‚</p><p>åœ¨ Service çš„å¯åŠ¨æµç¨‹ä¸­ï¼ŒService è¿›ç¨‹ attach åˆ° system_server è¿›ç¨‹åä¼šè°ƒç”¨ <code>realStartServiceLocked()</code> æ–¹æ³•ã€‚</p><h2 id="3-1-realStartServiceLocked"><a href="#3-1-realStartServiceLocked" class="headerlink" title="3.1 realStartServiceLocked"></a>3.1 realStartServiceLocked</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActiveServices</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">realStartServiceLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span>            ProcessRecord app<span class="token punctuation">,</span> <span class="token keyword">boolean</span> execInFg<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å‘é€ delay æ¶ˆæ¯ï¼ˆSERVICE_TIMEOUT_MSGï¼‰</span>        <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> created <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æœ€ç»ˆæ‰§è¡ŒæœåŠ¡çš„ onCreate() æ–¹æ³•</span>            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleCreateService</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>                <span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>                app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="3-2-bumpServiceExecutingLocked"><a href="#3-2-bumpServiceExecutingLocked" class="headerlink" title="3.2 bumpServiceExecutingLocked"></a>3.2 bumpServiceExecutingLocked</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="3-3-scheduleServiceTimeoutLocked"><a href="#3-3-scheduleServiceTimeoutLocked" class="headerlink" title="3.3 scheduleServiceTimeoutLocked"></a>3.3 scheduleServiceTimeoutLocked</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>ProcessRecord proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Message msg <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>            ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>    msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> proc<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“è¶…æ—¶åä»æ²¡æœ‰ remove è¯¥ SERVICE_TIMEOUT_MSG æ¶ˆæ¯ï¼Œ</span>    <span class="token comment" spellcheck="true">// é€šè¿‡ AMS.MainHandler æŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ã€‚</span>    mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>            proc<span class="token punctuation">.</span>execServicesFg <span class="token operator">?</span> SERVICE_TIMEOUT <span class="token operator">:</span> SERVICE_BACKGROUND_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä¸Šè¿°æ–¹æ³•é€šè¿‡ <code>AMS.MainHandler</code> æŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ <code>SERVICE_TIMEOUT_MSG</code>ã€‚</p><h2 id="3-4-serviceDoneExecutingLocked"><a href="#3-4-serviceDoneExecutingLocked" class="headerlink" title="3.4 serviceDoneExecutingLocked"></a>3.4 serviceDoneExecutingLocked</h2><font color="#0000ff" size="3">å‰å°è¿›ç¨‹ä¸­æ‰§è¡Œ Serviceï¼Œè¶…æ—¶æ—¶é—´æ˜¯ SERVICE_TIMEOUTï¼ˆ20 ç§’ï¼‰</font><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_TIMEOUT <span class="token operator">=</span> <span class="token number">20</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span></code></pre><font color="#0000ff" size="3">åå°è¿›ç¨‹ä¸­æ‰§è¡Œ Serviceï¼Œè¶…æ—¶æ—¶é—´æ˜¯ SERVICE_BACKGROUND_TIMEOUTï¼ˆ200 ç§’ï¼‰</font><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// How long we wait for a service to finish executing.</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SERVICE_BACKGROUND_TIMEOUT <span class="token operator">=</span> SERVICE_TIMEOUT <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span></code></pre><p>å½“ Service çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼ˆä¸ä¼š ANRï¼‰ï¼Œä¼šè°ƒç”¨ <code>serviceDoneExecutingLocked()</code> æ–¹æ³•ï¼Œä¹‹å‰æŠ›å‡ºçš„ <code>SERVICE_TIMEOUT_MSG</code> æ¶ˆæ¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šè¢«æ¸…é™¤ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">,</span> <span class="token keyword">int</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> inDestroying <span class="token operator">=</span> mDestroyingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> inDestroying<span class="token punctuation">,</span> inDestroying<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>ServiceRecord r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inDestroying<span class="token punctuation">,</span>          <span class="token keyword">boolean</span> finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// å½“å‰æœåŠ¡æ‰€åœ¨è¿›ç¨‹ä¸­æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„serviceï¼Œæ¸…é™¤ SERVICE_TIMEOUT_MSG æ¶ˆæ¯</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>                             ActivityManagerService<span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-5-handleMessage"><a href="#3-5-handleMessage" class="headerlink" title="3.5 handleMessage"></a>3.5 handleMessage</h2><p>å¦‚æœæ²¡æœ‰ Remove æ‰ SERVICE_TIMEOUT_MSG å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¯¹äº ANR çš„å¤„ç†é€»è¾‘ã€‚</p><p>åœ¨ system_server è¿›ç¨‹ä¸­æœ‰ä¸€ä¸ª Handler çº¿ç¨‹ï¼Œåå« <code>ActivityManager</code>ã€‚</p><p>å¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…ï¼Œ<code>SERVICE_TIMEOUT_MSG</code> æ²¡æœ‰è¢«æ¸…é™¤ï¼Œä¾¿ä¼šå‘è¯¥ <code>Handler</code> çº¿ç¨‹å‘é€ä¸€æ¡ä¿¡æ¯ <code>SERVICE_TIMEOUT_MSG</code>ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MainHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">case</span> SERVICE_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{</span>                mServices<span class="token punctuation">.</span><span class="token function">serviceTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ProcessRecord<span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="3-6-serviceTimeout"><a href="#3-6-serviceTimeout" class="headerlink" title="3.6 serviceTimeout"></a>3.6 serviceTimeout</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">serviceTimeout</span><span class="token punctuation">(</span>ProcessRecord proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>    String anrMessage <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mAm<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">long</span> nextTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯»æ‰¾è¿è¡Œè¶…æ—¶çš„ Service</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ServiceRecord sr <span class="token operator">=</span> proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sr<span class="token punctuation">.</span>executingStart <span class="token operator">&lt;</span> maxTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>                timeout <span class="token operator">=</span> sr<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sr<span class="token punctuation">.</span>executingStart <span class="token operator">></span> nextTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>                nextTime <span class="token operator">=</span> sr<span class="token punctuation">.</span>executingStart<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­æ‰§è¡Œ Service è¶…æ—¶çš„è¿›ç¨‹æ˜¯å¦åœ¨æœ€è¿‘è¿è¡Œè¿›ç¨‹åˆ—è¡¨ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™å¿½ç•¥è¿™ä¸ª ANR</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mAm<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Timeout executing service: "</span> <span class="token operator">+</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>            StringWriter sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            PrintWriter pw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastPrintWriter</span><span class="token punctuation">(</span>sw<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>            timeout<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>pw<span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mLastAnrDump <span class="token operator">=</span> sw<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>mLastAnrDumpClearer<span class="token punctuation">)</span><span class="token punctuation">;</span>            mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>mLastAnrDumpClearer<span class="token punctuation">,</span>                                            LAST_ANR_LIFETIME_DURATION_MSECS<span class="token punctuation">)</span><span class="token punctuation">;</span>            anrMessage <span class="token operator">=</span> <span class="token string">"executing service "</span> <span class="token operator">+</span> timeout<span class="token punctuation">.</span>shortName<span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>anrMessage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å½“å­˜åœ¨ timeout çš„ serviceï¼Œåˆ™æ‰§è¡Œ appNotResponding</span>        mAm<span class="token punctuation">.</span>mAppErrors<span class="token punctuation">.</span><span class="token function">appNotResponding</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> anrMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šè¿°æ–¹æ³•ä¼šæ‰¾åˆ°å½“å‰è¿›ç¨‹å·²ç»è¶…æ—¶çš„ Serviceï¼Œç»è¿‡ä¸€äº›åˆ¤å®šåï¼Œå†³å®šè¦æŠ¥å‘Š ANRï¼Œæœ€ç»ˆè°ƒç”¨ <code>AMS.appNotResponding()</code> æ–¹æ³•ã€‚</p><p>èµ°åˆ°è¿™ä¸€æ­¥ï¼ŒANR æœºåˆ¶å·²ç»å®Œæˆäº†ç›‘æµ‹æŠ¥å‘Šä»»åŠ¡ï¼Œå‰©ä¸‹çš„ä»»åŠ¡å°±æ˜¯ ANR ç»“æœçš„è¾“å‡ºï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º ANR çš„æŠ¥å‘Šæœºåˆ¶ã€‚ANR çš„æŠ¥å‘Šæœºåˆ¶æ˜¯é€šè¿‡ <code>AMS.appNotResponding()</code> å®Œæˆçš„ï¼ŒBroadcast å’Œ InputEvent ç±»å‹çš„ ANR æœ€ç»ˆä¹Ÿéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p><h1 id="4-ANR-ä¿¡æ¯æ”¶é›†è¿‡ç¨‹"><a href="#4-ANR-ä¿¡æ¯æ”¶é›†è¿‡ç¨‹" class="headerlink" title="4. ANR ä¿¡æ¯æ”¶é›†è¿‡ç¨‹"></a>4. ANR ä¿¡æ¯æ”¶é›†è¿‡ç¨‹</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ Android ANR çš„ä¿¡æ¯æ”¶é›†è¿‡ç¨‹ï¼</p><h2 id="4-1-appNotResponding"><a href="#4-1-appNotResponding" class="headerlink" title="4.1 appNotResponding"></a>4.1 appNotResponding</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/am/AppErrors.java</span><span class="token keyword">class</span> <span class="token class-name">AppErrors</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">appNotResponding</span><span class="token punctuation">(</span>ProcessRecord app<span class="token punctuation">,</span> ActivityRecord activity<span class="token punctuation">,</span>            ActivityRecord parent<span class="token punctuation">,</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> <span class="token keyword">final</span> String annotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">long</span> anrTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>MONITOR_CPU_USAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// æ›´æ–° cpu ç»Ÿè®¡ä¿¡æ¯</span>        <span class="token punctuation">}</span>        <span class="token keyword">boolean</span> showBackground <span class="token operator">=</span> Settings<span class="token punctuation">.</span>Secure<span class="token punctuation">.</span>                <span class="token function">getInt</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                           Settings<span class="token punctuation">.</span>Secure<span class="token punctuation">.</span>ANR_SHOW_BACKGROUND<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> isSilentANR<span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mShuttingDown<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>notResponding<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>crashing<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>killedByAm<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// In case we come through here for the same app before completing</span>            <span class="token comment" spellcheck="true">// this one, mark as anring now so we will bail out.</span>            app<span class="token punctuation">.</span>notResponding <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è®°å½• ANR åˆ° EventLog</span>            EventLog<span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span>EventLogTags<span class="token punctuation">.</span>AM_ANR<span class="token punctuation">,</span> app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span>                    app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å°†å½“å‰è¿›ç¨‹æ·»åŠ åˆ° firstPids</span>            firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Don't dump other PIDs if it's a background ANR</span>            isSilentANR <span class="token operator">=</span> <span class="token operator">!</span>showBackground                                   <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isInterestingForBackgroundTraces</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSilentANR<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> parentPid <span class="token operator">=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    parentPid <span class="token operator">=</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentPid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parentPid<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å°† system_server è¿›ç¨‹æ·»åŠ åˆ° firstPids</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>MY_PID <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid                                 <span class="token operator">&amp;&amp;</span> MY_PID <span class="token operator">!=</span> parentPid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>MY_PID<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    ProcessRecord r <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">int</span> pid <span class="token operator">=</span> r<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid                                        <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> parentPid <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> MY_PID<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// å°† persistent è¿›ç¨‹æ·»åŠ åˆ° firstPids</span>                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>treatLikeActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// å…¶ä»–è¿›ç¨‹æ·»åŠ åˆ° lastPids</span>                                lastPids<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è®°å½• ANR è¾“å‡ºåˆ° main log</span>        StringBuilder info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        info<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"ANR in "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> activity<span class="token punctuation">.</span>shortComponentName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" ("</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"PID: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Reason: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>annotation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> parent <span class="token operator">!=</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Parent: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ›å»º CPU tracker å¯¹è±¡ </span>        ProcessCpuTracker processCpuTracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessCpuTracker</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// è¾“å‡º traces ä¿¡æ¯</span>        File tracesFile <span class="token operator">=</span> ActivityManagerService<span class="token punctuation">.</span><span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>                <span class="token boolean">true</span><span class="token punctuation">,</span> firstPids<span class="token punctuation">,</span>                <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> processCpuTracker<span class="token punctuation">,</span>                <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> lastPids<span class="token punctuation">,</span>                nativePids<span class="token punctuation">)</span><span class="token punctuation">;</span>        String cpuInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManagerService<span class="token punctuation">.</span>MONITOR_CPU_USAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessCpuTracker<span class="token punctuation">)</span> <span class="token punctuation">{</span>                cpuInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessCpuTracker<span class="token punctuation">.</span><span class="token function">printCurrentState</span><span class="token punctuation">(</span>anrTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// è®°å½•å½“å‰ CPU è´Ÿè½½æƒ…å†µ</span>            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>processCpuTracker<span class="token punctuation">.</span><span class="token function">printCurrentLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cpuInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è®°å½•ä» anr æ—¶é—´å¼€å§‹çš„ Cpu ä½¿ç”¨æƒ…å†µ</span>        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>processCpuTracker<span class="token punctuation">.</span><span class="token function">printCurrentState</span><span class="token punctuation">(</span>anrTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è¾“å‡ºå½“å‰ ANR çš„ reasonï¼Œä»¥åŠ CPU ä½¿ç”¨ç‡ã€è´Ÿè½½ä¿¡æ¯</span>        Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tracesFile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Process<span class="token punctuation">.</span><span class="token function">sendSignal</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> Process<span class="token punctuation">.</span>SIGNAL_QUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// å°† traces æ–‡ä»¶å’Œ CPU ä½¿ç”¨ç‡ä¿¡æ¯ä¿å­˜åˆ° dropboxï¼Œå³ data/system/dropbox ç›®å½•</span>        mService<span class="token punctuation">.</span><span class="token function">addErrorToDropBox</span><span class="token punctuation">(</span><span class="token string">"anr"</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>                          activity<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> cpuInfo<span class="token punctuation">,</span> tracesFile<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mService<span class="token punctuation">.</span>mBatteryStatsService<span class="token punctuation">.</span><span class="token function">noteProcessAnr</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// åå° ANR çš„æƒ…å†µ, ç›´æ¥æ€æ‰</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token punctuation">{</span>                app<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">"bg anr"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// è®¾ç½® app çš„ ANR çŠ¶æ€ï¼Œç—…æŸ¥è¯¢é”™è¯¯æŠ¥å‘Š receiver</span>            <span class="token function">makeAppNotRespondingLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span>                    activity <span class="token operator">!=</span> null <span class="token operator">?</span> activity<span class="token punctuation">.</span>shortComponentName <span class="token operator">:</span> null<span class="token punctuation">,</span>                    annotation <span class="token operator">!=</span> null <span class="token operator">?</span> <span class="token string">"ANR "</span> <span class="token operator">+</span> annotation <span class="token operator">:</span> <span class="token string">"ANR"</span><span class="token punctuation">,</span>                    info<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¼¹å‡º ANR å¯¹è¯æ¡†</span>            Message msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            msg<span class="token punctuation">.</span>what <span class="token operator">=</span> ActivityManagerService<span class="token punctuation">.</span>SHOW_NOT_RESPONDING_UI_MSG<span class="token punctuation">;</span>            msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppNotRespondingDialog<span class="token punctuation">.</span>Data</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å‘ ui çº¿ç¨‹å‘é€ï¼Œå†…å®¹ä¸º SHOW_NOT_RESPONDING_MSG çš„æ¶ˆæ¯</span>            mService<span class="token punctuation">.</span>mUiHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>å½“å‘ç”Ÿ ANR æ—¶, ä¼šæŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œï¼š</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;1ã€è¾“å‡º <code>ANR Reason</code> ä¿¡æ¯åˆ° <code>EventLog</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ ANR è§¦å‘çš„æ—¶é—´ç‚¹æœ€æ¥è¿‘çš„å°±æ˜¯ <code>EventLog</code> ä¸­è¾“å‡ºçš„ <code>am_anr</code> ä¿¡æ¯;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;2ã€æ”¶é›†å¹¶è¾“å‡ºé‡è¦è¿›ç¨‹åˆ—è¡¨ä¸­çš„å„ä¸ªçº¿ç¨‹çš„ <code>traces</code> ä¿¡æ¯ï¼Œè¯¥æ–¹æ³•è¾ƒè€—æ—¶ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;3ã€è¾“å‡ºå½“å‰å„ä¸ªè¿›ç¨‹çš„ <code>CPU ä½¿ç”¨æƒ…å†µ</code>ä»¥åŠ <code>CPU è´Ÿè½½æƒ…å†µ</code>ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;4ã€å°† <code>traces æ–‡ä»¶</code>å’Œ <code>CPU ä½¿ç”¨æƒ…å†µä¿¡æ¯</code>ä¿å­˜åˆ° <code>dropbox</code>ï¼Œå³ <code>data/system/dropbox</code> ç›®å½•ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;5ã€æ ¹æ®è¿›ç¨‹ç±»å‹ï¼Œæ¥å†³å®š<code>ç›´æ¥åå°æ€æ‰</code>ï¼Œè¿˜æ˜¯<code>å¼¹æ¡†å‘ŠçŸ¥ç”¨æˆ·</code>ã€‚</p><blockquote><p>ANRè¾“å‡ºé‡è¦è¿›ç¨‹çš„tracesä¿¡æ¯ï¼Œè¿™äº›è¿›ç¨‹åŒ…å«ï¼š</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;1ã€<strong>firstPids é˜Ÿåˆ—</strong>ï¼šç¬¬ä¸€ä¸ªæ˜¯ <code>ANR</code> è¿›ç¨‹ï¼Œç¬¬äºŒä¸ªæ˜¯ <code>system_server</code>ï¼Œå‰©ä½™æ˜¯æ‰€æœ‰ <code>persistent</code> è¿›ç¨‹ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;2ã€<strong>Native é˜Ÿåˆ—</strong>ï¼šæ˜¯æŒ‡ <code>/system/bin/</code> ç›®å½•çš„ <code>mediaserver</code>ã€<code>sdcard</code> ä»¥åŠ <code>surfaceflinger</code> è¿›ç¨‹ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;3ã€<strong>lastPids é˜Ÿåˆ—</strong>: æ˜¯æŒ‡ <code>mLruProcesses</code> ä¸­çš„<code>ä¸å±äº firstPids</code> çš„æ‰€æœ‰è¿›ç¨‹ã€‚</p><h2 id="4-2-dumpStackTraces"><a href="#4-2-dumpStackTraces" class="headerlink" title="4.2 dumpStackTraces"></a>4.2 dumpStackTraces</h2><p>ç»§ç»­çœ‹çœ‹ dump å‡º trace ä¿¡æ¯çš„æµç¨‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ActivityManagerService.java</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> File <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> clearTraces<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">,</span>nativePids<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tracesDirProp<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// é»˜è®¤ä¸º data/anr/traces.txt</span>            String globalTracesPath <span class="token operator">=</span>                           SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"dalvik.vm.stack-trace-file"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            tracesFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>globalTracesPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>clearTraces <span class="token operator">&amp;&amp;</span> tracesFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    tracesFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// åˆ é™¤å·²å­˜åœ¨çš„ traces æ–‡ä»¶</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// è¿™é‡Œä¼šä¿è¯ data/anr/traces.txt æ–‡ä»¶å†…å®¹æ˜¯å…¨æ–°çš„æ–¹å¼ï¼Œè€Œéè¿½åŠ </span>                tracesFile<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// åˆ›å»º traces æ–‡ä»¶</span>                FileUtils<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>globalTracesPath<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unable to prepare ANR traces file: "</span> <span class="token operator">+</span> tracesFile<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è¾“å‡º trace å†…å®¹</span>        <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>tracesFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> firstPids<span class="token punctuation">,</span> nativePids<span class="token punctuation">,</span>                                         extraPids<span class="token punctuation">,</span> useTombstonedForJavaTraces<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> tracesFile<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-3-dumpStackTraces"><a href="#4-3-dumpStackTraces" class="headerlink" title="4.3 dumpStackTraces"></a>4.3 dumpStackTraces</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ActivityManagerService.java</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dumpStackTraces</span><span class="token punctuation">(</span>String tracesFile<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> DumpStackFileObserver observer<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>            observer <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DumpStackFileObserver</span><span class="token punctuation">(</span>tracesFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// We must complete all stack dumps within 20 seconds.</span>        <span class="token keyword">long</span> remainingTime <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                observer<span class="token punctuation">.</span><span class="token function">startWatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// é¦–å…ˆï¼Œè·å– firstPids è¿›ç¨‹çš„ stacks</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstPids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> num <span class="token operator">=</span> firstPids<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>useTombstonedForJavaTraces<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        timeTaken <span class="token operator">=</span> <span class="token function">dumpJavaTracesTombstoned</span><span class="token punctuation">(</span>firstPids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>                                                   tracesFile<span class="token punctuation">,</span> remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        timeTaken <span class="token operator">=</span> observer<span class="token punctuation">.</span><span class="token function">dumpWithTimeout</span><span class="token punctuation">(</span>firstPids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>                                                               remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// ä¸‹ä¸€æ­¥ï¼Œè·å– native è¿›ç¨‹çš„ stacks</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nativePids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pid <span class="token operator">:</span> nativePids<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token comment" spellcheck="true">// è¾“å‡º native è¿›ç¨‹çš„ trace</span>                    Debug<span class="token punctuation">.</span><span class="token function">dumpNativeBacktraceToFileTimeout</span><span class="token punctuation">(</span>                            pid<span class="token punctuation">,</span> tracesFile<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nativeDumpTimeoutMs <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Lastly, dump stacks for all extra PIDs from the CPU tracker.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>extraPids <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                observer<span class="token punctuation">.</span><span class="token function">stopWatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-4-å°ç»“"><a href="#4-4-å°ç»“" class="headerlink" title="4.4 å°ç»“"></a>4.4 å°ç»“</h2><blockquote><p>è§¦å‘ ANR æ—¶ç³»ç»Ÿä¼šè¾“å‡ºå…³é”®ä¿¡æ¯ï¼š</p></blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;1ã€å°† <code>am_anr</code> ä¿¡æ¯ï¼Œè¾“å‡ºåˆ° <code>EventLog</code>ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;2ã€è·å–é‡è¦è¿›ç¨‹ <code>trace</code> ä¿¡æ¯ï¼Œä¿å­˜åˆ° <code>/data/anr/traces.txt</code>ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;3ã€<code>ANR reason</code> ä»¥åŠ <code>CPU</code> ä½¿ç”¨æƒ…å†µä¿¡æ¯ï¼Œè¾“å‡ºåˆ° <code>main log</code>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;4ã€å†å°† <code>CPUä½¿ç”¨æƒ…å†µ</code> å’Œè¿›ç¨‹ <code>trace æ–‡ä»¶</code>ä¿¡æ¯ï¼Œå†ä¿å­˜åˆ° <code>/data/system/dropbox</code>ã€‚</p><h1 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. æ€»ç»“</h1><p>å½“ Service å‡ºç° ANR æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° <code>AMS.appNotResponding()</code>æ–¹æ³•ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;1ã€å¯¹äº<code>å‰å°æœåŠ¡</code>ï¼Œåˆ™è¶…æ—¶ä¸º <code>SERVICE_TIMEOUT = 20s</code>ï¼›</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;2ã€å¯¹äº<code>åå°æœåŠ¡</code>ï¼Œåˆ™è¶…æ—¶ä¸º <code>SERVICE_BACKGROUND_TIMEOUT = 200s</code>ï¼›</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;3ã€Service è¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼š<code>è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰æ‰§è¡Œå®Œç›¸åº”æ“ä½œ</code>æ¥è§¦å‘<code>å»¶æ—¶æ¶ˆæ¯</code>ï¼Œåˆ™ä¼šè§¦å‘ <code>ANR</code>;</p>]]></content>
      
      
      <categories>
          
          <category> æ€§èƒ½ä¼˜åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ€§èƒ½ä¼˜åŒ– </tag>
            
            <tag> ANR </tag>
            
            <tag> æ— å“åº” </tag>
            
            <tag> Service </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åº”ç”¨ ANR åˆ†æå®å½•</title>
      <link href="/2019/04/24/07.xing-neng-you-hua-xi-lie-ying-yong-anr-fen-xi-shi-lu/"/>
      <url>/2019/04/24/07.xing-neng-you-hua-xi-lie-ying-yong-anr-fen-xi-shi-lu/</url>
      
        <content type="html"><![CDATA[<p>åˆ†æ ANR é—®é¢˜ï¼Œæœ‰ä¸‰å¤§åˆ©å™¨ï¼š<strong><font color="#ff0000">Logcat</font></strong>ï¼Œ<strong><font color="#ff0000">traces</font></strong> å’Œ <strong><font color="#ff0000">StrictMode</font></strong>ï¼ˆä¸ä½œè®¨è®ºï¼‰ã€‚éœ€è¦ç»è¿‡ <strong><font color="#ff00ff">æ—¥å¿—è·å–</font></strong>ã€<strong><font color="#ff00ff">é—®é¢˜å®šä½</font></strong> å’Œ <strong><font color="#ff00ff">åœºæ™¯è¿˜åŸ</font></strong> ä¸‰ä¸ªæ­¥éª¤ã€‚</p><h2 id="1-æ—¥å¿—è·å–"><a href="#1-æ—¥å¿—è·å–" class="headerlink" title="1. æ—¥å¿—è·å–"></a>1. æ—¥å¿—è·å–</h2><p>å¦‚ä½•è·å–æ—¥å¿—ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å»è¯¦ç»†åˆ†æï¼Œåé¢æ‰“ç®—é€šè¿‡ Watchdog æœºåˆ¶åŠ ä»¥è¯¦è§£ï¼Œè¿™è¾¹æˆ‘ä»¬ä»¥æ‹¿åˆ°çš„æµ‹è¯• Log ä¸ºå‡†æ¥è¿›è¡Œåˆ†æã€‚</p><h2 id="2-é—®é¢˜å®šä½"><a href="#2-é—®é¢˜å®šä½" class="headerlink" title="2. é—®é¢˜å®šä½"></a>2. é—®é¢˜å®šä½</h2><p>æˆ‘ä»¬ç°åœ¨ä»¥ä¸€ä»½ ANR æ—¥å¿—ä¸ºä¾‹ï¼Œåˆ†æå¦‚ä½•å®šä½ ANRã€‚</p><p>1ã€é€šè¿‡åœ¨ <code>event log</code> ä¸­æ£€ç´¢ <code>am_anr</code> å…³é”®å­—ï¼Œå°±å¯ä»¥æ‰¾åˆ°å‘ç”Ÿ ANR çš„è¿›ç¨‹ï¼š</p><pre class=" language-log"><code class="language-log">04-24 00:48:27 820 907 I am_anr: [0,29533,com.android.systemui,1082670605,Broadcast of Intent { act=android.intent.action.TIME_TICK flg=0x50000114 (has extras) }]</code></pre><p>2ã€æ¥ä¸‹æ¥å¯ä»¥åœ¨ <code>system log</code> æ£€ç´¢ <code>ANR in</code> å…³é”®å­—ï¼Œæ‰¾åˆ°å‘ç”Ÿ <code>ANR å‰å</code>çš„ <code>CPU</code> ä½¿ç”¨æƒ…å†µï¼š</p><pre class=" language-log"><code class="language-log">04-24 00:50:10 820 907 E ActivityManager: ANR in com.android.systemui, time=13009069504-24 00:50:10 820 907 E ActivityManager: Reason: Broadcast of Intent { act=android.intent.action.TIME_TICK flg=0x50000114 (has extras) }04-24 00:50:10 820 907 E ActivityManager: Load: 30.4 / 22.34 / 19.9404-24 00:50:10 820 907 E ActivityManager: Android time :[2015-04-24 00:50:05.76] [130191,266]04-24 00:50:10 820 907 E ActivityManager: CPU usage from 6753ms to -4ms ago:04-24 00:50:10 820 907 E ActivityManager:   47% 320/netd: 3.1% user + 44% kernel / faults: 14886 minor 3 major04-24 00:50:10 820 907 E ActivityManager:   15% 10007/com.sohu.sohuvideo: 2.8% user + 12% kernel / faults: 1144 minor04-24 00:50:10 820 907 E ActivityManager:   13% 10654/hif_thread: 0% user + 13% kernel04-24 00:50:10 820 907 E ActivityManager:   11% 175/mmcqd/0: 0% user + 11% kernel04-24 00:50:10 820 907 E ActivityManager:   5.1% 12165/app_process: 1.6% user + 3.5% kernel / faults: 9703 minor 540 major04-24 00:50:10 820 907 E ActivityManager:   3.3% 29533/com.android.systemui: 2.6% user + 0.7% kernel / faults: 8402 minor 343 major04-24 00:50:10 820 907 E ActivityManager:   3.2% 820/system_server: 0.8% user + 2.3% kernel / faults: 5120 minor 523 major04-24 00:50:10 820 907 E ActivityManager:   2.5% 11817/com.netease.pomelo.push.l.messageservice_V2: 0.7% user + 1.7% kernel / faults: 7728 minor 687 major04-24 00:50:10 820 907 E ActivityManager:   1.6% 11887/com.android.email: 0.5% user + 1% kernel / faults: 6259 minor 587 major04-24 00:50:10 820 907 E ActivityManager:   1.4% 11854/com.android.settings: 0.7% user + 0.7% kernel / faults: 5404 minor 471 major04-24 00:50:10 820 907 E ActivityManager:   1.4% 11869/android.process.acore: 0.7% user + 0.7% kernel / faults: 6131 minor 561 major04-24 00:50:10 820 907 E ActivityManager:   1.3% 11860/com.tencent.mobileqq: 0.1% user + 1.1% kernel / faults: 5542 minor 470 major...04-24 00:50:10 820 907 E ActivityManager:  +0% 12832/cat: 0% user + 0% kernel04-24 00:50:10 820 907 E ActivityManager:  +0% 13211/zygote64: 0% user + 0% kernel04-24 00:50:10 820 907 E ActivityManager: 87% TOTAL: 3% user + 18% kernel + 64% iowait + 0.5% softirq</code></pre><p>ä»¥ä¸Šæ—¥å¿—çš„ä¿¡æ¯é‡å°±å¾ˆå¤§äº†ï¼š</p><p>âœ&nbsp;<strong><font color="#0000ff" size="3">å‘ç”Ÿ ANR çš„æ—¶é—´ï¼š</font></strong>event log ä¸­ï¼ŒANR çš„æ—¶é—´æ˜¯ 00:48:27ï¼Œå› ä¸º AMS.appNotResponding() é¦–å…ˆä¼šæ‰“å° event logï¼Œç„¶åå†æ‰“å° system logï¼Œæ‰€ä»¥åœ¨ system log ä¸­ï¼Œæ‰¾åˆ° ANR çš„æ—¶é—´æ˜¯ 00:50:10ã€‚å¯ä»¥ä»è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„æ—¥å¿—ä¸­ï¼Œè¿˜åŸ ANR å‡ºç°æ—¶ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€‚</p><p>âœ&nbsp;<strong><font color="#0000ff" size="3">æ‰“å° ANR çš„è¿›ç¨‹ï¼š</font></strong>ANR æ—¥å¿—éƒ½æ˜¯åœ¨ system_server è¿›ç¨‹ä¸­çš„ AMS æ‰“å°çš„ï¼Œåœ¨ event log å’Œ system log ä¸­ï¼Œéƒ½èƒ½çœ‹åˆ° 820å’Œ 907ï¼Œæ‰€ä»¥ system_server çš„ PID æ˜¯ 802ï¼ŒAMS çº¿ç¨‹çš„ TID æ˜¯ 907ã€‚ANR çš„ç›‘æµ‹æœºåˆ¶å®ç°åœ¨ AMS çº¿ç¨‹ï¼Œåˆ†æä¸€äº›å—ç³»ç»Ÿå½±å“çš„ ANRï¼Œéœ€è¦çŸ¥é“ system_server è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚</p><p>âœ&nbsp;<strong><font color="#0000ff" size="3">å‘ç”Ÿ ANR çš„è¿›ç¨‹ï¼š</font></strong>ANR in å…³é”®å­—å°±è¡¨æ˜äº†å½“å‰ ANR çš„è¿›ç¨‹æ˜¯ com.android.system.uiï¼Œé€šè¿‡ event logï¼ŒçŸ¥é“è¿›ç¨‹çš„ PID æ˜¯ 29533ã€‚</p><p>âœ&nbsp;<strong><font color="#0000ff" size="3">å‘ç”Ÿ ANR çš„åŸå› ï¼š</font></strong>Reason å…³é”®å­—è¡¨æ˜äº†å½“å‰å‘ç”Ÿ ANR çš„åŸå› ï¼šå¤„ç† TIME_TICK å¹¿æ’­æ¶ˆæ¯è¶…æ—¶ã€‚éšå«çš„æ„æ€æ˜¯ TIME_TICK æ˜¯ä¸€ä¸ªä¸²è¡Œå¹¿æ’­æ¶ˆæ¯ï¼Œåœ¨ 29533 çš„ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œ BroadcastReceiver.onReceive() æ–¹æ³•å·²ç»è¶…è¿‡ 10 ç§’ã€‚</p><p>âœ&nbsp;<strong><font color="#0000ff" size="3">CPU è´Ÿè½½ï¼š</font></strong>Load å…³é”®å­—è¡¨æ˜äº†æœ€è¿‘1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿå†…çš„ CPU è´Ÿè½½åˆ†åˆ«æ˜¯ 30.4ã€22.3ã€19.94ã€‚CPU æœ€è¿‘1åˆ†é’Ÿçš„è´Ÿè½½æœ€å…·å‚è€ƒä»·å€¼ï¼Œå› ä¸º ANR çš„è¶…æ—¶é™åˆ¶åŸºæœ¬éƒ½æ˜¯ 1 åˆ†é’Ÿä»¥å†…ï¼Œè¿™å¯ä»¥è¿‘ä¼¼çš„ç†è§£ä¸º CPU æœ€è¿‘1åˆ†é’Ÿå¹³å‡æœ‰ 30.4 ä¸ªä»»åŠ¡è¦å¤„ç†ï¼Œè¿™ä¸ªè´Ÿè½½å€¼æ˜¯æ¯”è¾ƒé«˜çš„ã€‚</p><p>âœ&nbsp;<strong><font color="#0000ff" size="3">CPU ä½¿ç”¨ç»Ÿè®¡æ—¶é—´æ®µï¼š</font></strong>CPU usage from XX to XX ago å…³é”®å­—è¡¨æ˜äº†è¿™æ˜¯åœ¨ ANR å‘ç”Ÿä¹‹å‰ä¸€æ®µæ—¶é—´å†…çš„ CPU ç»Ÿè®¡ã€‚ç±»ä¼¼çš„è¿˜æœ‰ CPU usage from XX to XX after å…³é”®å­—ï¼Œè¡¨æ˜æ˜¯ ANR å‘ç”Ÿä¹‹åä¸€æ®µæ—¶é—´å†…çš„ CPU ç»Ÿè®¡ã€‚</p><p>âœ&nbsp;<strong><font color="#0000ff" size="3">å„è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ï¼š</font></strong>æˆ‘ä»¬ä»¥ com.android.systemui è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ä¸ºä¾‹ï¼Œå®ƒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¦ æ€»çš„CPUä½¿ç”¨ç‡: 3.3%ï¼Œå…¶ä¸­ systemui è¿›ç¨‹åœ¨ç”¨æˆ·æ€çš„ CPU ä½¿ç”¨ç‡æ˜¯2.6%ï¼Œåœ¨å†…æ ¸æ€çš„ä½¿ç”¨ç‡æ˜¯0.7%ï¼›</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¦ ç¼ºé¡µæ¬¡æ•°faultï¼š8402 minor è¡¨ç¤ºé«˜é€Ÿç¼“å­˜ä¸­çš„ç¼ºé¡µæ¬¡æ•°ï¼Œ343 major è¡¨ç¤ºå†…å­˜çš„ç¼ºé¡µæ¬¡æ•°ã€‚minor å¯ä»¥ç†è§£ä¸ºè¿›ç¨‹åœ¨åšå†…å­˜è®¿é—®ï¼Œmajor å¯ä»¥ç†è§£ä¸ºè¿›ç¨‹åœ¨åš IO æ“ä½œã€‚å½“å‰ minor å’Œ major å€¼éƒ½æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œä»ä¾§é¢åæ˜ äº†å‘ç”Ÿ ANR ä¹‹å‰ï¼Œsystemui è¿›ç¨‹æœ‰è¾ƒå¤šçš„å†…å­˜è®¿é—®æ“ä½œï¼Œå¼•å‘çš„ IO æ¬¡æ•°ä¹Ÿä¼šè¾ƒå¤šï¼›</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¦ CPU ä½¿ç”¨ç‡å‰é¢çš„ â€œ+â€ï¼šéƒ¨åˆ†è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡å‰é¢æœ‰ â€œ+â€ å·ï¼Œä¾‹å¦‚ï¼šcat å’Œ zygote64ï¼Œè¡¨ç¤ºåœ¨ä¸Šä¸€æ¬¡ CPU ç»Ÿè®¡çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œè¿˜æ²¡æœ‰è¿™äº›è¿›ç¨‹ï¼Œè€Œè¿™ä¸€æ¬¡ CPU ç»Ÿè®¡çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œè¿è¡Œäº†è¿™äº›è¿›ç¨‹ã€‚ç±»ä¼¼çš„è¿˜æœ‰ â€œ-â€ å·ï¼Œè¡¨ç¤ºä¸¤æ¬¡ CPU ç»Ÿè®¡æ—¶é—´ç‰‡æ®µæ—¶ï¼Œè¿™äº›è¿›ç¨‹æ¶ˆäº¡äº†ã€‚</p><p>âœ&nbsp;<strong><font color="#ff0000" size="3">CPU æ€»ä½¿ç”¨ç‡ï¼š</font></strong>TOTAL å…³é”®å­—è¡¨æ˜äº† CPU ä½¿ç”¨çš„æ±‡æ€»ï¼Œ87% æ˜¯æ€»çš„ CPU ä½¿ç”¨ç‡ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹ iowait è¡¨æ˜ CPU åœ¨ç­‰å¾… IO çš„æ—¶é—´ï¼Œå åˆ°64%ï¼Œè¯´æ˜å‘ç”Ÿ ANR ä»¥å‰ï¼Œæœ‰å¤§é‡çš„ IO æ“ä½œã€‚app_processã€system_serverã€com.android.systemui è¿™å‡ ä¸ªè¿›ç¨‹çš„ major å€¼éƒ½æ¯”è¾ƒå¤§ï¼Œè¯´æ˜è¿™äº›è¿›ç¨‹çš„ IO æ“ä½œè¾ƒä¸ºé¢‘ç¹ï¼Œä»è€Œæ‹‰å‡äº†æ•´ä¸ª iowait çš„æ—¶é—´ã€‚</p><p>ä¿¡æ¯é‡æ˜¯å¦‚æ­¤çš„åºå¤§ï¼Œä»¥è‡´äºæˆ‘ä»¬éƒ½è¦ä¸‹ç»“è®ºäº†ï¼šCPU å¤§é‡çš„æ—¶é—´éƒ½åœ¨ç­‰å¾… IOï¼Œå¯¼è‡´ systemui è¿›ç¨‹åˆ†é…ä¸åˆ° CPU æ—¶é—´ï¼Œä»è€Œä¸»çº¿ç¨‹å¤„ç†å¹¿æ’­æ¶ˆæ¯è¶…æ—¶ï¼Œå‘ç”Ÿäº† ANRã€‚</p><p><strong><font color="#FF0000">å¯¹äºä¸€ä¸ªä¸¥è°¨çš„å¼€å‘äººå‘˜è€Œè¨€ï¼Œè¿™ç§ç»“è®ºä¸‹å¾—æœ‰ç‚¹æ—©ï¼Œå› ä¸ºè¿˜æœ‰å¤ªå¤šçš„ç–‘é—®ï¼Œæ¯”å¦‚ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ï¹– systemui è¿›ç¨‹ä¹Ÿåˆ†åˆ°äº†ä¸€äº› CPU æ—¶é—´(3.3%)ï¼Œéš¾é“ BroadcastReceiver.onReceive() æ–¹æ³•å°±ä¸€ç›´æ— æ³•æ‰§è¡Œå—ï¼Ÿ</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ï¹– ä¸ºä»€ä¹ˆ iowait çš„æ—¶é—´ä¼šè¿™ä¹ˆå¤šï¼Œè€Œä¸”å¤šä¸ªè¿›ç¨‹çš„ major å€¼éƒ½å¾ˆé«˜ï¼Ÿ</p><h2 id="3-åœºæ™¯è¿˜åŸ"><a href="#3-åœºæ™¯è¿˜åŸ" class="headerlink" title="3. åœºæ™¯è¿˜åŸ"></a>3. åœºæ™¯è¿˜åŸ</h2><p>é’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªç–‘é—®ç‚¹ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥åˆ†æï¼</p><h3 id="3-1-ç¬¬ä¸€ä¸ªç–‘ç‚¹"><a href="#3-1-ç¬¬ä¸€ä¸ªç–‘ç‚¹" class="headerlink" title="3.1 ç¬¬ä¸€ä¸ªç–‘ç‚¹"></a>3.1 ç¬¬ä¸€ä¸ªç–‘ç‚¹</h3><p>æˆ‘ä»¬å…ˆæ¥åšä¸€ä¸ªå‡è®¾ï¼šå¦‚æœ systemui è¿›ç¨‹æ­£åœ¨æ‰§è¡Œ BroadcatReceiver.onReceive() æ–¹æ³•ï¼Œé‚£ä¹ˆä» traces.txt æ–‡ä»¶ä¸­ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°ä¸»çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆæ­£åœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é¦–å…ˆä» traces æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°å‘ç”Ÿ ANR æ—¶ï¼ˆ00:48:27ï¼‰ï¼Œsysemtui è¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ã€‚</p><pre class=" language-log"><code class="language-log">----- pid 29533 at 2018-04-24 00:48:06 -----Cmd line: com.android.systemuiDALVIK THREADS (53):"main" prio=5 tid=1 Native  | group="main" sCount=1 dsCount=0 obj=0x75bd5818 self=0x7f8549a000  | sysTid=29533 nice=0 cgrp=bg_non_interactive sched=0/0 handle=0x7f894bbe58  | state=S schedstat=( 288625433917 93454573244 903419 ) utm=20570 stm=8292 core=3 HZ=100  | stack=0x7fdffda000-0x7fdffdc000 stackSize=8MB  | held mutexes=  native: #00 pc 00060b0c  /system/lib64/libc.so (__epoll_pwait+8)  native: #01 pc 0001bb54  /system/lib64/libc.so (epoll_pwait+32)  native: #02 pc 0001b3d8  /system/lib64/libutils.so (android::Looper::pollInner(int)+144)  native: #03 pc 0001b75c  /system/lib64/libutils.so (android::Looper::pollOnce(int, int*, int*, void**)+76)  native: #04 pc 000d7194  /system/lib64/libandroid_runtime.so (android::NativeMessageQueue::pollOnce(_JNIEnv*, int)+48)  at android.os.MessageQueue.nativePollOnce(Native method)  at android.os.MessageQueue.next(MessageQueue.java:148)  at android.os.Looper.loop(Looper.java:151)  at android.app.ActivityThread.main(ActivityThread.java:5718)  at java.lang.reflect.Method.invoke!(Native method)  at java.lang.reflect.Method.invoke(Method.java:372)  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:975)  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:770)----- pid 29533 at 2018-04-24 00:48:29 -----Cmd line: com.android.systemuiDALVIK THREADS (54):"main" prio=5 tid=1 Blocked  | group="main" sCount=1 dsCount=0 obj=0x75bd5818 self=0x7f8549a000  | sysTid=29533 nice=0 cgrp=bg_non_interactive sched=0/0 handle=0x7f894bbe58  | state=S schedstat=( 289080040422 93461978317 904874 ) utm=20599 stm=8309 core=0 HZ=100  | stack=0x7fdffda000-0x7fdffdc000 stackSize=8MB  | held mutexes=  at com.mediatek.anrappmanager.MessageLogger.println(SourceFile:77)  - waiting to lock <0x26b337a3> (a com.mediatek.anrappmanager.MessageLogger) held by thread 49  at android.os.Looper.loop(Looper.java:195)  at android.app.ActivityThread.main(ActivityThread.java:5718)  at java.lang.reflect.Method.invoke!(Native method)  at java.lang.reflect.Method.invoke(Method.java:372)  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:975)  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:770)..."Binder_5" prio=5 tid=49 Native  | group="main" sCount=1 dsCount=0 obj=0x136760a0 self=0x7f7e453000  | sysTid=6945 nice=0 cgrp=default sched=0/0 handle=0x7f6e3ce000  | state=S schedstat=( 5505571091 4567508913 30743 ) utm=264 stm=286 core=4 HZ=100  | stack=0x7f6b83f000-0x7f6b841000 stackSize=1008KB  | held mutexes=  native: #00 pc 00019d14  /system/lib64/libc.so (syscall+28)  native: #01 pc 0005b5d8  /system/lib64/libaoc.so (???)  native: #02 pc 002c6f18  /system/lib64/libaoc.so (???)  native: #03 pc 00032c40  /system/lib64/libaoc.so (???)  at libcore.io.Posix.getpid(Native method)  at libcore.io.ForwardingOs.getpid(ForwardingOs.java:83)  at android.system.Os.getpid(Os.java:176)  at android.os.Process.myPid(Process.java:754)  at com.mediatek.anrappmanager.MessageLogger.dump(SourceFile:219)  - locked <0x26b337a3> (a com.mediatek.anrappmanager.MessageLogger)  at com.mediatek.anrappmanager.ANRAppManager.dumpMessageHistory(SourceFile:65)  at android.app.ActivityThread$ApplicationThread.dumpMessageHistory(ActivityThread.java:1302)  at android.app.ApplicationThreadNative.onTransact(ApplicationThreadNative.java:682)  at android.os.Binder.execTransact(Binder.java:451)</code></pre><p>æœ€ç»ˆï¼Œæˆ‘ä»¬æ‰¾åˆ° systemui è¿›ç¨‹ ANR æ—¶åˆ»ï¼ˆ00:48:27ï¼‰é™„è¿‘çš„ä¸¤ä¸ªå‡½æ•°è°ƒç”¨æ ˆï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ åœ¨ ANR å‘ç”Ÿä¹‹å‰ï¼ˆ00:48:06ï¼‰ï¼Œä¸»çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆå¤„äºæ­£å¸¸çŠ¶æ€ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¾ªç¯å¤„ç†æ¶ˆæ¯</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ åœ¨ ANR å‘ç”Ÿä¹‹å2ç§’ï¼ˆ00:48:29ï¼‰ï¼Œä¸»çº¿ç¨‹å¤„äº Blocked çŠ¶æ€ï¼Œåœ¨ç­‰å¾…ä¸€ä¸ªè¢« 49 å·çº¿ç¨‹æŒæœ‰çš„é”ã€‚è€Œ 49 å·çº¿ç¨‹æ˜¯ä¸€ä¸ª Binder çº¿ç¨‹ï¼Œanrappmanager æ­£åœ¨åš dump æ“ä½œã€‚</p><p><font color="#ff0000">è‡³æ­¤ï¼Œsystemui è¿›ç¨‹å‘ç”Ÿ ANR çš„ç›´æ¥åŸå› æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†ï¼Œsystemui è¿›ç¨‹æ­£åœ¨æ‰“å° tracesï¼Œå­˜åœ¨è¾ƒé•¿æ—¶é—´çš„ IO æ“ä½œï¼Œå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ï¼Œä»è€Œæ— æ³•å¤„ç† TIME_TICK å¹¿æ’­æ¶ˆæ¯ï¼Œæ‰€ä»¥å‘ç”Ÿäº† ANRã€‚</font><br></p><p>è¦é¿å…è¿™ç§åœºæ™¯ä¸‹çš„ ANRï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰“ç ´ä¸»çº¿ç¨‹ä¸­ Blocked çš„é€»è¾‘ã€‚å…¶å®æœ¬ä¾‹æ˜¯ç”±äº MTK åœ¨ AOSP çš„ android.os.Looper.loop() æ‰©å±•äº†æ‰“å°æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å­˜åœ¨è®¾è®¡ç¼ºé™·ï¼Œä¼šå¯¼è‡´é”ç­‰å¾…çš„æƒ…å†µã€‚</p><h3 id="3-2-ç¬¬äºŒä¸ªç–‘ç‚¹"><a href="#3-2-ç¬¬äºŒä¸ªç–‘ç‚¹" class="headerlink" title="3.2 ç¬¬äºŒä¸ªç–‘ç‚¹"></a>3.2 ç¬¬äºŒä¸ªç–‘ç‚¹</h3><p>æˆ‘ä»¬è¿›ä¸€æ­¥æŒ–æ˜åœ¨ systemui è¿˜æ²¡æœ‰å‘ç”Ÿ ANR æ—¶ï¼Œå°±åœ¨æ‰“å° traces çš„åŸå› ã€‚å¸¦ç€ä¸Šæ–‡æå‡ºçš„ç¬¬äºŒä¸ªç–‘é—®ï¼Œæˆ‘ä»¬æ¥åšå¦ä¸€ä¸ªå‡è®¾ï¼šiowait è¾ƒé«˜ï¼Œè€Œä¸”å¤šä¸ªè¿›ç¨‹çš„ major éƒ½å¾ˆé«˜ï¼Œå¯èƒ½æ˜¯ç”±äºå½“å‰æ­£åœ¨è°ƒç”¨ AMS.dumpStackTraces() æ–¹æ³•ï¼Œå¾ˆå¤šè¿›ç¨‹éƒ½éœ€è¦å°†è‡ªå·±çš„å‡½æ•°è°ƒç”¨æ ˆå†™åˆ° traces æ–‡ä»¶ï¼Œæ‰€ä»¥ IO å°±ä¼šè¾ƒé«˜ã€‚å¦‚æœå½“å‰æ­£åœ¨è°ƒç”¨ AMS.dumpStackTraces() æ–¹æ³•ï¼Œé‚£è¯´æ˜å½“æ—¶ç³»ç»Ÿå·²ç»å‘ç”Ÿäº†å¼‚å¸¸ï¼Œè¦ä¹ˆå·²ç»æœ‰ ANR å‘ç”Ÿï¼Œè¦ä¹ˆæœ‰ SNR å‘ç”Ÿã€‚</p><p>æ˜¯ä»€ä¹ˆå¯¼è‡´å·²ç»å¼€å§‹ dump ä¿¡æ¯äº†å‘¢ï¼Ÿéš¾é“è¿˜æœ‰åˆ«çš„ ANR æˆ–è€… SNRï¼Ÿæœç„¶ï¼Œä» event log ä¸­ï¼Œæˆ‘ä»¬æ£€ç´¢åˆ°äº†å¦ä¸€ä¸ª ANRï¼š</p><pre class=" language-log"><code class="language-log">04-24 00:47:58 820 907 I am_anr  : [0,10464,com.android.settings,1086864965,Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)]</code></pre><p>åœ¨ 00:47:58 è¿™ä¸ªæ—¶åˆ»ï¼Œcom.android.settings è¿›ç¨‹å‘ç”Ÿäº† ANRï¼Œè€Œä¸” ANR çš„æ—¶é—´åœ¨ systemui ä¹‹å‰(00:48:27)ã€‚è¿™ä¸€ä¸‹ï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°ä½è¯äº†ï¼Œæ­£æ˜¯å› ä¸º settings è¿›ç¨‹å…ˆå‘ç”Ÿäº† ANRï¼Œè°ƒç”¨ AMS.dumpStackTraces()ï¼Œä»è€Œå¾ˆå¤šè¿›ç¨‹éƒ½å¼€å§‹äº†æ‰“å° traces çš„æ“ä½œï¼Œæ‰€ä»¥ç³»ç»Ÿçš„æ•´ä¸ª iowait æ¯”è¾ƒé«˜ï¼Œå¤§é‡è¿›ç¨‹çš„ major å€¼ä¹Ÿæ¯”è¾ƒé«˜ï¼Œsystemui å°±åœ¨å…¶åˆ—ã€‚åœ¨ MTK é€»è¾‘çš„å½±å“ä¸‹ï¼Œæ‰“å° ANR æ—¥å¿—ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ï¼Œä»è€Œå°±è¿å¸¦å¼•å‘äº†å…¶ä»–åº”ç”¨çš„ ANRã€‚</p><p>åœ¨ system log ä¸­ï¼Œæˆ‘ä»¬æ£€ç´¢åˆ°äº† settings è¿›ç¨‹ ANR çš„ CPU ä½¿ç”¨ä¿¡æ¯ï¼š</p><pre class=" language-log"><code class="language-log">04-24 00:48:12 820 907 E ActivityManager: ANR in com.android.settings (com.android.settings/.SubSettings), time=13006371804-24 00:48:12 820 907 E ActivityManager: Reason: Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)04-24 00:48:12 820 907 E ActivityManager: Load: 21.37 / 19.25 / 18.8404-24 00:48:12 820 907 E ActivityManager: Android time :[2015-04-24 00:48:12.24] [130077,742]04-24 00:48:12 820 907 E ActivityManager: CPU usage from 0ms to 7676ms later:04-24 00:48:12 820 907 E ActivityManager:   91% 820/system_server: 16% user + 75% kernel / faults: 13192 minor 167 major04-24 00:48:12 820 907 E ActivityManager:   3.2% 175/mmcqd/0: 0% user + 3.2% kernel04-24 00:48:12 820 907 E ActivityManager:   2.9% 29533/com.android.systemui: 2.3% user + 0.6% kernel / faults: 1352 minor 10 major04-24 00:48:12 820 907 E ActivityManager:   2.2% 1736/com.android.phone: 0.9% user + 1.3% kernel / faults: 1225 minor 1 major04-24 00:48:12 820 907 E ActivityManager:   2.2% 10464/com.android.settings: 0.7% user + 1.4% kernel / faults: 2801 minor 105 major04-24 00:48:12 820 907 E ActivityManager:   0% 1785/com.meizu.experiencedatasync: 0% user + 0% kernel / faults: 3478 minor 2 major04-24 00:48:12 820 907 E ActivityManager:   1.8% 11333/com.meizu.media.video: 1% user + 0.7% kernel / faults: 3843 minor 89 major04-24 00:48:12 820 907 E ActivityManager:   1.5% 332/mobile_log_d: 0.5% user + 1% kernel / faults: 94 minor 1 major04-24 00:48:12 820 907 E ActivityManager:   1% 11306/com.meizu.media.gallery: 0.7% user + 0.2% kernel / faults: 2204 minor 55 major...04-24 00:48:12 820 907 E ActivityManager:  +0% 11397/sh: 0% user + 0% kernel04-24 00:48:12 820 907 E ActivityManager:  +0% 11398/app_process: 0% user + 0% kernel04-24 00:48:12 820 907 E ActivityManager: 29% TOTAL: 5.1% user + 15% kernel + 9.5% iowait + 0% softirq</code></pre><p>å…·ä½“çš„æ¶µä¹‰æˆ‘ä»¬ä¸å†èµ˜è¿°äº†ï¼Œåªå…³æ³¨ä¸€ä¸‹ ANR çš„åŸå› :</p><pre class=" language-log"><code class="language-log">Reason: Input dispatching timed out (Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it.  Outbound queue length: 0.  Wait queue length: 1.)</code></pre><p>æˆ‘ä»¬åœ¨ <a href>ã€æ·±å…¥é’»ç ” Android åº”ç”¨ ANR ä¹‹ Input è¶…æ—¶ã€‘</a> ä¸­æ¢è®¨è¿‡ Input ANR çš„æƒ…å†µã€‚<code>Wait queue lengthï¼š1</code>ï¼šè¡¨ç¤ºä¹‹å‰çš„è¾“å…¥äº‹ä»¶å·²ç»æ´¾å‘åˆ° Settings è¿›ç¨‹äº†ï¼Œä½† Settings è¿›ç¨‹è¿˜æ²¡æœ‰å¤„ç†å®Œæ¯•ï¼Œæ–°æ¥çš„ KeyEvent äº‹ä»¶å·²ç»ç­‰å¾…è¶…è¿‡äº†5ç§’ï¼Œæ‰€ä»¥ ANR äº§ç”Ÿäº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰ç…§ systemui çš„åˆ†æé€»è¾‘æŸ¥çœ‹ Settings çš„ tracesï¼Œåˆ†æ Settings ä¸»çº¿ç¨‹å¤„ç†è¾“å…¥äº‹ä»¶è¶…æ—¶çš„åŸå› ï¼Œè¿™è¾¹ä¸å†è¯¦ç»†åˆ†æã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ€§èƒ½ä¼˜åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ€§èƒ½ä¼˜åŒ– </tag>
            
            <tag> ANR </tag>
            
            <tag> æ— å“åº” </tag>
            
            <tag> åº”ç”¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>â€œäº‹ä»¶åˆ†å‘æœºåˆ¶â€ - é¢è¯•é¢˜é›†</title>
      <link href="/2019/04/23/10.jing-yan-zong-jie-xi-lie-guan-yu-shi-jian-fen-fa-ji-zhi-de-mian-shi-ti-ji/"/>
      <url>/2019/04/23/10.jing-yan-zong-jie-xi-lie-guan-yu-shi-jian-fen-fa-ji-zhi-de-mian-shi-ti-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="1-ä¸ºä»€ä¹ˆä¼šæœ‰äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Ÿ"><a href="#1-ä¸ºä»€ä¹ˆä¼šæœ‰äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Ÿ" class="headerlink" title="1. ä¸ºä»€ä¹ˆä¼šæœ‰äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Ÿ"></a><center>1. ä¸ºä»€ä¹ˆä¼šæœ‰äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Ÿ</center></h3><p><br></p><p>å®‰å“ä¸Šé¢çš„ View æ˜¯æ ‘å½¢ç»“æ„çš„ï¼ŒView å¯èƒ½ä¼šé‡å åœ¨ä¸€èµ·ï¼Œå½“ç‚¹å‡»çš„åœ°æ–¹æœ‰å¤šä¸ª View å¯ä»¥å“åº”çš„æ—¶å€™ï¼Œè¿™ä¸ªç‚¹å‡»äº‹ä»¶åº”è¯¥ç»™è°å‘¢ï¼Ÿä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æœ‰äº†äº‹ä»¶åˆ†å‘æœºåˆ¶ã€‚</p><p><strong><font color="#0000ff">PhoneWindowï¼š</font></strong>æ˜¯æŠ½è±¡ç±» Window çš„å®ç°ç±»ï¼ŒæŠ½è±¡ç±» Window æ˜¯æ‰€æœ‰è§†å›¾æœ€é¡¶å±‚çš„å®¹å™¨ï¼ŒåŒ…æ‹¬ View è§†å›¾çš„å¤–è§‚å’Œè¡Œä¸ºéƒ½å½’Windowç®¡ã€‚</p><p><strong><font color="#0000ff">DecorViewï¼š</font></strong>PhoneWindow çš„å†…éƒ¨ç±»ï¼Œé€šè¿‡ DecorView ä¼ é€’ä¿¡æ¯ç»™ä¸‹é¢çš„ Viewï¼Œä¸‹é¢çš„ View ä¹Ÿé€šè¿‡ DecorView è¿”å›æ¶ˆæ¯ç»™ PhoneWindowã€‚</p><h3 id="2-onTouch-å’Œ-onTouchEvent-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œåˆè¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ"><a href="#2-onTouch-å’Œ-onTouchEvent-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œåˆè¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ" class="headerlink" title="2. onTouch å’Œ onTouchEvent æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œåˆè¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ"></a><center>2. onTouch å’Œ onTouchEvent æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œåˆè¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ</center></h3><p><br></p><p>æˆ‘ä»¬çœ‹ä¸‹æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/core/java/android/view/View.java</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">onFilterTouchEventForSecurity</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ListenerInfo li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener <span class="token operator">!=</span> null                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> ENABLED                    <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener<span class="token punctuation">.</span><span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 1</span>                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result <span class="token operator">&amp;&amp;</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 2</span>                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯åœ¨ View çš„ <code>dispatchTouchEvent</code> ä¸­è°ƒç”¨çš„ï¼Œ<code>onTouch</code> ä¼˜å…ˆäº <code>onTouchEvent</code> æ‰§è¡Œã€‚å¦‚æœåœ¨ <code>onTouch</code> æ–¹æ³•ä¸­é€šè¿‡è¿”å› <code>true</code> å°†äº‹ä»¶æ¶ˆè´¹æ‰ï¼Œ<code>onTouchEvent</code> å°†ä¸ä¼šå†æ‰§è¡Œã€‚</p><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒonTouch èƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œéœ€è¦ä¸¤ä¸ªå‰ææ¡ä»¶ï¼š</p><p>1ã€<code>mOnTouchListener</code> çš„å€¼ä¸èƒ½ä¸ºç©ºï¼è¿™ä¸ªæˆ‘ä»¬çŸ¥é“ï¼Œåªè¦æˆ‘ä»¬ç»™æ§ä»¶æ³¨å†Œäº† <code>Touch äº‹ä»¶</code>ï¼Œ<code>mOnTouchListener</code> å°±ä¸€å®šè¢«èµ‹å€¼ï¼ˆä¸ä¸ºç©ºï¼‰ï¼</p><p>2ã€å½“å‰ç‚¹å‡»çš„æ§ä»¶å¿…é¡»æ˜¯ <code>enable</code> çš„ã€‚å› æ­¤å¦‚æœä½ æœ‰ä¸€ä¸ªæ§ä»¶æ˜¯<code>éenable</code>çš„ï¼ˆæ¯”å¦‚ï¼šImageViewï¼‰ï¼Œé‚£ä¹ˆç»™å®ƒæ³¨å†Œ <code>onTouch</code> äº‹ä»¶å°†æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œã€‚å¯¹äºè¿™ä¸€ç±»æ§ä»¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ç›‘å¬å®ƒçš„ <code>touchäº‹ä»¶</code>ï¼Œå°±å¿…é¡»é€šè¿‡åœ¨è¯¥æ§ä»¶ä¸­é‡å†™ <code>onTouchEvent</code> æ–¹æ³•æ¥å®ç°ã€‚</p><p><br></p><h3 id="3-äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ï¼ˆä¸‰ä¸ªé‡è¦çš„äº‹ä»¶åˆ†å‘çš„æ–¹æ³•ï¼‰"><a href="#3-äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ï¼ˆä¸‰ä¸ªé‡è¦çš„äº‹ä»¶åˆ†å‘çš„æ–¹æ³•ï¼‰" class="headerlink" title="3. äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ï¼ˆä¸‰ä¸ªé‡è¦çš„äº‹ä»¶åˆ†å‘çš„æ–¹æ³•ï¼‰"></a><center>3. äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ï¼ˆä¸‰ä¸ªé‡è¦çš„äº‹ä»¶åˆ†å‘çš„æ–¹æ³•ï¼‰</center></h3><p><br></p><p>âœ’&nbsp;<strong><font color="#0000ff">dispatchTouchEventï¼š</font></strong>å¤„åœ¨é“¾é¦–ï¼Œç”¨äºåˆ†å‘äº‹ä»¶ï¼Œè¯¥æ–¹æ³•å†³å®šæ˜¯ç”±å½“å‰ View è‡ªå·±çš„ onTouchEvent æ¥å¤„ç†ï¼Œè¿˜æ˜¯åˆ†å‘ç»™å­ View é€’å½’è°ƒç”¨å…¶è‡ªèº«çš„ dispatchTouchEvent æ¥å¤„ç†ã€‚</p><p>âœ’&nbsp;<strong><font color="#0000ff">onInterceptTouchEventï¼š</font></strong>æ˜¯ç”¨æ¥æ‹¦æˆªäº‹ä»¶çš„ï¼Œå½“çˆ¶æ§ä»¶ä¸‹å‘äº‹ä»¶ç»™å­æ§ä»¶è¿›è¡Œæ‹¦æˆªå¤„ç†çš„æ—¶å€™ï¼Œå¦‚æœå­æ§ä»¶éœ€è¦å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œå°±è¦åœ¨ onInterceptTouchEvent æ–¹æ³•ä¸­è¿›è¡Œæ‹¦æˆªï¼Œç„¶ååˆ°å­æ§ä»¶çš„ onTouchEvent æ–¹æ³•ä¸­è¿›è¡Œäº‹ä»¶çš„ç›‘å¬ä»¥åŠé€»è¾‘çš„åˆ¤æ–­ã€‚</p><p>âœ’&nbsp;<strong><font color="#0000ff">onTouchEventï¼š</font></strong>ç”¨äºå¤„ç†ä¼ é€’åˆ° View çš„æ‰‹åŠ¿äº‹ä»¶ã€‚</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-971a1d903f18bc14.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹.jpg"></center><p><strong>å…¶ä¸­ï¼ŒActivity ä¸ View æ²¡æœ‰äº‹ä»¶æ‹¦æˆªï¼Œä¸»è¦åŸå› æ˜¯ï¼š</strong></p><p>Activity ä½œä¸ºåŸå§‹çš„äº‹ä»¶åˆ†å‘è€…ï¼Œå¦‚æœ Activity æ‹¦æˆªäº†äº‹ä»¶ä¼šå¯¼è‡´æ•´ä¸ªå±å¹•æ— æ³•å“åº”äº‹ä»¶ï¼Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼›View ä½œä¸ºäº‹ä»¶ä¼ é€’çš„æœ€æœ«ç«¯ï¼Œè¦ä¹ˆæ¶ˆè´¹äº‹ä»¶ï¼Œè¦ä¹ˆä¸å¤„ç†äº‹ä»¶è¿›è¡Œå›ä¼ ï¼Œæ ¹æœ¬æ²¡å¿…è¦æ‹¦æˆªã€‚</p><p><br></p><h3 id="4-äº‹ä»¶åˆ†å‘æµç¨‹"><a href="#4-äº‹ä»¶åˆ†å‘æµç¨‹" class="headerlink" title="4. äº‹ä»¶åˆ†å‘æµç¨‹"></a><center>4. äº‹ä»¶åˆ†å‘æµç¨‹</center></h3><p><br></p><p>Android View æ˜¯æ ‘å½¢ç»“æ„ï¼Œäº‹ä»¶åˆ†å‘æµç¨‹é‡‡ç”¨çš„æ˜¯è´£ä»»é“¾æ¨¡å¼ã€‚</p><p>äº‹ä»¶ä¼ é€’ï¼š</p><blockquote><p>Activity ï¼&gt; PhoneWindow ï¼&gt; DecorView ï¼&gt; ViewGroup ï¼&gt; â€¦ ï¼&gt; View</p></blockquote><p>äº‹ä»¶å›ä¼ ï¼š</p><blockquote><p>Activity &lt;ï¼ PhoneWindow &lt;ï¼ DecorView &lt;ï¼ ViewGroup &lt;ï¼ â€¦ &lt;ï¼ View</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯ç»†èŠ‚ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é¢è¯•é¢˜é›† </tag>
            
            <tag> äº‹ä»¶åˆ†å‘ </tag>
            
            <tag> ç»éªŒæ€»ç»“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android æ—¥å¸¸å¼€å‘é—®é¢˜æ€»ç»“</title>
      <link href="/2019/04/15/10.jing-yan-zong-jie-xi-lie-android-ri-chang-kai-fa-wen-ti-zong-jie/"/>
      <url>/2019/04/15/10.jing-yan-zong-jie-xi-lie-android-ri-chang-kai-fa-wen-ti-zong-jie/</url>
      
        <content type="html"><![CDATA[<h3 id="1-è®¿å®¢æ¨¡å¼-PC-ç«¯ä¸æ˜¾ç¤ºç›˜ç¬¦"><a href="#1-è®¿å®¢æ¨¡å¼-PC-ç«¯ä¸æ˜¾ç¤ºç›˜ç¬¦" class="headerlink" title="1. è®¿å®¢æ¨¡å¼ PC ç«¯ä¸æ˜¾ç¤ºç›˜ç¬¦"></a><center>1. è®¿å®¢æ¨¡å¼ PC ç«¯ä¸æ˜¾ç¤ºç›˜ç¬¦</center></h3><p><br></p><p>åœ¨ä¹‹å‰ Android ç³»ç»Ÿå¼€å‘çš„ Bug åº“ä¸­ï¼Œé‡åˆ°ä¸€ä¸ªè®¿å®¢æ¨¡å¼ä¸‹ PC ç«¯ä¸æ˜¾ç¤ºç›˜ç¬¦çš„é—®é¢˜ï¼Œå¦‚æœä½ ä¹Ÿæœ‰æ­¤é—®é¢˜ï¼Œè¿™è¾¹ç»™æ‚¨æä¾›ä¸€ç§æ–¹æ¡ˆï¼</p><p><strong><font color="#FF0000" size="4">âœ’ é—®é¢˜ç°è±¡</font></strong>ï¼ˆè¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯é’ˆå¯¹ MTK å¹³å°ï¼‰</p><p>Device åˆ‡æ¢åˆ°è®¿å®¢æ¨¡å¼ä¸‹ï¼Œè¿æ¥ç”µè„‘ USB ï¼Œæ‰“å¼€ä¼ è¾“æ¨¡å¼ï¼Œå´å‘ç°åœ¨ PC ç«¯æ— æ³•æ˜¾ç¤ºå†…éƒ¨å­˜å‚¨çš„ç›˜ç¬¦ã€‚</p><p><strong><font color="#FF0000" size="4">âœ’ é—®é¢˜åŸå› </font></strong></p><p>è¿™ä¸ªç°è±¡æ˜¯ä¸åˆç†çš„ï¼ŒåŸç”Ÿä»£ç é€»è¾‘ï¼ˆæˆ–è€…è¯´ Pixelï¼‰æ˜¯ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜çš„ï¼ŒBug çš„åŸå› æ˜¯ MTK åˆå…¥äº†ä¸€ä¸ª patch æ‰€å¯¼è‡´ã€‚</p><p>å¯¼è‡´é—®é¢˜çš„ä¿®æ”¹å¦‚ä¸‹ï¼š<strong><font color="#0099ff" size="4">MtpService.java</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>    UserHandle user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserHandle</span><span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sServerHolder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"MTP server is still running."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            mVolumeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mStorageMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mStorageManager<span class="token punctuation">.</span><span class="token function">registerListener</span><span class="token punctuation">(</span>mStorageEventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>            mVolumes <span class="token operator">=</span> StorageManager<span class="token punctuation">.</span><span class="token function">getVolumeList</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>StorageVolume volume <span class="token operator">:</span> mVolumes<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>MEDIA_MOUNTED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>volume<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// è·Ÿè¸ª volumeMountedLocked() å‡½æ•°</span>                    <span class="token function">volumeMountedLocked</span><span class="token punctuation">(</span>volume<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"StorageVolume not mounted "</span> <span class="token operator">+</span> volume<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">volumeMountedLocked</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// For update storage</span>    <span class="token comment" spellcheck="true">/*     * é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼     * MTK ä¸ºäº†ä¿®æ”¹ä¸€ä¸ª Bugï¼šå¶ç°æ˜¾ç¤ºä¸¤ä¸ªå†…éƒ¨å­˜å‚¨ç›˜ç¬¦ï¼Œæ‰€ä»¥åœ¨è¿™è¾¹é‡æ–°     * è·å–ä¸€é StroageVolume ï¼Œä½†æ˜¯æ²¡æœ‰è€ƒè™‘å¤šç”¨æˆ·æ¨¡å¼ï¼     *     */</span>    StorageVolume<span class="token punctuation">[</span><span class="token punctuation">]</span> volumes <span class="token operator">=</span> mStorageManager<span class="token punctuation">.</span><span class="token function">getVolumeList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mVolumes <span class="token operator">=</span> volumes<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mVolumes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        StorageVolume volume <span class="token operator">=</span> mVolumes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>volume<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mVolumeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> volume<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mMtpDisabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// In PTP mode we support only primary storage</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>volume<span class="token punctuation">.</span><span class="token function">isPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>mPtpMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">addStorageLocked</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FF0000" size="4">âœ’ è§£å†³æ–¹æ¡ˆ</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">volumeMountedLocked</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// For update storage, support multi-user mode</span>    <span class="token comment" spellcheck="true">/*     * åšä¸»å‘ç°åŸç”Ÿè®¾è®¡å¯¹å¤šç”¨æˆ·è¯»å–ç›˜ç¬¦æ˜¯è¿™ä¹ˆæ“ä½œçš„ï¼š     *     mVolumes = StorageManager.getVolumeList(user.getIdentifier(), 0);     * ç›´æ¥è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼šæ·»åŠ å¤šç”¨æˆ·æ¨¡å¼åˆ¤æ–­é€»è¾‘     *     */</span>    <span class="token comment" spellcheck="true">// ä¿®æ”¹æ–¹æ¡ˆ</span>    StorageVolume<span class="token punctuation">[</span><span class="token punctuation">]</span> volumes <span class="token operator">=</span> mStorageManager<span class="token punctuation">.</span><span class="token function">getVolumeList</span><span class="token punctuation">(</span>             <span class="token keyword">new</span> <span class="token class-name">UserHandle</span><span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mVolumes <span class="token operator">=</span> volumes<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mVolumes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        StorageVolume volume <span class="token operator">=</span> mVolumes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>volume<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mVolumeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> volume<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mMtpDisabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// In PTP mode we support only primary storage</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>volume<span class="token punctuation">.</span><span class="token function">isPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>mPtpMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">addStorageLocked</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><br></p><h3 id="2-å¿«é€Ÿç‚¹å‡»æ‰“å¼€ä¸¤ä¸ªé‡å¤çš„-Activity"><a href="#2-å¿«é€Ÿç‚¹å‡»æ‰“å¼€ä¸¤ä¸ªé‡å¤çš„-Activity" class="headerlink" title="2. å¿«é€Ÿç‚¹å‡»æ‰“å¼€ä¸¤ä¸ªé‡å¤çš„ Activity"></a><center>2. å¿«é€Ÿç‚¹å‡»æ‰“å¼€ä¸¤ä¸ªé‡å¤çš„ Activity</center></h3><p><br></p><p><strong><font color="#FF0000" size="4">âœ’ é—®é¢˜ç°è±¡</font></strong></p><p>å¦‚æœä½ ç»å¸¸é‡åˆ°ä¸€ç§æƒ…å†µï¼šå¿«é€Ÿç‚¹å‡»æŒ‰é’®ï¼ˆæ¯”å¦‚ Settings ç•Œé¢ï¼‰ï¼Œå¼¹å‡ºä¸¤ä¸ªé‡å¤çš„ç›®æ ‡ Activity ï¼è§£å†³æ–¹æ³•çœ‹è¿™é‡Œï¼</p><p><strong><font color="#FF0000" size="4">âœ’ é—®é¢˜åŸå› </font></strong></p><p>å…¶å®è¿™æ˜¯ä¸€ä¸ªç³»ç»ŸåŸç”Ÿè‡ªå¸¦çš„ Bugï¼Œå¼ºè¿«ç—‡å—ä¸äº†ï¼Œç›´æ¥æä¾›è§£å†³æ–¹æ¡ˆï¼</p><p><strong><font color="#FF0000" size="4">âœ’ è§£å†³æ–¹æ¡ˆ</font></strong></p><p>1ã€æ‰¾åˆ°ä½ çš„æ§ä»¶æ‰€åœ¨ç±»ï¼Œç„¶åæ·»åŠ ä¸€ä¸ªå˜é‡ï¼Œå¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> mStartTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// å®šä¹‰ä¸€ä¸ªåˆå§‹åˆ¤æ–­æ—¶é—´å˜é‡</span></code></pre><p>2ã€ç„¶ååœ¨ç‚¹å‡»å¤„ç†äº‹ä»¶ä¸­ï¼Œæ‰¾åˆ°ç›®æ ‡ Activity ç‚¹ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onItemClick</span><span class="token punctuation">(</span>AdapterView<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> parent<span class="token punctuation">,</span> View view<span class="token punctuation">,</span> <span class="token keyword">int</span> position<span class="token punctuation">,</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">long</span> interval <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> mStartTime<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ä¸¤æ¬¡ç‚¹å‡»æ—¶é—´é—´éš”</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">>=</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mStartTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">showConfirmDialog</span><span class="token punctuation">(</span>infoItem<span class="token punctuation">,</span> isChecked<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// target Activity</span>    <span class="token punctuation">}</span></code></pre><p>å°±è¿™ä¹ˆç®€å•ï¼Œä¸éœ€è¦æŒ‰ç…§ç½‘ä¸Šä¼—è¯´çº·çº­ï¼Œæ— éœ€è®¾ç½® SingerTopã€SingerTask ï¼Œæ›´æ²¡å¿…è¦å•ç‹¬è®¾ç½®ä¸ª onclickListen ç›‘å¬ï¼Œè¯•è¯•çœ‹ï¼Œæ•ˆæœå¾ˆå¥½ï¼</p><p><br></p><h3 id="3-åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæœºä¸»æ¨¡å¼"><a href="#3-åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæœºä¸»æ¨¡å¼" class="headerlink" title="3. åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæœºä¸»æ¨¡å¼"></a><center>3. åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæœºä¸»æ¨¡å¼</center></h3><p><br></p><p>æˆ‘ä»¬åœ¨ç»´æŠ¤å’Œä¿®æ”¹ Android ç³»ç»Ÿæˆ– Bug çš„æ—¶å€™ï¼Œæœ‰æ—¶å€™éœ€è¦åŒºåˆ†æœºä¸»æ¨¡å¼å’Œè®¿å®¢æ¨¡å¼ï¼Œé’ˆå¯¹ä¸åŒæ¨¡å¼ï¼Œéœ€è¦æ·»åŠ å’Œä¿®æ”¹ä¸åŒçš„ä»£ç é€»è¾‘ï¼</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityManager<span class="token punctuation">;</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">// ç›®æ ‡é€»è¾‘ä»£ç ä¸­æ·»åŠ ï¼Œéæœºä¸»æ¨¡å¼</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> UserHandle<span class="token punctuation">.</span>USER_OWNER<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span></code></pre><h3 id="4-åˆ¤æ–­åº”ç”¨æ˜¯å¦å·²å®‰è£…"><a href="#4-åˆ¤æ–­åº”ç”¨æ˜¯å¦å·²å®‰è£…" class="headerlink" title="4. åˆ¤æ–­åº”ç”¨æ˜¯å¦å·²å®‰è£…"></a><center>4. åˆ¤æ–­åº”ç”¨æ˜¯å¦å·²å®‰è£…</center></h3><p><br></p><p>åœ¨ Android ç³»ç»Ÿå¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ¤æ–­åº”ç”¨ï¼ˆPackageï¼‰æ˜¯å¦å·²å­˜åœ¨äº Device ä¸­ã€‚åˆ¤æ–­æ–¹æ³•å¾ˆå¤šï¼Œæˆ‘ä»¬æä¾›ä¸€ç§æ–¹æ¡ˆï¼</p><p>æºç ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯åˆ¤æ–­æŸ Apk æ˜¯å¦å®‰è£…ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span>  <span class="token keyword">boolean</span> <span class="token function">isPkgInstalled</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> String packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageName <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>ApplicationInfo info <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        info <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> info <span class="token operator">!=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><br></p><h3 id="5-Android-P-è“ç‰™å¼€å…³çŠ¶æ€æ æ— å›¾æ ‡æ˜¾ç¤º"><a href="#5-Android-P-è“ç‰™å¼€å…³çŠ¶æ€æ æ— å›¾æ ‡æ˜¾ç¤º" class="headerlink" title="5. Android P è“ç‰™å¼€å…³çŠ¶æ€æ æ— å›¾æ ‡æ˜¾ç¤º"></a><center>5. Android P è“ç‰™å¼€å…³çŠ¶æ€æ æ— å›¾æ ‡æ˜¾ç¤º</center></h3><p><br></p><p>è¿™æ˜¯ä¸ªåŸç”Ÿè®¾è®¡ï¼Œä¸ºäº†èŠ‚çº¦çŠ¶æ€æ å›¾æ ‡ç©ºé—´ï¼ˆåˆ˜æµ·å±å¯¼è‡´çŠ¶æ€æ ç©ºé—´è¿›ä¸€æ­¥ç¼©å°ï¼‰ï¼Œåªåœ¨è“ç‰™è¿æ¥è®¾å¤‡åæ‰æ˜¾ç¤ºç›¸åº”å›¾æ ‡ã€‚</p><p>å¦‚æœä½ çš„é¡¹ç›®éœ€æ±‚æ˜¯éœ€è¦æ˜¾ç¤ºè“ç‰™å›¾æ ‡ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ”¹åŠ¨ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/.../PhoneStatusBarPolicy.java</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">updateBluetooth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> iconId <span class="token operator">=</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>stat_sys_data_bluetooth<span class="token punctuation">;</span>    String contentDescription <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>                                string<span class="token punctuation">.</span>accessibility_quick_settings_bluetooth_on<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> bluetoothVisible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetooth <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// added by marco, begin</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetooth<span class="token punctuation">.</span><span class="token function">isBluetoothEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            iconId <span class="token operator">=</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>stat_sys_data_bluetooth<span class="token punctuation">;</span>            contentDescription <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>                                 string<span class="token punctuation">.</span>accessibility_quick_settings_bluetooth_on<span class="token punctuation">)</span><span class="token punctuation">;</span>            bluetoothVisible <span class="token operator">=</span> mBluetooth<span class="token punctuation">.</span><span class="token function">isBluetoothEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// added by marco, end</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetooth<span class="token punctuation">.</span><span class="token function">isBluetoothConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            iconId <span class="token operator">=</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>stat_sys_data_bluetooth_connected<span class="token punctuation">;</span>            contentDescription <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>                                 string<span class="token punctuation">.</span>accessibility_bluetooth_connected<span class="token punctuation">)</span><span class="token punctuation">;</span>            bluetoothVisible <span class="token operator">=</span> mBluetooth<span class="token punctuation">.</span><span class="token function">isBluetoothEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    mIconController<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>mSlotBluetooth<span class="token punctuation">,</span> iconId<span class="token punctuation">,</span> contentDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>    mIconController<span class="token punctuation">.</span><span class="token function">setIconVisibility</span><span class="token punctuation">(</span>mSlotBluetooth<span class="token punctuation">,</span> bluetoothVisible<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><br></p><h3 id="6-Menu-é”®å¯¼è‡´å±å¹•äº®å±"><a href="#6-Menu-é”®å¯¼è‡´å±å¹•äº®å±" class="headerlink" title="6. Menu é”®å¯¼è‡´å±å¹•äº®å±"></a><center>6. Menu é”®å¯¼è‡´å±å¹•äº®å±</center></h3><p><br></p><p>é¡¹ç›®ä¸­é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œæµ‹è¯•åé¦ˆ power é”®ç­å±ä¹‹åï¼Œå¿«é€Ÿç‚¹å‡» Menu é”®ï¼Œå±å¹•ä¼šè¢«é‡æ–°æ¿€æ´»äº®èµ·ã€‚å…¶å®ä»æºç çš„æµç¨‹æ¥çœ‹ï¼Œäº‹ä»¶å¤„ç†æœºåˆ¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æµ‹è¯•ä¸ªäººè§‰å¾—æ˜¯ä¸ªé—®é¢˜ï¼Œæœ¬ç€æµ‹è¯•è‡ªå·±è§‰å¾—æ˜¯é—®é¢˜ä½ å¼€å‘å°±å¿…é¡»æ”¹çš„â€œç²¾ç¥â€ï¼Œé‚£å°±çœ‹çœ‹æ€ä¹ˆæ”¹å§ã€‚</p><p>è¿™è¾¹ï¼Œæˆ‘ç›´æ¥ç»™ä½ è§£å†³æ–¹æ¡ˆï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneWindowManager</span> <span class="token keyword">implements</span> <span class="token class-name">WindowManagerPolicy</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isWakeKeyWhenScreenOff</span><span class="token punctuation">(</span><span class="token keyword">int</span> keyCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>keyCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ignore volume keys unless docked</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_VOLUME_UP<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_VOLUME_DOWN<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_VOLUME_MUTE<span class="token operator">:</span>                <span class="token keyword">return</span> mDockMode <span class="token operator">!=</span> Intent<span class="token punctuation">.</span>EXTRA_DOCK_STATE_UNDOCKED<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ignore media and camera keys</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MUTE<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_HEADSETHOOK<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_PLAY<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_PAUSE<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_PLAY_PAUSE<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_STOP<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_NEXT<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_PREVIOUS<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_REWIND<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_RECORD<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_FAST_FORWARD<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MEDIA_AUDIO_TRACK<span class="token operator">:</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_CAMERA<span class="token operator">:</span>            <span class="token comment" spellcheck="true">// added by marco, begin</span>            <span class="token comment" spellcheck="true">// ignore menu key</span>            <span class="token keyword">case</span> KeyEvent<span class="token punctuation">.</span>KEYCODE_MENU<span class="token operator">:</span>   <span class="token comment" spellcheck="true">// å±å¹• Menu é”®æ¿€æ´»å±å¹•äº®åº¦</span>            <span class="token comment" spellcheck="true">// added by marco, end</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p>]]></content>
      
      
      <categories>
          
          <category> æŠ€æœ¯ç»†èŠ‚ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç»éªŒæ€»ç»“ </tag>
            
            <tag> æ•´æœºå¼€å‘ </tag>
            
            <tag> Bug/éœ€æ±‚ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº â€œGMS è®¤è¯â€</title>
      <link href="/2019/04/01/09.gu-ge-ren-zheng-xi-lie-guan-yu-gms-ren-zheng/"/>
      <url>/2019/04/01/09.gu-ge-ren-zheng-xi-lie-guan-yu-gms-ren-zheng/</url>
      
        <content type="html"><![CDATA[<h1 id="1-CTS"><a href="#1-CTS" class="headerlink" title="1. CTS"></a>1. CTS</h1><p>å…³äºä½•ä¸º CTSï¼Œä¸å†å±•å¼€æ¥æè¿°ï¼Œä½ å¯ä»¥ç›´æ¥å‚é˜…å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://source.android.com/compatibility/cts/setup" target="_blank" rel="noopener">CTSå®˜æ–¹èµ„æ–™</a>ã€‚</p><h2 id="1-1-Compatibility-Test-Suite"><a href="#1-1-Compatibility-Test-Suite" class="headerlink" title="1.1 Compatibility Test Suite"></a>1.1 Compatibility Test Suite</h2><h2 id="1-2-CTS-Verifier"><a href="#1-2-CTS-Verifier" class="headerlink" title="1.2 CTS Verifier"></a>1.2 CTS Verifier</h2><h1 id="2-GTS"><a href="#2-GTS" class="headerlink" title="2. GTS"></a>2. GTS</h1>]]></content>
      
      
      <categories>
          
          <category> GMS è®¤è¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTS </tag>
            
            <tag> GTS </tag>
            
            <tag> VTS </tag>
            
            <tag> STS </tag>
            
            <tag> GMS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è°ˆè°ˆ â€œæ—¶é—´å¤æ‚åº¦â€</title>
      <link href="/2019/03/01/11.suan-fa-zhuan-lan-xi-lie-tan-tan-shi-jian-fu-za-du/"/>
      <url>/2019/03/01/11.suan-fa-zhuan-lan-xi-lie-tan-tan-shi-jian-fu-za-du/</url>
      
        <content type="html"><![CDATA[<h2 id="1ã€ç®—æ³•æ•ˆç‡"><a href="#1ã€ç®—æ³•æ•ˆç‡" class="headerlink" title="1ã€ç®—æ³•æ•ˆç‡"></a>1ã€ç®—æ³•æ•ˆç‡</h2><p>è™½ç„¶éšç€è®¡ç®—æœºç¡¬ä»¶çš„è¿­ä»£æ›´æ–°ï¼Œè¿ç®—å¤„ç†çš„æ€§èƒ½è¶Šæ¥è¶Šå¼ºï¼Œä½†å®é™…ä¸Šï¼Œå®ƒä¹Ÿéœ€è¦æ ¹æ®è¾“å…¥æ•°æ®çš„å¤§å°å’Œç®—æ³•æ•ˆç‡æ¥æ¶ˆè€—ä¸€å®šçš„å¤„ç†å™¨èµ„æºã€‚è¦æƒ³ç¼–å†™å‡ºèƒ½é«˜æ•ˆè¿è¡Œçš„ç¨‹åºï¼Œæˆ‘ä»¬å°±éœ€è¦è€ƒè™‘åˆ° <strong><font color="#9932CC">â€œç®—æ³•çš„æ•ˆç‡â€</font></strong>ã€‚</p><p>è¡¡é‡ç®—æ³•çš„ <strong>â€œå¥½åâ€</strong> å’Œ <strong>â€œæ•ˆç‡â€</strong> ä¸»è¦ç”±ä»¥ä¸‹ä¸¤ä¸ªæŒ‡æ ‡ï¼ˆå¤æ‚åº¦ï¼‰æ¥è¯„ä¼°ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#FF0000">æ—¶é—´å¤æ‚åº¦ï¼ˆè¿è¡Œæ—¶é—´ï¼‰ï¼š</font></strong>è¯„ä¼°æ‰§è¡Œç¨‹åºæ‰€éœ€çš„æ—¶é—´ï¼Œå¯ä»¥ä¼°ç®—å‡ºç¨‹åºå¯¹å¤„ç†å™¨çš„ä½¿ç”¨ç¨‹åº¦ã€‚<strong><font color="#0000CD">ï¼ˆæœ¬ç¯‡åšæ–‡æˆ‘ä»¬é‡ç‚¹æ¢è®¨æ—¶é—´å¤æ‚åº¦ï¼‰</font></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#FF0000">ç©ºé—´å¤æ‚åº¦ï¼ˆå ç”¨ç©ºé—´ï¼‰ï¼š</font></strong>è¯„ä¼°æ‰§è¡Œç¨‹åºæ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥ä¼°ç®—å‡ºç¨‹åºå¯¹è®¡ç®—æœºå†…å­˜çš„ä½¿ç”¨ç¨‹åº¦ã€‚</p><h2 id="2ã€ç®—æ³•äº‹ä¾‹"><a href="#2ã€ç®—æ³•äº‹ä¾‹" class="headerlink" title="2ã€ç®—æ³•äº‹ä¾‹"></a>2ã€ç®—æ³•äº‹ä¾‹</h2><p>æˆ‘ä»¬é€šè¿‡å‡ ä¸ªåœºæ™¯å¼•å‡ºæ—¶é—´å¤æ‚åº¦çš„æ¦‚å¿µï¼Œä»¥åŠå¸¸è§çš„å‡ ç§æ—¶é—´å¤æ‚åº¦ï¼Œæœ€åå†æ€»ç»“æ¯”è¾ƒå®ƒä»¬çš„ä¼˜åŠ£ï¼</p><blockquote><p><strong>åœºæ™¯ä¸€</strong></p></blockquote><p><strong><font color="#FFA500">ç”Ÿæ´»åœºæ™¯ï¼š</font></strong> <strong>ä½ ä¹°äº†ä¸€ç®±â€œç‰›æ å±±äºŒé”…å¤´â€ï¼ˆ16ç“¶ï¼‰ï¼Œ2 å¤©å–ä¸€ç“¶ï¼Œå…¨éƒ¨å–å®Œéœ€è¦å‡ å¤©ï¼Ÿ</strong></p><p>è¿™æ˜¯ä¸€é“å¾ˆç®€å•çš„ç®—æœ¯é—®é¢˜ï¼Œ2 âœ– 16 = 32 å¤©ã€‚é‚£å¦‚æœä¸€ç®±æœ‰ n ç“¶ï¼Œåˆ™éœ€è¦ 2 âœ– n = 2n å¤©ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªå‡½æ•°æ¥è¡¨è¾¾è¿™ä¸ªç›¸å¯¹æ—¶é—´ï¼Œå¯ä»¥è®°ä½œ <strong><font color="#FF0000">T(n) = 2n</font></strong> ã€‚</p><p><strong><font color="#FFA500">ä»£ç åœºæ™¯ï¼š</font></strong></p><pre class=" language-java"><code class="language-java">    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>               <span class="token comment" spellcheck="true">// æ‰§è¡Œæ¬¡æ•°æ˜¯çº¿æ€§çš„</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å–ä¸€ç“¶é…’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><blockquote><p><strong>åœºæ™¯äºŒ</strong></p></blockquote><p><strong><font color="#FFA500">ç”Ÿæ´»åœºæ™¯ï¼š</font></strong> <strong>ä½ åˆä¹°äº†ä¸€ç®±â€œç‰›æ å±±äºŒé”…å¤´â€ï¼ˆ16ç“¶ï¼‰ï¼Œ5 å¤©ä¸ºä¸€ä¸ªå‘¨æœŸï¼Œæ¯æ¬¡å–å‰©ä¸‹é…’çš„ä¸€åŠï¼Œäºæ˜¯ç¬¬ä¸€æ¬¡å– 8 ç“¶ï¼Œç¬¬äºŒæ¬¡å– 4 ç“¶ï¼Œé‚£ä¹ˆå–åˆ°æœ€åä¸€ç“¶éœ€è¦å‡ å¤©ï¼Ÿ</strong></p><p>è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆç®€å•ï¼Œ16/2 = 8ï¼Œ8/2 = 4ï¼Œ4/2 = 2ï¼Œ2/2 = 1ï¼ˆè¿˜å‰©ä¸€ç“¶ï¼‰ï¼Œè¿™ä¸å°±æ˜¯å¯¹æ•°å‡½æ•°å—ï¼Ÿä»¥ 2 ä¸ºåº•æ•°ï¼Œ16ä¸ºçœŸæ•°ï¼Œå¾—åˆ°çš„å¯¹æ•°å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥ç®€å†™ä¸ºï¼š5log16ã€‚å¦‚æœä¸€ç®±æœ‰ n ç“¶ï¼Œåˆ™éœ€è¦ 5logn å¤©ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªå‡½æ•°æ¥è¡¨è¾¾è¿™ä¸ªç›¸å¯¹æ—¶é—´ï¼Œå¯ä»¥è®°ä½œ <strong><font color="#FF0000">T(n) = 5logn</font></strong> ã€‚</p><p><strong><font color="#FFA500">ä»£ç åœºæ™¯ï¼š</font></strong></p><pre class=" language-java"><code class="language-java">   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å–ä¸€ç“¶é…’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><strong>åœºæ™¯ä¸‰</strong></p></blockquote><p><strong><font color="#FFA500">ç”Ÿæ´»åœºæ™¯ï¼š</font></strong> <strong>é…’å–å¤šäº†ï¼Œä¹°äº†ä¸€ç“¶æ¸æï¼Œ3 å¤©å–ä¸€ç“¶ï¼Œè¯·é—®å–å®Œæ¸æè¦å‡ å¤©ï¼Ÿ</strong></p><p>æ˜¯çš„ï¼Œä½ æ²¡å¬é”™ï¼Œæˆ‘ç¡®å®æ˜¯é—®ä½ å–å®Œæ¸æè¦å¤šä¹…ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼š3å¤©ï¼å¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªå‡½æ•°æ¥è¡¨è¾¾è¿™ä¸ªç›¸å¯¹æ—¶é—´ï¼Œå¯ä»¥è®°ä½œï¼š<strong><font color="#FF0000">T(n) = 3</font></strong> ã€‚</p><p><strong><font color="#FFA500">ä»£ç åœºæ™¯ï¼š</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">drink</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>   System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å–ä¸€ç“¶æ¸æ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><strong>åœºæ™¯å››</strong></p></blockquote><p><strong><font color="#FFA500">ç”Ÿæ´»åœºæ™¯ï¼š</font></strong> <strong>é…’ç˜¾éš¾æˆ’ï¼Œåˆä¹°äº†ä¸€ç®±å¥½é…’ï¼ˆ6ç“¶ï¼‰ï¼Œä½†æ˜¯åˆä¸èƒ½å¤šå–ï¼Œäºæ˜¯ç¬¬ä¸€ç“¶å–äº†1å¤©ï¼Œç¬¬äºŒç“¶å–äº†2å¤©ï¼Œç¬¬ä¸‰ç“¶å–äº†3å¤©ï¼Œè¿™æ ·ä¸‹å»å…¨éƒ¨å–å®Œéœ€è¦å‡ å¤©ï¼Ÿ</strong></p><p>ä¸ç”¨æˆ‘è¯´ï¼Œå…¶å®è¿™å°±æ˜¯ä¸€ä¸ª 1 + 2 + 3 â€¦ + 6 çš„ç®—æœ¯é—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“æœ‰ä¸ªå…¬å¼ï¼š6(6+1)/2 = 21 å¤©ï¼Œé‚£å¦‚æœæœ‰ n ç“¶ï¼Œå°±éœ€è¦ n(n+1)/2 å¤©ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªå‡½æ•°æ¥è¡¨è¾¾è¿™ä¸ªç›¸å¯¹æ—¶é—´ï¼Œå¯ä»¥è®°ä½œ <strong><font color="#FF0000">T(n) = nÂ²/2 + n/2</font></strong> ã€‚</p><p><strong><font color="#FFA500">ä»£ç åœºæ™¯ï¼š</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">drink</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>           System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…ä¸€å¤©"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å–ä¸€ç“¶é…’"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="3ã€æ¸è¿›æ—¶é—´å¤æ‚åº¦"><a href="#3ã€æ¸è¿›æ—¶é—´å¤æ‚åº¦" class="headerlink" title="3ã€æ¸è¿›æ—¶é—´å¤æ‚åº¦"></a>3ã€æ¸è¿›æ—¶é—´å¤æ‚åº¦</h2><p>æœ‰äº†åŸºæœ¬æ“ä½œæ‰§è¡Œæ¬¡æ•°çš„å‡½æ•° T(n)ï¼Œæ˜¯å¦å°±å¯ä»¥åˆ†æå’Œæ¯”è¾ƒä¸€æ®µä»£ç çš„è¿è¡Œæ—¶é—´äº†å‘¢ï¼Ÿè¿˜æ˜¯æœ‰ä¸€å®šçš„å›°éš¾ã€‚æ¯”å¦‚ç®—æ³• A çš„ç›¸å¯¹æ—¶é—´æ˜¯ <strong><font color="#0000CD">T(n) = 100n</font></strong> ï¼Œç®—æ³• B çš„ç›¸å¯¹æ—¶é—´æ˜¯ <strong><font color="#0000CD">T(n) = 5nÂ²</font></strong> ï¼Œè¿™ä¸¤ä¸ªåˆ°åº•è°çš„è¿è¡Œæ—¶é—´æ›´é•¿ä¸€äº›ï¼Ÿ<strong><font color="#0000CD">è¿™å°±è¦çœ‹ n çš„å–å€¼äº†ï¼</font></strong></p><p>æ‰€ä»¥ï¼Œè¿™æ—¶å€™æœ‰äº† <strong><font color="#FF0000">â€œæ¸è¿›æ—¶é—´å¤æ‚åº¦â€</font></strong>ï¼ˆasymptotic time complectiyï¼‰çš„æ¦‚å¿µã€‚</p><blockquote><p><strong><font color="#8470FF">æˆ‘ä»¬çœ‹çœ‹å®˜æ–¹çš„å®šä¹‰ï¼š</font></strong><br>è‹¥å­˜åœ¨å‡½æ•° f(n)ï¼Œä½¿å¾—å½“ n è¶‹è¿‘äºæ— ç©·å¤§æ—¶ï¼ŒT(n) / f(n) çš„æé™å€¼ä¸ºä¸ç­‰äºé›¶çš„å¸¸æ•°ï¼Œåˆ™ç§° f(n) æ˜¯ T(n) çš„åŒæ•°é‡çº§å‡½æ•°ã€‚è®°ä½œ T(n)= O(f(n))ï¼Œç§° O(f(n)) ä¸ºç®—æ³•çš„ <strong><font color="#FF0000">â€œæ¸è¿›æ—¶é—´å¤æ‚åº¦â€</font></strong>ï¼Œç®€ç§° <strong><font color="#FF0000">â€œæ—¶é—´å¤æ‚åº¦â€</font></strong>ã€‚æ¸è¿›æ—¶é—´å¤æ‚åº¦ç”¨å¤§å†™ O æ¥è¡¨ç¤ºï¼Œæ‰€ä»¥ä¹Ÿè¢«ç§°ä¸º <strong><font color="#FF0000">â€œå¤§Oè¡¨ç¤ºæ³•â€</font></strong>ã€‚</p></blockquote><h2 id="4ã€æ¨å¯¼åŸåˆ™"><a href="#4ã€æ¨å¯¼åŸåˆ™" class="headerlink" title="4ã€æ¨å¯¼åŸåˆ™"></a>4ã€æ¨å¯¼åŸåˆ™</h2><p><strong><font color="#FF0000">å¦‚ä½•æ¨å¯¼å‡ºæ—¶é—´å¤æ‚åº¦å‘¢ï¼Ÿæœ‰å¦‚ä¸‹å‡ ä¸ªåŸåˆ™ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âš«&nbsp;1ã€å¦‚æœè¿è¡Œæ—¶é—´æ˜¯å¸¸æ•°é‡çº§ï¼Œç”¨å¸¸æ•° 1 è¡¨ç¤ºï¼›</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âš«&nbsp;2ã€åªä¿ç•™æ—¶é—´å‡½æ•°ä¸­çš„æœ€é«˜é˜¶é¡¹ï¼›</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âš«&nbsp;3ã€å¦‚æœæœ€é«˜é˜¶é¡¹å­˜åœ¨ï¼Œåˆ™çœå»æœ€é«˜é˜¶é¡¹å‰é¢çš„ç³»æ•°ã€‚</p><h2 id="5ã€äº‹ä¾‹å†åˆ†æ"><a href="#5ã€äº‹ä¾‹å†åˆ†æ" class="headerlink" title="5ã€äº‹ä¾‹å†åˆ†æ"></a>5ã€äº‹ä¾‹å†åˆ†æ</h2><blockquote><p><strong>åœºæ™¯ä¸€</strong></p></blockquote><p>ç›¸å¯¹æ—¶é—´ï¼š<strong><font color="#0000FF">T(n) = 2n</font></strong> ï¼Œæ ¹æ®æ¨å¯¼åŸåˆ™ 3ï¼šæœ€é«˜é˜¶æ•°ä¸º 2n ï¼Œçœå»ç³»æ•° 2 ï¼Œè½¬æ¢åçš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š<strong><font color="#FF0000">T(n) = O(n)</font></strong> ã€‚</p><blockquote><p><strong>åœºæ™¯äºŒ</strong></p></blockquote><p>ç›¸å¯¹æ—¶é—´ï¼š<strong><font color="#0000FF">T(n) = 5logn</font></strong> ï¼Œæ ¹æ®æ¨å¯¼åŸåˆ™ 3ï¼šæœ€é«˜é˜¶æ•°ä¸º 5logn ï¼Œçœå»ç³»æ•° 5 ï¼Œè½¬æ¢åçš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š<strong><font color="#FF0000">T(n) = O(logn)</font></strong> ã€‚</p><blockquote><p><strong>åœºæ™¯ä¸‰</strong></p></blockquote><p>ç›¸å¯¹æ—¶é—´ï¼š<strong><font color="#0000FF">T(n) = 3</font></strong> ï¼Œæ ¹æ®æ¨å¯¼åŸåˆ™ 1ï¼šåªæœ‰å¸¸æ•°é‡çº§ ï¼Œç”¨å¸¸æ•° 1 è¡¨ç¤º ï¼Œè½¬æ¢åçš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š<strong><font color="#FF0000">T(n) = O(1)</font></strong> ã€‚</p><blockquote><p><strong>åœºæ™¯å››</strong></p></blockquote><p>ç›¸å¯¹æ—¶é—´ï¼š<strong><font color="#0000FF">T(n) = nÂ²/2 + n/2</font></strong> ï¼Œæ ¹æ®æ¨å¯¼åŸåˆ™ 2ï¼šæœ€é«˜é˜¶æ•°ä¸º nÂ²/2 ï¼Œçœå»ç³»æ•° 0.5 ï¼Œè½¬æ¢åçš„æ—¶é—´å¤æ‚åº¦ä¸ºï¼š<strong><font color="#FF0000">T(n) = O(nÂ²)</font></strong> ã€‚</p><p>è¿™å››ç§æ—¶é—´å¤æ‚åº¦ç©¶ç«Ÿè°ç”¨æ—¶æ›´é•¿ï¼Œè°èŠ‚çœæ—¶é—´å‘¢ï¼Ÿ<strong><font color="#FF00FF">O(1) &lt; O(logn) &lt; O(n) &lt; O(nÂ²)</font></strong></p><h2 id="6ã€å…¶ä»–å¸¸è§å¤æ‚åº¦"><a href="#6ã€å…¶ä»–å¸¸è§å¤æ‚åº¦" class="headerlink" title="6ã€å…¶ä»–å¸¸è§å¤æ‚åº¦"></a>6ã€å…¶ä»–å¸¸è§å¤æ‚åº¦</h2><p>é™¤äº†å¸¸æ•°é˜¶ã€çº¿æ€§é˜¶ã€å¹³æ–¹é˜¶ã€å¯¹æ•°é˜¶ï¼Œè¿˜æœ‰å¦‚ä¸‹æ—¶é—´å¤æ‚åº¦ï¼š</p><table><thead><tr><th style="text-align:center">f(n)</th><th style="text-align:center">æ—¶é—´å¤æ‚åº¦</th><th style="text-align:center">é˜¶</th></tr></thead><tbody><tr><td style="text-align:center">nlogn</td><td style="text-align:center">O(nlogn)</td><td style="text-align:center">nlogn é˜¶</td></tr><tr><td style="text-align:center">nÂ³</td><td style="text-align:center">O(nÂ³)</td><td style="text-align:center">ç«‹æ–¹é˜¶</td></tr><tr><td style="text-align:center">2â¿</td><td style="text-align:center">O(2â¿)</td><td style="text-align:center">æŒ‡æ•°é˜¶</td></tr><tr><td style="text-align:center">n!</td><td style="text-align:center">O(n!)</td><td style="text-align:center">é˜¶ä¹˜é˜¶</td></tr><tr><td style="text-align:center">(âˆšn)</td><td style="text-align:center">O(âˆšn)</td><td style="text-align:center">å¹³æ–¹æ ¹é˜¶</td></tr></tbody></table><h2 id="7ã€å¤æ‚åº¦æ¯”è¾ƒ"><a href="#7ã€å¤æ‚åº¦æ¯”è¾ƒ" class="headerlink" title="7ã€å¤æ‚åº¦æ¯”è¾ƒ"></a>7ã€å¤æ‚åº¦æ¯”è¾ƒ</h2><table><thead><tr><th style="text-align:center">n</th><th style="text-align:center">logn</th><th style="text-align:center">âˆšn</th><th style="text-align:center">nlogn</th><th style="text-align:center">nÂ²</th><th style="text-align:center">2â¿</th><th style="text-align:center">n!</th></tr></thead><tbody><tr><td style="text-align:center">5</td><td style="text-align:center">2</td><td style="text-align:center">2</td><td style="text-align:center">10</td><td style="text-align:center">25</td><td style="text-align:center">32</td><td style="text-align:center">120</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">3</td><td style="text-align:center">3</td><td style="text-align:center">30</td><td style="text-align:center">100</td><td style="text-align:center">1024</td><td style="text-align:center">3628800</td></tr><tr><td style="text-align:center">50</td><td style="text-align:center">5</td><td style="text-align:center">7</td><td style="text-align:center">250</td><td style="text-align:center">2500</td><td style="text-align:center">çº¦10^15</td><td style="text-align:center">çº¦3.0*10^64</td></tr><tr><td style="text-align:center">100</td><td style="text-align:center">6</td><td style="text-align:center">10</td><td style="text-align:center">600</td><td style="text-align:center">10000</td><td style="text-align:center">çº¦10^30</td><td style="text-align:center">çº¦9.3*10^157</td></tr><tr><td style="text-align:center">1000</td><td style="text-align:center">9</td><td style="text-align:center">31</td><td style="text-align:center">9000</td><td style="text-align:center">1000 000</td><td style="text-align:center">çº¦10^300</td><td style="text-align:center">çº¦4.0*10^2567</td></tr></tbody></table><p><br></p><p>ä»ä¸Šè¡¨å¯ä»¥çœ‹å‡ºï¼ŒO(n)ã€O(logn)ã€O(âˆšn)ã€O(nlogn) éšç€ n çš„å¢åŠ ï¼Œå¤æ‚åº¦æå‡ä¸å¤§ï¼Œå› æ­¤è¿™äº›å¤æ‚åº¦å±äºæ•ˆç‡æ¯”è¾ƒé«˜çš„ç®—æ³•ï¼Œåè§‚ O(2â¿) å’Œ O(n!) å½“ n å¢åŠ åˆ° 50 æ—¶ï¼Œå¤æ‚åº¦å°±çªç ´åä½æ•°äº†ï¼Œè¿™ç§æ•ˆç‡æå·®çš„å¤æ‚åº¦æœ€å¥½ä¸è¦å‡ºç°åœ¨ç¨‹åºä¸­ï¼Œå› æ­¤åœ¨åŠ¨æ‰‹ç¼–ç¨‹æ—¶è¦è¯„ä¼°æ‰€å†™ç®—æ³•çš„æœ€åæƒ…å†µçš„å¤æ‚åº¦ã€‚</p><p>è¿™äº›æ—¶é—´å¤æ‚åº¦ç©¶ç«Ÿè°ç”¨æ—¶æ›´é•¿ï¼Œè°èŠ‚çœæ—¶é—´å‘¢ï¼Ÿ</p><p><strong><font color="#FF00FF">O(1) &lt; O(logn) &lt; O(âˆšn) &lt; O(n) &lt; O(nlogn) &lt; O(nÂ²) &lt; O(nÂ³) &lt; O(2â¿) &lt; O(n!)</font></strong></p><h2 id="8ã€å†ä¸¾ä¸€ä¾‹"><a href="#8ã€å†ä¸¾ä¸€ä¾‹" class="headerlink" title="8ã€å†ä¸¾ä¸€ä¾‹"></a>8ã€å†ä¸¾ä¸€ä¾‹</h2><p><strong><font color="#FF0000">ã€ç–‘é—®ã€‘ï¼šç°åœ¨è®¡ç®—æœºç¡¬ä»¶æ€§èƒ½è¶Šæ¥è¶Šå¼ºï¼Œç®—æ³•çœŸçš„ä½“éªŒé‚£ä¹ˆæ˜æ˜¾å—ï¼Ÿç®—æ³•æ—¶é—´å¤æ‚åº¦çœŸçš„éœ€è¦é‚£ä¹ˆé‡è§†å—ï¼Ÿ</font></strong></p><p>æˆ‘ç›¸ä¿¡ä½ è‚¯å®šå­˜åœ¨è¿™æ ·çš„ç–‘é—®ï¼Œè™½ç„¶æˆ‘ä»¬çŸ¥é“ç®—æ³•è¿™ä¸ªä¸œè¥¿æ˜¯å¾ˆé‡è¦çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¹³å¸¸å¯èƒ½æ¥è§¦ä¸å¤šï¼Œå¾ˆå¤šæ—¶å€™è®¡ç®—æœºçš„æ€§èƒ½å·²ç»èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯è¦ä¸¾ä¸ªä¾‹å­è®©ä½ æ›´ç›´è§‚çš„çœ‹åˆ°ä¸åŒç®—æ³•ä¹‹é—´çš„å·¨å¤§å·®å¼‚ï¼</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#FF00FF">ç®—æ³• A çš„ç›¸å¯¹æ—¶é—´è§„æ¨¡æ˜¯ T(n) = 100nï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œç®—æ³• A è¿è¡Œåœ¨è€æ—§ç”µè„‘ä¸Šã€‚</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#FF00FF">ç®—æ³• B çš„ç›¸å¯¹æ—¶é—´è§„æ¨¡æ˜¯ T(n) = 5nÂ²ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(nÂ²)ï¼Œç®—æ³• B è¿è¡Œåœ¨æŸå°è¶…çº§è®¡ç®—æœºä¸Šï¼Œè¿è¡Œé€Ÿåº¦æ˜¯è€æ—§ç”µè„‘çš„ 100 å€ã€‚</font></p><p>å½“éšç€ n çš„å¢å¤§ï¼Œæˆ‘ä»¬é€šè¿‡è¡¨æ ¼çœ‹çœ‹ T(n) çš„å˜åŒ–ï¼š</p><table><thead><tr><th style="text-align:center">n</th><th style="text-align:center">T(n) = 100n âœ– 100</th><th style="text-align:center">T(n) = 5nÂ²</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">10000</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">50000</td><td style="text-align:center">125</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">10 0000</td><td style="text-align:center">500</td></tr><tr><td style="text-align:center">100</td><td style="text-align:center">100 0000</td><td style="text-align:center">50000</td></tr><tr><td style="text-align:center">1000</td><td style="text-align:center">1000 0000</td><td style="text-align:center">500 0000</td></tr><tr><td style="text-align:center">2000</td><td style="text-align:center"><font color="#FF0000">2000 0000</font></td><td style="text-align:center"><font color="#FF0000">2000 0000</font></td></tr><tr><td style="text-align:center">10000</td><td style="text-align:center">1 0000 0000</td><td style="text-align:center">5 0000 0000</td></tr><tr><td style="text-align:center">100000</td><td style="text-align:center">10 0000 0000</td><td style="text-align:center">500 0000 0000</td></tr><tr><td style="text-align:center">1000000</td><td style="text-align:center">100 0000 0000</td><td style="text-align:center">50000 0000 0000</td></tr></tbody></table><p><br></p><p>ä»è¡¨æ ¼ä¸­å¯ä»¥çœ‹å‡ºï¼Œå½“ n çš„å€¼å¾ˆå°çš„æ—¶å€™ï¼Œç®—æ³• A çš„è¿è¡Œç”¨æ—¶è¦è¿œå¤§äºç®—æ³• Bï¼›å½“ n çš„å€¼è¾¾åˆ° 1000 å·¦å³ï¼Œç®—æ³• A å’Œç®—æ³• B çš„è¿è¡Œæ—¶é—´å·²ç»æ¥è¿‘ï¼›å½“ n çš„å€¼è¾¾åˆ° 2000 å·¦å³ï¼Œç®—æ³• A å’Œ ç®—æ³• B çš„è¿è¡Œæ—¶é—´ä¸€è‡´ï¼›å½“ n çš„å€¼è¶Šæ¥è¶Šå¤§ï¼Œè¾¾åˆ°åä¸‡ã€ç™¾ä¸‡æ—¶ï¼Œç®—æ³• A çš„ä¼˜åŠ¿å¼€å§‹æ˜¾ç°ï¼Œç®—æ³• B åˆ™è¶Šæ¥è¶Šæ…¢ï¼Œå·®è·è¶Šæ¥è¶Šæ˜æ˜¾ã€‚è¿™å°±æ˜¯ä¸åŒæ—¶é—´å¤æ‚åº¦å¸¦æ¥çš„å·®è·ï¼Œå³ä¾¿ä½ çš„è®¡ç®—æœºå¾ˆç‰›Xï¼</p><p><br></p><p><strong><font color="#FF00FF" size="5">å‚è€ƒåšå®¢</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://blog.csdn.net/qq_41523096/article/details/82142747" target="_blank" rel="noopener">ä¸€å¥—å›¾ ææ‡‚â€œæ—¶é—´å¤æ‚åº¦â€</a></p>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³•ä¸“æ  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> æ—¶é—´å¤æ‚åº¦ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ8ï¼‰- APK å®‰è£…ï¼ˆä¸‹ï¼‰</title>
      <link href="/2019/02/06/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-8-apk-an-zhuang-xia/"/>
      <url>/2019/02/06/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-8-apk-an-zhuang-xia/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† PackageManagerService å®‰è£… APK çš„æµç¨‹ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">PackageInstallerSession.java</font></td><td>/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java</td></tr><tr><td><font color="#D15FEE">PackageManagerService.java</font></td><td>/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td></tr></tbody></table><p><br></p><h2 id="1-2-å‰è¨€"><a href="#1-2-å‰è¨€" class="headerlink" title="1.2 å‰è¨€"></a>1.2 å‰è¨€</h2><p>åœ¨æœ¬ç³»åˆ—ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://superandroid.pro/2018/11/15/B_05.%20Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%885%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88PI%EF%BC%89/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ7ï¼‰- APK å®‰è£…ï¼ˆä¸­ï¼‰</a> ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº† PackageInstaller å®‰è£… APK çš„æµç¨‹ï¼Œæœ€åä¼šå°† APK çš„ä¿¡æ¯äº¤ç”± PMS å¤„ç†ã€‚é‚£ä¹ˆ PMS æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬è¿™ç¯‡æ–‡ç« éœ€è¦åˆ†æçš„ã€‚<br><br></p><h1 id="ä¸€ã€å®‰è£…-APK"><a href="#ä¸€ã€å®‰è£…-APK" class="headerlink" title="ä¸€ã€å®‰è£… APK"></a>ä¸€ã€å®‰è£… APK</h1><h2 id="1-1-handleReturnCode"><a href="#1-1-handleReturnCode" class="headerlink" title="1.1 handleReturnCode"></a>1.1 handleReturnCode</h2><p>æˆ‘ä»¬å›åˆ° APK çš„å¤åˆ¶è°ƒç”¨é“¾çš„å¤´éƒ¨æ–¹æ³•ï¼šHandlerParams çš„ startCopy æ–¹æ³•ï¼Œåœ¨æœ€å è°ƒç”¨äº† handleReturnCode æ–¹æ³•ï¼Œè¿›è¡Œ APK çš„å®‰è£…ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">HandlerParams</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_RETRIES <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">int</span> mRetries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">startCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">boolean</span> res<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>mRetries <span class="token operator">></span> MAX_RETRIES<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token function">handleStartCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           res <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// å¤„ç†å¤åˆ¶ APK åçš„å®‰è£… APK é€»è¾‘</span>            <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>handleReturnCode ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å“ªé‡Œå®ç°ï¼ŸåŒæ ·ï¼Œå®ƒçš„å®ç°åœ¨ InstallParams ä¸­ã€‚</p><pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">void</span> <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// If mArgs is null, then MCS couldn't be reached. When it</span>            <span class="token comment" spellcheck="true">// reconnects, it will try again to install. At that point, this</span>            <span class="token comment" spellcheck="true">// will succeed.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mArgs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// "è£…è½½ä»£ç "çš„å…¥å£æ˜¯ processPendingInstall(InstallArgs,int) æ–¹æ³•</span>                <span class="token function">processPendingInstall</span><span class="token punctuation">(</span>mArgs<span class="token punctuation">,</span> mRet<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å‘ç°è°ƒç”¨äº† processPendingInstall æ–¹æ³•ï¼Œç»§ç»­è·Ÿï¼</p><h2 id="1-2-processPendingInstall"><a href="#1-2-processPendingInstall" class="headerlink" title="1.2 processPendingInstall"></a>1.2 processPendingInstall</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processPendingInstall</span><span class="token punctuation">(</span><span class="token keyword">final</span> InstallArgs args<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                PackageInstalledInfo res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstalledInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span><span class="token function">setReturnCode</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span>pkg <span class="token operator">=</span> null<span class="token punctuation">;</span>                res<span class="token punctuation">.</span>removedInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>                     <span class="token operator">*</span> å®‰è£…å‰å¤„ç†                     <span class="token operator">*</span> ç”¨äºæ£€æŸ¥ APK çš„çŠ¶æ€çš„ï¼Œåœ¨å®‰è£…å‰ç¡®ä¿å®‰è£…ç¯å¢ƒçš„å¯é ï¼Œå¦‚æœä¸å¯é ä¼šæ¸…é™¤å¤åˆ¶çš„ APK æ–‡ä»¶                    args<span class="token punctuation">.</span><span class="token function">doPreInstall</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">installPackageTracedLI</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>                    <span class="token punctuation">}</span>                    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>                     <span class="token operator">*</span> å®‰è£…åæ”¶å°¾                     <span class="token operator">*</span> ç”¨äºå¤„ç†å®‰è£…åçš„æ”¶å°¾æ“ä½œï¼Œå¦‚æœå®‰è£…ä¸æˆåŠŸï¼Œåˆ é™¤æ‰å®‰è£…ç›¸å…³çš„ç›®å½•ä¸æ–‡ä»¶                    args<span class="token punctuation">.</span><span class="token function">doPostInstall</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">,</span> res<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="1-3-installPackageTracedLI"><a href="#1-3-installPackageTracedLI" class="headerlink" title="1.3 installPackageTracedLI"></a>1.3 installPackageTracedLI</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackageTracedLI</span><span class="token punctuation">(</span>InstallArgs args<span class="token punctuation">,</span> PackageInstalledInfo res<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"installPackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">installPackageLI</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="1-4-installPackageLI"><a href="#1-4-installPackageLI" class="headerlink" title="1.4 installPackageLI"></a>1.4 installPackageLI</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackageLI</span><span class="token punctuation">(</span>InstallArgs args<span class="token punctuation">,</span> PackageInstalledInfo res<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"parsePackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è§£æ APK</span>            pkg <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>tmpPackageFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token string">"Failed parse during installPackageLI"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// Get rid of all references to package scan path via parser.</span>        pp <span class="token operator">=</span> null<span class="token punctuation">;</span>        String oldCodePath <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">boolean</span> systemApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ£€æŸ¥ APK æ˜¯å¦å­˜åœ¨</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_REPLACE_EXISTING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// è·å–æ²¡è¢«æ”¹åå‰çš„åŒ…å</span>                String oldName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mOriginalPackages <span class="token operator">!=</span> null                        <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>mOriginalPackages<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>oldName<span class="token punctuation">)</span>                        <span class="token operator">&amp;&amp;</span> mPackages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>oldName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    pkg<span class="token punctuation">.</span><span class="token function">setPackageName</span><span class="token punctuation">(</span>oldName<span class="token punctuation">)</span><span class="token punctuation">;</span>                    pkgName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è®¾ç½®æ ‡å¿—ä½è¡¨ç¤ºæ˜¯æ›¿æ¢å®‰è£…</span>                    replace <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Replacing existing renamed package: oldName="</span>                            <span class="token operator">+</span> oldName <span class="token operator">+</span> <span class="token string">" pkgName="</span> <span class="token operator">+</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æŸ¥çœ‹ Settings ä¸­æ˜¯å¦å­˜æœ‰è¦å®‰è£…çš„ APK çš„ä¿¡æ¯ï¼Œå¦‚æœæœ‰å°±è·å–ç­¾åä¿¡æ¯</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Existing package: "</span> <span class="token operator">+</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>                PackageSetting signatureCheckPs <span class="token operator">=</span> ps<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    SharedLibraryEntry libraryEntry <span class="token operator">=</span> <span class="token function">getLatestSharedLibraVersionLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>libraryEntry <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        signatureCheckPs <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>libraryEntry<span class="token punctuation">.</span>apk<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// æ£€æŸ¥ç­¾åçš„æ­£ç¡®æ€§</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldCheckUpgradeKeySetLP</span><span class="token punctuation">(</span>signatureCheckPs<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkUpgradeKeySetLP</span><span class="token punctuation">(</span>signatureCheckPs<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_UPDATE_INCOMPATIBLE<span class="token punctuation">,</span> <span class="token string">"Package "</span>                                <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">" upgrade keys do not match the "</span>                                <span class="token operator">+</span> <span class="token string">"previously installed version"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            <span class="token keyword">int</span> N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// éå†æ¯ä¸ªæƒé™ï¼Œå¯¹æƒé™è¿›è¡Œå¤„ç†</span>                PackageParser<span class="token punctuation">.</span>Permission perm <span class="token operator">=</span> pkg<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                BasePermission bp <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPermissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>perm<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>systemApp <span class="token operator">||</span> sPmsExt<span class="token punctuation">.</span><span class="token function">isOperatorApp</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">,</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">,</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>onExternal<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ç³»ç»ŸAPPä¸èƒ½åœ¨SDå¡ä¸Šæ›¿æ¢å®‰è£…</span>                res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_INVALID_INSTALL_LOCATION<span class="token punctuation">,</span>                        <span class="token string">"Cannot install updates to system apps on sdcard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instantApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ç³»ç»Ÿ APP ä¸èƒ½è¢« Instant App æ›¿æ¢</span>                res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_INSTANT_APP_INVALID<span class="token punctuation">,</span>                        <span class="token string">"Cannot update a system app with an instant app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// é‡å‘½åä¸´æ—¶æ–‡ä»¶</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">.</span><span class="token function">doRename</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> oldCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_INSUFFICIENT_STORAGE<span class="token punctuation">,</span> <span class="token string">"Failed rename"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instantApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">startIntentFilterVerifications</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_DOMAIN_VERIFICATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Not verifying instant app install for app links: "</span> <span class="token operator">+</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span>PackageFreezer freezer <span class="token operator">=</span> <span class="token function">freezePackageForInstall</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> installFlags<span class="token punctuation">,</span>                <span class="token string">"installPackageLI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ›¿æ¢å®‰è£…</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    PackageParser<span class="token punctuation">.</span>Package existingPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingPkg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> existingPkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">!=</span> pkg<span class="token punctuation">.</span>mVersionCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_DUPLICATE_PACKAGE<span class="token punctuation">,</span> <span class="token string">"Packages declaring "</span>                                <span class="token operator">+</span> <span class="token string">"static-shared libs cannot be updated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token function">replacePackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_REPLACING<span class="token punctuation">,</span> args<span class="token punctuation">.</span>user<span class="token punctuation">,</span>                        installerPackageName<span class="token punctuation">,</span> res<span class="token punctuation">,</span> args<span class="token punctuation">.</span>installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å®‰è£…æ–°çš„ APK</span>                <span class="token function">installNewPackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">,</span>                        args<span class="token punctuation">.</span>user<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> volumeUuid<span class="token punctuation">,</span> res<span class="token punctuation">,</span> args<span class="token punctuation">.</span>installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ›´æ–°åº”ç”¨ç¨‹åºæ‰€å±çš„ç”¨æˆ·</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                res<span class="token punctuation">.</span>newUsers <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">queryInstalledUsers</span><span class="token punctuation">(</span>sUserManager<span class="token punctuation">.</span><span class="token function">getUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ps<span class="token punctuation">.</span><span class="token function">setUpdateAvailable</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*updateAvailable*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>installPackageLI æ–¹æ³•çš„ä»£ç å¾ˆé•¿ï¼Œè¿™é‡Œæˆªå–ä¸»è¦çš„éƒ¨åˆ†ï¼Œä¸»è¦åšäº†å‡ ä»¶äº‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€åˆ›å»º PackageParser è§£æ APK ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€æ£€æŸ¥ APK æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è·å–æ­¤å‰æ²¡è¢«æ”¹åå‰çš„åŒ…åï¼Œèµ‹å€¼ç»™ PackageParser.Package ç±»å‹çš„ pkg ï¼Œå°†æ ‡å¿—ä½ replace ç½®ä¸º true è¡¨ç¤ºæ˜¯æ›¿æ¢å®‰è£…ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€å¦‚æœ Settings ä¸­ä¿å­˜æœ‰è¦å®‰è£…çš„ APK çš„ä¿¡æ¯ï¼Œè¯´æ˜æ­¤å‰å®‰è£…è¿‡è¯¥ APK ï¼Œåˆ™éœ€è¦æ ¡éªŒ APK çš„ç­¾åä¿¡æ¯ï¼Œç¡®ä¿å®‰å…¨çš„è¿›è¡Œæ›¿æ¢ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;4ã€å°†ä¸´æ—¶æ–‡ä»¶é‡æ–°å‘½åï¼Œæ¯”å¦‚å‰é¢æåˆ°çš„ /data/app/vmdl18300388.tmp/base.apk ï¼Œé‡å‘½åä¸º /data/app/åŒ…å-1/base.apk ã€‚è¿™ä¸ªæ–°å‘½åçš„åŒ…åä¼šå¸¦ä¸Šä¸€ä¸ªæ•°å­—åç¼€ 1ï¼Œæ¯æ¬¡å‡çº§ä¸€ä¸ªå·²æœ‰çš„ App ï¼Œè¿™ä¸ªæ•°å­—ä¼šä¸æ–­çš„ç´¯åŠ ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;5ã€ç³»ç»Ÿ APP çš„æ›´æ–°å®‰è£…ä¼šæœ‰ä¸¤ä¸ªé™åˆ¶ï¼Œä¸€ä¸ªæ˜¯ç³»ç»Ÿ APP ä¸èƒ½åœ¨ SD å¡ä¸Šæ›¿æ¢å®‰è£…ï¼Œå¦ä¸€ä¸ªæ˜¯ç³»ç»Ÿ APP ä¸èƒ½è¢« Instant App æ›¿æ¢ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;6ã€æ ¹æ® replace æ¥åšåŒºåˆ†ï¼Œå¦‚æœæ˜¯æ›¿æ¢å®‰è£…å°±ä¼šè°ƒç”¨ replacePackageLIF æ–¹æ³•ï¼Œå…¶æ–¹æ³•å†…éƒ¨è¿˜ä¼šå¯¹ç³»ç»Ÿ APP å’Œéç³»ç»Ÿ APP è¿›è¡ŒåŒºåˆ†å¤„ç†ï¼Œå¦‚æœæ˜¯æ–°å®‰è£… APK ä¼šè°ƒç”¨ installNewPackageLIF æ–¹æ³•ã€‚</p><h2 id="1-5-installNewPackageLIF"><a href="#1-5-installNewPackageLIF" class="headerlink" title="1.5 installNewPackageLIF"></a>1.5 installNewPackageLIF</h2><p>æˆ‘ä»¬ä»¥å®‰è£…æ–° APK ä¸ºä¾‹ï¼ŒæŸ¥çœ‹ installNewPackageLIF çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*     * Install a non-existing package.     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installNewPackageLIF</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> policyFlags<span class="token punctuation">,</span>            <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span> String installerPackageName<span class="token punctuation">,</span> String volumeUuid<span class="token punctuation">,</span>            PackageInstalledInfo res<span class="token punctuation">,</span> <span class="token keyword">int</span> installReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"installNewPackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ‰«æ APK</span>            PackageParser<span class="token punctuation">.</span>Package newPackage <span class="token operator">=</span> <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> policyFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                    System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ›´æ–° Settings ä¿¡æ¯</span>            <span class="token function">updateSettingsLI</span><span class="token punctuation">(</span>newPackage<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user<span class="token punctuation">,</span> installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å®‰è£…æˆåŠŸåï¼Œä¸ºæ–°å®‰è£…çš„åº”ç”¨ç¨‹åºå‡†å¤‡æ•°æ®</span>                <span class="token function">prepareAppDataAfterInstallLIF</span><span class="token punctuation">(</span>newPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å®‰è£…å¤±è´¥åˆ™åˆ é™¤ APK</span>                <span class="token function">deletePackageLIF</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span>                        PackageManager<span class="token punctuation">.</span>DELETE_KEEP_DATA<span class="token punctuation">,</span> res<span class="token punctuation">.</span>removedInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token string">"Package couldn't be installed in "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>installNewPackageLIF ä¸»è¦åšäº†ä»¥ä¸‹ 3 ä»¶äº‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€æ‰«æ APKï¼Œå°† APK çš„ä¿¡æ¯å­˜å‚¨åœ¨ PackageParser.Package ç±»å‹çš„ newPackage ä¸­ï¼Œä¸€ä¸ª Package çš„ä¿¡æ¯åŒ…å«äº† 1 ä¸ª base APK ä»¥åŠ 0 ä¸ªæˆ–è€…å¤šä¸ª split APK ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€æ›´æ–°è¯¥ APK å¯¹åº”çš„ Settings ä¿¡æ¯ï¼ŒSettings ç”¨äºä¿å­˜æ‰€æœ‰åŒ…çš„åŠ¨æ€è®¾ç½®ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€å¦‚æœå®‰è£…æˆåŠŸå°±ä¸ºæ–°å®‰è£…çš„åº”ç”¨ç¨‹åºå‡†å¤‡æ•°æ®ï¼Œå®‰è£…å¤±è´¥å°±åˆ é™¤APKã€‚</p><h2 id="1-6-scanPackageTracedLI"><a href="#1-6-scanPackageTracedLI" class="headerlink" title="1.6 scanPackageTracedLI"></a>1.6 scanPackageTracedLI</h2><p>è°ƒç”¨ scanPackageTracedLI() è¿›è¡Œå®‰è£… ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span>            <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"scanPackage ["</span> <span class="token operator">+</span> scanFile<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="1-7-scanPackageLI-01"><a href="#1-7-scanPackageLI-01" class="headerlink" title="1.7 scanPackageLI - 01"></a>1.7 scanPackageLI - 01</h2><p>scanPackageTracedLI() è°ƒç”¨äº† scanPackageLI() æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     *  Scans a package and returns the newly parsed package.     *  Returns {@code null} in case of errors and the error code is stored in mLastScanError     */</span>    <span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span>            <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Parsing: "</span> <span class="token operator">+</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setOnlyCoreApps</span><span class="token punctuation">(</span>mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="1-8-scanPackageLI-02"><a href="#1-8-scanPackageLI-02" class="headerlink" title="1.8 scanPackageLI - 02"></a>1.8 scanPackageLI - 02</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> policyFlags<span class="token punctuation">,</span>            <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span>                    <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// scanPackageDirtyLI å®é™…å®‰è£… package çš„æ–¹æ³•</span>            <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package res <span class="token operator">=</span> <span class="token function">scanPackageDirtyLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> policyFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                    currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>            success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span>                <span class="token function">destroyAppDataLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">,</span>                        StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_DE <span class="token operator">|</span> StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_CE<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">destroyAppProfilesLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>æœ€ç»ˆè°ƒç”¨ scanPackageLI æ–¹æ³•ï¼</p><h1 id="äºŒã€æ€»ç»“"><a href="#äºŒã€æ€»ç»“" class="headerlink" title="äºŒã€æ€»ç»“"></a>äºŒã€æ€»ç»“</h1><p>æœ¬æ–‡ä¸»è¦è®²è§£äº† PMS æ˜¯å¦‚ä½•å¤„ç† APK å®‰è£…çš„æµç¨‹ï¼Œä¸»è¦æœ‰å‡ ä¸ªæ­¥éª¤ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;PackageInstaller å®‰è£… APK æ—¶ä¼šå°† APK çš„ä¿¡æ¯äº¤ç”± PMS å¤„ç†ï¼ŒPMS é€šè¿‡å‘ PackageHandler å‘é€æ¶ˆæ¯æ¥é©±åŠ¨ APK çš„å¤åˆ¶å’Œå®‰è£…å·¥ä½œã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;PMS å‘é€ INIT_COPY å’Œ MCS_BOUND ç±»å‹çš„æ¶ˆæ¯ï¼Œæ§åˆ¶ PackageHandler æ¥ç»‘å®š DefaultContainerService ï¼Œå®Œæˆå¤åˆ¶ APK ç­‰å·¥ä½œã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;å¤åˆ¶ APK å®Œæˆåï¼Œä¼šå¼€å§‹è¿›è¡Œå®‰è£… APK çš„æµç¨‹ï¼ŒåŒ…æ‹¬å®‰è£…å‰çš„æ£€æŸ¥ã€å®‰è£… APK å’Œå®‰è£…åçš„æ”¶å°¾å·¥ä½œã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="http://liuwangshu.cn/framework/pms/3-pms-install.html" target="_blank" rel="noopener">AndroidåŒ…ç®¡ç†æœºåˆ¶ï¼ˆä¸‰ï¼‰PMSå¤„ç†APKçš„å®‰è£…</a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/c4333c7eb409" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£12â€”â€”PMSä¸­çš„æ–°å®‰è£…æµç¨‹ä¸Š(æ‹·è´)</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/27/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%887%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88%E4%B8%AD%EF%BC%89/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ7ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆä¸­ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
            <tag> APK å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- APK å®‰è£…ï¼ˆä¸­ï¼‰</title>
      <link href="/2019/02/01/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-7-apk-an-zhuang-zhong/"/>
      <url>/2019/02/01/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-7-apk-an-zhuang-zhong/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† PackageManagerService å®‰è£… APK çš„æµç¨‹ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">PackageInstallerSession.java</font></td><td>/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java</td></tr><tr><td><font color="#D15FEE">PackageManagerService.java</font></td><td>/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td></tr></tbody></table><p><br></p><h2 id="1-2-å‰è¨€"><a href="#1-2-å‰è¨€" class="headerlink" title="1.2 å‰è¨€"></a>1.2 å‰è¨€</h2><p>åœ¨æœ¬ç³»åˆ—ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://superandroid.pro/2018/11/15/B_05.%20Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%885%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88PI%EF%BC%89/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…ï¼ˆä¸Šï¼‰</a> ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº† PackageInstaller å®‰è£… APK çš„æµç¨‹ï¼Œæœ€åä¼šå°† APK çš„ä¿¡æ¯äº¤ç”± PMS å¤„ç†ã€‚é‚£ä¹ˆ PMS æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬è¿™ç¯‡æ–‡ç« éœ€è¦åˆ†æçš„ã€‚<br><br></p><h1 id="äºŒã€PackageManagerService"><a href="#äºŒã€PackageManagerService" class="headerlink" title="äºŒã€PackageManagerService"></a>äºŒã€PackageManagerService</h1><h2 id="2-1-commitLocked"><a href="#2-1-commitLocked" class="headerlink" title="2.1 commitLocked"></a>2.1 commitLocked</h2><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« æœ«å°¾ï¼Œæˆ‘ä»¬ç ”ç©¶è¿‡ <code>commitLocked</code> æ–¹æ³•ï¼Œå›é¡¾ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerSession</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageInstallerSession<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> PackageManagerService mPm<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        mPm<span class="token punctuation">.</span><span class="token function">installStage</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span> stageDir<span class="token punctuation">,</span> stageCid<span class="token punctuation">,</span> localObserver<span class="token punctuation">,</span> params<span class="token punctuation">,</span>                mInstallerPackageName<span class="token punctuation">,</span> mInstallerUid<span class="token punctuation">,</span> user<span class="token punctuation">,</span> mCertificates<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="2-2-installStage"><a href="#2-2-installStage" class="headerlink" title="2.2 installStage"></a>2.2 installStage</h2><p>æ¥ä¸‹æ¥æ­£å¼è¿›å…¥ PMS æºç çš„åˆ†ææµç¨‹ï¼Œçœ‹çœ‹ <code>installStage</code> æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">final</span> PackageHandler mHandler<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">installStage</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">,</span> File stagedDir<span class="token punctuation">,</span> String stagedCid<span class="token punctuation">,</span>            IPackageInstallObserver2 observer<span class="token punctuation">,</span> PackageInstaller<span class="token punctuation">.</span>SessionParams sessionParams<span class="token punctuation">,</span>            String installerPackageName<span class="token punctuation">,</span> <span class="token keyword">int</span> installerUid<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span>            Certificate<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> certificates<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºç±»å‹ä¸º INIT_COPY çš„æ¶ˆæ¯</span>        <span class="token keyword">final</span> Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>INIT_COPY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> installReason <span class="token operator">=</span> <span class="token function">fixUpInstallReason</span><span class="token punctuation">(</span>installerPackageName<span class="token punctuation">,</span> installerUid<span class="token punctuation">,</span>                sessionParams<span class="token punctuation">.</span>installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ›å»º InstallParamsï¼Œå®ƒå¯¹åº”äºåŒ…çš„å®‰è£…æ•°æ®</span>        <span class="token keyword">final</span> InstallParams params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstallParams</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> null<span class="token punctuation">,</span> observer<span class="token punctuation">,</span>                sessionParams<span class="token punctuation">.</span>installFlags<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> sessionParams<span class="token punctuation">.</span>volumeUuid<span class="token punctuation">,</span>                verificationInfo<span class="token punctuation">,</span> user<span class="token punctuation">,</span> sessionParams<span class="token punctuation">.</span>abiOverride<span class="token punctuation">,</span>                sessionParams<span class="token punctuation">.</span>grantedRuntimePermissions<span class="token punctuation">,</span> certificates<span class="token punctuation">,</span> installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>        params<span class="token punctuation">.</span><span class="token function">setTraceMethod</span><span class="token punctuation">(</span><span class="token string">"installStage"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTraceCookie</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> params<span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// å°† InstallParams é€šè¿‡æ¶ˆæ¯å‘é€å‡ºå»</span>        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="2-3-PackageHandler"><a href="#2-3-PackageHandler" class="headerlink" title="2.3 PackageHandler"></a>2.3 PackageHandler</h2><p>å› ä¸º <code>PackageHandler</code> ç»§æ‰¿ <code>Handler</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>PackageHandler</code> çš„ <code>HandlerMessage</code> æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">doHandleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// è®¾ç½®äº†çº¿ç¨‹çš„ä¼˜å…ˆçº§ä¸ºåå°çº¿ç¨‹</span>                Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h3 id="2-3-1-INIT-COPY"><a href="#2-3-1-INIT-COPY" class="headerlink" title="2.3.1 INIT_COPY"></a>2.3.1 INIT_COPY</h3><p>æ¥ä¸‹æ¥çœ‹ä¸‹ INIT_COPY æ¶ˆæ¯çš„å¤„ç†æµç¨‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>            <span class="token keyword">private</span> <span class="token keyword">boolean</span> mBound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>HandlerParams<span class="token operator">></span> mPendingInstalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>HandlerParams<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// ç”¨äºå¤„ç†å„ä¸ªç±»å‹çš„æ¶ˆæ¯</span>        <span class="token keyword">void</span> <span class="token function">doHandleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token keyword">case</span> INIT_COPY<span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å–å‡º InstallParamsï¼Œç»§æ‰¿è‡ª HandlerParamsï¼Œ</span>                    HandlerParams params <span class="token operator">=</span> <span class="token punctuation">(</span>HandlerParams<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// idx ä¸ºå½“å‰éœ€è¦å®‰è£…çš„ APK ä¸ªæ•°ï¼ŒmPendingInstalls é‡Œé¢ä¿å­˜æ‰€æœ‰éœ€è¦</span>                    <span class="token comment" spellcheck="true">// å®‰è£…çš„ APK è§£æå‡ºæ¥çš„ HandlerParams å‚æ•°</span>                    <span class="token keyword">int</span> idx <span class="token operator">=</span> mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// mBound ç”¨äºæ ‡è¯†æ˜¯å¦ç»‘å®šäº†æœåŠ¡ï¼ˆDefaultContainerServiceï¼‰ï¼Œå¦‚æœå·²ç»ç»‘å®šäº†ï¼Œ</span>                    <span class="token comment" spellcheck="true">// åˆ™ mBound ä¸ºtrueï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ mBound ä¸º falseï¼Œé»˜è®¤å€¼ä¸º false</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰ç»‘å®šæœåŠ¡ï¼Œåˆ™è¿›è¡Œç»‘å®šå·¥ä½œï¼ŒconnectToService æ–¹æ³•å†…éƒ¨è¿›è¡Œç»‘å®šï¼Œ</span>                        <span class="token comment" spellcheck="true">// å¦‚æœç»‘å®šæˆåŠŸä¼šå°† mBound ç½®ä¸º true</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">connectToService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// é”™è¯¯è¾“å‡º</span>                            <span class="token comment" spellcheck="true">// ç»‘å®šæœåŠ¡å¤±è´¥åˆ™ return</span>                            <span class="token keyword">return</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// ç»‘å®šæœåŠ¡æˆåŠŸï¼Œå°†è¯·æ±‚æ·»åŠ åˆ° ArrayList ç±»å‹çš„ mPendingInstalls ä¸­ï¼Œ</span>                            <span class="token comment" spellcheck="true">// ç­‰å¾…å¤„ç†</span>                            mPendingInstalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// å·²ç»ç»‘å®šæœåŠ¡</span>                        mPendingInstalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå®‰è£…è¯·æ±‚ï¼Œåˆ™ç›´æ¥å‘é€äº‹ä»¶ MCS_BOUND è§¦å‘å¤„ç†æµç¨‹</span>                            mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h3 id="2-3-2-connectToService"><a href="#2-3-2-connectToService" class="headerlink" title="2.3.2 connectToService"></a>2.3.2 connectToService</h3><p>å‡è®¾æˆ‘ä»¬æ˜¯ç¬¬ä¸€æ¬¡èµ°æµç¨‹ï¼Œè¿˜æ²¡æœ‰ç»‘å®šæœåŠ¡ï¼Œåˆ™ä¼šè°ƒç”¨ <code>connectToService()</code> æ–¹æ³•ï¼Œçœ‹ä¸‹æµç¨‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">connectToService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Intent service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>DEFAULT_CONTAINER_COMPONENT<span class="token punctuation">)</span><span class="token punctuation">;</span>            Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/**             * bindServiceAsUser æ–¹æ³•ä¼šä¼ å…¥ mDefContainerConnï¼Œ             * bindServiceAsUser æ–¹æ³•çš„å¤„ç†é€»è¾‘å’Œæˆ‘ä»¬è°ƒç”¨ bindService æ˜¯ç±»ä¼¼çš„ï¼Œ             * æœåŠ¡å»ºç«‹è¿æ¥åï¼Œä¼šè°ƒç”¨ onServiceConnected             */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">bindServiceAsUser</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> mDefContainerConn<span class="token punctuation">,</span>                    Context<span class="token punctuation">.</span>BIND_AUTO_CREATE<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å¦‚æœç»‘å®š DefaultContainerService æˆåŠŸï¼ŒmBound ä¼šç½®ä¸º ture</span>                mBound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            Process<span class="token punctuation">.</span><span class="token function">setThreadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ° <code>bind</code> äº†ä¸€ä¸ª <code>service</code> ï¼Œè¿™ä¸ª <code>service</code> çš„ <code>ComponentName</code> æ˜¯ <code>&quot;DEFAULT_CONTAINER_COMPONENT&quot;</code> è¿™ä¸ªå¸¸é‡ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¿™ä¸ª <code>ComponentName</code> æ˜¯ä»€ä¹ˆï¼Ÿ</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> ComponentName DEFAULT_CONTAINER_COMPONENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>        DEFAULT_CONTAINER_PACKAGE<span class="token punctuation">,</span>        <span class="token string">"com.android.defcontainer.DefaultContainerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ bind çš„ service æ˜¯ <code>DefaultContainerService</code> ã€‚ç»‘å®š <code>DefaultContainerService</code> ä¹‹åï¼Œè®¾å®šè¿›ç¨‹çš„ä¼˜å…ˆçº§ä¸º <code>THREAD_PRIORITY_DEFAULT</code>ã€‚</p><p>ç„¶åç­‰ <code>bindServiceAsUser</code> è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œåˆ™åˆæŠŠçº¿ç¨‹çš„ä¼˜å…ˆçº§è®¾ä¸º <code>THREAD_PRIORITY_BACKGROUND</code>ã€‚</p><p>è¿™è¾¹è¦é‡ç‚¹æåˆ°ä¸€ä¸ª<font color="#0000CD"> <strong>mDefContainerConn</strong></font> å˜é‡ï¼Œç ”ç©¶ä¸€ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">private</span> DefaultContainerConnection mDefContainerConn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultContainerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>mDefContainerConn</code> çš„ç±»å‹æ˜¯ <code>DefaultContainerConnection</code> ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>DefaultContainerConnection</code> è¿™ä¸ªç±»ã€‚<br><br></p><h3 id="2-3-3-DefaultContainerConnection"><a href="#2-3-3-DefaultContainerConnection" class="headerlink" title="2.3.3 DefaultContainerConnection"></a>2.3.3 DefaultContainerConnection</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// DefaultContainerConnection å®ç°äº† ServiceConnectionï¼Œ</span>    <span class="token comment" spellcheck="true">// æ‰€ä»¥åœ¨è¿æ¥æˆåŠŸçš„æ—¶å€™ä¼šè°ƒç”¨ onServiceConnected æ–¹æ³•</span>    <span class="token keyword">class</span> <span class="token class-name">DefaultContainerConnection</span> <span class="token keyword">implements</span> <span class="token class-name">ServiceConnection</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SD_INSTALL<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onServiceConnected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> IMediaContainerService imcs <span class="token operator">=</span> IMediaContainerService<span class="token punctuation">.</span>Stub                    <span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>Binder<span class="token punctuation">.</span><span class="token function">allowBlocking</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å‘é€äº† MCS_BOUND ç±»å‹çš„æ¶ˆæ¯</span>            mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">,</span> imcs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_SD_INSTALL<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onServiceDisconnected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>ä¸Šæ–‡æåŠåˆ° <code>mContext.bindServiceAsUser</code>() æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯<code>&quot;ç»‘å®š&quot;</code> <code>DefaultContainerService</code>ã€‚æˆ‘ä»¬çŸ¥é“ bind ä¸€ä¸ª Service ï¼Œå…¶ä¸­è´Ÿè´£é€šä¿¡çš„æ˜¯ <code>ServiceConnection</code>ï¼Œæ‰€ä»¥ï¼Œæœ¬æ–¹æ³•ä¸­è´Ÿè´£é€šä¿¡çš„å°±æ˜¯ <code>mDefContainerConn</code>ã€‚</p><p>ä¸€æ—¦ç»‘å®šæˆåŠŸä¼šæ‰§è¡Œ <code>mDefContainerConn</code> çš„ <code>onServiceConnected</code> æ–¹æ³•ã€‚</p><p>ä»æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼šå½“ç»‘å®šæˆåŠŸååœ¨ <code>onServiceConnected</code> ä¸­å°†ä¸€ä¸ª <code>IBinder</code> è½¬æ¢æˆäº†ä¸€ä¸ª <code>IMediaContainerService</code>ã€‚</p><p>è¿™ä¸ªå°±æ˜¯ <code>onServiceConnected</code> å›è°ƒå‡½æ•°ä¸­æ ¹æ®å‚æ•°ä¼ è¿›æ¥çš„ <code>IMediaContainerService.Stub</code> çš„å¯¹è±¡å¼•ç”¨åˆ›å»ºçš„ä¸€ä¸ª<code>è¿œç¨‹ä»£ç†å¯¹è±¡</code>ï¼Œåé¢ <code>PacakgeManagerService</code> å°†é€šè¿‡è¯¥ä»£ç†å¯¹è±¡è®¿é—® <code>DefaultContainerService</code> æœåŠ¡ã€‚<br><br></p><h3 id="2-3-4-å°ç»“"><a href="#2-3-4-å°ç»“" class="headerlink" title="2.3.4 å°ç»“"></a>2.3.4 å°ç»“</h3><p><strong>æˆ‘ä»¬ç®€å•æ¢³ç†ä¸€ä¸‹ä»¥ä¸Šä»£ç æ‰€åšçš„å·¥ä½œï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;ï¼ˆ1ï¼‰<code>mBound</code> ç”¨äºæ ‡è¯†æ˜¯å¦ç»‘å®šäº† <code>DefaultContainerService</code>ï¼Œé»˜è®¤å€¼ä¸º <code>false</code>ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;ï¼ˆ2ï¼‰<code>DefaultContainerService</code> æ˜¯ç”¨äºæ£€æŸ¥å’Œå¤åˆ¶å¯ç§»åŠ¨æ–‡ä»¶çš„æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œå› æ­¤ <code>DefaultContainerService</code> æ²¡æœ‰å’Œ <code>PackageManagerService</code> è¿è¡Œåœ¨åŒä¸€è¿›ç¨‹ä¸­ï¼Œå®ƒè¿è¡Œåœ¨ <code>com.android.defcontainer</code> è¿›ç¨‹ï¼Œé€šè¿‡ <code>IMediaContainerService</code> å’Œ <code>PackageManagerService</code> è¿›è¡Œ <code>IPC</code> é€šä¿¡ã€‚</p><p>å½¼æ­¤ä¹‹é—´çš„ IPC é€šä¿¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><br></p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-fc2af2fd9ed961c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/680" alt="IPC é€šä¿¡åŸç†å›¾.png"></center><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;ï¼ˆ3ï¼‰<code>connectToService</code> æ–¹æ³•ç”¨æ¥ç»‘å®š <code>DefaultContainerService</code>ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;ï¼ˆ4ï¼‰<code>mHandler.sendEmptyMessage(MCS_BOUND)</code>ï¼šå‘é€ <code>MCS_BOUND</code> ç±»å‹çš„æ¶ˆæ¯ï¼Œè§¦å‘å¤„ç†<code>ç¬¬ä¸€ä¸ªå®‰è£…è¯·æ±‚</code>ã€‚</p><p>ä¸çŸ¥é“ä½ æ˜¯å¦å‘ç°ï¼Œåœ¨æˆ‘ä»¬ä¸Šé¢ç ”ç©¶çš„æºç ä¸­ï¼Œæœ‰ä¸¤å¤„å‘é€äº† <code>MCS_BOUND</code> ç±»å‹æ¶ˆæ¯çš„æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// PackageHandler.doHandleMessageï¼ˆå·²ç»‘å®šæœåŠ¡ï¼‰</span>mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment" spellcheck="true">// ä¸å¸¦å‚æ•°</span><span class="token comment" spellcheck="true">// DefaultContainerConnectionï¼ˆæœªç»‘å®šæœåŠ¡ - ç»‘å®šæœåŠ¡ï¼‰</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">,</span> imcs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// å¸¦å‚æ•°</span></code></pre><p><br></p><h2 id="2-4-MCS-BOUND-åˆ†æ"><a href="#2-4-MCS-BOUND-åˆ†æ" class="headerlink" title="2.4 MCS_BOUND åˆ†æ"></a>2.4 MCS_BOUND åˆ†æ</h2><p><strong>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡ç‚¹è®¨è®ºè¿™ä¸¤ä¸ªæ–¹æ³•ï¼</strong><br><br></p><h3 id="2-4-1-ä¸å¸¦å‚æ•°"><a href="#2-4-1-ä¸å¸¦å‚æ•°" class="headerlink" title="2.4.1 ä¸å¸¦å‚æ•°"></a>2.4.1 ä¸å¸¦å‚æ•°</h3><p>é¦–å…ˆç ”ç©¶ä¸å¸¦å‚æ•°çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">void</span> <span class="token function">doHandleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">case</span> MCS_BOUND<span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"mcs_bound"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// ä¸å¸¦å‚æ•°ï¼Œåˆ™æ­¤æ¡ä»¶ä¸æ»¡è¶³</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>obj <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mContainerService <span class="token operator">=</span> <span class="token punctuation">(</span>IMediaContainerService<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>                    Trace<span class="token punctuation">.</span><span class="token function">asyncTraceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"bindingMCS"</span><span class="token punctuation">,</span>                            System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// èµ°è¿™è¾¹çš„é€»è¾‘</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mContainerService <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// æœåŠ¡æ²¡æœ‰ç»‘å®šï¼Œåˆ™èµ°è¿™è¾¹ï¼Œä½†æ˜¯ä¹‹å‰æˆ‘ä»¬è®²è§£è¿‡ï¼Œå‘é€ä¸å¸¦å‚æ•°çš„ MCS_BOUND æ—¶ï¼Œ</span>                    <span class="token comment" spellcheck="true">// å·²ç»ç»‘å®šäº†æœåŠ¡ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸æ­£å¸¸çš„</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>HandlerParams params <span class="token operator">:</span> mPendingInstalls<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// è´Ÿè´£å¤„ç†æœåŠ¡å‘ç”Ÿé”™è¯¯çš„æƒ…å†µ</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// ç»‘å®šå¤±è´¥ï¼Œæ¸…ç©ºå®‰è£…è¯·æ±‚é˜Ÿåˆ—</span>                        mPendingInstalls<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// ç»§ç»­ç­‰å¾…ç»‘å®šæœåŠ¡</span>                        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Waiting to connect to media container service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// Should never happen ideally.</span>                   Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Empty queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h3 id="2-4-2-å¸¦å‚æ•°"><a href="#2-4-2-å¸¦å‚æ•°" class="headerlink" title="2.4.2 å¸¦å‚æ•°"></a>2.4.2 å¸¦å‚æ•°</h3><p>æ¥ä¸‹æ¥ç ”ç©¶ä¸å¸¦å‚æ•°çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">void</span> <span class="token function">doHandleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">case</span> MCS_BOUND<span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"mcs_bound"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>obj <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mContainerService <span class="token operator">=</span> <span class="token punctuation">(</span>IMediaContainerService<span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>                    Trace<span class="token punctuation">.</span><span class="token function">asyncTraceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"bindingMCS"</span><span class="token punctuation">,</span>                            System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// å¸¦å‚æ•°ï¼Œæ­¤æ¡ä»¶ä¸æ»¡è¶³</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mContainerService <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token comment" spellcheck="true">// èµ°è¿™è¾¹çš„é€»è¾‘ï¼Œå®‰è£…è¯·æ±‚é˜Ÿåˆ—ä¸ä¸ºç©º</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                         <span class="token comment" spellcheck="true">// å¾—åˆ°å®‰è£…è¯·æ±‚é˜Ÿåˆ—ç¬¬ä¸€ä¸ªè¯·æ±‚ HandlerParams</span>                    HandlerParams params <span class="token operator">=</span> mPendingInstalls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// å¦‚æœ HandlerParams ä¸ä¸º null å°±ä¼šè°ƒç”¨ HandlerParams çš„ </span>                        <span class="token comment" spellcheck="true">// startCopy æ–¹æ³•ï¼Œç”¨äºå¼€å§‹å¤åˆ¶ APK çš„æµç¨‹</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">startCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// å¦‚æœ APK å®‰è£…æˆåŠŸï¼Œåˆ é™¤æœ¬æ¬¡å®‰è£…è¯·æ±‚</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                mPendingInstalls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰å®‰è£…è¯·æ±‚äº†ï¼Œå‘é€è§£ç»‘æœåŠ¡çš„è¯·æ±‚</span>                                    <span class="token function">removeMessages</span><span class="token punctuation">(</span>MCS_UNBIND<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    Message ubmsg <span class="token operator">=</span> <span class="token function">obtainMessage</span><span class="token punctuation">(</span>MCS_UNBIND<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>ubmsg<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// å¦‚æœè¿˜æœ‰å…¶ä»–çš„å®‰è£…è¯·æ±‚ï¼Œæ¥ç€å‘é€ MCS_BOUND æ¶ˆæ¯</span>                                <span class="token comment" spellcheck="true">// ç»§ç»­å¤„ç†å‰©ä½™çš„å®‰è£…è¯·æ±‚</span>                                mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_BOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// å¦‚æœå®‰è£…è¯·æ±‚æ•°ä¸å¤§äº 0 å°±ä¼šæ‰“å° â€œEmpty queueâ€</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Should never happen ideally.</span>                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Empty queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢çš„æµç¨‹å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬æ ¹æ®æ˜¯å¦ä¼ å…¥äº† <code>ims</code> è¿™ä¸ªå‚æ•°ï¼Œèµ°ä¸¤æ¡æµç¨‹ï¼Œæ ¸å¿ƒçš„æ–¹æ³•å°±æ˜¯æœ€ç»ˆçš„ <code>startCopy()</code>ã€‚<br><br></p><h1 id="ä¸‰ã€å¤åˆ¶-APK"><a href="#ä¸‰ã€å¤åˆ¶-APK" class="headerlink" title="ä¸‰ã€å¤åˆ¶ APK"></a>ä¸‰ã€å¤åˆ¶ APK</h1><p>ä¸Šé¢æˆ‘ä»¬æè¿‡ï¼Œå¤åˆ¶ <code>APK</code> çš„æ“ä½œæ˜¯è°ƒç”¨ <code>HandlerParams</code> çš„ <code>startCopy</code> æ–¹æ³•ã€‚<code>HandlerParams</code> æ˜¯ PMS ä¸­çš„<code>æŠ½è±¡ç±»</code>ï¼Œå®ƒçš„å®ç°ç±»ä¸º <code>PMS</code> çš„å†…éƒ¨ç±» <code>InstallParams</code>ã€‚<br><br></p><h2 id="3-1-startCopy"><a href="#3-1-startCopy" class="headerlink" title="3.1 startCopy"></a>3.1 startCopy</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">HandlerParams</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_RETRIES <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * Number of times startCopy() has been attempted and had a non-fatal         * error.         */</span>        <span class="token keyword">private</span> <span class="token keyword">int</span> mRetries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">startCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">boolean</span> res<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">/**                 * mRetries ç”¨äºè®°å½• startCopy æ–¹æ³•è°ƒç”¨çš„æ¬¡æ•°ï¼Œè°ƒç”¨ startCopy æ–¹æ³•æ—¶ä¼šå…ˆè‡ªåŠ¨åŠ  1                 * startCopy æ–¹æ³•å°è¯•çš„æ¬¡æ•°è¶…è¿‡äº† 4 æ¬¡ï¼Œå°±æ”¾å¼ƒè¿™ä¸ªå®‰è£…è¯·æ±‚                 */</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>mRetries <span class="token operator">></span> MAX_RETRIES<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å‘é€ MCS_GIVE_UP ç±»å‹æ¶ˆæ¯ï¼Œå°†ç¬¬ä¸€ä¸ªå®‰è£…è¯·æ±‚ï¼ˆæœ¬æ¬¡å®‰è£…è¯·æ±‚ï¼‰ä»å®‰è£…è¯·æ±‚é˜Ÿåˆ—</span>                    <span class="token comment" spellcheck="true">// mPendingInstalls ä¸­ç§»é™¤æ‰</span>                    mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_GIVE_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Message 1</span>                    <span class="token function">handleServiceError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token function">handleStartCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>                    res <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Posting install MCS_RECONNECT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>MCS_RECONNECT<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// Message 2</span>                res <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// è°ƒç”¨ handleReturnCode æŠ½è±¡æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ handleStartCopy æ‰§è¡Œå®Œæ‹·è´ç›¸å…³è¡Œä¸ºä¹‹åï¼Œ</span>            <span class="token comment" spellcheck="true">// æ ¹æ® handleStartCopy åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œä¸»è¦è¿”å›çŠ¶æ€ç </span>            <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleStartCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException<span class="token punctuation">;</span>        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleServiceError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬åœ¨åˆ†æ <code>handleStartCopy()</code> ä¹‹å‰ï¼Œç®€å•çš„çœ‹ä¸€ä¸‹ <code>MCS_GIVE_UP</code> å’Œ <code>MCS_RECONNECT</code> ä¸¤ç§ message çš„å¤„ç†æµç¨‹ï¼Œé€»è¾‘ç›¸å½“ç®€å•ï¼</p><blockquote><p><strong>MCS_RECONNECT</strong></p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">void</span> <span class="token function">doHandleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">case</span> MCS_RECONNECT<span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"mcs_reconnect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingInstalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">disconnectService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">connectToService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to bind to media container service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>HandlerParams params <span class="token operator">:</span> mPendingInstalls<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// Indicate service bind error</span>                            params<span class="token punctuation">.</span><span class="token function">serviceError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            Trace<span class="token punctuation">.</span><span class="token function">asyncTraceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"queueInstall"</span><span class="token punctuation">,</span>                                    System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        mPendingInstalls<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>åˆ¤æ–­å®‰è£…è¯·æ±‚é˜Ÿåˆ— <code>mPendingInstalls</code> æ˜¯å¦è¿˜æœ‰å…ƒç´ ï¼Œå¦‚æœæœ‰å…ƒç´ å…ˆæ–­å¼€ç»‘å®šï¼Œåˆ™å†æ¬¡é‡æ–°è°ƒç”¨ <code>connectToService</code> æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“ connectToService() å†…éƒ¨ä¼šå†æ¬¡æ‰§è¡Œç»‘å®š <code>DefaultContainerService</code>ï¼Œè€Œåœ¨ç»‘å®šæˆåŠŸåä¼šå†æ¬¡å‘é€ä¸€ä¸ª <code>what</code> å€¼ä¸º <code>MCS_BOUND</code> çš„ <code>Message</code>ï¼Œä»è€Œåˆå›åˆ°äº† <code>startCopy</code> é‡Œé¢ã€‚</p><blockquote><p>3.1.2 <strong>MCS_GIVE_UP</strong></p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">void</span> <span class="token function">doHandleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">case</span> MCS_GIVE_UP<span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"mcs_giveup too many retries"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                HandlerParams params <span class="token operator">=</span> mPendingInstalls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Trace<span class="token punctuation">.</span><span class="token function">asyncTraceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"queueInstall"</span><span class="token punctuation">,</span>                        System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ç›´æ¥åˆ é™¤äº†å®‰è£…è¯·æ±‚é˜Ÿåˆ— <code>mPendingInstalls</code> é‡Œé¢ä¸‹æ ‡ä¸º 0 çš„å…ƒç´ ï¼Œå³å–æ¶ˆæœ¬æ¬¡å®‰è£…è¯·æ±‚ã€‚<br><br></p><h2 id="3-2-handleStartCopy"><a href="#3-2-handleStartCopy" class="headerlink" title="3.2 handleStartCopy"></a>3.2 handleStartCopy</h2><p>æˆ‘ä»¬å‘ç° <code>handleStartCopy</code> ä¹Ÿæ˜¯ä¸€ä¸ª<code>æŠ½è±¡æ–¹æ³•</code>ï¼Œé‚£ä¹ˆå®ƒåœ¨å“ªå®ç°ï¼Ÿå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼š<code>HandlerParams</code> æ˜¯ <code>PMS</code> ä¸­çš„<code>æŠ½è±¡ç±»</code>ï¼Œå®ƒçš„å®ç°ç±»ä¸º <code>PMS</code> çš„å†…éƒ¨ç±» <code>InstallParams</code>ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">class</span> <span class="token class-name">InstallParams</span> <span class="token keyword">extends</span> <span class="token class-name">HandlerParams</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStartCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">/**             * ç¡®å®š APK çš„å®‰è£…ä½ç½®             *     onSdï¼š     å®‰è£…åˆ° SD å¡             *     onIntï¼š    å†…éƒ¨å­˜å‚¨å³ Data åˆ†åŒº             *     ephemeralï¼šå®‰è£…åˆ°ä¸´æ—¶å­˜å‚¨             */</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span> onSd <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_EXTERNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span> onInt <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INTERNAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span> ephemeral <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>            PackageInfoLite pkgLite <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// APK ä¸èƒ½åŒæ—¶å®‰è£…åœ¨ SD å¡å’Œ Data åˆ†åŒº</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>onInt <span class="token operator">&amp;&amp;</span> onSd<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Check if both bits are set.</span>                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Conflicting flags specified for installing ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_INSTALL_LOCATION<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å®‰è£…æ ‡å¿—å†²çªï¼ŒInstant Apps ä¸èƒ½å®‰è£…åˆ° SD å¡ä¸­</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onSd <span class="token operator">&amp;&amp;</span> ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>  <span class="token string">"Conflicting flags specified for installing ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_INSTALL_LOCATION<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">/**                 * è·å– APK çš„å°‘é‡çš„ä¿¡æ¯                 * é€šè¿‡ IMediaContainerService è·¨è¿›ç¨‹è°ƒç”¨ DefaultContainerService çš„                 * getMinimalPackageInfo æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è½»é‡è§£æ APK å¹¶å¾—åˆ° APK çš„å°‘é‡ä¿¡æ¯ï¼Œ                 * è½»é‡è§£æçš„åŸå› æ˜¯è¿™é‡Œä¸éœ€è¦å¾—åˆ° APK çš„å…¨éƒ¨ä¿¡æ¯ï¼ŒAPK çš„å°‘é‡ä¿¡æ¯ä¼šå°è£…åˆ°                 * PackageInfoLite ä¸­ã€‚                 */</span>                pkgLite <span class="token operator">=</span> mContainerService<span class="token punctuation">.</span><span class="token function">getMinimalPackageInfo</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>resolvedPath<span class="token punctuation">,</span>                                                         installFlags<span class="token punctuation">,</span> packageAbiOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_EPHEMERAL <span class="token operator">&amp;&amp;</span> ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Slog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"pkgLite for install: "</span> <span class="token operator">+</span> pkgLite<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// åˆ¤æ–­å®‰è£…çš„ä½ç½®</span>                <span class="token keyword">int</span> loc <span class="token operator">=</span> pkgLite<span class="token punctuation">.</span>recommendedInstallLocation<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>loc <span class="token operator">==</span> PackageHelper<span class="token punctuation">.</span>RECOMMEND_FAILED_INVALID_LOCATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_INSTALL_LOCATION<span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loc <span class="token operator">==</span> PackageHelper<span class="token punctuation">.</span>RECOMMEND_FAILED_ALREADY_EXISTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    installFlags <span class="token operator">=</span> sPmsExt<span class="token punctuation">.</span><span class="token function">customizeInstallPkgFlags</span><span class="token punctuation">(</span>installFlags<span class="token punctuation">,</span> pkgLite<span class="token punctuation">,</span>                            mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">,</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    loc <span class="token operator">=</span> <span class="token function">installLocationPolicy</span><span class="token punctuation">(</span>pkgLite<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">/**             * æ ¹æ® InstallParams åˆ›å»º InstallArgs å¯¹è±¡             * InstallArgs æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®šä¹‰äº† APK çš„å®‰è£…é€»è¾‘ï¼Œæ¯”å¦‚"å¤åˆ¶"å’Œ"é‡å‘½å" APK ç­‰             * InstallArgs æœ‰ 3 ä¸ªå­ç±»ï¼Œéƒ½è¢«å®šä¹‰åœ¨ PMS ä¸­ï¼š             *     FileInstallArgsï¼šç”¨äºå¤„ç†å®‰è£…åˆ°é ASEC çš„å­˜å‚¨ç©ºé—´çš„ APK ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨å­˜å‚¨ç©ºé—´             *     AsecInstallArgsï¼šç”¨äºå¤„ç†å®‰è£…åˆ° ASEC ä¸­ï¼ˆmnt/asecï¼‰å³ SD å¡ä¸­çš„ APK             *     MoveInstallArgsï¼šç”¨äºå¤„ç†å·²å®‰è£… APK ç§»åŠ¨çš„é€»è¾‘             */</span>            <span class="token keyword">final</span> InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>origin<span class="token punctuation">.</span>existing <span class="token operator">&amp;&amp;</span> requiredUid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span>                        <span class="token operator">&amp;&amp;</span> <span class="token function">isVerificationEnabled</span><span class="token punctuation">(</span>                                verifierUser<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> installFlags<span class="token punctuation">,</span> installerUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å¯¹ APK è¿›è¡Œæ£€æŸ¥åå°±ä¼šè°ƒç”¨ InstallArgs çš„ copyApk æ–¹æ³•è¿›è¡Œå®‰è£…</span>                    ret <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">copyApk</span><span class="token punctuation">(</span>mContainerService<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            mRet <span class="token operator">=</span> ret<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="3-3-FileInstallArgs"><a href="#3-3-FileInstallArgs" class="headerlink" title="3.3 FileInstallArgs"></a>3.3 FileInstallArgs</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“ <code>InstallParams</code> æœ‰ä¸‰ä¸ªå­ç±»ï¼Œä¸åŒçš„ <code>InstallArgs</code> å­ç±»ä¼šæœ‰ç€ä¸åŒçš„å¤„ç†ï¼Œé‚£æˆ‘ä»¬ç°åœ¨ä»¥ <code>FileInstallArgs</code> ä¸ºä¾‹è·Ÿè¸ªç ”ç©¶å…·ä½“çš„æµç¨‹ï¼š<br><br></p><h3 id="3-3-1-copyApk"><a href="#3-3-1-copyApk" class="headerlink" title="3.3.1 copyApk"></a>3.3.1 copyApk</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">class</span> <span class="token class-name">FileInstallArgs</span> <span class="token keyword">extends</span> <span class="token class-name">InstallArgs</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> File codeFile<span class="token punctuation">;</span>        <span class="token keyword">private</span> File resourceFile<span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">int</span> <span class="token function">copyApk</span><span class="token punctuation">(</span>IMediaContainerService imcs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> temp<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"copyApk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">doCopyApk</span><span class="token punctuation">(</span>imcs<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è°ƒè½¬ doCopyApk æ–¹æ³•</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h3 id="3-3-2-doCopyApk"><a href="#3-3-2-doCopyApk" class="headerlink" title="3.3.2 doCopyApk"></a>3.3.2 doCopyApk</h3><p>è°ƒç”¨äº† <code>doCopyApk</code> æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">FileInstallArgs</span> <span class="token keyword">extends</span> <span class="token class-name">InstallArgs</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> File codeFile<span class="token punctuation">;</span>    <span class="token keyword">private</span> File resourceFile<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doCopyApk</span><span class="token punctuation">(</span>IMediaContainerService imcs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> temp<span class="token punctuation">)</span>                                                                <span class="token keyword">throws</span> RemoteException <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isEphemeral <span class="token operator">=</span> <span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ç”¨äºåˆ›å»ºä¸´æ—¶å­˜å‚¨ç›®å½•ï¼Œæ¯”å¦‚ /data/app/vmdl18300388.tmpï¼Œ</span>            <span class="token comment" spellcheck="true">// å…¶ä¸­ 18300388 æ˜¯å®‰è£…çš„ sessionId</span>            <span class="token keyword">final</span> File tempDir <span class="token operator">=</span>                    mInstallerService<span class="token punctuation">.</span><span class="token function">allocateStageDirLegacy</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">,</span> isEphemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>            codeFile <span class="token operator">=</span> tempDir<span class="token punctuation">;</span>            resourceFile <span class="token operator">=</span> tempDir<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to create copy file: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INSUFFICIENT_STORAGE<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * é€šè¿‡ IMediaContainerService è·¨è¿›ç¨‹è°ƒç”¨ DefaultContainerService çš„ copyPackage æ–¹æ³•ï¼Œ         * è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ DefaultContainerService æ‰€åœ¨çš„è¿›ç¨‹ä¸­å°† APK å¤åˆ¶åˆ°ä¸´æ—¶å­˜å‚¨ç›®å½•ï¼Œ         * æ¯”å¦‚ /data/app/vmdl18300388.tmp/base.apk ã€‚         */</span>        ret <span class="token operator">=</span> imcs<span class="token punctuation">.</span><span class="token function">copyPackage</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// çœŸæ­£çš„æ–‡ä»¶æ‹·è´</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h1 id="å››ã€å®‰è£…-APK"><a href="#å››ã€å®‰è£…-APK" class="headerlink" title="å››ã€å®‰è£… APK"></a>å››ã€å®‰è£… APK</h1><h2 id="4-1-handleReturnCode"><a href="#4-1-handleReturnCode" class="headerlink" title="4.1 handleReturnCode"></a>4.1 handleReturnCode</h2><p>æˆ‘ä»¬å›åˆ° APK çš„å¤åˆ¶è°ƒç”¨é“¾çš„å¤´éƒ¨æ–¹æ³•ï¼šHandlerParams çš„ startCopy æ–¹æ³•ï¼Œåœ¨æœ€å è°ƒç”¨äº† handleReturnCode æ–¹æ³•ï¼Œè¿›è¡Œ APK çš„å®‰è£…ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">HandlerParams</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_RETRIES <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">int</span> mRetries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">startCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">boolean</span> res<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>mRetries <span class="token operator">></span> MAX_RETRIES<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token function">handleStartCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           res <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// å¤„ç†å¤åˆ¶ APK åçš„å®‰è£… APK é€»è¾‘</span>            <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>handleReturnCode ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å“ªé‡Œå®ç°ï¼ŸåŒæ ·ï¼Œå®ƒçš„å®ç°åœ¨ InstallParams ä¸­ã€‚</p><pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">void</span> <span class="token function">handleReturnCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// If mArgs is null, then MCS couldn't be reached. When it</span>            <span class="token comment" spellcheck="true">// reconnects, it will try again to install. At that point, this</span>            <span class="token comment" spellcheck="true">// will succeed.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mArgs <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// "è£…è½½ä»£ç "çš„å…¥å£æ˜¯ processPendingInstall(InstallArgs,int) æ–¹æ³•</span>                <span class="token function">processPendingInstall</span><span class="token punctuation">(</span>mArgs<span class="token punctuation">,</span> mRet<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å‘ç°è°ƒç”¨äº† processPendingInstall æ–¹æ³•ï¼Œç»§ç»­è·Ÿï¼</p><h2 id="4-2-processPendingInstall"><a href="#4-2-processPendingInstall" class="headerlink" title="4.2 processPendingInstall"></a>4.2 processPendingInstall</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processPendingInstall</span><span class="token punctuation">(</span><span class="token keyword">final</span> InstallArgs args<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                PackageInstalledInfo res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstalledInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span><span class="token function">setReturnCode</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span>uid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                res<span class="token punctuation">.</span>pkg <span class="token operator">=</span> null<span class="token punctuation">;</span>                res<span class="token punctuation">.</span>removedInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>                     <span class="token operator">*</span> å®‰è£…å‰å¤„ç†                     <span class="token operator">*</span> ç”¨äºæ£€æŸ¥ APK çš„çŠ¶æ€çš„ï¼Œåœ¨å®‰è£…å‰ç¡®ä¿å®‰è£…ç¯å¢ƒçš„å¯é ï¼Œå¦‚æœä¸å¯é ä¼šæ¸…é™¤å¤åˆ¶çš„ APK æ–‡ä»¶                    args<span class="token punctuation">.</span><span class="token function">doPreInstall</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">installPackageTracedLI</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>                    <span class="token punctuation">}</span>                    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>                     <span class="token operator">*</span> å®‰è£…åæ”¶å°¾                     <span class="token operator">*</span> ç”¨äºå¤„ç†å®‰è£…åçš„æ”¶å°¾æ“ä½œï¼Œå¦‚æœå®‰è£…ä¸æˆåŠŸï¼Œåˆ é™¤æ‰å®‰è£…ç›¸å…³çš„ç›®å½•ä¸æ–‡ä»¶                    args<span class="token punctuation">.</span><span class="token function">doPostInstall</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">,</span> res<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-3-installPackageTracedLI"><a href="#4-3-installPackageTracedLI" class="headerlink" title="4.3 installPackageTracedLI"></a>4.3 installPackageTracedLI</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackageTracedLI</span><span class="token punctuation">(</span>InstallArgs args<span class="token punctuation">,</span> PackageInstalledInfo res<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"installPackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">installPackageLI</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-4-installPackageLI"><a href="#4-4-installPackageLI" class="headerlink" title="4.4 installPackageLI"></a>4.4 installPackageLI</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installPackageLI</span><span class="token punctuation">(</span>InstallArgs args<span class="token punctuation">,</span> PackageInstalledInfo res<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"parsePackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è§£æ APK</span>            pkg <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>tmpPackageFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token string">"Failed parse during installPackageLI"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// Get rid of all references to package scan path via parser.</span>        pp <span class="token operator">=</span> null<span class="token punctuation">;</span>        String oldCodePath <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">boolean</span> systemApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ£€æŸ¥ APK æ˜¯å¦å­˜åœ¨</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>installFlags <span class="token operator">&amp;</span> PackageManager<span class="token punctuation">.</span>INSTALL_REPLACE_EXISTING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// è·å–æ²¡è¢«æ”¹åå‰çš„åŒ…å</span>                String oldName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mOriginalPackages <span class="token operator">!=</span> null                        <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>mOriginalPackages<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>oldName<span class="token punctuation">)</span>                        <span class="token operator">&amp;&amp;</span> mPackages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>oldName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    pkg<span class="token punctuation">.</span><span class="token function">setPackageName</span><span class="token punctuation">(</span>oldName<span class="token punctuation">)</span><span class="token punctuation">;</span>                    pkgName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è®¾ç½®æ ‡å¿—ä½è¡¨ç¤ºæ˜¯æ›¿æ¢å®‰è£…</span>                    replace <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Replacing existing renamed package: oldName="</span>                            <span class="token operator">+</span> oldName <span class="token operator">+</span> <span class="token string">" pkgName="</span> <span class="token operator">+</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æŸ¥çœ‹ Settings ä¸­æ˜¯å¦å­˜æœ‰è¦å®‰è£…çš„ APK çš„ä¿¡æ¯ï¼Œå¦‚æœæœ‰å°±è·å–ç­¾åä¿¡æ¯</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Existing package: "</span> <span class="token operator">+</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>                PackageSetting signatureCheckPs <span class="token operator">=</span> ps<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    SharedLibraryEntry libraryEntry <span class="token operator">=</span> <span class="token function">getLatestSharedLibraVersionLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>libraryEntry <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        signatureCheckPs <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>libraryEntry<span class="token punctuation">.</span>apk<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// æ£€æŸ¥ç­¾åçš„æ­£ç¡®æ€§</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldCheckUpgradeKeySetLP</span><span class="token punctuation">(</span>signatureCheckPs<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkUpgradeKeySetLP</span><span class="token punctuation">(</span>signatureCheckPs<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_UPDATE_INCOMPATIBLE<span class="token punctuation">,</span> <span class="token string">"Package "</span>                                <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName <span class="token operator">+</span> <span class="token string">" upgrade keys do not match the "</span>                                <span class="token operator">+</span> <span class="token string">"previously installed version"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            <span class="token keyword">int</span> N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// éå†æ¯ä¸ªæƒé™ï¼Œå¯¹æƒé™è¿›è¡Œå¤„ç†</span>                PackageParser<span class="token punctuation">.</span>Permission perm <span class="token operator">=</span> pkg<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                BasePermission bp <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPermissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>perm<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>systemApp <span class="token operator">||</span> sPmsExt<span class="token punctuation">.</span><span class="token function">isOperatorApp</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">,</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">,</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>onExternal<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ç³»ç»ŸAPPä¸èƒ½åœ¨SDå¡ä¸Šæ›¿æ¢å®‰è£…</span>                res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_INVALID_INSTALL_LOCATION<span class="token punctuation">,</span>                        <span class="token string">"Cannot install updates to system apps on sdcard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instantApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ç³»ç»Ÿ APP ä¸èƒ½è¢« Instant App æ›¿æ¢</span>                res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_INSTANT_APP_INVALID<span class="token punctuation">,</span>                        <span class="token string">"Cannot update a system app with an instant app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// é‡å‘½åä¸´æ—¶æ–‡ä»¶</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">.</span><span class="token function">doRename</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> oldCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_INSUFFICIENT_STORAGE<span class="token punctuation">,</span> <span class="token string">"Failed rename"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instantApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">startIntentFilterVerifications</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_DOMAIN_VERIFICATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Not verifying instant app install for app links: "</span> <span class="token operator">+</span> pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span>PackageFreezer freezer <span class="token operator">=</span> <span class="token function">freezePackageForInstall</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> installFlags<span class="token punctuation">,</span>                <span class="token string">"installPackageLI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ›¿æ¢å®‰è£…</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    PackageParser<span class="token punctuation">.</span>Package existingPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingPkg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> existingPkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">!=</span> pkg<span class="token punctuation">.</span>mVersionCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>INSTALL_FAILED_DUPLICATE_PACKAGE<span class="token punctuation">,</span> <span class="token string">"Packages declaring "</span>                                <span class="token operator">+</span> <span class="token string">"static-shared libs cannot be updated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token function">replacePackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_REPLACING<span class="token punctuation">,</span> args<span class="token punctuation">.</span>user<span class="token punctuation">,</span>                        installerPackageName<span class="token punctuation">,</span> res<span class="token punctuation">,</span> args<span class="token punctuation">.</span>installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å®‰è£…æ–°çš„ APK</span>                <span class="token function">installNewPackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">,</span>                        args<span class="token punctuation">.</span>user<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> volumeUuid<span class="token punctuation">,</span> res<span class="token punctuation">,</span> args<span class="token punctuation">.</span>installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ›´æ–°åº”ç”¨ç¨‹åºæ‰€å±çš„ç”¨æˆ·</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                res<span class="token punctuation">.</span>newUsers <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">queryInstalledUsers</span><span class="token punctuation">(</span>sUserManager<span class="token punctuation">.</span><span class="token function">getUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ps<span class="token punctuation">.</span><span class="token function">setUpdateAvailable</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*updateAvailable*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>installPackageLI æ–¹æ³•çš„ä»£ç å¾ˆé•¿ï¼Œè¿™é‡Œæˆªå–ä¸»è¦çš„éƒ¨åˆ†ï¼Œä¸»è¦åšäº†å‡ ä»¶äº‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€åˆ›å»º PackageParser è§£æ APK ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€æ£€æŸ¥ APK æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è·å–æ­¤å‰æ²¡è¢«æ”¹åå‰çš„åŒ…åï¼Œèµ‹å€¼ç»™ PackageParser.Package ç±»å‹çš„ pkg ï¼Œå°†æ ‡å¿—ä½ replace ç½®ä¸º true è¡¨ç¤ºæ˜¯æ›¿æ¢å®‰è£…ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€å¦‚æœ Settings ä¸­ä¿å­˜æœ‰è¦å®‰è£…çš„ APK çš„ä¿¡æ¯ï¼Œè¯´æ˜æ­¤å‰å®‰è£…è¿‡è¯¥ APK ï¼Œåˆ™éœ€è¦æ ¡éªŒ APK çš„ç­¾åä¿¡æ¯ï¼Œç¡®ä¿å®‰å…¨çš„è¿›è¡Œæ›¿æ¢ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;4ã€å°†ä¸´æ—¶æ–‡ä»¶é‡æ–°å‘½åï¼Œæ¯”å¦‚å‰é¢æåˆ°çš„ /data/app/vmdl18300388.tmp/base.apk ï¼Œé‡å‘½åä¸º /data/app/åŒ…å-1/base.apk ã€‚è¿™ä¸ªæ–°å‘½åçš„åŒ…åä¼šå¸¦ä¸Šä¸€ä¸ªæ•°å­—åç¼€ 1ï¼Œæ¯æ¬¡å‡çº§ä¸€ä¸ªå·²æœ‰çš„ App ï¼Œè¿™ä¸ªæ•°å­—ä¼šä¸æ–­çš„ç´¯åŠ ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;5ã€ç³»ç»Ÿ APP çš„æ›´æ–°å®‰è£…ä¼šæœ‰ä¸¤ä¸ªé™åˆ¶ï¼Œä¸€ä¸ªæ˜¯ç³»ç»Ÿ APP ä¸èƒ½åœ¨ SD å¡ä¸Šæ›¿æ¢å®‰è£…ï¼Œå¦ä¸€ä¸ªæ˜¯ç³»ç»Ÿ APP ä¸èƒ½è¢« Instant App æ›¿æ¢ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;6ã€æ ¹æ® replace æ¥åšåŒºåˆ†ï¼Œå¦‚æœæ˜¯æ›¿æ¢å®‰è£…å°±ä¼šè°ƒç”¨ replacePackageLIF æ–¹æ³•ï¼Œå…¶æ–¹æ³•å†…éƒ¨è¿˜ä¼šå¯¹ç³»ç»Ÿ APP å’Œéç³»ç»Ÿ APP è¿›è¡ŒåŒºåˆ†å¤„ç†ï¼Œå¦‚æœæ˜¯æ–°å®‰è£… APK ä¼šè°ƒç”¨ installNewPackageLIF æ–¹æ³•ã€‚</p><h2 id="4-5-installNewPackageLIF"><a href="#4-5-installNewPackageLIF" class="headerlink" title="4.5 installNewPackageLIF"></a>4.5 installNewPackageLIF</h2><p>æˆ‘ä»¬ä»¥å®‰è£…æ–° APK ä¸ºä¾‹ï¼ŒæŸ¥çœ‹ installNewPackageLIF çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*     * Install a non-existing package.     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installNewPackageLIF</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> policyFlags<span class="token punctuation">,</span>            <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">,</span> String installerPackageName<span class="token punctuation">,</span> String volumeUuid<span class="token punctuation">,</span>            PackageInstalledInfo res<span class="token punctuation">,</span> <span class="token keyword">int</span> installReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"installNewPackage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ‰«æ APK</span>            PackageParser<span class="token punctuation">.</span>Package newPackage <span class="token operator">=</span> <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> policyFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                    System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ›´æ–° Settings ä¿¡æ¯</span>            <span class="token function">updateSettingsLI</span><span class="token punctuation">(</span>newPackage<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user<span class="token punctuation">,</span> installReason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>returnCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å®‰è£…æˆåŠŸåï¼Œä¸ºæ–°å®‰è£…çš„åº”ç”¨ç¨‹åºå‡†å¤‡æ•°æ®</span>                <span class="token function">prepareAppDataAfterInstallLIF</span><span class="token punctuation">(</span>newPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å®‰è£…å¤±è´¥åˆ™åˆ é™¤ APK</span>                <span class="token function">deletePackageLIF</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span>                        PackageManager<span class="token punctuation">.</span>DELETE_KEEP_DATA<span class="token punctuation">,</span> res<span class="token punctuation">.</span>removedInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            res<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token string">"Package couldn't be installed in "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>installNewPackageLIF ä¸»è¦åšäº†ä»¥ä¸‹ 3 ä»¶äº‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€æ‰«æ APKï¼Œå°† APK çš„ä¿¡æ¯å­˜å‚¨åœ¨ PackageParser.Package ç±»å‹çš„ newPackage ä¸­ï¼Œä¸€ä¸ª Package çš„ä¿¡æ¯åŒ…å«äº† 1 ä¸ª base APK ä»¥åŠ 0 ä¸ªæˆ–è€…å¤šä¸ª split APK ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€æ›´æ–°è¯¥ APK å¯¹åº”çš„ Settings ä¿¡æ¯ï¼ŒSettings ç”¨äºä¿å­˜æ‰€æœ‰åŒ…çš„åŠ¨æ€è®¾ç½®ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€å¦‚æœå®‰è£…æˆåŠŸå°±ä¸ºæ–°å®‰è£…çš„åº”ç”¨ç¨‹åºå‡†å¤‡æ•°æ®ï¼Œå®‰è£…å¤±è´¥å°±åˆ é™¤APKã€‚</p><h2 id="4-6-scanPackageTracedLI"><a href="#4-6-scanPackageTracedLI" class="headerlink" title="4.6 scanPackageTracedLI"></a>4.6 scanPackageTracedLI</h2><p>è°ƒç”¨ scanPackageTracedLI() è¿›è¡Œå®‰è£… ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span>            <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token string">"scanPackage ["</span> <span class="token operator">+</span> scanFile<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-7-scanPackageLI-01"><a href="#4-7-scanPackageLI-01" class="headerlink" title="4.7 scanPackageLI - 01"></a>4.7 scanPackageLI - 01</h2><p>scanPackageTracedLI() è°ƒç”¨äº† scanPackageLI() æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     *  Scans a package and returns the newly parsed package.     *  Returns {@code null} in case of errors and the error code is stored in mLastScanError     */</span>    <span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span>            <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_INSTALL<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Parsing: "</span> <span class="token operator">+</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setOnlyCoreApps</span><span class="token punctuation">(</span>mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>        pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-8-scanPackageLI-02"><a href="#4-8-scanPackageLI-02" class="headerlink" title="4.8 scanPackageLI - 02"></a>4.8 scanPackageLI - 02</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> policyFlags<span class="token punctuation">,</span>            <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span>                    <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// scanPackageDirtyLI å®é™…å®‰è£… package çš„æ–¹æ³•</span>            <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package res <span class="token operator">=</span> <span class="token function">scanPackageDirtyLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> policyFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                    currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>            success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> res<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span>                <span class="token function">destroyAppDataLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">,</span>                        StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_DE <span class="token operator">|</span> StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_CE<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">destroyAppProfilesLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>æœ€ç»ˆè°ƒç”¨ scanPackageLI æ–¹æ³•ï¼</p><h1 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h1><p>æœ¬æ–‡ä¸»è¦è®²è§£äº† PMS æ˜¯å¦‚ä½•å¤„ç† APK å®‰è£…çš„æµç¨‹ï¼Œä¸»è¦æœ‰å‡ ä¸ªæ­¥éª¤ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;PackageInstaller å®‰è£… APK æ—¶ä¼šå°† APK çš„ä¿¡æ¯äº¤ç”± PMS å¤„ç†ï¼ŒPMS é€šè¿‡å‘ PackageHandler å‘é€æ¶ˆæ¯æ¥é©±åŠ¨ APK çš„å¤åˆ¶å’Œå®‰è£…å·¥ä½œã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;PMS å‘é€ INIT_COPY å’Œ MCS_BOUND ç±»å‹çš„æ¶ˆæ¯ï¼Œæ§åˆ¶ PackageHandler æ¥ç»‘å®š DefaultContainerService ï¼Œå®Œæˆå¤åˆ¶ APK ç­‰å·¥ä½œã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;å¤åˆ¶ APK å®Œæˆåï¼Œä¼šå¼€å§‹è¿›è¡Œå®‰è£… APK çš„æµç¨‹ï¼ŒåŒ…æ‹¬å®‰è£…å‰çš„æ£€æŸ¥ã€å®‰è£… APK å’Œå®‰è£…åçš„æ”¶å°¾å·¥ä½œã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="http://liuwangshu.cn/framework/pms/3-pms-install.html" target="_blank" rel="noopener">AndroidåŒ…ç®¡ç†æœºåˆ¶ï¼ˆä¸‰ï¼‰PMSå¤„ç†APKçš„å®‰è£… </a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/c4333c7eb409" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£12â€”â€”PMSä¸­çš„æ–°å®‰è£…æµç¨‹ä¸Š(æ‹·è´)</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/23/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%886%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88%E4%B8%8A%EF%BC%89/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆä¸Šï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/31/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%888%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88%E4%B8%8B%EF%BC%89/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ8ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆä¸‹ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
            <tag> APK å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…ï¼ˆä¸Šï¼‰</title>
      <link href="/2019/01/26/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-6-apk-an-zhuang-shang/"/>
      <url>/2019/01/26/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-6-apk-an-zhuang-shang/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† PackageInstaller å®‰è£… APK çš„æµç¨‹ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">PackageInstaller.java</font></td><td>/frameworks/base/core/java/android/content/pm/PackageInstaller.java</td></tr><tr><td><font color="#D15FEE">PackageManagerService.java</font></td><td>/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td></tr><tr><td><font color="#D15FEE">PackageInstallerSession.java</font></td><td>/frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java</td></tr><tr><td><font color="#D15FEE">InstallInstalling.java</font></td><td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallInstalling.java</td></tr><tr><td><font color="#D15FEE">PackageInstallerActivity.java</font></td><td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageInstallerActivity.java</td></tr></tbody></table><p><br></p><h2 id="1-2-å‰è¨€"><a href="#1-2-å‰è¨€" class="headerlink" title="1.2 å‰è¨€"></a>1.2 å‰è¨€</h2><p>åœ¨æœ¬ç³»åˆ—ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://superandroid.pro/2018/11/12/B_04.%20Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%884%EF%BC%89%E4%B9%8B%20PackageInstaller/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</a> ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“äº† PackageInstaller æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Œ</p><p>æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬ç ”ç©¶çš„é‡ç‚¹æ˜¯ï¼š <font color="#FF0000"><strong>PackageInstaller æ˜¯å¦‚ä½•å®‰è£… APK çš„</strong></font>ã€‚<br><br></p><h1 id="äºŒã€PackageInstallerActivity"><a href="#äºŒã€PackageInstallerActivity" class="headerlink" title="äºŒã€PackageInstallerActivity"></a>äºŒã€PackageInstallerActivity</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« çš„æœ«å°¾é˜¶æ®µï¼Œæˆ‘ä»¬çŸ¥é“ <font color="#0000CD"><strong><code>PackageInstallerActivity</code> è°ƒç”¨ <code>startInstallConfirm</code> æ–¹æ³•<code>åˆå§‹åŒ–å®‰è£…ç¡®è®¤ç•Œé¢</code></strong></font>åï¼Œè¿™ä¸ªå®‰è£…ç¡®è®¤ç•Œé¢å°±ä¼šå‘ˆç°ç»™ç”¨æˆ·ï¼Œç”¨æˆ·å¦‚æœæƒ³è¦å®‰è£…è¿™ä¸ªåº”ç”¨ç¨‹åºå°±ä¼šç‚¹å‡»ç¡®å®šæŒ‰é’®ï¼Œå°±ä¼šè°ƒç”¨ <strong><code>PackageInstallerActivity</code></strong> çš„ <font color="#0000CD"><strong><code>onClick()</code></strong></font> æ–¹æ³•ã€‚<br><br></p><h2 id="2-1-onClick"><a href="#2-1-onClick" class="headerlink" title="2.1 onClick"></a>2.1 onClick</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> mOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOk<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mOkCanInstall <span class="token operator">||</span> mScrollView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSessionId <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// å¦‚æœåŸæœ¬æ˜¯ç¡®è®¤æƒé™è¯·æ±‚åˆ™èµ‹äºˆå®‰è£…æƒé™åé€€å‡º</span>                        mInstaller<span class="token punctuation">.</span><span class="token function">setPermissionsResult</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token function">startInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ å¼€å§‹å®‰è£… ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    mScrollView<span class="token punctuation">.</span><span class="token function">pageScroll</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>FOCUS_DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> mCancel<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å–æ¶ˆå®‰è£…</span>            <span class="token function">setResult</span><span class="token punctuation">(</span>RESULT_CANCELED<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSessionId <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                mInstaller<span class="token punctuation">.</span><span class="token function">setPermissionsResult</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><strong><code>onClick</code></strong> æ–¹æ³•ä¸­åˆ†åˆ«å¯¹<strong><code>&quot;ç¡®å®š&quot;</code></strong>å’Œ<strong><code>&quot;å–æ¶ˆ&quot;</code></strong>æŒ‰é’®åšäº†å¤„ç†ï¼Œæˆ‘ä»¬ä¸»è¦æŸ¥çœ‹å¯¹â€ç¡®å®šâ€æŒ‰é’®çš„å¤„ç†ï¼Œè°ƒç”¨ <strong><code>startInstall</code></strong> æ–¹æ³•ï¼<br><br></p><h2 id="2-2-startInstall"><a href="#2-2-startInstall" class="headerlink" title="2.2 startInstall"></a>2.2 startInstall</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Intent newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¸¦ä¸Šå®‰è£…åŒ…çš„ applicationInfo</span>        newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PackageUtil<span class="token punctuation">.</span>INTENT_ATTR_APPLICATION_INFO<span class="token punctuation">,</span>                                                    mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¸¦ä¸Šå®‰è£…åŒ…çš„ URI</span>        newIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è®¾ç½®ç›®æ ‡ç±»</span>        newIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> InstallInstalling<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String installerPackageName <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>                Intent<span class="token punctuation">.</span>EXTRA_INSTALLER_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¸¦ä¸Šå®‰è£…åŒ…çš„ mOriginatingURI</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOriginatingURI <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">,</span> mOriginatingURI<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¸¦ä¸Šå®‰è£…åŒ…çš„ mReferrerURI</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mReferrerURI <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">,</span> mReferrerURI<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¸¦ä¸Šå®‰è£…åŒ…çš„ mOriginatingUid è¿™ä¸ª uid ä¸æ˜¯å®‰è£…åº”ç”¨çš„ uid</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOriginatingUid <span class="token operator">!=</span> PackageInstaller<span class="token punctuation">.</span>SessionParams<span class="token punctuation">.</span>UID_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_UID<span class="token punctuation">,</span> mOriginatingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>installerPackageName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INSTALLER_PACKAGE_NAME<span class="token punctuation">,</span>                    installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RETURN_RESULT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RETURN_RESULT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        newIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>localLOGV<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"downloaded app uri="</span><span class="token operator">+</span>mPackageURI<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// startInstall æ–¹æ³•ç”¨äºè·³è½¬åˆ° InstallInstalling è¿™ä¸ª Activity</span>        <span class="token function">startActivity</span><span class="token punctuation">(</span>newIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// å…³é—­å½“å‰çš„ PackageInstallerActivity</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹åˆ°åœ¨ <strong><code>startInstall</code></strong> æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯æ„é€ äº†ä¸€ä¸ª <strong><code>intent</code></strong>ï¼Œå¹¶ä¸”å°†<strong><code>å®‰è£…åŒ…ä¿¡æ¯</code></strong>å°è£…åˆ° intent ä¸­ï¼Œç„¶åè·³è½¬åˆ° <strong><code>InstallInstalling</code></strong> ç±»ã€‚<br><br></p><h1 id="ä¸‰ã€InstallInstalling"><a href="#ä¸‰ã€InstallInstalling" class="headerlink" title="ä¸‰ã€InstallInstalling"></a>ä¸‰ã€InstallInstalling</h1><p><strong><font color="#FF0000">InstallInstalling çš„ä¸»è¦å·¥ä½œï¼š</font></strong>ç”¨äºå‘åŒ…ç®¡ç†å™¨å‘é€åŒ…çš„ä¿¡æ¯å¹¶å¤„ç†åŒ…ç®¡ç†çš„å›è°ƒã€‚</p><h2 id="3-1-onCreate"><a href="#3-1-onCreate" class="headerlink" title="3.1 onCreate"></a>3.1 onCreate</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallInstalling</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_installing<span class="token punctuation">)</span><span class="token punctuation">;</span>        ApplicationInfo appInfo <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>PackageUtil<span class="token punctuation">.</span>INTENT_ATTR_APPLICATION_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>        mPackageURI <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ†åˆ«å¯¹ package å’Œ content åè®®çš„ Uri è¿›è¡Œå¤„ç†</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">installExistingPackage</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">launchSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">launchFailure</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INTERNAL_ERROR<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ ¹æ® mPackageURI åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ File</span>            <span class="token keyword">final</span> File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            PackageUtil<span class="token punctuation">.</span><span class="token function">initSnippetForNewApp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getAppSnippet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span>                    sourceFile<span class="token punctuation">)</span><span class="token punctuation">,</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>app_snippet<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¦‚æœ savedInstanceState ä¸ä¸º nullï¼Œè·å–æ­¤å‰ä¿å­˜çš„ mSessionId å’Œ mInstallId</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// mSessionId æ˜¯å®‰è£…åŒ…çš„ä¼šè¯ id</span>                mSessionId <span class="token operator">=</span> savedInstanceState<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>SESSION_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// mInstallId æ˜¯ç­‰å¾…çš„å®‰è£…äº‹ä»¶ id</span>                mInstallId <span class="token operator">=</span> savedInstanceState<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>INSTALL_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/**                 * æ ¹æ® mInstallId å‘ InstallEventReceiver æ³¨å†Œä¸€ä¸ªè§‚å¯Ÿè€…                 * launchFinishBasedOnResult ä¼šæ¥æ”¶åˆ°å®‰è£…äº‹ä»¶çš„å›è°ƒï¼Œ                 * æ— è®ºå®‰è£…æˆåŠŸæˆ–è€…å¤±è´¥éƒ½ä¼šå…³é—­å½“å‰çš„ Activity(InstallInstalling)                 */</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    InstallEventReceiver<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mInstallId<span class="token punctuation">,</span>                            <span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>launchFinishBasedOnResult<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EventResultPersister<span class="token punctuation">.</span>OutOfIdsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// Does not happen</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// savedInstanceState ä¸º null</span>                PackageInstaller<span class="token punctuation">.</span>SessionParams params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstaller<span class="token punctuation">.</span>SessionParams</span><span class="token punctuation">(</span>                        PackageInstaller<span class="token punctuation">.</span>SessionParams<span class="token punctuation">.</span>MODE_FULL_INSTALL<span class="token punctuation">)</span><span class="token punctuation">;</span>                params<span class="token punctuation">.</span>installFlags <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_FULL_APP<span class="token punctuation">;</span>                params<span class="token punctuation">.</span>referrerUri <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">)</span><span class="token punctuation">;</span>                params<span class="token punctuation">.</span>originatingUri <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>                params<span class="token punctuation">.</span>originatingUid <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_UID<span class="token punctuation">,</span>                        UID_UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>                params<span class="token punctuation">.</span>installerPackageName <span class="token operator">=</span>                        <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INSTALLER_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>                File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    PackageParser<span class="token punctuation">.</span>PackageLite pkg <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">parsePackageLite</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    params<span class="token punctuation">.</span><span class="token function">setAppPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>                    params<span class="token punctuation">.</span><span class="token function">setInstallLocation</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>installLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>                    params<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>PackageHelper<span class="token punctuation">.</span><span class="token function">calculateInstalledSize</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span>                                                                 <span class="token boolean">false</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>abiOverride<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParser<span class="token punctuation">.</span>PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">}</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    mInstallId <span class="token operator">=</span> InstallEventReceiver                            <span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> EventResultPersister<span class="token punctuation">.</span>GENERATE_NEW_ID<span class="token punctuation">,</span>                                    <span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>launchFinishBasedOnResult<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EventResultPersister<span class="token punctuation">.</span>OutOfIdsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">launchFailure</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INTERNAL_ERROR<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    mSessionId <span class="token operator">=</span>                            <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">launchFailure</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INTERNAL_ERROR<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mSessionCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstallSessionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="3-2-onResume"><a href="#3-2-onResume" class="headerlink" title="3.2 onResume"></a>3.2 onResume</h2><p>æˆ‘ä»¬æŸ¥çœ‹ <code>InstallInstalling</code> çš„ <code>onResume</code> æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallInstalling</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// This is the first onResume in a single life of the activity</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstallingTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageInstaller installer <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ ¹æ® mSessionId å¾—åˆ° SessionInfoï¼ŒSessionInfo ä»£è¡¨å®‰è£…ä¼šè¯çš„è¯¦ç»†ä¿¡æ¯</span>            PackageInstaller<span class="token punctuation">.</span>SessionInfo sessionInfo <span class="token operator">=</span> installer<span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¦‚æœ sessionInfo ä¸ä¸º Null å¹¶ä¸”ä¸æ˜¯æ´»åŠ¨çš„ï¼Œå°±åˆ›å»ºå¹¶æ‰§è¡Œ InstallingAsyncTask</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sessionInfo<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                mInstallingTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstallingAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• ğŸ’¥ ğŸ’¥ ğŸ’¥</span>                mInstallingTask<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// we will receive a broadcast when the install is finished</span>                mCancelButton<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">setFinishOnTouchOutside</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="3-3-InstallingAsyncTask"><a href="#3-3-InstallingAsyncTask" class="headerlink" title="3.3 InstallingAsyncTask"></a>3.3 InstallingAsyncTask</h2><p>æ—¢ç„¶å¯åŠ¨äº† <code>InstallingAsyncTask</code>ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹ç›¸å…³çš„ <code>doInBackground</code> å’Œ <code>onPostExecute</code> æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallInstalling</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InstallingAsyncTask</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Void<span class="token punctuation">,</span> Void<span class="token punctuation">,</span>            PackageInstaller<span class="token punctuation">.</span>Session<span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> isDone<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ ¹æ®åŒ…(APK)çš„ Uriï¼Œå°† APK çš„ä¿¡æ¯é€šè¿‡ IO æµçš„å½¢å¼å†™å…¥åˆ° PackageInstaller.Session ä¸­</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">protected</span> PackageInstaller<span class="token punctuation">.</span>Session <span class="token function">doInBackground</span><span class="token punctuation">(</span>Void<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageInstaller<span class="token punctuation">.</span>Session session<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                session <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            session<span class="token punctuation">.</span><span class="token function">setStagingProgress</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mPackageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">(</span>InputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">long</span> sizeBytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">try</span> <span class="token punctuation">(</span>OutputStream out <span class="token operator">=</span> session                            <span class="token punctuation">.</span><span class="token function">openWrite</span><span class="token punctuation">(</span><span class="token string">"PackageInstaller"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sizeBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">int</span> numRead <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>numRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                session<span class="token punctuation">.</span><span class="token function">fsync</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numRead<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>sizeBytes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">float</span> fraction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> numRead <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> sizeBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>                                session<span class="token punctuation">.</span><span class="token function">addProgress</span><span class="token punctuation">(</span>fraction<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> session<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> SecurityException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Could not write package"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    isDone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>Session session<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Intent broadcastIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>BROADCAST_ACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>                broadcastIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_RECEIVER_FOREGROUND<span class="token punctuation">)</span><span class="token punctuation">;</span>                broadcastIntent<span class="token punctuation">.</span><span class="token function">setPackage</span><span class="token punctuation">(</span>                        <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPermissionControllerPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                broadcastIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>EventResultPersister<span class="token punctuation">.</span>EXTRA_ID<span class="token punctuation">,</span> mInstallId<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// åˆ›å»ºäº†ä¸€ä¸ª PendingIntent</span>                PendingIntent pendingIntent <span class="token operator">=</span> PendingIntent<span class="token punctuation">.</span><span class="token function">getBroadcast</span><span class="token punctuation">(</span>                        InstallInstalling<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span>                        mInstallId<span class="token punctuation">,</span>                        broadcastIntent<span class="token punctuation">,</span>                        PendingIntent<span class="token punctuation">.</span>FLAG_UPDATE_CURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/**                 * å°†è¯¥ PendingIntent çš„ IntentSender é€šè¿‡                 * PackageInstaller.Session çš„ commit æ–¹æ³•å‘é€å‡ºå»                 */</span>                session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>pendingIntent<span class="token punctuation">.</span><span class="token function">getIntentSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                mCancelButton<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">setFinishOnTouchOutside</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">abandonSession</span><span class="token punctuation">(</span>mSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">launchFailure</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_APK<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>é—®é¢˜æ¥äº†ï¼Œcommit åˆ°å“ªå»äº†ï¼Ÿæˆ‘ä»¬ä¸å¦¨æ¥çœ‹ä¸€ä¸‹ <code>PackageInstaller.Session</code> çš„ <code>commit</code> æ–¹æ³•ï¼š<br><br></p><h2 id="3-4-commit"><a href="#3-4-commit" class="headerlink" title="3.4 commit"></a>3.4 commit</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstaller</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Session</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> IPackageInstallerSession mSession<span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> IntentSender statusReceiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                mSession<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>statusReceiver<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å‘ç°ï¼Œ<strong><code>mSession</code></strong> çš„ç±»å‹ä¸º <strong><code>IPackageInstallerSession</code></strong> ï¼Œè¿™è¯´æ˜è¦é€šè¿‡ <strong><code>IPackageInstallerSession</code></strong> æ¥è¿›è¡Œè¿›ç¨‹é—´çš„é€šä¿¡ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <strong><code>PackageInstallerSession</code></strong> çš„ <strong><code>commit</code></strong> æ–¹æ³•ï¼Œè¿™æ ·åˆå›åˆ°æ¡†æ¶å±‚å¤„ç†äº†ã€‚<br><br></p><h1 id="å››ã€PackageInstallerSession"><a href="#å››ã€PackageInstallerSession" class="headerlink" title="å››ã€PackageInstallerSession"></a>å››ã€PackageInstallerSession</h1><h2 id="4-1-commit"><a href="#4-1-commit" class="headerlink" title="4.1 commit"></a>4.1 commit</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerSession</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageInstallerSession<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> IntentSender statusReceiver<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forTransfer<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>statusReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> wasSealed<span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">assertCallerIsOwnerOrRootLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">assertPreparedAndNotDestroyedLocked</span><span class="token punctuation">(</span><span class="token string">"commit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å°†åŒ…çš„ä¿¡æ¯å°è£…ä¸º PackageInstallObserverAdapter</span>            <span class="token keyword">final</span> PackageInstallObserverAdapter adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstallObserverAdapter</span><span class="token punctuation">(</span>                    mContext<span class="token punctuation">,</span> statusReceiver<span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span>                    <span class="token function">isInstallerDeviceOwnerOrAffiliatedProfileOwnerLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>            mRemoteObserver <span class="token operator">=</span> adapter<span class="token punctuation">.</span><span class="token function">getBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MSG_COMMIT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="4-2-Handler-Callback"><a href="#4-2-Handler-Callback" class="headerlink" title="4.2 Handler.Callback"></a>4.2 Handler.Callback</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerSession</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageInstallerSession<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Handler<span class="token punctuation">.</span>Callback mHandlerCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler<span class="token punctuation">.</span>Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token keyword">case</span> MSG_COMMIT<span class="token operator">:</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• ğŸ’¥ ğŸ’¥ ğŸ’¥</span>                            <span class="token function">commitLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">final</span> String completeMsg <span class="token operator">=</span> ExceptionUtils<span class="token punctuation">.</span><span class="token function">getCompleteMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">destroyInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• ğŸ’¥ ğŸ’¥ ğŸ’¥</span>                            <span class="token function">dispatchSessionFinished</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>error<span class="token punctuation">,</span> completeMsg<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="4-3-commitLocked"><a href="#4-3-commitLocked" class="headerlink" title="4.3 commitLocked"></a>4.3 commitLocked</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerSession</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageInstallerSession<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> PackageManagerService mPm<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">/**         * commitLocked æ–¹æ³•å¾ˆé•¿ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å…¶ä¸­ä¸€è¡Œä»£ç          * è°ƒç”¨ PackageManagerService çš„ installStage æ–¹æ³•         * è¿™æ ·å®‰è£… APK çš„ä»£ç é€»è¾‘å°±è¿›å…¥äº† PackageManagerService ä¸­         */</span>        mPm<span class="token punctuation">.</span><span class="token function">installStage</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span> stageDir<span class="token punctuation">,</span> stageCid<span class="token punctuation">,</span> localObserver<span class="token punctuation">,</span> params<span class="token punctuation">,</span>                mInstallerPackageName<span class="token punctuation">,</span> mInstallerUid<span class="token punctuation">,</span> user<span class="token punctuation">,</span> mCertificates<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h1 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h1><p>æœ¬ç¯‡æ–‡ç« è®²è§£äº† PackageInstaller å®‰è£… APK çš„è¿‡ç¨‹ï¼Œç®€å•æ¥è¯´å°±ä¸¤æ­¥ï¼š<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp; 1. å°† APK çš„ä¿¡æ¯é€šè¿‡ IOæµ çš„å½¢å¼å†™å…¥åˆ° PackageInstaller.Sessionä¸­ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp; 2. è°ƒç”¨ PackageInstaller.Session çš„ commit æ–¹æ³•ï¼Œå°† APK çš„ä¿¡æ¯äº¤ç”± PMS å¤„ç†ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://blog.csdn.net/itachi85/article/details/81024903" target="_blank" rel="noopener">AndroidåŒ…ç®¡ç†æœºåˆ¶ï¼ˆäºŒï¼‰PackageInstallerå®‰è£…APKï¼ˆAndroid 8.0ï¼‰</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/19/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%885%EF%BC%89%E4%B9%8B%20PackageParser/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ5ï¼‰- PackageParser</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/27/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%887%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88%E4%B8%AD%EF%BC%89/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ7ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆä¸­ï¼‰</a> </p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
            <tag> APK å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- PackageParser</title>
      <link href="/2019/01/22/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-5-packageparser/"/>
      <url>/2019/01/22/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-5-packageparser/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">PackageParser.java</font></td><td>frameworks/base/core/java/android/content/pm/PackageParser.java</td></tr><tr><td><font color="#D15FEE">PackageManagerService.java</font></td><td>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td></tr></tbody></table><p><br></p><h2 id="1-2-ç®€ä»‹"><a href="#1-2-ç®€ä»‹" class="headerlink" title="1.2 ç®€ä»‹"></a>1.2 ç®€ä»‹</h2><p>åœ¨åˆ†æ <code>PackageManagerService</code> æ„é€ å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“ï¼šAndroid å®‰è£…ä¸€ä¸ª APK çš„æ—¶å€™é¦–å…ˆä¼šè§£æ APKï¼Œè€Œè§£æ APK åˆ™éœ€è¦ç”¨åˆ°ä¸€ä¸ªå·¥å…·ç±»ï¼Œè¿™ä¸ªå·¥å…·ç±»å°±æ˜¯æˆ‘ä»¬è¿™ç¯‡åšæ–‡çš„ä¸»è§’ <code>PackageParser</code>ï¼ˆåœ¨æˆ‘ä»¬ä¹‹å‰ç ”ç©¶çš„æºç ä¸­ï¼Œä½ å·²ç»è§è¿‡å®ƒçš„èº«å½±äº†ï¼‰ï¼<br><br></p><h1 id="äºŒã€PackageParser"><a href="#äºŒã€PackageParser" class="headerlink" title="äºŒã€PackageParser"></a>äºŒã€PackageParser</h1><h2 id="2-1-å®˜æ–¹è¯´æ˜"><a href="#2-1-å®˜æ–¹è¯´æ˜" class="headerlink" title="2.1 å®˜æ–¹è¯´æ˜"></a>2.1 å®˜æ–¹è¯´æ˜</h2><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹å®˜æ–¹å¯¹ PackageParser çš„è¯´æ˜ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Parser for package files (APKs) on disk. This supports apps packaged either * as a single "monolithic" APK, or apps packaged as a "cluster" of multiple * APKs in a single directory. * &lt;p> * Apps packaged as multiple APKs always consist of a single "base" APK (with a * {@code null} split name) and zero or more "split" APKs (with unique split * names). Any subset of those split APKs are a valid install, as long as the * following constraints are met: * &lt;ul> * &lt;li>All APKs must have the exact same package name, version code, and signing * certificates. * &lt;li>All APKs must have unique split names. * &lt;li>All installations must contain a single base APK. * &lt;/ul> * * ç¿»è¯‘å¦‚ä¸‹ï¼š * è§£æç£ç›˜ä¸Šçš„ APK å®‰è£…åŒ…æ–‡ä»¶ã€‚å®ƒæ—¢èƒ½è§£æä¸€ä¸ª"å•ä¸€" APK æ–‡ä»¶ï¼Œä¹Ÿèƒ½è§£æä¸€ä¸ª"é›†ç¾¤" APK æ–‡ä»¶ã€€* (å³ä¸€ä¸ª APK æ–‡ä»¶é‡Œé¢åŒ…å«å¤šä¸ª APK æ–‡ä»¶)ã€‚ä¸€ä¸ª"é›†ç¾¤" APK æœ‰ä¸€ä¸ª"åŸºå‡†" APK (base APK) ç»„æˆ * å’Œå…¶ä»–ä¸€äº›"åˆ†å‰²" APK ("split" APKs) æ„æˆï¼Œå…¶ä¸­è¿™äº›"åˆ†å‰²" APK ç”¨ä¸€äº›æ•°å­—æ¥åˆ†å‰²ã€‚ * è¿™äº›"åˆ†å‰²"çš„ APK å¿…é¡»éƒ½æ˜¯æœ‰æ•ˆçš„å®‰è£…ï¼ŒåŒæ—¶å¿…é¡»æ»¡è¶³ä¸‹é¢çš„å‡ ä¸ªæ¡ä»¶ï¼š *     æ‰€æœ‰çš„ APK å¿…é¡»å…·æœ‰å®Œå…¨ç›¸åŒçš„è½¯ä»¶åŒ…åç§°ï¼Œç‰ˆæœ¬ä»£ç å’Œç­¾åè¯ä¹¦ï¼› *     æ‰€æœ‰çš„ APK å¿…é¡»å…·æœ‰å”¯ä¸€çš„æ‹†åˆ†åç§°ï¼› *     æ‰€æœ‰å®‰è£…å¿…é¡»åŒ…å«ä¸€ä¸ªå•ä¸€çš„APKï¼› *  * @hide */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageParser</span> <span class="token punctuation">{</span></code></pre><p><br></p><h2 id="2-2-åˆ›å»ºè§£æå™¨"><a href="#2-2-åˆ›å»ºè§£æå™¨" class="headerlink" title="2.2 åˆ›å»ºè§£æå™¨"></a>2.2 åˆ›å»ºè§£æå™¨</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å…·ä½“æºç åŠé€»è¾‘æµç¨‹çœç•¥...</span><span class="token comment" spellcheck="true">// åˆ›å»ºè§£æå™¨</span><span class="token keyword">final</span> PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è§£æ APK</span>tmpPkg <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>codePath<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><br></p><h2 id="2-3-è§£æ-APK"><a href="#2-3-è§£æ-APK" class="headerlink" title="2.3 è§£æ APK"></a>2.3 è§£æ APK</h2><p>åœ¨åˆ†æ PackageParser è§£æ APK ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ Split APK æœºåˆ¶ï¼<br><br></p><h3 id="2-3-1-Split-APKæœºåˆ¶"><a href="#2-3-1-Split-APKæœºåˆ¶" class="headerlink" title="2.3.1 Split APKæœºåˆ¶"></a>2.3.1 Split APKæœºåˆ¶</h3><p>Split APK æ˜¯ Google ä¸ºè§£å†³ 65536 ä¸Šé™ï¼Œä»¥åŠ APK å®‰è£…åŒ…è¶Šæ¥è¶Šå¤§ç­‰é—®é¢˜ï¼Œåœ¨ <code>Android L</code> ä¸­å¼•å…¥çš„æœºåˆ¶ã€‚ Split APK å¯ä»¥å°†ä¸€ä¸ªåºå¤§çš„ APKï¼ŒæŒ‰å±å¹•å¯†åº¦ï¼ŒABI ç­‰å½¢å¼æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„ APKï¼Œåœ¨åº”ç”¨ç¨‹åºæ›´æ–°æ—¶ï¼Œä¸å¿…ä¸‹è½½æ•´ä¸ª APKï¼Œåªéœ€å•ç‹¬ä¸‹è½½æŸä¸ªæ¨¡å—å³å¯å®‰è£…æ›´æ–°ã€‚</p><p>Split APK å°†åŸæ¥ä¸€ä¸ª APK ä¸­å¤šä¸ªæ¨¡å—å…±äº«åŒä¸€ä»½èµ„æºçš„æ¨¡å‹åˆ†ç¦»æˆå¤šä¸ª APK ä½¿ç”¨å„è‡ªçš„èµ„æºï¼Œå¹¶ä¸”å¯ä»¥ç»§æ‰¿ Base APK ä¸­çš„èµ„æºï¼Œå¤šä¸ª APK æœ‰ç›¸åŒçš„ dataï¼Œcache ç›®å½•ã€‚</p><blockquote><p>åœ¨å¼•å…¥äº† Split APK æœºåˆ¶åï¼ŒAPK æœ‰ä¸¤ç§åˆ†ç±»ï¼š<br><code>Single APK</code>ï¼šå®‰è£…æ–‡ä»¶ä¸ºä¸€ä¸ªå®Œæ•´çš„ APKï¼Œå³ Base APKï¼Œæºç ä¸­å®šä¹‰ä¸º <code>Monolithic</code>ã€‚<br><code>Mutiple APK</code>ï¼šå®‰è£…æ–‡ä»¶åœ¨ä¸€ä¸ªæ–‡ä»¶ç›®å½•ä¸­ï¼Œå…¶å†…éƒ¨æœ‰å¤šä¸ªè¢«æ‹†åˆ†çš„ APKï¼Œè¿™äº› APK ç”±ä¸€ä¸ª Base APK å’Œä¸€ä¸ªæˆ–å¤šä¸ª Split APK ç»„æˆï¼Œæºç ä¸­å®šä¹‰ä¸º <code>Cluster</code>ã€‚</p></blockquote><h3 id="2-3-2-parsePackage"><a href="#2-3-2-parsePackage" class="headerlink" title="2.3.2 parsePackage"></a>2.3.2 parsePackage</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æ­£å¼åˆ†æ parsePackage æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Equivalent to {@link #parsePackage(File, int, boolean)} with {@code useCaches == false}. */</span><span class="token keyword">public</span> Package <span class="token function">parsePackage</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">parsePackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* useCaches */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æ–°å¢ä¸€ä¸ª <code>useCaches</code> å‚æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Package <span class="token function">parsePackage</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useCaches<span class="token punctuation">)</span>        <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>    Package parsed <span class="token operator">=</span> useCaches <span class="token operator">?</span> <span class="token function">getCachedResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> parsed<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">long</span> parseTime <span class="token operator">=</span> LOG_PARSE_TIMINGS <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœè§£æçš„ packageFile æ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™è°ƒç”¨ parseClusterPackage æ–¹æ³•</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        parsed <span class="token operator">=</span> <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å•ä¸ª APK æ–‡ä»¶ï¼Œåˆ™è°ƒç”¨ parseMonolithicPackageã€€æ–¹æ³•</span>        parsed <span class="token operator">=</span> <span class="token function">parseMonolithicPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">long</span> cacheTime <span class="token operator">=</span> LOG_PARSE_TIMINGS <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">cacheResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG_PARSE_TIMINGS<span class="token punctuation">)</span> <span class="token punctuation">{</span>        parseTime <span class="token operator">=</span> cacheTime <span class="token operator">-</span> parseTime<span class="token punctuation">;</span>        cacheTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cacheTime<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>parseTime <span class="token operator">+</span> cacheTime <span class="token operator">></span> LOG_PARSE_TIMINGS_THRESHOLD_MS<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Parse times for '"</span> <span class="token operator">+</span> packageFile <span class="token operator">+</span> <span class="token string">"': parse="</span> <span class="token operator">+</span> parseTime                    <span class="token operator">+</span> <span class="token string">"ms, update_cache="</span> <span class="token operator">+</span> cacheTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> parsed<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬è¿™è¾¹é€‰å– parseClusterPackage ä½œä¸ºåˆ†æçš„åˆ†æ”¯ï¼Œå½“ä½ ææ‡‚è¿™ä¸ªæ–¹æ³•çš„å…·ä½“é€»è¾‘ï¼Œå•ä¸ª APK çš„è§£æåŸç†å°±å¾ˆç®€å•äº†ã€‚</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-702816956a0fec31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></center><p><br></p><h1 id="ä¸‰ã€parseClusterPackage"><a href="#ä¸‰ã€parseClusterPackage" class="headerlink" title="ä¸‰ã€parseClusterPackage"></a>ä¸‰ã€parseClusterPackage</h1><p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>parseClusterPackage()</code> çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Package <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>File packageDir<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/*     * è°ƒç”¨ parseClusterPackageLite æ–¹æ³•ç”¨äºè½»é‡çº§è§£æç›®å½•æ–‡ä»¶ï¼Œ     * ä¹‹æ‰€ä»¥è¦è½»é‡çº§è§£ææ˜¯å› ä¸ºè§£æ APK æ˜¯ä¸€ä¸ªå¤æ‚è€—æ—¶çš„æ“ä½œï¼Œè¿™é‡Œçš„é€»è¾‘å¹¶ä¸éœ€è¦ APK æ‰€æœ‰çš„ä¿¡æ¯ã€‚     */</span>    <span class="token keyword">final</span> PackageLite lite <span class="token operator">=</span> <span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*     * mOnlyCoreApps ç”¨æ¥æŒ‡ç¤º PackageParser æ˜¯å¦åªè§£æâ€œæ ¸å¿ƒâ€åº”ç”¨ï¼Œ     * â€œæ ¸å¿ƒâ€åº”ç”¨æŒ‡çš„æ˜¯ AndroidManifest ä¸­ coreApp çš„å±æ€§å€¼ä¸º trueï¼Œ     * åªè§£æâ€œæ ¸å¿ƒâ€åº”ç”¨æ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªæç®€çš„å¯åŠ¨ç¯å¢ƒï¼Œ     * æˆ‘ä»¬å¯ä»¥é€šè¿‡ PackageParser çš„ setOnlyCoreApps æ–¹æ³•æ¥è®¾ç½® mOnlyCoreApps çš„å€¼ã€‚     *     * lite.coreApp è¡¨ç¤ºå½“å‰åŒ…æ˜¯å¦åŒ…å«â€œæ ¸å¿ƒâ€åº”ç”¨ï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mOnlyCoreApps <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lite<span class="token punctuation">.</span>coreApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">,</span>                <span class="token string">"Not a coreApp: "</span> <span class="token operator">+</span> packageDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Build the split dependency tree.</span>    SparseArray<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> splitDependencies <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">final</span> SplitAssetLoader assetLoader<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lite<span class="token punctuation">.</span>isolatedSplits <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            splitDependencies <span class="token operator">=</span>                           SplitAssetDependencyLoader<span class="token punctuation">.</span><span class="token function">createDependenciesFromPackage</span><span class="token punctuation">(</span>lite<span class="token punctuation">)</span><span class="token punctuation">;</span>            assetLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SplitAssetDependencyLoader</span><span class="token punctuation">(</span>lite<span class="token punctuation">,</span> splitDependencies<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SplitAssetDependencyLoader<span class="token punctuation">.</span>IllegalDependencyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span>                                              e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        assetLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSplitAssetLoader</span><span class="token punctuation">(</span>lite<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è·å– AssetManager å¯¹è±¡</span>        <span class="token keyword">final</span> AssetManager assets <span class="token operator">=</span> assetLoader<span class="token punctuation">.</span><span class="token function">getBaseAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> File baseApk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è§£æ base APKï¼Œè·å¾—å¯¹åº”çš„ Package å¯¹è±¡</span>        <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>baseApk<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_NOT_APK<span class="token punctuation">,</span>                    <span class="token string">"Failed to parse base APK: "</span> <span class="token operator">+</span> baseApk<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è·å– split APK çš„æ•°é‡</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>splitCodePaths <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>splitRevisionCodes <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitRevisionCodes<span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>splitFlags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>splitPrivateFlags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitDependencies <span class="token operator">=</span> splitDependencies<span class="token punctuation">;</span>            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitClassLoaderNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> AssetManager splitAssets <span class="token operator">=</span> assetLoader<span class="token punctuation">.</span><span class="token function">getSplitAssetManager</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// è§£ææ¯ä¸ª split APK</span>                <span class="token function">parseSplitApk</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> i<span class="token punctuation">,</span> splitAssets<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è®¾ç½®ç›¸åº”å±æ€§</span>        pkg<span class="token punctuation">.</span><span class="token function">setCodePath</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">.</span><span class="token function">getCanonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pkg<span class="token punctuation">.</span><span class="token function">setUse32bitAbi</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>use32bitAbi<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION<span class="token punctuation">,</span>                <span class="token string">"Failed to get path: "</span> <span class="token operator">+</span> lite<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>assetLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="3-1-parseClusterPackageLite"><a href="#3-1-parseClusterPackageLite" class="headerlink" title="3.1 parseClusterPackageLite"></a>3.1 parseClusterPackageLite</h2><p>æˆ‘ä»¬æ¥çœ‹çœ‹è½»é‡çº§è§£æå‡½æ•° <code>parseClusterPackageLite()</code> çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> PackageLite <span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>File packageDir<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>                                            <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isApkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// é€šè¿‡ parseApkLite æ–¹æ³•è§£ææ¯ä¸ª Mutiple APKï¼Œ</span>            <span class="token comment" spellcheck="true">// å¾—åˆ°æ¯ä¸ª Mutiple APK å¯¹åº”çš„ ApkLiteï¼ˆè½»é‡çº§ APK ä¿¡æ¯ï¼‰ã€‚</span>            <span class="token keyword">final</span> ApkLite lite <span class="token operator">=</span> <span class="token function">parseApkLite</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">final</span> String codePath <span class="token operator">=</span> packageDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å°†è¿™äº› ApkLite å°è£…ä¸ºä¸€ä¸ª PackageLiteï¼ˆè½»é‡çº§åŒ…ä¿¡æ¯ï¼‰å¹¶è¿”å›</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PackageLite</span><span class="token punctuation">(</span>codePath<span class="token punctuation">,</span> baseApk<span class="token punctuation">,</span> splitNames<span class="token punctuation">,</span> isFeatureSplits<span class="token punctuation">,</span> usesSplitNames<span class="token punctuation">,</span>            configForSplits<span class="token punctuation">,</span> splitCodePaths<span class="token punctuation">,</span> splitRevisionCodes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="3-2-parseBaseApk"><a href="#3-2-parseBaseApk" class="headerlink" title="3.2 parseBaseApk"></a>3.2 parseBaseApk</h2><p>æˆ‘ä»¬æ¥çœ‹çœ‹ Base Apk çš„è§£æå‡½æ•° <code>parseBaseApk()</code> çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String MNT_EXPAND <span class="token operator">=</span> <span class="token string">"/mnt/expand/"</span><span class="token punctuation">;</span><span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>File apkFile<span class="token punctuation">,</span> AssetManager assets<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>                             <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>    <span class="token keyword">final</span> String apkPath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    String volumeUuid <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>apkPath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> end <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¦‚æœ APK çš„è·¯å¾„ä»¥ /mnt/expand/ å¼€å¤´ï¼Œå°±æˆªå–è¯¥è·¯å¾„è·å– volumeUuid</span>        volumeUuid <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>    mArchiveSourcePath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_JAR<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Scanning base APK: "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    XmlResourceParser parser <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> cookie <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">findCookieForPath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span>                    <span class="token string">"Failed adding asset path: "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        parser <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">openXmlResourceParser</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> ANDROID_MANIFEST_FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> Resources res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å†æ¬¡è°ƒç”¨ parseBaseApk æ–¹æ³•</span>        <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>mParseError<span class="token punctuation">,</span>                    apkPath <span class="token operator">+</span> <span class="token string">" (at "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"): "</span> <span class="token operator">+</span> outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// ç”¨äºä»¥åæ ‡è¯†è¿™ä¸ªè§£æåçš„ Package</span>        pkg<span class="token punctuation">.</span><span class="token function">setVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ç”¨äºæ ‡è¯†è¯¥ App æ‰€åœ¨çš„å­˜å‚¨å· UUID</span>        pkg<span class="token punctuation">.</span><span class="token function">setApplicationVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>        pkg<span class="token punctuation">.</span><span class="token function">setBaseCodePath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        pkg<span class="token punctuation">.</span><span class="token function">setSigningDetails</span><span class="token punctuation">(</span>SigningDetails<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION<span class="token punctuation">,</span>                <span class="token string">"Failed to read manifest from "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¸»è¦å°±æ˜¯åšäº†ä¸¤ä»¶äº‹ï¼š</p><blockquote><p>1ã€è§£æ volumeUuid<br>  2ã€è°ƒç”¨ parseBaseApk(res, parser, flags, outError) æ¥è·å– Package å¯¹è±¡ pkg å¹¶è¿”å›</p></blockquote><p><br></p><h2 id="3-3-parseBaseApk-é‡è½½"><a href="#3-3-parseBaseApk-é‡è½½" class="headerlink" title="3.3 parseBaseApk é‡è½½"></a>3.3 parseBaseApk é‡è½½</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>String apkPath<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span> XmlResourceParser parser<span class="token punctuation">,</span>            <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>    <span class="token keyword">final</span> String splitName<span class="token punctuation">;</span>    <span class="token keyword">final</span> String pkgName<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// ç”¨åŒ…ååˆ›å»ºä¸€ä¸ª Package å¯¹è±¡</span>    <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä»èµ„æºä¸­æå–è‡ªå®šä¹‰å±æ€§é›† com.android.internal.R.styleable.AndroidManifest å¾—åˆ° TypedArray </span>    TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆå§‹åŒ– pkg çš„å±æ€§</span>    pkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pkg<span class="token punctuation">.</span>mVersionCodeMajor <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionCodeMajor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">setVersionCode</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pkg<span class="token punctuation">.</span>baseRevisionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_revisionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mVersionName<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è¯»å– APK çš„ AndroidManifest ä¸­çš„ coreApp çš„å€¼ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæ ¸å¿ƒ Apk</span>    pkg<span class="token punctuation">.</span>coreApp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"coreApp"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pkg<span class="token punctuation">.</span>mCompileSdkVersion <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_compileSdkVersion<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>compileSdkVersion <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersion<span class="token punctuation">;</span>    pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_compileSdkVersionCodename<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>compileSdkVersionCodename <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è·å–èµ„æºåè¦å›æ”¶</span>    sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">parseBaseApkCommon</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> null<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="3-4-parseBaseApkCommon"><a href="#3-4-parseBaseApkCommon" class="headerlink" title="3.4 parseBaseApkCommon"></a>3.4 parseBaseApkCommon</h2><p>æœ€ç»ˆè°ƒç”¨äº† <code>parseBaseApkCommon</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥è§£æ APK çš„ <code>AndroidManifest</code> ä¸­çš„ <code>å„ä¸ªæ ‡ç­¾</code>ï¼Œæ¯”å¦‚ applicationã€permissionã€uses-sdkã€feature-group ç­‰ç­‰ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Package <span class="token function">parseBaseApkCommon</span><span class="token punctuation">(</span>Package pkg<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>String<span class="token operator">></span> acceptedTags<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>        XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span>        IOException <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// æ˜¯å¦è¦å®‰è£…åœ¨ SD å¡ä¸Š</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_EXTERNAL_STORAGE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_EXTERNAL_STORAGE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// å¼€å§‹è§£æ xml</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> outerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// private static final String TAG_APPLICATION = "application";</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>foundApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>RIGID_PARSER<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;manifest> has more than one &lt;application>"</span><span class="token punctuation">;</span>                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"&lt;manifest> has more than one &lt;application>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            foundApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å…¶ä¸­å››å¤§ç»„ä»¶çš„æ ‡ç­¾åœ¨ application æ ‡ç­¾ä¸‹ï¼Œ</span>            <span class="token comment" spellcheck="true">// è§£æ application æ ‡ç­¾çš„æ–¹æ³•ä¸º parseBaseApplicationã€‚</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_OVERLAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="3-5-parseBaseApplication"><a href="#3-5-parseBaseApplication" class="headerlink" title="3.5 parseBaseApplication"></a>3.5 parseBaseApplication</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// parseBaseApplication æ–¹æ³•å¾ˆé•¿ï¼Œæˆ‘ä»¬è¿™é‡Œåªæˆªå–äº†è§£æå››å¤§ç»„ä»¶ç›¸å…³çš„ä»£ç ã€‚</span><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>Package owner<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>        XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span>    <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> innerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è°ƒç”¨ parseActivity æ–¹æ³•è§£æ activity æ ‡ç­¾ï¼Œ</span>            <span class="token comment" spellcheck="true">// å¾—åˆ°ä¸€ä¸ª Activity å¯¹è±¡ï¼ˆPackageParser çš„é™æ€å†…éƒ¨ç±»ï¼‰</span>            Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                    owner<span class="token punctuation">.</span>baseHardwareAccelerated<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// å°†è§£æå¾—åˆ°çš„ Activity å¯¹è±¡ä¿å­˜åœ¨ Package çš„åˆ—è¡¨ activities ä¸­</span>            owner<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>            parsedComponent <span class="token operator">=</span> a<span class="token punctuation">.</span>info<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span>                    <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            owner<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>            parsedComponent <span class="token operator">=</span> a<span class="token punctuation">.</span>info<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Service s <span class="token operator">=</span> <span class="token function">parseService</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            owner<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>            parsedComponent <span class="token operator">=</span> s<span class="token punctuation">.</span>info<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"provider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Provider p <span class="token operator">=</span> <span class="token function">parseProvider</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            owner<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            parsedComponent <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><br></p><h2 id="3-6-æ€»ç»“"><a href="#3-6-æ€»ç»“" class="headerlink" title="3.6 æ€»ç»“"></a>3.6 æ€»ç»“</h2><p>PackageParser è§£æ APK çš„ä»£ç é€»è¾‘éå¸¸åºå¤§ä¸”å¤æ‚ï¼ŒåŸºæœ¬äº†è§£äº†æœ¬æ–‡æ‰€æ¶‰åŠçš„é€»è¾‘å’ŒåŸç†ï¼Œåˆ†æé—®é¢˜åŸºæœ¬ä¸Šè¶³å¤Ÿäº†ï¼Œå¦‚æœæœ‰å…´è¶£å¯ä»¥è‡ªè¡Œæ·±å…¥çš„ç ”ç©¶æºç ã€‚</p><p>parseBaseApk æ–¹æ³•ä¸»è¦çš„è§£æç»“æ„å¯ä»¥ç†è§£ä¸ºä»¥ä¸‹ç®€å›¾ï¼š<br><br></p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-f8f66b9d2ba70154.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt="1417629-1a9039e0ad81bf21.png"></center><h1 id="å››ã€Package-æ•°æ®ç»“æ„"><a href="#å››ã€Package-æ•°æ®ç»“æ„" class="headerlink" title="å››ã€Package æ•°æ®ç»“æ„"></a>å››ã€Package æ•°æ®ç»“æ„</h1><p>åŒ…è¢«è§£æåï¼Œæœ€ç»ˆå­˜å‚¨åœ¨ <code>Package</code> ï¼Œå®ƒæ˜¯ <code>PackageParser</code> çš„<code>å†…éƒ¨ç±»</code>ï¼Œå®ƒçš„éƒ¨åˆ†æˆå‘˜å˜é‡å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Representation of a full package parsed from APK files on disk. A package * consists of a single base APK, and zero or more split APKs. */</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Package</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> String packageName<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The package name declared in the manifest as the package can be</span>    <span class="token comment" spellcheck="true">// renamed, for example static shared libs use synthetic package names.</span>    <span class="token keyword">public</span> String manifestPackageName<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/** Names of any split APKs, ordered by parsed splitName */</span>    <span class="token keyword">public</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitNames<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// TODO: work towards making these paths invariant</span>    <span class="token keyword">public</span> String volumeUuid<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * Path where this package was found on disk. For monolithic packages     * this is path to single base APK file; for cluster packages this is     * path to the cluster directory.     */</span>    <span class="token keyword">public</span> String codePath<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/** Path of base APK */</span>    <span class="token keyword">public</span> String baseCodePath<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/** Paths of any split APKs, ordered by parsed splitName */</span>    <span class="token keyword">public</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitCodePaths<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// For now we only support one application per package.</span>    <span class="token keyword">public</span> ApplicationInfo applicationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Permission<span class="token operator">></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Permission<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>PermissionGroup<span class="token operator">></span> permissionGroups <span class="token operator">=</span>                                                      <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>PermissionGroup<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*      * activities åˆ—è¡¨ä¸­å­˜å‚¨äº†ç±»å‹ä¸º Activity çš„å¯¹è±¡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ª Acticity å¹¶ä¸æ˜¯     * æˆ‘ä»¬å¸¸ç”¨çš„é‚£ä¸ª Activity ï¼Œè€Œæ˜¯ PackageParser çš„é™æ€å†…éƒ¨ç±»ï¼ŒPackage ä¸­çš„å…¶ä»–åˆ—è¡¨ä¹Ÿéƒ½æ˜¯å¦‚æ­¤ã€‚     */</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Activity<span class="token operator">></span> activities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Activity<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Activity<span class="token operator">></span> receivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Activity<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Provider<span class="token operator">></span> providers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Provider<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Service<span class="token operator">></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Service<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Instrumentation<span class="token operator">></span> instrumentation <span class="token operator">=</span>                                                <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Instrumentation<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>Package çš„æ•°æ®ç»“æ„ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-12ea4aeb503246b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></center><p>ä»è¿™ä¸ªç®€å›¾ä¸­å¯ä»¥å‘ç° Package çš„æ•°æ®ç»“æ„æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼š</p><p>1ã€Package ä¸­å­˜æœ‰è®¸å¤šç»„ä»¶ï¼Œæ¯”å¦‚ Acticityã€Providerã€Permission ç­‰ç­‰ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿åŸºç±» Componentã€‚<br>2ã€æ¯ä¸ªç»„ä»¶éƒ½åŒ…å«ä¸€ä¸ª info æ•°æ®ï¼Œæ¯”å¦‚ Activity ç±»ä¸­åŒ…å«äº†æˆå‘˜å˜é‡ ActivityInfoï¼Œè¿™ä¸ª ActivityInfo æ‰æ˜¯çœŸæ­£çš„ Activity æ•°æ®ã€‚<br>3ã€å››å¤§ç»„ä»¶çš„æ ‡ç­¾å†…å¯èƒ½åŒ…å« <intent-filter> æ¥è¿‡æ»¤ Intent ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦ IntentInfo æ¥ä¿å­˜ç»„ä»¶çš„ intent ä¿¡æ¯ï¼Œç»„ä»¶åŸºç±» Component ä¾èµ–äº IntentInfoï¼ŒIntentInfo æœ‰ä¸‰ä¸ªå­ç±» ActivityIntentInfoã€ServiceIntentInfo å’Œ ProviderIntentInfoï¼Œä¸åŒç»„ä»¶ä¾èµ–çš„ IntentInfo ä¼šæœ‰æ‰€ä¸åŒï¼Œæ¯”å¦‚ Activity ç»§æ‰¿è‡ªComponent<activityintentinfo> ï¼ŒPermission ç»§æ‰¿è‡ª Component<intentinfo> ã€‚</intentinfo></activityintentinfo></intent-filter></p><p>æœ€ç»ˆçš„è§£æçš„æ•°æ®ä¼šå°è£…åˆ° Package ä¸­ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="http://liuwangshu.cn/framework/pms/5-packageparser.html" target="_blank" rel="noopener">AndroidåŒ…ç®¡ç†æœºåˆ¶ï¼ˆäº”ï¼‰APKæ˜¯å¦‚ä½•è¢«è§£æçš„</a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/69fb6f9a6ac7" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£9â€”â€”PackageParserè§£æAPK(ä¸Š)</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/15/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%884%EF%BC%89%E4%B9%8B%20PackageInstaller/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/23/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%886%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88%E4%B8%8A%EF%BC%89/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆä¸Šï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
            <tag> PackageParser </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</title>
      <link href="/2019/01/16/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-4-packageinstaller/"/>
      <url>/2019/01/16/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-4-packageinstaller/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† PackageInstaller æºç æµç¨‹ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">PackageInstaller.java</font></td><td>/frameworks/base/core/java/android/content/pm/PackageInstaller.java</td></tr><tr><td><font color="#D15FEE">PackageManager.java</font></td><td>/frameworks/base/core/java/android/content/pm/PackageManager.java</td></tr><tr><td><font color="#D15FEE">ApplicationPackageManager.java</font></td><td>/frameworks/base/core/java/android/app/ApplicationPackageManager.java</td></tr><tr><td><font color="#D15FEE">PackageUtil.java</font></td><td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageUtil.java</td></tr><tr><td><font color="#D15FEE">InstallStart.java</font></td><td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStart.java</td></tr><tr><td><font color="#D15FEE">InstallStaging.java</font></td><td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStaging.java</td></tr><tr><td><font color="#D15FEE">PackageInstallerActivity.java</font></td><td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageInstallerActivity.java</td></tr></tbody></table><h2 id="1-2-PackageManager"><a href="#1-2-PackageManager" class="headerlink" title="1.2 PackageManager"></a>1.2 PackageManager</h2><p>åœ¨è¯¦ç»†è®²è§£åŒ…ç®¡ç†æœºåˆ¶å¦‚ä½•å®‰è£… APK ä¹‹å‰ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹å‰é¢ä¸€ç¯‡æ–‡ç« è®²è§£çš„ <font color="#FF0000"><strong>PackageManager</strong></font>ã€‚</p><p><code>PackageManager</code> æ˜¯ä¸€ä¸ª<code>æŠ½è±¡ç±»</code>ï¼Œå®ƒçš„å…·ä½“å®ç°ç±»ä¸º <code>ApplicationPackageManager</code> ã€‚</p><p><code>ApplicationPackageManager</code> ä¸­çš„æ–¹æ³•ä¼šé€šè¿‡ <code>IPackageManager</code> ä¸ <code>PackageManagerService</code> è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œå› æ­¤ <code>PackageManager</code> æ‰€æä¾›çš„åŠŸèƒ½æœ€ç»ˆæ˜¯ç”± <code>PackageManagerService</code> æ¥å®ç°çš„ï¼Œè¿™ä¹ˆè®¾è®¡çš„ä¸»è¦ç”¨æ„æ˜¯ä¸ºäº†é¿å…ç³»ç»ŸæœåŠ¡ PMS ç›´æ¥è¢«è®¿é—®ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// PackageManager æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ApplicationPackageManager ç»§æ‰¿è‡ª PackageManager</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><h2 id="1-3-å…³äº-APK"><a href="#1-3-å…³äº-APK" class="headerlink" title="1.3 å…³äº APK"></a>1.3 å…³äº APK</h2><blockquote><p>æ–‡ä»¶ç»“æ„å’Œå®‰è£…æ–¹å¼</p></blockquote><p><code>APK</code> æ˜¯ <code>AndroidPackage</code> çš„ç¼©å†™ï¼Œå³ <code>Android å®‰è£…åŒ…</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯ <code>zip</code> æ ¼å¼çš„å‹ç¼©æ–‡ä»¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè§£å‹åçš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><thead><tr><th>ç›®å½•/æ–‡ä»¶</th><th>æè¿°</th></tr></thead><tbody><tr><td>assert</td><td>å­˜æ”¾çš„åŸç”Ÿèµ„æºæ–‡ä»¶ï¼Œé€šè¿‡ AssetManager ç±»è®¿é—®ã€‚</td></tr><tr><td>lib</td><td>å­˜æ”¾åº“æ–‡ä»¶ã€‚</td></tr><tr><td>META-INF</td><td>ä¿å­˜åº”ç”¨çš„ç­¾åä¿¡æ¯ï¼Œç­¾åä¿¡æ¯å¯ä»¥éªŒè¯ APK æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚</td></tr><tr><td>res</td><td>å­˜æ”¾èµ„æºæ–‡ä»¶ã€‚res ä¸­é™¤äº† raw å­ç›®å½•ï¼Œå…¶ä»–çš„å­ç›®å½•éƒ½å‚ä¸ç¼–è¯‘ï¼Œè¿™äº›å­ç›®å½•ä¸‹çš„èµ„æºæ˜¯é€šè¿‡ç¼–è¯‘å‡ºçš„ R ç±»åœ¨ä»£ç ä¸­è®¿é—®ã€‚</td></tr><tr><td>AndroidManifest.xml</td><td>ç”¨æ¥å£°æ˜åº”ç”¨ç¨‹åºçš„åŒ…åç§°ã€ç‰ˆæœ¬ã€ç»„ä»¶å’Œæƒé™ç­‰æ•°æ®ã€‚ apk ä¸­çš„ AndroidManifest.xml ç»è¿‡å‹ç¼©ï¼Œå¯ä»¥é€šè¿‡ AXMLPrinter2 å·¥å…·è§£å¼€ã€‚</td></tr><tr><td>classes.dex</td><td>Java æºç ç¼–è¯‘åç”Ÿæˆçš„ Java å­—èŠ‚ç æ–‡ä»¶ã€‚</td></tr><tr><td>resources.arsc</td><td>ç¼–è¯‘åçš„äºŒè¿›åˆ¶èµ„æºæ–‡ä»¶ã€‚</td></tr></tbody></table><blockquote><p>å®‰è£…åœºæ™¯</p></blockquote><p>ç›®å‰ï¼Œæˆ‘ä»¬å¸¸è§çš„å®‰è£… APK çš„åœºæ™¯ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ <font color="#FF0000"><strong>å››ç§</strong></font>ï¼šï¼ˆè¿™å››ç§æ–¹å¼åé¢éƒ½å•ç‹¬è¿›è¡Œç ”ç©¶ï¼‰</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€é€šè¿‡ adb å‘½ä»¤å®‰è£…ï¼šadb å‘½ä»¤åŒ…æ‹¬ <code>adb push/install</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€ç”¨æˆ·ä¸‹è½½çš„ Apkï¼Œé€šè¿‡ç³»ç»Ÿå®‰è£…å™¨ <code>packageinstaller</code>ï¼ˆç³»ç»Ÿå†…ç½®çš„åº”ç”¨ç¨‹åºï¼Œç”¨äºå®‰è£…å’Œå¸è½½åº”ç”¨ç¨‹åºï¼‰å®‰è£…è¯¥ Apkã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€ç³»ç»Ÿå¼€æœºæ—¶å®‰è£…ç³»ç»Ÿåº”ç”¨ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;4ã€ç”µè„‘æˆ–è€…æ‰‹æœºä¸Šçš„åº”ç”¨å•†åº—è‡ªåŠ¨å®‰è£…ã€‚</p><p>å…¶å®ï¼Œè¿™ 4 ç§æ–¹å¼æœ€ç»ˆéƒ½æ˜¯ç”± <code>PackageManagerService</code> æ¥è¿›è¡Œå¤„ç†ï¼Œåªæ˜¯åœ¨æ­¤ä¹‹å‰çš„è°ƒç”¨é“¾ï¼ˆé€»è¾‘ï¼‰æ˜¯ä¸åŒçš„ã€‚</p><p>æˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„åˆ†æä¸­ï¼Œä¼šä¼˜å…ˆé€‰æ‹©ç¬¬äºŒç§æ–¹å¼ï¼Œå› ä¸ºå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œè¿™æ˜¯è°ƒç”¨é“¾æ¯”è¾ƒé•¿çš„å®‰è£…æ–¹å¼ï¼Œå…¶ä»–ä¸‰ç§æ–¹å¼ä¹Ÿä¼šå†è·Ÿä¸€éé€»è¾‘ï¼Œæ¢³ç† 4 ç§é€»è¾‘çš„å·®å¼‚ç‚¹ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹è¿™ç§å®‰è£…æ–¹å¼çš„<font color="#0000CD"> <strong>å®é™…æ•ˆæœå›¾</strong> </font>ï¼šï¼ˆåé¢æˆ‘ä»¬åˆ†ææºç çš„æµç¨‹ä¼šç´§å¯†è”ç³»ç€è¿™å‡ å¼ å›¾ï¼Œå¤§å®¶å¯ä»¥å¯¹æ¯”ç†è§£ï¼ï¼‰</p><p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-7404e3513b6871cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="æœªçŸ¥æƒé™.png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-7f3099737f62e7b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="å¼€å¯æƒé™.png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-836d60ebb88bea77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="ç¡®å®šå®‰è£….png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-088d3c221086bffb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="å®‰è£…ç•Œé¢.png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-6ce997c33e3193a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="å®‰è£…å®Œæˆ.png"></center><br><br></p><blockquote><p>å®‰è£…ç›®å½•</p></blockquote><table><thead><tr><th>ç›®å½•/æ–‡ä»¶</th><th>æè¿°</th></tr></thead><tbody><tr><td>/system/app</td><td>ç³»ç»Ÿè‡ªå¸¦çš„åº”ç”¨ç¨‹åºï¼Œè·å¾— adb root æƒé™æ‰èƒ½åˆ é™¤ã€‚</td></tr><tr><td>/data/app</td><td>ç”¨æˆ·ç¨‹åºå®‰è£…çš„ç›®å½•ï¼Œå®‰è£…æ—¶æŠŠ apk æ–‡ä»¶å¤åˆ¶åˆ°æ­¤ç›®å½•ã€‚</td></tr><tr><td>/data/data</td><td>å­˜æ”¾åº”ç”¨ç¨‹åºçš„æ•°æ®ã€‚</td></tr><tr><td>/data/dalvik-cache</td><td>å°† apk ä¸­çš„ dex æ–‡ä»¶å®‰è£…åˆ° dalvik-cache ç›®å½•ä¸‹ï¼Œç”¨äºè™šæ‹Ÿæœºå®‰è£…çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</td></tr><tr><td>/data/system</td><td>è¯¥ç›®å½•ä¸‹çš„ packages.xml æ–‡ä»¶ç±»ä¼¼äº Window çš„æ³¨å†Œè¡¨ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯è§£æ apk æ—¶ç”± writeLP() åˆ›å»ºçš„ï¼Œé‡Œé¢è®°å½•äº†ç³»ç»Ÿçš„ permissonsï¼Œä»¥åŠæ¯ä¸ª apk çš„ nameï¼ŒcodePathï¼Œflagï¼Œtsï¼Œversion ï¼Œuserid ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸»è¦é€šè¿‡ apk çš„ AndroidManifest è§£æè·å–ï¼Œè§£æå®Œ apk åå°†æ›´æ–°ä¿¡æ¯å†™å…¥è¿™ä¸ªæ–‡ä»¶å¹¶ä¿å­˜åˆ° flashï¼Œä¸‹æ¬¡å¼€æœºçš„æ—¶å€™ç›´æ¥ä»é‡Œé¢è¯»å–ç›¸å…³ä¿¡æ¯å¹¶æ·»åŠ åˆ°å†…å­˜ç›¸å…³åˆ—è¡¨ä¸­ã€‚å½“æœ‰ apk å‡çº§ï¼Œå®‰è£…æˆ–åˆ é™¤æ—¶ä¼šæ›´æ–°è¿™ä¸ªæ–‡ä»¶ã€‚</td></tr><tr><td>/data/system/package.xml</td><td>åŒ…å«äº†è¯¥åº”ç”¨ç”³è¯·çš„æƒé™ã€ç­¾åå’Œä»£ç æ‰€åœ¨çš„ä½ç½®ç­‰ä¿¡æ¯ç³»ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½æœ‰åŒä¸€ä¸ª userldã€‚ä¹‹æ‰€ä»¥æ¯ä¸ªåº”ç”¨éƒ½è¦ä¸€ä¸ª userIdï¼Œæ˜¯å› ä¸º Android åœ¨ç³»ç»Ÿè®¾è®¡ä¸ŠæŠŠæ¯ä¸ªåº”ç”¨å½“åš Linux ç³»ç»Ÿä¸Šçš„ä¸€ä¸ªç”¨æˆ·å¯¹å¾…ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨å·²æœ‰çš„ Linux ç”¨æˆ·ç®¡ç†æœºåˆ¶æ¥è®¾è®¡ Android åº”ç”¨ï¼Œæ¯”å¦‚åº”ç”¨ç›®å½•ï¼Œåº”ç”¨æƒé™ï¼Œåº”ç”¨è¿›ç¨‹ç®¡ç†ç­‰ã€‚</td></tr><tr><td>/data/system/package.list</td><td>æŒ‡å®šäº†åº”ç”¨çš„é»˜è®¤å­˜å‚¨ä½ç½® /data/data/com.xxx.xxxã€‚</td></tr></tbody></table><h1 id="äºŒã€PackageInstaller"><a href="#äºŒã€PackageInstaller" class="headerlink" title="äºŒã€PackageInstaller"></a>äºŒã€PackageInstaller</h1><h2 id="2-1-åˆå§‹åŒ–"><a href="#2-1-åˆå§‹åŒ–" class="headerlink" title="2.1 åˆå§‹åŒ–"></a>2.1 åˆå§‹åŒ–</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼šä» Android 8.0 å¼€å§‹ç³»ç»Ÿæ˜¯é€šè¿‡å¦‚ä¸‹ä»£ç å®‰è£…æŒ‡å®šè·¯å¾„ä¸­çš„ APKï¼š</p><pre class=" language-java"><code class="language-java">Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>intent<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"file://"</span> <span class="token operator">+</span> apkfile<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Intent çš„ <code>Action</code> å±æ€§ä¸º <code>ACTION_VIEW</code>ï¼ŒType å±æ€§æŒ‡å®š <code>Intent</code> çš„æ•°æ®ç±»å‹ä¸º <code>application/vnd.android.package-archive</code>ã€‚</p><font color="#0000CD"><strong>â€œapplication/vnd.android.package-archiveâ€ æ˜¯ä»€ä¹ˆï¼Ÿ</strong></font><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> MIME_MapTable<span class="token operator">=</span><span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//{åç¼€åï¼ŒMIMEç±»å‹} </span>    <span class="token punctuation">{</span><span class="token string">".3gp"</span><span class="token punctuation">,</span>    <span class="token string">"video/3gpp"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span><span class="token string">".apk"</span><span class="token punctuation">,</span>    <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span><span class="token string">".asf"</span><span class="token punctuation">,</span>    <span class="token string">"video/x-ms-asf"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">{</span><span class="token string">".avi"</span><span class="token punctuation">,</span>    <span class="token string">"video/x-msvideo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>æˆ‘ä»¬å‘ç° <code>&quot;application/vnd.android.package-archive&quot;</code> å…¶å®å°±æ˜¯<code>æ–‡ä»¶ç±»å‹</code>ï¼Œå…·ä½“å¯¹åº” <code>apk</code> ç±»å‹ã€‚</p><p>é‚£ä¹ˆè¿™ä¸ª <code>Intent éšå¼åŒ¹é…çš„ Activity</code> æ˜¯ä»€ä¹ˆï¼Ÿè¿™è¾¹æˆ‘ä»¬ç›´æ¥å‘Šè¯‰ä½ ï¼š<font color="#FF0000"><strong>InstallStart</strong></font> ï¼ä¸ºä»€ä¹ˆï¼Ÿæºç ä¸ºè¯ï¼</p><p>ï¼ˆæºç ä¸­ï¼Œ7.0 éšå¼åŒ¹é…çš„ Activity ä¸º <font color="#FF0000"><strong>PackageInstallerActivity</strong></font> ï¼Œä¸¤è€…çš„åŒºåˆ«æˆ‘ä»¬åé¢ä¼šè®²è§£åˆ°ï¼ï¼‰ã€‚</p><pre class=" language-xml"><code class="language-xml">// packages/apps/PackageInstaller/AndroidManifest.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.InstallStart<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>excludeFromRecents</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span> <span class="token attr-name"><span class="token namespace">android:</span>priority</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.VIEW<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.INSTALL_PACKAGE<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.DEFAULT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>mimeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>application/vnd.android.package-archive<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>    ... ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span></code></pre><h2 id="2-2-InstallStart"><a href="#2-2-InstallStart" class="headerlink" title="2.2 InstallStart"></a>2.2 InstallStart</h2><p>å…¶å®ï¼Œ<code>InstallStart</code> æ˜¯ <code>PackageInstaller</code> çš„<code>å…¥å£</code>ã€‚å½“æˆ‘ä»¬è°ƒç”¨ <code>PackageInstaller</code> æ¥å®‰è£…åº”ç”¨æ—¶ä¼šè·³è½¬åˆ° <code>InstallStart</code>ï¼Œå¹¶è°ƒç”¨å®ƒçš„ <code>onCreate</code> æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallStart</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        mIPackageManager <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Intent intent <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String callingPackage <span class="token operator">=</span> <span class="token function">getCallingPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">/**         * public static final String ACTION_CONFIRM_PERMISSIONS =                                      "android.content.pm.action.CONFIRM_PERMISSIONS";         * åˆ¤æ–­ Intent çš„ Action æ˜¯å¦ä¸º CONFIRM_PERMISSIONS ;         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ACTION_CONFIRM_PERMISSIONS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æˆ‘ä»¬æ¢è®¨çš„æƒ…æ™¯ä¼šèµ°è¿™è¾¹</span>            Uri packageUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ä¿è¯ packageUri ä¸ä¸º nullï¼Œåˆ¤æ–­ packageUri çš„ Scheme åè®®æ˜¯å¦æ˜¯ content æˆ–è€… File</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">!=</span> null                     <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ContentResolver<span class="token punctuation">.</span>SCHEME_FILE<span class="token punctuation">)</span>                    <span class="token operator">||</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ContentResolver<span class="token punctuation">.</span>SCHEME_CONTENT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// è·³è½¬åˆ° InstallStaging ï¼ˆAndroid 8.0 - 9.0ï¼‰</span>                nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> InstallStaging<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">!=</span> null                <span class="token operator">&amp;&amp;</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>PackageInstallerActivity<span class="token punctuation">.</span>SCHEME_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// è·³è½¬åˆ° PackageInstallerActivityï¼ˆAndroid 7.0ï¼‰</span>                nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                Intent result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                result<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INSTALL_RESULT<span class="token punctuation">,</span>                        PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">setResult</span><span class="token punctuation">(</span>RESULT_FIRST_USER<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>                nextActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¯åŠ¨ç›¸åº”çš„ Activityï¼ˆInstallStaging æˆ–è€… PackageInstallerActivityï¼‰</span>            <span class="token function">startActivity</span><span class="token punctuation">(</span>nextActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="2-3-InstallStaging"><a href="#2-3-InstallStaging" class="headerlink" title="2.3 InstallStaging"></a>2.3 InstallStaging</h2><p>æˆ‘ä»¬æ˜¯åŸºäº Android 9.0 çš„ä»£ç è¿›è¡Œçš„åˆ†æï¼Œæ‰€ä»¥ä¼šèµ°åˆ° <code>InstallStaging</code> åˆ†æ”¯ï¼Œç»§ç»­çœ‹æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallStaging</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// This is the first onResume in a single life of the activity</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStagingTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// File does not exist, or became invalid</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStagedFile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Create file delayed to be able to show error</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å¦‚æœ File ç±»å‹çš„ mStagedFile ä¸º nullï¼Œ</span>                    <span class="token comment" spellcheck="true">// åˆ™åˆ›å»º mStagedFileï¼ŒmStagedFile ç”¨äºå­˜å‚¨ä¸´æ—¶æ•°æ®</span>                    mStagedFile <span class="token operator">=</span> TemporaryFileManager<span class="token punctuation">.</span><span class="token function">getStagedFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">showError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            mStagingTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StagingAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¯åŠ¨ StagingAsyncTask çº¿ç¨‹ï¼Œå¹¶ä¼ å…¥äº† content åè®®çš„ Uri</span>            mStagingTask<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<font color="#0000CD"><strong>InstallStaging ä¸»è¦åšäº†ä¸¤éƒ¨åˆ†å·¥ä½œ</strong></font>ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€åˆ¤æ–­ <code>mStagingTask</code> æ˜¯å¦ä¸ºç©ºï¼Œä¸»è¦ç”¨äºå­˜å‚¨ä¸´æ—¶æ•°æ®ï¼›</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€åˆ›å»ºå¹¶å¯åŠ¨ <code>StagingAsyncTask</code> çº¿ç¨‹ã€‚</p><h2 id="2-4-StagingAsyncTask"><a href="#2-4-StagingAsyncTask" class="headerlink" title="2.4 StagingAsyncTask"></a>2.4 StagingAsyncTask</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªçº¿ç¨‹æ‰€åšçš„å·¥ä½œï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// /packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStaging.java</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallStaging</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">StagingAsyncTask</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Uri<span class="token punctuation">,</span> Void<span class="token punctuation">,</span> Boolean<span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">protected</span> Boolean <span class="token function">doInBackground</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> null <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            Uri packageUri <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">(</span>InputStream in <span class="token operator">=</span> <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openInputStream</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// å°† packageUriï¼ˆcontentåè®®çš„Uriï¼‰çš„å†…å®¹å†™å…¥åˆ° mStagedFile ä¸­                 </span>                <span class="token keyword">try</span> <span class="token punctuation">(</span>OutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>mStagedFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token keyword">int</span> bytesRead<span class="token punctuation">;</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesRead <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> SecurityException <span class="token operator">|</span> IllegalStateException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Error staging apk from content URI"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span>Boolean success<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Intent installIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å¦‚æœå†™å…¥æˆåŠŸï¼Œè·³è½¬åˆ° DeleteStagedFileOnResult            </span>                installIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span>InstallStaging<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> DeleteStagedFileOnResult<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å¹¶å°† mStagedFile ä¼ è¿›å»</span>                installIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>mStagedFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>installIntent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RETURN_RESULT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    installIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                installIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">startActivity</span><span class="token punctuation">(</span>installIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>                InstallStaging<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">showError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="2-5-DeleteStagedFileOnResult"><a href="#2-5-DeleteStagedFileOnResult" class="headerlink" title="2.5 DeleteStagedFileOnResult"></a>2.5 DeleteStagedFileOnResult</h2><p><code>doInBackground</code> æ–¹æ³•ä¸­å°† <code>packageUri</code>ï¼ˆcontent åè®®çš„ Uriï¼‰çš„å†…å®¹å†™å…¥åˆ° <code>mStagedFile</code> ä¸­ï¼Œå¦‚æœå†™å…¥æˆåŠŸï¼Œ<code>onPostExecute</code> æ–¹æ³•ä¸­ä¼šè·³è½¬åˆ° <code>DeleteStagedFileOnResult</code> ä¸­ï¼Œå¹¶å°† <code>mStagedFile</code> ä¼ è¿›å»ã€‚</p><p>ç›´æ¥çœ‹ä¸‹æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeleteStagedFileOnResult</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Intent installIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è·³è½¬åˆ° PackageInstallerActivity</span>            installIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            installIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>installIntent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sourceFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setResult</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-6-å°ç»“"><a href="#2-6-å°ç»“" class="headerlink" title="2.6 å°ç»“"></a>2.6 å°ç»“</h2><p><font color="#0000CD"><strong>ç»•äº†ä¸€åœˆåˆå›åˆ°äº† PackageInstallerActivity</strong></font>ï¼Œè¿™é‡Œå¯ä»¥çœ‹å‡º <code>InstallStaging</code> ä¸»è¦èµ·äº†è½¬æ¢çš„ä½œç”¨ï¼Œå°† <code>content</code> åè®®çš„ <code>Uri</code> è½¬æ¢ä¸º <code>File</code> åè®®ï¼Œç„¶åè·³è½¬åˆ° <code>PackageInstallerActivity</code>ï¼Œæ¥ä¸‹æ¥çš„å®‰è£…æµç¨‹å°±å’Œ Android 7.0 ä¸€æ ·äº†ã€‚</p><h1 id="ä¸‰ã€PackageInstallerActivity"><a href="#ä¸‰ã€PackageInstallerActivity" class="headerlink" title="ä¸‰ã€PackageInstallerActivity"></a>ä¸‰ã€PackageInstallerActivity</h1><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¦é‡ç‚¹åˆ†æ <code>PackageInstallerActivity</code> ï¼ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œ<font color="#FF0000"><strong>PackageInstallerActivity æ‰æ˜¯åº”ç”¨å®‰è£…å™¨ PackageInstaller çœŸæ­£çš„å…¥å£ Activity</strong></font>ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹å®˜æ–¹å¯¹äºè¿™ä¸ªç±»çš„è¯´æ˜ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * This activity is launched when a new application is installed via side loading * The package is first parsed and the user is notified of parse errors via a dialog. * If the package is successfully parsed, the user is notified to turn on the install unknown * applications setting. A memory check is made at this point and the user is notified of out * of memory conditions if any. If the package is already existing on the device, * a confirmation dialog (to replace the existing package) is presented to the user. * Based on the user response the package is then installed by launching InstallAppConfirm * sub activity. All state transitions are handled in this activity. */</span><span class="token comment" spellcheck="true">/** * å½“é€šè¿‡æ¸ é“å®‰è£…ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä¼šå¯åŠ¨è¿™ä¸ª Activityã€‚ * å¦‚æœåœ¨é¦–æ¬¡è§£æè¿™ä¸ªå®‰è£…åŒ…çš„æ—¶å€™å‡ºç°è§£æé”™è¯¯ï¼Œä¼šé€šè¿‡å¯¹è¯æ¡†çš„å½¢å¼å‘Šè¯‰ç”¨æˆ·ã€‚ * å¦‚æœé¦–æ¬¡è§£æå®‰è£…åŒ…çš„æ—¶å€™ï¼ŒæˆåŠŸè§£æäº†ï¼Œåˆ™ä¼šé€šçŸ¥ç”¨æˆ·å»æ‰“å¼€"å®‰è£…æœªçŸ¥åº”ç”¨ç¨‹åºè®¾ç½®"ã€‚ * åœ¨å¯åŠ¨ Activity çš„æ—¶å€™ä¼šè¿›è¡Œå†…å­˜æ£€æŸ¥ï¼Œå¦‚æœå†…å­˜ä¸è¶³ä¼šé€šçŸ¥ç”¨æˆ·ã€‚ * å¦‚æœè¿™ä¸ªåº”ç”¨ç¨‹åºå·²ç»åœ¨è¿™ä¸ªè®¾å¤‡å®‰è£…è¿‡äº†ï¼Œåˆ™ä¼šå‘ç”¨æˆ·å¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†è¯¢é—®ç”¨æˆ·æ˜¯å¦"æ›¿æ¢ç°æœ‰åº”ç”¨ç¨‹åºçš„å®‰è£…åŒ…"ã€‚ * åŸºäºç”¨æˆ·çš„å›åº”ï¼Œç„¶åé€šè¿‡ InstallAppConfirm çš„å­ç±»æ¥å®‰è£…åº”ç”¨ç¨‹åºã€‚ * æ‰€æœ‰çŠ¶æ€çš„è½¬æ¢éƒ½æ˜¯åœ¨è¿™ Activity ä¸­å¤„ç†ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>äº†è§£å®Œäº†å®˜æ–¹è¯´æ˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŸ¥çœ‹å®ƒçš„ <code>onCreate()</code> æ–¹æ³•ï¼</p><h2 id="3-1-onCreate"><a href="#3-1-onCreate" class="headerlink" title="3.1 onCreate"></a>3.1 onCreate</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    PackageManager mPm<span class="token punctuation">;</span>    IPackageManager mIpm<span class="token punctuation">;</span>    AppOpsManager mAppOpsManager<span class="token punctuation">;</span>    PackageInstaller mInstaller<span class="token punctuation">;</span>    UserManager mUserManager<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle icicle<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>icicle<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>icicle <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mAllowUnknownSources <span class="token operator">=</span> icicle<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>ALLOW_UNKNOWN_SOURCES_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆå§‹è¯ PackageManager å¯¹è±¡ï¼šå…·ä½“ç”¨æ¥æ‰§è¡Œå®‰è£…æ“ä½œï¼Œæœ€ç»ˆçš„åŠŸèƒ½ç”± PMS æ¥å®ç°ï¼›</span>        mPm <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// åˆå§‹è¯ IPackageManager å¯¹è±¡ï¼šä¸€ä¸ª AIDL çš„æ¥å£ï¼Œç”¨äºå’Œ PMS è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼›</span>        mIpm <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// åˆå§‹åŒ– AppOpsManager å¯¹è±¡ï¼šç”¨äºæƒé™åŠ¨æ€æ£€æµ‹ï¼Œåœ¨ï¼ŒAndroid 4.3 ä¸­è¢«å¼•å…¥ï¼›</span>        mAppOpsManager <span class="token operator">=</span> <span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>APP_OPS_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// åˆå§‹åŒ– PackageInstaller å¯¹è±¡ï¼šåœ¨è¯¥å¯¹è±¡ä¸­åŒ…å«äº†å®‰è£… APK çš„åŸºæœ¬ä¿¡æ¯ï¼›</span>        mInstaller <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// åˆå§‹åŒ– UserManager å¯¹è±¡ï¼šç”¨äºå¤šç”¨æˆ·ç®¡ç†ï¼›</span>        mUserManager <span class="token operator">=</span> <span class="token punctuation">(</span>UserManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>USER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">final</span> Uri packageUri<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ACTION_CONFIRM_PERMISSIONS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¯èƒ½æ˜¯ç³»ç»Ÿçº§åˆ«çš„åº”ç”¨å®‰è£…æ—¶ï¼Œéœ€è¦æˆæƒèµ°è¿™ä¸ªæµç¨‹</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> sessionId <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_SESSION_ID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> PackageInstaller<span class="token punctuation">.</span>SessionInfo info <span class="token operator">=</span> mInstaller<span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mSessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>            packageUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>resolvedBaseCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mOriginatingURI <span class="token operator">=</span> null<span class="token punctuation">;</span>            mReferrerURI <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±æ‹‰èµ·æ¥çš„å®‰è£…ï¼Œåˆ™é»˜è®¤ sessionId ä¸º -1ï¼Œå¹¶ä¸”è·å– packageUri</span>            mSessionId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            packageUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mOriginatingURI <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>            mReferrerURI <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è¿”å› URI è§£æé”™è¯¯</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unspecified source"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¦‚æœè®¾å¤‡ä¸ºæ‰‹è¡¨ï¼Œåˆ™ä¸æ”¯æŒ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceUtils<span class="token punctuation">.</span><span class="token function">isWear</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_NOT_SUPPORTED_ON_WEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ ¹æ® Uri çš„ Scheme è¿›è¡Œé¢„å¤„ç†</span>        <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• 1 ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>        <span class="token keyword">boolean</span> wasSetUp <span class="token operator">=</span> <span class="token function">processPackageUri</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasSetUp<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æ˜¯æœªçŸ¥æ¥æºçš„åº”ç”¨ï¼Œå¦‚æœå¼€å¯å…è®¸å®‰è£…æœªçŸ¥æ¥æºé€‰é¡¹åˆ™ç›´æ¥åˆå§‹åŒ–å®‰è£…</span>        <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• 2 ğŸ’¥ ğŸ’¥ ğŸ’¥</span>        <span class="token function">checkIfAllowedAndInitiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-2-processPackageUri"><a href="#3-2-processPackageUri" class="headerlink" title="3.2 processPackageUri"></a>3.2 processPackageUri</h2><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹ <code>processPackageUri</code> æ‰€åšçš„å·¥ä½œï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processPackageUri</span><span class="token punctuation">(</span><span class="token keyword">final</span> Uri packageUri<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mPackageURI <span class="token operator">=</span> packageUri<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¾—åˆ° packageUri çš„ Scheme åè®®</span>        <span class="token keyword">final</span> String scheme <span class="token operator">=</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ ¹æ®è¿™ä¸ª Scheme åè®®åˆ†åˆ«å¯¹ package åè®®å’Œ file åè®®è¿›è¡Œå¤„ç†</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>scheme<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¤„ç† scheme ä¸º package çš„æƒ…å†µ</span>            <span class="token keyword">case</span> SCHEME_PACKAGE<span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// è·å– package å¯¹åº”çš„ Android åº”ç”¨ä¿¡æ¯ PackageInfo</span>                    <span class="token comment" spellcheck="true">// å¦‚ï¼šåº”ç”¨åç§°ï¼Œæƒé™åˆ—è¡¨ç­‰...</span>                    mPkgInfo <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                        PackageManager<span class="token punctuation">.</span>GET_PERMISSIONS                                        <span class="token operator">|</span> PackageManager<span class="token punctuation">.</span>MATCH_UNINSTALLED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// å¦‚æœæ— æ³•è·å– PackageInfo ï¼Œå¼¹å‡ºä¸€ä¸ªé”™è¯¯çš„å¯¹è¯æ¡†ï¼Œç„¶åç›´æ¥é€€å‡ºå®‰è£…</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPkgInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Requested package "</span> <span class="token operator">+</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token operator">+</span> <span class="token string">" not available. Discontinuing installation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_PACKAGE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_APK<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// åˆ›å»º AppSnipet å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°è£…äº†å¾…å®‰è£… Android åº”ç”¨çš„æ ‡é¢˜å’Œå›¾æ ‡</span>                mAppSnippet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageUtil<span class="token punctuation">.</span>AppSnippet</span><span class="token punctuation">(</span>                                  mPm<span class="token punctuation">.</span><span class="token function">getApplicationLabel</span><span class="token punctuation">(</span>mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>                                  mPm<span class="token punctuation">.</span><span class="token function">getApplicationIcon</span><span class="token punctuation">(</span>mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¤„ç† scheme ä¸º file çš„æƒ…å†µ</span>            <span class="token keyword">case</span> ContentResolver<span class="token punctuation">.</span>SCHEME_FILE<span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ ¹æ® packageUri åˆ›å»ºä¸€ä¸ªæ–°çš„ File</span>                File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// åˆ›å»º APK æ–‡ä»¶çš„åˆ†æå™¨ parsedï¼ŒğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>                PackageParser<span class="token punctuation">.</span>Package parsed <span class="token operator">=</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// è¯´æ˜è§£æé”™è¯¯ï¼Œåˆ™å¼¹å‡ºå¯¹è¯æ¡†ï¼Œå¹¶é€€å‡ºå®‰è£…</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Parse error when parsing manifest..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_PACKAGE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_APK<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// èµ°åˆ°è¿™è¾¹ï¼Œè¯´æ˜è§£ææˆåŠŸï¼Œå¯¹ parsed è¿›ä¸€æ­¥å¤„ç†å¾—åˆ°åŒ…ä¿¡æ¯ PackageInfoï¼Œè·å–æƒé™éƒ¨åˆ†</span>                mPkgInfo <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">generatePackageInfo</span><span class="token punctuation">(</span>parsed<span class="token punctuation">,</span> null<span class="token punctuation">,</span>                        PackageManager<span class="token punctuation">.</span>GET_PERMISSIONS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PackageUserState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// private PackageUtil.AppSnippet mAppSnippet; è·å– PackageUtil.AppSnippetï¼Œ</span>                <span class="token comment" spellcheck="true">// AppSnippet æ˜¯ PackageUtil çš„é™æ€å†…éƒ¨ç±»ï¼Œå†…éƒ¨å°è£…äº†iconå’Œlabelï¼›</span>                <span class="token comment" spellcheck="true">// AppSnippet ä¸­åªæœ‰ä¸¤ä¸ªå±æ€§ï¼šlableï¼ˆåº”ç”¨åç§°ï¼‰ã€iconï¼ˆåº”ç”¨å›¾æ ‡ï¼‰;</span>                <span class="token comment" spellcheck="true">// return new PackageUtil.AppSnippet(label, icon); è¿”å›çš„æ˜¯ label å’Œ icon.</span>                mAppSnippet <span class="token operator">=</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getAppSnippet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>                                                     mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯è¿™ä¸¤ä¸ªåè®®å°±ä¼šæŠ›å‡ºå¼‚å¸¸</span>            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unexpected URI scheme "</span> <span class="token operator">+</span> packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h3 id="3-2-1-PackageUtil-getPackageInfo"><a href="#3-2-1-PackageUtil-getPackageInfo" class="headerlink" title="3.2.1 PackageUtil.getPackageInfo"></a>3.2.1 PackageUtil.getPackageInfo</h3><p>ä¸Šé¢æºç ä¸­åˆ›å»º <code>APK</code> æ–‡ä»¶çš„åˆ†æå™¨ <code>parsed</code> æ—¶ï¼Œæ¶‰åŠä¸€ä¸ªé‡è¦çš„æ–¹æ³• <code>getPackageInfo()</code>ï¼Œæˆ‘ä»¬çœ‹ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageUtil.java</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageUtil</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> File sourceFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ª PackageParser å¯¹è±¡</span>        <span class="token keyword">final</span> PackageParser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        parser<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>CallbackImpl</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-3-checkIfAllowedAndInitiateInstall"><a href="#3-3-checkIfAllowedAndInitiateInstall" class="headerlink" title="3.3 checkIfAllowedAndInitiateInstall"></a>3.3 checkIfAllowedAndInitiateInstall</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ <code>checkIfAllowedAndInitiateInstall</code> åšæ‰€å·¥ä½œï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkIfAllowedAndInitiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> installAppsRestrictionSource <span class="token operator">=</span> mUserManager<span class="token punctuation">.</span><span class="token function">getUserRestrictionSource</span><span class="token punctuation">(</span>                UserManager<span class="token punctuation">.</span>DISALLOW_INSTALL_APPS<span class="token punctuation">,</span> Process<span class="token punctuation">.</span><span class="token function">myUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>installAppsRestrictionSource <span class="token operator">&amp;</span> UserManager<span class="token punctuation">.</span>RESTRICTION_SOURCE_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_INSTALL_APPS_RESTRICTED_FOR_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>installAppsRestrictionSource <span class="token operator">!=</span> UserManager<span class="token punctuation">.</span>RESTRICTION_NOT_SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>ACTION_SHOW_ADMIN_SUPPORT_DETAILS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// isInstallRequestFromUnknownSource  -->  å®‰è£…è¯·æ±‚æ˜¯å¦æ¥è‡ªä¸€ä¸ªæœªçŸ¥çš„æº</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­å¦‚æœå…è®¸å®‰è£…æœªçŸ¥æ¥æºæˆ–è€…æ ¹æ® Intent åˆ¤æ–­å¾—å‡ºè¯¥ APK ä¸æ˜¯æœªçŸ¥æ¥æº</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAllowUnknownSources <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isInstallRequestFromUnknownSource</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–å®‰è£…</span>            <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• 1 ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> unknownSourcesRestrictionSource <span class="token operator">=</span> mUserManager<span class="token punctuation">.</span>                            <span class="token function">getUserRestrictionSource</span><span class="token punctuation">(</span>                                          UserManager<span class="token punctuation">.</span>DISALLOW_INSTALL_UNKNOWN_SOURCES<span class="token punctuation">,</span>                                           Process<span class="token punctuation">.</span><span class="token function">myUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¦‚æœç®¡ç†å‘˜é™åˆ¶æ¥è‡ªæœªçŸ¥æºçš„å®‰è£…, å°±å¼¹å‡ºæç¤º Dialog</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>unknownSourcesRestrictionSource <span class="token operator">&amp;</span>                                               UserManager<span class="token punctuation">.</span>RESTRICTION_SOURCE_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_UNKNOWN_SOURCES_RESTRICTED_FOR_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>unknownSourcesRestrictionSource <span class="token operator">!=</span> UserManager<span class="token punctuation">.</span>RESTRICTION_NOT_SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>ACTION_SHOW_ADMIN_SUPPORT_DETAILS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">handleUnknownSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹æ–¹æ³• 2 ğŸ’¥ ğŸ’¥ ğŸ’¥ </span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="3-4-handleUnknownSources"><a href="#3-4-handleUnknownSources" class="headerlink" title="3.4 handleUnknownSources"></a>3.4 handleUnknownSources</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>handleUnknownSources()</code> çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleUnknownSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOriginatingPackage <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No source found for package "</span> <span class="token operator">+</span> mPkgInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_ANONYMOUS_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> appOpCode <span class="token operator">=</span>             AppOpsManager<span class="token punctuation">.</span><span class="token function">permissionToOpCode</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>REQUEST_INSTALL_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> appOpMode <span class="token operator">=</span> mAppOpsManager<span class="token punctuation">.</span><span class="token function">noteOpNoThrow</span><span class="token punctuation">(</span>appOpCode<span class="token punctuation">,</span>                                                     mOriginatingUid<span class="token punctuation">,</span> mOriginatingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>appOpMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> AppOpsManager<span class="token punctuation">.</span>MODE_DEFAULT<span class="token operator">:</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token keyword">int</span> result <span class="token operator">=</span> mIpm<span class="token punctuation">.</span><span class="token function">checkUidPermission</span><span class="token punctuation">(</span>                            Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>REQUEST_INSTALL_PACKAGES<span class="token punctuation">,</span> mOriginatingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> exc<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unable to talk to package manager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                mAppOpsManager<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span>appOpCode<span class="token punctuation">,</span> mOriginatingUid<span class="token punctuation">,</span>                        mOriginatingPackage<span class="token punctuation">,</span> AppOpsManager<span class="token punctuation">.</span>MODE_ERRORED<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// fall through</span>            <span class="token comment" spellcheck="true">// æˆ‘ä»¬çœ‹ä¸‹è¿™è¾¹ï¼Œå½“ç³»ç»Ÿé»˜è®¤ä¸å…è®¸å®‰è£…ä½ç½®æ¥æºçš„åº”ç”¨æ—¶ï¼Œä¼šå¼¹å‡ºä¸€ä¸ª Dialog ç­‰å¾…ç”¨æˆ·ç¡®è®¤</span>            <span class="token keyword">case</span> AppOpsManager<span class="token punctuation">.</span>MODE_ERRORED<span class="token operator">:</span>                <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_EXTERNAL_SOURCE_BLOCKED<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> AppOpsManager<span class="token punctuation">.</span>MODE_ALLOWED<span class="token operator">:</span>                <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h3 id="3-4-1-showDialogInner"><a href="#3-4-1-showDialogInner" class="headerlink" title="3.4.1 showDialogInner"></a>3.4.1 showDialogInner</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">showDialogInner</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        DialogFragment currentDialog <span class="token operator">=</span>                <span class="token punctuation">(</span>DialogFragment<span class="token punctuation">)</span> <span class="token function">getFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFragmentByTag</span><span class="token punctuation">(</span><span class="token string">"dialog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentDialog <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            currentDialog<span class="token punctuation">.</span><span class="token function">dismissAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ª Dialog</span>        DialogFragment newDialog <span class="token operator">=</span> <span class="token function">createDialog</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newDialog <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            newDialog<span class="token punctuation">.</span><span class="token function">showAllowingStateLoss</span><span class="token punctuation">(</span><span class="token function">getFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dialog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h3 id="3-4-2-createDialog"><a href="#3-4-2-createDialog" class="headerlink" title="3.4.2 createDialog"></a>3.4.2 createDialog</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> DialogFragment <span class="token function">createDialog</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">case</span> DLG_EXTERNAL_SOURCE_BLOCKED<span class="token operator">:</span>                <span class="token keyword">return</span> ExternalSourcesBlockedDialog<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>mOriginatingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> DLG_ANONYMOUS_SOURCE<span class="token operator">:</span>                <span class="token keyword">return</span> AnonymousSourceDialog<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h3 id="3-4-3-ExternalSourcesBlockedDialog"><a href="#3-4-3-ExternalSourcesBlockedDialog" class="headerlink" title="3.4.3 ExternalSourcesBlockedDialog"></a>3.4.3 ExternalSourcesBlockedDialog</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">/**     * An error dialog shown when external sources are not allowed     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExternalSourcesBlockedDialog</span> <span class="token keyword">extends</span> <span class="token class-name">AppErrorDialog</span> <span class="token punctuation">{</span>        <span class="token keyword">static</span> AppErrorDialog <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String originationPkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            ExternalSourcesBlockedDialog dialog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExternalSourcesBlockedDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            dialog<span class="token punctuation">.</span><span class="token function">setArgument</span><span class="token punctuation">(</span>originationPkg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> dialog<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">protected</span> Dialog <span class="token function">createDialog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> CharSequence argument<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                PackageManager pm <span class="token operator">=</span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                ApplicationInfo sourceInfo <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AlertDialog<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span><span class="token function">getApplicationLabel</span><span class="token punctuation">(</span>sourceInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span><span class="token function">getApplicationIcon</span><span class="token punctuation">(</span>sourceInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token comment" spellcheck="true">// untrusted_external_source_warningï¼šå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œå·²ç¦æ­¢æ‚¨çš„æ‰‹æœºå®‰è£…</span>                        <span class="token comment" spellcheck="true">// æ¥è‡ªæ­¤æ¥æºçš„æœªçŸ¥åº”ç”¨ï¼Œå¯¹åº”æ–‡ç« å¼€å¤´çš„æ“ä½œå›¾</span>                        <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>untrusted_external_source_warning<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setPositiveButton</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>external_sources_settings<span class="token punctuation">,</span>                                <span class="token punctuation">(</span>dialog<span class="token punctuation">,</span> which<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                                    Intent settingsIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    settingsIntent<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>                                            Settings<span class="token punctuation">.</span>ACTION_MANAGE_UNKNOWN_APP_SOURCES<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token keyword">final</span> Uri packageUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"package:"</span> <span class="token operator">+</span> argument<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    settingsIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                                        <span class="token comment" spellcheck="true">// ExternalSourcesDetails.java</span>                                        <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span>settingsIntent<span class="token punctuation">,</span>                                                REQUEST_TRUST_EXTERNAL_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ActivityNotFoundException</span> exc<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                                    <span class="token punctuation">}</span>                                <span class="token punctuation">}</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setNegativeButton</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>cancel<span class="token punctuation">,</span>                                <span class="token punctuation">(</span>dialog<span class="token punctuation">,</span> which<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Did not find app info for "</span> <span class="token operator">+</span> argument<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-5-initiateInstall"><a href="#3-5-initiateInstall" class="headerlink" title="3.5 initiateInstall"></a>3.5 initiateInstall</h2><p>è§£å†³äº† <code>handleUnknownSources</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹é—ç•™çš„ <code>initiateInstall</code> æ–¹æ³•çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­å¦‚æœå…è®¸å®‰è£…æœªçŸ¥æ¥æºæˆ–è€…æ ¹æ® Intent åˆ¤æ–­å¾—å‡ºè¯¥ APK ä¸æ˜¯æœªçŸ¥æ¥æº</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¾—åˆ°åŒ…å</span>        String pkgName <span class="token operator">=</span> mPkgInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ˜¯å¦æœ‰åŒååº”ç”¨å·²ç»å®‰è£…ä¸Šå»äº†ï¼Œåœ¨æ­¤å®‰è£…åˆ™è¢«è®¤ä¸ºæ˜¯æ›¿æ¢å®‰è£…</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> oldName <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">canonicalToCurrentPackageNames</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> pkgName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> oldName<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> oldName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            pkgName <span class="token operator">=</span> oldName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            mPkgInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkgName<span class="token punctuation">;</span>            mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkgName<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ£€æŸ¥è¿™ä¸ªåŒ…æ˜¯å¦å·²å®‰è£…ï¼Œå¦‚æœè¦æ›¿æ¢ï¼Œåˆ™æ˜¾ç¤ºæ›¿æ¢å¯¹è¯æ¡†</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// è·å–è®¾å¤‡ä¸Šçš„æ®‹å­˜æ•°æ®ï¼Œå¹¶ä¸”æ ‡è®°ä¸º â€œinstalledâ€ çš„ï¼Œå®é™…ä¸Šå·²ç»è¢«å¸è½½çš„åº”ç”¨</span>            mAppInfo <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>                    PackageManager<span class="token punctuation">.</span>MATCH_UNINSTALLED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mAppInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_INSTALLED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å¦‚æœåº”ç”¨æ˜¯è¢«å¸è½½çš„ï¼Œä½†æ˜¯åˆæ˜¯è¢«æ ‡è¯†æˆå®‰è£…è¿‡çš„ï¼Œåˆ™è®¤ä¸ºæ˜¯æ–°å®‰è£…</span>                mAppInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mAppInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ—å‡ºæƒé™åˆ—è¡¨ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤å®‰è£…</span>        <span class="token function">startInstallConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<font color="#0000CD"><strong>initiateInstall ä¸»è¦åšäº†ä¸‰ä»¶äº‹</strong></font>ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ˜¯åŒåå®‰è£…ï¼Œå¦‚æœæ˜¯åˆ™åç»­æ˜¯æ›¿æ¢å®‰è£…ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€æ£€æŸ¥è®¾å¤‡ä¸Šæ˜¯å¦å·²ç»å®‰è£…äº†è¿™ä¸ªå®‰è£…åŒ…ï¼Œå¦‚æœæ˜¯ï¼Œåé¢æ˜¯æ›¿æ¢å®‰è£…ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€è°ƒç”¨ <code>startInstallConfirm()</code> ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å®‰è£…çš„æ ¸å¿ƒä»£ç ã€‚</p><h2 id="3-6-startInstallConfirm"><a href="#3-6-startInstallConfirm" class="headerlink" title="3.6 startInstallConfirm"></a>3.6 startInstallConfirm</h2><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹ <code>startInstallConfirm()</code> æ–¹æ³•é‡Œé¢çš„å…·ä½“å®ç°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInstallConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// We might need to show permissions, load layout with permissions</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm_perm_update<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm_perm<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">(</span><span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>install_confirm_question<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question<span class="token punctuation">)</span><span class="token punctuation">;</span>        TabHost tabHost <span class="token operator">=</span> <span class="token punctuation">(</span>TabHost<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tabhost<span class="token punctuation">)</span><span class="token punctuation">;</span>        tabHost<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ViewPager viewPager <span class="token operator">=</span> <span class="token punctuation">(</span>ViewPager<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>pager<span class="token punctuation">)</span><span class="token punctuation">;</span>        TabsAdapter adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TabsAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tabHost<span class="token punctuation">,</span> viewPager<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ ¹æ® sdk ç‰ˆæœ¬æ¥åˆ¤æ–­ app æ˜¯å¦æ”¯æŒè¿è¡Œæ—¶æƒé™</span>        <span class="token comment" spellcheck="true">// å¦‚æœ app æ”¯æŒè¿è¡Œæ—¶æƒé™ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæ–°çš„è¿è¡Œæ—¶æƒé™</span>        <span class="token keyword">boolean</span> supportsRuntimePermissions <span class="token operator">=</span> mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion                <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>M<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ˜¾ç¤ºæƒé™åˆ—è¡¨çš„å˜é‡ï¼Œtrueï¼šæ˜¾ç¤ºæƒé™åˆ—è¡¨ï¼Œfalseï¼šæœªæ˜¾ç¤ºæƒé™åˆ—è¡¨</span>        <span class="token keyword">boolean</span> permVisible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        mScrollView <span class="token operator">=</span> null<span class="token punctuation">;</span>        mOkCanInstall <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> msg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// perms è¿™ä¸ªå¯¹è±¡åŒ…æ‹¬äº†è¯¥åº”ç”¨çš„ç”¨æˆ·çš„ uid ä»¥åŠç›¸åº”çš„ä¸€äº›æƒé™ï¼Œä»¥åŠæƒé™ç»„ä¿¡æ¯</span>        AppSecurityPermissions perms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppSecurityPermissions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mPkgInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è·å–éšç§ç›¸å…³æƒé™çš„æ•°é‡</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> perms<span class="token punctuation">.</span><span class="token function">getPermissionCount</span><span class="token punctuation">(</span>AppSecurityPermissions<span class="token punctuation">.</span>WHICH_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦ä¸ºå·²ç»å®‰è£…è¿‡çš„åº”ç”¨</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœå·²ç»å®‰è£…è¿‡åˆ™ç»§ç»­åˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿåº”ç”¨</span>            msg <span class="token operator">=</span> <span class="token punctuation">(</span>mAppInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>                    <span class="token operator">?</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update_system                    <span class="token operator">:</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ç”¨æ¥æ˜¾ç¤ºæƒé™åˆ—è¡¨çš„ scrollview</span>            mScrollView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CaffeinatedScrollView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¾ç¤ºçš„å†…å®¹è¶…è¿‡äº† mScrollView ï¼Œåˆ™å°±ä¼šæŠ˜å å¯ä»¥æ»šåŠ¨</span>            mScrollView<span class="token punctuation">.</span><span class="token function">setFillViewport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> newPermissionsFound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsRuntimePermissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// é’ˆå¯¹æ›´æ–°åº”ç”¨ç¨‹åºç›¸å¯¹äºæ—§ç‰ˆæœ¬è€Œåˆ¤æ–­æ˜¯å¦åŠ å…¥æ–°çš„æƒé™</span>                <span class="token comment" spellcheck="true">// AppSecurityPermissions.WHICH_NEW  -->  æ–°åŠ å…¥çš„æƒé™</span>                newPermissionsFound <span class="token operator">=</span>                        <span class="token punctuation">(</span>perms<span class="token punctuation">.</span><span class="token function">getPermissionCount</span><span class="token punctuation">(</span>AppSecurityPermissions<span class="token punctuation">.</span>WHICH_NEW<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>newPermissionsFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å°†æ–°çš„æƒé™åˆ—è¡¨è§†é¢‘æ·»åŠ åˆ°æ»šåŠ¨è§†å›¾ä¸­</span>                    permVisible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è°ƒç”¨ AppSecurityPermissions çš„ getPermissionsView æ–¹æ³•æ¥è·å–</span>                    <span class="token comment" spellcheck="true">// PermissionItemViewï¼Œå°† PermissionItemView æ·»åŠ åˆ° </span>                    <span class="token comment" spellcheck="true">// CaffeinatedScrollViewï¼Œè¿™æ ·å®‰è£…è¯¥ APK éœ€è¦è®¿é—®çš„</span>                    <span class="token comment" spellcheck="true">// ç³»ç»Ÿæƒé™å°±å¯ä»¥å…¨éƒ¨çš„å±•ç¤ºå‡ºæ¥äº†</span>                    mScrollView<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>perms<span class="token punctuation">.</span><span class="token function">getPermissionsView</span><span class="token punctuation">(</span>                            AppSecurityPermissions<span class="token punctuation">.</span>WHICH_NEW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsRuntimePermissions <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newPermissionsFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å¦‚æœæ—¢ä¸æ”¯æŒå¯è¿è¡Œæƒé™é¡¹ä¹Ÿæ²¡æœ‰æ–°æƒé™å‘ç°ï¼Œ</span>                <span class="token comment" spellcheck="true">// åˆ™æç¤ºæ²¡æœ‰æ–°æƒé™ï¼ˆæ²¡æœ‰è®¾ç½®ä»»ä½•æƒé™ï¼Œåªæ˜¾ç¤ºåº”ç”¨ç¨‹åºåç§°å’Œå›¾æ ‡ï¼‰</span>                LayoutInflater inflater <span class="token operator">=</span> <span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">)</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>                        Context<span class="token punctuation">.</span>LAYOUT_INFLATER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>                TextView label <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span>inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>label<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                label<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>no_new_perms<span class="token punctuation">)</span><span class="token punctuation">;</span>                mScrollView<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            adapter<span class="token punctuation">.</span><span class="token function">addTab</span><span class="token punctuation">(</span>tabHost<span class="token punctuation">.</span><span class="token function">newTabSpec</span><span class="token punctuation">(</span>TAB_ID_NEW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIndicator</span><span class="token punctuation">(</span>                    <span class="token function">getText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>newPerms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mScrollView<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¦‚æœè‡³å°‘è®¾ç½®äº†ä¸€ä¸ªæƒé™</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsRuntimePermissions <span class="token operator">&amp;&amp;</span> N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            permVisible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            LayoutInflater inflater <span class="token operator">=</span> <span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">)</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>                    Context<span class="token punctuation">.</span>LAYOUT_INFLATER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è§£ææƒé™åˆ—è¡¨çš„è§†å›¾</span>            View root <span class="token operator">=</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>permissions_list<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mScrollView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mScrollView <span class="token operator">=</span> <span class="token punctuation">(</span>CaffeinatedScrollView<span class="token punctuation">)</span>root<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>scrollview<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// æ·»åŠ åˆ°æƒé™åˆ—è¡¨çš„è§†å›¾</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>ViewGroup<span class="token punctuation">)</span>root<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>permission_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>                        perms<span class="token punctuation">.</span><span class="token function">getPermissionsView</span><span class="token punctuation">(</span>AppSecurityPermissions<span class="token punctuation">.</span>WHICH_ALL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            adapter<span class="token punctuation">.</span><span class="token function">addTab</span><span class="token punctuation">(</span>tabHost<span class="token punctuation">.</span><span class="token function">newTabSpec</span><span class="token punctuation">(</span>TAB_ID_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIndicator</span><span class="token punctuation">(</span>                    <span class="token function">getText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>allPerms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// é»˜è®¤ä¸º falseï¼Œå¦‚æœæœ‰æ–°çš„æƒé™ä¼šç½®ä¸º true</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">/*                 * æ›´æ–°å®‰è£…åŒ…ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•æƒé™è¦æ±‚ï¼Œä¼šèµ°è¿™è¾¹çš„é€»è¾‘                 * æ ¹æ®æ˜¯å¦ä¸ºå†…ç½®åº”ç”¨ï¼Œåšä¸åŒçš„å­—ä¸²æé†’                 * install_confirm_question_update_system_no_permsï¼šç³»ç»Ÿåº”ç”¨                 * install_confirm_question_update_no_permsï¼šéç³»ç»Ÿåº”ç”¨                 */</span>                msg <span class="token operator">=</span> <span class="token punctuation">(</span>mAppInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>                        <span class="token operator">?</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update_system_no_perms                        <span class="token operator">:</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update_no_perms<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ˜¯æ–°å®‰è£…çš„ app å¹¶ä¸”æ²¡æœ‰æƒé™åˆ—è¡¨</span>                msg <span class="token operator">=</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_no_perms<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// è®¾ç½®ç›¸åº”çš„ UI</span>            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mScrollView <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>TextView<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>install_confirm_question<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScrollView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// There is nothing to scroll view, so the ok button is immediately</span>            <span class="token comment" spellcheck="true">// set to install.</span>            mOk<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install<span class="token punctuation">)</span><span class="token punctuation">;</span>            mOkCanInstall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            mScrollView<span class="token punctuation">.</span><span class="token function">setFullScrollAction</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token annotation punctuation">@Override</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mOk<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install<span class="token punctuation">)</span><span class="token punctuation">;</span>                    mOkCanInstall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªæ–¹æ³•å…¶å®ä¸»è¦æ˜¯æ ¹æ®ä¸åŒçš„æƒ…å†µæ¥è®¾ç½®ç›¸åº”çš„ <code>UI</code>ï¼Œä¸»è¦æ˜¯å°†å®‰è£…åŒ…åˆ†ä¸º<code>æ–°å®‰è£…</code>å’Œ<code>æ›´æ–°å®‰è£…</code>ï¼Œåœ¨æ›´æ–°å®‰è£…é‡Œé¢åˆåˆ†ä¸º<code>ç³»ç»Ÿåº”ç”¨</code>å’Œ<code>éç³»ç»Ÿåº”ç”¨</code>ï¼Œç„¶åæ ¹æ®ä¸åŒçš„æƒ…å†µæ¥æ˜¾ç¤ºä¸åŒçš„ <code>UI</code>ï¼Œ<code>UI</code> è¿™å—ä¸»è¦æ˜¯é€šè¿‡ <code>getPermissionsView</code> æ–¹æ³•æ¥è·å–ä¸åŒçš„æƒé™ <code>View</code>ã€‚</p><h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p><strong>PackageInstaller åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€æ ¹æ® <code>Uri</code> çš„ <code>Scheme</code> åè®®ä¸åŒï¼Œè·³è½¬åˆ°ä¸åŒçš„ç•Œé¢ï¼Œ<code>content</code> åè®®è·³è½¬åˆ° <code>InstallStart</code>ï¼Œå…¶ä»–çš„è·³è½¬åˆ° <code>PackageInstallerActivity</code>ã€‚æœ¬æ–‡åº”ç”¨åœºæ™¯ä¸­ï¼Œå¦‚æœæ˜¯ <code>Android 7.0</code> ä»¥åŠæ›´é«˜ç‰ˆæœ¬ä¼šè·³è½¬åˆ° <code>InstallStart</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€<code>InstallStart</code> å°† <code>content</code> åè®®çš„ <code>Uri è½¬æ¢</code>ä¸º <code>File åè®®</code>ï¼Œç„¶åè·³è½¬åˆ° <code>PackageInstallerActivity</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€<code>PackageInstallerActivity</code> ä¼šåˆ†åˆ«å¯¹ <code>package åè®®</code> å’Œ <code>file åè®®</code> çš„ <code>Uri</code> è¿›è¡Œå¤„ç†ï¼Œå¦‚æœæ˜¯ <code>file åè®®</code>ä¼šè§£æ <code>APK</code> æ–‡ä»¶å¾—åˆ°åŒ…ä¿¡æ¯ <code>PackageInfo</code>ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;4ã€<code>PackageInstallerActivity</code> ä¸­ä¼šå¯¹<code>æœªçŸ¥æ¥æº</code>è¿›è¡Œå¤„ç†ï¼Œå¦‚æœ<code>å…è®¸å®‰è£…æœªçŸ¥æ¥æº</code>æˆ–è€…æ ¹æ® <code>Intent</code> åˆ¤æ–­å¾—å‡ºè¯¥ <code>APK ä¸æ˜¯æœªçŸ¥æ¥æº</code>ï¼Œå°±ä¼š<code>åˆå§‹åŒ–å®‰è£…ç¡®è®¤ç•Œé¢</code>ï¼Œå¦‚æœç®¡ç†å‘˜<code>é™åˆ¶æ¥è‡ªæœªçŸ¥æºçš„å®‰è£…</code>, å°±å¼¹å‡ºæç¤º <code>Dialog</code> æˆ–è€…è·³è½¬åˆ°è®¾ç½®ç•Œé¢ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="http://liuwangshu.cn/framework/pms/1-packageinstaller-initialize.html" target="_blank" rel="noopener">AndroidåŒ…ç®¡ç†æœºåˆ¶ï¼ˆä¸€ï¼‰PackageInstallerçš„åˆå§‹åŒ–</a><br>&nbsp;ğŸ“• 02. <a href="https://www.cnblogs.com/ouyanliu/articles/7100682.html" target="_blank" rel="noopener">android 7.0 å®‰è£…å™¨å®‰è£…è¿‡ç¨‹åˆ†æ</a><br>&nbsp;ğŸ“• 03. <a href="https://www.jianshu.com/p/cbf8e73f41ed" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£11â€”â€”æ™®é€šåº”ç”¨å®‰è£…ç®€ä»‹</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/10/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%883%EF%BC%89%E4%B9%8B%20PackageManager/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ3ï¼‰- PackageManager</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/19/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%885%EF%BC%89%E4%B9%8B%20PackageParser/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ5ï¼‰- PackageParser</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
            <tag> PackageInstaller </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</title>
      <link href="/2019/01/12/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-3-packagemanager/"/>
      <url>/2019/01/12/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-3-packagemanager/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† PackageManager åŸç†ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€ç»†åŒ–æºç ï¼Œæ·»åŠ æ›´ä¸ºè¯¦ç»†çš„æ³¨é‡Šè¯´æ˜ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">3ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">Context.java</font></td><td>frameworks/base/core/java/android/content/Context.java</td></tr><tr><td><font color="#D15FEE">ContextImpl.java</font></td><td>frameworks/base/core/java/android/app/ContextImpl.java</td></tr><tr><td><font color="#D15FEE">ActivityThread.java</font></td><td>frameworks/base/core/java/android/app/ActivityThread.java</td></tr><tr><td><font color="#D15FEE">PackageManager.java</font></td><td>frameworks/base/core/java/android/content/pm/PackageManager.java</td></tr><tr><td><font color="#D15FEE">ApplicationPackageManager.java</font></td><td>frameworks/base/core/java/android/app/ApplicationPackageManager.java</td></tr></tbody></table><h1 id="äºŒã€PackageManager"><a href="#äºŒã€PackageManager" class="headerlink" title="äºŒã€PackageManager"></a>äºŒã€PackageManager</h1><h2 id="2-1-ç®€ä»‹"><a href="#2-1-ç®€ä»‹" class="headerlink" title="2.1 ç®€ä»‹"></a>2.1 ç®€ä»‹</h2><p>PackageManager æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Class for retrieving various kinds of information related to the application * packages that are currently installed on the device. * * You can find this class through {@link Context#getPackageManager}. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span></code></pre><p>ä»æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼š<code>PackageManager</code> è¿™ä¸ªç±»æ˜¯æ£€æµ‹å½“å‰å·²ç»å®‰è£…åœ¨å½“å‰è®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºåŒ…çš„ä¿¡æ¯ã€‚ä½ å¯ä»¥è°ƒç”¨ Context ç±»çš„ <code>getPackageManager()</code>æ–¹æ³•æ¥è·å– <code>PackageManager</code>ã€‚</p><h2 id="2-2-å®‰è£…åŸç†"><a href="#2-2-å®‰è£…åŸç†" class="headerlink" title="2.2 å®‰è£…åŸç†"></a>2.2 å®‰è£…åŸç†</h2><p><strong>PackageManager æ˜¯ä¸€ä¸ªå®é™…ä¸Šç®¡ç†åº”ç”¨ç¨‹åºå®‰è£…ã€å¸è½½å’Œå‡çº§çš„ API</strong>ã€‚</p><p>å½“æˆ‘ä»¬å®‰è£… APK æ–‡ä»¶æ—¶ï¼ŒPackageManager ä¼šè§£æ APK åŒ…æ–‡ä»¶å’Œæ˜¾ç¤ºç¡®è®¤ä¿¡æ¯ã€‚</p><p>å½“æˆ‘ä»¬ç‚¹å‡» OK æŒ‰é’®åï¼ŒPackageManager ä¼šè°ƒç”¨ä¸€ä¸ªå« â€œInstallPackageâ€ çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ 4 ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ uriã€installFlagsã€observerã€installPackagenameã€‚</p><p>PackageManager ä¼šå¯åŠ¨ä¸€ä¸ªå« â€œpackageâ€ çš„ servcie æœåŠ¡ï¼Œç°åœ¨æ‰€æœ‰æ¨¡ç³Šçš„ä¸œè¥¿ä¼šå‘ç”Ÿåœ¨è¿™ä¸ª service ä¸­ã€‚</p><p>ï¼ˆ<strong>ä» Android 8.1 ä¹‹åçš„æºç ä¸­å·²ç»å¼ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå…·ä½“ç»†èŠ‚å¾€ä¸‹çœ‹ï¼</strong>ï¼‰</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-f195e3a3c47103fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å®‰è£…åŸç†å›¾ï¼ˆAndroid 8.0ï¼‰(æµç¨‹å›¾åæœŸé‡æ–°æ›´æ–°).png"></center><p><br></p><h2 id="2-3-å®ç°åŠŸèƒ½"><a href="#2-3-å®ç°åŠŸèƒ½" class="headerlink" title="2.3 å®ç°åŠŸèƒ½"></a>2.3 å®ç°åŠŸèƒ½</h2><p><strong>æŠ½è±¡ç±» PackageManager æä¾›äº†çš„åŠŸèƒ½ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€å®‰è£…ã€å¸è½½åº”ç”¨<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€æŸ¥è¯¢ permission ç›¸å…³ä¿¡æ¯<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€æŸ¥è¯¢ Application ç›¸å…³ä¿¡æ¯(applicationã€activityã€receiverã€serviceã€provider åŠç›¸åº”å±æ€§ç­‰)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;4ã€æŸ¥è¯¢å·²å®‰è£…åº”ç”¨<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;5ã€å¢åŠ ã€åˆ é™¤ permission<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;6ã€æ¸…é™¤ç”¨æˆ·æ•°æ®ã€ç¼“å­˜ã€ä»£ç ç­‰</p><h2 id="2-4-æŠ½è±¡æ–¹æ³•"><a href="#2-4-æŠ½è±¡æ–¹æ³•" class="headerlink" title="2.4 æŠ½è±¡æ–¹æ³•"></a>2.4 æŠ½è±¡æ–¹æ³•</h2><p><strong>æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æŠ½è±¡æ–¹æ³•ï¼š</strong></p><blockquote><p>getPackageInfo()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * é€šè¿‡åŒ…åè·å–è¯¥åŒ…åå¯¹åº”çš„åº”ç”¨ç¨‹åºçš„ PackageInfo å¯¹è±¡ï¼Œ * PackageInfo ç±»åŒ…å«äº†ä» AndroidManifest.xml æ–‡ä»¶ä¸­æ”¶é›†çš„æ‰€æœ‰ä¿¡æ¯ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> PackageInfo <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">,</span>                                 <span class="token annotation punctuation">@PackageInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>getApplicationInfo()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æ ¹æ®åŒ…åè¿”å›å…¶å¯¹åº”çš„ ApplicationInfo ä¿¡æ¯ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> ApplicationInfo <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">,</span>                            <span class="token annotation punctuation">@ApplicationInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>getActivityInfo()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æ£€ç´¢å‡ºä¸€ä¸ªç‰¹å®šçš„ Activity ç±»çš„æ‰€æœ‰ä¿¡æ¯ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> ActivityInfo <span class="token function">getActivityInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>                              <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>getReceiverInfo()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æ£€ç´¢å‡ºä¸€ä¸ªç‰¹å®šçš„ Receiver ç±»çš„æ‰€æœ‰ä¿¡æ¯(è¿™é‡Œä¸»è¦æŒ‡ ActivityInfo)ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> ActivityInfo <span class="token function">getReceiverInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>                              <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>getServiceInfo()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æ£€ç´¢å‡ºä¸€ä¸ªç‰¹å®šçš„ Service ç±»çš„æ‰€æœ‰ä¿¡æ¯(è¿™é‡Œä¸»è¦æŒ‡ ServiceInfo)ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> ServiceInfo <span class="token function">getServiceInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>                              <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>getProviderInfo()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æ£€ç´¢å‡ºä¸€ä¸ªç‰¹å®šçš„ content provider ç±»çš„æ‰€æœ‰ä¿¡æ¯(è¿™é‡Œä¸»è¦æŒ‡ ProviderInfo)ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> ProviderInfo <span class="token function">getProviderInfo</span><span class="token punctuation">(</span>ComponentName component<span class="token punctuation">,</span>                              <span class="token annotation punctuation">@ComponentInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>getInstalledPackages()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * è·å–è®¾å¤‡ä¸Šå®‰è£…çš„æ‰€æœ‰è½¯ä»¶åŒ…ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> List<span class="token operator">&lt;</span>PackageInfo<span class="token operator">></span> <span class="token function">getInstalledPackages</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PackageInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>currentToCanonicalPackageNames()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * ä»è®¾å¤‡ä¸Šä½¿ç”¨å½“å‰åŒ…åæ˜ å°„åˆ°è¯¥è½¯ä»¶åŒ…åçš„å½“å‰è§„èŒƒåç§°ï¼Œ * å¦‚æœä¿®æ”¹åŒ…åä¼šç”¨åˆ°ï¼Œæ²¡æœ‰ä¿®æ”¹è¿‡åŒ…åä¸€èˆ¬ä¸ä¼šç”¨åˆ°ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">currentToCanonicalPackageNames</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>canonicalToCurrentPackageNames()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * å°†è½¯ä»¶åŒ…è§„èŒƒåç§°æ˜ å°„åˆ°è®¾å¤‡ä¸Šæ­£åœ¨ä½¿ç”¨çš„å½“å‰åç§°ï¼Œ * canonicalToCurrentPackageNames() å’Œ currentToCanonicalPackageNames() æ–¹æ³•æ˜¯ç›¸åçš„ä¸¤ä¸ªæ–¹æ³• */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">canonicalToCurrentPackageNames</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>getPermissionInfo()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æ£€æµ‹å‡ºæˆ‘ä»¬æƒ³è¦çŸ¥é“çš„æ‰€æœ‰å…³äºæƒé™çš„ä¿¡æ¯ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> PermissionInfo <span class="token function">getPermissionInfo</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token annotation punctuation">@PermissionInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>                                                             <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>queryPermissionsByGroup()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æŸ¥è¯¢ä¸ç‰¹å®šç»„ç›¸å…³çš„æ‰€æœ‰æƒé™ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> List<span class="token operator">&lt;</span>PermissionInfo<span class="token operator">></span> <span class="token function">queryPermissionsByGroup</span><span class="token punctuation">(</span>String group<span class="token punctuation">,</span>                             <span class="token annotation punctuation">@PermissionInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><blockquote><p>getAllPermissionGroups()</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * æ£€ç´¢å‡ºç³»ç»Ÿä¸­æ‰€æœ‰å·²çŸ¥çš„æƒé™ã€‚ */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> List<span class="token operator">&lt;</span>PermissionGroupInfo<span class="token operator">></span> <span class="token function">getAllPermissionGroups</span><span class="token punctuation">(</span>                             <span class="token annotation punctuation">@PermissionGroupInfoFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>é™¤äº†ä¸Šé¢åˆ—ä¸¾å‡ºæ¥çš„æ–¹æ³•ä»¥å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–æŠ½è±¡æ–¹æ³•ï¼Œè¿™è¾¹ä¸å†ä¸€ä¸€åˆ—ä¸¾å‡ºæ¥ï¼Œå¦‚æœåé¢åˆ†æé‡åˆ°ä¼šå†å•ç‹¬æ‹¿å‡ºæ¥åˆ†æï¼</p><h2 id="2-5-å®‰è£…æ–¹æ³•"><a href="#2-5-å®‰è£…æ–¹æ³•" class="headerlink" title="2.5 å®‰è£…æ–¹æ³•"></a>2.5 å®‰è£…æ–¹æ³•</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ PackageManager ä¸­å…³äºå®‰è£…çš„å‡ ä¸ªæ–¹æ³•ï¼</p><blockquote><p>InstallPackageï¼ˆå¼ƒç”¨ï¼‰</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * packageURIï¼šè¡¨ç¤ºå®‰è£…çš„è·¯å¾„ï¼Œå¯ä»¥æ˜¯ "file:" æˆ–è€… "content:" çš„ URI * observerï¼š  ä¸€ä¸ªå›è°ƒçš„è§‚å¯Ÿè€…ï¼Œæœ‰äº†è¿™ä¸ªè§‚å¯Ÿè€…ï¼Œå°±å¯ä»¥åœ¨è½¯ä»¶åŒ…å®‰è£…å®Œæˆåå¾—åˆ°å®‰è£…ç»“æœçš„é€šçŸ¥ã€‚ *             å¦‚æœå®‰è£…å®Œæˆä¼šè°ƒç”¨è¿™ä¸ªè§‚å¯Ÿè€… IPackageInstallObserver çš„ packageInstalled(Stringï¼Œint)æ–¹æ³•ï¼Œobserverè¿™ä¸ªå…¥å‚ä¸èƒ½ä¸ºç©ºã€‚ * flagsï¼š     æ ‡å¿—ä½å‚æ•° * nstallerPackageNameï¼šæ­£åœ¨è¿›è¡Œå®‰è£…çš„å®‰è£…åŒ…åŒ…å */</span><span class="token comment" spellcheck="true">/** * @deprecated replaced by {@link PackageInstaller} * @hide */</span><span class="token annotation punctuation">@Deprecated</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">installPackage</span><span class="token punctuation">(</span>      <span class="token comment" spellcheck="true">// å¼ƒç”¨</span>        Uri packageURI<span class="token punctuation">,</span>        IPackageInstallObserver observer<span class="token punctuation">,</span>        <span class="token annotation punctuation">@InstallFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>        String installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @deprecated replaced by {@link PackageInstaller} * @hide */</span><span class="token annotation punctuation">@Deprecated</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">installPackage</span><span class="token punctuation">(</span>      <span class="token comment" spellcheck="true">// å¼ƒç”¨</span>        Uri packageURI<span class="token punctuation">,</span>        PackageInstallObserver observer<span class="token punctuation">,</span>        <span class="token annotation punctuation">@InstallFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>        String installerPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>ä» 8.1 å¼€å§‹ï¼Œå·²ç»å¼ƒç”¨äº† <code>installPackage()</code> æ–¹æ³•</strong>ï¼ˆæºç ä¸­å·²ç»å»é™¤ï¼‰ï¼Œè€Œæ˜¯<strong>ä½¿ç”¨ <code>PackageInstaller</code> æ‰§è¡Œåº”ç”¨çš„å®‰è£…ã€å‡çº§å’Œåˆ é™¤æ“ä½œ</strong>ã€‚</p><blockquote><p>getPackageInstaller</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Return interface that offers the ability to install, upgrade, and remove * applications on the device. */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token annotation punctuation">@NonNull</span> PackageInstaller <span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>installExistingPackage</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * If there is already an application with the given package name installed * on the system for other users, also install it for the calling user. * @hide */</span><span class="token annotation punctuation">@SystemApi</span>   <span class="token comment" spellcheck="true">// ç³»ç»Ÿ API</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">installExistingPackage</span><span class="token punctuation">(</span>String packageName<span class="token punctuation">)</span> <span class="token keyword">throws</span> NameNotFoundException<span class="token punctuation">;</span></code></pre><p>é€šè¿‡æ³¨é‡Šå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ–¹æ³•çš„ç”¨é€”ï¼šå¦‚æœç³»ç»Ÿä¸Šå·²ç»å®‰è£…ç›¸åŒåŒ…åçš„åº”ç”¨ç¨‹åºï¼Œåˆ™é‡æ–°å®‰è£…ã€‚</p><h2 id="2-6-å…·ä½“å®ç°ç±»"><a href="#2-6-å…·ä½“å®ç°ç±»" class="headerlink" title="2.6 å…·ä½“å®ç°ç±»"></a>2.6 å…·ä½“å®ç°ç±»</h2><p>æˆ‘ä»¬çŸ¥é“ PackageManager æ˜¯ä¸€ä¸ª<code>æŠ½è±¡ç±»</code>ï¼Œå®šä¹‰äº†å¾ˆå¤šæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨å…·ä½“æ‰§è¡Œçš„æ—¶å€™ï¼Œè‚¯å®šæ˜¯ç”±å®ƒçš„å­ç±»å»å®ç°ï¼Œå®ƒçš„å­ç±»æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>å‰é¢æˆ‘ä»¬è®²è§£ PackageManager ç±»çš„æ—¶å€™ï¼Œå®˜æ–¹æ¨èé€šè¿‡ <code>Context#getPackageManager()</code> æ–¹æ³•è·å– <code>PackageManager</code> å¯¹è±¡ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/core/java/android/content/Context.java</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">/** Return PackageManager instance to find global package information. */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> PackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><code>Context</code> ä¹Ÿæ˜¯ä¸€ä¸ª<code>æŠ½è±¡ç±»</code>ï¼Œè€Œå®ƒçš„ <code>getPackageManager()</code> ä¹Ÿæ˜¯æŠ½è±¡æ–¹æ³•ï¼Œ<code>Context</code> çš„å…·ä½“å®ç°ç±»æ˜¯ <code>ContextImpl</code>ï¼Œé‚£æˆ‘ä»¬å°±å» <code>ContextImpl</code> é‡Œé¢çœ‹ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/core/java/android/app/ContextImpl.java</span><span class="token keyword">class</span> <span class="token class-name">ContextImpl</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> PackageManager mPackageManager<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> PackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­ mPackageManager æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> mPackageManager<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ ActivityThread çš„é™æ€æ–¹æ³• getPackageManager() è·å–ä¸€ä¸ª IPackageManager å¯¹è±¡</span>        IPackageManager pm <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¦‚æœè·å–çš„ IPackageManager å¯¹è±¡ä¸ä¸ºç©ºï¼Œåˆ™æ„é€ ä¸€ä¸ª ApplicationPackageManager å¯¹</span>        <span class="token comment" spellcheck="true">// è±¡ï¼ŒApplicationPackageManager æ˜¯ PackageManager çš„å­ç±»</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Doesn't matter if we make more than one instance.</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>åˆ°è¿™è¾¹å°±å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬å¹³æ—¶è°ƒç”¨ Context çš„ <code>getPackageManager()</code> æ–¹æ³•åï¼Œå…¶å®è¿”å›çš„æ˜¯ <code>ApplicationPackageManager</code> è¿™ä¸ªç±»ã€‚</p><h1 id="ä¸‰ã€ApplicationPackageManager"><a href="#ä¸‰ã€ApplicationPackageManager" class="headerlink" title="ä¸‰ã€ApplicationPackageManager"></a>ä¸‰ã€ApplicationPackageManager</h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ ApplicationPackageManager çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/core/java/android/app/ApplicationPackageManager.java</span><span class="token comment" spellcheck="true">/** @hide */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span></code></pre><p><code>ApplicationPackageManager</code> ç»§æ‰¿è‡ª <code>PackageManager</code>ï¼Œè€Œä¸” <code>ApplicationPackageManager ç±»ä¸æ˜¯æŠ½è±¡çš„</code>ï¼Œæ‰€ä»¥ <code>ApplicationPackageManager</code> å¿…ç„¶å®ç°äº† <code>PackageManager</code> çš„<code>æ‰€æœ‰æŠ½è±¡æ–¹æ³•</code>ã€‚</p><h2 id="3-1-æ„é€ å‡½æ•°"><a href="#3-1-æ„é€ å‡½æ•°" class="headerlink" title="3.1 æ„é€ å‡½æ•°"></a>3.1 æ„é€ å‡½æ•°</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> ContextImpl mContext<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> IPackageManager mPM<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token function">ApplicationPackageManager</span><span class="token punctuation">(</span>ContextImpl context<span class="token punctuation">,</span> IPackageManager pm<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>        mPM <span class="token operator">=</span> pm<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-2-InstallPackage-å¼ƒç”¨"><a href="#3-2-InstallPackage-å¼ƒç”¨" class="headerlink" title="3.2 InstallPackage(å¼ƒç”¨)"></a>3.2 InstallPackage(å¼ƒç”¨)</h2><p>åœ¨è®²è§£ <code>PackageManager</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°è¿‡å®‰è£… <code>APK</code> ä¼šè°ƒç”¨ <code>InstallPackage</code> æ–¹æ³•ï¼ˆAndroid 8.1ï¼Œ9.0 å·²å¼ƒç”¨ï¼‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹åœ¨ <code>ApplicationPackageManager</code> ä¸­çš„å…·ä½“å®ç°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">installPackage</span><span class="token punctuation">(</span>Uri packageURI<span class="token punctuation">,</span> IPackageInstallObserver observer<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>                               String installerPackageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">installCommon</span><span class="token punctuation">(</span>packageURI<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LegacyPackageInstallObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">,</span>            installerPackageName<span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="3-3-installCommon-å¼ƒç”¨"><a href="#3-3-installCommon-å¼ƒç”¨" class="headerlink" title="3.3 installCommon(å¼ƒç”¨)"></a>3.3 installCommon(å¼ƒç”¨)</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç æ¥è‡ªï¼šAndroid 8.1ï¼Œ9.0 å·²å¼ƒç”¨</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">installCommon</span><span class="token punctuation">(</span>Uri packageURI<span class="token punctuation">,</span>        PackageInstallObserver observer<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String installerPackageName<span class="token punctuation">,</span>        <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// scheme åˆ¤æ–­ï¼Œå¦‚æœé "file" åˆ™æŠ›å¼‚å¸¸ï¼Œå› ä¸ºåªæ”¯æŒ file æ ¼å¼çš„ URI</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"file"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>packageURI<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Only file:// URIs are supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è·å–ç›¸åº”çš„è·¯å¾„</span>    <span class="token keyword">final</span> String originPath <span class="token operator">=</span> packageURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ installPackageAsUser æ–¹æ³•</span>        mPM<span class="token punctuation">.</span><span class="token function">installPackageAsUser</span><span class="token punctuation">(</span>originPath<span class="token punctuation">,</span> observer<span class="token punctuation">.</span><span class="token function">getBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                               flags<span class="token punctuation">,</span> installerPackageName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥å‘ç°ï¼Œ<code>installPackage()</code> æ–¹æ³•å…¶å†…éƒ¨æœ¬è´¨æ˜¯è°ƒç”¨çš„ <code>IPackageManager</code> çš„ <code>installPackageAsUser()</code> æ–¹æ³•ï¼Œå› ä¸ºæ–¹æ³•å·²ç»å¼ƒç”¨ï¼Œæˆ‘ä»¬è¿™è¾¹ä¸å†è·Ÿä¸‹å»ã€‚</p><h2 id="3-4-getPackageInstaller-8-1-9-0"><a href="#3-4-getPackageInstaller-8-1-9-0" class="headerlink" title="3.4 getPackageInstaller(8.1-9.0)"></a>3.4 getPackageInstaller(8.1-9.0)</h2><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œä» 8.1 å¼€å§‹è°ƒç”¨ <code>getPackageInstaller</code> æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> PackageInstaller <span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstaller <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    mInstaller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageInstaller</span><span class="token punctuation">(</span>mPM<span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            mContext<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> mInstaller<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>åˆ°è¿™è¾¹ï¼Œä¸€åˆ‡éƒ½æ˜æœ—äº†ï¼Œ<code>PackageManager</code> ä¸­åˆ›å»ºäº† <code>PackageInstaller</code> å¯¹è±¡ï¼Œå…³äº <code>PackageInstaller</code> çš„å…·ä½“å†…å®¹ï¼Œæˆ‘ä»¬è¿™è¾¹ä¸å†ç»§ç»­åˆ†æã€‚</p><p>å…·ä½“å†…å®¹ï¼Œè¯·æŸ¥çœ‹ä¸‹ä¸€ç¯‡åšæ–‡ï¼š<a href="https://superandroid.pro/2019/01/15/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%884%EF%BC%89%E4%B9%8B%20PackageInstaller/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</a>ã€‚</p><h1 id="å››ã€IPackageManager"><a href="#å››ã€IPackageManager" class="headerlink" title="å››ã€IPackageManager"></a>å››ã€IPackageManager</h1><h2 id="4-1-ActivityThread"><a href="#4-1-ActivityThread" class="headerlink" title="4.1 ActivityThread"></a>4.1 ActivityThread</h2><p>åœ¨ä¸Šé¢åˆ†æ <code>ContextImpl</code> çš„ <code>getPackageManager()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°å¦‚ä¸‹æºç ï¼ˆå›é¡¾ï¼‰ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// frameworks/base/core/java/android/app/ContextImpl.java</span><span class="token keyword">class</span> <span class="token class-name">ContextImpl</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> PackageManager mPackageManager<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> PackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­ mPackageManager æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> mPackageManager<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ ActivityThread çš„é™æ€æ–¹æ³• getPackageManager() è·å–ä¸€ä¸ª IPackageManager å¯¹è±¡</span>        IPackageManager pm <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¦‚æœè·å–çš„ IPackageManager å¯¹è±¡ä¸ä¸ºç©ºï¼Œåˆ™æ„é€ ä¸€ä¸ª ApplicationPackageManager å¯¹</span>        <span class="token comment" spellcheck="true">// è±¡ï¼ŒApplicationPackageManager æ˜¯ PackageManager çš„å­ç±»</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Doesn't matter if we make more than one instance.</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>mPackageManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationPackageManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>è¿™è¾¹ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ <code>ActivityThread</code> çš„é™æ€æ–¹æ³• <code>getPackageManager()</code>ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">static</span> <span class="token keyword">volatile</span> IPackageManager sPackageManager<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> IPackageManager <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­ sPackageManager æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¯´æ˜æ˜¯çš„ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œèµ°ç¬¬äºŒæ­¥ï¼Œ</span>        <span class="token comment" spellcheck="true">// å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å› sPackageManager</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sPackageManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> sPackageManager<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// èƒ½èµ°åˆ°ç¬¬äºŒæ­¥ï¼Œè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œ</span>        <span class="token comment" spellcheck="true">// åˆ™è°ƒç”¨ ServiceManager çš„ getService(String) æ–¹æ³•è·å–ä¸€ä¸ª IBinder å¯¹è±¡</span>        IBinder b <span class="token operator">=</span> ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ IPackageManager.Stub.asInterface(IBinder) è·å–ä¸€ä¸ª sPackageManager å¯¹è±¡</span>        sPackageManager <span class="token operator">=</span> IPackageManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> sPackageManager<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="4-2-ApplicationPackageManager"><a href="#4-2-ApplicationPackageManager" class="headerlink" title="4.2 ApplicationPackageManager"></a>4.2 ApplicationPackageManager</h2><p>å†å›é¡¾ä¸‹ <code>ApplicationPackageManager</code> çš„æ„é€ å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> ContextImpl mContext<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> IPackageManager mPM<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token function">ApplicationPackageManager</span><span class="token punctuation">(</span>ContextImpl context<span class="token punctuation">,</span> IPackageManager pm<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>        mPM <span class="token operator">=</span> pm<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="4-3-IPackageManager"><a href="#4-3-IPackageManager" class="headerlink" title="4.3 IPackageManager"></a>4.3 IPackageManager</h2><p>å†å›é¡¾ä¸‹æˆ‘ä»¬åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æ‰€è¯´çš„ã€€<code>IPackageManager</code>ã€€æºç ï¼š</p><p><strong><font color="#0000FF">IPackageManager.javaï¼š</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IInterface</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/** Local-side IPC implementation stub class. */</span>    <span class="token comment" spellcheck="true">// å®šä¹‰å†…éƒ¨ç±» Stubï¼Œæ´¾ç”Ÿè‡ª Binderï¼Œå®ç° IPackageManager æ¥å£</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Stub</span> <span class="token keyword">extends</span> <span class="token class-name">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Binder</span>                                      <span class="token keyword">implements</span> <span class="token class-name">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>IPackageManager</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String DESCRIPTOR <span class="token operator">=</span>                                       <span class="token string">"android.content.pm.IPackageManager"</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** Construct the stub at attach it to the interface. */</span>        <span class="token keyword">public</span> <span class="token function">Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// å®šä¹‰ Stub çš„å†…éƒ¨ç±» Proxyï¼Œå®ç° IPackageManager æ¥å£</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>IPackageManager</span> <span class="token punctuation">{</span>            <span class="token keyword">private</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IBinder mRemote<span class="token punctuation">;</span>            <span class="token function">Proxy</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IBinder remote<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æ‰€ä»¥åœ¨ <code>ApplicationPackageManager</code> é‡Œé¢çš„ <code>mPM</code> å…¶å®å°±æ˜¯ <code>IPackageManager.Stub</code> å†…éƒ¨ç±» <code>Proxy å¯¹è±¡</code>ã€‚</p><p>é‚£å¯¹åº”çš„ <code>IPackageManager.Stub</code> æ˜¯ä»€ä¹ˆï¼Ÿå…¶å®å°±æ˜¯ <strong><font color="#FF0000">PackageManagerService.java</font></strong> ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IPackageManager<span class="token punctuation">.</span>Stub</span> <span class="token keyword">implements</span> <span class="token class-name">PackageSender</span> <span class="token punctuation">{</span></code></pre><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-74ae1197e39297b8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åŸç†å›¾.png"></center><h2 id="4-4-å°ç»“"><a href="#4-4-å°ç»“" class="headerlink" title="4.4 å°ç»“"></a>4.4 å°ç»“</h2><p>ç»“åˆä¸Šé¢çš„çŸ¥è¯†ï¼Œå†ç»“åˆ PackageManagerã€ApplicationPackageManager å’Œ PackageManagerService ï¼Œæˆ‘ä»¬ä½œä¸ªå°ç»“ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <strong>&nbsp;IPackageManager è´Ÿè´£é€šä¿¡</strong>ï¼šIPackageManager æ¥å£ç±»ä¸­å®šä¹‰äº†å¾ˆå¤šä¸šåŠ¡æ–¹æ³•ï¼Œä½†æ˜¯ç”±äºå®‰å…¨ç­‰æ–¹é¢çš„è€ƒè™‘ï¼ŒAndroid å¯¹å¤–(å³SDK)æä¾›çš„ä»…ä»…æ˜¯ä¸€ä¸ªå­é›†ï¼Œè¯¥å­é›†è¢«å°è£…åœ¨æŠ½è±¡ç±» PackageManager ä¸­ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬é€šè¿‡ Context çš„ getPackageManager å‡½æ•°è¿”å›ä¸€ä¸ªç±»å‹ä¸º PackageManager çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„å®é™…ç±»å‹æ˜¯ PackageManager çš„å­ç±» ApplicationPackageManager ã€‚ApplicationPackageManager å¹¶æ²¡æœ‰ç›´æ¥å‚ä¸ Binder é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡ mPM æˆå‘˜å˜é‡æŒ‡å‘äº†ä¸€ä¸ª IPackageManager.Stub.Proxy ç±»å‹çš„å¯¹è±¡ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp;<strong>AIDLä¸­ çš„ Binder æœåŠ¡ç«¯æ˜¯ PackageManagerService</strong>ï¼Œå› ä¸º PackageManagerService ç»§æ‰¿è‡ª IPackageManager.Stub ã€‚ç”±äº IPackageManager.Stub ç±»ä» Binder æ´¾ç”Ÿï¼Œæ‰€ä»¥ PackageManagerService å°†ä½œä¸ºæœåŠ¡ç«¯å‚ä¸ Binder é€šä¿¡ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp;<strong>AIDLä¸­ çš„ Binder å®¢æˆ·ç«¯æ˜¯ ApplicationPackageManager ä¸­æˆå‘˜å˜é‡ mPM</strong>ï¼Œå› ä¸ºmPMå†…éƒ¨æŒ‡å‘çš„æ˜¯ IPackageManager.Stub.Proxyã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://www.jianshu.com/p/c56376916d5e" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£2â€”â€”PackageManagerç®€ä»‹</a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/a301291ca845" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£3â€”â€”PackageManagerä¸PackageManagerService</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/05/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%882%EF%BC%89%E4%B9%8B%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/15/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%884%EF%BC%89%E4%B9%8B%20PackageInstaller/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
            <tag> PackageManager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</title>
      <link href="/2019/01/05/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-2-gou-zao-han-shu/"/>
      <url>/2019/01/05/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-2-gou-zao-han-shu/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† Android 9.0 æºç ä¸­æ‰«æç³»ç»Ÿ Apk åŠéç³»ç»Ÿ Apk çš„ä»£ç é€»è¾‘ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€ç»†åŒ–æºç ï¼Œæ·»åŠ æ›´ä¸ºè¯¦ç»†çš„æ³¨é‡Šè¯´æ˜ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">3ã€æ–°å¢æµç¨‹å›¾åŠæ—¶åºå›¾ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">4ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font><br><br></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">Process.java</font></td><td>frameworks/base/core/java/android/os/Process.java</td></tr><tr><td><font color="#D15FEE">Settings.java</font></td><td>frameworks/base/services/core/java/com/android/server/pm/Settings.java</td></tr><tr><td><font color="#D15FEE">SystemConfig.java</font></td><td>frameworks/base/core/java/com/android/server/SystemConfig.java</td></tr><tr><td><font color="#D15FEE">SystemServer.java</font></td><td>frameworks/base/services/java/com/android/server/SystemServer.java</td></tr><tr><td><font color="#D15FEE">PackageManagerService.java</font></td><td>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td></tr></tbody></table><h2 id="1-2-å›é¡¾"><a href="#1-2-å›é¡¾" class="headerlink" title="1.2 å›é¡¾"></a>1.2 å›é¡¾</h2><p>åœ¨ PackageManagerService ç³»åˆ—ç¬¬ä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬å°† <strong>â€œæ„é€ å‡½æ•°â€</strong> åˆ†æˆäº†ä¸¤éƒ¨åˆ†ç ”ç©¶ï¼Œå¦‚ä¸‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ1ï¼‰ - å‰æœŸå‡†å¤‡å·¥ä½œ</font></strong>&nbsp;<strong><font color="#FF0000">ï¼ˆåˆ†æå®Œï¼‰</font></strong><a href="https://superandroid.pro/2019/01/01/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%881%EF%BC%89%E4%B9%8B%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">ã€ŠFramework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹ã€‹</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ2ï¼‰ - æ‰«æ Package å’Œ æ‰«å°¾å·¥ä½œ</font></strong>&nbsp;<strong><font color="#FF0000">ï¼ˆæœ¬ç¯‡æ–‡ç« è¦è®¨è®ºçš„å†…å®¹ï¼‰</font></strong><br><br></p><hr><h1 id="äºŒã€æ‰«æ-Package"><a href="#äºŒã€æ‰«æ-Package" class="headerlink" title="äºŒã€æ‰«æ Package"></a>äºŒã€æ‰«æ Package</h1><p>PMS æ„é€ å‡½æ•°ç¬¬äºŒé˜¶æ®µï¼ˆæˆ‘ä»¬å‰é¢åˆ†æçš„ Settings å’Œ XML è§£æä½œä¸ºæ„é€ å‡½æ•°çš„ç¬¬ä¸€éƒ¨åˆ†ï¼‰çš„å·¥ä½œå°±æ˜¯ <code>æ‰«æç³»ç»Ÿä¸­çš„ APK</code>äº†ã€‚ç”±äºéœ€è¦é€ä¸ªæ‰«ææ–‡ä»¶ï¼Œå› æ­¤æ‰‹æœºä¸Šè£…çš„ç¨‹åºè¶Šå¤šï¼ŒPMS çš„å·¥ä½œé‡å°±è¶Šå¤§ï¼Œç³»ç»Ÿå¯åŠ¨é€Ÿåº¦ä¹Ÿå°±è¶Šæ…¢ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ çš„æ‰‹æœºå¯åŠ¨é€Ÿåº¦æœ‰å¿«æ…¢çš„åŸå› <strong><font color="#0000FF">ï¼ˆæ‰€ä»¥ä¼˜åŒ–å¼€æœºå¯åŠ¨é€Ÿåº¦ï¼Œäº†è§£ PMS ä¹Ÿæ˜¯å¾ˆå…³é”®çš„ï¼‰</font></strong>ã€‚</p><h2 id="2-1-ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰"><a href="#2-1-ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰" class="headerlink" title="2.1 ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰"></a>2.1 ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰</h2><p>æ¥ç€å‰é¢çš„ PMS æ„é€ å‡½æ•°ç»§ç»­åˆ†ææºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>        <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// writer </span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        mFirstBoot <span class="token operator">=</span> <span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">readLPw</span><span class="token punctuation">(</span>sUserManager<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> packageSettingCount <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ¸…ç†é‚£äº›ä»£ç è·¯å¾„ä¸å­˜åœ¨çš„å¼‚å¸¸ package</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> packageSettingCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isExternal</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ps<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>ps<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token operator">&amp;&amp;</span> mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">requestCopyPreoptedFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è®¾ç½®æ¨¡å—æ¥ä»£æ›¿ framework-res.apk ä¸­ç¼ºçœçš„ ResolverActivity</span>        String customResolverActivity <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>                R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>config_customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            customResolverActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            mCustomResolverComponentName <span class="token operator">=</span> ComponentName<span class="token punctuation">.</span><span class="token function">unflattenFromString</span><span class="token punctuation">(</span>                    customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è®°å½•æ‰«æå¼€å§‹çš„æ—¶é—´</span>        <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// éœ€è¦ç³»ç»Ÿæå‰åŠ è½½çš„ä¸€äº› jar</span>        <span class="token keyword">final</span> String bootClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"BOOTCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> String systemServerClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SYSTEMSERVERCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è‡³æ­¤ï¼Œç¬¬ä¸€é˜¶æ®µä»£ç å…¨éƒ¨ç»“æŸï¼</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="2-2-æ‰«æç³»ç»Ÿ-Package"><a href="#2-2-æ‰«æç³»ç»Ÿ-Package" class="headerlink" title="2.2 æ‰«æç³»ç»Ÿ Package"></a>2.2 æ‰«æç³»ç»Ÿ Package</h2><p>æ¥ä¸‹æ¥çœ‹ PMS ç¬¬äºŒé˜¶æ®µå·¥ä½œçš„æ ¸å¿ƒå†…å®¹ï¼Œå³ <code>æ‰«æ Package</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>        <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ã€€ã€€ã€€ã€€<span class="token comment" spellcheck="true">// ç¬¬ä¸€é˜¶æ®µåˆ†æç»“æŸï¼</span>    <span class="token comment" spellcheck="true">// å®šä¹‰ frameworkDir æŒ‡å‘ /system/frameworks ç›®å½•</span>    File frameworkDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"framework"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> VersionInfo ver <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getInternalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mIsUpgrade <span class="token operator">=</span> <span class="token operator">!</span>Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ver<span class="token punctuation">.</span>fingerprint<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token string">"Upgrading from "</span> <span class="token operator">+</span>                         ver<span class="token punctuation">.</span>fingerprint <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    mPromoteSystemApps <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>LOLLIPOP_MR1<span class="token punctuation">;</span>    mIsPreNUpgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">;</span>    mIsPreNMR1Upgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N_MR1<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ˜¯å¦éœ€è¦æå‡æƒé™</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPromoteSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> pkgSettingIter <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>pkgSettingIter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageSetting ps <span class="token operator">=</span> pkgSettingIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystemApp</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// éå† Settings::mPackages é›†åˆï¼Œå°†ç³»ç»Ÿ APP åŠ å…¥åˆ°</span>                <span class="token comment" spellcheck="true">// PackageManagerService::mExistingSystemPackages</span>                mExistingSystemPackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    mCacheDir <span class="token operator">=</span> <span class="token function">preparePackageParserCache</span><span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å®šä¹‰æ‰«æå‚æ•°</span>    <span class="token keyword">int</span> scanFlags <span class="token operator">=</span> SCAN_BOOTING <span class="token operator">|</span> SCAN_INITIAL<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">||</span> mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>        scanFlags <span class="token operator">=</span> scanFlags <span class="token operator">|</span> SCAN_FIRST_BOOT_OR_UPGRADE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// private static final String VENDOR_OVERLAY_DIR = "/vendor/overlay";</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>VENDOR_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// æ‰«æ /vendor/overlay ç›®å½•</span>                    mDefParseFlags                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>                     scanFlags                    <span class="token operator">|</span> SCAN_AS_SYSTEM                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// private static final String PRODUCT_OVERLAY_DIR = "/product/overlay";</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>PRODUCT_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// æ‰«æ /product/overlay ç›®å½•</span>                    mDefParseFlags                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>                     scanFlags                    <span class="token operator">|</span> SCAN_AS_SYSTEM                    <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mParallelPackageParserCallback<span class="token punctuation">.</span><span class="token function">findStaticOverlayPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Find base frameworks (resource packages without code).</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>frameworkDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// æ‰«æ /system/frameworks ç›®å½•</span>                    mDefParseFlags                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>                     scanFlags                    <span class="token operator">|</span> SCAN_NO_DEX                    <span class="token operator">|</span> SCAN_AS_SYSTEM                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Collected privileged system packages.</span>    <span class="token keyword">final</span> File privilegedAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"priv-app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">// æ‰«æ /system/priv-app ç›®å½•</span>                    mDefParseFlags                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>                     scanFlags                    <span class="token operator">|</span> SCAN_AS_SYSTEM                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Collect ordinary system packages.</span>    <span class="token keyword">final</span> File systemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// æ‰«æ /system/app ç›®å½•</span>                    mDefParseFlags                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>                     scanFlags                    <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// Collect ordinary vendor packages.</span>    File vendorAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        vendorAppDir <span class="token operator">=</span> vendorAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>    <span class="token punctuation">}</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// æ‰«æ /vendor/app ç›®å½•</span>                    mDefParseFlags                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>                    scanFlags                    <span class="token operator">|</span> SCAN_AS_SYSTEM                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// Collect all OEM packages.</span>    <span class="token keyword">final</span> File oemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">// æ‰«æ /oem/app ç›®å½•</span>                    mDefParseFlags                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>                     scanFlags                    <span class="token operator">|</span> SCAN_AS_SYSTEM                    <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ï½</code></pre><p>æˆ‘ä»¬å‘ç° PMS æ‰«æäº†å¾ˆå¤šç›®å½•ï¼Œæˆ‘ä»¬åˆ—ä¸¾å‡ ä¸ªé‡ç‚¹è¯´æ˜ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><code>/system/frameworks</code></strong> ï¼šè¯¥ç›®å½•ä¸­çš„æ–‡ä»¶éƒ½æ˜¯ç³»ç»Ÿåº“ï¼Œä¾‹å¦‚ï¼šframework.jarã€services.jarã€framework-res.apkã€‚ä¸è¿‡ scanDirTracedLI åªæ‰«æ APK æ–‡ä»¶ï¼Œæ‰€ä»¥ <code>framework-res.apk</code> æ˜¯è¯¥ç›®å½•ä¸­å”¯ä¸€è¢«æ‰«æçš„æ–‡ä»¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><code>/system/app</code></strong> ï¼šè¯¥ç›®å½•ä¸‹å…¨æ˜¯é»˜è®¤çš„ç³»ç»Ÿåº”ç”¨ã€‚ä¾‹å¦‚ï¼šBrowser.apkã€SettingsProvider.apk ç­‰ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><code>/vendor/app</code></strong> ï¼šè¯¥ç›®å½•ä¸­çš„æ–‡ä»¶ç”±å‚å•†æä¾›ï¼Œå³å…¨æ˜¯å‚å•†å®šåˆ¶çš„ APK æ–‡ä»¶ã€‚</p><h3 id="2-2-1-scanDirTracedLI"><a href="#2-2-1-scanDirTracedLI" class="headerlink" title="2.2.1 scanDirTracedLI"></a>2.2.1 scanDirTracedLI</h3><p>PMS æ‰«æç›®å½•ç»Ÿä¸€è°ƒç”¨ <code>scanDirTracedLI()</code> æ–¹æ³•ï¼ˆå‡ºç°æ¬¡æ•°æœ€å¤šçš„ä¹Ÿæ˜¯æœ€é‡è¦çš„å‡½æ•°ï¼‰ï¼Œæˆ‘ä»¬æ·±å…¥è·Ÿè¸ªæºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>File scanDir<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span>                                           <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è·³è½¬è‡³ scanDirLI æ–¹æ³•</span>        <span class="token function">scanDirLI</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-2-scanDirLI"><a href="#2-2-2-scanDirLI" class="headerlink" title="2.2.2 scanDirLI"></a>2.2.2 scanDirLI</h3><p>ä¸‹é¢çš„é‡ç‚¹å°±è½¬ç§»åˆ° <code>scanDirLI()</code> æ–¹æ³•äº†ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanDirLI</span><span class="token punctuation">(</span>File scanDir<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ‰«æè¯¥ç›®å½•ä¸‹æ‰€æœ‰åç¼€ä¸º .apk çš„æ–‡ä»¶</span>    <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> scanDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No files in app dir "</span> <span class="token operator">+</span> scanDir<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ParallelPackageParser æ˜¯ Android 9.0ã€€æ–°å¢çš„ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£å®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œ</span>    <span class="token comment" spellcheck="true">// æ”¶é›†ç³»ç»Ÿ apk æ–‡ä»¶ï¼Œç„¶åä»è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ä¸€ä¸ªä¸ªå–å‡º apk ï¼Œè°ƒç”¨ PackageParserã€€è§£æï¼</span>    <span class="token keyword">try</span> <span class="token punctuation">(</span>ParallelPackageParser parallelPackageParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParallelPackageParser</span><span class="token punctuation">(</span>            mSeparateProcesses<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> mCacheDir<span class="token punctuation">,</span>            mParallelPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Submit files for parsing in parallel    -->    æ”¶é›† apk</span>        <span class="token keyword">int</span> fileCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPackage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isApkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>PackageInstallerService<span class="token punctuation">.</span><span class="token function">isStageName</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è¿‡æ»¤æ‰é apk æ–‡ä»¶ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ç»§ç»­æ‰«æ</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Ignore entries which are not packages</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            parallelPackageParser<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>            fileCount<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Process results one by one              -->    è§£æ apk</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> fileCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> fileCount<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ParallelPackageParser<span class="token punctuation">.</span>ParseResult parseResult <span class="token operator">=</span> parallelPackageParser<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Throwable throwable <span class="token operator">=</span> parseResult<span class="token punctuation">.</span>throwable<span class="token punctuation">;</span>            <span class="token keyword">int</span> errorCode <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Static shared libraries have synthetic package names</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">renameStaticSharedLibraryPackage</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">/*                         * Android 9.0 è°ƒç”¨ scanPackageChildLIï¼Œ                         * Android 8.0 è°ƒç”¨ scanPackageLIï¼Œ                         * Android 7.0 è°ƒç”¨ scanPackageTracedLIï¼Œ                         *                          * è°ƒç”¨ scanPackageChildLI å‡½æ•°æ‰«æä¸€ä¸ªç‰¹å®šçš„ apk æ–‡ä»¶ï¼Œ                         * è¿”å›å€¼æ˜¯ PackageParser çš„å†…éƒ¨ç±» Packageï¼Œ                         * è¯¥ç±»çš„å®ä¾‹ä»£è¡¨ä¸€ä¸ª APK æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯å’Œ apk æ–‡ä»¶å¯¹åº”çš„æ•°æ®ç»“æ„ã€‚                         */</span>                        <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                                currentTime<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// æ‰«æ APK è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    errorCode <span class="token operator">=</span> e<span class="token punctuation">.</span>error<span class="token punctuation">;</span>                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to scan "</span> <span class="token operator">+</span> parseResult<span class="token punctuation">.</span>scanFile <span class="token operator">+</span> <span class="token string">": "</span>                                                               <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token keyword">instanceof</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>PackageParserException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Delete invalid userdata apps -- å¦‚æœè§£æå¤±è´¥ï¼Œå¹¶ä¸”æ˜¯éç³»ç»Ÿ apk</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>                    errorCode <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// éç³»ç»Ÿ Package æ‰«æå¤±è´¥ï¼Œåˆ é™¤æ–‡ä»¶</span>                <span class="token function">removeCodePathLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ç»§ç»­åˆ†æ <code>scanPackageChildLI()</code> æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹çœ‹ 9.0 æ–°å¢çš„ <code>ParallelPackageParser</code> è¿™ä¸ªç±»ã€‚</p><h4 id="2-2-2-1-ParallelPackageParser"><a href="#2-2-2-1-ParallelPackageParser" class="headerlink" title="2.2.2.1 ParallelPackageParser"></a>2.2.2.1 ParallelPackageParser</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Helper class for parallel parsing of packages using {@link PackageParser}. * &lt;p>Parsing requests are processed by a thread-pool of {@link #MAX_THREADS}. * At any time, at most {@link #QUEUE_CAPACITY} results are kept in RAM&lt;/p> */</span><span class="token keyword">class</span> <span class="token class-name">ParallelPackageParser</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> BlockingQueue<span class="token operator">&lt;</span>ParseResult<span class="token operator">></span> mQueue <span class="token operator">=</span>                                              <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>QUEUE_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ParallelPackageParser</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> separateProcesses<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCoreApps<span class="token punctuation">,</span>            DisplayMetrics metrics<span class="token punctuation">,</span> File cacheDir<span class="token punctuation">,</span> PackageParser<span class="token punctuation">.</span>Callback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mSeparateProcesses <span class="token operator">=</span> separateProcesses<span class="token punctuation">;</span>        mOnlyCore <span class="token operator">=</span> onlyCoreApps<span class="token punctuation">;</span>        mMetrics <span class="token operator">=</span> metrics<span class="token punctuation">;</span>        mCacheDir <span class="token operator">=</span> cacheDir<span class="token punctuation">;</span>        mPackageParserCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">/**     * Submits the file for parsing     * @param scanFile file to scan     * @param parseFlags parse falgs     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            ParseResult pr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParseResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>                pp<span class="token punctuation">.</span><span class="token function">setOnlyCoreApps</span><span class="token punctuation">(</span>mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>                pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>                pp<span class="token punctuation">.</span><span class="token function">setCacheDir</span><span class="token punctuation">(</span>mCacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>                pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>                pr<span class="token punctuation">.</span>scanFile <span class="token operator">=</span> scanFile<span class="token punctuation">;</span>                pr<span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token function">parsePackage</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                pr<span class="token punctuation">.</span>throwable <span class="token operator">=</span> e<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                mQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pr<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                mInterruptedInThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å†çœ‹ä¸‹ <code>ParallelPackageParser</code> çš„å†…éƒ¨ç±» <code>ParseResult</code>ã€‚</p><h4 id="2-2-2-2-ParseResult"><a href="#2-2-2-2-ParseResult" class="headerlink" title="2.2.2.2 ParseResult"></a>2.2.2.2 ParseResult</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Helper class for parallel parsing of packages using {@link PackageParser}. * &lt;p>Parsing requests are processed by a thread-pool of {@link #MAX_THREADS}. * At any time, at most {@link #QUEUE_CAPACITY} results are kept in RAM&lt;/p> */</span><span class="token keyword">class</span> <span class="token class-name">ParallelPackageParser</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ParseResult</span> <span class="token punctuation">{</span>        PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Parsed package</span>        File scanFile<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// File that was parsed</span>        Throwable throwable<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Set if an error occurs during parsing</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"ParseResult{"</span> <span class="token operator">+</span>ã€€<span class="token string">"pkg="</span> <span class="token operator">+</span> pkg <span class="token operator">+</span>ã€€<span class="token string">", scanFile="</span> <span class="token operator">+</span> scanFile <span class="token operator">+</span>                    <span class="token string">", throwable="</span> <span class="token operator">+</span> throwable <span class="token operator">+</span>ã€€<span class="token string">'}'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Take the parsed package from the parsing queue, waiting if necessary until the element     * appears in the queue.     * @return parsed package     */</span>    <span class="token keyword">public</span> ParseResult <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInterruptedInThread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token string">"Interrupted in "</span> <span class="token operator">+</span> mInterruptedInThread<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> mQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// We cannot recover from interrupt here</span>            Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-3-scanPackageChildLI"><a href="#2-2-3-scanPackageChildLI" class="headerlink" title="2.2.3 scanPackageChildLI"></a>2.2.3 scanPackageChildLI</h3><p>æºç ä¸­ï¼Œå¦‚æœ apk æ–‡ä»¶æ²¡æœ‰é—®é¢˜ï¼Œä¼šèµ°å¦‚ä¸‹æµç¨‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/*         * Android 9.0 è°ƒç”¨ scanPackageChildLIï¼Œ         * Android 8.0 è°ƒç”¨ scanPackageLIï¼Œ         * Android 7.0 è°ƒç”¨ scanPackageTracedLIï¼Œ         *          * è°ƒç”¨ scanPackageChildLI å‡½æ•°æ‰«æä¸€ä¸ªç‰¹å®šçš„ apk æ–‡ä»¶ï¼Œ         * è¿”å›å€¼æ˜¯ PackageParser çš„å†…éƒ¨ç±» Packageï¼Œ         * è¯¥ç±»çš„å®ä¾‹ä»£è¡¨ä¸€ä¸ª APK æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯å’Œ apk æ–‡ä»¶å¯¹åº”çš„æ•°æ®ç»“æ„ã€‚         *         * PackageParser.Package pkg;    // Parsed package         */</span>        <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>ã€€currentTime<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯åˆ†æ <code>scanPackageChildLI()</code> æ–¹æ³•ï¼</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** *  Scans a package and returns the newly parsed package.  *  æ‰«æä¸€ä¸ª apk æ–‡ä»¶å¹¶è¿”å› packageï¼ *  @throws PackageManagerException on a parse error. */</span><span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>        <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            scanFlags <span class="token operator">|=</span> SCAN_CHECK_ONLY<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        scanFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>SCAN_CHECK_ONLY<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Scan the parent</span>    PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> <span class="token function">addForInitLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span>            scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Scan the children</span>    <span class="token keyword">final</span> <span class="token keyword">int</span> childCount <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        PackageParser<span class="token punctuation">.</span>Package childPackage <span class="token operator">=</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">addForInitLI</span><span class="token punctuation">(</span>childPackage<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> scannedPkg<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-4-addForInitLI"><a href="#2-2-4-addForInitLI" class="headerlink" title="2.2.4 addForInitLI"></a>2.2.4 addForInitLI</h3><p>ç»§ç»­è·Ÿè¸ªæºç ï¼Œè°ƒç”¨ <code>addForInitLI()</code> æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">addForInitLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>        <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span>ã€€<span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> scanSystemPartition <span class="token operator">=</span> <span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span>                                          PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> String renamedPkgName<span class="token punctuation">;</span>    <span class="token keyword">final</span> PackageSetting disabledPkgSetting<span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isSystemPkgUpdated<span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> pkgAlreadyExists<span class="token punctuation">;</span>    PackageSetting pkgSetting<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">/*      * åˆ¤æ–­ç³»ç»Ÿ APK æ˜¯å¦éœ€è¦æ›´æ–°     * final ArrayMap&lt;String, PackageParser.Package> mPackages =      *                                      new ArrayMap&lt;String, PackageParser.Package>();     */</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>        renamedPkgName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mRealPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> String realPkgName <span class="token operator">=</span> <span class="token function">getRealPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>realPkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ensurePackageRenamed</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> PackageSetting originalPkgSetting <span class="token operator">=</span>                                            <span class="token function">getOriginalPackageLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> PackageSetting installedPkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>        pkgSetting <span class="token operator">=</span> originalPkgSetting <span class="token operator">==</span> null <span class="token operator">?</span> installedPkgSetting <span class="token operator">:</span> originalPkgSetting<span class="token punctuation">;</span>        pkgAlreadyExists <span class="token operator">=</span> pkgSetting <span class="token operator">!=</span> null<span class="token punctuation">;</span>        <span class="token keyword">final</span> String disabledPkgName <span class="token operator">=</span> pkgAlreadyExists <span class="token operator">?</span> pkgSetting<span class="token punctuation">.</span>name <span class="token operator">:</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>        disabledPkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>disabledPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>        isSystemPkgUpdated <span class="token operator">=</span> disabledPkgSetting <span class="token operator">!=</span> null<span class="token punctuation">;</span>        <span class="token keyword">final</span> SharedUserSetting sharedUserSetting <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId <span class="token operator">!=</span> null<span class="token punctuation">)</span>                <span class="token operator">?</span> mSettings<span class="token punctuation">.</span><span class="token function">getSharedUserLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId<span class="token punctuation">,</span>                        <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgFlags*/</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgPrivateFlags*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>                <span class="token operator">:</span> null<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>scanSystemPartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSystemPkgUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> <span class="token keyword">int</span> scannedChildCount <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span>                        <span class="token operator">?</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">final</span> <span class="token keyword">int</span> disabledChildCount <span class="token operator">=</span> disabledPkgSetting<span class="token punctuation">.</span>childPackageNames <span class="token operator">!=</span> null                        <span class="token operator">?</span> disabledPkgSetting<span class="token punctuation">.</span>childPackageNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> disabledChildCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€                String disabledChildPackageName <span class="token operator">=</span>                            disabledPkgSetting<span class="token punctuation">.</span>childPackageNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">boolean</span> disabledPackageAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> scannedChildCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        PackageParser<span class="token punctuation">.</span>Package childPkg <span class="token operator">=</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>childPkg<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>disabledChildPackageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            disabledPackageAvailable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                            <span class="token keyword">break</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disabledPackageAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        mSettings<span class="token punctuation">.</span><span class="token function">removeDisabledSystemPackageLPw</span><span class="token punctuation">(</span>disabledChildPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// we're updating the disabled package, so, scan it as the package setting</span>                <span class="token keyword">final</span> ScanRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanRequest</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> sharedUserSetting<span class="token punctuation">,</span> null<span class="token punctuation">,</span>                        disabledPkgSetting <span class="token comment" spellcheck="true">/* pkgSetting */</span><span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/* disabledPkgSetting */</span><span class="token punctuation">,</span>                        null <span class="token comment" spellcheck="true">/* originalPkgSetting */</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                        <span class="token punctuation">(</span>pkg <span class="token operator">==</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">applyPolicy</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">scanPackageOnlyLI</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mFactoryTest<span class="token punctuation">,</span> <span class="token operator">-</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newPkgChangedPaths <span class="token operator">=</span>            pkgAlreadyExists <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newPkgVersionGreater <span class="token operator">=</span>            pkgAlreadyExists <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> pkgSetting<span class="token punctuation">.</span>versionCode<span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isSystemPkgBetter <span class="token operator">=</span> scanSystemPartition <span class="token operator">&amp;&amp;</span> isSystemPkgUpdated            <span class="token operator">&amp;&amp;</span> newPkgChangedPaths <span class="token operator">&amp;&amp;</span> newPkgVersionGreater<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isSystemPkgBetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ›´æ–°å®‰è£…åŒ…åˆ°ç³»ç»Ÿåˆ†åŒºä¸­</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ä» PackageManagerService çš„å®‰è£…åŒ…åˆ—è¡¨ä¸­åˆ é™¤è¯¥åŒ…</span>            mPackages<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºå®‰è£…å‚æ•° InstallArgs</span>        <span class="token keyword">final</span> InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgsForExisting</span><span class="token punctuation">(</span>                <span class="token function">packageFlagsToInstallFlags</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">,</span>                pkgSetting<span class="token punctuation">.</span>resourcePathString<span class="token punctuation">,</span> <span class="token function">getAppDexInstructionSets</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        args<span class="token punctuation">.</span><span class="token function">cleanUpResourcesLI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// å®‰è£…åŒ…æ ¡éªŒ</span>    <span class="token function">collectCertificatesLI</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> forceCollect<span class="token punctuation">,</span> skipVerify<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*     * A new system app appeared, but we already had a non-system one of the     * same name installed earlier.     *     * å½“æˆ‘ä»¬å®‰è£…ä¸€ä¸ªç³»ç»Ÿ apk çš„æ—¶å€™ï¼Œå‘ç°å·²ç»æœ‰äº†ä¸€ä¸ªç›¸åŒåŒ…åçš„ apkï¼Œ     * è€Œä¸”è¿™ä¸ªç›¸åŒåŒ…å apk æ˜¯åœ¨éç³»ç»Ÿçš„åˆ†åŒºä¸­     */</span>    <span class="token keyword">boolean</span> shouldHideSystemApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// A new application appeared on /system, but, we already have a copy of</span>    <span class="token comment" spellcheck="true">// the application installed on /data.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>scanSystemPartition <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isSystemPkgUpdated <span class="token operator">&amp;&amp;</span> pkgAlreadyExists            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>                PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>INSTALLED_DATA<span class="token punctuation">)</span>                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>                                pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>                                PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>ROLLBACK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> <span class="token string">"System package signature mismatch;"</span>                                           <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">(</span>PackageFreezer freezer <span class="token operator">=</span> <span class="token function">freezePackage</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>                    <span class="token string">"scanPackageInternalLI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å¦‚æœä¸¤ä¸ª apk ç­¾åä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ deletePackageLI æ–¹æ³•æ¸…é™¤ apk æ–‡ä»¶åŠå…¶æ•°æ®</span>                <span class="token function">deletePackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            pkgSetting <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newPkgVersionGreater<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// The application on /system is newer than the application on /data.</span>            <span class="token comment" spellcheck="true">// Simply remove the application on /data [keeping application data]</span>            <span class="token comment" spellcheck="true">// and replace it with the version on /system.</span>            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> <span class="token string">"System package enabled;"</span> <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name                    <span class="token operator">+</span> <span class="token string">"; "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>versionCode <span class="token operator">+</span> <span class="token string">" --> "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token operator">+</span> <span class="token string">"; "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>codePathString <span class="token operator">+</span> <span class="token string">" --> "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ›´æ–°ç³»ç»Ÿ apk ç¨‹åº</span>            InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgsForExisting</span><span class="token punctuation">(</span>                    <span class="token function">packageFlagsToInstallFlags</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">,</span>                    pkgSetting<span class="token punctuation">.</span>resourcePathString<span class="token punctuation">,</span> <span class="token function">getAppDexInstructionSets</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>                args<span class="token punctuation">.</span><span class="token function">cleanUpResourcesLI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// The application on /system is older than the application on /data. Hide</span>            <span class="token comment" spellcheck="true">// the application on /system and the version on /data will be scanned later</span>            <span class="token comment" spellcheck="true">// and re-added like an update.</span>            shouldHideSystemApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>                    <span class="token string">"System package disabled;"</span>                    <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name                    <span class="token operator">+</span> <span class="token string">"; old: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>codePathString <span class="token operator">+</span> <span class="token string">" @ "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>versionCode                    <span class="token operator">+</span> <span class="token string">"; new: "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath <span class="token operator">+</span> <span class="token string">" @ "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ é‡ç‚¹æ–¹æ³• ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥</span>    <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> <span class="token function">scanPackageNewLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags            <span class="token operator">|</span> SCAN_UPDATE_SIGNATURE<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ–°å®‰è£…çš„ç³»ç»Ÿ APK ä¼šè¢«æ—§çš„ APK æ•°æ®è¦†ç›–ï¼Œ</span>    <span class="token comment" spellcheck="true">// æ‰€ä»¥éœ€è¦éšè—éšè—ç³»ç»Ÿåº”ç”¨ç¨‹åºï¼Œå¹¶é‡æ–°æ‰«æ /data/app ç›®å½•</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldHideSystemApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mSettings<span class="token punctuation">.</span><span class="token function">disableSystemPackageLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> scannedPkg<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-5-scanPackageNewLI"><a href="#2-2-5-scanPackageNewLI" class="headerlink" title="2.2.5 scanPackageNewLI"></a>2.2.5 scanPackageNewLI</h3><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ <code>scanPackageNewLI()</code> æ–¹æ³•æºç ï¼</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageNewLI</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>        <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>    <span class="token keyword">final</span> String renamedPkgName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mRealPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> String realPkgName <span class="token operator">=</span> <span class="token function">getRealPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>realPkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ensurePackageRenamed</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">final</span> PackageSetting originalPkgSetting <span class="token operator">=</span>                                            <span class="token function">getOriginalPackageLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> PackageSetting pkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> PackageSetting disabledPkgSetting <span class="token operator">=</span>                         mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTransferedPackages<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName                <span class="token operator">+</span> <span class="token string">" was transferred to another, but its .apk remains"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    scanFlags <span class="token operator">=</span> <span class="token function">adjustScanFlags</span><span class="token punctuation">(</span>scanFlags<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> disabledPkgSetting<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">applyPolicy</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertPackageIsValid</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>        SharedUserSetting sharedUserSetting <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// SIDE EFFECTS; may potentially allocate a new shared user</span>            sharedUserSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getSharedUserLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId<span class="token punctuation">,</span>                            <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgFlags*/</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgPrivateFlags*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*create*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PACKAGE_SCANNING<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> PackageParser<span class="token punctuation">.</span>PARSE_CHATTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>                    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Shared UserID "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>mSharedUserId                            <span class="token operator">+</span> <span class="token string">" (uid="</span> <span class="token operator">+</span> sharedUserSetting<span class="token punctuation">.</span>userId <span class="token operator">+</span> <span class="token string">"):"</span>                            <span class="token operator">+</span> <span class="token string">" packages="</span> <span class="token operator">+</span> sharedUserSetting<span class="token punctuation">.</span>packages<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">boolean</span> scanSucceeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> ScanRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanRequest</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> sharedUserSetting<span class="token punctuation">,</span>                    pkgSetting <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> pkgSetting<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span>                     disabledPkgSetting<span class="token punctuation">,</span> originalPkgSetting<span class="token punctuation">,</span> realPkgName<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span>                     scanFlags<span class="token punctuation">,</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> ScanResult result <span class="token operator">=</span> <span class="token function">scanPackageOnlyLI</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mFactoryTest<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å°† pkg ä¸­çš„æ•°æ®ä¿å­˜åˆ°å¯¹åº”çš„ PMS å˜é‡ä¸­ï¼Œç”¨äºä»¥åçš„ç®¡ç†æŸ¥è¯¢è°ƒç”¨ç­‰</span>                <span class="token comment" spellcheck="true">// ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ é‡ç‚¹æ–¹æ³• ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥</span>                <span class="token function">commitScanResultsLocked</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            scanSucceeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scanSucceeded <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span>                  <span class="token function">destroyAppDataLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">,</span>                          StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_DE <span class="token operator">|</span> StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_CE<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token function">destroyAppProfilesLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> pkg<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-5-commitScanResultsLocked"><a href="#2-2-5-commitScanResultsLocked" class="headerlink" title="2.2.5 commitScanResultsLocked"></a>2.2.5 commitScanResultsLocked</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitScanResultsLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ScanRequest request<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> ScanResult result<span class="token punctuation">)</span>        <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPkgSetting <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>oldPkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">,</span> oldPkgSetting<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> user <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Modify state for the given package setting</span>        <span class="token comment" spellcheck="true">// å°† pkg ä¸­çš„æ•°æ®ä¿å­˜åˆ°å¯¹åº”çš„ PMS å˜é‡ä¸­ï¼Œç”¨äºä»¥åçš„ç®¡ç†æŸ¥è¯¢è°ƒç”¨ç­‰</span>        <span class="token comment" spellcheck="true">// ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ é‡ç‚¹æ–¹æ³• ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥</span>        <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> oldPkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> user<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>                <span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> PackageParser<span class="token punctuation">.</span>PARSE_CHATTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*chatty*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span><span class="token function">getInstantApp</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mInstantAppRegistry<span class="token punctuation">.</span><span class="token function">addInstantAppLPw</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-6-commitPackageSettings"><a href="#2-2-6-commitPackageSettings" class="headerlink" title="2.2.6 commitPackageSettings"></a>2.2.6 commitPackageSettings</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Adds a scanned package to the system. When this method is finished, the package will * be available for query, resolution, etc... */</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>            <span class="token annotation punctuation">@Nullable</span> PackageParser<span class="token punctuation">.</span>Package oldPkg<span class="token punctuation">,</span> PackageSetting pkgSetting<span class="token punctuation">,</span>             UserHandle user<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> chatty<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> String pkgName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// mCustomResolverComponentName æ˜¯ä»ç³»ç»Ÿèµ„æºä¸­è¯»å‡ºçš„ï¼Œå¯ä»¥é…ç½®</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCustomResolverComponentName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>                mCustomResolverComponentName<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è¿™é‡Œçš„ç”¨é€”å’Œä¸‹é¢åˆ¤æ–­ packageName æ˜¯å¦ä¸º "android" æœ‰è”ç³»ï¼Œ</span>        <span class="token comment" spellcheck="true">// å› ä¸ºè°ƒç”¨ setUpCustomResolverActivity(pkg) å mResolverReplaced ä¸ºtrue</span>        <span class="token function">setUpCustomResolverActivity</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// é’ˆå¯¹åŒ…åä¸º "android" çš„ apk è¿›è¡Œå¤„ç†</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Set up information for our fall-back user intent resolution activity.</span>                <span class="token comment" spellcheck="true">// ä¸ºæˆ‘ä»¬å›é€€çš„é¡µé¢é…ç½®ä¿¡æ¯</span>                mPlatformPackage <span class="token operator">=</span> pkg<span class="token punctuation">;</span>                pkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">=</span> mSdkVersion<span class="token punctuation">;</span>                pkg<span class="token punctuation">.</span>mVersionCodeMajor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                mAndroidApplication <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å¦‚æœä¸Šé¢çš„ä»£ç ä¸­è°ƒç”¨äº† setUpCustomResolverActivity æ–¹æ³•ï¼Œ</span>                <span class="token comment" spellcheck="true">// åœ¨ setUpCustomResolverActivity æ–¹æ³•é‡Œé¢è®¾ç½®äº† mResolverReplaced = true</span>                <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰è°ƒç”¨ setUpCustomResolverActivity æ–¹æ³•ï¼Œ</span>                <span class="token comment" spellcheck="true">// é…ç½®ç›¸åº” mResolveActivity çš„å±æ€§</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mResolverReplaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mResolveActivity<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> mAndroidApplication<span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>name <span class="token operator">=</span> ResolverActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>packageName <span class="token operator">=</span> mAndroidApplication<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>processName <span class="token operator">=</span> <span class="token string">"system:ui"</span><span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>launchMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>LAUNCH_MULTIPLE<span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>documentLaunchMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_NEVER<span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>flags <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_EXCLUDE_FROM_RECENTS<span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>theme <span class="token operator">=</span> R<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Theme_Material_Dialog_Alert<span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>exported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>RESIZE_MODE_RESIZEABLE<span class="token punctuation">;</span>                    mResolveActivity<span class="token punctuation">.</span>configChanges <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SCREEN_SIZE                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SMALLEST_SCREEN_SIZE                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SCREEN_LAYOUT                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_ORIENTATION                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_KEYBOARD                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_KEYBOARD_HIDDEN<span class="token punctuation">;</span>                    mResolveInfo<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> mResolveActivity<span class="token punctuation">;</span>                    mResolveInfo<span class="token punctuation">.</span>priority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    mResolveInfo<span class="token punctuation">.</span>preferredOrder <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    mResolveInfo<span class="token punctuation">.</span>match <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    mResolveComponentName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>                             mAndroidApplication<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> mResolveActivity<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// åœ¨æ­¤ä¹‹å‰ï¼Œå››å¤§ç»„ä»¶çš„ä¿¡æ¯éƒ½æ˜¯ Package å¯¹è±¡çš„ç§æœ‰å˜é‡ï¼Œé€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œ</span>        <span class="token comment" spellcheck="true">// å°†ä»–ä»¬æ³¨å†Œåˆ° PackageManagerService é‡Œé¢ï¼Œ</span>        <span class="token comment" spellcheck="true">// è¿™æ · PackageManagerService å°±æœ‰äº†æ‰€æœ‰çš„ç»„ä»¶ä¿¡æ¯</span>        <span class="token keyword">int</span> N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        StringBuilder r <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">int</span> i<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ³¨å†Œ pkg é‡Œé¢çš„ provider åˆ° PackageManagerService ä¸Šçš„ mProvider ä¸Š</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageParser<span class="token punctuation">.</span>Provider p <span class="token operator">=</span> pkg<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è®¾ç½®è¿›ç¨‹åç§°ï¼Œå¦‚æœåœ¨ AndroidManifest é‡Œé¢é…ç½®äº†è¿›ç¨‹åç§°ï¼Œå°±ä»¥é…ç½®ä¸ºå‡†ï¼Œ</span>            <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°±æ˜¯é»˜è®¤åŒ…å</span>            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>processName <span class="token operator">=</span> <span class="token function">fixProcessName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>                        p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>            mProviders<span class="token punctuation">.</span><span class="token function">addProvider</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            p<span class="token punctuation">.</span>syncable <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>isSyncable<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                String names<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>syncable<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>Provider</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>                        p<span class="token punctuation">.</span>syncable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">+</span> <span class="token string">";"</span> <span class="token operator">+</span> names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        PackageParser<span class="token punctuation">.</span>Provider other <span class="token operator">=</span> mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>chatty<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ³¨å†Œè¯¥ Package ä¸­çš„ service åˆ° PackageManagerService çš„ mServices ä¸Š</span>        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ³¨å†Œ pkg é‡Œé¢çš„ receiver åˆ° PackageManagerService ä¸Šçš„ mReceivers ä¸Š</span>        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mReceivers<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ³¨å†Œ pkg é‡Œé¢çš„ activity åˆ° PackageManagerService ä¸Šçš„ mActivities ä¸Š</span>        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mActivities<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Don't allow ephemeral applications to define new permissions groups.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permission groups from package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName                    <span class="token operator">+</span> <span class="token string">" ignored: instant apps cannot define new permission groups."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            mPermissionManager<span class="token punctuation">.</span><span class="token function">addAllPermissionGroups</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Don't allow ephemeral applications to define new permissions.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permissions from package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName                    <span class="token operator">+</span> <span class="token string">" ignored: instant apps cannot define new permissions."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            mPermissionManager<span class="token punctuation">.</span><span class="token function">addAllPermissions</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//  æ³¨å†Œ pkg é‡Œé¢çš„ instrumentation åˆ° PackageManagerService çš„ mInstrumentation ä¸­</span>        <span class="token comment" spellcheck="true">// Instrumentation ç”¨æ¥è·Ÿè¸ªæœ¬åº”ç”¨å†…çš„ application åŠ activity çš„ç”Ÿå‘½å‘¨æœŸ</span>        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageParser<span class="token punctuation">.</span>Instrumentation a <span class="token operator">=</span> pkg<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>sourceDir <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>sourceDir<span class="token punctuation">;</span>            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>publicSourceDir <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>publicSourceDir<span class="token punctuation">;</span>            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitSourceDirs <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitSourceDirs<span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mInstrumentation<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getComponentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¦‚æœæœ‰åŒ…å†…å¹¿æ’­</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>protectedBroadcasts <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mProtectedBroadcasts<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mProtectedBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-3-æ‰«æéç³»ç»Ÿ-Package"><a href="#2-3-æ‰«æéç³»ç»Ÿ-Package" class="headerlink" title="2.3 æ‰«æéç³»ç»Ÿ Package"></a>2.3 æ‰«æéç³»ç»Ÿ Package</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*  * mOnlyCore ç”¨äºæ§åˆ¶æ˜¯å¦æ‰«æéç³»ç»Ÿ Package */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// do this first before mucking with mPackages for the "expecting better" case</span>    <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageParser<span class="token punctuation">.</span>Package<span class="token operator">></span> pkgIterator <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>pkgIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg <span class="token operator">=</span> pkgIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>isStub<span class="token punctuation">)</span> <span class="token punctuation">{</span>            stubSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> psit <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>psit<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        PackageSetting ps <span class="token operator">=</span> psit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*         * If this is not a system app, it can't be a         * disable system app.         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/*         * If the package is scanned, it's not erased.         */</span>        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>scannedPkg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">removePackageLI</span><span class="token punctuation">(</span>scannedPkg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                mExpectingBetter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ps<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            psit<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> PackageSetting disabledPs <span class="token operator">=</span>                    mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>disabledPs<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>disabledPs<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token operator">||</span> disabledPs<span class="token punctuation">.</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                possiblyDeletedUpdatedSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ‰«æ /data/app ç›®å½•</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>mAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ‰«æ /data/app-private ç›®å½•</span>    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>mDrmAppPrivateInstallDir<span class="token punctuation">,</span> mDefParseFlags            <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_FORWARD_LOCK<span class="token punctuation">,</span>            scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è¿™é‡Œæ£€æŸ¥ç”¨æˆ·ç›®å½•ä¸‹å‡çº§æ–‡ä»¶æ˜¯å¦è¿˜å­˜åœ¨ï¼Œç„¶åè¿›è¡Œå¤„ç†</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>String deletedAppName <span class="token operator">:</span> possiblyDeletedUpdatedSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>        PackageParser<span class="token punctuation">.</span>Package deletedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ä» mSettings.mDisabledSysPackages å˜é‡ä¸­ç§»é™¤å»æ­¤åº”ç”¨</span>        mSettings<span class="token punctuation">.</span><span class="token function">removeDisabledSystemPackageLPw</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> String msg<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ç”¨æˆ·ç›®å½•ä¸­ä¹Ÿæ²¡æœ‰å‡çº§åŒ…ï¼Œåˆ™è‚¯å®šæ˜¯æ®‹ç•™çš„åº”ç”¨ä¿¡æ¯ï¼Œåˆ™æŠŠå®ƒçš„æ•°æ®ç›®å½•åˆ é™¤æ‰</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>deletedPkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg <span class="token operator">=</span> <span class="token string">"Updated system package "</span> <span class="token operator">+</span> deletedAppName                    <span class="token operator">+</span> <span class="token string">" no longer exists; removing its data"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¦‚æœåœ¨ç”¨æˆ·ç©ºé—´æ‰¾åˆ°äº†æ–‡ä»¶ï¼Œåˆ™è¯´æ˜ç³»ç»Ÿç›®å½•ä¸‹çš„æ–‡ä»¶å¯èƒ½è¢«åˆ é™¤äº†ï¼Œ</span>        <span class="token comment" spellcheck="true">// å› æ­¤ï¼ŒæŠŠåº”ç”¨çš„ç³»ç»Ÿå±æ€§å»æ‰ï¼Œä»¥æ™®é€šåº”ç”¨çš„æ–¹å¼è¿è¡Œ</span>            msg <span class="token operator">=</span> <span class="token string">"Updated system package + "</span> <span class="token operator">+</span> deletedAppName                    <span class="token operator">+</span> <span class="token string">" no longer exists; revoking system privileges"</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> PackageSetting deletedPs <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>            deletedPkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>            deletedPs<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æŠ¥å‘Šç³»ç»Ÿå‘ç”Ÿäº†ä¸ä¸€è‡´çš„æƒ…å†µ</span>        <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¤„ç† mExpectingBetter åˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨çš„åº”ç”¨æ˜¯å¸¦æœ‰å‡çº§åŒ…çš„ç³»ç»Ÿçš„åº”ç”¨ï¼Œ</span>    <span class="token comment" spellcheck="true">// å‰é¢æŠŠä»–ä»¬ä» mPackages åˆ—è¡¨ä¸­æ¸…é™¤äº†å¹¶æ”¾åˆ° mExpectingBetter åˆ—è¡¨ï¼Œ</span>    <span class="token comment" spellcheck="true">// æœ€åä¹Ÿå¯¹ä»–ä»¬è¿›è¡Œæ‰«æå¤„ç†ï¼Œä½†ä¸ä¼šæ”¾åˆ° mPackages ä¸­ã€‚</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> String packageName <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> File scanFile <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> reparseFlags<span class="token punctuation">;</span>            <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> rescanFlags<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ç¡®ä¿åº”ç”¨ä½äºä¸‹é¢çš„ç³»ç»Ÿåº”ç”¨ç›®å½•ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™ä¸éœ€è¦å¤„ç†</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                reparseFlags <span class="token operator">=</span>                        mDefParseFlags <span class="token operator">|</span>                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>                rescanFlags <span class="token operator">=</span>                        scanFlags                        <span class="token operator">|</span> SCAN_AS_SYSTEM                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                reparseFlags <span class="token operator">=</span>                        mDefParseFlags <span class="token operator">|</span>                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>                rescanFlags <span class="token operator">=</span>                        scanFlags                        <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedVendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>                       <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedOdmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                reparseFlags <span class="token operator">=</span>                        mDefParseFlags <span class="token operator">|</span>                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>                rescanFlags <span class="token operator">=</span>                        scanFlags                        <span class="token operator">|</span> SCAN_AS_SYSTEM                        <span class="token operator">|</span> SCAN_AS_VENDOR                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>                       <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>odmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                reparseFlags <span class="token operator">=</span>                        mDefParseFlags <span class="token operator">|</span>                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>                rescanFlags <span class="token operator">=</span>                        scanFlags                        <span class="token operator">|</span> SCAN_AS_SYSTEM                        <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                reparseFlags <span class="token operator">=</span>                        mDefParseFlags <span class="token operator">|</span>                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>                rescanFlags <span class="token operator">=</span>                        scanFlags                        <span class="token operator">|</span> SCAN_AS_SYSTEM                        <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedProductAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                reparseFlags <span class="token operator">=</span>                        mDefParseFlags <span class="token operator">|</span>                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>                rescanFlags <span class="token operator">=</span>                        scanFlags                        <span class="token operator">|</span> SCAN_AS_SYSTEM                        <span class="token operator">|</span> SCAN_AS_PRODUCT                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>productAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                reparseFlags <span class="token operator">=</span>                        mDefParseFlags <span class="token operator">|</span>                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>                rescanFlags <span class="token operator">=</span>                        scanFlags                        <span class="token operator">|</span> SCAN_AS_SYSTEM                        <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Ignoring unexpected fallback path "</span> <span class="token operator">+</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å¦‚æœåº”ç”¨ä¸åœ¨ä¸Šé¢è¿™äº›ç›®å½•ï¼Œç»§ç»­å¾ªç¯ï¼Œä¸è¦å¤„ç†</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// é‡æ–°æ‰«æä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ª &lt;update-package> æ ‡ç­¾</span>                <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>scanFile<span class="token punctuation">,</span> reparseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to parse original system package: "</span>                        <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Uncompress and install any stubbed system applications.</span>    <span class="token comment" spellcheck="true">// This must be done last to ensure all stubs are replaced or disabled.</span>    <span class="token function">decompressSystemApplications</span><span class="token punctuation">(</span>stubSystemApps<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">int</span> cachedNonSystemApps <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>sCachedPackageReadCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token operator">-</span> cachedSystemApps<span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">long</span> dataScanTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemScanTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">int</span> dataPackagesCount <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemPackagesCount<span class="token punctuation">;</span>    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Finished scanning non-system apps. Time: "</span> <span class="token operator">+</span> dataScanTime            <span class="token operator">+</span> <span class="token string">" ms, packageCount: "</span> <span class="token operator">+</span> dataPackagesCount            <span class="token operator">+</span> <span class="token string">" , timePerPackage: "</span>            <span class="token operator">+</span> <span class="token punctuation">(</span>dataPackagesCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> dataScanTime <span class="token operator">/</span> dataPackagesCount<span class="token punctuation">)</span>            <span class="token operator">+</span> <span class="token string">" , cached: "</span> <span class="token operator">+</span> cachedNonSystemApps<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">&amp;&amp;</span> dataPackagesCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        MetricsLogger<span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"ota_package_manager_data_app_avg_scan_time"</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> dataScanTime<span class="token punctuation">)</span> <span class="token operator">/</span> dataPackagesCount<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ã€€ã€€ã€€ã€€<span class="token comment" spellcheck="true">//ã€€æ‰«æéç³»ç»Ÿ apkã€€å·¥ä½œå®Œæˆï¼</span><span class="token punctuation">}</span></code></pre><h1 id="ä¸‰ã€æ‰«å°¾å·¥ä½œ"><a href="#ä¸‰ã€æ‰«å°¾å·¥ä½œ" class="headerlink" title="ä¸‰ã€æ‰«å°¾å·¥ä½œ"></a>ä¸‰ã€æ‰«å°¾å·¥ä½œ</h1><p>è¿™éƒ¨åˆ†ä»»åŠ¡æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†ç¬¬äºŒé˜¶æ®µ APK çš„ä¿¡æ¯å†é›†ä¸­æ•´ç†ä¸€æ¬¡ï¼Œå¯è‡ªè¡Œç ”ç©¶ã€‚</p><hr><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://www.2cto.com/kf/201609/551752.html" target="_blank" rel="noopener">Android7.0 PackageManagerService (2) PKMSæ„é€ å‡½æ•°çš„ä¸»è¦å·¥ä½œ</a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/8e2831428110" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£7â€”â€”PackageManagerServiceçš„å¯åŠ¨æµç¨‹(ä¸Š)</a></p><hr><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/01/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%881%EF%BC%89%E4%B9%8B%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/10/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%883%EF%BC%89%E4%B9%8B%20PackageManager/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ3ï¼‰- PackageManager</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
            <tag> PMS æ„é€ å‡½æ•° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</title>
      <link href="/2019/01/01/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-1-qi-dong-liu-cheng/"/>
      <url>/2019/01/01/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-1-qi-dong-liu-cheng/</url>
      
        <content type="html"><![CDATA[<p><br></p><p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p><table><thead><tr><th style="text-align:center">&nbsp;</th><th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th></tr></thead><tbody><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td></tr><tr><td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td></tr><tr><td style="text-align:center"></td><td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† Android 9.0 æºç ä¸­ PMS çš„å¯åŠ¨æµç¨‹ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€é‡æ–°æ¢³ç†æ¶‰åŠ Settings çš„ä»£ç é€»è¾‘ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">3ã€é‡æ–°æ¢³ç† XML æ–‡ä»¶æ‰«æçš„ä»£ç é€»è¾‘ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">4ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆç­‰ä¼˜åŒ–ï¼›</font></p><p><br></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">Process.java</font></td><td>frameworks/base/core/java/android/os/Process.java</td></tr><tr><td><font color="#D15FEE">Settings.java</font></td><td>frameworks/base/services/core/java/com/android/server/pm/Settings.java</td></tr><tr><td><font color="#D15FEE">SettingBase.java</font></td><td>frameworks/base/services/core/java/com/android/server/pm/SettingBase.java</td></tr><tr><td><font color="#D15FEE">SystemConfig.java</font></td><td>frameworks/base/core/java/com/android/server/SystemConfig.java</td></tr><tr><td><font color="#D15FEE">SystemServer.java</font></td><td>frameworks/base/services/java/com/android/server/SystemServer.java</td></tr><tr><td><font color="#D15FEE">SharedUserSetting.java</font></td><td>frameworks/base/services/core/java/com/android/server/pm/SharedUserSetting.java</td></tr><tr><td><font color="#D15FEE">PackageManagerService.java</font></td><td>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td></tr></tbody></table><h2 id="1-2-ç®€ä»‹"><a href="#1-2-ç®€ä»‹" class="headerlink" title="1.2 ç®€ä»‹"></a>1.2 ç®€ä»‹</h2><p><strong><font color="#0000CD">PackageManagerServiceï¼ˆPMSï¼‰</font></strong>æ˜¯ SystemServer å¯åŠ¨åçš„ç¬¬ä¸€ä¸ªæ ¸å¿ƒæœåŠ¡ï¼Œä¹Ÿæ˜¯ Android ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„æœåŠ¡ä¹‹ä¸€ã€‚å®ƒè´Ÿè´£ç³»ç»Ÿä¸­ Package çš„ç®¡ç†ï¼Œåº”ç”¨ç¨‹åºçš„å®‰è£…ã€å¸è½½ã€ä¿¡æ¯æŸ¥è¯¢ç­‰ã€‚å¦‚æœä½ æ˜¯é¢å‘ Android ç³»ç»Ÿå¼€å‘çš„å·¥ç¨‹å¸ˆï¼ŒåŸºç¡€æ¦‚å¿µæˆ‘ä¹Ÿä¸éœ€è¦å†å¤šèµ˜è¿°ï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯é˜…è¯»åˆ†ææºç ï¼Œé’»ç ”æ›´æ·±å±‚æ¬¡çš„åŸç†ã€‚</p><h2 id="1-3-å®¶æ—è°±"><a href="#1-3-å®¶æ—è°±" class="headerlink" title="1.3 å®¶æ—è°±"></a>1.3 å®¶æ—è°±</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ PackageManagerService åŠå®¢æˆ·ç«¯çš„å®¶æ—è°±ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè¿™å¼ å›¾æš‚ä¸”åªéœ€è¦æœ‰ä¸ªå°è±¡ï¼Œæ•´ä¸ªç³»åˆ—åˆ†æå®Œå†å›æ¥çœ‹è¿™ä¸ªå®¶æ—è°±ï¼Œä½ ä¼šæ¸…æ™°å¾ˆå¤šï¼ï¼‰</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-ece68587e315bc1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å®¶æ—è°±.png"></center><p><strong><font color="#436EEE" size="3">ç®€å•è¯´æ˜ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° IPackageManager æ¥å£ç±»ä¸­å®šä¹‰äº†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é€šä¿¡çš„ä¸šåŠ¡å‡½æ•°ï¼Œè¿˜å®šä¹‰äº†å†…éƒ¨ç±» Stubï¼Œè¯¥ç±»ä» Binder æ´¾ç”Ÿå¹¶å®ç°äº† IPackageManager æ¥å£ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° PackageManagerService ç»§æ‰¿è‡ª IPackageManager.Stubç±»ï¼Œç”±äº Stub ç±»ä» Binder æ´¾ç”Ÿï¼Œå› æ­¤ PackageManagerService å°†ä½œä¸ºæœåŠ¡ç«¯å‚ä¸ Binder é€šä¿¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° Stub ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±» Proxyï¼Œè¯¥ç±»æœ‰ä¸€ä¸ª IBinderç±»å‹ï¼ˆå®é™…ç±»å‹ä¸º BinderProxyï¼‰çš„æˆå‘˜å˜é‡ mRemoteï¼ŒmRemote ç”¨äºå’ŒæœåŠ¡ç«¯ PackageManagerServiceé€šä¿¡ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° IPackageManager æ¥å£ç±»ä¸­å®šä¹‰äº†è®¸å¤šä¸šåŠ¡å‡½æ•°ï¼Œä½†æ˜¯å¤„äºå®‰å…¨ç­‰æ–¹é¢çš„è€ƒè™‘ï¼ŒAndroid å¯¹å¤–ï¼ˆå³SDKï¼‰æä¾›çš„åªæ˜¯ä¸€ä¸ªå­é›†ï¼Œè¯¥å­ç±»è¢«å°è£…åœ¨æŠ½è±¡ç±» PackageManagerä¸­ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬é€šè¿‡ Context çš„ getPackageManager å‡½æ•°è¿”å›ä¸€ä¸ªç±»å‹ä¸º PackageManagerçš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„å®é™…ç±»å‹æ˜¯ PackageManager çš„å­ç±» ApplicationPackageManagerã€‚è¿™ç§åŸºäºæ¥å£ç¼–ç¨‹çš„æ–¹å¼ï¼Œè™½ç„¶æå¤§é™ä½äº†æ¨¡å—ä¹‹é—´çš„è€¦åˆæ€§ï¼Œå´ç»™ä»£ç åˆ†æå¸¦æ¥äº†ä¸å°çš„éº»çƒ¦ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° ApplicationPackageManager ç±»ç»§æ‰¿è‡ª PackageManagerç±»ã€‚å®ƒå¹¶æ²¡æœ‰ç›´æ¥å‚ä¸ Binder é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡ mPM æˆå‘˜å˜é‡æŒ‡å‘ä¸€ä¸ª IPackageManager.Stub.Proxy ç±»å‹çš„å¯¹è±¡ã€‚</p><blockquote><p><strong><font color="#FF0000">ã€æç¤ºã€‘ï¼š</font></strong>åœ¨ä½ è‡ªå·±çš„åˆ†æè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‘ç°æºç ä¸­æ‰¾ä¸åˆ° IPackageManager.java è¿™ä¸ªæ–‡ä»¶ã€‚å…¶å®è¯¥æ–‡ä»¶æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ï¼Œæœ€ç»ˆçš„æ–‡ä»¶ä½äº Android æºç  outï¼ˆ<code>/out/target/common/obj/JAVA_LIBRARIES/framework_intermediates/core/java/android/content/pm</code>ï¼‰ç›®å½•ä¸‹é¢ã€‚</p></blockquote><p><strong><font color="#0000FF">IPackageManager.javaï¼š</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IInterface</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/** Local-side IPC implementation stub class. */</span>    <span class="token comment" spellcheck="true">// å®šä¹‰å†…éƒ¨ç±» Stubï¼Œæ´¾ç”Ÿè‡ª Binderï¼Œå®ç° IPackageManager æ¥å£</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Stub</span> <span class="token keyword">extends</span> <span class="token class-name">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Binder</span>                                      <span class="token keyword">implements</span> <span class="token class-name">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>IPackageManager</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String DESCRIPTOR <span class="token operator">=</span>                                       <span class="token string">"android.content.pm.IPackageManager"</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/** Construct the stub at attach it to the interface. */</span>        <span class="token keyword">public</span> <span class="token function">Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// å®šä¹‰ Stub çš„å†…éƒ¨ç±» Proxyï¼Œå®ç° IPackageManager æ¥å£</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>IPackageManager</span> <span class="token punctuation">{</span>            <span class="token keyword">private</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IBinder mRemote<span class="token punctuation">;</span>            <span class="token function">Proxy</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IBinder remote<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#436EEE">çœ‹æºç ï¼Œæ¢³ç†æµç¨‹ï¼Œå°±åƒæ˜¯èµ°è¿›è¿·å®«ï¼Œå¾ˆå®¹æ˜“è¿·å¤±ï¼</font></strong></p><p>æ‰€ä»¥åœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ç»™å¤§å®¶ä¸€äº›å»ºè®®ï¼š<strong><font color="#FF0000">ç´§æŠ“ä¸»å¹²ï¼Œç†Ÿæ‚‰æµç¨‹ï¼Œå†å•ƒç»†èŠ‚ï¼</font></strong></p><hr><h1 id="äºŒã€SystemServer"><a href="#äºŒã€SystemServer" class="headerlink" title="äºŒã€SystemServer"></a>äºŒã€SystemServer</h1><p>å…ˆæ¥è¯´è¯´ PackageManagerService æ˜¯æ€ä¹ˆå¯åŠ¨çš„ï¼Ÿ</p><p><code>PackageManagerService</code> ä½œä¸ºç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡ï¼Œç”± <code>SystemServer</code> åˆ›å»ºï¼Œ<code>SystemServer</code> è°ƒç”¨äº† <code>PackageManagerService</code> çš„ <code>main()</code> åˆ›å»º <code>PackageManagerService å®ä¾‹</code>ã€‚</p><h2 id="2-1-main"><a href="#2-1-main" class="headerlink" title="2.1 main"></a>2.1 main</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/java/com/android/server/SystemServer.java</span><span class="token comment" spellcheck="true">/**  * The main entry point from zygote.  */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">new</span> <span class="token class-name">SystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Start services.</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="2-2-startBootstrapServices"><a href="#2-2-startBootstrapServices" class="headerlink" title="2.2 startBootstrapServices"></a>2.2 startBootstrapServices</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/java/com/android/server/SystemServer.java</span><span class="token keyword">private</span> PackageManagerService mPackageManagerService<span class="token punctuation">;</span><span class="token keyword">private</span> Context mSystemContext<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">boolean</span> mOnlyCore<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨ PMS çš„ main å‡½æ•°ï¼Œä¸»è¦æ˜¯åˆ›å»º PMS æœåŠ¡ï¼Œå¹¶æ³¨å†Œåˆ° ServiceManagerï¼ˆæœåŠ¡ç®¡å®¶ï¼‰</span>    mPackageManagerService <span class="token operator">=</span> PackageManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>                mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_OFF<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// è·å– PackageManager</span>    mPackageManager <span class="token operator">=</span> mSystemContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="2-3-startOtherServices"><a href="#2-3-startOtherServices" class="headerlink" title="2.3 startOtherServices"></a>2.3 startOtherServices</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/java/com/android/server/SystemServer.java</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"MakePackageManagerServiceReady"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mPackageManagerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><hr><h1 id="ä¸‰ã€PackageManagerService"><a href="#ä¸‰ã€PackageManagerService" class="headerlink" title="ä¸‰ã€PackageManagerService"></a>ä¸‰ã€PackageManagerService</h1><p>æŸ¥çœ‹æºç ï¼Œæˆ‘ä»¬çŸ¥é“äº† <code>SystemServer</code> è°ƒç”¨ <code>PackageManagerService</code> çš„ <code>main()</code> åˆ›å»ºäº† <code>PackageManagerService å®ä¾‹</code>ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯å…³æ³¨ PackageManagerService çš„ <code>main()</code> æ–¹æ³•ï¼</p><h2 id="3-1-main"><a href="#3-1-main" class="headerlink" title="3.1 main"></a>3.1 main</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/</span>            PackageManagerService<span class="token punctuation">.</span>java<span class="token keyword">public</span> <span class="token keyword">static</span> PackageManagerService <span class="token function">main</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>                                         <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Self-check for initial settings: æ­¤å¤„ä¸»è¦æ£€æŸ¥ç³»ç»Ÿå±æ€§</span>    PackageManagerServiceCompilerMapping<span class="token punctuation">.</span><span class="token function">checkProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ­¤å¤„åˆ›å»ºæ„é€ å‡½æ•°ï¼Œå…¶ä¸­ï¼ŒfactoryTestï¼šå†³å®šæ˜¯å¦æµ‹è¯•ç‰ˆæœ¬ï¼ŒonlyCoreï¼šå†³å®šæ˜¯å¦åªè§£æç³»ç»Ÿç›®å½•</span>    PackageManagerService m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>                                                         factoryTest<span class="token punctuation">,</span> onlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>    m<span class="token punctuation">.</span><span class="token function">enableSystemUserPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ©ç”¨ Binder é€šä¿¡ï¼Œå°†è‡ªå·±æ³¨å†Œåˆ° ServiceManager è¿›ç¨‹ä¸­ï¼ˆè¿™æ˜¯ Binder æœåŠ¡çš„å¸¸è§„æ³¨å†Œæµç¨‹ï¼‰</span>    ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> PackageManagerNative pmn <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">PackageManagerNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"package_native"</span><span class="token punctuation">,</span> pmn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> m<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è¯¥æ–¹æ³•ä¸»è¦<code>åˆ›å»º PMS å¯¹è±¡</code>ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° <code>ServiceManager</code> ä¸­ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ª <code>HashMap</code> çš„é›†åˆï¼Œå­˜å‚¨äº†å¾ˆå¤šç›¸å…³çš„ Binder æœåŠ¡ï¼Œç¼“å­˜èµ·æ¥ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ <code>getService(key)</code> çš„æ–¹å¼å» <code>Map</code> ä¸­è·å–ã€‚</p><blockquote><p><strong><font color="#436EEE">main å‡½æ•°çœ‹ä¼¼å‡ è¡Œä»£ç å¾ˆç®€å•ï¼Œä½†æ‰§è¡Œæ—¶é—´å´å¾ˆé•¿ã€‚ä¸»è¦åŸå› æ˜¯ PMS åœ¨å…¶â€œæ„é€ å‡½æ•°â€ä¸­åšäº†å¾ˆå¤šâ€œé‡ä½“åŠ›æ´»â€ï¼Œè¿™ä¹Ÿæ˜¯ Android å¯åŠ¨é€Ÿåº¦æ…¢çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</font></strong></p></blockquote><p><strong><font color="#FF0000">å…·ä½“åˆ†æå‰ï¼Œæˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸€ä¸‹ PMS æ„é€ å‡½æ•°çš„ä¸»è¦åŠŸèƒ½ï¼š</font></strong></p><p>æ‰«æ Android ç³»ç»Ÿä¸­å‡ ä¸ªç›®æ ‡æ–‡ä»¶å¤¹ä¸­çš„ APKï¼Œä»è€Œå»ºç«‹åˆé€‚çš„æ•°æ®ç»“æ„æ¥ç®¡ç†å„ç§ä¿¡æ¯ï¼Œå¦‚ï¼šPackage ä¿¡æ¯ã€å››å¤§ç»„ä»¶ä¿¡æ¯ã€æƒé™ä¿¡æ¯ç­‰ã€‚</p><p>æŠ½è±¡åœ°æ¥çœ‹ï¼ŒPMS åƒä¸€ä¸ªåŠ å·¥å‚ï¼Œå®ƒè§£æå®é™…çš„ç‰©ç†æ–‡ä»¶ï¼ˆAPKæ–‡ä»¶ï¼‰ä»¥ç”Ÿæˆç¬¦åˆè‡ªå·±è¦æ±‚çš„äº§å“ã€‚ï¼ˆä¾‹å¦‚ï¼šPMS å°†è§£æ APK åŒ…ä¸­çš„ <code>AndroidManifest.xml</code>ï¼Œå¹¶æ ¹æ®å…¶ä¸­å£°æ˜çš„ <code>Activity æ ‡ç­¾</code>æ¥åˆ›å»ºä¸æ­¤å¯¹åº”çš„å¯¹è±¡å¹¶åŠ ä»¥ä¿ç®¡ã€‚ï¼‰</p><p>ä»æºç è§’åº¦æ¥çœ‹ï¼ŒPMS çš„å·¥ä½œæµç¨‹ç›¸å¯¹ç®€å•ã€‚ä½†æ·±å…¥ç ”ç©¶åï¼Œå‘ç°å…¶å¾ˆå¤æ‚ï¼</p><blockquote><p><strong><font color="#A020F0">å¤æ‚çš„æ˜¯å…¶ä¸­ç”¨äºä¿å­˜å„ç§ä¿¡æ¯çš„<code>æ•°æ®ç»“æ„</code>å’Œ<code>å®ƒä»¬ä¹‹é—´çš„å…³ç³»</code>ï¼Œä»¥åŠå½±å“æœ€ç»ˆç»“æœçš„<code>ç­–ç•¥æ§åˆ¶</code></font></strong>ã€‚</p></blockquote><p>å¦‚æœä½ è‡ªè¡Œç ”ç©¶è¿‡ PMSï¼Œä½ ä¼šå‘ç°ä»£ç ä¸­å­˜åœ¨å¤§é‡ä¸åŒçš„æ•°æ®ç»“æ„ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ä¼šè®©äººå¤§ä¸ºå¤´ç–¼ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬é™¤äº†åˆ†æ PMS çš„å·¥ä½œæµç¨‹ä»¥å¤–ï¼Œä¼šé‡ç‚¹å…³æ³¨é‡è¦çš„æ•°æ®ç»“æ„ä»¥åŠå®ƒä»¬çš„ä½œç”¨ã€‚</p><p><strong><font color="#FF0000">æ¥ä¸‹æ¥å¼€å§‹é‡ç‚¹åˆ†æ PMS çš„æ„é€ å‡½æ•°</font></strong>ï¼Œå¦‚æœæ”¾åœ¨ä¸€ç¯‡æ–‡ç« ä¸­å»åˆ†ææ˜¯å®Œå…¨ä¸å¯èƒ½æ¢³ç†æ¸…æ¥šçš„ï¼</p><p>æˆ‘ä»¬åˆ†ä¸¤éƒ¨åˆ†ç ”ç©¶ï¼Œå¦‚ä¸‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ1ï¼‰ - å‰æœŸå‡†å¤‡å·¥ä½œ</font></strong>&nbsp;<strong><font color="#FF0000">ï¼ˆæœ¬ç¯‡æ–‡ç« è¦è®¨è®ºçš„å†…å®¹ï¼‰</font></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ2ï¼‰ - æ‰«æ Package å’Œ æ‰«å°¾å·¥ä½œ</font></strong> <a href="https://superandroid.pro/2018/11/05/B_02.%20Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%882%EF%BC%89%E4%B9%8B%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/">ã€ŠFramework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°ã€‹</a></p><hr><p>æ­£å¼å¼€å§‹åˆ†æ PMS çš„æ„é€ å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æ­¤å¤„åˆ›å»ºæ„é€ å‡½æ•°ï¼Œå…¶ä¸­ï¼ŒfactoryTestï¼šå†³å®šæ˜¯å¦æµ‹è¯•ç‰ˆæœ¬ï¼ŒonlyCoreï¼šå†³å®šæ˜¯å¦åªè§£æç³»ç»Ÿç›®å½•</span>PackageManagerService m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>                                                     factoryTest<span class="token punctuation">,</span> onlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="3-2-Settings"><a href="#3-2-Settings" class="headerlink" title="3.2 Settings"></a>3.2 Settings</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// public static final int SDK_INT = SystemProperties.getInt("ro.build.version.sdk", 0);</span><span class="token keyword">final</span> <span class="token keyword">int</span> mSdkVersion <span class="token operator">=</span> Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>            <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/*     * mSdkVersionæ˜¯ PMS çš„æˆå‘˜å˜é‡ï¼Œå®šä¹‰çš„æ—¶å€™è¿›è¡Œèµ‹å€¼ï¼Œå…¶å€¼å–è‡ªç³»ç»Ÿå±æ€§ ro.build.version.sdk     * å¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œåˆ™ APK å°±æ— æ³•çŸ¥é“è‡ªå·±è¿è¡Œåœ¨ Android å“ªä¸ªç‰ˆæœ¬ä¸Š     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSdkVersion <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"**** ro.build.version.sdk not set!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>    mFactoryTest <span class="token operator">=</span> factoryTest<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è¿è¡Œåœ¨éå·¥å‚æ¨¡å¼ä¸‹</span>    mOnlyCore <span class="token operator">=</span> onlyCore<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ ‡è®°æ˜¯å¦åªåŠ è½½æ ¸å¿ƒæœåŠ¡</span>    mMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å­˜å‚¨ä¸æ˜¾ç¤ºå±ç›¸å…³çš„ä¸€äº›å±æ€§ï¼Œä¾‹å¦‚å±å¹•çš„å®½/é«˜å°ºå¯¸ï¼Œåˆ†è¾¨ç‡ç­‰ä¿¡æ¯</span>    mInstaller <span class="token operator">=</span> installer<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// åˆ›å»º Installer å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å’Œ Native è¿›ç¨‹ installd äº¤äº’</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Expose private service for system components to use.</span>        LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>PackageManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>                                  <span class="token keyword">new</span> <span class="token class-name">PackageManagerInternalImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sUserManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserDataPreparer</span><span class="token punctuation">(</span>mInstaller<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">,</span> mContext<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">,</span>                 mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>        mPermissionManager <span class="token operator">=</span> PermissionManagerService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">DefaultPermissionGrantedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDefaultRuntimePermissionsGranted</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            mSettings<span class="token punctuation">.</span><span class="token function">onDefaultRuntimePermissionsGrantedLPr</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> mPackages <span class="token comment" spellcheck="true">/*externalLock*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mDefaultPermissionPolicy <span class="token operator">=</span> mPermissionManager<span class="token punctuation">.</span><span class="token function">getDefaultPermissionGrantPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Settings æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç±»ï¼Œè¯¥ç±»ç”¨äºå­˜å‚¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›è®¾ç½®ï¼Œæˆ‘ä»¬åé¢ä¼šé‡ç‚¹åˆ†æè¿™ä¸ªç±»ï¼</span>        mSettings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>mPermissionManager<span class="token punctuation">.</span><span class="token function">getPermissionSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ·»åŠ systemã€phoneã€logã€nfcã€bluetoothã€shellè¿™å…­ç§ shareUserId åˆ° mSettings</span>    <span class="token comment" spellcheck="true">// addSharedUserLPw å‡½æ•°åšäº†ä»€ä¹ˆï¼Ÿè¿™æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦åˆ†æçš„é‡ç‚¹ï¼</span>    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.system"</span><span class="token punctuation">,</span> Process<span class="token punctuation">.</span>SYSTEM_UID<span class="token punctuation">,</span>                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.phone"</span><span class="token punctuation">,</span> RADIO_UID<span class="token punctuation">,</span>                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.log"</span><span class="token punctuation">,</span> LOG_UID<span class="token punctuation">,</span>                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.nfc"</span><span class="token punctuation">,</span> NFC_UID<span class="token punctuation">,</span>                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.bluetooth"</span><span class="token punctuation">,</span> BLUETOOTH_UID<span class="token punctuation">,</span>                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.shell"</span><span class="token punctuation">,</span> SHELL_UID<span class="token punctuation">,</span>                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.se"</span><span class="token punctuation">,</span> SE_UID<span class="token punctuation">,</span>                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>åˆšè¿›å…¥æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å°±é‡åˆ°äº†ç¬¬ä¸€ä¸ªè¾ƒä¸ºå¤æ‚çš„æ•°æ®ç»“æ„ <code>Settings</code> ï¼Œä»¥åŠå®ƒçš„ <code>addSharedUserLPw</code> å‡½æ•°ã€‚</p><h4 id="3-2-1-æ„é€ å‡½æ•°"><a href="#3-2-1-æ„é€ å‡½æ•°" class="headerlink" title="3.2.1 æ„é€ å‡½æ•°"></a>3.2.1 æ„é€ å‡½æ•°</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Settings</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token function">Settings</span><span class="token punctuation">(</span>PermissionSettings permissions<span class="token punctuation">,</span> Object lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getDataDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">Settings</span><span class="token punctuation">(</span>File dataDir<span class="token punctuation">,</span> PermissionSettings permission<span class="token punctuation">,</span> Object lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mLock <span class="token operator">=</span> lock<span class="token punctuation">;</span>        mPermissions <span class="token operator">=</span> permission<span class="token punctuation">;</span>        mRuntimePermissionsPersistence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimePermissionPersistence</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºæŒ‡å‘ /data/system/ ç›®å½•çš„ File</span>        mSystemDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dataDir<span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºç›®å½•</span>        mSystemDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileUtils<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  FileUtils<span class="token punctuation">.</span>S_IRWXU<span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IRWXG                  <span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IROTH<span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IXOTH<span class="token punctuation">,</span>                  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ç”¨äºæè¿°ç³»ç»Ÿæ‰€å®‰è£…çš„ Package ä¿¡æ¯</span>        mSettingsFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// packages.xmlçš„å¤‡ä»½ä¿¡æ¯</span>        mBackupSettingsFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-backup.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ä¿å­˜ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰éç³»ç»Ÿè‡ªå¸¦çš„ APK ä¿¡æ¯ï¼Œå³ UID å¤§äº 10000 çš„ apk</span>        mPackageListFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages.list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileUtils<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>mPackageListFilename<span class="token punctuation">,</span> <span class="token number">0640</span><span class="token punctuation">,</span> SYSTEM_UID<span class="token punctuation">,</span> PACKAGE_INFO_GID<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// sdcardfs ç›¸å…³çš„æ–‡ä»¶</span>        <span class="token keyword">final</span> File kernelDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/config/sdcardfs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mKernelMappingFilename <span class="token operator">=</span> kernelDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> kernelDir <span class="token operator">:</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è®°å½•ç³»ç»Ÿä¸­è¢«å¼ºåˆ¶åœæ­¢è¿è¡Œçš„ App ä¿¡æ¯ï¼Œå¦‚æœ‰ App è¢«å¼ºåˆ¶åœæ­¢è¿è¡Œï¼Œä¼šå°†ä¸€äº›ä¿¡æ¯è®°å½•åˆ°è¯¥æ–‡ä»¶ä¸­</span>        mStoppedPackagesFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-stopped.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// packages-stopped.xml çš„å¤‡ä»½ä¿¡æ¯</span>        mBackupStoppedPackagesFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-stopped-backup.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FF0000">Settings çš„æ„é€ å‡½æ•°çš„ä¸»è¦å·¥ä½œï¼šå»ºç«‹ä¸æŸäº›ç³»ç»Ÿé…ç½®æ–‡ä»¶ã€ç›®å½•ä¹‹é—´çš„å…³è”</font></strong>ã€‚é¦–å…ˆï¼Œå®ƒä¼šåˆ›å»ºæŒ‡å‘ <code>/data/system/</code> ç›®å½•çš„ <code>File</code> å®ä¾‹ï¼Œè¿™ä¸ªç›®å½•ä¸‹ä¼šä¿å­˜å¾ˆå¤šç³»ç»Ÿæ–‡ä»¶ã€‚å…¶æ¬¡ï¼Œå°±æ˜¯åˆ›å»º <code>/data/system/</code> ç›®å½•ä¸‹çš„æŸäº› <code>.xml æ–‡ä»¶</code> æˆ–å…¶ä»–æ–‡ä»¶çš„ <code>File</code> å®ä¾‹ã€‚</p><p>ä¸Šé¢æºç ä¸­æ¶‰åŠåˆ° 5 ä¸ªæ–‡ä»¶ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages.xmlï¼š</font> PMS æ‰«æå®Œç›®æ ‡æ–‡ä»¶å¤¹åï¼Œä¼šåˆ›å»ºpackages.xmlã€‚å½“ç³»ç»Ÿè¿›è¡Œç¨‹åºå®‰è£…ã€å¸è½½å’Œæ›´æ–°ç­‰æ“ä½œæ—¶ï¼Œå‡ä¼šæ›´æ–°è¯¥æ–‡ä»¶;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages-backup.xmlï¼š</font>packages.xml æ–‡ä»¶çš„å¤‡ä»½;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages.listï¼š</font>ç”¨äºæè¿°ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰éç³»ç»Ÿè‡ªå¸¦çš„ APK ä¿¡æ¯ã€‚å½“è¿™äº› APK æœ‰å˜åŒ–æ—¶ï¼ŒPKMSå°±ä¼šæ›´æ–°è¯¥æ–‡ä»¶;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages-stopped.xmlï¼š</font>è®°å½•è¢«ç”¨æˆ·å¼ºè¡Œåœæ­¢çš„åº”ç”¨çš„ Package ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œä»è®¾ç½®è¿›å…¥æŸä¸ªåº”ç”¨ï¼Œç„¶åç‚¹å‡»å¼ºè¡Œåœæ­¢ï¼Œé‚£ä¹ˆåº”ç”¨çš„Packageä¿¡æ¯å°±ä¼šè¢«è®°å½•ï¼‰;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages-stopped-back.xmlï¼š</font>packages-stopped.xml æ–‡ä»¶çš„å¤‡ä»½ã€‚</p><blockquote><p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„ä»‹ç»ä¸­æ¶‰åŠåˆ°äº†ä¸¤ä¸ª <code>back-up</code> æ–‡ä»¶ï¼Œå®ƒä»¬æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿå…¶å® Android ç³»ç»Ÿåœ¨ä¿®æ”¹ <code>packages.xml</code>ã€<code>packages-stopped.xml</code> ä¹‹å‰ï¼Œä¼šå…ˆå¯¹å®ƒä»¬è¿›è¡Œ<code>å¤‡ä»½</code>ã€‚å½“å¯¹å®ƒä»¬çš„ä¿®æ”¹æ“ä½œæ­£å¸¸å®Œæˆï¼Œåˆ™ä¼šåˆ æ‰å¤‡ä»½çš„æ–‡ä»¶ã€‚å¦‚æœåœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­ç³»ç»Ÿå‡ºç°é—®é¢˜é‡å¯äº†ï¼Œä¼šå†æ¬¡å»è¯»å–è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼›å¦‚æœæ­¤æ—¶å‘ç°å®ƒä»¬çš„å¤‡ä»½æ–‡ä»¶è¿˜å­˜åœ¨ï¼Œåˆ™è¯´æ˜ä¸Šä¸€æ¬¡å¯¹ä¸¤ä»½æ–‡ä»¶çš„ä¿®æ”¹æ“ä½œå‘ç”Ÿäº†å¼‚å¸¸ï¼Œè¿™ä¸¤ä»½æ–‡ä»¶çš„å†…å®¹å¯èƒ½å·²ç»ä¸å‡†ç¡®äº†ï¼Œè¿™æ—¶ç³»ç»Ÿä¼šå»ä½¿ç”¨ä¹‹å‰å¤‡ä»½çš„æ–‡ä»¶çš„å†…å®¹ã€‚</p></blockquote><p>åˆ›å»ºå®Œç›¸å…³ç³»ç»Ÿæ–‡ä»¶ File å®ä¾‹åï¼ŒSettings çš„æ„é€ å·¥ä½œä¹Ÿå°±ç»“æŸäº†ã€‚</p><p>ä¹‹å‰æˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼š<strong><font color="#63B8FF">addSharedUserLPw å‡½æ•°åšäº†ä»€ä¹ˆï¼Ÿ</font></strong>ä»ä¸Šé¢æˆªå–ä¸€æ®µä»£ç å›é¡¾ä¸€ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java">mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.system"</span><span class="token punctuation">,</span> Process<span class="token punctuation">.</span>SYSTEM_UID<span class="token punctuation">,</span>            ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>addSharedUserLPw ä¼ é€’äº† 4 ä¸ªå‚æ•°ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;android.uid.system</font>ï¼šå­—ç¬¦ä¸²ï¼Œname å’Œ uid ä¸€ä¸€å¯¹åº”</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>public static final int SYSTEM_UID = 1000;</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;Process.SYSTEM_UID</font>ï¼šå€¼ä¸º 1000ï¼Œname å’Œ uid ä¸€ä¸€å¯¹åº”</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>public static final int FLAG_SYSTEM = 1&lt;&lt;0;</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;ApplicationInfo.FLAG_SYSTEM</font>ï¼šæ ‡å¿—</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>public static final int PRIVATE_FLAG_PRIVILEGED = 1&lt;&lt;3;</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;ApplicationInfo.PRIVATE_FLAG_PRIVILEGED</font>ï¼šç‰¹æƒApk</p><p>å¯¹ addSharedUserLPw å‡½æ•°åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ <code>SYSTEM_UID</code> çš„ç›¸å…³çŸ¥è¯†ã€‚</p><hr><h3 id="3-2-2-UID-GID"><a href="#3-2-2-UID-GID" class="headerlink" title="3.2.2 UID/GID"></a>3.2.2 UID/GID</h3><p><strong><font color="#FF0000">UID ä¸º <code>ç”¨æˆ· ID</code> çš„ç¼©å†™ï¼ŒGID ä¸º <code>ç”¨æˆ·ç»„ ID</code> çš„ç¼©å†™</font></strong>ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ UIDï¼ˆå³æ ‡ç¤ºè¯¥è¿›ç¨‹å±äºå“ªä¸ªç”¨æˆ·ï¼Œä¸åŒç”¨æˆ·æ‹¥æœ‰ä¸åŒæƒé™ï¼‰ã€‚ä¸€ä¸ªè¿›ç¨‹ä¹Ÿå¯åˆ†å±ä¸ç”¨çš„ç”¨æˆ·ç»„ï¼ˆæ¯ä¸ªç”¨æˆ·éƒ½æœ‰å¯¹åº”çš„æƒé™ï¼‰ã€‚<strong><font color="#FF0000">UID/GID å’Œè¿›ç¨‹çš„æƒé™æœ‰å…³</font></strong>ã€‚</p><p>åœ¨ Android å¹³å°ä¸­ï¼Œç³»ç»Ÿå®šä¹‰çš„ UID/GID åœ¨ <strong><font color="#8470FF">Process.java</font></strong> æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼ˆåˆ—ä¸¾éƒ¨åˆ†ï¼‰ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/android/os/Process.java</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYSTEM_UID <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// ç³»ç»Ÿè¿›ç¨‹çš„ UID/GID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PHONE_UID <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// Phone è¿›ç¨‹çš„ UID/GID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHELL_UID <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// shell è¿›ç¨‹çš„ UID/GID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> LOG_UID <span class="token operator">=</span> <span class="token number">1007</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// LOG è¿›ç¨‹çš„ UID/GID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> WIFI_UID <span class="token operator">=</span> <span class="token number">1010</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// WIFI è¿›ç¨‹çš„ UID/GID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MEDIA_UID <span class="token operator">=</span> <span class="token number">1013</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// mediaserver è¿›ç¨‹çš„ UID/GID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NFC_UID <span class="token operator">=</span> <span class="token number">1027</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// NFC è¿›ç¨‹çš„ UID/GID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> FIRST_APPLICATION_UID <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªåº”ç”¨ Package çš„èµ·å§‹ UID</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> LAST_APPLICATION_UID <span class="token operator">=</span> <span class="token number">19999</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç³»ç»Ÿæ‰€æ”¯æŒçš„æœ€å¤§çš„åº”ç”¨ Package çš„ UID</span></code></pre><h3 id="3-2-3-addSharedUserLPw"><a href="#3-2-3-addSharedUserLPw" class="headerlink" title="3.2.3 addSharedUserLPw"></a>3.2.3 addSharedUserLPw</h3><p>ç°åœ¨æˆ‘ä»¬å¼€å§‹åˆ†æ addSharedUserLPw å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/Settings.java</span>SharedUserSetting <span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgPrivateFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ ¹æ® key ä» map ä¸­è·å–å€¼</span>    SharedUserSetting s <span class="token operator">=</span> mSharedUsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœå€¼ä¸ä¸º null å¹¶ä¸”ä¿å­˜çš„ uid å’Œä¼ é€’è¿‡æ¥çš„ä¸€è‡´ï¼Œå°±ç›´æ¥è¿”å›ç»“æœ</span>    <span class="token comment" spellcheck="true">// uid ä¸ä¸€è‡´åˆ™è¿”å› null</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>userId <span class="token operator">==</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> s<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>                    <span class="token string">"Adding duplicate shared user, keeping first: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è‹¥ s ä¸º nullï¼Œåˆ™æ ¹æ®ä¼ é€’è¿‡æ¥çš„å‚æ•°æ–°åˆ›å»ºå¯¹è±¡</span>    s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedUserSetting</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pkgFlags<span class="token punctuation">,</span> pkgPrivateFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>    s<span class="token punctuation">.</span>userId <span class="token operator">=</span> uid<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åœ¨ç³»ç»Ÿä¸­ä¿å­˜å€¼ä¸º uid çš„ ç”¨æˆ· idï¼ŒæˆåŠŸè¿”å› true</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addUserIdLPw</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> s<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mSharedUsers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å°† name ä¸ s é”®å€¼å¯¹æ·»åŠ åˆ° mSharedUsers ä¸­ä¿å­˜</span>        <span class="token keyword">return</span> s<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä»æºç ä¸­æˆ‘ä»¬å‘ç°ï¼ŒSettings ä¸­æœ‰ä¸€ä¸ª <code>mSharedUsers</code> æˆå‘˜ï¼Œè¯¥æˆå‘˜å­˜å‚¨çš„æ˜¯ <code>ã€â€œå­—ç¬¦ä¸²â€ ä¸ â€œSharedUserSettingâ€ é”®å€¼å¯¹ã€‘</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡ <code>å­—ç¬¦ä¸²</code> ä¸º <code>key</code> å¾—åˆ°å¯¹åº”çš„ <code>SharedUserSetting</code> å¯¹è±¡ã€‚</p><p>é‚£ä¹ˆ SharedUserSetting æ˜¯ä»€ä¹ˆï¼Ÿåˆ›å»ºå®ƒçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æï¼</p><h4 id="3-2-3-1-SharedUserSetting"><a href="#3-2-3-1-SharedUserSetting" class="headerlink" title="3.2.3.1 SharedUserSetting"></a>3.2.3.1 SharedUserSetting</h4><p>ä¸ºäº†è§£é‡Š SharedUserSettingï¼Œæˆ‘ä»¬æ‹¿ <strong><font color="#1874CD">SystemUI</font></strong> ä½œä¸ºä¾‹å­æ¥è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹ SystemUI çš„ <code>AndroidManifest.xml</code>ï¼ˆè¿™ä¸ªæ–‡ä»¶ä½ è‚¯å®šä¸é™Œç”Ÿï¼‰ï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">xmlns:</span>androidprv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/prv/res/android<span class="token punctuation">"</span></span>        <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.android.systemui<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>sharedUserId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.uid.system<span class="token punctuation">"</span></span>        <span class="token attr-name">coreApp</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre><p>åœ¨ <code>AndroidManifest.xml</code> ä¸­ï¼Œå£°æ˜äº†ä¸€ä¸ªåä¸º <code>android:sharedUserId</code> çš„å±æ€§ï¼š<code>android.uid.systemui</code>ã€‚</p><p><strong><font color="#FF0000">æœ‰å¿…è¦èŠèŠè¿™ä¸ª â€œsharedUserIdâ€ çš„ä½œç”¨ï¼</font></strong></p><p>1ã€ä¸¤ä¸ªæˆ–å¤šä¸ªå£°æ˜äº†åŒä¸€ç§ <code>sharedUserId</code> çš„ <code>APK</code> å¯å…±äº«å½¼æ­¤çš„æ•°æ®ï¼Œå¹¶ä¸”å¯è¿è¡Œåœ¨åŒä¸€è¿›ç¨‹ä¸­ã€‚</p><p>2ã€é€šè¿‡å£°æ˜ç‰¹å®šçš„ <code>sharedUserId</code>ï¼Œè¯¥ <code>APK</code> æ‰€åœ¨ <code>è¿›ç¨‹</code> å°†è¢«èµ‹äºˆæŒ‡å®šçš„ <code>UID</code>ï¼ˆæ¯”å¦‚æœ¬ä¾‹ä¸­çš„ SystemUI å£°æ˜äº† system çš„ uidï¼Œè¿è¡Œ SystemUI çš„è¿›ç¨‹å°±å¯äº«å— system ç”¨æˆ·æ‰€å¯¹åº”çš„æƒé™ï¼‰ã€‚</p><blockquote><p>é™¤äº†åœ¨ <code>AndroidManifest.xml</code> ä¸­å£°æ˜ <code>sharedUserId</code> å¤–ï¼ŒAPK åœ¨ç¼–è¯‘æ—¶è¿˜å¿…é¡»ä½¿ç”¨å¯¹åº”çš„è¯ä¹¦è¿›è¡Œç­¾åã€‚ä¾‹å¦‚æœ¬ä¾‹çš„ <code>SystemUI</code>ï¼Œåœ¨å…¶ <code>Android.mk</code> ä¸­éœ€è¦é¢å¤–ç”³æ˜ <code>LOCAL_CERTIFICATE := platform</code>ï¼Œå¦‚æ­¤æ‰å¯ä»¥è·å¾—æŒ‡å®šçš„ <code>UID</code>ï¼ˆå½“ç„¶è¿™ä¸ªä¸æ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹ï¼Œåœ¨é¡¹ç›®å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šäº†è§£åˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚</p></blockquote><p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•ç»„ç»‡ä¸€ç§æ•°æ®ç»“æ„æ¥åŒ…æ‹¬ä¸Šé¢çš„å†…å®¹ã€‚</p><p><strong><font color="#FF0000">æœ‰ 3 ä¸ªå…³é”®ç‚¹éœ€è¦æ³¨æ„ï¼š</font></strong></p><blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ &nbsp;XML ä¸­ sharedUserId å±æ€§æŒ‡å®šäº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯ UID çš„å­—ç¬¦ä¸²æè¿°ï¼Œæ•…å¯¹åº”æ•°æ®ç»“æ„ä¸­ä¹Ÿåº”è¯¥æœ‰è¿™æ ·ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™æ ·å°±æŠŠä»£ç å’Œ XML ä¸­çš„å±æ€§è”ç³»èµ·æ¥äº†ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ &nbsp;åœ¨ LINUX ç³»ç»Ÿä¸­ï¼ŒçœŸæ­£çš„ uid æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ‰€ä»¥è¯¥æ•°æ®ç»“æ„ä¸­å¿…ç„¶æœ‰ä¸€ä¸ªæ•´å‹å˜é‡ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ &nbsp;å¤šä¸ª Package å¯å£°æ˜åŒä¸€ä¸ª sharedUserIdï¼Œå› æ­¤è¯¥æ•°æ®ç»“æ„å¿…ç„¶ä¼šä¿å­˜é‚£äº›å£°æ˜äº†ç›¸åŒ sharedUserId çš„ Package çš„æŸäº›ä¿¡æ¯ã€‚</p></blockquote><p>å¯¹ <strong><font color="#8470FF">SharedUserSetting</font></strong> æˆ‘ä»¬åšä¸ªæ€»ç»“ï¼š</p><p>1ã€<code>Settings</code> ç±»å®šä¹‰äº†ä¸€ä¸ª <code>mSharedUsers</code> æˆå‘˜ï¼Œå®ƒæ˜¯ä¸€ä¸ª <code>ArrayMap</code>ï¼Œä»¥ <code>å­—ç¬¦ä¸²</code>ï¼ˆå¦‚ï¼šandroid.uid.systemï¼‰ä¸º <code>key</code>ï¼Œå¯¹åº”çš„ <code>Value</code> æ˜¯ä¸€ä¸ª <code>SharedUserSetting</code> å¯¹è±¡ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> SharedUserSetting<span class="token operator">></span> mSharedUsers <span class="token operator">=</span>                                           <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> SharedUserSetting<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>2ã€<code>SharedUserSetting</code> å®šä¹‰äº†ä¸€ä¸ªæˆå‘˜å˜é‡ <code>packages</code>ï¼Œç±»å‹ä¸º <code>ArraySet</code>ï¼Œç”¨äºä¿å­˜å£°æ˜äº†ç›¸åŒ <code>sharedUserId</code> çš„ <code>Package</code> çš„æƒé™è®¾ç½®ä¿¡æ¯ï¼ˆè¿™ä¸€ç‚¹æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ï¼‰ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SharedUserSetting</span> <span class="token keyword">extends</span> <span class="token class-name">SettingBase</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> String name<span class="token punctuation">;</span>    <span class="token keyword">int</span> userId<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// flags that are associated with this uid, regardless of any package flags</span>    <span class="token keyword">int</span> uidFlags<span class="token punctuation">;</span>    <span class="token keyword">int</span> uidPrivateFlags<span class="token punctuation">;</span>    <span class="token keyword">final</span> ArraySet<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> packages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArraySet</span><span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>3ã€æ¯ä¸ª <code>Package</code> æœ‰è‡ªå·±çš„æƒé™è®¾ç½®ã€‚æƒé™çš„æ¦‚å¿µç”± <code>PackageSeting</code> ç±»è¡¨è¾¾ã€‚è¯¥ç±»ç»§æ‰¿è‡ª <code>PackageSettingBase</code> ç±»ï¼Œ<code>PackageSettingBase</code> åˆç»§æ‰¿è‡ª <code>SettingBase</code>ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PackageSetting</span> <span class="token keyword">extends</span> <span class="token class-name">PackageSettingBase</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PackageSettingBase</span> <span class="token keyword">extends</span> <span class="token class-name">SettingBase</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p><code>SettingBase</code> å¯¹è±¡æŒæœ‰ <code>PermissionsState</code> å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºå¯ç”¨çš„æƒé™ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SettingBase</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token keyword">final</span> PermissionsState mPermissionsState<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>4ã€<code>Settings</code> ä¸­è¿˜æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯ <code>mUserIds</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>mOtherUserIds</code>ï¼Œè¿™ä¸¤ä½æˆå‘˜çš„ç±»å‹åˆ†åˆ«æ˜¯ <code>ArrayList</code> å’Œ <code>SparseArray</code>ã€‚å…¶ç›®çš„æ˜¯ä»¥ <code>UID</code> ä¸ºç´¢å¼•ï¼Œå¾—åˆ°å¯¹åº”çš„ <code>SharedUserSeting</code> å¯¹è±¡ã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»¥ <code>ç´¢å¼•</code> è·å–<code>æ•°ç»„å…ƒç´ </code>çš„é€Ÿåº¦ï¼Œæ¯”ä»¥ <code>Key</code> è·å– <code>ArrayMap</code> ä¸­ <code>å…ƒç´ </code> çš„é€Ÿåº¦è¦å¿«å¾ˆå¤šã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Object<span class="token operator">></span> mUserIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">final</span> SparseArray<span class="token operator">&lt;</span>Object<span class="token operator">></span> mOtherUserIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="3-2-3-2-addUserIdLPw"><a href="#3-2-3-2-addUserIdLPw" class="headerlink" title="3.2.3.2 addUserIdLPw"></a>3.2.3.2 addUserIdLPw</h4><p>æˆ‘ä»¬å›å¿†ä¸€ä¸‹ addSharedUserLPw æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/Settings.java</span>SharedUserSetting <span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgPrivateFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>    SharedUserSetting s <span class="token operator">=</span> mSharedUsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedUserSetting</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pkgFlags<span class="token punctuation">,</span> pkgPrivateFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>    s<span class="token punctuation">.</span>userId <span class="token operator">=</span> uid<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addUserIdLPw</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> s<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mSharedUsers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> s<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æºç ä¸­è¿˜æœ‰ä¸€ä¸ª <code>addUserIdLPw</code> æ–¹æ³•ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯å°† <code>SharedUserSettings</code> å¯¹è±¡ä¿å­˜åˆ°å¯¹åº”çš„æ•°ç»„ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/Settings.java</span><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addUserIdLPw</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> Object obj<span class="token punctuation">,</span> Object name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ç³»ç»Ÿæ‰€æ”¯æŒçš„æœ€å¤§çš„åº”ç”¨ Package çš„ UIDï¼Œä¸èƒ½è¶…å‡ºé™åˆ¶ 19999</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">></span> Process<span class="token punctuation">.</span>LAST_APPLICATION_UID<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªåº”ç”¨ Packageï¼ˆéç³»ç»Ÿå®‰è£…åº”ç”¨ï¼‰çš„èµ·å§‹ UID</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">>=</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è·å–æ•°ç»„çš„é•¿åº¦</span>        <span class="token keyword">int</span> N <span class="token operator">=</span> mUserIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment" spellcheck="true">// è®¡ç®—ç´¢å¼•ï¼Œå…¶å€¼æ˜¯ uid å’Œ FIRST_APPLICATION_UID çš„å·®</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> uid <span class="token operator">-</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> N<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mUserIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>            N<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¦‚æœæ•°ç»„çš„ç›®æ ‡ç´¢å¼•å€¼ä½ç½®æœ‰ä¸ä¸º null çš„å€¼ï¼Œè¯´æ˜å·²ç»æ·»åŠ è¿‡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mUserIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>                    <span class="token string">"Adding duplicate user id: "</span> <span class="token operator">+</span> uid                    <span class="token operator">+</span> <span class="token string">" name="</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åº”ç”¨ Package çš„ uid ç”± mUserIds ä¿å­˜</span>        mUserIds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOtherUserIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>                    <span class="token string">"Adding duplicate shared id: "</span> <span class="token operator">+</span> uid                            <span class="token operator">+</span> <span class="token string">" name="</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// ç³»ç»Ÿ Package çš„ uid ç”± mOtherUserIds ä¿å­˜</span>        mOtherUserIds<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FF0000">è‡³æ­¤å¯¹ Settings çš„åˆ†ææˆ‘ä»¬æš‚æ—¶å‘Šä¸€æ®µè½ã€‚</font></strong></p><h3 id="3-2-4-æ€»ç»“"><a href="#3-2-4-æ€»ç»“" class="headerlink" title="3.2.4 æ€»ç»“"></a>3.2.4 æ€»ç»“</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª SharedUserSettings çš„ç±»å›¾ï¼š(ç±»åæ”¹å˜ï¼ŒåæœŸé‡æ–°è¡¥å›¾)<br><br></p><p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-6aeecba875f5450b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="20160929092228475.jpg"></center><br></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ<code>Settings</code> å¯¹è±¡ä¸­æŒæœ‰å¤šä¸ª <code>SharedUserSetting</code> å¯¹è±¡ï¼Œæ¯ä¸ª <code>SharedUserSetting</code> å¯¹è±¡åˆä¼šæŒæœ‰å¤šä¸ª <code>PackageSetting</code> å¯¹è±¡ã€‚</p><p>ä»ç»§æ‰¿å…³ç³»æ¥çœ‹ï¼Œ<code>SharedUserSetting</code> å’Œ <code>PackageSetting</code> å¯¹è±¡ï¼Œæœ€ç»ˆéƒ½å°†ç»§æ‰¿ <code>SettingBase</code> å¯¹è±¡ã€‚</p><p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ<code>SettingBase</code> å¯¹è±¡æŒæœ‰ <code>PermissionsState</code> å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºå¯ç”¨çš„æƒé™ã€‚</p><p>å› æ­¤ï¼Œ<code>SharedUserSetting</code> å¯¹è±¡å’Œ <code>PackageSetting</code> å¯¹è±¡ä¸­éƒ½å°†åŒ…å«æœ‰ <code>PermissionsState</code>ã€‚</p><p>ä»è€Œæˆ‘ä»¬å¯ä»¥æ®æ­¤æ¨æµ‹å‡ºï¼Œ<code>SharedUserSetting</code> ä¸­æŒæœ‰çš„æ˜¯ä¸€ç»„ <code>Package</code> å…±æœ‰çš„æƒé™ï¼›<code>PackageSetting</code> ä¸­æŒæœ‰çš„æ˜¯å•ä¸ª <code>Package</code> ç‹¬æœ‰çš„æƒé™ã€‚</p><hr><h2 id="3-3-XML-æ–‡ä»¶æ‰«æ"><a href="#3-3-XML-æ–‡ä»¶æ‰«æ" class="headerlink" title="3.3 XML æ–‡ä»¶æ‰«æ"></a>3.3 XML æ–‡ä»¶æ‰«æ</h2><p>åˆ†æå®Œ PMS æ„é€ å‡½æ•°å‰æœŸå·¥ä½œçš„ç¬¬ä¸€é˜¶æ®µåï¼Œæ¥ä¸‹æ¥å°±è¦ç»§ç»­å›åˆ°æ„é€ å‡½æ•°ä¸­åˆ†æå‰©ä¸‹çš„ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç ï¼šframeworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>              <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">// ç¬¬ä¸€é˜¶æ®µ</span>    <span class="token comment" spellcheck="true">// è¯¥å€¼å’Œè°ƒè¯•æœ‰å…³ï¼Œä¸€èˆ¬ä¸è®¾ç½®è¯¥å±æ€§</span>    String separateProcesses <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"debug.separate_processes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>separateProcesses <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> separateProcesses<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>separateProcesses<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mDefParseFlags <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>PARSE_IGNORE_PROCESSES<span class="token punctuation">;</span>            mSeparateProcesses <span class="token operator">=</span> null<span class="token punctuation">;</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Running with debug.separate_processes: * (ALL)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            mDefParseFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            mSeparateProcesses <span class="token operator">=</span> separateProcesses<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Running with debug.separate_processes: "</span> <span class="token operator">+</span> separateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        mDefParseFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        mSeparateProcesses <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// å¯¹åº”ç”¨è¿›è¡Œ dexopt ä¼˜åŒ–çš„è¾…åŠ©ç±»</span>    mPackageDexOptimizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageDexOptimizer</span><span class="token punctuation">(</span>installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">,</span> context<span class="token punctuation">,</span>                                                   <span class="token string">"*dexopt*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    DexManager<span class="token punctuation">.</span>Listener dexManagerListener <span class="token operator">=</span> DexLogger<span class="token punctuation">.</span><span class="token function">getListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> installer<span class="token punctuation">,</span>                                                                   mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>    mDexManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mPackageDexOptimizer<span class="token punctuation">,</span> installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>    mArtManagerService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArtManagerService</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>    mMoveCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MoveCallbacks</span><span class="token punctuation">(</span>FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mOnPermissionChangeListeners <span class="token operator">=</span> <span class="token keyword">new</span>                                    <span class="token class-name">OnPermissionChangeListeners</span><span class="token punctuation">(</span>FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è·å–å½“å‰è®¾å¤‡çš„æ˜¾ç¤ºå±ä¿¡æ¯</span>    <span class="token function">getDefaultDisplayMetrics</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// é€šè¿‡ SystemConfig è¯»å–ç³»ç»Ÿçš„ featureã€permession ç­‰é…ç½®ï¼Œ</span>    <span class="token comment" spellcheck="true">// å¹¶åˆå§‹åŒ– mGlobalGids/mAvailableFeatures æˆå‘˜</span>    SystemConfig systemConfig <span class="token operator">=</span> SystemConfig<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// é‡ç‚¹è®¨è®º</span>    mAvailableFeatures <span class="token operator">=</span> systemConfig<span class="token punctuation">.</span><span class="token function">getAvailableFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    mProtectedPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProtectedPackages</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token punctuation">}</span></code></pre><p>ä»¥ä¸Šä»£ç é™¤äº†åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„éœ€è¦å…³æ³¨çš„ç±»ï¼š<strong><font color="#FF0000">SystemConfig</font></strong>ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æçš„é‡ç‚¹ï¼ï¼ï¼</p><h3 id="3-3-1-SystemConfig"><a href="#3-3-1-SystemConfig" class="headerlink" title="3.3.1 SystemConfig"></a>3.3.1 SystemConfig</h3><p>æˆ‘ä»¬å…ˆæ¥åˆ†æ <strong><font color="#1874CD">SystemConfig systemConfig = SystemConfig.getInstance() </font></strong> å‡½æ•°ï¼</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span><span class="token comment" spellcheck="true">/** * Loads global system configuration info. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemConfig</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> SystemConfig sInstance<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> SystemConfig <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// å•ä¾‹æ¨¡å¼</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>SystemConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æŸ¥çœ‹å®ƒçš„æ„é€ å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span><span class="token comment" spellcheck="true">/** * é€šè¿‡ readPermissions() è¯»å–å¹¶è§£æ /system/etc/ã€€ç­‰ç›®å½•ä¸‹çš„ sysconfig.xmlã€permission.xml æ–‡ä»¶ */</span><span class="token function">SystemConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Read configuration from system</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ALLOW_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Read configuration from the old permissions dir</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ALLOW_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Vendors are only allowed to customze libs, features and privapp permissions</span>    <span class="token keyword">int</span> vendorPermissionFlag <span class="token operator">=</span> ALLOW_LIBS <span class="token operator">|</span> ALLOW_FEATURES <span class="token operator">|</span> ALLOW_PRIVAPP_PERMISSIONS<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>FIRST_SDK_INT <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O_MR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// For backward compatibility</span>        vendorPermissionFlag <span class="token operator">|=</span> <span class="token punctuation">(</span>ALLOW_PERMISSIONS <span class="token operator">|</span> ALLOW_APP_CONFIGS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vendorPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vendorPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Allow ODM to customize system configs as much as Vendor, because /odm is another</span>    <span class="token comment" spellcheck="true">// vendor partition other than /vendor.</span>    <span class="token keyword">int</span> odmPermissionFlag <span class="token operator">=</span> vendorPermissionFlag<span class="token punctuation">;</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getOdmDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> odmPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getOdmDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> odmPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Allow OEM to customize features and OEM permissions</span>    <span class="token keyword">int</span> oemPermissionFlag <span class="token operator">=</span> ALLOW_FEATURES <span class="token operator">|</span> ALLOW_OEM_PERMISSIONS<span class="token punctuation">;</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oemPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oemPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Allow Product to customize system configs around libs, features, permissions and apps</span>    <span class="token keyword">int</span> productPermissionFlag <span class="token operator">=</span> ALLOW_LIBS <span class="token operator">|</span> ALLOW_FEATURES <span class="token operator">|</span> ALLOW_PERMISSIONS <span class="token operator">|</span>            ALLOW_APP_CONFIGS <span class="token operator">|</span> ALLOW_PRIVAPP_PERMISSIONS<span class="token punctuation">;</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getProductDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>            Environment<span class="token punctuation">.</span><span class="token function">getProductDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å‘ç° <code>SystemConfig</code> çš„æ„é€ å‡½æ•°æ‰€åšçš„å·¥ä½œå°±æ˜¯ï¼š<code>readPermissions()</code>ï¼Œå³ä»æ–‡ä»¶ä¸­<code>è¯»å–æƒé™</code>ï¼</p><h3 id="3-3-2-readPermissions"><a href="#3-3-2-readPermissions" class="headerlink" title="3.3.2 readPermissions"></a>3.3.2 readPermissions</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ readPermissions çš„æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span><span class="token keyword">void</span> <span class="token function">readPermissions</span><span class="token punctuation">(</span>File libraryDir<span class="token punctuation">,</span> <span class="token keyword">int</span> permissionFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// Iterate over the files in the directory and scan .xml files</span>    File platformFile <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>File f <span class="token operator">:</span> libraryDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// We'll read platform.xml last</span>        <span class="token comment" spellcheck="true">// å¤„ç†è¯¥ç›®å½•ä¸‹çš„é platform.xml æ–‡ä»¶</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"etc/permissions/platform.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            platformFile <span class="token operator">=</span> f<span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ readPermissionsFromXml è§£ææ­¤ XML æ–‡ä»¶</span>        <span class="token function">readPermissionsFromXml</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> permissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Read platform permissions last so it will take precedence</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>platformFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œplatform.xmlæ–‡ä»¶çš„è§£æä¼˜å…ˆçº§æœ€é«˜ï¼</span>        <span class="token function">readPermissionsFromXml</span><span class="token punctuation">(</span>platformFile<span class="token punctuation">,</span> permissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä»æºç ä¸­ï¼Œæˆ‘ä»¬å‘ç° <code>readPermissions</code> å‡½æ•°ä¸å°±æ˜¯è°ƒç”¨ <code>readPermissionFromXml</code> å‡½æ•°è§£æ <code>&quot;/xxx/etc/permissions/&quot;</code> ç›®å½•ä¸‹çš„æ–‡ä»¶å—ï¼Ÿ</p><p>è¿™äº›æ–‡ä»¶ä¼¼ä¹éƒ½æ˜¯ XML æ–‡ä»¶ã€‚ä½ ä¹Ÿè®¸æœ‰ä¸ªç–‘é—®ï¼Ÿè¯¥ç›®å½•ä¸‹éƒ½æœ‰å“ªäº› XML æ–‡ä»¶ï¼Ÿè¿™äº› XML æ–‡ä»¶ä¸­æœ‰äº›ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿ<strong><font color="#63B8FF">ä»¥æˆ‘æ‰‹ä¸­çš„ pixel ä¸ºä¾‹</font></strong>ï¼š</p><pre><code>sailfish:/system/etc/permissions $ ls -alls -altotal 168drwxr-xr-x  2 root root  4096 2009-01-01 16:00 .drwxr-xr-x 14 root root  4096 2009-01-01 16:00 ..-rw-r--r--  1 root root  1050 2009-01-01 16:00 android.software.live_wallpaper.xml-rw-r--r--  1 root root   748 2009-01-01 16:00 android.software.webview.xml-rw-r--r--  1 root root  1778 2009-01-01 16:00 com.android.ims.rcsmanager.xml-rw-r--r--  1 root root   828 2009-01-01 16:00 com.android.location.provider.xml-rw-r--r--  1 root root   828 2009-01-01 16:00 com.android.media.remotedisplay.xml-rw-r--r--  1 root root   820 2009-01-01 16:00 com.android.mediadrm.signer.xml-rw-r--r--  1 root root   158 2009-01-01 16:00 com.android.omadm.service.xml-rw-r--r--  1 root root   435 2009-01-01 16:00 com.android.sdm.plugins.connmo.xml-rw-r--r--  1 root root   701 2009-01-01 16:00 com.android.sdm.plugins.sprintdm.xml-rw-r--r--  1 root root   234 2009-01-01 16:00 com.android.vzwomatrigger.xml-rw-r--r--  1 root root  1079 2009-01-01 16:00 com.customermobile.preload.vzw.xml-rw-r--r--  1 root root   850 2009-01-01 16:00 com.google.android.camera.experimental2016.xml-rw-r--r--  1 root root   563 2009-01-01 16:00 com.google.android.dialer.support.xml-rw-r--r--  1 root root   816 2009-01-01 16:00 com.google.android.maps.xml-rw-r--r--  1 root root   835 2009-01-01 16:00 com.google.android.media.effects.xml-rw-r--r--  1 root root   811 2009-01-01 16:00 com.google.vr.platform.xml-rw-r--r--  1 root root   160 2009-01-01 16:00 com.verizon.apn.xml-rw-r--r--  1 root root   158 2009-01-01 16:00 com.verizon.embms.xml-rw-r--r--  1 root root   288 2009-01-01 16:00 com.verizon.llkagent.xml-rw-r--r--  1 root root   174 2009-01-01 16:00 com.verizon.provider.xml-rw-r--r--  1 root root   220 2009-01-01 16:00 com.verizon.services.xml-rw-r--r--  1 root root   239 2009-01-01 16:00 features-verizon.xml-rw-r--r--  1 root root   811 2009-01-01 16:00 obdm_permissions.xml-rw-r--r--  1 root root  8916 2009-01-01 16:00 platform.xml-rw-r--r--  1 root root 23092 2009-01-01 16:00 privapp-permissions-google.xml-rw-r--r--  1 root root  1346 2009-01-01 16:00 privapp-permissions-marlin.xml-rw-r--r--  1 root root 20848 2009-01-01 16:00 privapp-permissions-platform.xml-rw-r--r--  1 root root  1587 2009-01-01 16:00 vzw_mvs_permissions.xmlsailfish:/system/etc/permissions $</code></pre><p>æ—¢ç„¶æˆ‘ä»¬ä¸Šé¢ä¸€ç›´åœ¨è¯´ platform.xml è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£å°±çœ‹ä¸‹ <strong><font color="#FF0000">platform.xml</font></strong> æœ‰ä»€ä¹ˆï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permissions</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- å»ºç«‹æƒé™åä¸ gid çš„æ˜ å°„å…³ç³»ã€‚å¦‚ä¸‹é¢å£°æ˜çš„ BLUETOOTH_ADMIN æƒé™ï¼Œ         å®ƒå¯¹åº”çš„ç”¨æˆ·ç»„æ˜¯ net_bt_adminã€‚æ³¨æ„ï¼Œè¯¥æ–‡ä»¶ä¸­çš„ permission æ ‡ç­¾åªå¯¹         é‚£äº›éœ€è¦é€šè¿‡è¯»å†™è®¾å¤‡ï¼ˆè“ç‰™/cametaï¼‰/åˆ›å»º socket ç­‰è¿›ç¨‹åˆ’åˆ†äº† gidã€‚         å› ä¸ºè¿™äº›æƒé™æ¶‰åŠå’Œ Linux å†…æ ¸äº¤äº’ï¼Œæ‰€ä»¥éœ€è¦åœ¨åº•å±‚æƒé™ï¼ˆç”±ä¸ç”¨çš„ç”¨æˆ·ç»„ç•Œå®šï¼‰         å’Œ Android å±‚æƒé™ï¼ˆç”±ä¸åŒçš„å­—ç¬¦ä¸²ç•Œå®šï¼‰ä¹‹é—´å»ºç«‹æ˜ å°„å…³ç³»ã€‚ --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.BLUETOOTH_ADMIN<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_bt_admin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permission</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.BLUETOOTH<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_bt<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permission</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.BLUETOOTH_STACK<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bluetooth<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wakelock<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uhid<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permission</span><span class="token punctuation">></span></span>    ... ...    <span class="token comment" spellcheck="true">&lt;!-- èµ‹äºˆå¯¹åº” uid ç›¸åº”çš„æƒé™ã€‚å¦‚æœä¸‹é¢ä¸€è¡Œè¡¨ç¤º uid ä¸º audioserverï¼Œé‚£ä¹ˆå°±         èµ‹äºˆå®ƒ WAKE_LOCK çš„æƒé™ï¼Œå…¶å®å°±æ˜¯æŠŠå®ƒåŠ åˆ°å¯¹åº”çš„ç”¨æˆ·ç»„ä¸­ --></span>    ... ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.MODIFY_AUDIO_SETTINGS<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.ACCESS_SURFACE_FLINGER<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.WAKE_LOCK<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.UPDATE_DEVICE_STATS<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.UPDATE_APP_OPS_STATS<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    ... ...    <span class="token comment" spellcheck="true">&lt;!-- This is a list of all the libraries available for application         code to link against. --></span>    <span class="token comment" spellcheck="true">&lt;!-- ç³»ç»Ÿæä¾›çš„ Java åº“ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œæ—¶å¿…é¡»è¦é“¾æ¥è¿™äº›åº“ï¼Œè¯¥å·¥ä½œç”±ç³»ç»Ÿè‡ªåŠ¨å®Œæˆ --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.test.mock<span class="token punctuation">"</span></span>            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/android.test.mock.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.test.runner<span class="token punctuation">"</span></span>            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/android.test.runner.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javax.obex<span class="token punctuation">"</span></span>            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/javax.obex.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.http.legacy<span class="token punctuation">"</span></span>            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/org.apache.http.legacy.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    ... ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permissions</span><span class="token punctuation">></span></span></code></pre><p>platform.xml æ–‡ä»¶ä¸­ä¸»è¦ä½¿ç”¨äº†å¦‚ä¸‹ <strong><font color="#FF0000">4 ä¸ªæ ‡ç­¾</font></strong>ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#87CEFA">permission</font></strong> å’Œ <strong><font color="#87CEFA">group</font></strong> ç”¨äºå»ºç«‹ Linux å±‚ gid å’Œ Andrid å±‚ permission ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#87CEFA">assign-permission</font></strong> ç”¨äºå‘æŒ‡å®šçš„ uid èµ‹äºˆç›¸åº”çš„æƒé™ã€‚è¿™ä¸ªæƒé™ç”± Android å®šä¹‰ï¼Œç”¨äºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#87CEFA">library</font></strong> ç”¨äºæŒ‡å®šç³»ç»Ÿåº“ã€‚å½“åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºè¿™äº›è¿›ç¨‹åŠ è½½è¿™äº›åº“ã€‚</p><p>ä¸çŸ¥é“ä½ æ˜¯å¦å·²ç»äº§ç”Ÿäº†ç–‘é—®ï¼Ÿè®¾å¤‡ä¸Šçš„ /system/etc/permission ç›®å½•ä¸­çš„æ–‡ä»¶æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿæˆ‘ç›´æ¥å‘Šè¯‰ä½ ç­”æ¡ˆï¼šåœ¨ç¼–è¯‘é˜¶æ®µç”±ä¸ç”¨ç¡¬ä»¶å¹³å°æ ¹æ®è‡ªå·±çš„é…ç½®ä¿¡æ¯å¤åˆ¶ç›¸å…³æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•ä¸­çš„æ¥çš„ã€‚ï¼ˆè¿™ä¸ªå…·ä½“æˆ‘ä»¬ä¸è®¨è®ºï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ï¼‰ </p><h3 id="3-3-3-readPermissionFromXML"><a href="#3-3-3-readPermissionFromXML" class="headerlink" title="3.3.3 readPermissionFromXML"></a>3.3.3 readPermissionFromXML</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼š<code>readPermissions</code> å‡½æ•°å…¶å®å°±æ˜¯è°ƒç”¨ <code>readPermissionFromXml</code> å‡½æ•°è§£æ <code>&quot;/xxx/etc/permissions/&quot;</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼</p><p>readPermissionFromXml åˆæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿå…¶å®å®ƒçš„ä½œç”¨å°±æ˜¯å°† XML æ–‡ä»¶ä¸­çš„æ ‡ç­¾ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»è½¬æ¢æˆä»£ç ä¸­çš„ç›¸åº”æ•°æ®ç»“æ„ï¼Œç›´æ¥çœ‹æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readPermissionsFromXml</span><span class="token punctuation">(</span>File permFile<span class="token punctuation">,</span> <span class="token keyword">int</span> permissionFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    FileReader permReader <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">final</span> <span class="token keyword">boolean</span> lowRam <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">isLowRamDeviceStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        XmlPullParser parser <span class="token operator">=</span> Xml<span class="token punctuation">.</span><span class="token function">newPullParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        parser<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>permReader<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            String name <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è§£æ group æ ‡ç­¾</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"group"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>                String gidStr <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"gid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>gidStr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">int</span> gid <span class="token operator">=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Process<span class="token punctuation">.</span><span class="token function">getGidForName</span><span class="token punctuation">(</span>gidStr<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è½¬æ¢ XML ä¸­çš„ gid å­—ç¬¦ä¸²ä¸ºæ•´å‹ï¼Œå¹¶ä¿å­˜åˆ° mGlobalGidsä¸­</span>                    mGlobalGids <span class="token operator">=</span> <span class="token function">appendInt</span><span class="token punctuation">(</span>mGlobalGids<span class="token punctuation">,</span> gid<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"&lt;group> without gid in "</span> <span class="token operator">+</span> permFile <span class="token operator">+</span> <span class="token string">" at "</span>                            <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è§£æ permissionæ ‡ç­¾</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"permission"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowPermissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>                String perm <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>perm <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                perm <span class="token operator">=</span> perm<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// è°ƒç”¨ readPermission å¤„ç†</span>                <span class="token function">readPermission</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è§£æ assign-permission æ ‡ç­¾</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"assign-permission"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowPermissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>                String perm <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                String uidStr <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ assign-permissionï¼Œåˆ™å–å‡º uid å­—ç¬¦ä¸²ï¼Œç„¶åè·å¾— Linux å¹³å°ä¸Šçš„æ•´å‹ uid å€¼</span>                <span class="token keyword">int</span> uid <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getUidForName</span><span class="token punctuation">(</span>uidStr<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                perm <span class="token operator">=</span> perm<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å’Œ assign ç›¸å…³çš„ä¿¡æ¯ä¿å­˜åœ¨ mSystemPermissions ä¸­</span>                ArraySet<span class="token operator">&lt;</span>String<span class="token operator">></span> perms <span class="token operator">=</span> mSystemPermissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>perms <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    perms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArraySet</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    mSystemPermissions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> perms<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                perms<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">;</span>                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è§£æ library æ ‡ç­¾</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"library"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowLibs<span class="token punctuation">)</span> <span class="token punctuation">{</span>                String lname <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String lfile <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>lname <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lfile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token comment" spellcheck="true">// å°† XML ä¸­çš„ name å’Œ library å±æ€§å€¼å­˜å‚¨åˆ° mSharedLibraries ä¸­</span>                    mSharedLibraries<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lname<span class="token punctuation">,</span> lfile<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è§£æ featureæ ‡ç­¾</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"feature"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowFeatures<span class="token punctuation">)</span> <span class="token punctuation">{</span>                String fname <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> fversion <span class="token operator">=</span> XmlUtils<span class="token punctuation">.</span><span class="token function">readIntAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">boolean</span> allowed<span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"unavailable-feature"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowFeatures<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">// è§£æå…¶å®ƒæ ‡ç­¾</span>        <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FF0000">readPermission å‡½æ•°æœç„¶æ˜¯å°† XML ä¸­çš„æ ‡ç­¾è½¬æ¢æˆå¯¹åº”çš„æ•°æ®ç»“æ„ï¼ï¼ï¼</font></strong></p><hr><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://www.2cto.com/kf/201609/551752.html" target="_blank" rel="noopener">Android 7.0 PackageManagerService (2) â€“ PKMS æ„é€ å‡½æ•°çš„ä¸»è¦å·¥ä½œ</a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/8e2831428110" target="_blank" rel="noopener">APK å®‰è£…æµç¨‹è¯¦è§£ 7 â€“ PackageManagerService çš„å¯åŠ¨æµç¨‹(ä¸Š)</a></p><hr><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/05/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%882%EF%BC%89%E4%B9%8B%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¡†æ¶æœåŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PackageManagerService </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨å’ŒåŠ è½½</title>
      <link href="/2018/12/26/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-launcher/"/>
      <url>/2018/12/26/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-launcher/</url>
      
        <content type="html"><![CDATA[<p><br></p><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><br><center><strong><font color="#1874CD"><font color="#3A5FCD" size="4">Android å¯åŠ¨é˜¶æ®µç³»åˆ—</font></font></strong></center><br><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€å¯åŠ¨é˜¶æ®µã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">æºç ç‰ˆæœ¬</font></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">init</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/01/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20init/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">zygote</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/10/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20zygote/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">systemserver</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/18/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20systemserver/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Launcher</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/26/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20Launcher/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨åŠåŠ è½½æµç¨‹</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">åšæ–‡ä¿®æ”¹æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† Launcher å¯åŠ¨å’ŒåŠ è½½æµç¨‹ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br><br></p><hr><h1 id="å¼€ç¯‡"><a href="#å¼€ç¯‡" class="headerlink" title="å¼€ç¯‡"></a>å¼€ç¯‡</h1><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">SystemServer.java</font></td><td>frameworks/base/services/java/com/android/server/SystemServer.java</td></tr><tr><td><font color="#D15FEE">ActivityManagerService.java</font></td><td>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</td></tr><tr><td><font color="#D15FEE">ActivityStack.java</font></td><td>frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</td></tr><tr><td><font color="#D15FEE">ActivityStackSupervisor.java</font></td><td>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</td></tr><tr><td><font color="#D15FEE">Launcher.java</font></td><td>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</td></tr><tr><td><font color="#D15FEE">LauncherModel.java</font></td><td>packages/apps/Launcher3/src/com/android/launcher3/LauncherModel.java</td></tr></tbody></table><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>Androidç³»ç»Ÿå¯åŠ¨çš„æœ€åä¸€æ­¥æ˜¯å¯åŠ¨ä¸€ä¸ªHomeåº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºç”¨æ¥æ˜¾ç¤ºç³»ç»Ÿä¸­å·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªHomeåº”ç”¨ç¨‹åºå°±å«åšLauncherã€‚åº”ç”¨ç¨‹åºLauncheråœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè¯·æ±‚PackageManagerServiceè¿”å›ç³»ç»Ÿä¸­å·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¿«æ·å›¾æ ‡åˆ—è¡¨æ˜¾ç¤ºåœ¨ç³»ç»Ÿå±å¹•ä¸Šï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»è¿™äº›å¿«æ·å›¾æ ‡æ¥å¯åŠ¨ç›¸åº”çš„åº”ç”¨ç¨‹åºã€‚</p><h1 id="Launcher-å¯åŠ¨æµç¨‹"><a href="#Launcher-å¯åŠ¨æµç¨‹" class="headerlink" title="Launcher å¯åŠ¨æµç¨‹"></a>Launcher å¯åŠ¨æµç¨‹</h1><h2 id="startOtherServices"><a href="#startOtherServices" class="headerlink" title="startOtherServices"></a>startOtherServices</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> ActivityManagerService mActivityManagerService<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    mActivityManagerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Making services ready"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="systemReady"><a href="#systemReady" class="headerlink" title="systemReady"></a>systemReady</h2><p>åœ¨ startOtherServices å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨ ActivityManagerService çš„ systemReady å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> ActivityStackSupervisor mStackSupervisor<span class="token punctuation">;</span><span class="token keyword">final</span> UserController mUserController<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token keyword">final</span> Runnable goingCallback<span class="token punctuation">,</span> TimingsTraceLog traceLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            mStackSupervisor<span class="token punctuation">.</span><span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mUserController<span class="token punctuation">.</span><span class="token function">sendUserSwitchBroadcastsLocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> currentUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>    </code></pre><h2 id="resumeFocusedStackTopActivityLocked"><a href="#resumeFocusedStackTopActivityLocked" class="headerlink" title="resumeFocusedStackTopActivityLocked"></a>resumeFocusedStackTopActivityLocked</h2><p>æˆ‘ä»¬çœ‹ä¸‹ resumeFocusedStackTopActivityLocked()ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>okï¼Œå‡½æ•°è·³è½¬ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span>            ActivityStack targetStack<span class="token punctuation">,</span> ActivityRecord target<span class="token punctuation">,</span> ActivityOptions targetOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readyToResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetStack <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">isFocusedStack</span><span class="token punctuation">(</span>targetStack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> targetStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> ActivityRecord r <span class="token operator">=</span> mFocusedStack<span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null <span class="token operator">||</span> r<span class="token punctuation">.</span>state <span class="token operator">!=</span> RESUMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mFocusedStack<span class="token punctuation">.</span><span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">==</span> RESUMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Kick off any lingering app transitions form the MoveTaskToFront operation.</span>            mFocusedStack<span class="token punctuation">.</span><span class="token function">executeAppTransition</span><span class="token punctuation">(</span>targetOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="resumeTopActivityUncheckedLocked"><a href="#resumeTopActivityUncheckedLocked" class="headerlink" title="resumeTopActivityUncheckedLocked"></a>resumeTopActivityUncheckedLocked</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityUncheckedLocked</span><span class="token punctuation">(</span>ActivityRecord prev<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStackSupervisor<span class="token punctuation">.</span>inResumeTopActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Don't even start recursing.</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Protect against recursion.</span>            mStackSupervisor<span class="token punctuation">.</span>inResumeTopActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            result <span class="token operator">=</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            mStackSupervisor<span class="token punctuation">.</span>inResumeTopActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> ActivityRecord next <span class="token operator">=</span> <span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* focusableOnly */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>next<span class="token punctuation">.</span><span class="token function">canTurnScreenOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">checkReadyForSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="resumeTopActivityInnerLocked"><a href="#resumeTopActivityInnerLocked" class="headerlink" title="resumeTopActivityInnerLocked"></a>resumeTopActivityInnerLocked</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span>ActivityRecord prev<span class="token punctuation">,</span> ActivityOptions options<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> <span class="token function">isOnHomeDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            mStackSupervisor<span class="token punctuation">.</span><span class="token function">resumeHomeStackTask</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> <span class="token string">"prevFinished"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="resumeHomeStackTask"><a href="#resumeHomeStackTask" class="headerlink" title="resumeHomeStackTask"></a>resumeHomeStackTask</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">resumeHomeStackTask</span><span class="token punctuation">(</span>ActivityRecord prev<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// Only resume home activity if isn't finishing.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">moveFocusableActivityStackToFrontLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> myReason<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">resumeFocusedStackTopActivityLocked</span><span class="token punctuation">(</span>mHomeStack<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> mService<span class="token punctuation">.</span><span class="token function">startHomeActivityLocked</span><span class="token punctuation">(</span>mCurrentUser<span class="token punctuation">,</span> myReason<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="startHomeActivityLocked"><a href="#startHomeActivityLocked" class="headerlink" title="startHomeActivityLocked"></a>startHomeActivityLocked</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// String mTopAction = Intent.ACTION_MAIN;</span><span class="token keyword">boolean</span> <span class="token function">startHomeActivityLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFactoryTest <span class="token operator">==</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_LOW_LEVEL            <span class="token operator">&amp;&amp;</span> mTopAction <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Intent intent <span class="token operator">=</span> <span class="token function">getHomeIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ActivityInfo aInfo <span class="token operator">=</span> <span class="token function">resolveActivityInfo</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> STOCK_PM_FLAGS<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        aInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        aInfo<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> <span class="token function">getAppInfoForUser</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>        ProcessRecord app <span class="token operator">=</span> <span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>                aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">==</span> null <span class="token operator">||</span> app<span class="token punctuation">.</span>instr <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            intent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> resolvedUserId <span class="token operator">=</span> UserHandle<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> String myReason <span class="token operator">=</span> reason <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> resolvedUserId<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¯åŠ¨ Launcher</span>            mActivityStarter<span class="token punctuation">.</span><span class="token function">startHomeActivityLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> myReason<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        Slog<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No home screen found for "</span> <span class="token operator">+</span> intent<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Throwable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="getHomeIntent"><a href="#getHomeIntent" class="headerlink" title="getHomeIntent"></a>getHomeIntent</h2><pre class=" language-java"><code class="language-java">    Intent <span class="token function">getHomeIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>mTopAction<span class="token punctuation">,</span> mTopData <span class="token operator">!=</span> null <span class="token operator">?</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>mTopData<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>mTopComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_DEBUG_TRIAGED_MISSING<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFactoryTest <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_LOW_LEVEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœç³»ç»Ÿè¿è¡Œæ¨¡å¼ä¸æ˜¯ä½çº§å·¥å‚æ¨¡å¼åˆ™å°† intentçš„Category è®¾ç½®ä¸º Intent.CATEGORY_HOME</span>            intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>CATEGORY_HOME<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> intent<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h1 id="Launcher-åº”ç”¨å›¾æ ‡æ˜¾ç¤ºæµç¨‹"><a href="#Launcher-åº”ç”¨å›¾æ ‡æ˜¾ç¤ºæµç¨‹" class="headerlink" title="Launcher åº”ç”¨å›¾æ ‡æ˜¾ç¤ºæµç¨‹"></a>Launcher åº”ç”¨å›¾æ ‡æ˜¾ç¤ºæµç¨‹</h1><pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        LauncherAppState app <span class="token operator">=</span> LauncherAppState<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        mModel <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">setLauncher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mModel<span class="token punctuation">.</span><span class="token function">startLoader</span><span class="token punctuation">(</span>currentScreen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mDragLayer<span class="token punctuation">.</span><span class="token function">setAlpha</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            mWorkspace<span class="token punctuation">.</span><span class="token function">setCurrentPage</span><span class="token punctuation">(</span>currentScreen<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">setWorkspaceLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="setLauncher"><a href="#setLauncher" class="headerlink" title="setLauncher"></a>setLauncher</h2><pre class=" language-java"><code class="language-java">    LauncherModel <span class="token function">setLauncher</span><span class="token punctuation">(</span>Launcher launcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">getLocalProvider</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLauncherProviderChangeListener</span><span class="token punctuation">(</span>launcher<span class="token punctuation">)</span><span class="token punctuation">;</span>        mModel<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>launcher<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> mModel<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a>initialize</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Set this as the current Launcher activity object for the loader.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span>Callbacks callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Preconditions<span class="token punctuation">.</span><span class="token function">assertUIThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>åœ¨ initialize å‡½æ•°ä¸­ä¼šå°† Callbacksï¼Œä¹Ÿå°±æ˜¯ä¼ å…¥çš„ Launcher å°è£…æˆä¸€ä¸ªå¼±å¼•ç”¨å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬å¾—çŸ¥ mCallbacks å˜é‡æŒ‡çš„å°±æ˜¯å°è£…æˆå¼±å¼•ç”¨å¯¹è±¡çš„ Launcherã€‚</p><p>é‡æ–°å›åˆ° oncreate() å‡½æ•°ï¼Œæœ‰ä¸ª startLoader æ–¹æ³•ï¼</p><h2 id="startLoader"><a href="#startLoader" class="headerlink" title="startLoader"></a>startLoader</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// åˆ›å»ºäº†å…·æœ‰æ¶ˆæ¯å¾ªç¯çš„çº¿ç¨‹ HandlerThread å¯¹è±¡</span>    <span class="token annotation punctuation">@Thunk</span> <span class="token keyword">static</span> <span class="token keyword">final</span> HandlerThread sWorkerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerThread</span><span class="token punctuation">(</span><span class="token string">"launcher-loader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        sWorkerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åˆ›å»ºäº† Handlerï¼Œå¹¶ä¸”ä¼ å…¥ HandlerThread çš„ Looper</span>    <span class="token annotation punctuation">@Thunk</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Handler sWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>sWorkerThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startLoader</span><span class="token punctuation">(</span><span class="token keyword">int</span> synchronousBindPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>        InstallShortcutReceiver<span class="token punctuation">.</span><span class="token function">enableInstallQueue</span><span class="token punctuation">(</span>InstallShortcutReceiver<span class="token punctuation">.</span>FLAG_LOADER_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallbacks <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mCallbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> Callbacks oldCallbacks <span class="token operator">=</span> mCallbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                mUiExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                oldCallbacks<span class="token punctuation">.</span><span class="token function">clearPendingBinds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">stopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                LoaderResults loaderResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoaderResults</span><span class="token punctuation">(</span>mApp<span class="token punctuation">,</span> sBgDataModel<span class="token punctuation">,</span>                        mBgAllAppsList<span class="token punctuation">,</span> synchronousBindPage<span class="token punctuation">,</span> mCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mModelLoaded <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIsLoaderTaskRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    loaderResults<span class="token punctuation">.</span><span class="token function">bindWorkspace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    loaderResults<span class="token punctuation">.</span><span class="token function">bindAllApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    loaderResults<span class="token punctuation">.</span><span class="token function">bindDeepShortcuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    loaderResults<span class="token punctuation">.</span><span class="token function">bindWidgets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token function">startLoaderForResults</span><span class="token punctuation">(</span>loaderResults<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="startLoaderForResults"><a href="#startLoaderForResults" class="headerlink" title="startLoaderForResults"></a>startLoaderForResults</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startLoaderForResults</span><span class="token punctuation">(</span>LoaderResults results<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">stopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mLoaderTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoaderTask</span><span class="token punctuation">(</span>mApp<span class="token punctuation">,</span> mBgAllAppsList<span class="token punctuation">,</span> sBgDataModel<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">runOnWorkerThread</span><span class="token punctuation">(</span>mLoaderTask<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="runOnWorkerThread"><a href="#runOnWorkerThread" class="headerlink" title="runOnWorkerThread"></a>runOnWorkerThread</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runOnWorkerThread</span><span class="token punctuation">(</span>Runnable r<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sWorkerThread<span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Process<span class="token punctuation">.</span><span class="token function">myTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// If we are not on the worker thread, then post to the worker handler</span>            sWorker<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>å½“ LoaderTask æ‰€æè¿°çš„æ¶ˆæ¯è¢«å¤„ç†æ—¶åˆ™ä¼šè°ƒç”¨å®ƒçš„ run å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoaderTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Skip fast if we are already stopped.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span>LauncherModel<span class="token punctuation">.</span>LoaderTransaction transaction <span class="token operator">=</span> mApp<span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">beginLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 1.1: loading workspace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">loadWorkspace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// åŠ è½½å·¥ä½œåŒºä¿¡æ¯</span>            <span class="token function">verifyNotStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 1.2: bind workspace workspace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mResults<span class="token punctuation">.</span><span class="token function">bindWorkspace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// second step</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 2.1: loading all apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">loadAllApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// åŠ è½½ç³»ç»Ÿå·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºä¿¡æ¯</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 2.2: Binding all apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">verifyNotStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mResults<span class="token punctuation">.</span><span class="token function">bindAllApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// third step</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 3.1: loading deep shortcuts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">loadDeepShortcuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">verifyNotStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 3.2: bind deep shortcuts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mResults<span class="token punctuation">.</span><span class="token function">bindDeepShortcuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// fourth step</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 4.1: loading widgets"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mBgDataModel<span class="token punctuation">.</span>widgetsModel<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>mApp<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">verifyNotStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"step 4.2: Binding widgets"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mResults<span class="token punctuation">.</span><span class="token function">bindWidgets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            transaction<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancellationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Loader stopped, ignore</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_LOADERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Loader cancelled"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>çœ‹ä¸‹ loadAllApps() ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadAllApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">long</span> loadTime <span class="token operator">=</span> DEBUG_LOADERS <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>UserHandle<span class="token operator">></span> profiles <span class="token operator">=</span> mUserManager<span class="token punctuation">.</span><span class="token function">getUserProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mBgAllAppsList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>UserHandle user <span class="token operator">:</span> profiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> <span class="token keyword">long</span> qiaTime <span class="token operator">=</span> DEBUG_LOADERS <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>LauncherActivityInfo<span class="token operator">></span> apps <span class="token operator">=</span> mLauncherApps<span class="token punctuation">.</span><span class="token function">getActivityList</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>apps <span class="token operator">==</span> null <span class="token operator">||</span> apps<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">boolean</span> quietMode <span class="token operator">=</span> mUserManager<span class="token punctuation">.</span><span class="token function">isQuietModeEnabled</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> apps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                LauncherActivityInfo app <span class="token operator">=</span> apps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                mBgAllAppsList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AppInfo</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> user<span class="token punctuation">,</span> quietMode<span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            ManagedProfileHeuristic<span class="token punctuation">.</span><span class="token function">onAllAppsLoaded</span><span class="token punctuation">(</span>mApp<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> apps<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>FeatureFlags<span class="token punctuation">.</span>LAUNCHER3_PROMISE_APPS_IN_ALL_APPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>SessionInfo info <span class="token operator">:</span>                    mPackageInstaller<span class="token punctuation">.</span><span class="token function">getAllVerifiedSessions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                mBgAllAppsList<span class="token punctuation">.</span><span class="token function">addPromiseApp</span><span class="token punctuation">(</span>mApp<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        PackageInstallerCompat<span class="token punctuation">.</span>PackageInstallInfo<span class="token punctuation">.</span><span class="token function">fromInstallingState</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        mBgAllAppsList<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h1 id="å‚è€ƒBlog"><a href="#å‚è€ƒBlog" class="headerlink" title="å‚è€ƒBlog"></a>å‚è€ƒBlog</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01. <a href="http://liuwangshu.cn/framework/booting/4-launcher.html" target="_blank" rel="noopener">http://liuwangshu.cn/framework/booting/4-launcher.html</a></p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿå¯åŠ¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Launcher </tag>
            
            <tag> å¯åŠ¨é˜¶æ®µ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</title>
      <link href="/2018/12/18/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-systemserver/"/>
      <url>/2018/12/18/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-systemserver/</url>
      
        <content type="html"><![CDATA[<p><br></p><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><br><center><strong><font color="#1874CD"><font color="#3A5FCD" size="4">Android å¯åŠ¨é˜¶æ®µç³»åˆ—</font></font></strong></center><br><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€å¯åŠ¨é˜¶æ®µã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">æºç ç‰ˆæœ¬</font></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">init</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/01/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20init/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">zygote</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/10/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20zygote/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">systemserver</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/18/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20systemserver/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Launcher</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/26/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20Launcher/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨åŠåŠ è½½æµç¨‹</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">åšæ–‡ä¿®æ”¹æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† systemserver æºç ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br><br></p><hr><h1 id="å¼€ç¯‡"><a href="#å¼€ç¯‡" class="headerlink" title="å¼€ç¯‡"></a>å¼€ç¯‡</h1><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">com_android_internal_os_Zygote.cpp</font></td><td>frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</td></tr><tr><td><font color="#D15FEE">AndroidRuntime.cpp</font></td><td>frameworks/base/core/jni/AndroidRuntime.cpp</td></tr><tr><td><font color="#D15FEE">ZygoteInit.java</font></td><td>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</td></tr><tr><td><font color="#D15FEE">Zygote.java</font></td><td>frameworks/base/core/java/com/android/internal/os/Zygote.java</td></tr><tr><td><font color="#D15FEE">ActivityThread.java</font></td><td>frameworks/base/core/java/android/app/ActivityThread.java</td></tr><tr><td><font color="#D15FEE">ContextImpl.java.java</font></td><td>frameworks/base/core/java/android/app/ContextImpl.java</td></tr><tr><td><font color="#D15FEE">LoadedApk.java.java</font></td><td>frameworks/base/core/java/android/app/LoadedApk.java</td></tr><tr><td><font color="#D15FEE">SystemServer.java</font></td><td>frameworks/base/services/java/com/android/server/SystemServer.java</td></tr><tr><td><font color="#D15FEE">RuntimeInit.java</font></td><td>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</td></tr></tbody></table><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemServeræ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯Android Javaçš„ä¸¤å¤§æ”¯æŸ±ä¹‹ä¸€ã€‚å¦å¤–ä¸€ä¸ªæ”¯æŸ±æ˜¯ä¸“é—¨è´Ÿè´£å­µåŒ–Javaè¿›ç¨‹çš„Zygoteï¼ˆZygoteè¿›ç¨‹æ˜¯æ•´ä¸ªandroidç³»ç»Ÿçš„æ ¹è¿›ç¨‹ï¼‰ã€‚è¿™ä¸¤ä¸ªæ”¯æŸ±å€’äº†ä»»ä½•ä¸€ä¸ªï¼Œéƒ½ä¼šå¯¼è‡´Android Javaçš„å´©æºƒï¼ˆæ‰€æœ‰ç”±Zygoteå­µåŒ–çš„Javaè¿›ç¨‹éƒ½ä¼šè¢«é”€æ¯ï¼Œè€ŒSystemServerå°±æ˜¯ç”±Zygoteå­µåŒ–è€Œæ¥ï¼‰ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‹¥Android JavaçœŸçš„å´©æºƒäº†ï¼Œé‚£ä¹ˆLinuxç³»ç»Ÿä¸­çš„è¿›ç¨‹initä¼šé‡æ–°å¯åŠ¨â€œä¸¤å¤§æ”¯æŸ±â€ä»¥é‡å»ºAndroid Javaã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemServerå’Œç³»ç»ŸæœåŠ¡æœ‰ç€é‡è¦çš„å…³ç³»ï¼ŒAndroidç³»ç»Ÿä¸­å‡ ä¹æ‰€æœ‰çš„æ ¸å¿ƒæœåŠ¡éƒ½æ˜¯åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­ï¼Œå¦‚ï¼šActivityManagerServiceã€PowerManagerServiceå’ŒWindowManagerServiceç­‰ã€‚å½“æˆ‘ä»¬çš„åº”ç”¨éœ€è¦ä½¿ç”¨å„ç§ç³»ç»ŸæœåŠ¡çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿæ˜¯é€šè¿‡ä¸SystemServerè¿›ç¨‹é€šè®¯è·å–å„ç§æœåŠ¡å¯¹è±¡çš„å¥æŸ„ï¼Œè¿›è€Œæ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p><h1 id="Read-The-Fucking-Code"><a href="#Read-The-Fucking-Code" class="headerlink" title="Read The Fucking Code"></a>Read The Fucking Code</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemServeræ˜¯ç”±Zygoteå­µåŒ–è€Œæ¥çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œé€šè¿‡pså‘½ä»¤ï¼Œæˆ‘ä»¬å‘ç°å…¶è¿›ç¨‹åä¸ºï¼šsystem_serverã€‚</p><h2 id="å¯åŠ¨SystemServerè¿›ç¨‹"><a href="#å¯åŠ¨SystemServerè¿›ç¨‹" class="headerlink" title="å¯åŠ¨SystemServerè¿›ç¨‹"></a>å¯åŠ¨SystemServerè¿›ç¨‹</h2><p>åœ¨åˆ†æzygoteè¿›ç¨‹æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“å½“zygoteè¿›ç¨‹è¿›å…¥åˆ°javaä¸–ç•Œåï¼Œåœ¨ZygoteInit.javaä¸­ï¼Œå°†è°ƒç”¨startSystemServerå‡½æ•°å¯åŠ¨SystemServerè¿›ç¨‹ï¼Œå…¶å…³é”®ä»£ç æ˜¯ï¼š</p><pre class=" language-C++"><code class="language-C++">            if (startSystemServer) {                Runnable r = forkSystemServer(abiList, socketName, zygoteServer);                 // forkå‡ºsystem server                // {@code r == null} in the parent (zygote) process, and {@code r != null} in the                // child (system_server) process.                if (r != null) {                    r.run();                    return;                }            }</code></pre><p>æˆ‘ä»¬çœ‹ä¸‹forkSystemServer()ï¼š</p><pre class=" language-C++"><code class="language-C++">// æˆ‘ä»¬è¿™è¾¹æŒ‘å‡ºé‡è¦ä»£ç è®²è§£ï¼Œè¯¦ç»†ä»£ç åˆ†æè¯·å‚è€ƒZygoteç¯‡/* Request to fork the system server process */pid = Zygote.forkSystemServer(        parsedArgs.uid, parsedArgs.gid,        parsedArgs.gids,        parsedArgs.debugFlags,        null,        parsedArgs.permittedCapabilities,        parsedArgs.effectiveCapabilities);</code></pre><p>è€æ ·å­ï¼Œæºç ç»§ç»­è·Ÿä¸‹å»ï¼š</p><pre class=" language-C++"><code class="language-C++">    public static int forkSystemServer(int uid, int gid, int[] gids, int debugFlags,            int[][] rlimits, long permittedCapabilities, long effectiveCapabilities) {        VM_HOOKS.preFork();        // Resets nice priority for zygote process.        resetNicePriority();        int pid = nativeForkSystemServer(                uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);        // Enable tracing as soon as we enter the system_server.        if (pid == 0) {            Trace.setTracingEnabled(true, debugFlags);        }        VM_HOOKS.postForkCommon();        return pid;    }</code></pre><p>å®¹æ˜“çœ‹å‡ºï¼Œè¯¥å‡½æ•°é€šè¿‡è°ƒç”¨nativeæ–¹æ³•ï¼Œå®Œæˆå®é™…çš„åˆ›å»ºæ“ä½œã€‚è¯¥Nativeæ–¹æ³•å®šä¹‰äºframeworks/base/core/jni/com_android_internal_os_Zygote.cppä¸­ã€‚ æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹åº”çš„nativeå‡½æ•°ã€‚</p><pre class=" language-C++"><code class="language-C++">static jint com_android_internal_os_Zygote_nativeForkSystemServer(        JNIEnv* env, jclass, uid_t uid, gid_t gid, jintArray gids,        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,        jlong effectiveCapabilities) {  // è¿›è¡Œå®é™…çš„â€œåˆ†è£‚â€å·¥ä½œ  pid_t pid = ForkAndSpecializeCommon(env, uid, gid, gids,                                      debug_flags, rlimits,                                      permittedCapabilities, effectiveCapabilities,                                      MOUNT_EXTERNAL_DEFAULT, NULL, NULL, true, NULL,                                      NULL, NULL, NULL);  if (pid > 0) {      // The zygote process checks whether the child process has died or not.      ALOGI("System server process %d has been created", pid);      // è¿™é‡ŒSystemServerè¿›ç¨‹å·²ç»åˆ›å»ºå‡ºæ¥ï¼Œpid > 0 è¯´æ˜åœ¨çˆ¶è¿›ç¨‹ä¸­      // å°†å­è¿›ç¨‹SystemServerçš„pidå­˜åœ¨zygoteè¿›ç¨‹çš„å…¨å±€å˜é‡ä¸­      gSystemServerPid = pid;      // There is a slight window that the system server process has crashed      // but it went unnoticed because we haven't published its pid yet. So      // we recheck here just to make sure that all is well.      int status;      if (waitpid(pid, &status, WNOHANG) == pid) {          // å°æ¦‚ç‡ï¼ŒSystemServerè¿›ç¨‹åˆšåˆ›å»ºï¼Œå°±crashï¼›æ­¤æ—¶éœ€è¦é‡å¯zygote          ALOGE("System server process %d has died. Restarting Zygote!", pid);          RuntimeAbort(env, __LINE__, "System server process has died. Restarting Zygote!");      }      // Assign system_server to the correct memory cgroup.      if (!WriteStringToFile(StringPrintf("%d", pid), "/dev/memcg/system/tasks")) {        ALOGE("couldn't write %d to /dev/memcg/system/tasks", pid);      }  }  return pid;}</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå®é™…çš„â€œåˆ†è£‚â€å·¥ä½œï¼Œç”±å‡½æ•°ForAndSpecializeCommonå®Œæˆã€‚</p><pre class=" language-C++"><code class="language-C++">// Utility routine to fork zygote and specialize the child process.static pid_t ForkAndSpecializeCommon(JNIEnv* env, uid_t uid, gid_t gid, jintArray javaGids,                                     jint debug_flags, jobjectArray javaRlimits,                                     jlong permittedCapabilities, jlong effectiveCapabilities,                                     jint mount_external,                                     jstring java_se_info, jstring java_se_name,                                     bool is_system_server, jintArray fdsToClose,                                     jintArray fdsToIgnore,                                     jstring instructionSet, jstring dataDir) {  SetSigChldHandler();               // æ³¨å†Œä¿¡å·ç›‘å¬å™¨  ... ...  pid_t pid = fork();  if (pid == 0) {    ... ...                          // æ ¹æ®ä¼ å…¥å‚æ•°è¿›è¡Œå¯¹åº”çš„å¤„ç†ï¼Œä¾‹å¦‚è®¾ç½®è¿›ç¨‹åï¼Œè®¾ç½®å„ç§idï¼ˆç”¨æˆ·idï¼Œç»„idï¼‰ç­‰    UnsetSigChldHandler();           // åæ³¨å†Œæ‰ä¿¡å·ç›‘å¬å™¨    ... ...  } else if (pid > 0) {     ... ...  }  return pid;}</code></pre><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒForkAndSpecializeCommonæœ€ç»ˆæ˜¯é€šè¿‡forkçš„æ–¹å¼ï¼Œåˆ†è£‚å‡ºå­è¿›ç¨‹ã€‚<br>è¿™é‡Œéœ€è¦å…³æ³¨ä¸€ä¸‹çš„æ˜¯ï¼Œåœ¨zygoteè¿›ç¨‹forkä¹‹å‰ï¼Œè°ƒç”¨SetSigChldHandlerå‡½æ•°æ³¨å†Œäº†ä¸€ä¸ªå­è¿›ç¨‹ä¿¡å·ç›‘å¬å™¨ã€‚ç”±äºå­è¿›ç¨‹å…±äº«çˆ¶è¿›ç¨‹ä¸­çš„å †åŠæ ˆä¿¡æ¯ï¼Œå› æ­¤åœ¨å­è¿›ç¨‹ä¸­ä¹Ÿä¼šæœ‰ç›¸åº”çš„ä¿¡å·å¤„ç†å™¨ã€‚<br>ä¸ºäº†é¿å…è¯¥ä¿¡å·ç›‘å¬å™¨å¯¹å­è¿›ç¨‹çš„å½±å“ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å­è¿›ç¨‹ä¸­è¿›è¡Œäº†UnsetSigChldHandlerçš„æ“ä½œã€‚</p><p>åˆ†åˆ«çœ‹ä¸€ä¸‹SetSigChldHandlerå’ŒUnsetSigChldHandleræ‰€ä½œå·¥ä½œï¼</p><h3 id="SetSigChldHandler"><a href="#SetSigChldHandler" class="headerlink" title="SetSigChldHandler"></a>SetSigChldHandler</h3><p>æˆ‘ä»¬çœ‹çœ‹SetSigChldHandlerè¿›è¡Œäº†å“ªäº›æ“ä½œã€‚</p><pre class=" language-C++"><code class="language-C++">// Configures the SIGCHLD handler for the zygote process. This is configured// very late, because earlier in the runtime we may fork() and exec()// other processes, and we want to waitpid() for those rather than// have them be harvested immediately.//// This ends up being called repeatedly before each fork(), but there's// no real harm in that.static void SetSigChldHandler() {  struct sigaction sa;  memset(&sa, 0, sizeof(sa));  sa.sa_handler = SigChldHandler;  // è¯¥ä¿¡å·ç›‘å¬å™¨å…³æ³¨å­è¿›ç¨‹ç»“æŸï¼Œå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸ºSigChldHandler  int err = sigaction(SIGCHLD, &sa, NULL);  if (err < 0) {    ALOGW("Error setting SIGCHLD handler: %s", strerror(errno));  }}</code></pre><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒSetSigChldHandlerå‡½æ•°å°†æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å™¨ï¼Œæ¥ç›‘å¬å­è¿›ç¨‹çš„æ­»äº¡ã€‚å½“å­è¿›ç¨‹æ­»äº¡åï¼Œåˆ©ç”¨SigChldHandlerè¿›è¡Œæ“ä½œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œzygoteçš„ä¿¡å·ç›‘å¬å™¨ï¼Œå…³æ³¨çš„æ˜¯zygoteæ‰€æœ‰çš„å­è¿›ç¨‹ï¼Œè€Œä¸åªæ˜¯SystemServerè¿›ç¨‹ï¼ˆæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹æ—¶ï¼Œzygoteéƒ½ä¼šæ³¨å†Œå¯¹åº”çš„ç›‘å¬å™¨ï¼‰ã€‚</p><p>é‚£å°±ç»§ç»­åˆ†æä¸€ä¸‹SigChldHandlerå§ï¼š</p><pre class=" language-C++"><code class="language-C++">static void SigChldHandler(int /*signal_number*/) {  pid_t pid;  int status;  ... ...  while ((pid = waitpid(-1, &status, WNOHANG)) > 0) {    // é€šè¿‡statusåˆ¤æ–­å­è¿›ç¨‹ç»“æŸçš„åŸå› ï¼Œå¹¶æ‰“å°ç›¸åº”çš„log    ... ...    // If the just-crashed process is the system_server, bring down zygote    // so that it is restarted by init and system server will be restarted    // from there.    if (pid == gSystemServerPid) {     // ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡ï¼ŒgSystemServerPidä¸­è®°å½•äº†SystemServerçš„pid      ... ...      kill(getpid(), SIGKILL);         // å¦‚æœç»“æŸçš„å­è¿›ç¨‹ä¸ºSystemServerï¼ŒZygoteä¹Ÿå°†ç»“æŸè‡ªå·±    }  }  ... ...}</code></pre><p>å‘ç°æ²¡ï¼Ÿæ‰€æœ‰zygoteçš„å­è¿›ç¨‹ä¸­ï¼Œzygoteåªå…³å¿ƒäº†SystemServerçš„æ­»æ´»ã€‚å½“å…¶å®ƒå­è¿›ç¨‹crashæ—¶ï¼Œzygoteåªæ‰“å°äº†logä¿¡æ¯ã€‚</p><h3 id="UnsetSigChldHandler"><a href="#UnsetSigChldHandler" class="headerlink" title="UnsetSigChldHandler"></a>UnsetSigChldHandler</h3><p>æœ€åçœ‹çœ‹UnsetSigChldHandlerå‡½æ•°ï¼š</p><pre class=" language-C++"><code class="language-C++">// Sets the SIGCHLD handler back to default behavior in zygote children.static void UnsetSigChldHandler() {  struct sigaction sa;  memset(&sa, 0, sizeof(sa));  sa.sa_handler = SIG_DFL;  int err = sigaction(SIGCHLD, &sa, NULL);  if (err < 0) {    ALOGW("Error unsetting SIGCHLD handler: %s", strerror(errno));  }}</code></pre><h2 id="SystemServerå·¥ä½œæµç¨‹"><a href="#SystemServerå·¥ä½œæµç¨‹" class="headerlink" title="SystemServerå·¥ä½œæµç¨‹"></a>SystemServerå·¥ä½œæµç¨‹</h2><p>åœ¨åˆ†æzygoteè¿›ç¨‹æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“å½“ZygoteInit.javaçš„startSystemServerå‡½æ•°ï¼Œé€šè¿‡forkåˆ›å»ºå‡ºSystemServerè¿›ç¨‹åï¼ŒSystemServerè¿›ç¨‹è°ƒç”¨handleSystemServerProcesså‡½æ•°ï¼Œå¼€å§‹æ‰§è¡Œè‡ªå·±çš„å·¥ä½œã€‚</p><h3 id="handleSystemServerProcess"><a href="#handleSystemServerProcess" class="headerlink" title="handleSystemServerProcess"></a>handleSystemServerProcess</h3><pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/* For child process */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// å…³é—­ä»zygoteè¿›ç¨‹é‚£é‡Œç»§æ‰¿ä¸‹æ¥server socket</span>            <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹handleSystemServerProcesså‡½æ•°çš„ä¸»è¦å†…å®¹ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Finish remaining work for the newly forked system server process.     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Runnable <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>ZygoteConnection<span class="token punctuation">.</span>Arguments parsedArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// set umask to 0077 so new files and directories will default to owner-only permissions.</span>        Os<span class="token punctuation">.</span><span class="token function">umask</span><span class="token punctuation">(</span>S_IRWXG <span class="token operator">|</span> S_IRWXO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>niceName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Process<span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>niceName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åŠ è½½SystemServerå¯¹åº”çš„æ–‡ä»¶</span>        <span class="token keyword">final</span> String systemServerClasspath <span class="token operator">=</span> Os<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SYSTEMSERVERCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>systemServerClasspath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">performSystemServerDexOpt</span><span class="token punctuation">(</span>systemServerClasspath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>invokeWith <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// åˆ©ç”¨systemServerClasså¯¹åº”çš„è·¯å¾„æ„å»ºå¯¹åº”çš„ClassLoader</span>            ClassLoader cl <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>systemServerClasspath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                cl <span class="token operator">=</span> <span class="token function">createPathClassLoader</span><span class="token punctuation">(</span>systemServerClasspath<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">/*             * Pass the remaining arguments to SystemServer.             */</span>            <span class="token comment" spellcheck="true">// å°†å‰©ä½™å‚æ•°åŠclassLoaderé€’äº¤ç»™ZygoteInitçš„zygoteInitå‡½æ•°</span>            <span class="token keyword">return</span> ZygoteInit<span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>remainingArgs<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/* should never reach here */</span>    <span class="token punctuation">}</span></code></pre><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ¥ä¸‹æ¥çš„æµç¨‹è¿›å…¥åˆ°ZygoteInitçš„zygoteInitå‡½æ•°ã€‚zygoteInitå‡½æ•°å°†æ ¹æ®classLoaderå’Œå‚æ•°ï¼Œå®Œæˆä¸åŒè¿›ç¨‹æ‰€éœ€è¦çš„åˆå§‹åŒ–å·¥ä½œï¼ˆSystemServerè¿›ç¨‹ä¸zygoteçš„å…¶å®ƒå­è¿›ç¨‹å‡å°†ä½¿ç”¨zygoteInitå‡½æ•°ï¼‰ã€‚</p><h3 id="zygoteInit"><a href="#zygoteInit" class="headerlink" title="zygoteInit"></a>zygoteInit</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Runnable <span class="token function">zygoteInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>RuntimeInit<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>RuntimeInit<span class="token punctuation">.</span>TAG<span class="token punctuation">,</span> <span class="token string">"RuntimeInit: Starting application from zygote"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_ACTIVITY_MANAGER<span class="token punctuation">,</span> <span class="token string">"ZygoteInit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        RuntimeInit<span class="token punctuation">.</span><span class="token function">redirectLogStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        RuntimeInit<span class="token punctuation">.</span><span class="token function">commonInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ZygoteInit<span class="token punctuation">.</span><span class="token function">nativeZygoteInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> RuntimeInit<span class="token punctuation">.</span><span class="token function">applicationInit</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h4 id="commonInit"><a href="#commonInit" class="headerlink" title="commonInit"></a>commonInit</h4><p>commonInitä¸»è¦è¿›è¡Œä¸€äº›å¸¸è§„åˆå§‹åŒ–ã€‚ç”±äºè‡ªå·±æ˜¯åšé€šä¿¡çš„ï¼Œæ‰€ä»¥æ¯”è¾ƒå…³æ³¨çš„æ˜¯åˆ›å»ºUA(user agent): frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">commonInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">/*         * Sets the default HTTP User-Agent used by HttpURLConnection.         */</span>        String userAgent <span class="token operator">=</span> <span class="token function">getDefaultUserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"http.agent"</span><span class="token punctuation">,</span> userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span></code></pre><p>User-Agentæ˜¯Httpåè®®ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå±äºå¤´åŸŸçš„ç»„æˆéƒ¨åˆ†ï¼Œæ˜¯ä¸€ç§å‘è®¿é—®ç½‘ç«™æä¾›ä½ æ‰€ä½¿ç”¨çš„æµè§ˆå™¨ç±»å‹ã€æ“ä½œç³»ç»Ÿã€æµè§ˆå™¨å†…æ ¸ç­‰ä¿¡æ¯çš„æ ‡è¯†ã€‚é€šè¿‡è¿™ä¸ªæ ‡è¯†ï¼Œç”¨æˆ·æ‰€è®¿é—®çš„ç½‘ç«™å¯ä»¥æ˜¾ç¤ºä¸åŒçš„æ’ç‰ˆï¼Œä»è€Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„ä½“éªŒæˆ–è€…è¿›è¡Œä¿¡æ¯ç»Ÿè®¡ã€‚</p><h4 id="nativeZygoteInit"><a href="#nativeZygoteInit" class="headerlink" title="nativeZygoteInit"></a>nativeZygoteInit</h4><p>å‡½æ•°nativeZyoteInitå®ç°åœ¨frameworks/base/core/jni/AndroidRuntime.cppä¸­ï¼Œä¸»è¦ç”¨äºä¸ºBinderé€šä¿¡æ‰“ä¸‹åŸºç¡€ã€‚</p><pre class=" language-C++"><code class="language-C++">static void com_android_internal_os_ZygoteInit_nativeZygoteInit(JNIEnv* env, jobject clazz){    gCurRuntime->onZygoteInit();}</code></pre><p>è¿™é‡Œéœ€è¦å…³æ³¨çš„æ˜¯ï¼ŒSystemServerè¿›ç¨‹ä¸­çš„gCurRuntimeæŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å®é™…ä¸Šåœ¨zygoteè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œåœ¨app_main.cppçš„mainå‡½æ•°ä¸­ï¼Œåˆ›å»ºå‡ºäº†AppRuntimeï¼š</p><pre class=" language-C++"><code class="language-C++">int main(int argc, char* const argv[]){    ........    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));    ........</code></pre><p>AppRuntimeå®šä¹‰å¦‚ä¸‹ï¼š</p><pre class=" language-C++"><code class="language-C++">class AppRuntime : public AndroidRuntime{public:    AppRuntime(char* argBlockStart, const size_t argBlockLength)        : AndroidRuntime(argBlockStart, argBlockLength)        , mClass(NULL)    {    }    ... ...}</code></pre><p>çœ‹çœ‹AppRuntimeçš„çˆ¶ç±»AndroidRuntimeï¼š</p><pre class=" language-C++"><code class="language-C++">AndroidRuntime::AndroidRuntime(char* argBlockStart, const size_t argBlockLength) :        mExitWithoutCleanup(false),        mArgBlockStart(argBlockStart),        mArgBlockLength(argBlockLength){    SkGraphics::Init();    // Pre-allocate enough space to hold a fair number of options.    mOptions.setCapacity(20);    assert(gCurRuntime == NULL);        // one per process    gCurRuntime = this;}</code></pre><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒAndroidRuntimeåˆå§‹åŒ–æ—¶å®šä¹‰äº†gCurRuntimeã€‚gCurRuntimeæŒ‡å‘å¯¹è±¡è‡ªèº«ï¼Œä¹Ÿå°±æ˜¯è¯´gCurRuntimeæŒ‡å‘çš„æ˜¯AppRuntimeå¯¹è±¡ã€‚</p><p>ç”±äºSystemServerè¿›ç¨‹ç”±zygoteè¿›ç¨‹forkå‡ºæ¥ï¼Œäºæ˜¯system serverè¿›ç¨‹ä¸­ä¹Ÿå­˜åœ¨gCurRuntimeå¯¹è±¡ï¼Œç±»å‹ä¸ºAppRuntimeã€‚è‡³æ­¤æˆ‘ä»¬çŸ¥é“ï¼ŒNativeå‡½æ•°ä¸­gCurRuntime-&gt;onZygoteInitå°†è°ƒç”¨AppRuntimeä¸­çš„onZygoteInitã€‚</p><pre class=" language-C++"><code class="language-C++">    virtual void onZygoteInit()    {        sp<ProcessState> proc = ProcessState::self();        ALOGV("App process: starting thread pool.\n");        proc->startThreadPool();    }</code></pre><p>onZygoteInitçš„ç”¨é€”æ˜¯å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºbinderé€šä¿¡ã€‚</p><h4 id="applicationInit"><a href="#applicationInit" class="headerlink" title="applicationInit"></a>applicationInit</h4><pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">static</span> Runnable <span class="token function">applicationInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>            ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è®¾ç½®ä¸€äº›è¿›ç¨‹é€€å‡ºçš„å¤„ç†ç­–ç•¥ï¼Œå¯ç”¨å †æ ˆä¸Šé™ç­‰</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// Remaining arguments are passed to the start class's static main</span>        <span class="token keyword">return</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>startClass<span class="token punctuation">,</span> args<span class="token punctuation">.</span>startArgs<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>ç»§ç»­åˆ†æfindStaticMainå‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> Runnable <span class="token function">findStaticMain</span><span class="token punctuation">(</span>String className<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>            ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// classNameä¸ºè¿›è¡Œåˆå§‹åŒ–å·¥ä½œçš„è¿›ç¨‹ç±»å</span>        <span class="token comment" spellcheck="true">// åœ¨SystemServeråˆå§‹åŒ–æ—¶ï¼Œä¸ºcom.android.server.SystemServer</span>        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cl<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ä¸‹é¢å°±æ˜¯é€šè¿‡åå°„å¾—åˆ°å¯¹åº”ç±»çš„mainæ–¹æ³•</span>            cl <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                    <span class="token string">"Missing class when invoking static main "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span>                    ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">/*         * This throw gets caught in ZygoteInit.main(), which responds         * by invoking the exception's run() method. This arrangement         * clears up all the stack frames that were required in setting         * up the process.         */</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ•è·MethodAndArgsCallerå¼‚å¸¸</span>    <span class="token punctuation">}</span></code></pre><h2 id="mainå‡½æ•°"><a href="#mainå‡½æ•°" class="headerlink" title="mainå‡½æ•°"></a>mainå‡½æ•°</h2><p>æ¥ä¸‹æ¥å°±è¿›å…¥äº†SystemServer.javaçš„mainå‡½æ•°ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * The main entry point from zygote.     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">SystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºå¹¶è¿è¡Œï¼Œç®€å•ç²—æš´ï¼</span>    <span class="token punctuation">}</span></code></pre><p>è¿™é‡Œæ¯”è¾ƒç®€å•ï¼Œåªæ˜¯newå‡ºä¸€ä¸ªSystemServerå¯¹è±¡å¹¶æ‰§è¡Œå…¶runæ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"InitBeforeStartServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// If a device's clock is before 1970 (before 0), a lot of</span>            <span class="token comment" spellcheck="true">// APIs crash dealing with negative numbers, notably</span>            <span class="token comment" spellcheck="true">// java.io.File#setLastModified, so instead we fake it and</span>            <span class="token comment" spellcheck="true">// hope that time from cell towers or NTP fixes it shortly.</span>            <span class="token comment" spellcheck="true">// å¦‚ä½•ç³»ç»Ÿæ—¶é’Ÿæ—©äº1970å¹´ï¼Œåˆ™è®¾ç½®ç³»ç»Ÿå§‹ç»ˆä»1970å¹´å¼€å§‹</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> EARLIEST_SUPPORTED_TIME<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System clock is before 1970; setting to 1970."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// private static final long EARLIEST_SUPPORTED_TIME = 86400 * 1000;</span>                SystemClock<span class="token punctuation">.</span><span class="token function">setCurrentTimeMillis</span><span class="token punctuation">(</span>EARLIEST_SUPPORTED_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// If the system has "persist.sys.language" and friends set, replace them with</span>            <span class="token comment" spellcheck="true">// "persist.sys.locale". Note that the default locale at this point is calculated</span>            <span class="token comment" spellcheck="true">// using the "-Duser.locale" command line flag. That flag is usually populated by</span>            <span class="token comment" spellcheck="true">// AndroidRuntime using the same set of system properties, but only the system_server</span>            <span class="token comment" spellcheck="true">// and system apps are allowed to set them.</span>            <span class="token comment" spellcheck="true">//</span>            <span class="token comment" spellcheck="true">// NOTE: Most changes made here will need an equivalent change to</span>            <span class="token comment" spellcheck="true">// core/jni/AndroidRuntime.cpp</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"persist.sys.language"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// è®¾ç½®åŒºåŸŸï¼Œè¯­è¨€ç­‰é€‰é¡¹            </span>                <span class="token keyword">final</span> String languageTag <span class="token operator">=</span> Locale<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLanguageTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.locale"</span><span class="token punctuation">,</span> languageTag<span class="token punctuation">)</span><span class="token punctuation">;</span>                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.language"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.country"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"persist.sys.localevar"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Mmmmmm... more memory!</span>            <span class="token comment" spellcheck="true">// æ¸…é™¤vmå†…å­˜å¢é•¿ä¸Šé™ï¼Œç”±äºå¯åŠ¨è¿‡ç¨‹éœ€è¦è¾ƒå¤šçš„è™šæ‹Ÿæœºå†…å­˜ç©ºé—´</span>            VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearGrowthLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                 <span class="token comment" spellcheck="true">// The system server has to run all of the time, so it needs to be</span>            <span class="token comment" spellcheck="true">// as efficient as possible with its memory usage.</span>            <span class="token comment" spellcheck="true">// è®¾ç½®å †æ ˆåˆ©ç”¨ç‡ï¼ŒGCåä¼šé‡æ–°è®¡ç®—å †æ ˆç©ºé—´å¤§å°</span>            VMRuntime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTargetHeapUtilization</span><span class="token punctuation">(</span><span class="token number">0.8f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token comment" spellcheck="true">// Some devices rely on runtime fingerprint generation, so make sure</span>            <span class="token comment" spellcheck="true">// we've defined it before booting further.</span>            <span class="token comment" spellcheck="true">// é’ˆå¯¹éƒ¨åˆ†è®¾å¤‡ä¾èµ–äºè¿è¡Œæ—¶å°±äº§ç”ŸæŒ‡çº¹ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦åœ¨å¼€æœºå®Œæˆå‰å·²ç»å®šä¹‰</span>            Build<span class="token punctuation">.</span><span class="token function">ensureFingerprintProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                         <span class="token comment" spellcheck="true">// Within the system server, it is an error to access Environment paths without</span>            <span class="token comment" spellcheck="true">// explicitly specifying a user.</span>            <span class="token comment" spellcheck="true">// è®¿é—®ç¯å¢ƒå˜é‡å‰ï¼Œéœ€è¦æ˜ç¡®åœ°æŒ‡å®šç”¨æˆ·</span>            Environment<span class="token punctuation">.</span><span class="token function">setUserRequired</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// Initialize native services.</span>            <span class="token comment" spellcheck="true">// åŠ è½½åŠ¨æ€åº“libandroid_services.so</span>            System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"android_servers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                     <span class="token comment" spellcheck="true">// Check whether we failed to shut down last time we tried.</span>            <span class="token comment" spellcheck="true">// This call may not return.</span>            <span class="token comment" spellcheck="true">// æ£€æµ‹ä¸Šæ¬¡å…³æœºè¿‡ç¨‹æ˜¯å¦å¤±è´¥ï¼Œè¯¥æ–¹æ³•å¯èƒ½ä¸ä¼šè¿”å›</span>            <span class="token function">performPendingShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                    <span class="token comment" spellcheck="true">// Initialize the system context.</span>            <span class="token comment" spellcheck="true">// åœ¨SystemServerè¿›ç¨‹ä¸­ä¹Ÿéœ€è¦åˆ›å»ºContextå¯¹è±¡ï¼Œåˆå§‹åŒ–ç³»ç»Ÿä¸Šä¸‹æ–‡</span>            <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                     <span class="token comment" spellcheck="true">// Create the system service manager.</span>            <span class="token comment" spellcheck="true">// é€šè¿‡SystemServiceManagerçš„æ„é€ æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„SystemServiceManagerå¯¹è±¡</span>            mSystemServiceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemServiceManager</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// SystemServerè¿›ç¨‹ä¸»è¦æ˜¯ç”¨æ¥æ„å»ºç³»ç»Ÿå„ç§serviceæœåŠ¡ï¼Œè€ŒSystemServiceManagerå°±æ˜¯è¿™äº›æœåŠ¡çš„ç®¡ç†å¯¹è±¡            </span>            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">setRuntimeRestarted</span><span class="token punctuation">(</span>mRuntimeRestart<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment" spellcheck="true">// å°†SystemServiceManagerå¯¹è±¡ä¿å­˜åˆ°SystemServerè¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ•°æ®ç»“æ„ä¸­            </span>            LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>SystemServiceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// Prepare the thread pool for init tasks that can be parallelized</span>            SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// InitBeforeStartServices</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Start services.</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>                              <span class="token comment" spellcheck="true">// åˆ†ç§ç±»å¯åŠ¨ä¸åŒçš„system service</span>            <span class="token comment" spellcheck="true">// ä¸»è¦ç”¨äºå¯åŠ¨ç³»ç»ŸBootçº§æœåŠ¡</span>            <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// ä¸»è¦ç”¨äºå¯åŠ¨ç³»ç»Ÿæ ¸å¿ƒçš„æœåŠ¡            </span>            <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// ä¸»è¦ç”¨äºå¯åŠ¨ä¸€äº›éç´§è¦æˆ–è€…ééœ€è¦åŠæ—¶å¯åŠ¨çš„æœåŠ¡            </span>            <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"******************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"************ Failure starting system services"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// Loop forever.</span>        <span class="token comment" spellcheck="true">// //å¯åŠ¨looperï¼Œä»¥å¤„ç†åˆ°æ¥çš„æ¶ˆæ¯ï¼Œä¸€ç›´å¾ªç¯æ‰§è¡Œ</span>        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»¥ä¸Šå°±æ˜¯SystemServerçš„runå‡½æ•°æ•´ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬åšä¸ªç®€åŒ–ï¼Œå¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Initialize the system context.</span>            <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment" spellcheck="true">// ğŸğŸğŸ 01.åˆå§‹åŒ–ç³»ç»Ÿä¸Šä¸‹æ–‡ ğŸğŸğŸ</span>            <span class="token comment" spellcheck="true">// Create the system service manager.                                          </span>            mSystemServiceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemServiceManager</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ğŸğŸğŸ 02.åˆ›å»ºç³»ç»ŸæœåŠ¡ç®¡ç† ğŸğŸğŸ</span>            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">setRuntimeRestarted</span><span class="token punctuation">(</span>mRuntimeRestart<span class="token punctuation">)</span><span class="token punctuation">;</span>                              LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>SystemServiceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// InitBeforeStartServices</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Start services.                                                    // ğŸğŸğŸ 03.å¯åŠ¨ç³»ç»Ÿå„ç§æœåŠ¡ ğŸğŸğŸ</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment" spellcheck="true">// å¯åŠ¨å¼•å¯¼æœåŠ¡</span>            <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment" spellcheck="true">// å¯åŠ¨æ ¸å¿ƒæœåŠ¡</span>            <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                             <span class="token comment" spellcheck="true">// å¯åŠ¨å…¶ä»–æœåŠ¡</span>            SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"******************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> <span class="token string">"************ Failure starting system services"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// Loop forever.</span>        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                        <span class="token comment" spellcheck="true">// ä¸€ç›´å¾ªç¯æ‰§è¡Œ  </span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OKï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é’ˆå¯¹SystemServeræ‰€åšçš„ä¸‰éƒ¨åˆ†å·¥ä½œï¼Œè¿›è¡Œé€ä¸ªåˆ†æï¼</p><hr><h2 id="åˆå§‹åŒ–ä¸Šä¸‹æ–‡"><a href="#åˆå§‹åŒ–ä¸Šä¸‹æ–‡" class="headerlink" title="åˆå§‹åŒ–ä¸Šä¸‹æ–‡"></a><strong><font color="#DC143C" size="3">åˆå§‹åŒ–ä¸Šä¸‹æ–‡</font></strong></h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Initialize the system context.</span>            <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment" spellcheck="true">// ğŸğŸğŸ 01.åˆå§‹åŒ–ç³»ç»Ÿä¸Šä¸‹æ–‡ ğŸğŸğŸ</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è·Ÿè¸ªcreateSystemContextå‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ActivityThread activityThread <span class="token operator">=</span> ActivityThread<span class="token punctuation">.</span><span class="token function">systemMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mSystemContext <span class="token operator">=</span> activityThread<span class="token punctuation">.</span><span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mSystemContext<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>DEFAULT_SYSTEM_THEME<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> Context systemUiContext <span class="token operator">=</span> activityThread<span class="token punctuation">.</span><span class="token function">getSystemUiContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        systemUiContext<span class="token punctuation">.</span><span class="token function">setTheme</span><span class="token punctuation">(</span>DEFAULT_SYSTEM_THEME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è·Ÿè¸ªsystemMainå‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> ActivityThread <span class="token function">systemMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// The system process on low-memory devices do not get to use hardware</span>        <span class="token comment" spellcheck="true">// accelerated drawing, since this can add too much overhead to the</span>        <span class="token comment" spellcheck="true">// process.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ActivityManager<span class="token punctuation">.</span><span class="token function">isHighEndGfx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ThreadedRenderer<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                   <span class="token comment" spellcheck="true">// å¯¹äºä½å†…å­˜çš„è®¾å¤‡ï¼Œç¦ç”¨ç¡¬ä»¶åŠ é€Ÿ</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            ThreadedRenderer<span class="token punctuation">.</span><span class="token function">enableForegroundTrimming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ActivityThread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> thread<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mResourcesManager <span class="token operator">=</span> ResourcesManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// ä½¿ç”¨å•ä¾‹æ¨¡å¼è·å¾—ä¸€ä¸ªResourcesManagerå®ä¾‹</span>    <span class="token punctuation">}</span></code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»§ç»­è·Ÿè¸ªattachå‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">)</span> <span class="token punctuation">{</span>        sCurrentActivityThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        mSystemThread <span class="token operator">=</span> system<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Don't set application object here -- if the system crashes,</span>            <span class="token comment" spellcheck="true">// we can't display an alert, we just want to die die die.</span>            <span class="token comment" spellcheck="true">// è®¾ç½®SystemServerè¿›ç¨‹åœ¨DDMSä¸­æ˜¾ç¤ºçš„åå­—ä¸º"system_process" </span>            android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span>DdmHandleAppName<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"system_process"</span><span class="token punctuation">,</span>                                          UserHandle<span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// å¦‚ä¸è®¾ç½®ï¼Œåˆ™æ˜¾ç¤º"?"ï¼Œæ— æ³•è°ƒè¯•è¯¥è¿›ç¨‹</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// é¦–å…ˆé€šè¿‡getSystemContext()åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ï¼Œç„¶ååˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡</span>                ContextImpl context <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>                                                <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// åˆ›å»ºApplication</span>                mInitialApplication <span class="token operator">=</span> context<span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// è°ƒç”¨Applicationçš„onCreate()                </span>                mInitialApplication<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                        <span class="token string">"Unable to instantiate Application():"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// add dropbox logging to libcore</span>        DropBox<span class="token punctuation">.</span><span class="token function">setReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DropBoxReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ViewRootImpl<span class="token punctuation">.</span>ConfigChangedCallback configChangedCallback                <span class="token operator">=</span> <span class="token punctuation">(</span>Configuration globalConfig<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// We need to apply this change to the resources immediately, because upon returning</span>                <span class="token comment" spellcheck="true">// the view hierarchy will be informed about it.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">applyConfigurationToResourcesLocked</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">,</span>                        null <span class="token comment" spellcheck="true">/* compat */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>mInitialApplication<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// This actually changed the resources! Tell everyone about it.</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingConfiguration <span class="token operator">==</span> null                            <span class="token operator">||</span> mPendingConfiguration<span class="token punctuation">.</span><span class="token function">isOtherSeqNewer</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        mPendingConfiguration <span class="token operator">=</span> globalConfig<span class="token punctuation">;</span>                        <span class="token function">sendMessage</span><span class="token punctuation">(</span>H<span class="token punctuation">.</span>CONFIGURATION_CHANGED<span class="token punctuation">,</span> globalConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ·»åŠ å›è°ƒ</span>        ViewRootImpl<span class="token punctuation">.</span><span class="token function">addConfigCallback</span><span class="token punctuation">(</span>configChangedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œattachä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ï¼ˆ1ï¼‰åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ï¼šgetSystemContext() â€“&gt; createSystemContext() â€“&gt; new ContextImpl()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ï¼ˆ2ï¼‰åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡ ContextImpl.createAppContext() â€“&gt; new ContextImpl()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ï¼ˆ3ï¼‰æ·»åŠ å›è°ƒconfigChangedCallbackåˆ°ViewRootImpl</p><hr><h3 id="åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡"><a href="#åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡" class="headerlink" title="åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡"></a><strong><font color="#DC143C" size="3">åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡</font></strong></h3><p>getSystemContext():</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ContextImpl <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSystemContext <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mSystemContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createSystemContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> mSystemContext<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>è·Ÿè¸ªcreateSystemContextå‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> ContextImpl <span class="token function">createSystemContext</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è¿™è¾¹newå‡ºæ¥çš„LoadedApkå°†ä½œä¸ºåˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡çš„å‚æ•°packageInfo</span>        LoadedApk packageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoadedApk</span><span class="token punctuation">(</span>mainThread<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// ContextImpl()åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡         </span>        ContextImpl context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>                                 null<span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span>mResources<span class="token punctuation">.</span><span class="token function">updateConfiguration</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                context<span class="token punctuation">.</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> context<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡"><a href="#åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡" class="headerlink" title="åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡"></a>åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡</h3><p>ContextImpl.createAppContext()ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> ContextImpl <span class="token function">createAppContext</span><span class="token punctuation">(</span>ActivityThread mainThread<span class="token punctuation">,</span> LoadedApk packageInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"packageInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ContextImpl()åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡</span>        ContextImpl context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>                                 null<span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> context<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šnew ContextImplæ—¶ï¼Œç³»ç»Ÿä¸Šä¸‹æ–‡å’Œåº”ç”¨ä¸Šä¸‹æ–‡çš„å‚æ•°æ˜¯ä¸€æ ·çš„ï¼ŒcreateAppContext()ä¸­çš„å‚æ•°packageInfoï¼Œå°±æ˜¯createSystemContext()ä¸­newçš„LoadedApkã€‚<br>åˆ›å»ºå®Œæˆä¹‹åï¼Œç³»ç»Ÿä¸Šä¸‹æ–‡èµ‹å€¼ç»™äº†ActivityThreadçš„æˆå‘˜å˜é‡mSystemContextï¼Œè€Œåº”ç”¨ä¸Šä¸‹æ–‡åªæ˜¯ä½œä¸ºå‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡ä¸´æ—¶ä½¿ç”¨ã€‚<br>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹åˆ›å»ºä¸Šä¸‹æ–‡çš„ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java">            <span class="token keyword">try</span> <span class="token punctuation">{</span>                mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// é¦–å…ˆé€šè¿‡getSystemContext()åˆ›å»ºç³»ç»Ÿä¸Šä¸‹æ–‡ï¼Œç„¶ååˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡</span>                ContextImpl context <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>                                                <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// åˆ›å»ºApplication</span>                mInitialApplication <span class="token operator">=</span> context<span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è°ƒç”¨Applicationçš„onCreate()</span>                mInitialApplication<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            </code></pre><p>æ¥ä¸‹æ¥å°±ç»§ç»­çœ‹ä¸‹åˆ›å»ºApplicationçš„æµç¨‹ï¼š</p><h3 id="åˆ›å»ºApplication"><a href="#åˆ›å»ºApplication" class="headerlink" title="åˆ›å»ºApplication"></a>åˆ›å»ºApplication</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Application <span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceDefaultAppClass<span class="token punctuation">,</span>            Instrumentation instrumentation<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mApplication <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> mApplication<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Application app <span class="token operator">=</span> null<span class="token punctuation">;</span>        String appClass <span class="token operator">=</span> mApplicationInfo<span class="token punctuation">.</span>className<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å‚æ•°forceDefaultAppClassä¸ºtrue </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceDefaultAppClass <span class="token operator">||</span> <span class="token punctuation">(</span>appClass <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                              appClass <span class="token operator">=</span> <span class="token string">"android.app.Application"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ClassLoader cl <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ­¤LoadedApkå¯¹è±¡æ˜¯createSystemContextæ—¶newçš„ï¼ŒmPackageName="android"</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                         <span class="token function">initializeJavaContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// åˆåˆ›å»ºäº†ä¸€ä¸ªå±€éƒ¨åº”ç”¨ä¸Šä¸‹æ–‡</span>            ContextImpl appContext <span class="token operator">=</span> ContextImpl<span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// åˆ›å»ºApplication </span>            app <span class="token operator">=</span> mActivityThread<span class="token punctuation">.</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">newApplication</span><span class="token punctuation">(</span>                                             cl<span class="token punctuation">,</span> appClass<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>            appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å°†å‰é¢åˆ›å»ºçš„appæ·»åŠ åˆ°åº”ç”¨åˆ—è¡¨</span>        mActivityThread<span class="token punctuation">.</span>mAllApplications<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>        mApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> app<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>è¿™ä¸€æ­¥ä¸»è¦åˆ›å»ºäº†ä¸€ä¸ªActivityThreadå¯¹è±¡ï¼Œç„¶åæ‰§è¡Œäº†è¯¥å¯¹è±¡çš„attach()æ–¹æ³•ï¼Œattach()æ–¹æ³•ä¸­åˆ›å»ºäº†ç³»ç»Ÿä¸Šä¸‹æ–‡mSystemContextï¼ˆç±»å‹ä¸ºContextImplï¼‰ï¼Œå¹¶åˆ›å»ºApplicationå¯¹è±¡ã€‚<br>ç³»ç»Ÿä¸Šä¸‹æ–‡ä¸­ï¼Œnewäº†ä¸€ä¸ªLoadedApkçš„æˆå‘˜å˜é‡ï¼Œå¹¶å°†ActivityThreadå¯¹è±¡ä¼ ç»™LoadedApkæˆå‘˜ï¼Œåé¢çš„Applicationå¯¹è±¡å°±æ˜¯LoadedApkä½¿ç”¨ActivityThreadåˆ›å»ºçš„ï¼ŒLoadedApkåˆ›å»ºäº†Applicationå¯¹è±¡åï¼Œå°†Applicationæ·»åŠ åˆ°ActivityThreadçš„åº”ç”¨åˆ—è¡¨ä¸­ã€‚</p><h2 id="åˆ›å»ºç³»ç»ŸæœåŠ¡ç®¡ç†"><a href="#åˆ›å»ºç³»ç»ŸæœåŠ¡ç®¡ç†" class="headerlink" title="åˆ›å»ºç³»ç»ŸæœåŠ¡ç®¡ç†"></a>åˆ›å»ºç³»ç»ŸæœåŠ¡ç®¡ç†</h2><p>æˆ‘ä»¬å›é¡¾ä¸‹ç›¸å…³ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java">            <span class="token comment" spellcheck="true">// Create the system service manager.</span>            mSystemServiceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemServiceManager</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">setRuntimeRestarted</span><span class="token punctuation">(</span>mRuntimeRestart<span class="token punctuation">)</span><span class="token punctuation">;</span>            LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>SystemServiceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>è¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯newäº†ä¸€ä¸ªSystemServiceManagerï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æœ¬åœ°æœåŠ¡åˆ—è¡¨ä¸­ã€‚mSystemContextä¸ºç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„ç³»ç»Ÿä¸Šä¸‹æ–‡ã€‚æœ¬åœ°æœåŠ¡åˆ—è¡¨æ˜¯ä»¥ç±»ä¸ºkeyä¿å­˜çš„ä¸€ä¸ªåˆ—è¡¨ï¼Œå³åˆ—è¡¨ä¸­æŸç§ç±»å‹çš„å¯¹è±¡æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemServiceManager</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// Services that should receive lifecycle events.</span>    <span class="token comment" spellcheck="true">// ç³»ç»ŸæœåŠ¡åˆ—è¡¨ï¼Œç³»ç»ŸæœåŠ¡å¿…é¡»ç»§æ‰¿SystemService</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>SystemService<span class="token operator">></span> mServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>SystemService<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å½“å‰å¤„äºå¼€æœºè¿‡ç¨‹çš„å“ªä¸ªé˜¶æ®µï¼ŒSystemService.PHASE_XXXXX</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> mCurrentPhase <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">SystemServiceManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Starts a service by class name.     *     * @return The service instance.     */</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// é€šè¿‡ç±»åå¯åŠ¨ç³»ç»ŸæœåŠ¡ï¼Œå¯èƒ½ä¼šæ‰¾ä¸åˆ°ç±»è€ŒæŠ›å¼‚å¸¸</span>    <span class="token keyword">public</span> SystemService <span class="token function">startService</span><span class="token punctuation">(</span>String className<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> Class<span class="token operator">&lt;</span>SystemService<span class="token operator">></span> serviceClass<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            serviceClass <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>SystemService<span class="token operator">></span><span class="token punctuation">)</span>Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting "</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create service "</span> <span class="token operator">+</span> className                    <span class="token operator">+</span> <span class="token string">": service class not found, usually indicates that the caller should "</span>                    <span class="token operator">+</span> <span class="token string">"have called PackageManager.hasSystemFeature() to check whether the "</span>                    <span class="token operator">+</span> <span class="token string">"feature is available on this device before trying to start the "</span>                    <span class="token operator">+</span> <span class="token string">"services that implement it"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">startService</span><span class="token punctuation">(</span>serviceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Creates and starts a system service. The class must be a subclass of     * {@link com.android.server.SystemService}.     *     * @param serviceClass A Java class that implements the SystemService interface.     * @return The service instance, never null.     * @throws RuntimeException if the service fails to start.     */</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// åˆ›å»ºå¹¶å¯åŠ¨ç³»ç»ŸæœåŠ¡ï¼Œç³»ç»ŸæœåŠ¡ç±»å¿…é¡»ç»§æ‰¿SystemService</span>    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">SystemService</span><span class="token operator">></span> T <span class="token function">startService</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> serviceClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> String name <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">,</span> <span class="token string">"StartService "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Create the service.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>serviceClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create "</span> <span class="token operator">+</span> name                        <span class="token operator">+</span> <span class="token string">": service must extend "</span> <span class="token operator">+</span> SystemService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">final</span> T service<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Constructor<span class="token operator">&lt;</span>T<span class="token operator">></span> constructor <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                service <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create service "</span> <span class="token operator">+</span> name                        <span class="token operator">+</span> <span class="token string">": service could not be instantiated"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create service "</span> <span class="token operator">+</span> name                        <span class="token operator">+</span> <span class="token string">": service must have a public constructor with a Context argument"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create service "</span> <span class="token operator">+</span> name                        <span class="token operator">+</span> <span class="token string">": service must have a public constructor with a Context argument"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create service "</span> <span class="token operator">+</span> name                        <span class="token operator">+</span> <span class="token string">": service constructor threw an exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">startService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> service<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startService</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> SystemService service<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Register it.</span>        mServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Start it.</span>        <span class="token keyword">long</span> time <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            service<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to start service "</span> <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token operator">+</span> <span class="token string">": onStart threw an exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">warnIfTooLong</span><span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token string">"onStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Starts the specified boot phase for all system services that have been started up to     * this point.     *     * @param phase The boot phase to start.     */</span>    <span class="token comment" spellcheck="true">// é€šçŸ¥ç³»ç»ŸæœåŠ¡åˆ°äº†å¼€æœºçš„å“ªä¸ªé˜¶æ®µï¼Œä¼šéå†è°ƒç”¨æ‰€æœ‰ç³»ç»ŸæœåŠ¡çš„onBootPhase()å‡½æ•°</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startBootPhase</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> phase<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>phase <span class="token operator">&lt;=</span> mCurrentPhase<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Next phase must be larger than previous"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mCurrentPhase <span class="token operator">=</span> phase<span class="token punctuation">;</span>        Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting phase "</span> <span class="token operator">+</span> mCurrentPhase<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">,</span> <span class="token string">"OnBootPhase "</span> <span class="token operator">+</span> phase<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> serviceLen <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> serviceLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> SystemService service <span class="token operator">=</span> mServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">long</span> time <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    service<span class="token punctuation">.</span><span class="token function">onBootPhase</span><span class="token punctuation">(</span>mCurrentPhase<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to boot service "</span>                            <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token operator">+</span> <span class="token string">": onBootPhase threw an exception during phase "</span>                            <span class="token operator">+</span> mCurrentPhase<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token function">warnIfTooLong</span><span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token string">"onBootPhase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="å¯åŠ¨ç³»ç»Ÿå„ç§æœåŠ¡"><a href="#å¯åŠ¨ç³»ç»Ÿå„ç§æœåŠ¡" class="headerlink" title="å¯åŠ¨ç³»ç»Ÿå„ç§æœåŠ¡"></a>å¯åŠ¨ç³»ç»Ÿå„ç§æœåŠ¡</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">// å¯åŠ¨å¼•å¯¼æœåŠ¡</span>        <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// å¯åŠ¨æ ¸å¿ƒæœåŠ¡</span>        <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// å¯åŠ¨å…¶ä»–æœåŠ¡</span></code></pre><h3 id="å¯åŠ¨å¼•å¯¼æœåŠ¡"><a href="#å¯åŠ¨å¼•å¯¼æœåŠ¡" class="headerlink" title="å¯åŠ¨å¼•å¯¼æœåŠ¡"></a>å¯åŠ¨å¼•å¯¼æœåŠ¡</h3><p>é¦–å…ˆæ¥çœ‹ä¸‹startBootstrapServices()ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨InstalleræœåŠ¡ï¼Œé˜»å¡ç­‰å¾…ä¸installdå»ºç«‹socketé€šé“</span>        Installer installer <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>Installer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>DeviceIdentifiersPolicyService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨ActivityManagerServiceï¼ˆAMSï¼‰ï¼Œå…³äºAMSæˆ‘ä»¬åé¢ä¼šè¯¦ç»†è®²è§£</span>        mActivityManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>                ActivityManagerService<span class="token punctuation">.</span>Lifecycle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setSystemServiceManager</span><span class="token punctuation">(</span>mSystemServiceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setInstaller</span><span class="token punctuation">(</span>installer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨PowerManagerService</span>        mPowerManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>PowerManagerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// PowerManagerServiceå°±ç»ªï¼ŒAMSåˆå§‹åŒ–ç”µæºç®¡ç†</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">initPowerManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Bring up recovery system in case a rescue party needs a reboot</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemProperties<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"config.disable_noncore"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartRecoverySystemService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>RecoverySystemService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        RescueParty<span class="token punctuation">.</span><span class="token function">noteBoot</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨LightsService</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>LightsService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨DisplayManagerServiceï¼ˆbefore package managerï¼‰</span>        mDisplayManagerService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>DisplayManagerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–package managerä¹‹å‰ï¼Œéœ€è¦é»˜è®¤æ˜¾ç¤ºã€‚é˜»å¡ï¼Œ10sè¶…æ—¶ï¼Œsee DisplayManagerService.onBootPhase()</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startBootPhase</span><span class="token punctuation">(</span>SystemService<span class="token punctuation">.</span>PHASE_WAIT_FOR_DEFAULT_DISPLAY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Only run "core" apps if we're encrypting the device.</span>        <span class="token comment" spellcheck="true">// å½“è®¾å¤‡æ­£åœ¨åŠ å¯†æ—¶ï¼Œä»…è¿è¡Œæ ¸å¿ƒåº”ç”¨</span>        String cryptState <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"vold.decrypt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ENCRYPTING_STATE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cryptState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Detected encryption in progress - only parsing core apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mOnlyCore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ENCRYPTED_STATE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cryptState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Device encrypted - only parsing core apps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mOnlyCore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Start the package manager.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRuntimeRestart<span class="token punctuation">)</span> <span class="token punctuation">{</span>            MetricsLogger<span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"boot_package_manager_init_start"</span><span class="token punctuation">,</span>                    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨PackageManagerService</span>        mPackageManagerService <span class="token operator">=</span> PackageManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>                mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_OFF<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>        mFirstBoot <span class="token operator">=</span> mPackageManagerService<span class="token punctuation">.</span><span class="token function">isFirstBoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mPackageManager <span class="token operator">=</span> mSystemContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// å°†UserManagerServiceæ·»åŠ åˆ°æœåŠ¡åˆ—è¡¨ï¼Œè¯¥æœåŠ¡æ˜¯åœ¨PackageManagerServiceä¸­åˆå§‹åŒ–çš„        </span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>UserManagerService<span class="token punctuation">.</span>LifeCycle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Initialize attribute cache used to cache resources from packages.</span>        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ç”¨æ¥ç¼“å­˜åŒ…èµ„æºçš„å±æ€§ç¼“å­˜</span>        AttributeCache<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Set up the Application instance for the system process and get started.</span>        <span class="token comment" spellcheck="true">// è®¾ç½®AMS</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// The sensor service needs access to package manager service, app ops</span>        <span class="token comment" spellcheck="true">// service, and permissions service, therefore we start it after them.</span>        <span class="token comment" spellcheck="true">// Start sensor service in a separate thread. Completion should be checked</span>        <span class="token comment" spellcheck="true">// before using it.</span>        mSensorServiceStart <span class="token operator">=</span> SystemServerInitThreadPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            TimingsTraceLog traceLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimingsTraceLog</span><span class="token punctuation">(</span>                    SYSTEM_SERVER_TIMING_ASYNC_TAG<span class="token punctuation">,</span> Trace<span class="token punctuation">.</span>TRACE_TAG_SYSTEM_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>            traceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>START_SENSOR_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¯åŠ¨ä¼ æ„Ÿå™¨æœåŠ¡ï¼ˆnative æœåŠ¡ï¼Œä¾èµ–PackageManagerServiceã€AppOpsServiceã€permissions serviceï¼‰</span>            <span class="token function">startSensorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            traceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> START_SENSOR_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>è¿™æ­¥é¦–å…ˆç­‰å¾…installdå¯åŠ¨å®Œæˆï¼Œç„¶åå¯åŠ¨ä¸€äº›ç›¸äº’ä¾èµ–çš„å…³é”®æœåŠ¡ã€‚æ‰€åˆ›å»ºçš„æœåŠ¡ï¼šActivityManagerServiceï¼ŒPowerManagerServiceï¼ŒLightsServiceï¼ŒDisplayManagerServiceï¼ŒPackageManagerServiceï¼ŒUserManagerServiceï¼ŒsensoræœåŠ¡ã€‚</p><h3 id="å¯åŠ¨æ ¸å¿ƒæœåŠ¡"><a href="#å¯åŠ¨æ ¸å¿ƒæœåŠ¡" class="headerlink" title="å¯åŠ¨æ ¸å¿ƒæœåŠ¡"></a>å¯åŠ¨æ ¸å¿ƒæœåŠ¡</h3><p>æ¥ä¸‹æ¥ç»§ç»­çœ‹ä¸‹æ ¸å¿ƒæœåŠ¡ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Starts some essential services that are not tangled up in the bootstrap process.     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>DropBoxManagerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨BatteryServiceï¼Œç”¨äºç»Ÿè®¡ç”µæ± ç”µé‡ï¼Œéœ€è¦LightService</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>BatteryService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨UsageStatsServiceï¼Œç”¨äºç»Ÿè®¡åº”ç”¨ä½¿ç”¨æƒ…å†µ</span>        mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>UsageStatsService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mActivityManagerService<span class="token punctuation">.</span><span class="token function">setUsageStatsManager</span><span class="token punctuation">(</span>                LocalServices<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>UsageStatsManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨WebViewUpdateService</span>        mWebViewUpdateService <span class="token operator">=</span> mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>WebViewUpdateService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>å¯åŠ¨æœåŠ¡DropBoxManagerServiceã€BatteryServiceï¼ŒUsageStatsServiceï¼ŒWebViewUpdateServiceã€‚</p><h3 id="å¯åŠ¨å…¶ä»–æœåŠ¡"><a href="#å¯åŠ¨å…¶ä»–æœåŠ¡" class="headerlink" title="å¯åŠ¨å…¶ä»–æœåŠ¡"></a>å¯åŠ¨å…¶ä»–æœåŠ¡</h3><p>ä»£ç å¾ˆé•¿ï¼ˆ1200å¤šè¡Œâ€¦ï¼‰ï¼Œä½†æ˜¯é€»è¾‘ç®€å•ï¼Œä¸»è¦æ˜¯å¯åŠ¨å„ç§æœåŠ¡ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Starts a miscellaneous grab bag of stuff that has yet to be refactored     * and organized.     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartSchedulingPolicyService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// è°ƒåº¦ç­–ç•¥</span>            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"scheduling_policy"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SchedulingPolicyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartTelecomLoaderService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>TelecomLoaderService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartTelephonyRegistry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// æä¾›ç”µè¯æ³¨å†Œã€ç®¡ç†æœåŠ¡ï¼Œå¯ä»¥è·å–ç”µè¯çš„é“¾æ¥çŠ¶æ€ã€ä¿¡å·å¼ºåº¦ç­‰</span>            telephonyRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelephonyRegistry</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"telephony.registry"</span><span class="token punctuation">,</span> telephonyRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartEntropyMixer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// éšæœºæ•°ç›¸å…³ï¼ŒåŸåEntropyService</span>            mEntropyMixer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntropyMixer</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mContentResolver <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// The AccountManager must come before the ContentService</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartAccountManagerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// æä¾›æ‰€æœ‰è´¦å·ã€å¯†ç ã€è®¤è¯ç®¡ç†ç­‰ç­‰çš„æœåŠ¡</span>            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>ACCOUNT_SERVICE_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartContentService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ContentProvideræœåŠ¡ï¼Œæä¾›è·¨è¿›ç¨‹æ•°æ®äº¤æ¢</span>            mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>CONTENT_SERVICE_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"InstallSystemProviders"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mActivityManagerService<span class="token punctuation">.</span><span class="token function">installSystemProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartVibratorService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// æŒ¯åŠ¨å™¨æœåŠ¡</span>            vibrator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VibratorService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"vibrator"</span><span class="token punctuation">,</span> vibrator<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"InitWatchdog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// åˆå§‹åŒ– Watchdog</span>            <span class="token keyword">final</span> Watchdog watchdog <span class="token operator">=</span> Watchdog<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            watchdog<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mActivityManagerService<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartInputManagerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// äº‹ä»¶ä¼ é€’åˆ†å‘æœåŠ¡</span>            inputManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartWindowManagerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// çª—å£ç®¡ç†æœåŠ¡</span>            <span class="token comment" spellcheck="true">// WMS needs sensor service ready</span>            ConcurrentUtils<span class="token punctuation">.</span><span class="token function">waitForFutureNoInterrupt</span><span class="token punctuation">(</span>mSensorServiceStart<span class="token punctuation">,</span> START_SENSOR_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>            mSensorServiceStart <span class="token operator">=</span> null<span class="token punctuation">;</span>            wm <span class="token operator">=</span> WindowManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> inputManager<span class="token punctuation">,</span>                    mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_LOW_LEVEL<span class="token punctuation">,</span>                    <span class="token operator">!</span>mFirstBoot<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindowManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">,</span> wm<span class="token punctuation">)</span><span class="token punctuation">;</span>            ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>INPUT_SERVICE<span class="token punctuation">,</span> inputManager<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        LockSettingsService               <span class="token comment" spellcheck="true">// å±å¹•é”å®šæœåŠ¡ï¼Œç®¡ç†æ¯ä¸ªç”¨æˆ·çš„ç›¸å…³é”å±ä¿¡æ¯</span>        DeviceIdleController              <span class="token comment" spellcheck="true">// Dozeæ¨¡å¼çš„ä¸»è¦é©±åŠ¨ï¼Œå‚è€ƒâ€œæ·±å…¥Android 'M' Dozeâ€</span>        DevicePolicyManagerService        <span class="token comment" spellcheck="true">// æä¾›ä¸€äº›ç³»ç»Ÿçº§åˆ«çš„è®¾ç½®åŠå±æ€§</span>        StatusBarManagerService           <span class="token comment" spellcheck="true">// çŠ¶æ€æ ç®¡ç†æœåŠ¡</span>        ClipboardService                  <span class="token comment" spellcheck="true">// ç³»ç»Ÿå‰ªåˆ‡æ¿æœåŠ¡</span>        NetworkManagementService          <span class="token comment" spellcheck="true">// ç½‘ç»œç®¡ç†æœåŠ¡</span>        TextServicesManagerService        <span class="token comment" spellcheck="true">// æ–‡æœ¬æœåŠ¡ï¼Œä¾‹å¦‚æ–‡æœ¬æ£€æŸ¥ç­‰</span>        NetworkScoreService               <span class="token comment" spellcheck="true">// ç½‘ç»œè¯„åˆ†æœåŠ¡</span>        NetworkStatsService               <span class="token comment" spellcheck="true">// ç½‘ç»œçŠ¶æ€æœåŠ¡</span>        NetworkPolicyManagerService       <span class="token comment" spellcheck="true">// ç½‘ç»œç­–ç•¥æœåŠ¡</span>        WifiP2pService                    <span class="token comment" spellcheck="true">// Wifi DirectæœåŠ¡</span>        WifiService                       <span class="token comment" spellcheck="true">// WifiæœåŠ¡</span>        WifiScanningService               <span class="token comment" spellcheck="true">// Wifiæ‰«ææœåŠ¡</span>        RttService                        <span class="token comment" spellcheck="true">// Wifiç›¸å…³</span>        EthernetService                   <span class="token comment" spellcheck="true">// ä»¥å¤ªç½‘æœåŠ¡</span>        ConnectivityService               <span class="token comment" spellcheck="true">// ç½‘ç»œè¿æ¥ç®¡ç†æœåŠ¡</span>        NsdService                        <span class="token comment" spellcheck="true">// ç½‘ç»œå‘ç°æœåŠ¡</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        NotificationManagerService        <span class="token comment" spellcheck="true">// é€šçŸ¥æ ç®¡ç†æœåŠ¡</span>        DeviceStorageMonitorService       <span class="token comment" spellcheck="true">// ç£ç›˜ç©ºé—´çŠ¶æ€æ£€æµ‹æœåŠ¡</span>        LocationManagerService            <span class="token comment" spellcheck="true">// ä½ç½®æœåŠ¡ï¼ŒGPSã€å®šä½ç­‰</span>        CountryDetectorService            <span class="token comment" spellcheck="true">// æ£€æµ‹ç”¨æˆ·å›½å®¶</span>        SearchManagerService              <span class="token comment" spellcheck="true">// æœç´¢ç®¡ç†æœåŠ¡</span>        DropBoxManagerService             <span class="token comment" spellcheck="true">// ç”¨äºç³»ç»Ÿè¿è¡Œæ—¶æ—¥å¿—çš„å­˜å‚¨äºç®¡ç†</span>        WallpaperManagerService           <span class="token comment" spellcheck="true">// å£çº¸ç®¡ç†æœåŠ¡</span>        AudioService                      <span class="token comment" spellcheck="true">// AudioFlingerçš„ä¸Šå±‚ç®¡ç†å°è£…ï¼Œä¸»è¦æ˜¯éŸ³é‡ã€éŸ³æ•ˆã€å£°é“åŠé“ƒå£°ç­‰çš„ç®¡ç†</span>        DockObserver                      <span class="token comment" spellcheck="true">// å¦‚æœç³»ç»Ÿæœ‰ä¸ªåº§å­ï¼Œå½“æ‰‹æœºè£…ä¸Šæˆ–æ‹”å‡ºè¿™ä¸ªåº§å­çš„è¯ï¼Œå°±å¾—é ä»–æ¥ç®¡ç†äº†</span>        WiredAccessoryManager             <span class="token comment" spellcheck="true">// ç›‘è§†æ‰‹æœºå’Œåº•åº§ä¸Šçš„è€³æœº</span>        UsbService                        <span class="token comment" spellcheck="true">// USBæœåŠ¡</span>        SerialService                     <span class="token comment" spellcheck="true">// ä¸²å£æœåŠ¡</span>        TwilightService                   <span class="token comment" spellcheck="true">// æŒ‡å‡ºç”¨æˆ·å½“å‰æ‰€åœ¨ä½ç½®æ˜¯å¦ä¸ºæ™šä¸Šï¼Œè¢«UiModeManagerç­‰ç”¨æ¥è°ƒæ•´å¤œé—´æ¨¡å¼ã€‚</span>        BackupManagerService              <span class="token comment" spellcheck="true">// å¤‡ä»½æœåŠ¡</span>        AppWidgetService                  <span class="token comment" spellcheck="true">// æä¾›Widgetçš„ç®¡ç†å’Œç›¸å…³æœåŠ¡</span>        VoiceInteractionManagerService    <span class="token comment" spellcheck="true">// è¯­éŸ³äº¤äº’ç®¡ç†æœåŠ¡</span>        DiskStatsService                  <span class="token comment" spellcheck="true">// ç£ç›˜ç»Ÿè®¡æœåŠ¡ï¼Œä¾›dumpsysä½¿ç”¨</span>        SamplingProfilerService           <span class="token comment" spellcheck="true">// ç”¨äºè€—æ—¶ç»Ÿè®¡ç­‰</span>        NetworkTimeUpdateService          <span class="token comment" spellcheck="true">// ç›‘è§†ç½‘ç»œæ—¶é—´ï¼Œå½“ç½‘ç»œæ—¶é—´å˜åŒ–æ—¶æ›´æ–°æœ¬åœ°æ—¶é—´ã€‚</span>        CommonTimeManagementService       <span class="token comment" spellcheck="true">// ç®¡ç†æœ¬åœ°å¸¸è§çš„æ—¶é—´æœåŠ¡çš„é…ç½®ï¼Œåœ¨ç½‘ç»œé…ç½®å˜åŒ–æ—¶é‡æ–°é…ç½®æœ¬åœ°æœåŠ¡ã€‚</span>        CertBlacklister                   <span class="token comment" spellcheck="true">// æä¾›ä¸€ç§æœºåˆ¶æ›´æ–°SSL certificate blacklist</span>        DreamManagerService               <span class="token comment" spellcheck="true">// å±å¹•ä¿æŠ¤</span>        AssetAtlasService                 <span class="token comment" spellcheck="true">// è´Ÿè´£å°†é¢„åŠ è½½çš„bitmapç»„è£…æˆçº¹ç†è´´å›¾ï¼Œç”Ÿæˆçš„çº¹ç†è´´å›¾å¯ä»¥è¢«ç”¨æ¥è·¨è¿›ç¨‹ä½¿ç”¨ï¼Œä»¥å‡å°‘å†…å­˜ã€‚</span>        PrintManagerService               <span class="token comment" spellcheck="true">// æ‰“å°æœåŠ¡</span>        HdmiControlService                <span class="token comment" spellcheck="true">// HDMIæ§åˆ¶æœåŠ¡</span>        FingerprintService                <span class="token comment" spellcheck="true">// æŒ‡çº¹æœåŠ¡</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span></code></pre><p>ä»¥ä¸Šä»£ç ä»…æŒ‰é¡ºåºåˆ—å‡ºå¯åŠ¨çš„æœåŠ¡ï¼Œæœ‰äº›æœåŠ¡æ ¹æ®æ¡ä»¶ï¼Œå¦‚æ˜¯å¦æ˜¯å·¥å‚æ¨¡å¼ï¼Œæˆ–ç³»ç»Ÿå±æ€§é…ç½®ï¼Œé€‰æ‹©æ€§å¯åŠ¨ï¼Œè¿™é‡Œä¸è€ƒè™‘æ¡ä»¶åˆ¤æ–­å’Œå¼‚å¸¸å¤„ç†ã€‚</p><p>è‡ªæ­¤ï¼ŒSystemServerç›¸å…³æºç åˆ†æå®Œæ¯•ã€‚</p><h1 id="å‚è€ƒBlog"><a href="#å‚è€ƒBlog" class="headerlink" title="å‚è€ƒBlog"></a>å‚è€ƒBlog</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01. <a href="https://blog.csdn.net/kingodcool/article/details/52171331" target="_blank" rel="noopener">https://blog.csdn.net/kingodcool/article/details/52171331</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 02. <a href="https://blog.csdn.net/qq_23547831/article/details/51105171" target="_blank" rel="noopener">https://blog.csdn.net/qq_23547831/article/details/51105171</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 03. <a href="https://blog.csdn.net/gaugamela/article/details/52261075" target="_blank" rel="noopener">https://blog.csdn.net/gaugamela/article/details/52261075</a></p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿå¯åŠ¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯åŠ¨é˜¶æ®µ </tag>
            
            <tag> SystemServer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</title>
      <link href="/2018/12/10/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-zygote/"/>
      <url>/2018/12/10/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-zygote/</url>
      
        <content type="html"><![CDATA[<p><br></p><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><br><center><strong><font color="#1874CD"><font color="#3A5FCD" size="4">Android å¯åŠ¨é˜¶æ®µç³»åˆ—</font></font></strong></center><br><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€å¯åŠ¨é˜¶æ®µã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">æºç ç‰ˆæœ¬</font></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">init</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/01/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20init/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">zygote</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/10/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20zygote/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">systemserver</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/18/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20systemserver/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Launcher</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/26/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20Launcher/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨åŠåŠ è½½æµç¨‹</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">åšæ–‡ä¿®æ”¹æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† zygote æºç ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br><br></p><hr><h1 id="å¼€ç¯‡"><a href="#å¼€ç¯‡" class="headerlink" title="å¼€ç¯‡"></a>å¼€ç¯‡</h1><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">init.rc</font></td><td>system/core/rootdir/init.rc</td></tr><tr><td><font color="#D15FEE">init.cpp</font></td><td>system/core/init/init.cpp</td></tr><tr><td><font color="#D15FEE">init.zygote64.rc</font></td><td>system/core/rootdir/init.zygote64.rc</td></tr><tr><td><font color="#D15FEE">builtins.cpp</font></td><td>system/core/init/builtins.cpp</td></tr><tr><td><font color="#D15FEE">service.cpp</font></td><td>system/core/init/service.cpp</td></tr><tr><td><font color="#D15FEE">app_main.cpp</font></td><td>frameworks/base/cmds/app_process/app_main.cpp</td></tr><tr><td><font color="#D15FEE">AndroidRuntime.cpp</font></td><td>frameworks/base/core/jni/AndroidRuntime.cpp</td></tr><tr><td><font color="#D15FEE">JniInvocation.cpp</font></td><td>libnativehelper/JniInvocation.cpp</td></tr><tr><td><font color="#D15FEE">ZygoteInit.java</font></td><td>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</td></tr><tr><td><font color="#D15FEE">ZygoteServer.java</font></td><td>frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</td></tr></tbody></table><h2 id="Zygoteç®€ä»‹"><a href="#Zygoteç®€ä»‹" class="headerlink" title="Zygoteç®€ä»‹"></a>Zygoteç®€ä»‹</h2><p>åœ¨Androidç³»ç»Ÿä¸­ï¼ŒJavaVM(Javaè™šæ‹Ÿæœº)ã€åº”ç”¨ç¨‹åºè¿›ç¨‹ä»¥åŠè¿è¡Œç³»ç»Ÿçš„å…³é”®æœåŠ¡çš„SystemServerè¿›ç¨‹éƒ½æ˜¯ç”±Zygoteè¿›ç¨‹æ¥åˆ›å»ºçš„ï¼Œæˆ‘ä»¬ä¹Ÿå°†å®ƒç§°ä¸ºå­µåŒ–å™¨ã€‚å®ƒé€šè¿‡fock(å¤åˆ¶è¿›ç¨‹)çš„å½¢å¼æ¥åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹ï¼Œç”±äºZygoteè¿›ç¨‹åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºJavaVMï¼Œå› æ­¤é€šè¿‡fockè€Œåˆ›å»ºçš„åº”ç”¨ç¨‹åºè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹å¯ä»¥åœ¨å†…éƒ¨è·å–ä¸€ä¸ªJavaVMçš„å®ä¾‹æ‹·è´ã€‚</p><h1 id="Read-The-Fucking-Code"><a href="#Read-The-Fucking-Code" class="headerlink" title="Read The Fucking Code"></a>Read The Fucking Code</h1><h2 id="Zygoteè§¦å‘"><a href="#Zygoteè§¦å‘" class="headerlink" title="Zygoteè§¦å‘"></a>Zygoteè§¦å‘</h2><p>åœ¨åˆ†æinitè¿›ç¨‹æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“initè¿›ç¨‹å¯åŠ¨åï¼Œä¼šè§£æinit.rcæ–‡ä»¶ï¼Œç„¶ååˆ›å»ºå’ŒåŠ è½½serviceå­—æ®µæŒ‡å®šçš„è¿›ç¨‹ã€‚zygoteè¿›ç¨‹å°±æ˜¯ä»¥è¿™ç§æ–¹å¼ï¼Œè¢«initè¿›ç¨‹åŠ è½½çš„ã€‚</p><p>åœ¨system/core/rootdir/init.rcçš„å¼€å§‹éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><pre><code>import /init.environ.rcimport /init.usb.rcimport /init.${ro.hardware}.rcimport /vendor/etc/init/hw/init.${ro.hardware}.rcimport /init.usb.configfs.rcimport /init.${ro.zygote}.rc           // ${ro.zygote}ç”±å‚å•†å®šä¹‰ï¼Œä¸å¹³å°ç›¸å…³on early-init    # Set init and its forked children&#39;s oom_adj.    write /proc/1/oom_score_adj -1000</code></pre><h3 id="init-zygoteXX-rc"><a href="#init-zygoteXX-rc" class="headerlink" title="init.zygoteXX.rc"></a>init.zygoteXX.rc</h3><p>ä»ä¹‹å‰åˆ†æçš„initç¯‡ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä¸åŒçš„å¹³å°ï¼ˆ32ã€64åŠ64_32ï¼‰ä¸Šï¼Œinit.rcå°†åŒ…å«ä¸åŒçš„zygote.rcæ–‡ä»¶ã€‚åœ¨system/core/rootdirç›®å½•ä¸‹ï¼Œæœ‰init.zygote32_64.rcã€init.zyote64.rcã€ init.zyote32.rcã€init.zygote64_32.rcã€‚ </p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote32.rc</font>ï¼šzygote è¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯ app_process (çº¯ 32bit æ¨¡å¼)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote64.rc</font>ï¼šzygote è¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯ app_process64 (çº¯ 64bit æ¨¡å¼)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote32_64.rc</font>ï¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ (åä¸º zygote å’Œ zygote_secondary)ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯ app_process32 (ä¸»æ¨¡å¼)ã€app_process64<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ <font color="#87CEFA">init.zygote64_32.rc</font>ï¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ (åä¸º zygote å’Œ zygote_secondary)ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯ app_process64 (ä¸»æ¨¡å¼)ã€app_process32</p><p>ä¸ºä»€ä¹ˆè¦å®šä¹‰è¿™ä¹ˆå¤šç§æƒ…å†µå‘¢ï¼Ÿç›´æ¥å®šä¹‰ä¸€ä¸ªä¸å°±å¥½äº†ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºAndroid 5.0ä»¥åå¼€å§‹æ”¯æŒ64ä½ç¨‹åºï¼Œä¸ºäº†å…¼å®¹32ä½å’Œ64ä½æ‰è¿™æ ·å®šä¹‰ã€‚ä¸åŒçš„zygote.rcå†…å®¹å¤§è‡´ç›¸åŒï¼Œä¸»è¦åŒºåˆ«ä½“ç°åœ¨å¯åŠ¨çš„æ˜¯32ä½ï¼Œè¿˜æ˜¯64ä½çš„è¿›ç¨‹ã€‚init.zygote32_64.rcå’Œinit.zygote64_32.rcä¼šå¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸”å­˜åœ¨ä¸»æ¬¡ä¹‹åˆ†ã€‚</p><p>è¿™é‡Œæ‹¿64ä½å¤„ç†å™¨ä¸ºä¾‹ï¼Œinit.zygote64_32.rcçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>// è¿›ç¨‹åç§°æ˜¯zygote,è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨/system/bin/app_process64// å¯åŠ¨å‚æ•°æ˜¯ -Xzygote /system/bin --zygote --start-system-server --socket-name=zygoteservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote    class main    priority -20    user root    group root readproc    socket zygote stream 660 root system                               // åˆ›å»ºä¸€ä¸ªsocketï¼Œåå­—å«zygoteï¼Œä»¥tcpå½¢å¼    onrestart write /sys/android_power/request_state wake              // onrestart æŒ‡å½“è¿›ç¨‹é‡å¯æ—¶æ‰§è¡Œåé¢çš„å‘½ä»¤    onrestart write /sys/power/state on    onrestart restart audioserver    onrestart restart cameraserver    onrestart restart media    onrestart restart netd    onrestart restart wificond    writepid /dev/cpuset/foreground/tasks                              // åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œå‘ /dev/cpuset/foreground/tasks å†™å…¥pid// å¦ä¸€ä¸ªservice ,åå­— zygote_secondaryservice zygote_secondary /system/bin/app_process32 -Xzygote /system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload    class main    priority -20    user root    group root readproc    socket zygote_secondary stream 660 root system    onrestart restart zygote    writepid /dev/cpuset/foreground/tasks</code></pre><h3 id="start-zygote"><a href="#start-zygote" class="headerlink" title="start zygote"></a>start zygote</h3><p>å®šä¹‰äº†serviceï¼Œè‚¯å®šæœ‰åœ°æ–¹è°ƒç”¨ start zygoteã€‚åœ¨ä¹‹å‰initè§£æçš„åšå®¢ä¸­ï¼Œæˆ‘ä»¬åˆ†æè¿‡initè¿›ç¨‹çš„å¯åŠ¨ã€‚initè¿›ç¨‹å¯åŠ¨çš„æœ€åï¼Œä¼šäº§ç”Ÿâ€late-initâ€äº‹ä»¶ã€‚</p><pre class=" language-C++"><code class="language-C++">    // Don't mount filesystems or start core system services in charger mode.    std::string bootmode = GetProperty("ro.bootmode", "");    if (bootmode == "charger") {        am.QueueEventTrigger("charger");    } else {        am.QueueEventTrigger("late-init");    }</code></pre><p>å¯¹åº”äºinit.rcé…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><pre><code># Mount filesystems and start core system services.on late-init    trigger early-fs    ... ...    # Now we can start zygote for devices with file based encryption    trigger zygote-start                 // è§¦å‘äº†zygote-startäº‹ä»¶åï¼Œå°±ä¼šå¯åŠ¨zygoteè¿›ç¨‹    ... ...</code></pre><p>å¯¹åº”äºinit.rcé…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><pre><code># It is recommended to put unnecessary data/ initialization from post-fs-data# to start-zygote in device&#39;s init.rc to unblock zygote start.on zygote-start &amp;&amp; property:ro.crypto.state=unencrypted    # A/B update verifier that marks a successful boot.    exec_start update_verifier_nonencrypted           start netd                    // startå¯¹åº”çš„æ˜ å°„å…³ç³»å®šä¹‰äºsystem/core/init/builtins.cppä¸­    start zygote                  // è°ƒç”¨startå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¯åŠ¨åä¸ºzygoteçš„æœåŠ¡ï¼ˆä¼ å…¥å‰æ–‡init.zygote.rcä¸­å®šä¹‰çš„å‚æ•°ï¼‰    start zygote_secondaryon zygote-start &amp;&amp; property:ro.crypto.state=unsupported    # A/B update verifier that marks a successful boot.    exec_start update_verifier_nonencrypted    start netd    start zygote    start zygote_secondaryon zygote-start &amp;&amp; property:ro.crypto.state=encrypted &amp;&amp; property:ro.crypto.type=file    # A/B update verifier that marks a successful boot.    exec_start update_verifier_nonencrypted    start netd    start zygote    start zygote_secondary</code></pre><p>startå‘½ä»¤æœ‰ä¸€ä¸ªå¯¹åº”çš„æ‰§è¡Œå‡½æ•°do_startï¼Œå®šä¹‰åœ¨platform/system/core/init/builtins.cppä¸­</p><pre class=" language-C++"><code class="language-C++">const BuiltinFunctionMap::Map& BuiltinFunctionMap::map() const {    constexpr std::size_t kMax = std::numeric_limits<std::size_t>::max();    // clang-format off    static const Map builtin_functions = {        ... ...        {"start",                   {1,     1,    do_start}},        ... ...    };    // clang-format on    return builtin_functions;}</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸‹do_start()ï¼š</p><pre class=" language-C++"><code class="language-C++">static int do_start(const std::vector<std::string>& args) {    Service* svc = ServiceManager::GetInstance().FindServiceByName(args[1]);    // æ‰¾åˆ°zygote serviceå¯¹åº”ä¿¡æ¯    if (!svc) {        LOG(ERROR) << "do_start: Service " << args[1] << " not found";        return -1;    }    if (!svc->Start())         // å¯åŠ¨å¯¹åº”çš„è¿›ç¨‹        return -1;    return 0;}</code></pre><p>do_starté¦–å…ˆæ˜¯é€šè¿‡FindServiceByNameå»serviceæ•°ç»„ä¸­éå†ï¼Œæ ¹æ®åå­—åŒ¹é…å‡ºå¯¹åº”çš„serviceï¼Œç„¶åè°ƒç”¨serviceçš„Startå‡½æ•°ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹service.cppä¸­å®šä¹‰Startå‡½æ•°ï¼š</p><pre class=" language-C++"><code class="language-C++">bool Service::Start() {    ... ...    pid_t pid = -1;    if (namespace_flags_) {        pid = clone(nullptr, nullptr, namespace_flags_ | SIGCHLD, nullptr);    } else {        pid = fork();         // ä»initè¿›ç¨‹ä¸­ï¼Œforkå‡ºzygoteè¿›ç¨‹    }    ... ...}</code></pre><p>Startå‡½æ•°ä¸»è¦æ˜¯forkå‡ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œç„¶åæ‰§è¡Œserviceå¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†å‚æ•°ä¼ é€’è¿›å»ã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬ä»¥init.zygote64.rcä¸ºä¾‹è¿›è¡Œåˆ†æã€‚</p><h2 id="app-process"><a href="#app-process" class="headerlink" title="app_process"></a>app_process</h2><p>ä»ä¸Šé¢æˆ‘ä»¬åˆ†æçš„init.zygote64.rcå¯ä»¥çœ‹å‡ºï¼Œzygote64å¯åŠ¨æ–‡ä»¶çš„åœ°å€ä¸ºapp_process64ã€‚app_process64å¯¹åº”çš„ä»£ç å®šä¹‰åœ¨frameworks/base/cmds/app_processä¸­ï¼Œ </p><p>æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹åº”çš„Android.mkï¼š frameworks/base/cmds/app_process</p><pre class=" language-mk"><code class="language-mk">LOCAL_PATH:= $(call my-dir)... ...app_process_src_files := \    app_main.cpp \... ...LOCAL_MODULE:= app_processLOCAL_MULTILIB := bothLOCAL_MODULE_STEM_32 := app_process32LOCAL_MODULE_STEM_64 := app_process64</code></pre><p>å…¶å®ä¸ç®¡æ˜¯app_processã€app_process32è¿˜æ˜¯app_process64ï¼Œå¯¹åº”çš„æºæ–‡ä»¶éƒ½æ˜¯app_main.cppã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹app_processå¯¹åº”çš„mainå‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äºapp_main.cppä¸­ã€‚</p><p>åœ¨app_main.cppçš„mainå‡½æ•°ä¸­ï¼Œä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯å‚æ•°è§£æ. è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ç§å¯åŠ¨æ¨¡å¼ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä¸€ç§æ˜¯zygoteæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–zygoteè¿›ç¨‹ï¼Œä¼ é€’çš„å‚æ•°æœ‰â€“start-system-server â€“socket-name=zygoteï¼Œå‰è€…è¡¨ç¤ºå¯åŠ¨SystemServerï¼Œåè€…æŒ‡å®šsocketçš„åç§°ï¼ˆZygote64_32ï¼‰ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä¸€ç§æ˜¯applicationæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å¯åŠ¨æ™®é€šåº”ç”¨ç¨‹åºï¼Œä¼ é€’çš„å‚æ•°æœ‰classåå­—ä»¥åŠclasså¸¦çš„å‚æ•°ã€‚</p><p>ä¸¤è€…æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨AppRuntimeå¯¹è±¡çš„startå‡½æ•°ï¼ŒåŠ è½½ZygoteInitæˆ–RuntimeInitä¸¤ä¸ªJavaç±»ï¼Œå¹¶å°†ä¹‹å‰æ•´ç†çš„å‚æ•°ä¼ å…¥è¿›å»ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œæš‚æ—¶åªè®²è§£ZygoteInitçš„åŠ è½½æµç¨‹ã€‚</p><pre class=" language-C++"><code class="language-C++">int main(int argc, char* const argv[]){    // å°†å‚æ•°argvæ”¾åˆ°argv_Stringå­—ç¬¦ä¸²ä¸­ï¼Œç„¶åæ‰“å°å‡ºæ¥    // ä¹‹å‰start zygoteä¼ å…¥çš„å‚æ•°æ˜¯ -Xzygote /system/bin --zygote --start-system-server    if (!LOG_NDEBUG) {      String8 argv_String;      for (int i = 0; i < argc; ++i) {        argv_String.append("\"");        argv_String.append(argv[i]);        argv_String.append("\" ");      }      ALOGV("app_process main with argv: %s", argv_String.string());    }    // AppRuntimeå®šä¹‰äºapp_main.cppä¸­ï¼Œç»§æ‰¿è‡ªAndroidRuntime    // å°±æ˜¯å¯¹Androidè¿è¡Œç¯å¢ƒçš„ä¸€ç§æŠ½è±¡ï¼Œç±»ä¼¼äºjavaè™šæ‹Ÿæœºå¯¹Javaç¨‹åºçš„ä½œç”¨    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));    // Process command line arguments    // ignore argv[0]    argc--;    argv++;    // è¿™ä¸¤ä¸ªå‚æ•°æ˜¯Javaç¨‹åºéœ€è¦ä¾èµ–çš„JaråŒ…ï¼Œç›¸å½“äºimport    const char* spaced_commands[] = { "-cp", "-classpath" };    // Allow "spaced commands" to be succeeded by exactly 1 argument (regardless of -s).    bool known_command = false;    int i;    // æ‰¾åˆ°è§£æå‚æ•°çš„èµ·ç‚¹    for (i = 0; i < argc; i++) {        // å°†spaced_commandsä¸­çš„å‚æ•°é¢å¤–åŠ å…¥VM        if (known_command == true) {          runtime.addOption(strdup(argv[i]));          // The static analyzer gets upset that we don't ever free the above          // string. Since the allocation is from main, leaking it doesn't seem          // problematic. NOLINTNEXTLINE          ALOGV("app_process main add known option '%s'", argv[i]);          known_command = false;          continue;        }        for (int j = 0;             j < static_cast<int>(sizeof(spaced_commands) / sizeof(spaced_commands[0]));             ++j) {            // æ¯”è¾ƒå‚æ•°æ˜¯å¦æ˜¯spaced_commandsä¸­çš„å‚æ•°          if (strcmp(argv[i], spaced_commands[j]) == 0) {            known_command = true;            ALOGV("app_process main found known command '%s'", argv[i]);          }        }        // å¦‚æœå‚æ•°ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯'-'ï¼Œç›´æ¥è·³å‡ºå¾ªç¯ï¼Œä¹‹å‰ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ -Xzygoteï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°è¿™å„¿å°±è·³å‡ºäº†        if (argv[i][0] != '-') {            break;        }        if (argv[i][1] == '-' && argv[i][2] == 0) {            ++i; // Skip --.            break;        }        runtime.addOption(strdup(argv[i]));        // The static analyzer gets upset that we don't ever free the above        // string. Since the allocation is from main, leaking it doesn't seem        // problematic. NOLINTNEXTLINE        ALOGV("app_process main add option '%s'", argv[i]);    }    // Parse runtime arguments.  Stop at first unrecognized option.    // ä»è¿™é‡Œå…¶å®å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡app_mainå¯ä»¥å¯åŠ¨zygoteã€system-serveråŠæ™®é€šapkè¿›ç¨‹    // è¿™ä¸ªå¯ä»¥é€šè¿‡init.rcæ¥é…ç½®    bool zygote = false;    bool startSystemServer = false;    bool application = false;    String8 niceName;                              // app_processçš„åç§°æ”¹ä¸ºzygote    String8 className;                             // å¯åŠ¨apkè¿›ç¨‹æ—¶ï¼Œå¯¹åº”çš„ç±»å    ++i;  // Skip unused "parent dir" argument.    // è·³è¿‡ä¸€ä¸ªå‚æ•°ï¼Œä¹‹å‰è·³è¿‡äº†-Xzygoteï¼Œè¿™é‡Œç»§ç»­è·³è¿‡ /system/bin ,ä¹Ÿå°±æ˜¯æ‰€è°“çš„ "parent dir"    while (i < argc) {                             // å¼€å§‹è§£æè¾“å…¥å‚æ•°        const char* arg = argv[i++];        if (strcmp(arg, "--zygote") == 0) {        // è¡¨ç¤ºæ˜¯zygoteå¯åŠ¨æ¨¡å¼            zygote = true;            niceName = ZYGOTE_NICE_NAME;           // è¿™ä¸ªå€¼æ ¹æ®å¹³å°å¯èƒ½æ˜¯zygote64æˆ–zygote        } else if (strcmp(arg, "--start-system-server") == 0) {            startSystemServer = true;              // init.zygote.rcä¸­å®šä¹‰äº†è¯¥å­—æ®µï¼Œå¯åŠ¨zygoteåä¼šå¯åŠ¨system-server        } else if (strcmp(arg, "--application") == 0) {            application = true;                    // è¡¨ç¤ºæ˜¯applicationå¯åŠ¨æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ™®é€šåº”ç”¨ç¨‹åº        } else if (strncmp(arg, "--nice-name=", 12) == 0) {            niceName.setTo(arg + 12);              // è¿›ç¨‹åˆ«åï¼Œå¯ä»¥è‡ªå·±æŒ‡å®šè¿›ç¨‹å        } else if (strncmp(arg, "--", 2) != 0) {            className.setTo(arg);                  // ä¸--applicationé…ç½®ï¼Œå¯åŠ¨æŒ‡å®šçš„ç±»ï¼Œapplicationå¯åŠ¨çš„class            break;        } else {            --i;            break;        }    }    // å‡†å¤‡å‚æ•°    Vector<String8> args;    if (!className.isEmpty()) {                    // classNameä¸ä¸ºç©ºï¼Œè¯´æ˜æ˜¯applicationå¯åŠ¨æ¨¡å¼        // We're not in zygote mode, the only argument we need to pass        // to RuntimeInit is the application argument.        //        // The Remainder of args get passed to startup class main(). Make        // copies of them before we overwrite them with the process name.        args.add(application ? String8("application") : String8("tool"));        runtime.setClassNameAndArgs(className, argc - i, argv + i);    // å°†classNameå’Œå‚æ•°è®¾ç½®ç»™runtime        ... ...    } else {                                       // zygoteå¯åŠ¨æ¨¡å¼        // We're in zygote mode.        maybeCreateDalvikCache();                  // åˆ›å»ºDalvikçš„ç¼“å­˜ç›®å½•å¹¶å®šä¹‰æƒé™        if (startSystemServer) {                   // å¢åŠ start-system-serverå‚æ•°ï¼Œé»˜è®¤å¯åŠ¨zygoteåï¼Œå°±ä¼šå¯åŠ¨system_server            args.add(String8("start-system-server"));        }        char prop[PROP_VALUE_MAX];                 // è·å–å¹³å°å¯¹åº”çš„abiä¿¡æ¯        if (property_get(ABI_LIST_PROPERTY, prop, NULL) == 0) {            LOG_ALWAYS_FATAL("app_process: Unable to determine ABI list from property %s.",                ABI_LIST_PROPERTY);            return 11;        }        String8 abiFlag("--abi-list=");            // å‚æ•°éœ€è¦åˆ¶å®šabi        abiFlag.append(prop);        args.add(abiFlag);                         // åŠ å…¥--abi-list=å‚æ•°        // In zygote mode, pass all remaining arguments to the zygote        // main() method.        for (; i < argc; ++i) {            args.add(String8(argv[i]));            // å°†å‰©ä¸‹çš„å‚æ•°åŠ å…¥args        }    }    if (!niceName.isEmpty()) {                     // å°†app_processçš„è¿›ç¨‹åï¼Œæ›¿æ¢ä¸ºniceName        runtime.setArgv0(niceName.string(), true /* setProcName */);    }    if (zygote) {                                  // è°ƒç”¨Runtimeçš„startå‡½æ•°, å¯åŠ¨ZygoteInit        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);    } else if (className) {                        // å¯åŠ¨zygoteæ²¡æœ‰è¿›å…¥è¿™ä¸ªåˆ†æ”¯        // ä½†è¿™ä¸ªåˆ†æ”¯è¯´æ˜ï¼Œé€šè¿‡é…ç½®init.rcæ–‡ä»¶ï¼Œå…¶å®æ˜¯å¯ä»¥ä¸é€šè¿‡zygoteæ¥å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹        // å¦‚æœæ˜¯applicationå¯åŠ¨æ¨¡å¼ï¼Œåˆ™åŠ è½½RuntimeInit        runtime.start("com.android.internal.os.RuntimeInit", args, zygote);    } else {        // erroræƒ…å†µ        fprintf(stderr, "Error: no class name or --zygote supplied.\n");        app_usage();        LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");    }}</code></pre><h2 id="AndroidRuntime"><a href="#AndroidRuntime" class="headerlink" title="AndroidRuntime"></a>AndroidRuntime</h2><p>ç”±äºAppRuntimeç»§æ‰¿è‡ªAndroidRuntimeï¼Œä¸”æ²¡æœ‰é‡å†™startæ–¹æ³•ï¼Œå› æ­¤zygoteçš„æµç¨‹è¿›å…¥åˆ°äº†AndroidRuntime.cppã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹AndroidRuntimeçš„startå‡½æ•°çš„æµç¨‹ã€‚</p><h3 id="åˆ›å»ºJavaè™šæ‹Ÿæœº"><a href="#åˆ›å»ºJavaè™šæ‹Ÿæœº" class="headerlink" title="åˆ›å»ºJavaè™šæ‹Ÿæœº"></a>åˆ›å»ºJavaè™šæ‹Ÿæœº</h3><pre class=" language-C++"><code class="language-C++">/* * Start the Android runtime.  This involves starting the virtual machine * and calling the "static void main(String[] args)" method in the class * named by "className". * * Passes the main function two arguments, the class name and the specified * options string. */void AndroidRuntime::start(const char* className, const Vector<String8>& options, bool zygote){    ... ...                                   // æ‰“å°ä¸€äº›æ—¥å¿—ï¼Œè·å–ANDROID_ROOTç¯å¢ƒå˜é‡    /* start the virtual machine */    JniInvocation jni_invocation;    jni_invocation.Init(NULL);                // åˆå§‹åŒ–JNI,åŠ è½½libart.so    JNIEnv* env;    // åˆ›å»ºè™šæ‹Ÿæœºï¼Œå…¶ä¸­å¤§å¤šæ•°å‚æ•°ç”±ç³»ç»Ÿå±æ€§å†³å®š    // æœ€ç»ˆï¼ŒstartVmåˆ©ç”¨JNI_CreateJavaVMåˆ›å»ºå‡ºè™šæ‹Ÿæœº    if (startVm(&mJavaVM, &env, zygote) != 0) {        return;    }    // å›è°ƒAppRuntimeçš„onVmCreatedå‡½æ•°    // å¯¹äºzygoteè¿›ç¨‹çš„å¯åŠ¨æµç¨‹è€Œè¨€ï¼Œæ— å®é™…æ“ä½œï¼Œè¡¨ç¤ºè™šæ‹Ÿåˆ›å»ºå®Œæˆï¼Œä½†æ˜¯é‡Œé¢æ˜¯ç©ºå®ç°    onVmCreated(env);    ... ...}</code></pre><p>è¿™è¾¹æˆ‘ä»¬è·Ÿä¸€ä¸‹jni_invocation.Init()ï¼šlibnativehelper/JniInvocation.cpp</p><p>Initå‡½æ•°ä¸»è¦ä½œç”¨æ˜¯åˆå§‹åŒ–JNIï¼Œå…·ä½“å·¥ä½œæ˜¯é¦–å…ˆé€šè¿‡dlopenåŠ è½½libart.soè·å¾—å…¶å¥æŸ„ï¼Œç„¶åè°ƒç”¨dlsymä»libart.soä¸­æ‰¾åˆ°JNI_GetDefaultJavaVMInitArgsã€JNI_CreateJavaVMã€JNI_GetCreatedJavaVMsä¸‰ä¸ªå‡½æ•°åœ°å€ï¼Œèµ‹å€¼ç»™å¯¹åº”æˆå‘˜å±æ€§ï¼Œè¿™ä¸‰ä¸ªå‡½æ•°ä¼šåœ¨åç»­è™šæ‹Ÿæœºåˆ›å»ºä¸­è°ƒç”¨ã€‚</p><pre class=" language-C++"><code class="language-C++">bool JniInvocation::Init(const char* library) {#ifdef __ANDROID__  char buffer[PROP_VALUE_MAX];#else  char* buffer = NULL;#endif  library = GetLibrary(library, buffer);              // é»˜è®¤è¿”å› libart.so  // Load with RTLD_NODELETE in order to ensure that libart.so is not unmapped when it is closed.  // This is due to the fact that it is possible that some threads might have yet to finish  // exiting even after JNI_DeleteJavaVM returns, which can lead to segfaults if the library is  // unloaded.  const int kDlopenFlags = RTLD_NOW | RTLD_NODELETE;  /*   * 1.dlopenåŠŸèƒ½æ˜¯ä»¥æŒ‡å®šæ¨¡å¼æ‰“å¼€æŒ‡å®šçš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¥æŸ„   * 2.RTLD_NOWè¡¨ç¤ºéœ€è¦åœ¨dlopenè¿”å›å‰ï¼Œè§£æå‡ºæ‰€æœ‰æœªå®šä¹‰ç¬¦å·ï¼Œå¦‚æœè§£æä¸å‡ºæ¥ï¼Œåœ¨dlopenä¼šè¿”å›NULL   * 3.RTLD_NODELETEè¡¨ç¤ºåœ¨dlclose()æœŸé—´ä¸å¸è½½åº“ï¼Œå¹¶ä¸”åœ¨ä»¥åä½¿ç”¨dlopen()é‡æ–°åŠ è½½åº“æ—¶ä¸åˆå§‹åŒ–åº“ä¸­çš„é™æ€å˜é‡   */  handle_ = dlopen(library, kDlopenFlags);            // è·å–libart.soçš„å¥æŸ„  if (handle_ == NULL) {                              // è·å–å¤±è´¥æ‰“å°é”™è¯¯æ—¥å¿—å¹¶å°è¯•å†æ¬¡æ‰“å¼€libart.so    if (strcmp(library, kLibraryFallback) == 0) {      // Nothing else to try.      ALOGE("Failed to dlopen %s: %s", library, dlerror());      return false;    }    // Note that this is enough to get something like the zygote    // running, we can't property_set here to fix this for the future    // because we are root and not the system user. See    // RuntimeInit.commonInit for where we fix up the property to    // avoid future fallbacks. http://b/11463182    ALOGW("Falling back from %s to %s after dlopen error: %s",          library, kLibraryFallback, dlerror());    library = kLibraryFallback;    handle_ = dlopen(library, kDlopenFlags);    if (handle_ == NULL) {      ALOGE("Failed to dlopen %s: %s", library, dlerror());      return false;    }  }  /*   * 1.FindSymbolå‡½æ•°å†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯dlsym   * 2.dlsymä½œç”¨æ˜¯æ ¹æ® åŠ¨æ€é“¾æ¥åº“ æ“ä½œå¥æŸ„(handle)ä¸ç¬¦å·(symbol)ï¼Œè¿”å›ç¬¦å·å¯¹åº”çš„åœ°å€   * 3.è¿™é‡Œå®é™…å°±æ˜¯ä»libart.soä¸­å°†JNI_GetDefaultJavaVMInitArgsç­‰å¯¹åº”çš„åœ°å€å­˜å…¥&JNI_GetDefaultJavaVMInitArgs_ä¸­   */  if (!FindSymbol(reinterpret_cast<void**>(&JNI_GetDefaultJavaVMInitArgs_),                  "JNI_GetDefaultJavaVMInitArgs")) {    return false;  }  if (!FindSymbol(reinterpret_cast<void**>(&JNI_CreateJavaVM_),                  "JNI_CreateJavaVM")) {    return false;  }  if (!FindSymbol(reinterpret_cast<void**>(&JNI_GetCreatedJavaVMs_),                  "JNI_GetCreatedJavaVMs")) {    return false;  }  return true;}</code></pre><p>å…¶æ¬¡ï¼Œæˆ‘ä»¬å†è·Ÿä¸€ä¸‹startVm()ï¼š</p><p>è¿™ä¸ªå‡½æ•°ç‰¹åˆ«é•¿ï¼Œä½†æ˜¯é‡Œé¢åšçš„äº‹æƒ…å¾ˆå•ä¸€ï¼Œå…¶å®å°±æ˜¯ä»å„ç§ç³»ç»Ÿå±æ€§ä¸­è¯»å–ä¸€äº›å‚æ•°ï¼Œç„¶åé€šè¿‡addOptionè®¾ç½®åˆ°AndroidRuntimeçš„mOptionsæ•°ç»„ä¸­å­˜èµ·æ¥ï¼Œå¦å¤–å°±æ˜¯è°ƒç”¨ä¹‹å‰ä»libart.soä¸­æ‰¾åˆ°JNI_CreateJavaVMå‡½æ•°ï¼Œå¹¶å°†è¿™äº›å‚æ•°ä¼ å…¥ï¼Œç”±äºæœ¬ç¯‡ä¸»è¦è®²zygoteå¯åŠ¨æµç¨‹ï¼Œå› æ­¤å…³äºè™šæ‹Ÿæœºçš„å®ç°å°±ä¸æ·±å…¥æ¢ç©¶äº†ã€‚</p><pre class=" language-C++"><code class="language-C++">int AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, bool zygote){    JavaVMInitArgs initArgs;    char propBuf[PROPERTY_VALUE_MAX];    char stackTraceFileBuf[sizeof("-Xstacktracefile:")-1 + PROPERTY_VALUE_MAX];    char jniOptsBuf[sizeof("-Xjniopts:")-1 + PROPERTY_VALUE_MAX];    ... ...    /* route exit() to our handler */    addOption("exit", (void*) runtime_exit);                                    // å°†å‚æ•°æ”¾å…¥mOptionsæ•°ç»„ä¸­    ... ...    initArgs.version = JNI_VERSION_1_4;    initArgs.options = mOptions.editArray();                                    // å°†mOptionsèµ‹å€¼ç»™initArgs    initArgs.nOptions = mOptions.size();    initArgs.ignoreUnrecognized = JNI_FALSE;    /*     * Initialize the VM.     *     * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread.     * If this call succeeds, the VM is ready, and we can start issuing     * JNI calls.     */    if (JNI_CreateJavaVM(pJavaVM, pEnv, &initArgs) < 0) {                       // è°ƒç”¨libart.soçš„JNI_CreateJavaVMå‡½æ•°        ALOGE("JNI_CreateJavaVM failed\n");        return -1;    }    return 0;}</code></pre><h3 id="æ³¨å†ŒJNIå‡½æ•°"><a href="#æ³¨å†ŒJNIå‡½æ•°" class="headerlink" title="æ³¨å†ŒJNIå‡½æ•°"></a>æ³¨å†ŒJNIå‡½æ•°</h3><p>æˆ‘ä»¬å›åˆ°AndroidRuntimeçš„startå‡½æ•°ã€‚åˆå§‹åŒ–JVMåï¼Œæ¥ä¸‹æ¥å°±ä¼šè°ƒç”¨startRegå‡½æ•°ã€‚</p><pre class=" language-C++"><code class="language-C++">void AndroidRuntime::start(const char* className, const Vector<String8>& options, bool zygote){    ... ...    /* 01. åˆ›å»ºJavaè™šæ‹Ÿæœº*/    /*     * Register android functions.     */    if (startReg(env) < 0) {         // æ³¨å†ŒJNIå‡½æ•°        ALOGE("Unable to register all android natives\n");        return;    }    ... ...}</code></pre><p>startRegé¦–å…ˆæ˜¯è®¾ç½®äº†Androidåˆ›å»ºçº¿ç¨‹çš„å¤„ç†å‡½æ•°ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª200å®¹é‡çš„å±€éƒ¨å¼•ç”¨ä½œç”¨åŸŸï¼Œç”¨äºç¡®ä¿ä¸ä¼šå‡ºç°OutOfMemoryExceptionï¼Œæœ€åå°±æ˜¯è°ƒç”¨register_jni_procsè¿›è¡ŒJNIæ³¨å†Œã€‚</p><p>æˆ‘ä»¬è·Ÿè¿›startReg()ï¼š</p><pre class=" language-C++"><code class="language-C++">/* * Register android native functions with the VM. *//*static*/ int AndroidRuntime::startReg(JNIEnv* env){    ATRACE_NAME("RegisterAndroidNatives");    /*     * This hook causes all future threads created in this process to be     * attached to the JavaVM.  (This needs to go away in favor of JNI     * Attach calls.)     */    // å®šä¹‰Androidåˆ›å»ºçº¿ç¨‹çš„funcï¼šjavaCreateThreadEtcï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨æ˜¯é€šè¿‡Linuxçš„cloneæ¥åˆ›å»ºçº¿ç¨‹çš„    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);           ALOGV("--- registering native functions ---\n");    /*     * Every "register" function calls one or more things that return     * a local reference (e.g. FindClass).  Because we haven't really     * started the VM yet, they're all getting stored in the base frame     * and never released.  Use Push/Pop to manage the storage.     */    env->PushLocalFrame(200);        // åˆ›å»ºä¸€ä¸ª200å®¹é‡çš„å±€éƒ¨å¼•ç”¨ä½œç”¨åŸŸ,è¿™ä¸ªå±€éƒ¨å¼•ç”¨å…¶å®å°±æ˜¯å±€éƒ¨å˜é‡    if (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) < 0) {       // æ³¨å†ŒJNIå‡½æ•°        env->PopLocalFrame(NULL);        return -1;    }    env->PopLocalFrame(NULL);                                         // é‡Šæ”¾å±€éƒ¨å¼•ç”¨ä½œç”¨åŸŸ    //createJavaThread("fubar", quickTest, (void*) "hello");    return 0;}</code></pre><p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒstartRegå‡½æ•°ä¸­ä¸»è¦æ˜¯é€šè¿‡register_jni_procsæ¥æ³¨å†ŒJNIå‡½æ•°ã€‚å…¶ä¸­ï¼ŒgRegJNIæ˜¯ä¸€ä¸ªå…¨å±€æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class=" language-C++"><code class="language-C++">static const RegJNIRec gRegJNI[] = {                                  // é‡Œé¢å°±æ˜¯ä¸€å †çš„å‡½æ•°æŒ‡é’ˆ    REG_JNI(register_com_android_internal_os_RuntimeInit),    REG_JNI(register_com_android_internal_os_ZygoteInit_nativeZygoteInit),    REG_JNI(register_android_os_SystemClock),    REG_JNI(register_android_util_EventLog),    REG_JNI(register_android_util_Log),    ... ...};</code></pre><p>æˆ‘ä»¬æŒ‘ä¸€ä¸ªregister_com_android_internal_os_ZygoteInit_nativeZygoteInitï¼Œè¿™å®é™…ä¸Šæ˜¯è‡ªå®šä¹‰JNIå‡½æ•°å¹¶è¿›è¡ŒåŠ¨æ€æ³¨å†Œçš„æ ‡å‡†å†™æ³•,<br>å†…éƒ¨æ˜¯è°ƒç”¨JNIçš„RegisterNativesï¼Œè¿™æ ·æ³¨å†Œåï¼ŒJavaç±»ZygoteInitçš„nativeæ–¹æ³•nativeZygoteInitå°±ä¼šè°ƒç”¨com_android_internal_os_ZygoteInit_nativeZygoteInitå‡½æ•°ã€‚</p><pre class=" language-C++"><code class="language-C++">int register_com_android_internal_os_ZygoteInit_nativeZygoteInit(JNIEnv* env){    const JNINativeMethod methods[] = {        { "nativeZygoteInit", "()V",            (void*) com_android_internal_os_ZygoteInit_nativeZygoteInit },    };    return jniRegisterNativeMethods(env, "com/android/internal/os/ZygoteInit",        methods, NELEM(methods));}</code></pre><p>REG_JNIå¯¹åº”çš„å®å®šä¹‰åŠRegJNIRecç»“æ„ä½“çš„å®šä¹‰ä¸ºï¼š</p><pre class=" language-C++"><code class="language-C++">#ifdef NDEBUG    #define REG_JNI(name)      { name }    struct RegJNIRec {        int (*mProc)(JNIEnv*);    };#else    #define REG_JNI(name)      { name, #name }    struct RegJNIRec {        int (*mProc)(JNIEnv*);        const char* mName;    };#endif</code></pre><p>æ ¹æ®å®å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œå®REG_JNIå°†å¾—åˆ°å‡½æ•°åï¼›å®šä¹‰RegJNIRecæ•°ç»„æ—¶ï¼Œå‡½æ•°åè¢«èµ‹å€¼ç»™RegJNIRecç»“æ„ä½“ï¼Œäºæ˜¯æ¯ä¸ªå‡½æ•°åè¢«å¼ºè¡Œè½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆã€‚<br>å› æ­¤ï¼Œregister_jni_procsçš„å‚æ•°å°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„å¤§å°å’ŒJNIEnvã€‚</p><p>æˆ‘ä»¬æ¥è·Ÿè¿›ä¸€ä¸‹register_jni_procså‡½æ•°ï¼š</p><pre class=" language-C++"><code class="language-C++">static int register_jni_procs(const RegJNIRec array[], size_t count, JNIEnv* env){    for (size_t i = 0; i < count; i++) {        if (array[i].mProc(env) < 0) {              // è°ƒç”¨mProc#ifndef NDEBUG            ALOGD("----------!!! %s failed to load\n", array[i].mName);#endif            return -1;        }    }    return 0;}</code></pre><p>ç»“åˆå‰é¢çš„åˆ†æï¼Œå®¹æ˜“çŸ¥é“register_jni_procså‡½æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨å‡½æ•°æŒ‡é’ˆï¼ˆmProcï¼‰å¯¹åº”çš„å‡½æ•°ï¼Œä»¥è¿›è¡Œå®é™…çš„JNIå‡½æ•°æ³¨å†Œã€‚</p><h3 id="åå°„å¯åŠ¨ZygoteInit"><a href="#åå°„å¯åŠ¨ZygoteInit" class="headerlink" title="åå°„å¯åŠ¨ZygoteInit"></a>åå°„å¯åŠ¨ZygoteInit</h3><p>ç»§ç»­åˆ†æAndroidRuntime.cppçš„startå‡½æ•°ï¼š</p><pre class=" language-C++"><code class="language-C++">void AndroidRuntime::start(const char* className, const Vector<String8>& options, bool zygote){    ... ...    /* 01. åˆ›å»ºJavaè™šæ‹Ÿæœº*/    /* 02. æ³¨å†ŒJNIå‡½æ•° */    /*     * Start VM.  This thread becomes the main thread of the VM, and will     * not return until the VM exits.     */    // æ›¿æ¢stringä¸ºå®é™…è·¯å¾„    // ä¾‹å¦‚ï¼šå°† "com.android.internal.os.ZygoteInit" æ›¿æ¢ä¸º "com/android/internal/os/ZygoteInit"    char* slashClassName = toSlashClassName(className != NULL ? className : "");    jclass startClass = env->FindClass(slashClassName);                    // æ‰¾åˆ°classæ–‡ä»¶    if (startClass == NULL) {        ALOGE("JavaVM unable to locate class '%s'\n", slashClassName);        /* keep going */    } else {        jmethodID startMeth = env->GetStaticMethodID(startClass, "main",            "([Ljava/lang/String;)V");                                     // é€šè¿‡åå°„æ‰¾åˆ°ZygoteInitçš„mainå‡½æ•°        if (startMeth == NULL) {            ALOGE("JavaVM unable to find main() in '%s'\n", className);            /* keep going */        } else {            env->CallStaticVoidMethod(startClass, startMeth, strArray);    // è°ƒç”¨ZygoteInitçš„mainå‡½æ•°            ... ...        }    }    free(slashClassName);    ALOGD("Shutting down VM\n");    if (mJavaVM->DetachCurrentThread() != JNI_OK)                          // é€€å‡ºå½“å‰çº¿ç¨‹        ALOGW("Warning: unable to detach main thread\n");    if (mJavaVM->DestroyJavaVM() != 0)                                     // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹ç»“æŸåå…³é—­è™šæ‹Ÿæœº        ALOGW("Warning: VM did not shut down cleanly\n");}</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨AndroidRuntimeçš„æœ€åï¼Œå°†é€šè¿‡åå°„è°ƒç”¨ZygoteInitçš„mainå‡½æ•°ã€‚è‡³æ­¤ï¼Œ<strong><font color="#87CEFA">zygoteè¿›ç¨‹è¿›å…¥äº†javaä¸–ç•Œ</font></strong>ã€‚ </p><p>å…¶å®æˆ‘ä»¬ä»”ç»†æƒ³ä¸€æƒ³ï¼Œå°±ä¼šè§‰å¾—zygoteçš„æ•´ä¸ªæµç¨‹å®é™…ä¸Šæ˜¯éå¸¸ç¬¦åˆå®é™…æƒ…å†µçš„ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;âœ¨âœ¨ åœ¨Androidä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¿è¡Œåœ¨å¯¹åº”çš„è™šæ‹Ÿæœºä¸Šï¼Œå› æ­¤zygoteé¦–å…ˆå°±è´Ÿè´£åˆ›å»ºå‡ºè™šæ‹Ÿæœºã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;âœ¨âœ¨ ç„¶åï¼Œä¸ºäº†åå°„è°ƒç”¨javaä»£ç ï¼Œå¿…é¡»æœ‰å¯¹åº”çš„JNIå‡½æ•°ï¼Œäºæ˜¯zygoteè¿›è¡Œäº†JNIå‡½æ•°çš„æ³¨å†Œã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;âœ¨âœ¨ å½“ä¸€åˆ‡å‡†å¤‡å¦¥å½“åï¼Œzygoteè¿›ç¨‹æ‰è¿›å…¥åˆ°äº†javaä¸–ç•Œã€‚</p><h2 id="ZygoteInit"><a href="#ZygoteInit" class="headerlink" title="ZygoteInit"></a>ZygoteInit</h2><p>ç°åœ¨æˆ‘ä»¬è·Ÿè¿›ZygoteInit.javaçš„mainå‡½æ•°ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//åˆ›å»ºZygoteServerå¯¹è±¡</span>        ZygoteServer zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token comment" spellcheck="true">// Mark zygote start. This ensures that thread creation will throw</span>        <span class="token comment" spellcheck="true">// an error.</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨nativeå‡½æ•°ï¼Œç¡®ä¿å½“å‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹åœ¨è¿è¡Œ</span>        <span class="token comment" spellcheck="true">// ä¸»è¦è¿˜æ˜¯å¤„äºå®‰å…¨çš„è€ƒè™‘</span>        ZygoteHooks<span class="token punctuation">.</span><span class="token function">startZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Zygote goes into its own process group.</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Os<span class="token punctuation">.</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to setpgid(0,0)"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> Runnable caller<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            RuntimeInit<span class="token punctuation">.</span><span class="token function">enableDdms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            String socketName <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span>            String abiList <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">boolean</span> enableLazyPreload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// è§£æå‚æ•°ï¼Œå¾—åˆ°ä¸Šè¿°å˜é‡çš„å€¼</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"--enable-lazy-preload"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    enableLazyPreload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    abiList <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    socketName <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unknown command line argument: "</span> <span class="token operator">+</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>abiList <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No ABI list supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            zygoteServer<span class="token punctuation">.</span><span class="token function">registerServerSocket</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ³¨å†Œserver socket</span>            <span class="token comment" spellcheck="true">// In some configurations, we avoid preloading resources and classes eagerly.</span>            <span class="token comment" spellcheck="true">// In such cases, we will preload things prior to our first fork.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableLazyPreload<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token function">preload</span><span class="token punctuation">(</span>bootTimingsTraceLog<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// é»˜è®¤æƒ…å†µï¼Œé¢„åŠ è½½ä¿¡æ¯</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æ³¨é‡Šï¼Œå»¶è¿Ÿé¢„åŠ è½½</span>            <span class="token comment" spellcheck="true">// å˜æ›´Zygoteè¿›ç¨‹ä¼˜å…ˆçº§ä¸ºNORMALçº§åˆ«</span>            <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡forkæ—¶æ‰ä¼špreload</span>                Zygote<span class="token punctuation">.</span><span class="token function">resetNicePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Do an initial gc to clean up after startup</span>            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"PostZygoteInitGC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">gcAndFinalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment" spellcheck="true">// å¦‚æœé¢„åŠ è½½äº†ï¼Œå¾ˆæœ‰å¿…è¦GCä¸€æ³¢</span>            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// PostZygoteInitGC</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// Zygote process unmounts root storage spaces.</span>            Zygote<span class="token punctuation">.</span><span class="token function">nativeUnmountStorageOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Set seccomp policy</span>            <span class="token comment" spellcheck="true">// åŠ è½½seccompçš„è¿‡æ»¤è§„åˆ™</span>            <span class="token comment" spellcheck="true">// æ‰€æœ‰ Android è½¯ä»¶éƒ½ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼ˆç®€ç§°ä¸º syscallï¼‰ä¸ Linux å†…æ ¸è¿›è¡Œé€šä¿¡</span>            <span class="token comment" spellcheck="true">// å†…æ ¸æä¾›è®¸å¤šç‰¹å®šäºè®¾å¤‡å’ŒSOCçš„ç³»ç»Ÿè°ƒç”¨ï¼Œè®©ç”¨æˆ·ç©ºé—´è¿›ç¨‹ï¼ˆåŒ…æ‹¬åº”ç”¨ï¼‰å¯ä»¥ç›´æ¥ä¸å†…æ ¸è¿›è¡Œäº¤äº’</span>            <span class="token comment" spellcheck="true">// ä¸è¿‡ï¼Œå…¶ä¸­è®¸å¤šç³»ç»Ÿè°ƒç”¨Androidæœªäºˆä½¿ç”¨æˆ–æœªäºˆæ­£å¼æ”¯æŒ</span>            <span class="token comment" spellcheck="true">// é€šè¿‡seccompï¼ŒAndroidå¯ä½¿åº”ç”¨è½¯ä»¶æ— æ³•è®¿é—®æœªä½¿ç”¨çš„å†…æ ¸ç³»ç»Ÿè°ƒç”¨</span>            <span class="token comment" spellcheck="true">// ç”±äºåº”ç”¨æ— æ³•è®¿é—®è¿™äº›ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤ï¼Œå®ƒä»¬ä¸ä¼šè¢«æ½œåœ¨çš„æœ‰å®³åº”ç”¨åˆ©ç”¨</span>            <span class="token comment" spellcheck="true">// è¯¥è¿‡æ»¤å™¨å®‰è£…åˆ°zygoteè¿›ç¨‹ä¸­ï¼Œç”±äºæ‰€æœ‰Androidåº”ç”¨å‡è¡ç”Ÿè‡ªè¯¥è¿›ç¨‹</span>            <span class="token comment" spellcheck="true">// å› è€Œä¼šå½±å“åˆ°æ‰€æœ‰åº”ç”¨</span>            Seccomp<span class="token punctuation">.</span><span class="token function">setPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/// M: Added for BOOTPROF</span>            <span class="token function">addBootEvent</span><span class="token punctuation">(</span><span class="token string">"Zygote:Preload End"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/// @}</span>            ZygoteHooks<span class="token punctuation">.</span><span class="token function">stopZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// å…è®¸æœ‰å…¶å®ƒçº¿ç¨‹äº†</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Runnable r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> socketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// forkå‡ºsystem server</span>                <span class="token comment" spellcheck="true">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>                <span class="token comment" spellcheck="true">// child (system_server) process.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// The select loop returns early in the child process after a fork and</span>            <span class="token comment" spellcheck="true">// loops forever in the zygote.</span>            caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// zygoteè¿›ç¨‹è¿›å…¥æ— é™å¾ªç¯ï¼Œå¤„ç†è¯·æ±‚</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// We're in the child process and have exited the select loop. Proceed to execute the</span>        <span class="token comment" spellcheck="true">// command.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            caller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>ä¸Šé¢æ˜¯ZygoteInitçš„mainå‡½æ•°çš„ä¸»å¹²éƒ¨åˆ†ï¼Œé™¤äº†å®‰å…¨ç›¸å…³çš„å†…å®¹å¤–ï¼Œæœ€ä¸»è¦çš„å·¥ä½œå°±æ˜¯æ³¨å†Œserver socketã€é¢„åŠ è½½ã€å¯åŠ¨system serveråŠè¿›å…¥æ— é™å¾ªç¯å¤„ç†è¯·æ±‚æ¶ˆæ¯ã€‚ </p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†å››éƒ¨åˆ†åˆ†åˆ«è®¨è®ºï¼</p><h3 id="åˆ›å»ºserver-socket"><a href="#åˆ›å»ºserver-socket" class="headerlink" title="åˆ›å»ºserver socket"></a>åˆ›å»ºserver socket</h3><p>Android Oå°†server socketç›¸å…³çš„å·¥ä½œæŠ½è±¡åˆ°ZygoteServer.javaä¸­äº†ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å…¶ä¸­çš„registerZygoteSocketå‡½æ•°ï¼š</p><pre class=" language-C++"><code class="language-C++">    /**     * Registers a server socket for zygote command connections     *     * @throws RuntimeException when open fails     */    void registerServerSocket(String socketName) {        if (mServerSocket == null) {            int fileDesc;            // ANDROID_SOCKET_PREFIXä¸º"ANDROID_SOCKET_"            // æ­¤å¤„çš„socket nameï¼Œå°±æ˜¯zygote            final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;            try {                // è¿˜è®°å¾—ä¹ˆï¼Ÿåœ¨init.zygote.rcè¢«åŠ è½½æ—¶ï¼ŒæŒ‡å®šäº†åä¸ºzygoteçš„socket                // åœ¨è¿›ç¨‹è¢«åˆ›å»ºæ—¶ï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶åŠ å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­                // å› æ­¤ï¼Œæ­¤æ—¶å¯ä»¥å–å‡ºå¯¹åº”çš„ç¯å¢ƒå˜é‡                String env = System.getenv(fullSocketName);                fileDesc = Integer.parseInt(env);            } catch (RuntimeException ex) {                throw new RuntimeException(fullSocketName + " unset or invalid", ex);            }            try {                FileDescriptor fd = new FileDescriptor();                fd.setInt$(fileDesc);                           // è·å–zygote socketçš„æ–‡ä»¶æè¿°ç¬¦                mServerSocket = new LocalServerSocket(fd);      // å°†socketåŒ…è£…æˆä¸€ä¸ªserver socket            } catch (IOException ex) {                throw new RuntimeException(                        "Error binding to local socket '" + fileDesc + "'", ex);            }        }    }</code></pre><p>æˆ‘ä»¬è·Ÿè¸ªLocalServerSocket()ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">LocalServerSocket</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException    <span class="token punctuation">{</span>        impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocketImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        impl<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>LocalSocket<span class="token punctuation">.</span>SOCKET_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">// åˆ›å»ºSOCKET_STREAMç±»å‹çš„AF_UNIX socket</span>        localAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocketAddress</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        impl<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment" spellcheck="true">// ç»‘å®šåˆ°æŒ‡å®šåœ°å€</span>        impl<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>LISTEN_BACKLOG<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// å¼€å§‹ç›‘å¬</span>    <span class="token punctuation">}</span></code></pre><h3 id="é¢„åŠ è½½"><a href="#é¢„åŠ è½½" class="headerlink" title="é¢„åŠ è½½"></a>é¢„åŠ è½½</h3><p>æˆ‘ä»¬çœ‹çœ‹é¢„åŠ è½½çš„å†…å®¹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preload</span><span class="token punctuation">(</span>TimingsTraceLog bootTimingsTraceLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">beginIcuCachePinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment" spellcheck="true">// Pin ICU Data, è·å–å­—ç¬¦é›†è½¬æ¢èµ„æºç­‰</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token function">preloadClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                             <span class="token comment" spellcheck="true">// è¯»å–æ–‡ä»¶system/etc/preloaded-classesï¼Œç„¶åé€šè¿‡åå°„åŠ è½½å¯¹åº”çš„ç±»</span>                                                                      <span class="token comment" spellcheck="true">// ä¸€èˆ¬ç”±å‚å•†æ¥å®šä¹‰ï¼Œæœ‰æ—¶éœ€è¦åŠ è½½æ•°åƒä¸ªç±»ï¼Œå¯åŠ¨æ…¢çš„åŸå› ä¹‹ä¸€</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">preloadResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                           <span class="token comment" spellcheck="true">// è´Ÿè´£åŠ è½½ä¸€äº›å¸¸ç”¨çš„ç³»ç»Ÿèµ„æº</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">nativePreloadAppProcessHALs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">preloadOpenGL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment" spellcheck="true">// å›¾å½¢ç›¸å…³</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">preloadSharedLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token comment" spellcheck="true">// ä¸€äº›å¿…è¦åº“</span>        <span class="token function">preloadTextResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment" spellcheck="true">// è¯­è¨€ç›¸å…³çš„å­—ç¬¦ä¿¡æ¯</span>        <span class="token comment" spellcheck="true">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span>        <span class="token comment" spellcheck="true">// for memory sharing purposes.</span>        WebViewFactory<span class="token punctuation">.</span><span class="token function">prepareWebViewInZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">endIcuCachePinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">warmUpJcaProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment" spellcheck="true">// å®‰å…¨ç›¸å…³çš„</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"end preload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sPreloadComplete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>ä¸ºäº†è®©ç³»ç»Ÿå®é™…è¿è¡Œæ—¶æ›´åŠ æµç•…ï¼Œåœ¨zygoteå¯åŠ¨æ—¶å€™ï¼Œè°ƒç”¨preloadå‡½æ•°è¿›è¡Œäº†ä¸€äº›é¢„åŠ è½½æ“ä½œã€‚Android é€šè¿‡zygote forkçš„æ–¹å¼åˆ›å»ºå­è¿›ç¨‹ã€‚zygoteè¿›ç¨‹é¢„åŠ è½½è¿™äº›ç±»å’Œèµ„æºï¼Œåœ¨forkå­è¿›ç¨‹æ—¶ï¼Œä»…éœ€è¦åšä¸€ä¸ªå¤åˆ¶å³å¯ã€‚<br>è¿™æ ·å¯ä»¥èŠ‚çº¦å­è¿›ç¨‹çš„å¯åŠ¨æ—¶é—´ã€‚åŒæ—¶ï¼Œæ ¹æ®forkçš„copy-on-writeæœºåˆ¶å¯çŸ¥ï¼Œæœ‰äº›ç±»å¦‚æœä¸åšæ”¹å˜ï¼Œç”šè‡³éƒ½ä¸ç”¨å¤åˆ¶ï¼Œå­è¿›ç¨‹å¯ä»¥å’Œçˆ¶è¿›ç¨‹å…±äº«è¿™éƒ¨åˆ†æ•°æ®ï¼Œä»è€Œçœå»ä¸å°‘å†…å­˜çš„å ç”¨ã€‚</p><h3 id="å¯åŠ¨SystemServerè¿›ç¨‹"><a href="#å¯åŠ¨SystemServerè¿›ç¨‹" class="headerlink" title="å¯åŠ¨SystemServerè¿›ç¨‹"></a>å¯åŠ¨SystemServerè¿›ç¨‹</h3><p>å†æ¥çœ‹çœ‹å¯åŠ¨System Serverçš„æµç¨‹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Prepare the arguments and forks for the system server process.     *     * Returns an {@code Runnable} that provides an entrypoint into system_server code in the     * child process, and {@code null} in the parent.     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Runnable <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>String abiList<span class="token punctuation">,</span> String socketName<span class="token punctuation">,</span>            ZygoteServer zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> capabilities <span class="token operator">=</span> <span class="token function">posixCapabilitiesAsBits</span><span class="token punctuation">(</span>            OsConstants<span class="token punctuation">.</span>CAP_IPC_LOCK<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_KILL<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_NET_ADMIN<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_NET_BIND_SERVICE<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_NET_BROADCAST<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_NET_RAW<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_SYS_MODULE<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_SYS_NICE<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_SYS_PTRACE<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_SYS_TIME<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_SYS_TTY_CONFIG<span class="token punctuation">,</span>            OsConstants<span class="token punctuation">.</span>CAP_WAKE_ALARM        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* Containers run without this capability, so avoid setting it in that case */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SystemProperties<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>PROPERTY_RUNNING_IN_CONTAINER<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            capabilities <span class="token operator">|=</span> <span class="token function">posixCapabilitiesAsBits</span><span class="token punctuation">(</span>OsConstants<span class="token punctuation">.</span>CAP_BLOCK_SUSPEND<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/* Hardcoded command line to start the system server */</span>        String args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"--setuid=1000"</span><span class="token punctuation">,</span>            <span class="token string">"--setgid=1000"</span><span class="token punctuation">,</span>            <span class="token string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010"</span><span class="token punctuation">,</span>            <span class="token string">"--capabilities="</span> <span class="token operator">+</span> capabilities <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> capabilities<span class="token punctuation">,</span>            <span class="token string">"--nice-name=system_server"</span><span class="token punctuation">,</span>            <span class="token string">"--runtime-args"</span><span class="token punctuation">,</span>            <span class="token string">"com.android.server.SystemServer"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ZygoteConnection<span class="token punctuation">.</span>Arguments parsedArgs <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">int</span> pid<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            parsedArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteConnection<span class="token punctuation">.</span>Arguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å°†ä¸Šé¢å‡†å¤‡çš„å‚æ•°ï¼ŒæŒ‰ç…§ZygoteConnectionçš„é£æ ¼è¿›è¡Œå°è£…</span>            ZygoteConnection<span class="token punctuation">.</span><span class="token function">applyDebuggerSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>            ZygoteConnection<span class="token punctuation">.</span><span class="token function">applyInvokeWithSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/* Request to fork the system server process */</span>            pid <span class="token operator">=</span> Zygote<span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>                                <span class="token comment" spellcheck="true">// é€šè¿‡fork"åˆ†è£‚"å‡ºsystem_server</span>                    parsedArgs<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>                    parsedArgs<span class="token punctuation">.</span>gids<span class="token punctuation">,</span>                    parsedArgs<span class="token punctuation">.</span>debugFlags<span class="token punctuation">,</span>                    null<span class="token punctuation">,</span>                    parsedArgs<span class="token punctuation">.</span>permittedCapabilities<span class="token punctuation">,</span>                    parsedArgs<span class="token punctuation">.</span>effectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/* For child process */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¤„ç†32_64å’Œ64_32çš„æƒ…å†µ</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// forkæ—¶ä¼šcopy socketï¼Œsystem serveréœ€è¦ä¸»åŠ¨å…³é—­</span>            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// system serverè¿›ç¨‹å¤„ç†è‡ªå·±çš„å·¥ä½œ</span>            <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="å¤„ç†è¯·æ±‚ä¿¡æ¯"><a href="#å¤„ç†è¯·æ±‚ä¿¡æ¯" class="headerlink" title="å¤„ç†è¯·æ±‚ä¿¡æ¯"></a>å¤„ç†è¯·æ±‚ä¿¡æ¯</h3><p>åˆ›å»ºå‡ºSystemServerè¿›ç¨‹åï¼Œzygoteè¿›ç¨‹è°ƒç”¨ZygoteServerä¸­çš„å‡½æ•°runSelectLoopï¼Œå¤„ç†server socketæ”¶åˆ°çš„å‘½ä»¤ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Runs the zygote process's select loop. Accepts new connections as     * they happen, and reads commands from connections one spawn-request's     * worth at a time.     */</span>    Runnable <span class="token function">runSelectLoop</span><span class="token punctuation">(</span>String abiList<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ArrayList<span class="token operator">&lt;</span>FileDescriptor<span class="token operator">></span> fds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>FileDescriptor<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ArrayList<span class="token operator">&lt;</span>ZygoteConnection<span class="token operator">></span> peers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ZygoteConnection<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// é¦–å…ˆå°†server socketåŠ å…¥åˆ°fds</span>        fds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mServerSocket<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ¯æ¬¡å¾ªç¯ï¼Œéƒ½é‡æ–°åˆ›å»ºéœ€è¦ç›‘å¬çš„pollFds</span>            StructPollfd<span class="token punctuation">[</span><span class="token punctuation">]</span> pollFds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">[</span>fds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pollFds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructPollfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å…³æ³¨äº‹ä»¶åˆ°æ¥</span>                pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> POLLIN<span class="token punctuation">;</span>                            <span class="token punctuation">}</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ç­‰å¾…äº‹ä»¶åˆ°æ¥</span>                Os<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollFds<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"poll failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// æ³¨æ„è¿™é‡Œæ˜¯å€’åºçš„ï¼Œå³ä¼˜å…ˆå¤„ç†å·²å»ºç«‹é“¾æ¥çš„ä¿¡æ¯ï¼Œåå¤„ç†æ–°å»ºé“¾æ¥çš„è¯·æ±‚</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> pollFds<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pollFds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// server socketæœ€å…ˆåŠ å…¥fdsï¼Œ å› æ­¤è¿™é‡Œæ˜¯server socketæ”¶åˆ°æ•°æ®</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// æ”¶åˆ°æ–°çš„å»ºç«‹é€šä¿¡çš„è¯·æ±‚ï¼Œå»ºç«‹é€šä¿¡è¿æ¥</span>                    ZygoteConnection newPeer <span class="token operator">=</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// åŠ å…¥åˆ°peerså’Œfds, å³ä¸‹ä¸€æ¬¡ä¹Ÿå¼€å§‹ç›‘å¬</span>                    peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>                    fds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">.</span><span class="token function">getFileDesciptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//å…¶å®ƒé€šä¿¡è¿æ¥æ”¶åˆ°æ•°æ®</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>ä»ä¸Šé¢ä»£ç å¯çŸ¥ï¼Œåˆå§‹æ—¶fdsä¸­ä»…æœ‰server socketï¼Œå› æ­¤å½“æœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œå°†æ‰§è¡Œiç­‰äº0çš„åˆ†æ”¯ã€‚æ­¤æ—¶ï¼Œæ˜¾ç„¶æ˜¯éœ€è¦åˆ›å»ºæ–°çš„é€šä¿¡è¿æ¥ï¼Œå› æ­¤acceptCommandPeerå°†è¢«è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬çœ‹çœ‹acceptCommandPeerå‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Waits for and accepts a single command connection. Throws     * RuntimeException on failure.     */</span>    <span class="token keyword">private</span> ZygoteConnection <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>String abiList<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// socketç¼–ç¨‹ä¸­ï¼Œaccept()è°ƒç”¨ä¸»è¦ç”¨åœ¨åŸºäºè¿æ¥çš„å¥—æ¥å­—ç±»å‹ï¼Œæ¯”å¦‚SOCK_STREAMå’ŒSOCK_SEQPACKET</span>            <span class="token comment" spellcheck="true">// å®ƒæå–å‡ºæ‰€ç›‘å¬å¥—æ¥å­—çš„ç­‰å¾…è¿æ¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å¥—æ¥å­—ï¼Œå¹¶è¿”å›æŒ‡å‘è¯¥å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦</span>            <span class="token comment" spellcheck="true">// æ–°å»ºç«‹çš„å¥—æ¥å­—ä¸åœ¨ç›‘å¬çŠ¶æ€ï¼ŒåŸæ¥æ‰€ç›‘å¬çš„å¥—æ¥å­—çš„çŠ¶æ€ä¹Ÿä¸å—accept()è°ƒç”¨çš„å½±å“</span>            <span class="token keyword">return</span> <span class="token function">createNewConnection</span><span class="token punctuation">(</span>mServerSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                    <span class="token string">"IOException during accept()"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> ZygoteConnection <span class="token function">createNewConnection</span><span class="token punctuation">(</span>LocalSocket socket<span class="token punctuation">,</span> String abiList<span class="token punctuation">)</span>            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteConnection</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>ä»ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºacceptCommandPeerè°ƒç”¨äº†server socketçš„accpetå‡½æ•°ã€‚äºæ˜¯å½“æ–°çš„è¿æ¥å»ºç«‹æ—¶ï¼Œzygoteå°†ä¼šåˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„socketä¸å…¶é€šä¿¡ï¼Œå¹¶å°†è¯¥socketåŠ å…¥åˆ°fdsä¸­ã€‚å› æ­¤ï¼Œä¸€æ—¦é€šä¿¡è¿æ¥å»ºç«‹åï¼Œfdsä¸­å°†ä¼šåŒ…å«æœ‰å¤šä¸ªsocketã€‚</p><p>å½“pollç›‘å¬åˆ°è¿™ä¸€ç»„socketsä¸Šæœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œå°±ä¼šä»é˜»å¡ä¸­æ¢å¤ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸ªsocketæ”¶åˆ°äº†æ•°æ®ã€‚</p><p>åœ¨runSelectLoopä¸­é‡‡ç”¨å€’åºçš„æ–¹å¼è½®è¯¢ã€‚ç”±äºserver socketç¬¬ä¸€ä¸ªè¢«åŠ å…¥åˆ°fdsï¼Œå› æ­¤æœ€åè½®è¯¢åˆ°çš„socketæ‰éœ€è¦å¤„ç†æ–°å»ºè¿æ¥çš„æ“ä½œï¼›å…¶å®ƒsocketæ”¶åˆ°æ•°æ®æ—¶ï¼Œä»…éœ€è¦è°ƒç”¨zygoteConnectionçš„runonceå‡½æ•°æ‰§è¡Œæ•°æ®å¯¹åº”çš„æ“ä½œã€‚è‹¥ä¸€ä¸ªè¿æ¥å¤„ç†å®Œæ‰€æœ‰å¯¹åº”æ¶ˆæ¯åï¼Œè¯¥è¿æ¥å¯¹åº”çš„socketå’Œè¿æ¥ç­‰å°†è¢«ç§»é™¤ã€‚</p><h1 id="å®Œç»“"><a href="#å®Œç»“" class="headerlink" title="å®Œç»“"></a>å®Œç»“</h1><p><center><strong><font color="#87CEFA" size="4">Zygoteå¯åŠ¨æµç¨‹åˆ°æ­¤ç»“æŸï¼ŒZygoteè¿›ç¨‹å…±åšäº†å¦‚ä¸‹å‡ ä»¶äº‹</font></strong></center><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 1. åˆ›å»ºAppRuntimeå¹¶è°ƒç”¨å…¶startæ–¹æ³•ï¼Œå¯åŠ¨Zygoteè¿›ç¨‹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 2. åˆ›å»ºJavaVMå¹¶ä¸ºJavaVMæ³¨å†ŒJNI.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 3. é€šè¿‡JNIè°ƒç”¨ZygoteInitçš„mainå‡½æ•°è¿›å…¥Zygoteçš„Javaæ¡†æ¶å±‚ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 4. é€šè¿‡registerZygoteSocketå‡½æ•°åˆ›å»ºæœåŠ¡ç«¯Socketï¼Œé¢„åŠ è½½ç±»å’Œèµ„æºï¼Œå¹¶é€šè¿‡runSelectLoopå‡½æ•°ç­‰å¾…å¦‚ActivityManagerServiceç­‰çš„è¯·æ±‚ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¨ 5. å¯åŠ¨SystemServerè¿›ç¨‹ã€‚</p><h1 id="å‚è€ƒBlog"><a href="#å‚è€ƒBlog" class="headerlink" title="å‚è€ƒBlog"></a>å‚è€ƒBlog</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01. <a href="https://blog.csdn.net/tfygg/article/details/52086621" target="_blank" rel="noopener">https://blog.csdn.net/tfygg/article/details/52086621</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 02. <a href="https://www.jianshu.com/p/cbc6b84aee08" target="_blank" rel="noopener">https://www.jianshu.com/p/cbc6b84aee08</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 03. <a href="https://www.jianshu.com/p/ab9b83a77af6" target="_blank" rel="noopener">https://www.jianshu.com/p/ab9b83a77af6</a></p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿå¯åŠ¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯åŠ¨é˜¶æ®µ </tag>
            
            <tag> zygote </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</title>
      <link href="/2018/12/01/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-init/"/>
      <url>/2018/12/01/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-init/</url>
      
        <content type="html"><![CDATA[<p><br></p><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><br><center><strong><font color="#1874CD"><font color="#3A5FCD" size="4">Android å¯åŠ¨é˜¶æ®µç³»åˆ—</font></font></strong></center><br><center>ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ </center><p><br></p><table><thead><tr><th style="text-align:center"><strong><font color="#EE2C2C" size="3">ã€å¯åŠ¨é˜¶æ®µã€‘</font></strong></th><th style="text-align:center"><strong><font color="#0000FF" size="3">ã€ç›¸å…³æ–‡ç« ã€‘</font></strong></th><th style="text-align:center"><strong><font color="#9932CC" size="3">æºç ç‰ˆæœ¬</font></strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">init</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/01/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20init/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ init</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">zygote</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/10/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20zygote/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">systemserver</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/18/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20systemserver/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ systemserver</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr><tr><td style="text-align:center"><strong><font color="#FF7F00" size="3">Launcher</font></strong></td><td style="text-align:center"><a href="https://superandroid.pro/2018/12/26/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20Launcher/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨åŠåŠ è½½æµç¨‹</a></td><td style="text-align:center"><font color="#FF0000" size="3">Android 9.0</font></td></tr></tbody></table><p><br></p><p><strong><font color="#3A5FCD" size="4">åšæ–‡ä¿®æ”¹æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† init æºç ï¼ˆAndroid 9.0ï¼‰ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font><br><br></p><hr><h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">init.rc</font></td><td>/system/core/rootdir/init.rc</td></tr><tr><td><font color="#D15FEE">init.cpp</font></td><td>/system/core/init/init.cpp</td></tr><tr><td><font color="#D15FEE">property_service.cpp</font></td><td>/system/core/init/property_service.cpp</td></tr><tr><td><font color="#D15FEE">parser.cpp</font></td><td>/system/core/init/parser.cpp</td></tr><tr><td><font color="#D15FEE">log.cpp</font></td><td>/system/core/init/log.cpp</td></tr><tr><td><font color="#D15FEE">logging.cpp</font></td><td>/system/core/base/logging.cpp</td></tr><tr><td><font color="#D15FEE">property_service.cpp</font></td><td>/system/core/init/property_service.cpp</td></tr><tr><td><font color="#D15FEE">signal_handler.cpp</font></td><td>/system/core/init/signal_handler.cpp</td></tr><tr><td><font color="#D15FEE">service.cpp</font></td><td>/system/core/init/service.cpp</td></tr><tr><td><font color="#D15FEE">Action.cpp</font></td><td>/system/core/init/Action.cpp</td></tr><tr><td><font color="#D15FEE">builtins.cpp</font></td><td>/system/core/init/builtins.cpp</td></tr><tr><td><font color="#D15FEE">selinux.cpp</font></td><td>/system/core/init/selinux.cpp</td></tr></tbody></table><h2 id="1-2-ç³»ç»Ÿå¯åŠ¨æµç¨‹"><a href="#1-2-ç³»ç»Ÿå¯åŠ¨æµç¨‹" class="headerlink" title="1.2 ç³»ç»Ÿå¯åŠ¨æµç¨‹"></a>1.2 ç³»ç»Ÿå¯åŠ¨æµç¨‹</h2><p><strong><font color="#0000CD">1. æŒ‰ä¸‹ç”µæºç³»ç»Ÿå¯åŠ¨</font></strong></p><p>å½“ç”µæºæŒ‰ä¸‹æ—¶å¼•å¯¼èŠ¯ç‰‡ä»£ç å¼€å§‹ä»é¢„å®šä¹‰çš„åœ°æ–¹ï¼ˆå›ºåŒ–åœ¨ ROMï¼‰å¼€å§‹æ‰§è¡Œï¼ŒåŠ è½½å¼•å¯¼ç¨‹åº Bootloader åˆ° RAMï¼Œç„¶åæ‰§è¡Œã€‚ </p><p><strong><font color="#0000CD">2. å¼•å¯¼ç¨‹åº Bootloader</font></strong></p><p>å¼•å¯¼ç¨‹åºæ˜¯åœ¨ Android æ“ä½œç³»ç»Ÿå¼€å§‹è¿è¡Œå‰çš„ä¸€ä¸ªå°ç¨‹åºï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æŠŠç³»ç»Ÿ OS æ‹‰èµ·æ¥å¹¶è¿è¡Œã€‚ </p><p><strong><font color="#0000CD">3. linux å†…æ ¸å¯åŠ¨</font></strong></p><p>å†…æ ¸å¯åŠ¨æ—¶ï¼Œè®¾ç½®ç¼“å­˜ã€è¢«ä¿æŠ¤å­˜å‚¨å™¨ã€è®¡åˆ’åˆ—è¡¨ï¼ŒåŠ è½½é©±åŠ¨ã€‚å½“å†…æ ¸å®Œæˆç³»ç»Ÿè®¾ç½®ï¼Œå®ƒé¦–å…ˆåœ¨ç³»ç»Ÿæ–‡ä»¶ä¸­å¯»æ‰¾ â€initâ€ æ–‡ä»¶ï¼Œç„¶åå¯åŠ¨ root è¿›ç¨‹æˆ–è€…ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚</p><p><strong><font color="#0000CD">4. init è¿›ç¨‹å¯åŠ¨</font></strong></p><p><strong><font color="#FF0000">âœ¨ è¿™å°±æ˜¯æˆ‘ä»¬æœ¬ç¯‡æ–‡ç« è¦è®¨è®ºçš„å†…å®¹ âœ¨</font></strong></p><h2 id="1-3-å…³äº-init"><a href="#1-3-å…³äº-init" class="headerlink" title="1.3 å…³äº init"></a>1.3 å…³äº init</h2><p>init è¿›ç¨‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”±å†…æ ¸å¯åŠ¨çš„ç”¨æˆ·çº§è¿›ç¨‹ï¼Œå½“ Linux å†…æ ¸å¯åŠ¨ä¹‹åï¼Œè¿è¡Œçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯ initï¼Œè¿™ä¸ªè¿›ç¨‹æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œç¡®åˆ‡çš„è¯´ï¼Œå®ƒæ˜¯ Linux ç³»ç»Ÿä¸­ç”¨æˆ·æ§ä»¶çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥å®ƒçš„è¿›ç¨‹å·æ˜¯ 1ã€‚å®ƒçš„ç”Ÿå‘½å‘¨æœŸè´¯ç©¿æ•´ä¸ª linux å†…æ ¸è¿è¡Œçš„å§‹ç»ˆï¼Œ linux ä¸­æ‰€æœ‰å…¶å®ƒçš„è¿›ç¨‹çš„å…±åŒå§‹ç¥–å‡ä¸º init è¿›ç¨‹ï¼Œå¯ä»¥é€šè¿‡ â€œadb shell ps | grep initâ€ æŸ¥çœ‹è¿›ç¨‹å·ã€‚</p><p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-f5b4697ef9cc33ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Android è¿›ç¨‹æ¨¡å‹.png"></center><br><br><br>init è¿›ç¨‹çš„å…¥å£æ–‡ä»¶åœ¨ <code>system/core/init/init.cpp</code> ä¸­ï¼Œç”±äº init æ˜¯å‘½ä»¤è¡Œç¨‹åºï¼Œæ‰€ä»¥åˆ†æ init.cpp é¦–å…ˆåº”ä» <code>main</code> å‡½æ•°å¼€å§‹ï¼</p><h1 id="äºŒã€ç¬¬ä¸€é˜¶æ®µï¼ˆå†…æ ¸æ€ï¼‰"><a href="#äºŒã€ç¬¬ä¸€é˜¶æ®µï¼ˆå†…æ ¸æ€ï¼‰" class="headerlink" title="äºŒã€ç¬¬ä¸€é˜¶æ®µï¼ˆå†…æ ¸æ€ï¼‰"></a>äºŒã€ç¬¬ä¸€é˜¶æ®µï¼ˆå†…æ ¸æ€ï¼‰</h1><h2 id="2-1-åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡"><a href="#2-1-åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡" class="headerlink" title="2.1 åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡"></a>2.1 åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡</h2><pre class=" language-java"><code class="language-java"><span class="token operator">/</span>system<span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token operator">/</span>init<span class="token punctuation">.</span>cpp<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">//æ ¹æ®å‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¯åŠ¨ ueventd å’Œ watchdogd</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ueventd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨ ueventd</span>        <span class="token keyword">return</span> <span class="token function">ueventd_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"watchdogd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¯åŠ¨ watchdogd</span>        <span class="token keyword">return</span> <span class="token function">watchdogd_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"subcontext"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">InitKernelLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> BuiltinFunctionMap function_map<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">SubcontextMain</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>function_map<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>REBOOT_BOOTLOADER_ON_PANIC<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">InstallRebootSignalHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">// è‹¥ç´§æ€¥é‡å¯ï¼Œåˆ™å®‰è£…å¯¹åº”çš„æ¶ˆæ¯å¤„ç†å™¨</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-2-åˆ›å»ºå¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#2-2-åˆ›å»ºå¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2.2 åˆ›å»ºå¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ"></a>2.2 åˆ›å»ºå¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æ˜¯ç³»ç»Ÿå¯åŠ¨çš„ç¬¬ä¸€é˜¶æ®µ</span>    bool is_first_stage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"INIT_SECOND_STAGE"</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡è¿›å…¥ä¸º true</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ç”¨äºè®°å½•å¯åŠ¨æ—¶é—´</span>        boot_clock<span class="token operator">:</span><span class="token operator">:</span>time_point start_time <span class="token operator">=</span> boot_clock<span class="token operator">:</span><span class="token operator">:</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// æ¸…é™¤å±è”½å­—(file mode creation mask)ï¼Œä¿è¯æ–°å»ºçš„ç›®å½•çš„è®¿é—®æƒé™ä¸å—å±è”½å­—å½±å“</span>        <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">clearenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"PATH"</span><span class="token punctuation">,</span> _PATH_DEFPATH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æŒ‚è½½ tmpfs æ–‡ä»¶ç³»ç»Ÿ</span>        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"tmpfs"</span><span class="token punctuation">,</span> <span class="token string">"/dev"</span><span class="token punctuation">,</span> <span class="token string">"tmpfs"</span><span class="token punctuation">,</span> MS_NOSUID<span class="token punctuation">,</span> <span class="token string">"mode=0755"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/pts"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/socket"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// æŒ‚è½½ devpts æ–‡ä»¶ç³»ç»Ÿ</span>        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"devpts"</span><span class="token punctuation">,</span> <span class="token string">"/dev/pts"</span><span class="token punctuation">,</span> <span class="token string">"devpts"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>        #define <span class="token function">MAKE_STR</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">__STRING</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// æŒ‚è½½ proc æ–‡ä»¶ç³»ç»Ÿ</span>        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"proc"</span><span class="token punctuation">,</span> <span class="token string">"/proc"</span><span class="token punctuation">,</span> <span class="token string">"proc"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"hidepid=2,gid="</span> <span class="token function">MAKE_STR</span><span class="token punctuation">(</span>AID_READPROC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 8.0 æ–°å¢, æ”¶ç´§äº† cmdline ç›®å½•çš„æƒé™</span>        <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token string">"/proc/cmdline"</span><span class="token punctuation">,</span> <span class="token number">0440</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 8.0 æ–°å¢ï¼Œå¢åŠ äº†ä¸ªç”¨æˆ·ç»„</span>        gid_t groups<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> AID_READPROC <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token function">setgroups</span><span class="token punctuation">(</span><span class="token function">arraysize</span><span class="token punctuation">(</span>groups<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æŒ‚è½½ sysfs æ–‡ä»¶ç³»ç»Ÿ</span>        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"sysfs"</span><span class="token punctuation">,</span> <span class="token string">"/sys"</span><span class="token punctuation">,</span> <span class="token string">"sysfs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 8.0 æ–°å¢</span>        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"selinuxfs"</span><span class="token punctuation">,</span> <span class="token string">"/sys/fs/selinux"</span><span class="token punctuation">,</span> <span class="token string">"selinuxfs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æå‰åˆ›å»ºäº† kmsg è®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶ï¼Œç”¨äºè¾“å‡º log ä¿¡æ¯</span>        <span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/kmsg"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0600</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token function">constexpr</span> <span class="token punctuation">(</span>WORLD_WRITABLE_KMSG<span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/kmsg_debug"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0622</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/random"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Mount staging areas for devices managed by vold</span>        <span class="token comment" spellcheck="true">// See storage config details at http://source.android.com/devices/storage/</span>        <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"tmpfs"</span><span class="token punctuation">,</span> <span class="token string">"/mnt"</span><span class="token punctuation">,</span> <span class="token string">"tmpfs"</span><span class="token punctuation">,</span> MS_NOEXEC <span class="token operator">|</span> MS_NOSUID <span class="token operator">|</span> MS_NODEV<span class="token punctuation">,</span>              <span class="token string">"mode=0755,uid=0,gid=1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span>        <span class="token comment" spellcheck="true">// part of the vendor partition, e.g. because they are mounted read-write.</span>        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/mnt/vendor"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>é€šè¿‡æºç å¯ä»¥å‘ç°ï¼Œè¯¥éƒ¨åˆ†ä¸»è¦ç”¨äº<code>åˆ›å»º</code>å’Œ<code>æŒ‚è½½</code>å¯åŠ¨æ‰€éœ€çš„<code>æ–‡ä»¶ç›®å½•</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ç¼–è¯‘ Android ç³»ç»Ÿæºç æ—¶ï¼Œåœ¨ç”Ÿæˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¹¶ä¸å­˜åœ¨è¿™äº›ç›®å½•ï¼Œå®ƒä»¬æ˜¯ç³»ç»Ÿè¿è¡Œæ—¶çš„ç›®å½•ï¼Œå³å½“ç³»ç»Ÿç»ˆæ­¢æ—¶ï¼Œå°±ä¼šæ¶ˆå¤±ã€‚ </p><p><strong><font color="#FF0000" size="4">å››ç±»æ–‡ä»¶ç³»ç»Ÿï¼š</font></strong> <strong>ï¼ˆç®€å•ç†è§£å³å¯ï¼‰</strong></p><p><strong><font color="#0000CD">tmpfs</font></strong>ï¼šä¸€ç§è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä¼šå°†æ‰€æœ‰çš„æ–‡ä»¶å­˜å‚¨åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå¦‚æœä½ å°† tmpfs æ–‡ä»¶ç³»ç»Ÿå¸è½½åï¼Œé‚£ä¹ˆå…¶ä¸‹çš„æ‰€æœ‰çš„å†…å®¹å°†ä¸å¤å­˜åœ¨ã€‚tmpfs æ—¢å¯ä»¥ä½¿ç”¨ RAMï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äº¤æ¢åˆ†åŒºï¼Œä¼šæ ¹æ®ä½ çš„å®é™…éœ€è¦è€Œæ”¹å˜å¤§å°ã€‚tmpfs çš„é€Ÿåº¦éå¸¸æƒŠäººï¼Œæ¯•ç«Ÿå®ƒæ˜¯é©»ç•™åœ¨ RAM ä¸­çš„ï¼Œå³ä½¿ç”¨äº†äº¤æ¢åˆ†åŒºï¼Œæ€§èƒ½ä»ç„¶éå¸¸å“è¶Šã€‚ç”±äº tmpfs æ˜¯é©»ç•™åœ¨ RAM çš„ï¼Œå› æ­¤å®ƒçš„å†…å®¹æ˜¯ä¸æŒä¹…çš„ã€‚æ–­ç”µåï¼Œtmpfs çš„å†…å®¹å°±æ¶ˆå¤±äº†ï¼Œè¿™ä¹Ÿæ˜¯è¢«ç§°ä½œ tmpfs çš„æ ¹æœ¬åŸå› ã€‚</p><p><strong><font color="#0000CD">devpts</font></strong>ï¼šä¸ºä¼ªç»ˆç«¯æä¾›äº†ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œå®ƒçš„æ ‡å‡†æŒ‚æ¥ç‚¹æ˜¯ /dev/ptsã€‚åªè¦ pty çš„ä¸»å¤åˆè®¾å¤‡ /dev/ptmx è¢«æ‰“å¼€ï¼Œå°±ä¼šåœ¨ /dev/pts ä¸‹åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªæ–°çš„ pty è®¾å¤‡æ–‡ä»¶ã€‚</p><p><strong><font color="#0000CD">proc</font></strong>ï¼šä¸€ä¸ªéå¸¸é‡è¦çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯å†…æ ¸å†…éƒ¨æ•°æ®ç»“æ„çš„æ¥å£ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥è·å¾—ç³»ç»Ÿçš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ä¿®æ”¹ç‰¹å®šçš„å†…æ ¸å‚æ•°ã€‚</p><p><strong><font color="#0000CD">sysfs</font></strong>ï¼šä¸ proc æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä¸å æœ‰ä»»ä½•ç£ç›˜ç©ºé—´çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚å®ƒé€šå¸¸è¢«æŒ‚æ¥åœ¨ /sys ç›®å½•ä¸‹ã€‚sysfs æ–‡ä»¶ç³»ç»Ÿæ˜¯ Linux2.6 å†…æ ¸å¼•å…¥çš„ï¼Œå®ƒæŠŠè¿æ¥åœ¨ç³»ç»Ÿä¸Šçš„è®¾å¤‡å’Œæ€»çº¿ç»„ç»‡æˆä¸ºä¸€ä¸ªåˆ†çº§çš„æ–‡ä»¶ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å­˜å–ã€‚</p><h2 id="2-3-é‡å®šå‘è¾“å…¥è¾“å‡º-å†…æ ¸-Log-ç³»ç»Ÿ"><a href="#2-3-é‡å®šå‘è¾“å…¥è¾“å‡º-å†…æ ¸-Log-ç³»ç»Ÿ" class="headerlink" title="2.3 é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ"></a>2.3 é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºå¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">InitKernelLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h2 id="2-4-æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡"><a href="#2-4-æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡" class="headerlink" title="2.4 æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡"></a>2.4 æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// æŒ‚è½½ç‰¹å®šçš„åˆ†åŒºè®¾å¤‡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DoFirstStageMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to mount required partitions early ..."</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h2 id="2-5-å®Œæˆ-SELinux-ç›¸å…³å·¥ä½œ"><a href="#2-5-å®Œæˆ-SELinux-ç›¸å…³å·¥ä½œ" class="headerlink" title="2.5 å®Œæˆ SELinux ç›¸å…³å·¥ä½œ"></a>2.5 å®Œæˆ SELinux ç›¸å…³å·¥ä½œ</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// æ­¤å¤„åº”è¯¥æ˜¯åˆå§‹åŒ–å®‰å…¨æ¡†æ¶ï¼šAndroid Verified Boot</span>        <span class="token comment" spellcheck="true">// AVB ä¸»è¦ç”¨äºé˜²æ­¢ç³»ç»Ÿæ–‡ä»¶æœ¬èº«è¢«ç¯¡æ”¹ï¼Œè¿˜åŒ…å«äº†é˜²æ­¢ç³»ç»Ÿå›æ»šçš„åŠŸèƒ½ï¼Œ</span>        <span class="token comment" spellcheck="true">// ä»¥å…æœ‰äººè¯•å›¾å›æ»šç³»ç»Ÿå¹¶åˆ©ç”¨ä»¥å‰çš„æ¼æ´</span>        <span class="token function">SetInitAvbVersionInRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Set up SELinux, loading the SELinux policy.</span>        <span class="token function">SelinuxSetupKernelLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">selinux_initialize</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è°ƒç”¨ selinux_initialize å¯åŠ¨ SELinux</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h2 id="2-6-is-first-stage-æ”¶å°¾"><a href="#2-6-is-first-stage-æ”¶å°¾" class="headerlink" title="2.6 is_first_stage æ”¶å°¾"></a>2.6 is_first_stage æ”¶å°¾</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// æŒ‰ selinux policy è¦æ±‚ï¼Œé‡æ–°è®¾ç½® init æ–‡ä»¶å±æ€§</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">selinux_android_restorecon</span><span class="token punctuation">(</span><span class="token string">"/init"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"restorecon failed of /init failed"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"INIT_SECOND_STAGE"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">static</span> constexpr uint32_t kNanosecondsPerMillisecond <span class="token operator">=</span> <span class="token number">1e6</span><span class="token punctuation">;</span>        uint64_t start_ms <span class="token operator">=</span>                   start_time<span class="token punctuation">.</span><span class="token function">time_since_epoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> kNanosecondsPerMillisecond<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è®°å½•åˆå§‹åŒ–æ—¶çš„æ—¶é—´</span>        <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"INIT_STARTED_AT"</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">to_string</span><span class="token punctuation">(</span>start_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span><span class="token operator">*</span> path <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> nullptr <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å†æ¬¡è°ƒç”¨ init çš„ main å‡½æ•°ï¼Œå¯åŠ¨ç”¨æˆ·æ€çš„ init è¿›ç¨‹</span>        <span class="token function">execv</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// execv() only returns if an error happened, in which case we</span>        <span class="token comment" spellcheck="true">// panic and never fall through this conditional.</span>        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"execv(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\") failed"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢æ‰€æœ‰çš„æºç æˆ‘ä»¬éƒ½æ˜¯å›´ç»•ç¬¬ä¸€é˜¶æ®µè¿›è¡Œçš„åˆ†æï¼ˆis_first_stageï¼‰ï¼Œè‡ªæ­¤ç¬¬ä¸€é˜¶æ®µç»“æŸï¼Œä¼šå¤ä½ä¸€äº›ä¿¡æ¯ï¼Œå¹¶è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œæœ€åå¯åŠ¨ç”¨æˆ·æ€çš„ init è¿›ç¨‹ï¼Œè¿›å…¥ init ç¬¬äºŒé˜¶æ®µã€‚</p><h1 id="ä¸‰ã€ç¬¬äºŒé˜¶æ®µï¼ˆç”¨æˆ·æ€ï¼‰"><a href="#ä¸‰ã€ç¬¬äºŒé˜¶æ®µï¼ˆç”¨æˆ·æ€ï¼‰" class="headerlink" title="ä¸‰ã€ç¬¬äºŒé˜¶æ®µï¼ˆç”¨æˆ·æ€ï¼‰"></a>ä¸‰ã€ç¬¬äºŒé˜¶æ®µï¼ˆç”¨æˆ·æ€ï¼‰</h1><p>init è¿›ç¨‹çš„ç¬¬äºŒé˜¶æ®µä»ç„¶ä» main å‡½æ•°å¼€å§‹å…¥æ‰‹ï¼</p><h2 id="3-1-åˆå§‹åŒ–å±æ€§åŸŸ"><a href="#3-1-åˆå§‹åŒ–å±æ€§åŸŸ" class="headerlink" title="3.1 åˆå§‹åŒ–å±æ€§åŸŸ"></a>3.1 åˆå§‹åŒ–å±æ€§åŸŸ</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">// åŒæ ·å±è”½æ ‡å‡†è¾“å…¥è¾“å‡ºåŠå®šä¹‰ Kernel logger</span>    <span class="token function">InitKernelLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"init second stage started!"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æœ€åè°ƒç”¨ syscallï¼Œè®¾ç½®å®‰å…¨ç›¸å…³çš„å€¼</span>    <span class="token function">keyctl_get_keyring_ID</span><span class="token punctuation">(</span>KEY_SPEC_SESSION_KEYRING<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è¿™é‡Œçš„åŠŸèƒ½ç±»ä¼¼äºâ€œé”â€</span>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/.booting"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">property_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–å±æ€§åŸŸ --> å®šä¹‰äºsystem/core/init/property_service.cpp</span>    <span class="token function">process_kernel_dt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">process_kernel_cmdline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¤„ç†å†…æ ¸å‘½ä»¤</span>    <span class="token comment" spellcheck="true">// Propagate the kernel variables to internal variables</span>    <span class="token comment" spellcheck="true">// used by init as well as the current required properties.</span>    <span class="token function">export_kernel_boot_props</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Make the time that init started available for bootstat to log.</span>    <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.boottime.init"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"INIT_STARTED_AT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.boottime.init.selinux"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"INIT_SELINUX_TOOK"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Set libavb version for Framework-only OTA match in Treble build.</span>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> avb_version <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"INIT_AVB_VERSION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>avb_version<span class="token punctuation">)</span> <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.boot.avb_version"</span><span class="token punctuation">,</span> avb_version<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>è¿™éƒ¨åˆ†ä»£ç ä¸»è¦çš„å·¥ä½œåº”è¯¥å°±æ˜¯è°ƒç”¨ <code>property_init()</code> åˆå§‹åŒ–å±æ€§åŸŸï¼Œç„¶åè®¾ç½®å„ç§å±æ€§ã€‚</p><p>åœ¨ Android å¹³å°ä¸­ï¼Œä¸ºäº†è®©è¿è¡Œä¸­çš„æ‰€æœ‰è¿›ç¨‹å…±äº«ç³»ç»Ÿè¿è¡Œæ—¶æ‰€éœ€è¦çš„å„ç§è®¾ç½®å€¼ï¼Œç³»ç»Ÿå¼€è¾Ÿäº†å±æ€§å­˜å‚¨åŒºåŸŸï¼Œå¹¶æä¾›äº†è®¿é—®è¯¥åŒºåŸŸçš„ APIã€‚</p><p>æˆ‘ä»¬æŸ¥çœ‹ <code>property_init()</code> æºç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token operator">/</span>system<span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token operator">/</span>property_service<span class="token punctuation">.</span>cpp<span class="token keyword">void</span> <span class="token function">property_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/__properties__"</span><span class="token punctuation">,</span> S_IRWXU <span class="token operator">|</span> S_IXGRP <span class="token operator">|</span> S_IXOTH<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CreateSerializedPropertyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æœ€ç»ˆè°ƒç”¨ _system_property_area_init() å‡½æ•°åˆå§‹åŒ–å±æ€§åŸŸ</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__system_property_area_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to initialize property area"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>property_info_area<span class="token punctuation">.</span><span class="token function">LoadDefaultPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to load serialized property info file"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="3-2-æ¸…ç©ºç¯å¢ƒå˜é‡"><a href="#3-2-æ¸…ç©ºç¯å¢ƒå˜é‡" class="headerlink" title="3.2 æ¸…ç©ºç¯å¢ƒå˜é‡"></a>3.2 æ¸…ç©ºç¯å¢ƒå˜é‡</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">// æ¸…é™¤æ‰ä¹‹å‰ä½¿ç”¨è¿‡çš„ç¯å¢ƒå˜é‡</span>    <span class="token comment" spellcheck="true">// Clean up our environment.</span>    <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token string">"INIT_SECOND_STAGE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token string">"INIT_STARTED_AT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token string">"INIT_SELINUX_TOOK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token string">"INIT_AVB_VERSION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-3-å®Œæˆ-SELinux-ç›¸å…³å·¥ä½œ"><a href="#3-3-å®Œæˆ-SELinux-ç›¸å…³å·¥ä½œ" class="headerlink" title="3.3 å®Œæˆ SELinux ç›¸å…³å·¥ä½œ"></a>3.3 å®Œæˆ SELinux ç›¸å…³å·¥ä½œ</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">// å†æ¬¡å®Œæˆ selinux ç›¸å…³çš„å·¥ä½œ</span>    <span class="token comment" spellcheck="true">// Now set up SELinux for second stage.</span>    <span class="token function">SelinuxSetupKernelLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">SelabelInitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">SelinuxRestoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>æˆ‘ä»¬å‘ç°åœ¨ <code>init</code> è¿›ç¨‹çš„<code>ç¬¬ä¸€é˜¶æ®µ</code>ï¼Œä¹Ÿè°ƒç”¨äº† <code>selinux_initialize</code> å‡½æ•°ï¼Œé‚£ä¹ˆä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><p>init è¿›ç¨‹<code>ç¬¬ä¸€é˜¶æ®µ</code>ä¸»è¦<code>åŠ è½½ selinux ç›¸å…³çš„ç­–ç•¥</code>ï¼Œè€Œ<code>ç¬¬äºŒé˜¶æ®µ</code>è°ƒç”¨ <code>SelabelInitialize()</code> æ˜¯ä¸ºäº†<code>æ³¨å†Œä¸€äº›å¤„ç†å™¨</code>ã€‚</p><h2 id="3-4-åˆ›å»º-epoll-å¥æŸ„"><a href="#3-4-åˆ›å»º-epoll-å¥æŸ„" class="headerlink" title="3.4 åˆ›å»º epoll å¥æŸ„"></a>3.4 åˆ›å»º epoll å¥æŸ„</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 03. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    epoll_fd <span class="token operator">=</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span>EPOLL_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è°ƒç”¨ epoll_create1 åˆ›å»º epoll å¥æŸ„</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoll_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_create1 failed"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-5-è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨"><a href="#3-5-è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨" class="headerlink" title="3.5 è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨"></a>3.5 è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 03. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 04. åˆ›å»º epoll å¥æŸ„ */</span>    <span class="token function">signal_handler_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨</span><span class="token punctuation">}</span></code></pre><p><code>init</code> æ˜¯ä¸€ä¸ª<code>å®ˆæŠ¤è¿›ç¨‹</code>ï¼Œä¸ºäº†é˜²æ­¢ init çš„å­è¿›ç¨‹æˆä¸º<code>åƒµå°¸è¿›ç¨‹</code>(zombie process)ï¼Œéœ€è¦ init åœ¨å­è¿›ç¨‹åœ¨ç»“æŸæ—¶è·å–å­è¿›ç¨‹çš„ç»“æŸç ï¼Œé€šè¿‡ç»“æŸç å°†ç¨‹åºè¡¨ä¸­çš„å­è¿›ç¨‹ç§»é™¤ï¼Œé˜²æ­¢æˆä¸ºåƒµå°¸è¿›ç¨‹çš„å­è¿›ç¨‹å ç”¨ç¨‹åºè¡¨çš„ç©ºé—´ï¼ˆç¨‹åºè¡¨çš„ç©ºé—´è¾¾åˆ°ä¸Šé™æ—¶ï¼Œç³»ç»Ÿå°±ä¸èƒ½å†å¯åŠ¨æ–°çš„è¿›ç¨‹äº†ï¼Œä¼šå¼•èµ·ä¸¥é‡çš„ç³»ç»Ÿé—®é¢˜ï¼‰ã€‚</p><p>åœ¨ linux å½“ä¸­ï¼Œ<code>çˆ¶è¿›ç¨‹</code>æ˜¯é€šè¿‡æ•æ‰ <code>SIGCHLD</code> ä¿¡å·æ¥å¾—çŸ¥å­è¿›ç¨‹è¿è¡Œç»“æŸçš„æƒ…å†µï¼Œæ­¤å¤„ init è¿›ç¨‹è°ƒç”¨ <code>signal_handler_init()</code> çš„ç›®çš„å°±æ˜¯<code>æ•è·å­è¿›ç¨‹ç»“æŸçš„ä¿¡å·</code>ã€‚</p><h2 id="3-6-å¯åŠ¨å±æ€§æœåŠ¡"><a href="#3-6-å¯åŠ¨å±æ€§æœåŠ¡" class="headerlink" title="3.6 å¯åŠ¨å±æ€§æœåŠ¡"></a>3.6 å¯åŠ¨å±æ€§æœåŠ¡</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 03. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 04. åˆ›å»º epoll å¥æŸ„ */</span>    <span class="token comment" spellcheck="true">/* 05. è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨ */</span>    <span class="token comment" spellcheck="true">// è¿›ç¨‹è°ƒç”¨ property_load_boot_defaults è¿›è¡Œé»˜è®¤å±æ€§é…ç½®ç›¸å…³çš„å·¥ä½œ</span>    <span class="token function">property_load_boot_defaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">export_oem_lock_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æœ€ç»ˆå°±æ˜¯å†³å®š "ro.boot.flash.locked" çš„å€¼</span>    <span class="token function">start_property_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¯åŠ¨å±æ€§æœåŠ¡</span>    <span class="token function">set_usb_controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-7-åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³»"><a href="#3-7-åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³»" class="headerlink" title="3.7 åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³»"></a>3.7 åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³»</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 03. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 04. åˆ›å»º epoll å¥æŸ„ */</span>    <span class="token comment" spellcheck="true">/* 05. è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨ */</span>    <span class="token comment" spellcheck="true">/* 06. å¯åŠ¨å±æ€§æœåŠ¡*/</span>    <span class="token comment" spellcheck="true">/* 07. åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³» */</span>    <span class="token comment" spellcheck="true">// system/core/init/builtins.cppï¼Œå®šä¹‰ Action ä¸­çš„ function_map ä¸º BuiltinFuntionMap</span>    <span class="token keyword">const</span> BuiltinFunctionMap function_map<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åœ¨ Action ä¸­ä¿å­˜ function_map å¯¹è±¡ï¼Œè®°å½•äº†å‘½ä»¤ä¸å‡½æ•°ä¹‹é—´çš„å¯¹åº”å…³ç³»</span>    Action<span class="token operator">:</span><span class="token operator">:</span><span class="token function">set_function_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>function_map<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ END ------------ */</span><span class="token punctuation">}</span></code></pre><p>è‡³æ­¤ï¼Œinit è¿›ç¨‹çš„å‡†å¤‡å·¥ä½œæ‰§è¡Œå®Œæ¯•ï¼Œ æ¥ä¸‹æ¥å°±è¦å¼€å§‹è§£æ init.rc æ–‡ä»¶çš„å·¥ä½œã€‚ </p><h1 id="å››ã€ç¬¬ä¸‰é˜¶æ®µï¼ˆinit-rcï¼‰"><a href="#å››ã€ç¬¬ä¸‰é˜¶æ®µï¼ˆinit-rcï¼‰" class="headerlink" title="å››ã€ç¬¬ä¸‰é˜¶æ®µï¼ˆinit.rcï¼‰"></a>å››ã€ç¬¬ä¸‰é˜¶æ®µï¼ˆinit.rcï¼‰</h1><h2 id="4-1-è§£æ-init-rc"><a href="#4-1-è§£æ-init-rc" class="headerlink" title="4.1 è§£æ init.rc"></a>4.1 è§£æ init.rc</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 03. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 04. åˆ›å»º epoll å¥æŸ„ */</span>    <span class="token comment" spellcheck="true">/* 05. è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨ */</span>    <span class="token comment" spellcheck="true">/* 06. å¯åŠ¨å±æ€§æœåŠ¡*/</span>    <span class="token comment" spellcheck="true">/* 07. åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³» */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸‰é˜¶æ®µ ----------- BEGIN------------ */</span>    subcontexts <span class="token operator">=</span> <span class="token function">InitializeSubcontexts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ActionManager<span class="token operator">&amp;</span> am <span class="token operator">=</span> ActionManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ServiceList<span class="token operator">&amp;</span> sm <span class="token operator">=</span> ServiceList<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>am<span class="token punctuation">,</span> sm<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è§£æ init.rc</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="4-2-LoadBootScripts"><a href="#4-2-LoadBootScripts" class="headerlink" title="4.2 LoadBootScripts"></a>4.2 LoadBootScripts</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>ActionManager<span class="token operator">&amp;</span> action_manager<span class="token punctuation">,</span> ServiceList<span class="token operator">&amp;</span> service_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parser parser <span class="token operator">=</span> <span class="token function">CreateParser</span><span class="token punctuation">(</span>action_manager<span class="token punctuation">,</span> service_list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ bootscript</span>    std<span class="token operator">:</span><span class="token operator">:</span>string bootscript <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.boot.init_rc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰ bootscriptï¼Œåˆ™è§£æ init.rc æ–‡ä»¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootscript<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ã€€           <span class="token comment" spellcheck="true">// 8.0ã€€å¼•å…¥</span>        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/init.rc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// å¼€å§‹å®é™…çš„è§£æè¿‡ç¨‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/product/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/product/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span>bootscript<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å¦‚æœæ²¡æœ‰å®šä¹‰ bootScriptï¼Œé‚£ä¹ˆ init è¿›ç¨‹è¿˜æ˜¯ä¼šè§£æ <code>init.rc</code> æ–‡ä»¶ã€‚init.rc æ–‡ä»¶æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨åæ‰§è¡Œçš„å¯åŠ¨è„šæœ¬ï¼Œæ–‡ä»¶ä¸­è®°å½•ç€ init è¿›ç¨‹éœ€æ‰§è¡Œçš„æ“ä½œã€‚</p><p>æ­¤å¤„è§£æå‡½æ•°ä¼ å…¥çš„å‚æ•°ä¸ºâ€œ/init.rcâ€ï¼Œè§£æçš„æ˜¯è¿è¡Œæ—¶ä¸ init è¿›ç¨‹åŒåœ¨æ ¹ç›®å½•ä¸‹çš„ init.rc æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åœ¨ç¼–è¯‘å‰ï¼Œå®šä¹‰äº<code>system/core/rootdir/init.rc</code>ä¸­ã€‚</p><p><strong>ç»§ç»­å¾€ä¸‹åˆ†æ main å‡½æ•°ä¹‹å‰ï¼›æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ init.rc æ˜¯ä»€ä¹ˆï¼Œç„¶ååˆ†æä¸‹ parser è§£æ init.rc è¿‡ç¨‹ï¼›æœ€åæˆ‘ä»¬å†ç»§ç»­è·Ÿæºç ï¼</strong></p><h2 id="4-3-init-rc-é…ç½®æ–‡ä»¶"><a href="#4-3-init-rc-é…ç½®æ–‡ä»¶" class="headerlink" title="4.3 init.rc é…ç½®æ–‡ä»¶"></a>4.3 init.rc é…ç½®æ–‡ä»¶</h2><p>init.rc æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå†…éƒ¨ç”± Android åˆå§‹åŒ–è¯­è¨€ç¼–å†™ï¼ˆAndroid Init Languageï¼‰ç¼–å†™çš„è„šæœ¬ï¼Œä¸»è¦åŒ…å«äº”ç§ç±»å‹è¯­å¥ï¼š <font color="#0000CD">Actionã€Commandã€Serviceã€Option</font> å’Œ <font color="#0000CD">Import</font>ï¼Œåœ¨åˆ†æä»£ç çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»ã€‚</p><p>init.rc çš„é…ç½®ä»£ç åœ¨ï¼š<code>system/core/rootdir/init.rc</code> ä¸­ã€‚</p><p>init.rc æ–‡ä»¶å¤§è‡´åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š</p><blockquote><p>ä¸€éƒ¨åˆ†æ˜¯ä»¥ <font color="#FF0000">â€œonâ€</font> å…³é”®å­—å¼€å¤´çš„ <font color="#FF0000">åŠ¨ä½œåˆ—è¡¨</font>ï¼ˆaction listï¼‰ï¼š</p></blockquote><pre><code>on early-init                                         // Actionç±»å‹è¯­å¥    # Set init and its forked children&#39;s oom_adj.     // #ï¼šæ³¨é‡Šç¬¦å·    write /proc/1/oom_score_adj -1000    ... ...    # app mem cgroups, used by activity manager, lmkd and zygote    mkdir /dev/memcg/apps/ 0755 system system    ... ...    start ueventd</code></pre><p>Action ç±»å‹è¯­å¥æ ¼å¼ï¼š</p><pre><code>on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*     // è®¾ç½®è§¦å‘å™¨   &lt;command&gt;   &lt;command&gt;                     // åŠ¨ä½œè§¦å‘ä¹‹åè¦æ‰§è¡Œçš„å‘½ä»¤   ...</code></pre><blockquote><p>å¦ä¸€éƒ¨åˆ†æ˜¯ä»¥ <font color="#FF0000">â€œserviceâ€</font> å…³é”®å­—å¼€å¤´çš„ <font color="#FF0000">æœåŠ¡åˆ—è¡¨</font>ï¼ˆservice listï¼‰ï¼š  å¦‚ <strong><font color="#FF0000">Zygote</font></strong></p></blockquote><pre><code>service ueventd /sbin/ueventd    // Serviceç±»å‹è¯­å¥    class core    critical    seclabel u:r:ueventd:s0    shutdown critical</code></pre><p>Service ç±»å‹è¯­å¥æ ¼å¼ï¼š</p><pre><code>service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*   // &lt;serviceçš„åå­—&gt;&lt;æ‰§è¡Œç¨‹åºè·¯å¾„&gt;&lt;ä¼ é€’å‚æ•°&gt;   &lt;option&gt;                                 // optionæ˜¯serviceçš„ä¿®é¥°è¯ï¼Œå½±å“ä»€ä¹ˆæ—¶å€™ã€å¦‚ä½•å¯åŠ¨services   &lt;option&gt;   ...</code></pre><p>å€ŸåŠ©ç³»ç»Ÿç¯å¢ƒå˜é‡æˆ– Linux å‘½ä»¤ï¼Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ¹ åŠ¨ä½œåˆ—è¡¨ç”¨äº<code>åˆ›å»ºæ‰€éœ€ç›®å½•ï¼Œä»¥åŠä¸ºæŸäº›ç‰¹å®šæ–‡ä»¶æŒ‡å®šæƒé™</code>ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ¹ æœåŠ¡åˆ—è¡¨ç”¨æ¥<code>è®°å½• init è¿›ç¨‹éœ€è¦å¯åŠ¨çš„ä¸€äº›å­è¿›ç¨‹</code>ï¼Œå¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œservice å…³é”®å­—åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºæœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰çš„åç§°ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºæœåŠ¡çš„æ‰§è¡Œè·¯å¾„ã€‚</p><h2 id="4-4-Parser"><a href="#4-4-Parser" class="headerlink" title="4.4 Parser"></a>4.4 Parser</h2><p>å›åˆ° LoadBootScripts()ã€€å‡½æ•°ä¸­ï¼Œå®é™…è§£æ init.rc çš„æºç å¦‚ä¸‹ï¼ˆå›é¡¾ï¼‰ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>ActionManager<span class="token operator">&amp;</span> action_manager<span class="token punctuation">,</span> ServiceList<span class="token operator">&amp;</span> service_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ›å»ºè§£æå™¨ parser</span>    Parser parser <span class="token operator">=</span> <span class="token function">CreateParser</span><span class="token punctuation">(</span>action_manager<span class="token punctuation">,</span> service_list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ bootscript</span>    std<span class="token operator">:</span><span class="token operator">:</span>string bootscript <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.boot.init_rc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰ bootscriptï¼Œåˆ™è§£æ init.rc æ–‡ä»¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootscript<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ã€€           <span class="token comment" spellcheck="true">// 8.0ã€€å¼•å…¥</span>        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/init.rc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// å¼€å§‹å®é™…çš„è§£æè¿‡ç¨‹</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h3 id="4-4-1-CreateParser"><a href="#4-4-1-CreateParser" class="headerlink" title="4.4.1 CreateParser"></a>4.4.1 CreateParser</h3><pre class=" language-java"><code class="language-java">Parser <span class="token function">CreateParser</span><span class="token punctuation">(</span>ActionManager<span class="token operator">&amp;</span> action_manager<span class="token punctuation">,</span> ServiceList<span class="token operator">&amp;</span> service_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parser parser<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¢åŠ  ServiceParser ä¸ºä¸€ä¸ª sectionï¼Œå¯¹åº” name ä¸º service</span>    parser<span class="token punctuation">.</span><span class="token function">AddSectionParser</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>ServiceParser<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>service_list<span class="token punctuation">,</span> subcontexts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¢åŠ  ActionParser ä¸ºä¸€ä¸ª sectionï¼Œå¯¹åº” name ä¸º action</span>    parser<span class="token punctuation">.</span><span class="token function">AddSectionParser</span><span class="token punctuation">(</span><span class="token string">"on"</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>ActionParser<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>action_manager<span class="token punctuation">,</span> subcontexts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¢åŠ  ImportParser ä¸ºä¸€ä¸ª sectionï¼Œå¯¹åº” name ä¸º import</span>    parser<span class="token punctuation">.</span><span class="token function">AddSectionParser</span><span class="token punctuation">(</span><span class="token string">"import"</span><span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>ImportParser<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> parser<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>åˆå§‹åŒ– ServiceParser ç”¨æ¥è§£æ â€œserviceâ€ å—ï¼ŒActionParser ç”¨æ¥è§£æ â€œonâ€ å—ï¼ŒImportParser ç”¨æ¥è§£æ â€œimportâ€ å—ã€‚</p><h3 id="4-4-2-ParseConfig"><a href="#4-4-2-ParseConfig" class="headerlink" title="4.4.2 ParseConfig"></a>4.4.2 ParseConfig</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ ParseConfig()ã€€å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token operator">/</span>system<span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token operator">/</span>parser<span class="token punctuation">.</span>cppbool Parser<span class="token operator">:</span><span class="token operator">:</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>    size_t parse_errors<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">ParseConfig</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parse_errors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ç»§ç»­è·Ÿè¸ªæºç ï¼š</p><pre class=" language-java"><code class="language-java">bool Parser<span class="token operator">:</span><span class="token operator">:</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> size_t<span class="token operator">*</span> parse_errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">*</span>parse_errors <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­ä¼ å…¥å‚æ•°æ˜¯å¦ä¸ºç›®å½•åœ°å€</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_dir</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// é€’å½’ç›®å½•ï¼Œæœ€ç»ˆè¿˜æ˜¯é  ParseConfigFile æ¥è§£æå®é™…çš„æ–‡ä»¶</span>        <span class="token keyword">return</span> <span class="token function">ParseConfigDir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> parse_errors<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ä¼ å…¥å‚æ•°ä¸ºæ–‡ä»¶åœ°å€</span>    <span class="token keyword">return</span> <span class="token function">ParseConfigFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> parse_errors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="4-4-3-ParseConfigDir"><a href="#4-4-3-ParseConfigDir" class="headerlink" title="4.4.3 ParseConfigDir"></a>4.4.3 ParseConfigDir</h3><pre class=" language-java"><code class="language-java">bool Parser<span class="token operator">:</span><span class="token operator">:</span><span class="token function">ParseConfigDir</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> size_t<span class="token operator">*</span> parse_errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Parsing directory "</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"..."</span><span class="token punctuation">;</span>    std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>DIR<span class="token punctuation">,</span> <span class="token function">decltype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>closedir<span class="token punctuation">)</span><span class="token operator">></span> <span class="token function">config_dir</span><span class="token punctuation">(</span><span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> closedir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config_dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not import directory '"</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"'"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// é€’å½’ç›®å½•ï¼Œå¾—åˆ°éœ€è¦å¤„ç†çš„æ–‡ä»¶</span>    dirent<span class="token operator">*</span> current_file<span class="token punctuation">;</span>    std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">></span> files<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>current_file <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>config_dir<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Ignore directories and only process regular files.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>current_file<span class="token operator">-</span><span class="token operator">></span>d_type <span class="token operator">==</span> DT_REG<span class="token punctuation">)</span> <span class="token punctuation">{</span>            std<span class="token operator">:</span><span class="token operator">:</span>string current_path <span class="token operator">=</span>                android<span class="token operator">:</span><span class="token operator">:</span>base<span class="token operator">:</span><span class="token operator">:</span><span class="token function">StringPrintf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current_file<span class="token operator">-</span><span class="token operator">></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>            files<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>current_path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Sort first so we load files in a consistent order (bug 31996208)</span>    std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> files<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å®¹æ˜“çœ‹å‡ºï¼Œæœ€ç»ˆä»æ˜¯è°ƒç”¨ ParseConfigFileã€€å‡½æ•°</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParseConfigFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> parse_errors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"could not import file '"</span> <span class="token operator">&lt;&lt;</span> file <span class="token operator">&lt;&lt;</span> <span class="token string">"'"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="4-4-4-ParseConfigFile"><a href="#4-4-4-ParseConfigFile" class="headerlink" title="4.4.4 ParseConfigFile"></a>4.4.4 ParseConfigFile</h3><pre class=" language-java"><code class="language-java">bool Parser<span class="token operator">:</span><span class="token operator">:</span><span class="token function">ParseConfigFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span> size_t<span class="token operator">*</span> parse_errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Parsing file "</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"..."</span><span class="token punctuation">;</span>    android<span class="token operator">:</span><span class="token operator">:</span>base<span class="token operator">:</span><span class="token operator">:</span>Timer t<span class="token punctuation">;</span>    auto config_contents <span class="token operator">=</span> <span class="token function">ReadFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è¯»å–è·¯å¾„æŒ‡å®šæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œä¿å­˜ä¸ºå­—ç¬¦ä¸²å½¢å¼</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config_contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unable to read config file '"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    config_contents<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// TODO: fix parse_config.</span>    <span class="token function">ParseData</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">*</span>config_contents<span class="token punctuation">,</span> parse_errors<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è§£æè·å–çš„å­—ç¬¦ä¸²</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> <span class="token punctuation">[</span>section_name<span class="token punctuation">,</span> section_parser<span class="token punctuation">]</span> <span class="token operator">:</span> section_parsers_<span class="token punctuation">)</span> <span class="token punctuation">{</span>        section_parser<span class="token operator">-</span><span class="token operator">></span><span class="token function">EndFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">LOG</span><span class="token punctuation">(</span>VERBOSE<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"(Parsing "</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">" took "</span> <span class="token operator">&lt;&lt;</span> t <span class="token operator">&lt;&lt;</span> <span class="token string">".)"</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å¯ä»¥å‘ç°ï¼Œ<code>ParseConfigFile</code> åªæ˜¯è¯»å–æ–‡ä»¶çš„å†…å®¹å¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå®é™…çš„è§£æå·¥ä½œè¢«äº¤ä»˜ç»™ <code>ParseData()</code>ï¼</p><h2 id="4-5-ParseData"><a href="#4-5-ParseData" class="headerlink" title="4.5 ParseData"></a>4.5 ParseData</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> Parser<span class="token operator">:</span><span class="token operator">:</span><span class="token function">ParseData</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> size_t<span class="token operator">*</span> parse_errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// TODO: Use a parser with const input and remove this copy</span>    <span class="token comment" spellcheck="true">// copy ä¸€æ³¢æ•°æ®</span>    std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> <span class="token function">data_copy</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data_copy<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è§£æç”¨çš„ç»“æ„ä½“</span>    parse_state state<span class="token punctuation">;</span>    state<span class="token punctuation">.</span>line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    state<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>data_copy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    state<span class="token punctuation">.</span>nexttoken <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// next_token ä»¥è¡Œä¸ºå•ä½åˆ†å‰²å‚æ•°ä¼ é€’è¿‡æ¥çš„å­—ç¬¦ä¸²ï¼Œåˆå§‹æ²¡æœ‰åˆ†å‰²ç¬¦æ—¶ï¼Œæœ€å…ˆèµ°åˆ° T_TEXT åˆ†æ”¯</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">next_token</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> T_EOF<span class="token operator">:</span>                <span class="token function">end_section</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// è§£æç»“æŸ</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> T_NEWLINE<span class="token operator">:</span>                state<span class="token punctuation">.</span>line<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token comment" spellcheck="true">// åœ¨å‰æ–‡åˆ›å»º parser æ—¶ï¼Œæˆ‘ä»¬ä¸º serviceï¼Œonï¼Œimport å®šä¹‰äº†å¯¹åº”çš„ parser</span>                <span class="token comment" spellcheck="true">// è¿™é‡Œå°±æ˜¯æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„ parser</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>section_parsers_<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// ç»“æŸä¸Šä¸€ä¸ª parser çš„å·¥ä½œ</span>                    <span class="token function">end_section</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è·å–å‚æ•°å¯¹åº”çš„ parser</span>                    section_parser <span class="token operator">=</span> section_parsers_<span class="token punctuation">[</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    section_start_line <span class="token operator">=</span> state<span class="token punctuation">.</span>line<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// è°ƒç”¨å®é™… parser çš„ ParseSection å‡½æ•°</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>auto result <span class="token operator">=</span> section_parser<span class="token operator">-</span><span class="token operator">></span><span class="token function">ParseSection</span><span class="token punctuation">(</span>                                              std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> state<span class="token punctuation">.</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token punctuation">(</span><span class="token operator">*</span>parse_errors<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>                        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> filename <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> state<span class="token punctuation">.</span>line <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>                        section_parser <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>section_parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">/*                      * å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯serviceï¼Œonï¼Œimport                     * åˆ™è°ƒç”¨å‰ä¸€ä¸ªparserçš„ParseLineSectionå‡½æ•°                     * è¿™é‡Œç›¸å½“äºè§£æä¸€ä¸ªå‚æ•°å—çš„å­é¡¹                     */</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>auto result <span class="token operator">=</span> section_parser<span class="token operator">-</span><span class="token operator">></span><span class="token function">ParseLineSection</span><span class="token punctuation">(</span>                                              std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token punctuation">(</span><span class="token operator">*</span>parse_errors<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>                        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> filename <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> state<span class="token punctuation">.</span>line <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// æ¸…ç©ºæœ¬æ¬¡è§£æçš„æ•°æ®</span>                args<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> T_TEXT<span class="token operator">:</span>                <span class="token comment" spellcheck="true">// å°†æœ¬æ¬¡è§£æçš„å†…å®¹å†™å…¥åˆ° args ä¸­</span>                args<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢çš„ä»£ç çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä½†å®é™…ä¸Šå°±æ˜¯é¢å‘å¯¹è±¡ï¼Œæ ¹æ®ä¸åŒçš„å…³é”®å­—ï¼Œä½¿ç”¨ä¸åŒçš„ parser å¯¹è±¡è¿›è¡Œè§£æã€‚</p><p><strong><font color="#FF0000">è‡³æ­¤ï¼Œinit.rcè§£æå®Œï¼</font></strong></p><h1 id="äº”ã€ç¬¬å››é˜¶æ®µ"><a href="#äº”ã€ç¬¬å››é˜¶æ®µ" class="headerlink" title="äº”ã€ç¬¬å››é˜¶æ®µ"></a>äº”ã€ç¬¬å››é˜¶æ®µ</h1><h2 id="5-1-å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶ä»–-action"><a href="#5-1-å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶ä»–-action" class="headerlink" title="5.1 å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶ä»– action"></a>5.1 å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶ä»– action</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 03. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 04. åˆ›å»º epoll å¥æŸ„ */</span>    <span class="token comment" spellcheck="true">/* 05. è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨ */</span>    <span class="token comment" spellcheck="true">/* 06. å¯åŠ¨å±æ€§æœåŠ¡*/</span>    <span class="token comment" spellcheck="true">/* 07. åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³» */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸‰é˜¶æ®µ ----------- BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* initè§£æ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸‰é˜¶æ®µ -----------  END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬å››é˜¶æ®µ ----------- BEGIN------------ */</span>        <span class="token comment" spellcheck="true">// init æ‰§è¡Œå‘½ä»¤è§¦å‘å™¨ä¸»è¦åˆ†ä¸º early-initï¼Œinitï¼Œlate-initï¼Œboot ç­‰</span>    <span class="token comment" spellcheck="true">// æ·»åŠ è§¦å‘å™¨ early-initï¼Œæ‰§è¡Œ on early-init å†…å®¹</span>    am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"early-init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>wait_for_coldboot_done_action<span class="token punctuation">,</span> <span class="token string">"wait_for_coldboot_done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ... so that we can start queuing up actions that require stuff from /dev.</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>MixHwrngIntoLinuxRngAction<span class="token punctuation">,</span> <span class="token string">"MixHwrngIntoLinuxRng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>SetMmapRndBitsAction<span class="token punctuation">,</span> <span class="token string">"SetMmapRndBits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>SetKptrRestrictAction<span class="token punctuation">,</span> <span class="token string">"SetKptrRestrict"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>keychord_init_action<span class="token punctuation">,</span> <span class="token string">"keychord_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>console_init_action<span class="token punctuation">,</span> <span class="token string">"console_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Trigger all the boot actions to get us started.</span>    <span class="token comment" spellcheck="true">// æ·»åŠ è§¦å‘å™¨ initï¼Œæ‰§è¡Œ on init å†…å®¹ï¼Œä¸»è¦åŒ…æ‹¬åˆ›å»º/æŒ‚åœ¨ä¸€äº›ç›®å½•ï¼Œä»¥åŠ symlink ç­‰</span>    am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span>    <span class="token comment" spellcheck="true">// wasn't ready immediately after wait_for_coldboot_done</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>MixHwrngIntoLinuxRngAction<span class="token punctuation">,</span> <span class="token string">"MixHwrngIntoLinuxRng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Don't mount filesystems or start core system services in charger mode.</span>    std<span class="token operator">:</span><span class="token operator">:</span>string bootmode <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.bootmode"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootmode <span class="token operator">==</span> <span class="token string">"charger"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"charger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// on chargeré˜¶æ®µ</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"late-init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// éå……ç”µæ¨¡å¼æ·»åŠ è§¦å‘å™¨ last-init</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Run all property triggers based on current state of the properties.</span>    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>queue_property_triggers_action<span class="token punctuation">,</span> <span class="token string">"queue_property_triggers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="5-2-å‰©ä½™å·¥ä½œ"><a href="#5-2-å‰©ä½™å·¥ä½œ" class="headerlink" title="5.2 å‰©ä½™å·¥ä½œ"></a>5.2 å‰©ä½™å·¥ä½œ</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆ¤æ–­åŠå¢åŠ ç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 02. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›®å½•å¹¶æŒ‚è½½ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 03. é‡å®šå‘è¾“å…¥è¾“å‡º/å†…æ ¸ Log ç³»ç»Ÿ */</span>    <span class="token comment" spellcheck="true">/* 04. æŒ‚è½½ä¸€äº›åˆ†åŒºè®¾å¤‡ */</span>    <span class="token comment" spellcheck="true">/* 05. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 06. is_first_stage æ”¶å°¾ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸€é˜¶æ®µ ------------- END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. åˆå§‹åŒ–å±æ€§åŸŸ */</span>    <span class="token comment" spellcheck="true">/* 02. æ¸…ç©ºç¯å¢ƒå˜é‡ */</span>    <span class="token comment" spellcheck="true">/* 03. å®Œæˆ SELinux ç›¸å…³å·¥ä½œ */</span>    <span class="token comment" spellcheck="true">/* 04. åˆ›å»º epoll å¥æŸ„ */</span>    <span class="token comment" spellcheck="true">/* 05. è£…è½½å­è¿›ç¨‹ä¿¡å·å¤„ç†å™¨ */</span>    <span class="token comment" spellcheck="true">/* 06. å¯åŠ¨å±æ€§æœåŠ¡*/</span>    <span class="token comment" spellcheck="true">/* 07. åŒ¹é…å‘½ä»¤å’Œå‡½æ•°ä¹‹é—´å¯¹åº”å…³ç³» */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬äºŒé˜¶æ®µ ------------ END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸‰é˜¶æ®µ ----------- BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* initè§£æ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬ä¸‰é˜¶æ®µ -----------  END ------------ */</span>    <span class="token comment" spellcheck="true">/* ------------ ç¬¬å››é˜¶æ®µ ----------- BEGIN------------ */</span>    <span class="token comment" spellcheck="true">/* 01. å‘æ‰§è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å…¶ä»–action */</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶éœ€è¦å¤„ç†</span>        <span class="token comment" spellcheck="true">// By default, sleep until something happens.</span>        <span class="token keyword">int</span> epoll_timeout_ms <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>do_shutdown <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shutting_down<span class="token punctuation">)</span> <span class="token punctuation">{</span>            do_shutdown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HandlePowerctlMessage</span><span class="token punctuation">(</span>shutdown_command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                shutting_down <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>waiting_for_prop <span class="token operator">||</span> Service<span class="token operator">:</span><span class="token operator">:</span><span class="token function">is_exec_service_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ä¾æ¬¡æ‰§è¡Œæ¯ä¸ª action ä¸­æºå¸¦ command å¯¹åº”çš„æ‰§è¡Œå‡½æ•°</span>            am<span class="token punctuation">.</span><span class="token function">ExecuteOneCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>waiting_for_prop <span class="token operator">||</span> Service<span class="token operator">:</span><span class="token operator">:</span><span class="token function">is_exec_service_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shutting_down<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// é‡å¯ä¸€äº›æŒ‚æ‰çš„è¿›ç¨‹</span>                auto next_process_restart_time <span class="token operator">=</span> <span class="token function">RestartProcesses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// If there's a process that needs restarting, wake up in time for that.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>next_process_restart_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    epoll_timeout_ms <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span>chrono<span class="token operator">:</span><span class="token operator">:</span>ceil<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>chrono<span class="token operator">:</span><span class="token operator">:</span>milliseconds<span class="token operator">></span><span class="token punctuation">(</span>                                           <span class="token operator">*</span>next_process_restart_time <span class="token operator">-</span> boot_clock<span class="token operator">:</span><span class="token operator">:</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                           <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoll_timeout_ms <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> epoll_timeout_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// If there's more work to do, wake up again immediately.</span>            <span class="token comment" spellcheck="true">// æœ‰ action å¾…å¤„ç†ï¼Œä¸ç­‰å¾…</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">HasMoreCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> epoll_timeout_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        epoll_event ev<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ²¡æœ‰äº‹ä»¶åˆ°æ¥çš„è¯ï¼Œæœ€å¤šé˜»å¡timeoutæ—¶é—´</span>        <span class="token keyword">int</span> nr <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">epoll_wait</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> epoll_timeout_ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_wait failed"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nr <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//æœ‰äº‹ä»¶åˆ°æ¥ï¼Œæ‰§è¡Œå¯¹åº”å¤„ç†å‡½æ•°</span>            <span class="token comment" spellcheck="true">//æ ¹æ®ä¸Šæ–‡çŸ¥é“ï¼Œepoll å¥æŸ„ï¼ˆå³ epoll_fd ï¼‰ä¸»è¦ç›‘å¬å­è¿›ç¨‹ç»“æŸï¼ŒåŠå…¶å®ƒè¿›ç¨‹è®¾ç½®ç³»ç»Ÿå±æ€§çš„è¯·æ±‚</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// end main</span></code></pre><p>è‡³æ­¤ï¼ŒInit.cpp çš„ main å‡½æ•°åˆ†æå®Œæ¯•ï¼init è¿›ç¨‹å·²ç»å¯åŠ¨å®Œæˆï¼Œä¸€äº›é‡è¦çš„æœåŠ¡å¦‚ core æœåŠ¡å’Œ main æœåŠ¡ä¹Ÿéƒ½å¯åŠ¨èµ·æ¥ï¼Œå¹¶å¯åŠ¨äº† zygoteï¼ˆ/system/bin/app_process64ï¼‰è¿›ç¨‹ï¼Œzygote åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºè™šæ‹Ÿæœºï¼Œå¯åŠ¨ systemserver ç­‰ï¼</p><hr><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://blog.csdn.net/gaugamela/article/details/79280385" target="_blank" rel="noopener">Android O: initè¿›ç¨‹å¯åŠ¨æµç¨‹åˆ†æ(é˜¶æ®µä¸€)</a><br>&nbsp;ğŸ“• 02. <a href="https://blog.csdn.net/yangwen123/article/details/9029959" target="_blank" rel="noopener">Android Initè¿›ç¨‹æºç åˆ†æ</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2018/12/10/%E3%80%90%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E3%80%91Android%20%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E9%92%BB%E7%A0%94%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20zygote/">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygote</a></p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿå¯åŠ¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯åŠ¨é˜¶æ®µ </tag>
            
            <tag> init </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ Binderï¼ˆåŸºç¡€ç¯‡ï¼‰</title>
      <link href="/2018/11/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhu-zhi-binder-ji-chu-pian/"/>
      <url>/2018/11/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhu-zhi-binder-ji-chu-pian/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€Binder-æ¦‚è¿°"><a href="#ä¸€ã€Binder-æ¦‚è¿°" class="headerlink" title="ä¸€ã€Binder æ¦‚è¿°"></a>ä¸€ã€Binder æ¦‚è¿°</h1><p>Binder æ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼ŒåŸºäºå¼€æºçš„ OpenBinder å®ç°ï¼›OpenBinder èµ·åˆç”± Be Inc. å¼€å‘ï¼Œåç”± Plam Inc. æ¥æ‰‹ã€‚ä»å­—é¢ä¸Šæ¥è§£é‡Š Binder æœ‰èƒ¶æ°´ã€ç²˜åˆå‰‚çš„æ„æ€ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ç²˜å’Œä¸åŒçš„è¿›ç¨‹ï¼Œä½¿ä¹‹å®ç°é€šä¿¡ã€‚</p><h2 id="1-1-ä¸ºä»€ä¹ˆè¦ç†è§£-Binderï¼Ÿ"><a href="#1-1-ä¸ºä»€ä¹ˆè¦ç†è§£-Binderï¼Ÿ" class="headerlink" title="1.1 ä¸ºä»€ä¹ˆè¦ç†è§£ Binderï¼Ÿ"></a>1.1 ä¸ºä»€ä¹ˆè¦ç†è§£ Binderï¼Ÿ</h2><p>ä¸€èˆ¬ Android åº”ç”¨å¼€å‘å¾ˆå°‘ç›´æ¥ç”¨åˆ°è·¨è¿›ç¨‹ä¿¡é€šä¿¡ï¼ˆIPCï¼‰ï¼Œä½†å¦‚æœä½ æƒ³çŸ¥é“ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° &nbsp;App æ˜¯å¦‚ä½•å¯åŠ¨å¹¶åˆå§‹åŒ–çš„ï¼Ÿ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° &nbsp;Activity çš„å¯åŠ¨è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° &nbsp;è¿›ç¨‹é—´æ˜¯å¦‚ä½•é€šä¿¡çš„ï¼Ÿ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° &nbsp;AIDL çš„å…·ä½“åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° &nbsp;ä¼—å¤šæ’ä»¶åŒ–æ¡†æ¶çš„è®¾è®¡åŸç†ç­‰ç­‰â€¦</p><p>è¿™äº›é—®é¢˜çš„èƒŒåéƒ½ä¸ Binder æœ‰è«å¤§çš„å…³ç³»ï¼Œè¦å¼„æ‡‚ä¸Šé¢è¿™äº›é—®é¢˜ï¼Œç†è§£ Binder é€šä¿¡æœºåˆ¶æ˜¯å¿…é¡»çš„ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ Android åº”ç”¨ç¨‹åºæ˜¯ç”± Activityã€Serviceã€Broadcast Receiver å’Œ Content Provide å››å¤§ç»„ä»¶ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªç»„æˆçš„ã€‚æœ‰æ—¶è¿™äº›ç»„ä»¶è¿è¡Œåœ¨åŒä¸€è¿›ç¨‹ï¼Œæœ‰æ—¶è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ã€‚è¿™äº›è¿›ç¨‹é—´çš„é€šä¿¡å°±ä¾èµ–äº Binder IPC æœºåˆ¶ã€‚</p><p>ä¸ä»…å¦‚æ­¤ï¼ŒAndroid ç³»ç»Ÿå¯¹åº”ç”¨å±‚æä¾›çš„å„ç§æœåŠ¡å¦‚ï¼šActivityManagerServiceã€PackageManagerService ç­‰éƒ½æ˜¯åŸºäº Binder IPC æœºåˆ¶æ¥å®ç°çš„ã€‚Binder æœºåˆ¶åœ¨ Android ä¸­çš„ä½ç½®éå¸¸é‡è¦ï¼Œæ¯«ä¸å¤¸å¼ çš„è¯´ç†è§£ Binder æ˜¯è¿ˆå‘ Android é«˜çº§å·¥ç¨‹çš„ç¬¬ä¸€æ­¥ã€‚</p><h2 id="1-2-ä¸ºä»€ä¹ˆé€‰æ‹©-Binder"><a href="#1-2-ä¸ºä»€ä¹ˆé€‰æ‹©-Binder" class="headerlink" title="1.2 ä¸ºä»€ä¹ˆé€‰æ‹© Binder ?"></a>1.2 ä¸ºä»€ä¹ˆé€‰æ‹© Binder ?</h2><p>Android ç³»ç»Ÿæ˜¯åŸºäº Linux å†…æ ¸çš„ï¼ŒLinux å·²ç»æä¾›äº† <font color="#87CEFA">ç®¡é“</font>ã€<font color="#87CEFA">æ¶ˆæ¯é˜Ÿåˆ—</font>ã€<font color="#87CEFA">å…±äº«å†…å­˜</font> å’Œ <font color="#87CEFA">Socket</font> ç­‰ IPC æœºåˆ¶ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆ Android è¿˜è¦æä¾› <font color="#0000CD">Binder</font> æ¥å®ç° IPC å‘¢ï¼Ÿä¸»è¦æ˜¯åŸºäº <font color="#0000CD">æ€§èƒ½</font>ã€<font color="#0000CD">ç¨³å®šæ€§</font> å’Œ <font color="#0000CD">å®‰å…¨æ€§</font> å‡ æ–¹é¢çš„åŸå› ï¼</p><h3 id="1-2-1-æ€§èƒ½"><a href="#1-2-1-æ€§èƒ½" class="headerlink" title="1.2.1 æ€§èƒ½"></a>1.2.1 æ€§èƒ½</h3><p>é¦–å…ˆè¯´è¯´æ€§èƒ½ä¸Šçš„ä¼˜åŠ¿ã€‚</p><p><font color="#FF0000">Socket</font>ï¼šä½œä¸ºä¸€æ¬¾é€šç”¨æ¥å£ï¼Œå…¶ä¼ è¾“æ•ˆç‡ä½ï¼Œå¼€é”€å¤§ï¼Œä¸»è¦ç”¨åœ¨è·¨ç½‘ç»œçš„è¿›ç¨‹é—´é€šä¿¡å’Œæœ¬æœºä¸Šè¿›ç¨‹é—´çš„ä½é€Ÿé€šä¿¡ã€‚</p><p><font color="#FF0000">æ¶ˆæ¯é˜Ÿåˆ—å’Œç®¡é“</font>ï¼šé‡‡ç”¨å­˜å‚¨-è½¬å‘æ–¹å¼ï¼Œå³æ•°æ®å…ˆä»å‘é€æ–¹ç¼“å­˜åŒºæ‹·è´åˆ°å†…æ ¸å¼€è¾Ÿçš„ç¼“å­˜åŒºä¸­ï¼Œç„¶åå†ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶æ–¹ç¼“å­˜åŒºï¼Œè‡³å°‘æœ‰ä¸¤æ¬¡æ‹·è´è¿‡ç¨‹ã€‚</p><p><font color="#FF0000">å…±äº«å†…å­˜</font>ï¼šè™½ç„¶æ— éœ€æ‹·è´ï¼Œä½†æ§åˆ¶å¤æ‚ï¼Œéš¾ä»¥ä½¿ç”¨ã€‚</p><p><font color="#FF0000">Binder</font>ï¼šåªéœ€è¦ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œæ€§èƒ½ä¸Šä»…æ¬¡äºå…±äº«å†…å­˜ã€‚</p><table><thead><tr><th>IPCæœºåˆ¶</th><th>æ•°æ®æ‹·è´æ¬¡æ•°</th></tr></thead><tbody><tr><td>å…±äº«å†…å­˜</td><td>0</td></tr><tr><td>Binder</td><td>1</td></tr><tr><td>ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€Socket</td><td>2</td></tr></tbody></table><h3 id="1-2-2-ç¨³å®šæ€§"><a href="#1-2-2-ç¨³å®šæ€§" class="headerlink" title="1.2.2 ç¨³å®šæ€§"></a>1.2.2 ç¨³å®šæ€§</h3><p>å†è¯´è¯´ç¨³å®šæ€§ï¼ŒBinder åŸºäº C/S æ¶æ„ï¼Œå®¢æˆ·ç«¯ï¼ˆClientï¼‰æœ‰ä»€ä¹ˆéœ€æ±‚å°±ä¸¢ç»™æœåŠ¡ç«¯ï¼ˆServerï¼‰å»å®Œæˆï¼Œæ¶æ„æ¸…æ™°ã€èŒè´£æ˜ç¡®åˆç›¸äº’ç‹¬ç«‹ï¼Œè‡ªç„¶ç¨³å®šæ€§æ›´å¥½ã€‚å…±äº«å†…å­˜è™½ç„¶æ— éœ€æ‹·è´ï¼Œä½†æ˜¯æ§åˆ¶è´Ÿè´£ï¼Œéš¾ä»¥ä½¿ç”¨ã€‚ä»ç¨³å®šæ€§çš„è§’åº¦è®²ï¼ŒBinder æœºåˆ¶æ˜¯ä¼˜äºå…±äº«å†…å­˜çš„ã€‚</p><h3 id="1-2-3-å®‰å…¨æ€§"><a href="#1-2-3-å®‰å…¨æ€§" class="headerlink" title="1.2.3 å®‰å…¨æ€§"></a>1.2.3 å®‰å…¨æ€§</h3><p>Android ä½œä¸ºä¸€ä¸ªå¼€æ”¾æ€§çš„å¹³å°ï¼Œå¸‚åœºä¸Šæœ‰å„ç±»æµ·é‡çš„åº”ç”¨ä¾›ç”¨æˆ·é€‰æ‹©å®‰è£…ï¼Œå› æ­¤å®‰å…¨æ€§å¯¹äº Android å¹³å°è€Œè¨€æå…¶é‡è¦ã€‚ä½œä¸ºç”¨æˆ·å½“ç„¶ä¸å¸Œæœ›æˆ‘ä»¬ä¸‹è½½çš„ APP å·å·è¯»å–æˆ‘çš„é€šä¿¡å½•ï¼Œä¸Šä¼ æˆ‘çš„éšç§æ•°æ®ï¼Œåå°å·è·‘æµé‡ã€æ¶ˆè€—æ‰‹æœºç”µé‡ã€‚ä¼ ç»Ÿçš„ IPC æ²¡æœ‰ä»»ä½•å®‰å…¨æªæ–½ï¼Œå®Œå…¨ä¾èµ–ä¸Šå±‚åè®®æ¥ç¡®ä¿ã€‚</p><p>é¦–å…ˆä¼ ç»Ÿçš„ IPC æ¥æ”¶æ–¹æ— æ³•è·å¾—å¯¹æ–¹å¯é çš„è¿›ç¨‹â€œç”¨æˆ·ID/è¿›ç¨‹IDâ€ï¼ˆUID/PIDï¼‰ï¼Œä»è€Œæ— æ³•é‰´åˆ«å¯¹æ–¹èº«ä»½ã€‚Android ä¸ºæ¯ä¸ªå®‰è£…å¥½çš„ APK åˆ†é…äº†è‡ªå·±çš„ UIDï¼Œæ•…è€Œè¿›ç¨‹çš„ UID æ˜¯é‰´åˆ«è¿›ç¨‹èº«ä»½çš„é‡è¦æ ‡å¿—ã€‚</p><p>ä¼ ç»Ÿçš„ IPC åªèƒ½ç”±ç”¨æˆ·åœ¨æ•°æ®åŒ…ä¸­å¡«å…¥ UID/PIDï¼Œä½†è¿™æ ·ä¸å¯é ï¼Œå®¹æ˜“è¢«æ¶æ„ç¨‹åºåˆ©ç”¨ã€‚å¯é çš„èº«ä»½æ ‡è¯†åªæœ‰ç”± IPC æœºåˆ¶åœ¨å†…æ ¸ä¸­æ·»åŠ ã€‚</p><p>å…¶æ¬¡ä¼ ç»Ÿçš„ IPC è®¿é—®æ¥å…¥ç‚¹æ˜¯å¼€æ”¾çš„ï¼Œåªè¦çŸ¥é“è¿™äº›æ¥å…¥ç‚¹çš„ç¨‹åºéƒ½å¯ä»¥å’Œå¯¹ç«¯å»ºç«‹è¿æ¥ï¼Œä¸ç®¡æ€æ ·éƒ½æ— æ³•é˜»æ­¢æ¶æ„ç¨‹åºé€šè¿‡çŒœæµ‹æ¥æ”¶æ–¹åœ°å€è·å¾—è¿æ¥ã€‚åŒæ—¶ Binder æ—¢æ”¯æŒå®å Binderï¼Œåˆæ”¯æŒåŒ¿å Binderï¼Œå®‰å…¨æ€§é«˜ã€‚</p><h1 id="äºŒã€ä¼ ç»Ÿ-IPC-é€šä¿¡åŸç†"><a href="#äºŒã€ä¼ ç»Ÿ-IPC-é€šä¿¡åŸç†" class="headerlink" title="äºŒã€ä¼ ç»Ÿ IPC é€šä¿¡åŸç†"></a>äºŒã€ä¼ ç»Ÿ IPC é€šä¿¡åŸç†</h1><p>äº†è§£ Linux IPC ç›¸å…³çš„æ¦‚å¿µå’ŒåŸç†æœ‰åŠ©äºæˆ‘ä»¬ç†è§£ Binder é€šä¿¡åŸç†ã€‚å› æ­¤ï¼Œåœ¨ä»‹ç» Binder è·¨è¿›ç¨‹é€šä¿¡åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠèŠ Linux ç³»ç»Ÿä¸‹ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡æ˜¯å¦‚ä½•å®ç°ã€‚</p><h2 id="2-1-åŸºç¡€æ¦‚å¿µ"><a href="#2-1-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="2.1 åŸºç¡€æ¦‚å¿µ"></a>2.1 åŸºç¡€æ¦‚å¿µ</h2><h3 id="2-1-1-è¿›ç¨‹éš”ç¦»"><a href="#2-1-1-è¿›ç¨‹éš”ç¦»" class="headerlink" title="2.1.1 è¿›ç¨‹éš”ç¦»"></a>2.1.1 è¿›ç¨‹éš”ç¦»</h3><p>ç®€å•çš„è¯´å°±æ˜¯æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹ä¸è¿›ç¨‹é—´å†…å­˜æ˜¯ä¸å…±äº«çš„ã€‚ä¸¤ä¸ªè¿›ç¨‹å°±åƒä¸¤ä¸ªå¹³è¡Œçš„ä¸–ç•Œï¼ŒA è¿›ç¨‹æ²¡æ³•ç›´æ¥è®¿é—® B è¿›ç¨‹çš„æ•°æ®ï¼Œè¿™å°±æ˜¯è¿›ç¨‹éš”ç¦»çš„é€šä¿—è§£é‡Šã€‚A è¿›ç¨‹å’Œ B è¿›ç¨‹ä¹‹é—´è¦è¿›è¡Œæ•°æ®äº¤äº’å°±å¾—é‡‡ç”¨ç‰¹æ®Šçš„é€šä¿¡æœºåˆ¶ï¼š<font color="#0000CD">è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰</font>ã€‚</p><h3 id="2-1-2-è¿›ç¨‹ç©ºé—´"><a href="#2-1-2-è¿›ç¨‹ç©ºé—´" class="headerlink" title="2.1.2 è¿›ç¨‹ç©ºé—´"></a>2.1.2 è¿›ç¨‹ç©ºé—´</h3><p>ç°åœ¨æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨çš„è™šæ‹Ÿå­˜å‚¨å™¨ï¼Œå¯¹äº 32 ä½ç³»ç»Ÿè€Œè¨€ï¼Œå®ƒçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰å°±æ˜¯ 2 çš„ 32 æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯ 4GBã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿå¯ä»¥è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æƒé™ã€‚ä¸ºäº†ä¿æŠ¤ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ï¼Œä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œæ“ä½œç³»ç»Ÿä»é€»è¾‘ä¸Šå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†ä¸ºç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰å’Œå†…æ ¸ç©ºé—´ï¼ˆKernel Spaceï¼‰ã€‚é’ˆå¯¹ Linux æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå°†æœ€é«˜çš„ 1GB å­—èŠ‚ä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼›è¾ƒä½çš„ 3GB å­—èŠ‚ä¾›å„è¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚</p><h3 id="2-1-3-ç³»ç»Ÿè°ƒç”¨"><a href="#2-1-3-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="2.1.3 ç³»ç»Ÿè°ƒç”¨"></a>2.1.3 ç³»ç»Ÿè°ƒç”¨</h3><p>è™½ç„¶ä»é€»è¾‘ä¸Šè¿›è¡Œäº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„åˆ’åˆ†ï¼Œä½†ä¸å¯é¿å…çš„ç”¨æˆ·ç©ºé—´éœ€è¦è®¿é—®å†…æ ¸èµ„æºï¼Œæ¯”å¦‚æ–‡ä»¶æ“ä½œã€è®¿é—®ç½‘ç»œç­‰ç­‰ã€‚ä¸ºäº†çªç ´éš”ç¦»é™åˆ¶ï¼Œå°±éœ€è¦å€ŸåŠ©ç³»ç»Ÿè°ƒç”¨æ¥å®ç°ã€‚<font color="#FF0000">ç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æˆ·ç©ºé—´è®¿é—®å†…æ ¸ç©ºé—´çš„å”¯ä¸€æ–¹å¼</font>ï¼Œä¿è¯äº†æ‰€æœ‰çš„èµ„æºè®¿é—®éƒ½æ˜¯åœ¨å†…æ ¸çš„æ§åˆ¶ä¸‹è¿›è¡Œçš„ï¼Œé¿å…äº†ç”¨æˆ·ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„è¶Šæƒè®¿é—®ï¼Œæå‡äº†ç³»ç»Ÿå®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</p><p>Linux ä½¿ç”¨ä¸¤çº§ä¿æŠ¤æœºåˆ¶ï¼š0 çº§ä¾›ç³»ç»Ÿå†…æ ¸ä½¿ç”¨ï¼Œ3 çº§ä¾›ç”¨æˆ·ç¨‹åºä½¿ç”¨ã€‚</p><p>å½“ä¸€ä¸ªä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è€Œé™·å…¥å†…æ ¸ä»£ç ä¸­æ‰§è¡Œæ—¶ï¼Œç§°è¿›ç¨‹å¤„äºå†…æ ¸è¿è¡Œæ€ï¼ˆå†…æ ¸æ€ï¼‰ã€‚æ­¤æ—¶å¤„ç†å™¨å¤„äºç‰¹æƒçº§æœ€é«˜çš„ï¼ˆ0çº§ï¼‰å†…æ ¸ä»£ç ä¸­æ‰§è¡Œã€‚å½“è¿›ç¨‹å¤„äºå†…æ ¸æ€æ—¶ï¼Œæ‰§è¡Œçš„å†…æ ¸ä»£ç ä¼šä½¿ç”¨å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å†…æ ¸æ ˆã€‚</p><p>å½“è¿›ç¨‹åœ¨æ‰§è¡Œç”¨æˆ·è‡ªå·±çš„ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç§°å…¶å¤„äºç”¨æˆ·è¿è¡Œæ€ï¼ˆç”¨æˆ·æ€ï¼‰ã€‚æ­¤æ—¶å¤„ç†å™¨åœ¨ç‰¹æƒçº§æœ€ä½çš„ï¼ˆ3çº§ï¼‰ç”¨æˆ·ä»£ç ä¸­è¿è¡Œã€‚</p><h2 id="2-2-IPC-é€šä¿¡åŸç†"><a href="#2-2-IPC-é€šä¿¡åŸç†" class="headerlink" title="2.2 IPC é€šä¿¡åŸç†"></a>2.2 IPC é€šä¿¡åŸç†</h2><p>ç†è§£äº†ä¸Šé¢çš„å‡ ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ä¼ ç»Ÿçš„ IPC æ–¹å¼ä¸­ï¼Œè¿›ç¨‹ä¹‹é—´æ˜¯å¦‚ä½•å®ç°é€šä¿¡çš„ã€‚</p><p>é€šå¸¸çš„åšæ³•æ˜¯æ¶ˆæ¯å‘é€æ–¹å°†è¦å‘é€çš„æ•°æ®å­˜æ”¾åœ¨å†…å­˜ç¼“å­˜åŒºä¸­ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ€ã€‚ç„¶åå†…æ ¸ç¨‹åºåœ¨å†…æ ¸ç©ºé—´åˆ†é…å†…å­˜ï¼Œå¼€è¾Ÿä¸€å—å†…æ ¸ç¼“å­˜åŒºï¼Œè°ƒç”¨ <font color="#FF0000">copyfromuser()</font> å‡½æ•°å°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´çš„å†…å­˜ç¼“å­˜åŒºæ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„å†…æ ¸ç¼“å­˜åŒºä¸­ã€‚åŒæ ·çš„ï¼Œæ¥æ”¶æ–¹è¿›ç¨‹åœ¨æ¥æ”¶æ•°æ®æ—¶åœ¨è‡ªå·±çš„ç”¨æˆ·ç©ºé—´å¼€è¾Ÿä¸€å—å†…å­˜ç¼“å­˜åŒºï¼Œç„¶åå†…æ ¸ç¨‹åºè°ƒç”¨ <font color="#FF0000">copytouser()</font> å‡½æ•°å°†æ•°æ®ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶è¿›ç¨‹çš„å†…å­˜ç¼“å­˜åŒºã€‚è¿™æ ·æ•°æ®å‘é€æ–¹è¿›ç¨‹å’Œæ•°æ®æ¥æ”¶æ–¹è¿›ç¨‹å°±å®Œæˆäº†ä¸€æ¬¡æ•°æ®ä¼ è¾“ï¼Œæˆ‘ä»¬ç§°å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´é€šä¿¡ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹åŸç†å›¾ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-635752d9992aeeca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¼ ç»Ÿ IPC é€šä¿¡æ–¹å¼.png"></center><p>è¿™ç§ä¼ ç»Ÿçš„ IPC é€šä¿¡æ–¹å¼æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp;1ã€æ€§èƒ½ä½ä¸‹ï¼Œä¸€æ¬¡æ•°æ®ä¼ é€’éœ€è¦ç»å†ï¼šå†…å­˜ç¼“å­˜åŒº â€“&gt; å†…æ ¸ç¼“å­˜åŒº â€“&gt; å†…å­˜ç¼“å­˜åŒºï¼Œéœ€è¦ 2 æ¬¡æ•°æ®æ‹·è´ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp;2ã€æ¥æ”¶æ•°æ®çš„ç¼“å­˜åŒºç”±æ•°æ®æ¥æ”¶è¿›ç¨‹æä¾›ï¼Œä½†æ˜¯æ¥æ”¶è¿›ç¨‹å¹¶ä¸çŸ¥é“éœ€è¦å¤šå¤§çš„ç©ºé—´æ¥å­˜æ”¾å°†è¦ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œå› æ­¤åªèƒ½å¼€è¾Ÿå°½å¯èƒ½å¤§çš„å†…å­˜ç©ºé—´æˆ–è€…å…ˆè°ƒç”¨ API æ¥æ”¶æ¶ˆæ¯å¤´æ¥è·å–æ¶ˆæ¯ä½“çš„å¤§å°ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸¤ç§åšæ³•ä¸æ˜¯æµªè´¹ç©ºé—´å°±æ˜¯æµªè´¹æ—¶é—´ã€‚</p><h1 id="ä¸‰ã€Binder-è·¨è¿›ç¨‹é€šä¿¡åŸç†"><a href="#ä¸‰ã€Binder-è·¨è¿›ç¨‹é€šä¿¡åŸç†" class="headerlink" title="ä¸‰ã€Binder è·¨è¿›ç¨‹é€šä¿¡åŸç†"></a>ä¸‰ã€Binder è·¨è¿›ç¨‹é€šä¿¡åŸç†</h1><p>ç†è§£äº† Linux IPC ç›¸å…³æ¦‚å¿µå’Œé€šä¿¡åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ­£å¼ä»‹ç»ä¸‹ Binder IPC çš„åŸç†ã€‚</p><h2 id="3-1-åŠ¨æ€å†…æ ¸å¯åŠ è½½æ¨¡å—"><a href="#3-1-åŠ¨æ€å†…æ ¸å¯åŠ è½½æ¨¡å—" class="headerlink" title="3.1 åŠ¨æ€å†…æ ¸å¯åŠ è½½æ¨¡å—"></a>3.1 åŠ¨æ€å†…æ ¸å¯åŠ è½½æ¨¡å—</h2><p>æ­£å¦‚å‰é¢æ‰€è¯´ï¼Œè·¨è¿›ç¨‹é€šä¿¡æ˜¯éœ€è¦å†…æ ¸ç©ºé—´åšæ”¯æŒçš„ã€‚ä¼ ç»Ÿçš„ IPC æœºåˆ¶å¦‚ç®¡é“ã€Socket éƒ½æ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤é€šè¿‡å†…æ ¸æ”¯æŒæ¥å®ç°è¿›ç¨‹é—´é€šä¿¡è‡ªç„¶æ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯ Binder å¹¶ä¸æ˜¯ Linux ç³»ç»Ÿå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™å°±å¾—ç›Šäº Linux çš„ <strong><font color="#FF0000">åŠ¨æ€å†…æ ¸å¯åŠ è½½æ¨¡å—</font></strong>ï¼ˆLoadable Kernel Moduleï¼ŒLKMï¼‰çš„æœºåˆ¶ï¼›æ¨¡å—æ˜¯å…·æœ‰ç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºï¼Œå®ƒå¯ä»¥è¢«å•ç‹¬ç¼–è¯‘ï¼Œä½†æ˜¯ä¸èƒ½ç‹¬ç«‹è¿è¡Œã€‚å®ƒåœ¨è¿è¡Œæ—¶è¢«é“¾æ¥åˆ°å†…æ ¸ä½œä¸ºå†…æ ¸çš„ä¸€éƒ¨åˆ†è¿è¡Œã€‚è¿™æ ·ï¼ŒAndroid ç³»ç»Ÿå°±å¯ä»¥é€šè¿‡åŠ¨æ€æ·»åŠ ä¸€ä¸ªå†…æ ¸æ¨¡å—è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·è¿›ç¨‹ä¹‹é—´é€šè¿‡è¿™ä¸ªå†…æ ¸æ¨¡å—ä½œä¸ºæ¡¥æ¢æ¥å®ç°é€šä¿¡ã€‚</p><p>åœ¨ Android ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªè¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œè´Ÿè´£å„ä¸ªç”¨æˆ·è¿›ç¨‹é€šè¿‡ Binder å®ç°é€šä¿¡çš„å†…æ ¸æ¨¡å—å°±å« <strong><font color="#FFD39B">Binder é©±åŠ¨</font></strong>ï¼ˆBinder Dirverï¼‰ã€‚</p><p>é‚£ä¹ˆåœ¨ Android ç³»ç»Ÿä¸­ç”¨æˆ·è¿›ç¨‹ä¹‹é—´æ˜¯å¦‚ä½•é€šè¿‡è¿™ä¸ªå†…æ ¸æ¨¡å—ï¼ˆBinder é©±åŠ¨ï¼‰æ¥å®ç°é€šä¿¡çš„å‘¢ï¼Ÿéš¾é“æ˜¯å’Œå‰é¢è¯´çš„ä¼ ç»Ÿ IPC æœºåˆ¶ä¸€æ ·ï¼Œå…ˆå°†æ•°æ®ä»å‘é€æ–¹è¿›ç¨‹æ‹·è´åˆ°å†…æ ¸ç¼“å­˜åŒºï¼Œç„¶åå†å°†æ•°æ®ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶æ–¹è¿›ç¨‹ï¼Œé€šè¿‡ä¸¤æ¬¡æ‹·è´æ¥å®ç°å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼Œå¦åˆ™ä¹Ÿä¸ä¼šæœ‰å¼€ç¯‡æ‰€è¯´çš„ Binder åœ¨æ€§èƒ½æ–¹é¢çš„ä¼˜åŠ¿äº†ã€‚</p><p>è¿™å°±æ¶‰åŠåˆ°æˆ‘ä»¬æ¥ä¸‹æ¥è¦è¯´çš„ <strong><font color="#87CEFA">å†…å­˜æ˜ å°„</font></strong> çš„æ¦‚å¿µäº†ã€‚</p><h2 id="3-2-å†…å­˜æ˜ å°„"><a href="#3-2-å†…å­˜æ˜ å°„" class="headerlink" title="3.2 å†…å­˜æ˜ å°„"></a>3.2 å†…å­˜æ˜ å°„</h2><p>Binder IPC æœºåˆ¶ä¸­æ¶‰åŠåˆ°çš„å†…å­˜æ˜ å°„é€šè¿‡ <strong><font color="#0000CD">mmap()</font></strong> æ¥å®ç°ï¼Œmmap() æ˜¯æ“ä½œç³»ç»Ÿä¸­ä¸€ç§å†…å­˜æ˜ å°„çš„æ–¹æ³•ã€‚å†…å­˜æ˜ å°„ç®€å•çš„è®²å°±æ˜¯å°†ç”¨æˆ·ç©ºé—´çš„ä¸€å—å†…å­˜åŒºåŸŸæ˜ å°„åˆ°å†…æ ¸ç©ºé—´ã€‚æ˜ å°„å…³ç³»å»ºç«‹åï¼Œç”¨æˆ·å¯¹è¿™å—å†…å­˜åŒºåŸŸçš„ä¿®æ”¹å¯ä»¥ç›´æ¥ååº”åˆ°å†…æ ¸ç©ºé—´ï¼›åä¹‹å†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿèƒ½ç›´æ¥ååº”åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><p>å†…å­˜æ˜ å°„èƒ½å‡å°‘æ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå®ç°ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é«˜æ•ˆäº’åŠ¨ã€‚ä¸¤ä¸ªç©ºé—´å„è‡ªçš„ä¿®æ”¹èƒ½ç›´æ¥åæ˜ åœ¨æ˜ å°„çš„å†…å­˜åŒºåŸŸï¼Œä»è€Œè¢«å¯¹æ–¹ç©ºé—´åŠæ—¶æ„ŸçŸ¥ã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œå†…å­˜æ˜ å°„èƒ½å¤Ÿæä¾›å¯¹è¿›ç¨‹é—´é€šä¿¡çš„æ”¯æŒã€‚</p><h2 id="3-3-Binder-IPC-å®ç°åŸç†"><a href="#3-3-Binder-IPC-å®ç°åŸç†" class="headerlink" title="3.3 Binder IPC å®ç°åŸç†"></a>3.3 Binder IPC å®ç°åŸç†</h2><p>Binder IPC æ­£æ˜¯åŸºäºå†…å­˜æ˜ å°„ï¼ˆmmapï¼‰æ¥å®ç°çš„ï¼Œä½†æ˜¯ mmap() é€šå¸¸æ˜¯ç”¨åœ¨æœ‰ç‰©ç†ä»‹è´¨çš„æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ã€‚</p><p>æ¯”å¦‚è¿›ç¨‹ä¸­çš„ç”¨æˆ·åŒºåŸŸæ˜¯ä¸èƒ½ç›´æ¥å’Œç‰©ç†è®¾å¤‡æ‰“äº¤é“çš„ï¼Œå¦‚æœæƒ³è¦æŠŠç£ç›˜ä¸Šçš„æ•°æ®è¯»å–åˆ°è¿›ç¨‹çš„ç”¨æˆ·åŒºåŸŸï¼Œéœ€è¦ä¸¤æ¬¡æ‹·è´ï¼ˆç£ç›˜â€“&gt;å†…æ ¸ç©ºé—´â€“&gt;ç”¨æˆ·ç©ºé—´ï¼‰ï¼›é€šå¸¸åœ¨è¿™ç§åœºæ™¯ä¸‹ mmap() å°±èƒ½å‘æŒ¥ä½œç”¨ï¼Œé€šè¿‡åœ¨ç‰©ç†ä»‹è´¨å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å»ºç«‹æ˜ å°„ï¼Œå‡å°‘æ•°æ®çš„æ‹·è´æ¬¡æ•°ï¼Œç”¨å†…å­˜è¯»å†™å–ä»£I/Oè¯»å†™ï¼Œæé«˜æ–‡ä»¶è¯»å–æ•ˆç‡ã€‚</p><p>è€Œ Binder å¹¶ä¸å­˜åœ¨ç‰©ç†ä»‹è´¨ï¼Œå› æ­¤ Binder é©±åŠ¨ä½¿ç”¨ mmap() å¹¶ä¸æ˜¯ä¸ºäº†åœ¨ç‰©ç†ä»‹è´¨å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å»ºç«‹æ˜ å°„ï¼Œè€Œæ˜¯ç”¨æ¥åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºæ•°æ®æ¥æ”¶çš„ç¼“å­˜ç©ºé—´ã€‚</p><p><strong><font color="#FFD39B">ä¸€æ¬¡å®Œæ•´çš„ Binder IPC é€šä¿¡è¿‡ç¨‹é€šå¸¸æ˜¯è¿™æ ·ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp;1ã€é¦–å…ˆ Binder é©±åŠ¨åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºä¸€ä¸ª <strong><font color="#87CEFA">æ•°æ®æ¥æ”¶ç¼“å­˜åŒº</font></strong> ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp;2ã€æ¥ç€åœ¨å†…æ ¸ç©ºé—´å¼€è¾Ÿä¸€å—å†…æ ¸ç¼“å­˜åŒºï¼Œå»ºç«‹ <strong><font color="#87CEFA">å†…æ ¸ç¼“å­˜åŒº</font></strong> å’Œ <strong><font color="#87CEFA">å†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒº</font></strong> ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠ <strong><font color="#87CEFA">å†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒº</font></strong> å’Œ <strong><font color="#87CEFA">æ¥æ”¶è¿›ç¨‹ç”¨æˆ·ç©ºé—´åœ°å€</font></strong> çš„æ˜ å°„å…³ç³»ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp;3ã€å‘é€æ–¹è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <strong><font color="#87CEFA">copyfromuser()</font></strong> å°†æ•°æ® copy åˆ°å†…æ ¸ä¸­çš„å†…æ ¸ç¼“å­˜åŒºï¼Œç”±äºå†…æ ¸ç¼“å­˜åŒºå’Œæ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´å­˜åœ¨å†…å­˜æ˜ å°„ï¼Œå› æ­¤ä¹Ÿå°±ç›¸å½“äºæŠŠæ•°æ®å‘é€åˆ°äº†æ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ä¾¿å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´çš„é€šä¿¡ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹åŸç†å›¾ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-0c9748841ab26628.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/780" alt="Binder é€šä¿¡åŸç†.jpg"></center><h1 id="å››ã€Binder-é€šä¿¡æ¨¡å‹"><a href="#å››ã€Binder-é€šä¿¡æ¨¡å‹" class="headerlink" title="å››ã€Binder é€šä¿¡æ¨¡å‹"></a>å››ã€Binder é€šä¿¡æ¨¡å‹</h1><p>ä»‹ç»å®Œ Binder IPC çš„åº•å±‚é€šä¿¡åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å®ç°å±‚é¢æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚</p><p>ä¸€æ¬¡å®Œæ•´çš„è¿›ç¨‹é—´é€šä¿¡å¿…ç„¶è‡³å°‘åŒ…å«ä¸¤ä¸ªè¿›ç¨‹ï¼Œé€šå¸¸æˆ‘ä»¬ç§°é€šä¿¡çš„åŒæ–¹åˆ†åˆ«ä¸º <strong><font color="#87CEFA">å®¢æˆ·ç«¯è¿›ç¨‹</font></strong>ï¼ˆClientï¼‰å’Œ <strong><font color="#87CEFA">æœåŠ¡ç«¯è¿›ç¨‹</font></strong>ï¼ˆServerï¼‰ï¼Œç”±äºè¿›ç¨‹éš”ç¦»æœºåˆ¶çš„å­˜åœ¨ï¼Œé€šä¿¡åŒæ–¹å¿…ç„¶éœ€è¦å€ŸåŠ© <strong><font color="#87CEFA">Binder</font></strong> æ¥å®ç°ã€‚</p><h2 id="4-1-Client-Server-ServiceManager-é©±åŠ¨"><a href="#4-1-Client-Server-ServiceManager-é©±åŠ¨" class="headerlink" title="4.1 Client/Server/ServiceManager/é©±åŠ¨"></a>4.1 Client/Server/ServiceManager/é©±åŠ¨</h2><p>å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ï¼ŒBinder æ˜¯åŸºäº C/S æ¶æ„çš„ã€‚ç”±ä¸€ç³»åˆ—çš„ç»„ä»¶ç»„æˆï¼ŒåŒ…æ‹¬ Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp; Clientã€Serverã€Service Manager è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼ŒBinder é©±åŠ¨è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp; Service Manager å’Œ Binder é©±åŠ¨ç”±ç³»ç»Ÿæä¾›ï¼Œè€Œ Clientã€Server ç”±åº”ç”¨ç¨‹åºæ¥å®ç°ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ &nbsp; Clientã€Server å’Œ ServiceManager å‡æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ openã€mmap å’Œ ioctl æ¥è®¿é—®è®¾å¤‡æ–‡ä»¶ /dev/binderï¼Œä»è€Œå®ç°ä¸ Binder é©±åŠ¨çš„äº¤äº’æ¥é—´æ¥çš„å®ç°è·¨è¿›ç¨‹é€šä¿¡ã€‚</p><p>å¦‚ä¸‹åŸç†å›¾ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-9b388624bd4db998.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/780" alt="é€šä¿¡æ¨¡å‹.jpg"></center><p>Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨è¿™å‡ ä¸ªç»„ä»¶åœ¨é€šä¿¡è¿‡ç¨‹ä¸­æ‰®æ¼”çš„è§’è‰²å°±å¦‚åŒäº’è”ç½‘ä¸­æœåŠ¡å™¨ï¼ˆServerï¼‰ã€å®¢æˆ·ç«¯ï¼ˆClientï¼‰ã€DNSåŸŸåæœåŠ¡å™¨ï¼ˆServiceManagerï¼‰ä»¥åŠè·¯ç”±å™¨ï¼ˆBinder é©±åŠ¨ï¼‰ä¹‹å‰çš„å…³ç³»ã€‚</p><p>é€šå¸¸æˆ‘ä»¬è®¿é—®ä¸€ä¸ªç½‘é¡µçš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆåœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œå¦‚ <a href="https://www.google.com" target="_blank" rel="noopener">https://www.google.com</a> ç„¶åæŒ‰ä¸‹å›è½¦é”®ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰åŠæ³•é€šè¿‡åŸŸååœ°å€ç›´æ¥æ‰¾åˆ°æˆ‘ä»¬è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œå› æ­¤éœ€è¦é¦–å…ˆè®¿é—® DNS åŸŸåæœåŠ¡å™¨ï¼ŒåŸŸåæœåŠ¡å™¨ä¸­ä¿å­˜äº† <a href="https://www.google.com" target="_blank" rel="noopener">https://www.google.com</a> å¯¹åº”çš„ ip åœ°å€ 10.249.23.13ï¼Œç„¶åé€šè¿‡è¿™ä¸ª ip åœ°å€æ‰èƒ½æ‰¾åˆ° <a href="https://www.google.com" target="_blank" rel="noopener">https://www.google.com</a> å¯¹åº”çš„æœåŠ¡å™¨ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-b4d4af5e47697aa5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/780" alt="google.jpg"></center><h2 id="4-2-Android-Binder-è®¾è®¡ä¸å®ç°"><a href="#4-2-Android-Binder-è®¾è®¡ä¸å®ç°" class="headerlink" title="4.2 Android Binder è®¾è®¡ä¸å®ç°"></a>4.2 Android Binder è®¾è®¡ä¸å®ç°</h2><p><a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">Android Binder è®¾è®¡ä¸å®ç°</a>ä¸€æ–‡ä¸­å¯¹ Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨æœ‰å¾ˆè¯¦ç»†çš„æè¿°ã€‚</p><h3 id="4-2-1-Binder-é©±åŠ¨"><a href="#4-2-1-Binder-é©±åŠ¨" class="headerlink" title="4.2.1 Binder é©±åŠ¨"></a>4.2.1 Binder é©±åŠ¨</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Binder é©±åŠ¨å°±å¦‚åŒè·¯ç”±å™¨ä¸€æ ·ï¼Œæ˜¯æ•´ä¸ªé€šä¿¡çš„æ ¸å¿ƒï¼›é©±åŠ¨è´Ÿè´£è¿›ç¨‹ä¹‹é—´ Binder é€šä¿¡çš„å»ºç«‹ã€Binder åœ¨è¿›ç¨‹ä¹‹é—´çš„ä¼ é€’ã€Binder å¼•ç”¨è®¡æ•°ç®¡ç†ã€æ•°æ®åŒ…åœ¨è¿›ç¨‹ä¹‹é—´çš„ä¼ é€’å’Œäº¤äº’ç­‰ä¸€ç³»åˆ—åº•å±‚æ”¯æŒã€‚ </p><h3 id="4-2-2-ServiceManager-ä¸å®å-Binder"><a href="#4-2-2-ServiceManager-ä¸å®å-Binder" class="headerlink" title="4.2.2 ServiceManager ä¸å®å Binder"></a>4.2.2 ServiceManager ä¸å®å Binder</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceManager å’Œ DNS ç±»ä¼¼ï¼Œä½œç”¨æ˜¯å°†å­—ç¬¦å½¢å¼çš„ Binder åå­—è½¬åŒ–æˆ Client ä¸­å¯¹è¯¥ Binder çš„å¼•ç”¨ï¼Œä½¿å¾— Client èƒ½å¤Ÿé€šè¿‡ Binder çš„åå­—è·å¾—å¯¹ Binder å®ä½“çš„å¼•ç”¨ã€‚æ³¨å†Œäº†åå­—çš„ Binder å«å®å Binderï¼Œå°±åƒç½‘ç«™ä¸€æ ·é™¤äº†æœ‰ IP åœ°å€ä»¥å¤–è¿˜æœ‰è‡ªå·±çš„ç½‘å€ã€‚Server åˆ›å»ºäº† Binderï¼Œå¹¶ä¸ºå®ƒèµ·ä¸€ä¸ªå­—ç¬¦å½¢å¼ï¼Œå¯è¯»æ˜“è®°å¾—åå­—ï¼Œå°†è¿™ä¸ª Binder å®ä½“è¿åŒåå­—ä¸€èµ·ä»¥æ•°æ®åŒ…çš„å½¢å¼é€šè¿‡ Binder é©±åŠ¨å‘é€ç»™ ServiceManager ï¼Œé€šçŸ¥ ServiceManager æ³¨å†Œä¸€ä¸ªåä¸ºâ€œå¼ ä¸‰â€çš„ Binderï¼Œå®ƒä½äºæŸä¸ª Server ä¸­ã€‚é©±åŠ¨ä¸ºè¿™ä¸ªç©¿è¶Šè¿›ç¨‹è¾¹ç•Œçš„ Binder åˆ›å»ºä½äºå†…æ ¸ä¸­çš„å®ä½“èŠ‚ç‚¹ä»¥åŠ ServiceManager å¯¹å®ä½“çš„å¼•ç”¨ï¼Œå°†åå­—ä»¥åŠæ–°å»ºçš„å¼•ç”¨æ‰“åŒ…ä¼ ç»™ ServiceManagerã€‚ServiceManger æ”¶åˆ°æ•°æ®åä»ä¸­å–å‡ºåå­—å’Œå¼•ç”¨å¡«å…¥æŸ¥æ‰¾è¡¨ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼ŒServierManager æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒServer æ˜¯å¦ä¸€ä¸ªè¿›ç¨‹ï¼ŒServer å‘ ServiceManager ä¸­æ³¨å†Œ Binder å¿…ç„¶æ¶‰åŠåˆ°è¿›ç¨‹é—´é€šä¿¡ã€‚å½“å‰å®ç°è¿›ç¨‹é—´é€šä¿¡åˆè¦ç”¨åˆ°è¿›ç¨‹é—´é€šä¿¡ï¼Œè¿™å°±å¥½åƒè›‹å¯ä»¥å­µå‡ºé¸¡çš„å‰æå´æ˜¯è¦å…ˆæ‰¾åªé¸¡ä¸‹è›‹ï¼<font color="#87CEFA">Binder çš„å®ç°æ¯”è¾ƒå·§å¦™ï¼Œå°±æ˜¯é¢„å…ˆåˆ›é€ ä¸€åªé¸¡æ¥ä¸‹è›‹</font>ã€‚ServiceManager å’Œå…¶ä»–è¿›ç¨‹åŒæ ·é‡‡ç”¨ Binder é€šä¿¡ï¼ŒServiceManager æ˜¯ Server ç«¯ï¼Œæœ‰è‡ªå·±çš„ Binder å®ä½“ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯ Clientï¼Œéœ€è¦é€šè¿‡è¿™ä¸ª Binder çš„å¼•ç”¨æ¥å®ç° Binder çš„æ³¨å†Œï¼ŒæŸ¥è¯¢å’Œè·å–ã€‚ServiceManager æä¾›çš„ Binder æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ²¡æœ‰åå­—ä¹Ÿä¸éœ€è¦æ³¨å†Œã€‚å½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ BINDERSETCONTEXT_MGR å‘½ä»¤å°†è‡ªå·±æ³¨å†Œæˆ ServiceManager æ—¶ Binder é©±åŠ¨ä¼šè‡ªåŠ¨ä¸ºå®ƒåˆ›å»º Binder å®ä½“<font color="#87CEFA">ï¼ˆè¿™å°±æ˜¯é‚£åªé¢„å…ˆé€ å¥½çš„é‚£åªé¸¡ï¼‰</font>ã€‚å…¶æ¬¡è¿™ä¸ª Binder å®ä½“çš„å¼•ç”¨åœ¨æ‰€æœ‰ Client ä¸­éƒ½å›ºå®šä¸º 0 è€Œæ— éœ€é€šè¿‡å…¶å®ƒæ‰‹æ®µè·å¾—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª Server æƒ³è¦å‘ ServiceManager æ³¨å†Œè‡ªå·±çš„ Binder å°±å¿…é¡»é€šè¿‡è¿™ä¸ª 0 å·å¼•ç”¨å’Œ ServiceManager çš„ Binder é€šä¿¡ã€‚ç±»æ¯”äº’è”ç½‘ï¼Œ0 å·å¼•ç”¨å°±å¥½æ¯”æ˜¯åŸŸåæœåŠ¡å™¨çš„åœ°å€ï¼Œä½ å¿…é¡»é¢„å…ˆåŠ¨æ€æˆ–è€…æ‰‹å·¥é…ç½®å¥½ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¯´çš„ Client æ˜¯ç›¸å¯¹äº ServiceManager è€Œè¨€çš„ï¼Œä¸€ä¸ªè¿›ç¨‹æˆ–è€…åº”ç”¨ç¨‹åºå¯èƒ½æ˜¯æä¾›æœåŠ¡çš„ Serverï¼Œä½†å¯¹äº ServiceManager æ¥è¯´å®ƒä»ç„¶æ˜¯ä¸ª Clientã€‚</p><h3 id="4-2-3-Client-è·å¾—å®å-Binder-çš„å¼•ç”¨"><a href="#4-2-3-Client-è·å¾—å®å-Binder-çš„å¼•ç”¨" class="headerlink" title="4.2.3 Client è·å¾—å®å Binder çš„å¼•ç”¨"></a>4.2.3 Client è·å¾—å®å Binder çš„å¼•ç”¨</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Server å‘ ServiceManager ä¸­æ³¨å†Œäº† Binder ä»¥åï¼Œ Client å°±èƒ½é€šè¿‡åå­—è·å¾— Binder çš„å¼•ç”¨äº†ã€‚Client ä¹Ÿåˆ©ç”¨ä¿ç•™çš„ 0 å·å¼•ç”¨å‘ ServiceManager è¯·æ±‚è®¿é—®æŸä¸ª Binder: æˆ‘ç”³è¯·è®¿é—®åå­—å«å¼ ä¸‰çš„ Binder å¼•ç”¨ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceManager æ”¶åˆ°è¿™ä¸ªè¯·æ±‚åä»è¯·æ±‚æ•°æ®åŒ…ä¸­å–å‡º Binder åç§°ï¼Œåœ¨æŸ¥æ‰¾è¡¨é‡Œæ‰¾åˆ°å¯¹åº”çš„æ¡ç›®ï¼Œå–å‡ºå¯¹åº”çš„ Binder å¼•ç”¨ä½œä¸ºå›å¤å‘é€ç»™å‘èµ·è¯·æ±‚çš„ Clientã€‚ä»é¢å‘å¯¹è±¡çš„è§’åº¦çœ‹ï¼ŒServer ä¸­çš„ Binder å®ä½“ç°åœ¨æœ‰ä¸¤ä¸ªå¼•ç”¨ï¼šä¸€ä¸ªä½äº ServiceManager ä¸­ï¼Œä¸€ä¸ªä½äºå‘èµ·è¯·æ±‚çš„ Client ä¸­ã€‚å¦‚æœæ¥ä¸‹æ¥æœ‰æ›´å¤šçš„ Client è¯·æ±‚è¯¥ Binderï¼Œç³»ç»Ÿä¸­å°±ä¼šæœ‰æ›´å¤šçš„å¼•ç”¨æŒ‡å‘è¯¥ Binder ï¼Œå°±åƒ Java ä¸­ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªå¼•ç”¨ä¸€æ ·ã€‚</p><h2 id="4-3-Binder-é€šä¿¡è¿‡ç¨‹"><a href="#4-3-Binder-é€šä¿¡è¿‡ç¨‹" class="headerlink" title="4.3 Binder é€šä¿¡è¿‡ç¨‹"></a>4.3 Binder é€šä¿¡è¿‡ç¨‹</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¤§è‡´èƒ½æ€»ç»“å‡º Binder é€šä¿¡è¿‡ç¨‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ 1ã€é¦–å…ˆï¼Œä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ BINDERSETCONTEXT_MGR å‘½ä»¤é€šè¿‡ Binder é©±åŠ¨å°†è‡ªå·±æ³¨å†Œæˆä¸º ServiceManagerï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ 2ã€Server é€šè¿‡é©±åŠ¨å‘ ServiceManager ä¸­æ³¨å†Œ Binderï¼ˆServer ä¸­çš„ Binder å®ä½“ï¼‰ï¼Œè¡¨æ˜å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ã€‚é©±åŠ¨ä¸ºè¿™ä¸ª Binder åˆ›å»ºä½äºå†…æ ¸ä¸­çš„å®ä½“èŠ‚ç‚¹ä»¥åŠ ServiceManager å¯¹å®ä½“çš„å¼•ç”¨ï¼Œå°†åå­—ä»¥åŠæ–°å»ºçš„å¼•ç”¨æ‰“åŒ…ä¼ ç»™ ServiceManagerï¼ŒServiceManger å°†å…¶å¡«å…¥æŸ¥æ‰¾è¡¨ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ 3ã€Client é€šè¿‡åå­—ï¼Œåœ¨ Binder é©±åŠ¨çš„å¸®åŠ©ä¸‹ä» ServiceManager ä¸­è·å–åˆ°å¯¹ Binder å®ä½“çš„å¼•ç”¨ï¼Œé€šè¿‡è¿™ä¸ªå¼•ç”¨å°±èƒ½å®ç°å’Œ Server è¿›ç¨‹çš„é€šä¿¡ã€‚</p><p>æˆ‘ä»¬çœ‹åˆ°æ•´ä¸ªé€šä¿¡è¿‡ç¨‹éƒ½éœ€è¦ Binder é©±åŠ¨çš„æ¥å…¥ã€‚ä¸‹å›¾èƒ½æ›´åŠ ç›´è§‚çš„å±•ç°æ•´ä¸ªé€šä¿¡è¿‡ç¨‹(ä¸ºäº†è¿›ä¸€æ­¥æŠ½è±¡é€šä¿¡è¿‡ç¨‹ä»¥åŠå‘ˆç°ä¸Šçš„æ–¹ä¾¿ï¼Œä¸‹å›¾æˆ‘ä»¬å¿½ç•¥äº† Binder å®ä½“åŠå…¶å¼•ç”¨çš„æ¦‚å¿µ)ï¼š</p><p>åŸç†å›¾ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-1235f55b286716ee.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/780" alt="åŸç†å›¾.jpg"></center><h2 id="4-4-Binder-é€šä¿¡ä¸­çš„ä»£ç†æ¨¡å¼"><a href="#4-4-Binder-é€šä¿¡ä¸­çš„ä»£ç†æ¨¡å¼" class="headerlink" title="4.4 Binder é€šä¿¡ä¸­çš„ä»£ç†æ¨¡å¼"></a>4.4 Binder é€šä¿¡ä¸­çš„ä»£ç†æ¨¡å¼</h2><p>æˆ‘ä»¬å·²ç»è§£é‡Šæ¸…æ¥š Clientã€Server å€ŸåŠ© Binder é©±åŠ¨å®Œæˆè·¨è¿›ç¨‹é€šä¿¡çš„å®ç°æœºåˆ¶äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸ªé—®é¢˜ä¼šè®©æˆ‘ä»¬å›°æƒ‘ã€‚A è¿›ç¨‹æƒ³è¦ B è¿›ç¨‹ä¸­æŸä¸ªå¯¹è±¡ï¼ˆobjectï¼‰æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ¯•ç«Ÿå®ƒä»¬åˆ†å±ä¸åŒçš„è¿›ç¨‹ï¼ŒA è¿›ç¨‹æ²¡æ³•ç›´æ¥ä½¿ç”¨ B è¿›ç¨‹ä¸­çš„ objectã€‚</p><p>å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡è·¨è¿›ç¨‹é€šä¿¡çš„è¿‡ç¨‹éƒ½æœ‰ Binder é©±åŠ¨çš„å‚ä¸ï¼Œå› æ­¤åœ¨æ•°æ®æµç» Binder é©±åŠ¨çš„æ—¶å€™é©±åŠ¨ä¼šå¯¹æ•°æ®åšä¸€å±‚è½¬æ¢ã€‚å½“ A è¿›ç¨‹æƒ³è¦è·å– B è¿›ç¨‹ä¸­çš„ object æ—¶ï¼Œé©±åŠ¨å¹¶ä¸ä¼šçœŸçš„æŠŠ object è¿”å›ç»™ Aï¼Œè€Œæ˜¯è¿”å›äº†ä¸€ä¸ªè·Ÿ object çœ‹èµ·æ¥ä¸€æ¨¡ä¸€æ ·çš„ä»£ç†å¯¹è±¡ objectProxyï¼Œè¿™ä¸ª objectProxy å…·æœ‰å’Œ object ä¸€æ¨¡ä¸€æ ·çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•å¹¶æ²¡æœ‰ B è¿›ç¨‹ä¸­ object å¯¹è±¡é‚£äº›æ–¹æ³•çš„èƒ½åŠ›ï¼Œè¿™äº›æ–¹æ³•åªéœ€è¦æŠŠè¯·æ±‚å‚æ•°äº¤ç»™é©±åŠ¨å³å¯ã€‚å¯¹äº A è¿›ç¨‹æ¥è¯´å’Œç›´æ¥è°ƒç”¨ object ä¸­çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ã€‚</p><p>å½“ Binder é©±åŠ¨æ¥æ”¶åˆ° A è¿›ç¨‹çš„æ¶ˆæ¯åï¼Œå‘ç°è¿™æ˜¯ä¸ª objectProxy å°±å»æŸ¥è¯¢è‡ªå·±ç»´æŠ¤çš„è¡¨å•ï¼Œä¸€æŸ¥å‘ç°è¿™æ˜¯ B è¿›ç¨‹ object çš„ä»£ç†å¯¹è±¡ã€‚äºæ˜¯å°±ä¼šå»é€šçŸ¥ B è¿›ç¨‹è°ƒç”¨ object çš„æ–¹æ³•ï¼Œå¹¶è¦æ±‚ B è¿›ç¨‹æŠŠè¿”å›ç»“æœå‘ç»™è‡ªå·±ã€‚å½“é©±åŠ¨æ‹¿åˆ° B è¿›ç¨‹çš„è¿”å›ç»“æœåå°±ä¼šè½¬å‘ç»™ A è¿›ç¨‹ï¼Œä¸€æ¬¡é€šä¿¡å°±å®Œæˆäº†ã€‚</p><p>åŸç†å›¾ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-c870411b839705db.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/780" alt="åŸç†å›¾.jpg"></center><h2 id="4-5-Binder-çš„å®Œæ•´å®šä¹‰"><a href="#4-5-Binder-çš„å®Œæ•´å®šä¹‰" class="headerlink" title="4.5 Binder çš„å®Œæ•´å®šä¹‰"></a>4.5 Binder çš„å®Œæ•´å®šä¹‰</h2><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯¹ Binder åšä¸ªæ›´åŠ å…¨é¢çš„å®šä¹‰äº†ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä»è¿›ç¨‹é—´é€šä¿¡çš„è§’åº¦çœ‹ï¼ŒBinder æ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„æœºåˆ¶ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä» Server è¿›ç¨‹çš„è§’åº¦çœ‹ï¼ŒBinder æŒ‡çš„æ˜¯ Server ä¸­çš„ Binder å®ä½“å¯¹è±¡ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä» Client è¿›ç¨‹çš„è§’åº¦çœ‹ï¼ŒBinder æŒ‡çš„æ˜¯å¯¹ Binder ä»£ç†å¯¹è±¡ï¼Œæ˜¯ Binder å®ä½“å¯¹è±¡çš„ä¸€ä¸ªè¿œç¨‹ä»£ç†ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä»ä¼ è¾“è¿‡ç¨‹çš„è§’åº¦çœ‹ï¼ŒBinder æ˜¯ä¸€ä¸ªå¯ä»¥è·¨è¿›ç¨‹ä¼ è¾“çš„å¯¹è±¡ï¼›Binder é©±åŠ¨ä¼šå¯¹è¿™ä¸ªè·¨è¶Šè¿›ç¨‹è¾¹ç•Œçš„å¯¹è±¡å¯¹ä¸€ç‚¹ç‚¹ç‰¹æ®Šå¤„ç†ï¼Œè‡ªåŠ¨å®Œæˆä»£ç†å¯¹è±¡å’Œæœ¬åœ°å¯¹è±¡ä¹‹é—´çš„è½¬æ¢ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://www.jianshu.com/p/062a6e4f5cbe" target="_blank" rel="noopener">å…³äºBinderï¼Œä½œä¸ºåº”ç”¨å¼€å‘è€…ä½ éœ€è¦çŸ¥é“çš„å…¨éƒ¨</a><br>&nbsp;ğŸ“• 02. <a href="https://zhuanlan.zhihu.com/p/35519585" target="_blank" rel="noopener">å†™ç»™ Android åº”ç”¨å·¥ç¨‹å¸ˆçš„ Binder åŸç†å‰–æ</a><br>&nbsp;ğŸ“• 03. <a href="https://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="noopener">Android Banderè®¾è®¡ä¸å®ç° - è®¾è®¡ç¯‡</a><br>&nbsp;ğŸ“• 04. <a href="https://blog.csdn.net/freekiteyu/article/details/70082302" target="_blank" rel="noopener">ä¸€ç¯‡æ–‡ç« äº†è§£ç›¸è§æ¨æ™šçš„ Android Binder è¿›ç¨‹é—´é€šè®¯æœºåˆ¶</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ ¸å¿ƒæŠ€æœ¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Binder </tag>
            
            <tag> æ ¸å¿ƒæŠ€æœ¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ JNI</title>
      <link href="/2018/11/10/04.he-xin-ji-zhi-xi-lie-shen-ru-zuan-yan-android-he-xin-ji-zhu-zhi-jni/"/>
      <url>/2018/11/10/04.he-xin-ji-zhi-xi-lie-shen-ru-zuan-yan-android-he-xin-ji-zhu-zhi-jni/</url>
      
        <content type="html"><![CDATA[<h1 id="1-å¼€ç¯‡"><a href="#1-å¼€ç¯‡" class="headerlink" title="1. å¼€ç¯‡"></a>1. å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">MediaScanner.java</font></td><td>frameworks/base/media/java/android/media/MediaScanner.java</td></tr><tr><td><font color="#D15FEE">android_media_MediaScanner.cpp</font></td><td>frameworks/base/media/jni/android_media_MediaScanner.cpp</td></tr><tr><td><font color="#D15FEE">android_media_MediaPlayer.cpp</font></td><td>frameworks/base/media/jni/android_media_MediaPlayer.cpp</td></tr><tr><td><font color="#D15FEE">AndroidRuntime.cpp</font></td><td>frameworks/base/core/jni/AndroidRuntime.cpp</td></tr></tbody></table><h2 id="1-2-JNIæ¦‚è¿°"><a href="#1-2-JNIæ¦‚è¿°" class="headerlink" title="1.2 JNIæ¦‚è¿°"></a>1.2 JNIæ¦‚è¿°</h2><p>JNIæ˜¯Java Native Interfaceçš„ç¼©å†™ï¼Œä¸­æ–‡è¯‘ä¸ºâ€œJavaæœ¬åœ°è°ƒç”¨â€ï¼Œé€šä¿—åœ°è¯´ï¼ŒJNIæ˜¯ä¸€ç§æŠ€æœ¯ï¼Œé€šè¿‡è¿™ç§æŠ€æœ¯å¯ä»¥åšåˆ°ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Javaç¨‹åºä¸­çš„å‡½æ•°å¯ä»¥è°ƒç”¨Nativeè¯­è¨€å†™çš„å‡½æ•°ï¼ŒNativeä¸€èˆ¬æŒ‡çš„æ˜¯C/C++ç¼–å†™å‡½æ•°ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Nativeç¨‹åºä¸­çš„å‡½æ•°å¯ä»¥è°ƒç”¨Javaå±‚çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨C/C++ç¨‹åºä¸­å¯ä»¥è°ƒç”¨Javaçš„å‡½æ•°ï¼›</p><p>åœ¨å¹³å°æ— å…³çš„Javaä¸­ï¼Œä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸€ä¸ªä¸Nativeç›¸å…³çš„JNIæŠ€æœ¯å‘¢ï¼Ÿè¿™å²‚ä¸æ˜¯ç ´åäº† Java çš„å¹³å°æ— å…³ç‰¹æ€§å—ï¼ŸJNIæŠ€æœ¯çš„æ¨å‡ºä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„è€ƒè™‘ï¼š<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ æ‰¿è½½Javaä¸–ç•Œçš„è™šæ‹Ÿæœºæ˜¯ç”¨ Native è¯­è¨€å†™çš„ï¼Œè€Œè™šæ‹Ÿæœºåˆè¿è¡Œåœ¨å…·ä½“çš„å¹³å°ä¸Šï¼Œæ‰€ä»¥è™šæ‹Ÿæœºæœ¬èº«æ— æ³•åšåˆ°å¹³å°æ— å…³ã€‚ç„¶è€Œï¼Œæœ‰äº†JNIæŠ€æœ¯åï¼Œå°±å¯ä»¥å¯¹Javaå±‚å±è”½ä¸åŒæ“ä½œç³»ç»Ÿå¹³å°ä¹‹é—´çš„å·®å¼‚äº†ã€‚è¿™æ ·ï¼Œå°±èƒ½å®ç°Javaæœ¬èº«çš„å¹³å°æ— å…³ç‰¹æ€§ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ åœ¨Javaè¯ç”Ÿä¹‹å‰ï¼Œå¾ˆå¤šç¨‹åºéƒ½æ˜¯ç”¨ Native è¯­è¨€å†™çš„ï¼ŒéšåJavaåæ¥å—åˆ°è¿½æ§ï¼Œå¹¶ä¸”è¿…é€Ÿå‘å±•ï¼Œä½†æ˜¯ä½œä¸ºä¸€é—¨é«˜çº§è¯­è¨€ï¼Œæ— æ³•å°†è½¯ä»¶ä¸–ç•Œå½»åº•çš„æ”¹å˜ã€‚é‚£ä¹ˆæ—¢ç„¶Nativeæ¨¡å—å®ç°äº†è®¸å¤šåŠŸèƒ½ï¼Œé‚£ä¹ˆåœ¨Javaä¸­ç›´æ¥é€šè¿‡JNIæŠ€æœ¯å»ä½¿ç”¨å®ƒä»¬ä¸ä¹…å¯ä»¥äº†ï¼Ÿ</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠJNIçœ‹ä½œä¸€åº§å°†Nativeä¸–ç•Œå’ŒJavaä¸–ç•Œäº’è”èµ·æ¥çš„ä¸€åº§æ¡¥æ¢ï¼ˆ<strong>ç‰¹æ®Šè¯´æ˜ï¼šJNIå±‚çš„ä»£ç ä¹Ÿæ˜¯ç”¨Nativeå†™çš„å“¦ï¼</strong>ï¼‰ã€‚</p><p>åŸç†å›¾å¦‚ä¸‹ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-c6c57c45b56f79bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="æµç¨‹å›¾.png"></center><p>ä¸€å¾‹çš„è®²åŸç†å¾ˆæ¯ç‡¥ï¼Œæˆ‘ä»¬ç›´æ¥ä»¥å®é™…çš„ä»£ç ä½œä¸ºèŒƒä¾‹æ¥å­¦ä¹ JNIçš„åŸç†å’Œå®é™…ä½¿ç”¨ï¼</p><h2 id="1-3-MediaScanner"><a href="#1-3-MediaScanner" class="headerlink" title="1.3 MediaScanner"></a>1.3 MediaScanner</h2><p>å¦‚æœä½ æ˜¯åšAndroidç³»ç»Ÿå¼€å‘å’Œç»´æŠ¤å·¥ä½œçš„ï¼Œé‚£ä¹ˆä½ è‚¯å®šå¬è¿‡MediaScannerï¼Œé‚£æˆ‘ä»¬å°±æ‹¿å®ƒæ¥ä¸¾ä¾‹ï¼Œçœ‹çœ‹å®ƒå’ŒJNIä¹‹é—´æ˜¯å¦‚ä½•å…³è”çš„ã€‚</p><p>ï¼ˆMediaScanneræ˜¯Androidå¹³å°ä¸­å¤šåª’ä½“ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯æ‰«æåª’ä½“æ–‡ä»¶ï¼Œå¾—åˆ°è¯¸å¦‚æ­Œæ›²æ—¶é•¿ã€æ­Œæ›²ä½œè€…ç­‰åª’ä½“ä¿¡æ¯ï¼Œå¹¶å°†ä»–ä»¬å­˜å…¥åˆ°åª’ä½“æ•°æ®åº“ä¸­ï¼Œæ‹±å…¶ä»–åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚ï¼‰</p><p>MediaScannerå’Œå®ƒçš„JNIï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-1cb14ee004b58782.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="æµç¨‹å›¾.png"></center><p>æˆ‘ä»¬ç®€å•è¯´æ˜ä¸‹è¿™ä¸ªæµç¨‹å›¾ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Javaä¸–ç•Œå¯¹åº”çš„æ˜¯MediaScannerï¼Œè€Œè¿™ä¸ªMediaScannerç±»æœ‰ä¸€äº›å‡½æ•°éœ€è¦ç”±Nativeå±‚æ¥å®ç°ï¼ˆå®šä¹‰äº†ä¸€äº›Nativeå‡½æ•°ï¼Œå…·ä½“å®ç°ä»£ç åœ¨Nativeå±‚ï¼‰<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ JNIå±‚å¯¹åº”çš„æ˜¯libmedia_jni.soã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Â· media_jniæ˜¯JNIåº“çš„åå­—ï¼Œå…¶ä¸­ä¸‹åˆ’çº¿å‰çš„â€œmediaâ€æ˜¯Nativeå±‚åº“çš„åå­—ï¼Œè¿™é‡Œå°±æ˜¯libmediaåº“ã€‚ä¸‹åˆ’çº¿åçš„â€œjniâ€è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªJNIåº“ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Â· Androidå¹³å°åŸºæœ¬ä¸Šéƒ½é‡‡ç”¨â€œlibæ¨¡å—å_jni.soâ€æ¥å‘½åJNIåº“ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Nativeå±‚å¯¹åº”çš„æ˜¯libmedia.soï¼Œè¿™ä¸ªåº“å®Œæˆäº†å®é™…çš„åŠŸèƒ½ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ MediaScannerå°†é€šè¿‡JNIåº“libmedia_jni.soå’ŒNativeå±‚çš„libmedia.soäº¤äº’ã€‚</p><h1 id="2-æºç åˆ†æ-Javaå±‚"><a href="#2-æºç åˆ†æ-Javaå±‚" class="headerlink" title="2. æºç åˆ†æ - Javaå±‚"></a>2. æºç åˆ†æ - Javaå±‚</h1><h2 id="2-1-MediaScanner-java"><a href="#2-1-MediaScanner-java" class="headerlink" title="2.1 MediaScanner.java"></a>2.1 MediaScanner.java</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹MediaScanneråœ¨Javaå±‚ä¸­å…³äºJNIçš„ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> android<span class="token punctuation">.</span>media<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaScanner</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// staticè¯­å¥</span>        <span class="token comment" spellcheck="true">// è¿™ä¸ªæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œmedia_jniä¸ºJNIåº“çš„åå­—ï¼Œå®é™…åŠ è½½åŠ¨æ€åº“çš„æ—¶å€™ä¼šå°†å…¶æ‹“å±•æˆlibmedia_jni.so</span>        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"media_jni"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">native_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// è°ƒç”¨native_initå‡½æ•°</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">processFile</span><span class="token punctuation">(</span>String path<span class="token punctuation">,</span> String mimeType<span class="token punctuation">,</span> MediaScannerClient client<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">native_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ç”³æ˜ä¸€ä¸ªnativeå‡½æ•°ã€‚nativeä¸ºJavaçš„å…³é”®å­—ï¼Œè¡¨ç¤ºå®ƒç”±JNIå±‚å®ç°ã€‚</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>OKï¼Œä»¥ä¸Šä»£ç åˆ—å‡ºäº†ä¸¤ä¸ªé‡è¦çš„è¦ç‚¹ï¼šï¼ˆ1ï¼‰åŠ è½½JNIåº“ï¼›ï¼ˆ2ï¼‰è°ƒç”¨Javaçš„nativeå‡½æ•°</p><h2 id="2-2-åŠ è½½JNIåº“"><a href="#2-2-åŠ è½½JNIåº“" class="headerlink" title="2.2 åŠ è½½JNIåº“"></a>2.2 åŠ è½½JNIåº“</h2><p>æˆ‘ä»¬å‰é¢è¯´åˆ°è¿‡ï¼Œå¦‚æœJavaè¦è°ƒç”¨nativeå‡½æ•°ï¼Œå°±å¿…é¡»é€šè¿‡ä¸€ä¸ªä½äºJNIå±‚çš„åŠ¨æ€åº“æ¥å®ç°ã€‚é‚£ä¹ˆè¿™ä¸ªåŠ¨æ€åº“åœ¨ä»€ä¹ˆæ—¶å€™ã€ä»€ä¹ˆåœ°æ–¹åŠ è½½ï¼Ÿ</p><p>åŸåˆ™ä¸Šï¼Œåœ¨è°ƒç”¨nativeå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•æ—¶å€™ã€ä»»ä½•åœ°æ–¹å»åŠ è½½åŠ¨æ€åº“ã€‚ä½†ä¸€èˆ¬é€šè¡Œçš„åšæ³•å°±æ˜¯åœ¨ç±»çš„staticè¯­å¥ä¸­åŠ è½½ï¼Œè°ƒç”¨System.loadLibraryæ–¹æ³•å°±å¯ä»¥äº†ã€‚</p><h2 id="2-3-nativeå‡½æ•°"><a href="#2-3-nativeå‡½æ•°" class="headerlink" title="2.3 nativeå‡½æ•°"></a>2.3 nativeå‡½æ•°</h2><p>æˆ‘ä»¬å‘ç°native_initå’ŒprocessFileå‡½æ•°å‰é¢éƒ½æœ‰Javaçš„å…³é”®å­—nativeï¼Œè¿™ä¸ªå°±è¡¨ç¤ºå‡½æ•°å°†ç”±JNIå±‚æ¥å®ç°ã€‚</p><p>æ‰€ä»¥åœ¨Javaå±‚é¢å»ä½¿ç”¨JNIåªè¦åšä¸¤é¡¹å·¥ä½œï¼šï¼ˆ1ï¼‰åŠ è½½å¯¹åº”çš„JNIåº“ï¼›ï¼ˆ2ï¼‰ç”³æ˜ç”±å…³é”®å­—nativeä¿®é¥°çš„å‡½æ•°ã€‚</p><h1 id="3-æºç åˆ†æ-JNIå±‚"><a href="#3-æºç åˆ†æ-JNIå±‚" class="headerlink" title="3. æºç åˆ†æ - JNIå±‚"></a>3. æºç åˆ†æ - JNIå±‚</h1><h2 id="3-1-å®ç°å‡½æ•°"><a href="#3-1-å®ç°å‡½æ•°" class="headerlink" title="3.1 å®ç°å‡½æ•°"></a>3.1 å®ç°å‡½æ•°</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹Javaå±‚ä¸­å®šä¹‰çš„ä¸¤ä¸ªnativeå‡½æ•°åœ¨JNIå±‚çš„å®ç°ã€‚</p><p>native_initçš„JNIå±‚å®ç°</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> kClassMediaScanner <span class="token operator">=</span>        <span class="token string">"android/media/MediaScanner"</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token function">android_media_MediaScanner_native_init</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">{</span>    jclass <span class="token class-name">clazz</span> <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span>kClassMediaScanner<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    fields<span class="token punctuation">.</span>context <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"mNativeContext"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fields<span class="token punctuation">.</span>context <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>processFileçš„JNIå±‚å®ç°</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token function">android_media_MediaScanner_processFile</span><span class="token punctuation">(</span>        JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring path<span class="token punctuation">,</span>        jstring mimeType<span class="token punctuation">,</span> jobject client<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Lock already hold by processDirectory</span>    MediaScanner <span class="token operator">*</span>mp <span class="token operator">=</span> <span class="token function">getNativeScanner_l</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> thiz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathStr <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> pathStr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">,</span> mimeTypeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è¿™è¾¹æˆ‘ä»¬æ¥è§£ç­”ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç¡®å®æ˜¯çŸ¥é“MediaScannerçš„nativeå‡½æ•°æ˜¯JNIå±‚å»å®ç°çš„ï¼Œä½†æ˜¯ç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“Javaå±‚çš„native_initå‡½æ•°å¯¹åº”çš„å°±æ˜¯JNIå±‚çš„android_media_MediaScanner_native_initå‡½æ•°å‘¢ï¼Ÿ</p><h2 id="3-2-æ³¨å†ŒJNIå‡½æ•°"><a href="#3-2-æ³¨å†ŒJNIå‡½æ•°" class="headerlink" title="3.2 æ³¨å†ŒJNIå‡½æ•°"></a>3.2 æ³¨å†ŒJNIå‡½æ•°</h2><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°native_initå‡½æ•°ä½äºandroid.mediaè¿™ä¸ªåŒ…ä¸­ï¼Œå®ƒçš„å…¨è·¯å¾„ååº”è¯¥æ˜¯android.media.MediaScanner.native_initï¼Œè€ŒJNIå±‚å‡½æ•°çš„åå­—æ˜¯android_media_MediaScanner_native_initã€‚</p><p>æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Ÿåå­—å¯¹åº”ç€ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯â€œ.â€è¿™ä¸ªç¬¦å·å˜æˆäº†â€œ<em>â€ã€‚å› ä¸ºåœ¨Nativeè¯­è¨€ä¸­ï¼Œç¬¦å·â€œ.â€æœ‰ç€ç‰¹æ®Šçš„æ„ä¹‰ï¼Œæ‰€ä»¥JNIå±‚éœ€è¦æŠŠJavaå‡½æ•°åç§°ï¼ˆåŒ…æ‹¬åŒ…åï¼‰ä¸­çš„â€œ.â€æ¢æˆâ€œ</em>â€ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼Œnative_initæ‰¾åˆ°äº†è‡ªå·±JNIå±‚çš„æœ¬å®¶å…„å¼Ÿandroid.media.MediaScanner.native_initã€‚</p><p>æˆ‘ä»¬çŸ¥é“äº†Javaå±‚nativeå‡½æ•°å¯¹åº”JNIå±‚çš„å‡½æ•°çš„åŸç†ï¼Œä½†æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“æ˜¯å“ªä¸ªå‡½æ•°ï¼Œä½†æ˜¯æƒ³è¦æŠŠä¸¤ä¸ªå‡½æ•°å…³è”èµ·æ¥ï¼ˆä¹Ÿå°±æ˜¯è¯´å»è°ƒç”¨å®ƒï¼‰å°±æ¶‰åŠåˆ°JNIå‡½æ•°æ³¨å†Œçš„é—®é¢˜ï¼ˆä¸æ³¨å†Œï¼Œå°±æ²¡æœ‰å…³è”ï¼Œæ²¡æœ‰å…³è”å°±æ— æ³•è°ƒç”¨ï¼‰ã€‚</p><h3 id="3-2-1-é™æ€æ–¹æ³•æ³¨å†Œ"><a href="#3-2-1-é™æ€æ–¹æ³•æ³¨å†Œ" class="headerlink" title="3.2.1 é™æ€æ–¹æ³•æ³¨å†Œ"></a>3.2.1 é™æ€æ–¹æ³•æ³¨å†Œ</h3><p>è¿™ç§æ–¹æ³•å¾ˆç®€å•ï¼Œå¾ˆæš´åŠ›ï¼ç›´æ¥æ ¹æ®å‡½æ•°åæ¥æ‰¾å¯¹åº”çš„JNIå‡½æ•°ï¼Œå®ƒéœ€è¦Javaçš„å·¥å…·ç¨‹åºjavahå‚ä¸ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ å…ˆç¼–å†™Javaä»£ç ï¼Œç„¶åç¼–è¯‘ç”Ÿæˆ.classæ–‡ä»¶ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä½¿ç”¨Javaçš„å·¥å…·ç¨‹åºjavahï¼Œé‡‡ç”¨å‘½ä»¤â€œjavah -o output packagename.classnameâ€ï¼Œè¿™æ ·å®ƒä¼šç”Ÿæˆä¸€ä¸ªå«output.hçš„JNIå±‚å¤´æ–‡ä»¶ã€‚å…¶ä¸­packagename.classnameæ˜¯Javaä»£ç ç¼–è¯‘åçš„classæ–‡ä»¶ï¼Œè€Œåœ¨ç”Ÿæˆçš„output.hæ–‡ä»¶é‡Œï¼Œå£°æ˜äº†å¯¹åº”çš„JNIå±‚å‡½æ•°ï¼Œåªè¦å®ç°é‡Œé¢çš„å‡½æ•°å³å¯ã€‚</p><p>è¿™ä¸ªå¤´æ–‡ä»¶çš„åå­—ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨packagename_class.hçš„æ ·å¼ï¼Œä¾‹å¦‚MediaScannerå¯¹åº”çš„JNIå±‚å¤´æ–‡ä»¶å°±æ˜¯android_media_MediaScanner.hã€‚</p><pre class=" language-h"><code class="language-h">/* DO NOT EDIT THIS FILE - it is machine generated*/  #include <jni.h>        // å¿…é¡»åŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œå¦åˆ™ç¼–è¯‘é€šä¸è¿‡/* Header for class android_media_MediaScanner */#ifndef _Included_android_media_MediaScanner#define _Included_android_media_MediaScanner#ifdef _cplusplusextern "C" {#endif... ...     // ç•¥å»ä¸€éƒ¨åˆ†å†…å®¹// processFileå¯¹åº”çš„JNIå‡½æ•°JNIEXPORT void JNICALL Java_android_media_MediaScanner_processFile(JNIEnv *, jobject, jstring, jstring, jobject);... ...     // ç•¥å»ä¸€éƒ¨åˆ†å†…å®¹// native_initå¯¹åº”çš„JNIå‡½æ•°JNIEXPORT void JNICALL Java_android_media_MediaScanner_native_linit(JNIEnv *, jclass);#ifdef _cplusplus}#endif#endif</code></pre><p>ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥å‘ç°ï¼Œnative_initå’ŒprocessFileçš„JNIå±‚å‡½æ•°è¢«å£°æ˜æˆï¼š</p><pre class=" language-h"><code class="language-h">// Java å±‚å‡½æ•°åä¸­å¦‚æœç”±ä¸€ä¸ªâ€œ_â€ï¼Œ è½¬æ¢æˆJNIåå°±å˜æˆäº†â€œlâ€JNIEXPORT void JNICALL Java_android_media_MediaScanner_processFileJNIEXPORT void JNICALL Java_android_media_MediaScanner_native_linit</code></pre><p>Okï¼Œé‚£ä¹ˆé™æ€æ–¹æ³•ä¸­nativeå‡½æ•°æ˜¯å¦‚ä½•æ‰¾åˆ°å¯¹åº”çš„JNIå‡½æ•°çš„å‘¢ï¼Ÿ</p><p>å½“Javaå±‚è°ƒç”¨native_initå‡½æ•°æ—¶ï¼Œå®ƒä¼šä»å¯¹åº”çš„JNIåº“ä¸­å¯»æ‰¾Java_android_media_MediaScanner_native_initå‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šæŠ¥é”™ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåˆ™ä¼šä¸ºè¿™ä¸ªnative_initå’ŒJava_android_media_MediaScanner_native_initå»ºç«‹ä¸€ä¸ªå…³è”å…³ç³»ï¼Œå…¶å®å°±æ˜¯ä¿å­˜JNIå±‚å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆã€‚ä»¥åå†è°ƒç”¨native_initå‡½æ•°æ—¶ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå°±å¯ä»¥äº†ï¼Œå½“ç„¶è¿™é¡¹å·¥ä½œæ˜¯ç”±è™šæ‹Ÿæœºå®Œæˆçš„ã€‚</p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œé™æ€æ–¹æ³•å°±æ˜¯æ ¹æ®å‡½æ•°åæ¥å»ºç«‹Javaå‡½æ•°ä¸JNIå‡½æ•°ä¹‹é—´çš„å…³è”å…³ç³»çš„ï¼Œè€Œä¸”å®ƒè¦æ±‚JNIå‡½æ•°çš„åå­—å¿…é¡»éµå¾ªç‰¹å®šçš„æ ¼å¼ã€‚</p><p>è¿™ç§æ–¹æ³•æœ‰ä¸‰ä¸ªå¼Šç«¯ï¼Œå¦‚ä¸‹ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ éœ€è¦ç¼–è¯‘æ‰€æœ‰å£°æ˜äº†nativeå‡½æ•°çš„Javaç±»ï¼Œæ¯ä¸ªæ‰€ç”Ÿæˆçš„classæ–‡ä»¶éƒ½å¾—ç”¨javahç”Ÿæˆä¸€ä¸ªå¤´æ–‡ä»¶ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ javahç”Ÿæˆçš„JNIå±‚å‡½æ•°åç‰¹åˆ«é•¿ï¼Œä¹¦å†™èµ·æ¥å¾ˆä¸æ–¹ä¾¿ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ åˆæ¬¡è°ƒç”¨nativeå‡½æ•°æ—¶éœ€è¦æ ¹æ®å‡½æ•°åç§°æœç´¢å¯¹åº”çš„JNIå‡½æ•°æ¥å»ºç«‹å…³è”å…³ç³»ï¼Œè¿™æ ·ä¼šå½±å“è¿è¡Œæ•ˆç‡ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æ˜¯å¦æœ‰åŠæ³•å…‹æœä»¥ä¸Šä¸‰ç‚¹å¼Šç«¯ï¼Ÿæˆ‘ä»¬çŸ¥é“é™æ€æ–¹æ³•æ˜¯å»åŠ¨æ€åº“é‡Œæ‰¾ä¸€éï¼Œç„¶åå»ºç«‹å…³è”å…³ç³»ï¼Œä»¥åå†æ ¹æ®è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå»è°ƒç”¨å¯¹åº”çš„JNIå‡½æ•°ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç›´æ¥è®©nativeå‡½æ•°ç›´æ¥çŸ¥é“JNIå±‚å¯¹åº”å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œæ˜¯ä¸å°±Okäº†ï¼Ÿ</p><p>è¿™å°±æ˜¯ä¸‹é¢æˆ‘ä»¬è¦ä»‹ç»çš„ç¬¬äºŒç§æ–¹æ³•ï¼šåŠ¨æ€æ³¨å†Œæ³•ï¼</p><h3 id="3-2-2-åŠ¨æ€æ–¹æ³•æ³¨å†Œ"><a href="#3-2-2-åŠ¨æ€æ–¹æ³•æ³¨å†Œ" class="headerlink" title="3.2.2 åŠ¨æ€æ–¹æ³•æ³¨å†Œ"></a>3.2.2 åŠ¨æ€æ–¹æ³•æ³¨å†Œ</h3><p>æˆ‘ä»¬çŸ¥é“Java nativeå‡½æ•°å’ŒJNIå‡½æ•°æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™ä¸ªå°±åƒæˆ‘ä»¬key-valueä¸€æ ·ï¼Œé‚£ä¹ˆå¦‚æœæœ‰ä¸€ä¸ªç»“æ„æ¥ä¿å­˜è¿™ç§å…³è”å…³ç³»ï¼Œé‚£ä¹ˆé€šè¿‡è¿™ä¸ªç»“æ„ç›´æ¥å¯ä»¥æ‰¾åˆ°å½¼æ­¤çš„å…³è”ï¼Œæ˜¯ä¸æ˜¯å°±æ•ˆç‡å°±é«˜å¤šäº†ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼ŒåŠ¨æ€æ³¨å†Œå°±æ˜¯è¿™ä¹ˆå¹²çš„ï¼åœ¨JNIæŠ€æœ¯ä¸­ï¼Œç”¨æ¥è®°å½•è¿™ç§ä¸€ä¸€å¯¹åº”å…³ç³»çš„ï¼Œæ˜¯ä¸€ä¸ªå« JNINativeMethod çš„ç»“æ„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class=" language-h"><code class="language-h">typedef struct {    char *name;                      // Javaä¸­nativeå‡½æ•°çš„åå­—ï¼Œä¸ç”¨æºå¸¦åŒ…çš„è·¯å¾„ï¼Œä¾‹å¦‚ï¼šnative_init    char *signature;                 // Javaä¸­å‡½æ•°çš„ç­¾åä¿¡æ¯ï¼Œç”¨å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œæ˜¯å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹çš„é›†åˆ    void *fnPtr;                     // JNIå±‚å¯¹åº”å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œæ³¨æ„å®ƒæ˜¯ void* ç±»å‹}JNINativeMethod;</code></pre><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“ï¼Œçœ‹ä¸‹MediaScanner JNIå±‚æ˜¯å¦‚ä½•åšçš„ã€‚</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// å®šä¹‰ä¸€ä¸ªJNINativeMethodæ•°ç»„ï¼Œå…¶æˆå‘˜å°±æ˜¯MediaScannerä¸­æ‰€æœ‰nativeå‡½æ•°çš„ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚</span><span class="token keyword">static</span> <span class="token keyword">const</span> JNINativeMethod gMethods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">{</span>        <span class="token string">"processFile"</span><span class="token punctuation">,</span>                                    <span class="token comment" spellcheck="true">// Javaä¸­nativeå‡½æ•°çš„å‡½æ•°å</span>        <span class="token string">"(Ljava/lang/String;Ljava/lang/String;Landroid/media/MediaScannerClient;)V"</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// processFileçš„ç­¾åä¿¡æ¯</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>android_media_MediaScanner_processFile    <span class="token comment" spellcheck="true">// JNIå±‚å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆ</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">{</span>        <span class="token string">"native_init"</span><span class="token punctuation">,</span>        <span class="token string">"()V"</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>android_media_MediaScanner_native_init    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>æ˜¯ä¸æ˜¯å¾ˆä¸€ç›®äº†ç„¶ï¼Ÿå®šä¹‰å¥½äº†ï¼Œä¸èƒ½ç›´æ¥ç”¨å•Šï¼Œå½“ç„¶éœ€è¦æ³¨å†Œä¸€ä¸‹ã€‚</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// This function only registers the native methods, and is called from</span><span class="token comment" spellcheck="true">// JNI_OnLoad in android_media_MediaPlayer.cpp</span><span class="token comment" spellcheck="true">// æ³¨å†ŒJNINativeMethodæ•°ç»„</span><span class="token keyword">int</span> <span class="token function">register_android_media_MediaScanner</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨AndroidRuntimeçš„registerNativeMethodså‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨æ˜æ˜¯Javaä¸­çš„å“ªä¸ªç±»</span>    <span class="token comment" spellcheck="true">// æˆ‘ä»¬åœ¨è®²è§£ZygoteåŸç†æ—¶ï¼ŒèŠè¿‡åˆ›å»ºJavaè™šæ‹Ÿæœºï¼Œæ³¨å†ŒJNIå‡½æ•°çš„å†…å®¹</span>    <span class="token keyword">return</span> AndroidRuntime<span class="token operator">::</span><span class="token function">registerNativeMethods</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>                kClassMediaScanner<span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>AndroidRunTimeç±»æä¾›äº†ä¸€ä¸ªregisterNativeMethodså‡½æ•°æ¥å®Œæˆæ³¨å†Œçš„å·¥ä½œï¼Œä¸‹é¢æ¥çœ‹ä¸‹registerNativeMethodsçš„å®ç°ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/* * Register native methods using JNI. */</span><span class="token comment" spellcheck="true">/*static*/</span> <span class="token keyword">int</span> AndroidRuntime<span class="token operator">::</span><span class="token function">registerNativeMethods</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> <span class="token keyword">const</span> JNINativeMethod<span class="token operator">*</span> gMethods<span class="token punctuation">,</span> <span class="token keyword">int</span> numMethods<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨jniRegisterNativeMethodså‡½æ•°å®Œæˆæ³¨å†Œ</span>    <span class="token keyword">return</span> <span class="token function">jniRegisterNativeMethods</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> className<span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> numMethods<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å…¶å®ï¼ŒjniRegisterNativeMethodsæ˜¯Androidå¹³å°ä¸­ä¸ºäº†æ–¹ä¾¿JNIä½¿ç”¨è€Œæä¾›çš„ä¸€ä¸ªå¸®åŠ©å‡½æ•°ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">jniRegisterNativeMethods</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> <span class="token keyword">const</span> JNINativeMethod<span class="token operator">*</span> gMethods<span class="token punctuation">,</span> <span class="token keyword">int</span> numMethods<span class="token punctuation">)</span><span class="token punctuation">{</span>    jclass <span class="token class-name">clazz</span><span class="token punctuation">;</span>    clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// å®é™…ä¸Šæ˜¯è°ƒç”¨JNIEnvçš„RegisterNativeså‡½æ•°å®Œæˆæ³¨å†Œçš„</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> numMethods<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æˆ‘çŸ¥é“ä½ çœ‹åˆ°è¿™è¾¹å·²ç»å¤´ç–¼äº†ï¼Œè°ƒç”¨æ¥è°ƒç”¨å»ï¼Œçœ‹ä¸Šå»å¾ˆéº»çƒ¦ï¼Œæ˜¯ä¸æ˜¯ï¼Ÿå…¶å®åŠ¨æ€æ³¨å†Œçš„å·¥ä½œï¼Œåªç”¨ä¸¤ä¸ªå‡½æ•°å°±èƒ½å®Œæˆï¼Œå¦‚ä¸‹ï¼š</p><p>ï¼ˆ1ï¼‰<font color="#FFFF00">jclass clazz = (<em>env)-&gt;FindClass(env, className); </em></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;envæŒ‡å‘ä¸€ä¸ªJNIEnvç»“æ„ä½“ï¼Œå®ƒéå¸¸é‡è¦ï¼Œåé¢æˆ‘ä»¬ä¼šè®¨è®ºã€‚classnameä¸ºå¯¹åº”çš„Javaç±»åï¼Œç”±äºJNINativeMethodä¸­ä½¿ç”¨çš„å‡½æ•°åå¹¶éå…¨è·¯å¾„åï¼Œæ‰€ä»¥è¦æŒ‡æ˜æ˜¯å“ªä¸ªç±»ã€‚<br>ï¼ˆ2ï¼‰<font color="#FFFF00">(env)-&gt;RegisterNatives(env, clazz, gMethods, numMethods); </font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è°ƒç”¨JNIEnvçš„RegisterNativeså‡½æ•°ï¼Œæ³¨å†Œå…³è”å…³ç³»ã€‚</p><p>é‚£ä¹ˆï¼Œä½ ç°åœ¨çŸ¥é“äº†å¦‚æœåŠ¨æ€æ³¨å†Œäº†ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œè¿™äº›åŠ¨æ€æ³¨å†Œçš„å‡½æ•°åœ¨ä»€ä¹ˆæ—¶å€™å’Œä»€ä¹ˆåœ°æ–¹è¢«è°ƒç”¨ï¼Ÿ</p><font color="#FF0000">å½“Javaå±‚é€šè¿‡System.loadLibraryåŠ è½½å®ŒJNIåŠ¨æ€åº“åï¼Œç´§æ¥ç€å°±ä¼šå»æŸ¥æ‰¾è¯¥åº“ä¸­ä¸€ä¸ªå«JNI_OnLoadçš„å‡½æ•°ã€‚å¦‚æœæœ‰ï¼Œå°±è°ƒç”¨å®ƒï¼Œè€ŒåŠ¨æ€æ³¨å†Œçš„å·¥ä½œå°±æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚</font> <h3 id="3-2-3-JNI-OnLoad"><a href="#3-2-3-JNI-OnLoad" class="headerlink" title="3.2.3 JNI_OnLoad"></a>3.2.3 JNI_OnLoad</h3><p>åŠ¨æ€åº“æ˜¯libmedia_jni.soï¼Œé‚£ä¹ˆJNI_OnLoadå‡½æ•°åœ¨å“ªé‡Œå®ç°çš„ï¼Ÿå¦‚æœä½ çœ‹çš„æ¯”è¾ƒè‡ªä¿¡çš„è¯ï¼Œæˆ‘ç›¸ä¿¡ä¹‹å‰ä»£ç ä¸­æœ‰æ®µæ³¨é‡Šä½ åº”è¯¥æ³¨æ„åˆ°äº†ã€‚</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// This function only registers the native methods, and is called from</span><span class="token comment" spellcheck="true">// JNI_OnLoad in android_media_MediaPlayer.cpp                    // çœ‹è¿™é‡Œï¼çœ‹è¿™é‡Œï¼çœ‹è¿™é‡Œï¼ </span><span class="token keyword">int</span> <span class="token function">register_android_media_MediaScanner</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span>              <span class="token comment" spellcheck="true">// è¿™ä¸ªä»£ç å¾ˆç†Ÿæ‚‰å§ï¼Ÿ</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> AndroidRuntime<span class="token operator">::</span><span class="token function">registerNativeMethods</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>                kClassMediaScanner<span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ç”±äºå¤šåª’ä½“ç³»ç»Ÿå¾ˆå¤šåœ°æ–¹éƒ½ä½¿ç”¨äº†JNIï¼Œæ‰€ä»¥JNI_OnLoadè¢«æ”¾åˆ°äº†android_media_MediaPlayer.cppä¸­ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä»£ç ï¼š</p><pre class=" language-cpp"><code class="language-cpp">jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token comment" spellcheck="true">/* reserved */</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹ä¸ºJavaVMï¼Œè¿™å¯æ˜¯è™šæ‹Ÿæœºåœ¨JNIå±‚çš„ä»£è¡¨å“¦ï¼Œæ¯ä¸ªJavaè¿›ç¨‹åªæœ‰ä¸€ä¸ªè¿™æ ·çš„JavaVM</span>    JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    jint result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_4<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">goto</span> bail<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">register_android_media_MediaScanner</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"ERROR: MediaScanner native registration failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> bail<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">/* success -- return valid version number */</span>    result <span class="token operator">=</span> JNI_VERSION_1_4<span class="token punctuation">;</span>bail<span class="token operator">:</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="3-3-æ•°æ®ç±»å‹è½¬æ¢"><a href="#3-3-æ•°æ®ç±»å‹è½¬æ¢" class="headerlink" title="3.3 æ•°æ®ç±»å‹è½¬æ¢"></a>3.3 æ•°æ®ç±»å‹è½¬æ¢</h2><p>åœ¨Javaä¸­è°ƒç”¨nativeå‡½æ•°ä¼ é€’çš„å‚æ•°æ˜¯Javaæ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆè¿™äº›å‚æ•°ç±»å‹ä¼ é€’åˆ°JNIå±‚ä¼šå˜æˆä»€ä¹ˆç±»å‹ï¼Ÿ</p><p>Javaæ•°æ®ç±»å‹åˆ†ä¸º<strong>â€œåŸºæœ¬æ•°æ®ç±»å‹â€</strong>å’Œ<strong>â€œå¼•ç”¨æ•°æ®ç±»å‹â€</strong>ä¸¤ç§ï¼ŒJNIå±‚ä¹Ÿæ˜¯åŒºåˆ«å¯¹å¾…ä¸¤è€…çš„ã€‚</p><h3 id="3-3-1-åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢"><a href="#3-3-1-åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢" class="headerlink" title="3.3.1 åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢"></a>3.3.1 åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢</h3><table><thead><tr><th>JavaåŸºæœ¬ç±»å‹</th><th>Nativeç±»å‹</th><th>ç¬¦å·å±æ€§</th><th>å­—é•¿</th></tr></thead><tbody><tr><td>boolean</td><td>jboolean</td><td>æ— ç¬¦å·</td><td>8ä½</td></tr><tr><td>byte</td><td>jbyte</td><td>æ— ç¬¦å·</td><td>8ä½</td></tr><tr><td>char</td><td>jchar</td><td>æ— ç¬¦å·</td><td>16ä½</td></tr><tr><td>short</td><td>jshort</td><td>æœ‰ç¬¦å·</td><td>16ä½</td></tr><tr><td>int</td><td>jint</td><td>æœ‰ç¬¦å·</td><td>32ä½</td></tr><tr><td>long</td><td>jlong</td><td>æœ‰ç¬¦å·</td><td>64ä½</td></tr><tr><td>float</td><td>jfloat</td><td>æœ‰ç¬¦å·</td><td>32ä½</td></tr><tr><td>double</td><td>jdoublt</td><td>æœ‰ç¬¦å·</td><td>64ä½</td></tr></tbody></table><h3 id="3-3-2-å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢"><a href="#3-3-2-å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢" class="headerlink" title="3.3.2 å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢"></a>3.3.2 å¼•ç”¨æ•°æ®ç±»å‹çš„è½¬æ¢</h3><table><thead><tr><th>Javaå¼•ç”¨ç±»å‹</th><th>Nativeç±»å‹</th><th>Javaå¼•ç”¨ç±»å‹</th><th>Nativeç±»å‹</th></tr></thead><tbody><tr><td>All objects</td><td>jobject</td><td>char[]</td><td>jcharArray</td></tr><tr><td>java.lang.Class å®ä¾‹</td><td>jclass</td><td>short[]</td><td>jshortArray</td></tr><tr><td>java.lang.String å®ä¾‹</td><td>jstring</td><td>int[]</td><td>jintArray</td></tr><tr><td>Object[]</td><td>jobjectArray</td><td>long[]</td><td>jlongArray</td></tr><tr><td>boolean[]</td><td>jbooleanArray</td><td>float</td><td>jfloatArray</td></tr><tr><td>byte[]</td><td>jbyteArray</td><td>double[]</td><td>jdoubleArray</td></tr><tr><td>java.lang.Throwable å®ä¾‹</td><td>jthrowable</td><td></td><td></td></tr></tbody></table><p>æˆ‘ä»¬ä¸¾ä¾‹è¯´æ˜ï¼Œçœ‹ä¸‹processFileå‡½æ•°ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">private</span> native <span class="token keyword">void</span> <span class="token function">processFile</span>                   <span class="token punctuation">(</span>                           String  path<span class="token punctuation">,</span>  String  mimeType<span class="token punctuation">,</span>  MediaScannerClient client<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_media_MediaScanner_processFile</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring path<span class="token punctuation">,</span>  jstring mimeType<span class="token punctuation">,</span>  jobject            client<span class="token punctuation">)</span></code></pre><p>æˆ‘ä»¬å‘ç°ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Javaçš„Stringç±»å‹åœ¨JNIå±‚å¯¹åº”ä¸ºjstringç±»å‹ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Javaçš„MediaScannerClientç±»å‹åœ¨JNIå±‚å¯¹åº”ä¸ºjobjectã€‚</p><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ä¸€ä¸ªé—®é¢˜ï¼ŒJavaä¸­çš„processFileä¸­åªæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œä¸ºä»€ä¹ˆåˆ°äº†JNIå±‚å¯¹åº”çš„å‡½æ•°å´æœ‰äº”ä¸ªå‚æ•°ï¼Ÿ</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_media_MediaScanner_processFile</span><span class="token punctuation">(</span>        JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring path<span class="token punctuation">,</span>        jstring mimeType<span class="token punctuation">,</span> jobject client<span class="token punctuation">)</span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹é‡ç‚¹è®¨è®ºJNIEnvï¼ï¼ï¼</p><h2 id="3-4-JNIEnv"><a href="#3-4-JNIEnv" class="headerlink" title="3.4 JNIEnv"></a>3.4 JNIEnv</h2><p><strong><font color="#FFFF00">JNIEnvçš„æ¦‚å¿µ</font></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ˜¯ä¸€ä¸ªä¸çº¿ç¨‹ç›¸å…³çš„ä»£è¡¨JNIç¯å¢ƒçš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ä»£è¡¨äº†Javaåœ¨æœ¬çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒã€‚<br><strong><font color="#FFFF00">JNUEnvçš„ä½œç”¨</font></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ è°ƒç”¨ Java å‡½æ•° : JNIEnv ä»£è¡¨ Java æ‰§è¡Œç¯å¢ƒ, èƒ½å¤Ÿä½¿ç”¨ JNIEnv è°ƒç”¨ Java ä¸­çš„ä»£ç <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ æ“ä½œ Java å¯¹è±¡ : Java å¯¹è±¡ä¼ å…¥ JNI å±‚å°±æ˜¯ Jobject å¯¹è±¡, é¡»è¦ä½¿ç”¨ JNIEnv æ¥æ“ä½œè¿™ä¸ª Java å¯¹è±¡</p><p><strong><font color="#00FFFF">æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡</font></strong></p><p>å‰é¢ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ JNIEnv æ˜¯ä¸€ä¸ªä¸çº¿ç¨‹ç›¸å…³çš„å˜é‡ï¼Œå¦‚æœæ­¤æ—¶çº¿ç¨‹ A æœ‰ä¸€ä¸ª JNIEnv å˜é‡ï¼Œ çº¿ç¨‹ B ä¹Ÿæœ‰ä¸€ä¸ªJNIEnvå˜é‡ï¼Œç”±äºçº¿ç¨‹ç›¸å…³ï¼Œæ‰€ä»¥ A çº¿ç¨‹ä¸èƒ½ä½¿ç”¨ B çº¿ç¨‹çš„ JNIEnv ç»“æ„ä½“å˜é‡ã€‚<br>æ­¤æ—¶ï¼Œä¸€ä¸ªjavaå¯¹è±¡é€šè¿‡JNIè°ƒç”¨åŠ¨æ€åº“ä¸­çš„ä¸€ä¸ªsend()å‡½æ•°å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼Œä¸ç­‰æœåŠ¡å™¨æ¶ˆæ¯åˆ°æ¥å°±ç«‹å³è¿”å›ï¼ŒåŒæ—¶æŠŠJNIæ¥å£çš„æŒ‡é’ˆJNIEnv *env(è™šæ‹Ÿæœºç¯å¢ƒæŒ‡é’ˆ)ï¼Œå’Œjobject objä¿å­˜åœ¨åŠ¨æ€åº“ä¸­çš„å˜é‡é‡Œã€‚ä¸€æ®µæ—¶é—´åï¼ŒåŠ¨æ€åº“ä¸­çš„æ¶ˆæ¯æ¥æ”¶çº¿ç¨‹æ¥æ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„æ¶ˆæ¯ï¼Œå¹¶è¯•å›¾é€šè¿‡ä¿å­˜è¿‡çš„envå’Œobjæ¥è°ƒç”¨å…ˆå‰çš„javaå¯¹è±¡çš„æ–¹æ³•(ç›¸å½“äºJAVAå›è°ƒæ–¹æ³•)æ¥å¤„ç†æ­¤æ¶ˆæ¯ï¼Œ<strong><font color="#FF0000">æ­¤æ—¶ç¨‹åºçªç„¶é€€å‡º(å´©æºƒ)</font></strong>ã€‚</p><p><strong><font color="#00FFFF">ä¸ºä»€ä¹ˆï¼Ÿ</font></strong></p><p><strong><font color="#FF0000">åŸå› </font>ï¼š</strong>å‰å°JAVAçº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œåå°çº¿ç¨‹å¤„ç†æ¶ˆæ¯ï¼Œå½’å±äºä¸¤ä¸ªä¸åŒçš„çº¿ç¨‹ï¼Œä¸èƒ½ä½¿ç”¨ç›¸åŒçš„JNIEnvå˜é‡ã€‚</p><p><strong><font color="#00FFFF">æ€ä¹ˆè§£å†³ï¼Ÿ</font></strong></p><p>è¿˜è®°å¾—æˆ‘ä»¬å‰é¢ä»‹ç»çš„JNI_OnLoadå‡½æ•°å—ï¼Ÿå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯JavaVMï¼Œå®ƒæ˜¯è™šæ‹Ÿæœºåœ¨JNIå±‚çš„ä»£è¡¨ï¼ï¼ï¼</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// å…¨è¿›ç¨‹åªæœ‰ä¸€ä¸ªJavaVMå¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨</span>jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token comment" spellcheck="true">/* reserved */</span><span class="token punctuation">)</span></code></pre><p>é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä¸è®ºè¿›ç¨‹æœ‰å¤šå°‘çº¿ç¨‹ï¼ˆä¸è®ºæœ‰å¤šå°‘JNIEnvï¼‰ï¼ŒJavaVMå´æ˜¯ç‹¬æ­¤ä¸€ä»½ï¼æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸ªæœºåˆ¶ï¼šåˆ©ç”¨å…¨å±€çš„ JavaVM <em> æŒ‡é’ˆå¾—åˆ°å½“å‰çº¿ç¨‹çš„ JNIEnv</em> æŒ‡é’ˆã€‚</p><p><strong><font color="#FFFF00">JavaVMå’ŒJNIEnv</font></strong>ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ è°ƒç”¨JavaVMçš„AttachCurrentThreadå‡½æ•°ï¼Œå°±å¯å¾—åˆ°è¿™ä¸ªçº¿ç¨‹çš„JNIEnvç»“æ„ä½“ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åå°çº¿ç¨‹ä¸­å›è°ƒJavaå‡½æ•°äº†ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ å¦å¤–ï¼Œåœ¨åå°çº¿ç¨‹é€€å‡ºå‰ï¼Œéœ€è¦è°ƒç”¨JavaVMçš„DetachCurrentThreadå‡½æ•°æ¥é‡Šæ”¾å¯¹åº”çš„èµ„æºã€‚</p><h2 id="3-5-é€šè¿‡JNIEnvæ“ä½œjobject"><a href="#3-5-é€šè¿‡JNIEnvæ“ä½œjobject" class="headerlink" title="3.5 é€šè¿‡JNIEnvæ“ä½œjobject"></a>3.5 é€šè¿‡JNIEnvæ“ä½œjobject</h2><p>å‰é¢ä»‹ç»æ•°æ®ç±»å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“Javaçš„å¼•ç”¨ç±»å‹é™¤äº†å°‘æ•°å‡ ä¸ªå¤–ï¼ˆClassã€Stringå’ŒThrowableï¼‰ï¼Œæœ€ç»ˆåœ¨JNIå±‚éƒ½ä¼šç”¨jobjectæ¥è¡¨ç¤ºå¯¹è±¡çš„æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•æ“ä½œè¿™ä¸ªjobjectå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆå›é¡¾ä¸‹Javaå¯¹è±¡æ˜¯ç”±ä»€ä¹ˆç»„æˆçš„ï¼Ÿå½“ç„¶æ˜¯å®ƒçš„æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°äº†ï¼é‚£ä¹ˆåŒç†ï¼Œæ“ä½œjobjectçš„æœ¬è´¨å°±åº”å½“æ˜¯æ“ä½œè¿™äº›å¯¹è±¡çš„æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°ï¼é‚£ä¹ˆjobjectçš„æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°åˆæ˜¯ä»€ä¹ˆï¼Ÿ</p><h3 id="3-5-1-å–å‡ºjfieldIDå’ŒjmethodID"><a href="#3-5-1-å–å‡ºjfieldIDå’ŒjmethodID" class="headerlink" title="3.5.1 å–å‡ºjfieldIDå’ŒjmethodID"></a>3.5.1 å–å‡ºjfieldIDå’ŒjmethodID</h3><p>åœ¨javaä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°éƒ½æ˜¯ç”±ç±»å®šä¹‰çš„ï¼Œä»–ä»¬æ˜¯ç±»çš„å±æ€§ï¼Œé‚£ä¹ˆåœ¨JNIè§„åˆ™ä¸­ï¼Œä¹Ÿæ˜¯è¿™ä¹ˆæ¥å®šä¹‰çš„ï¼Œç”¨jfieldIDå®šä¹‰Javaç±»çš„æˆå‘˜å˜é‡ï¼Œç”¨jmethodIDå®šä¹‰Javaç±»çš„æˆå‘˜å‡½æ•°ã€‚</p><p>å¯é€šè¿‡JNIEnvçš„ä¸‹é¢ä¸¤ä¸ªå‡½æ•°å¾—åˆ°ï¼š</p><pre class=" language-cpp"><code class="language-cpp">jfieldID <span class="token function">GetFieldID</span><span class="token punctuation">(</span>jclass <span class="token class-name">clazz</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> sig<span class="token punctuation">)</span>jmethodID <span class="token function">GetMethodID</span><span class="token punctuation">(</span>jclass <span class="token class-name">clazz</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> sig<span class="token punctuation">)</span></code></pre><p>å…¶ä¸­ï¼Œjclassä»£è¡¨Javaç±»ï¼Œnameè¡¨ç¤ºæˆå‘˜å‡½æ•°æˆ–æˆå‘˜å˜é‡çš„åå­—ï¼Œsigä¸ºè¿™ä¸ªå‡½æ•°å’Œå˜é‡çš„ç­¾åä¿¡æ¯ï¼ˆåé¢ä¼šè¯´åˆ°ï¼‰ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨MediaScannerä¸­å¦‚ä½•ä½¿ç”¨å®ƒä»¬ï¼Œç›´æ¥çœ‹ä»£ç ï¼šandroid_media_MediaScanner.cpp::MyMediaScannerClientæ„é€ å‡½æ•°</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MyMediaScannerClient</span> <span class="token operator">:</span> <span class="token keyword">public</span> MediaScannerClient<span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">MyMediaScannerClient</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject client<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å…ˆæ‰¾åˆ°android.media.MediaScannerClientç±»åœ¨JNIå±‚ä¸­å¯¹åº”çš„jclasså®ä¾‹</span>        jclass <span class="token class-name">mediaScannerClientInterface</span> <span class="token operator">=</span>                env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span>kClassMediaScannerClient<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaScannerClientInterface <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Class %s not found"</span><span class="token punctuation">,</span> kClassMediaScannerClient<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å–å‡ºMediaScannerClientç±»ä¸­å‡½æ•°scanFileçš„jMethodID</span>            mScanFileMethodID <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>                                    mediaScannerClientInterface<span class="token punctuation">,</span>                                    <span class="token string">"scanFile"</span><span class="token punctuation">,</span>                                    <span class="token string">"(Ljava/lang/String;JJZZ)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å–å‡ºMediaScannerClientç±»ä¸­å‡½æ•°handleStringTagçš„jMethodID</span>            mHandleStringTagMethodID <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>                                    mediaScannerClientInterface<span class="token punctuation">,</span>                                    <span class="token string">"handleStringTag"</span><span class="token punctuation">,</span>                                    <span class="token string">"(Ljava/lang/String;Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    jobject mClient<span class="token punctuation">;</span>    jmethodID mScanFileMethodID<span class="token punctuation">;</span>    jmethodID mHandleStringTagMethodID<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>ä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå°†scanFileå’ŒhandleStringTagå‡½æ•°çš„jMethodIDä¿å­˜åœ¨MyMediaScannerClientçš„æˆå‘˜å˜é‡ä¸­ã€‚ä¸ºä»€ä¹ˆè¿™é‡Œè¦æŠŠå®ƒä»¬ä¿å­˜èµ·æ¥å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°ä¸€ä¸ªå…³äºç¨‹åºè¿è¡Œæ•ˆç‡çš„çŸ¥è¯†ç‚¹ï¼š</p><p>å¦‚æœæ¯æ¬¡æ“ä½œjobjectå‰éƒ½è¦å»æŸ¥è¯¢jmethodIDæˆ–jfieldIDï¼Œé‚£ä¹ˆå°†ä¼šå½±å“ç¨‹åºè¿è¡Œçš„æ•ˆç‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™å¯ä»¥å–å‡ºè¿™äº›IDå¹¶ä¿å­˜èµ·æ¥ä»¥ä¾›åç»­ä½¿ç”¨ã€‚</p><h3 id="3-5-2-ä½¿ç”¨jfieldIDå’ŒjmethodID"><a href="#3-5-2-ä½¿ç”¨jfieldIDå’ŒjmethodID" class="headerlink" title="3.5.2 ä½¿ç”¨jfieldIDå’ŒjmethodID"></a>3.5.2 ä½¿ç”¨jfieldIDå’ŒjmethodID</h3><p>æˆ‘ä»¬æ¥çœ‹çœ‹android_media_MediaScanner.cpp::MyMediaScannerClientçš„scanFileå‡½æ•°</p><pre class=" language-cpp"><code class="language-cpp">    <span class="token keyword">virtual</span> status_t <span class="token function">scanFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> lastModified<span class="token punctuation">,</span>            <span class="token keyword">long</span> <span class="token keyword">long</span> fileSize<span class="token punctuation">,</span> <span class="token keyword">bool</span> isDirectory<span class="token punctuation">,</span> <span class="token keyword">bool</span> noMedia<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        jstring pathStr<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pathStr <span class="token operator">=</span> mEnv<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mEnv<span class="token operator">-</span><span class="token operator">></span><span class="token function">ExceptionClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> NO_MEMORY<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/*         * è°ƒç”¨JNIEnvçš„CallVoidMethodå‡½æ•°         * æ³¨æ„CallVoidMethodçš„å‚æ•°ï¼š         *ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»£è¡¨MediaScannerClientçš„jobjectå¯¹è±¡         *ï¼ˆ2ï¼‰ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°scanFileçš„jmethodIDï¼Œåé¢æ˜¯Javaä¸­çš„scanFileçš„å‚æ•°         */</span>        mEnv<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> mScanFileMethodID<span class="token punctuation">,</span> pathStr<span class="token punctuation">,</span> lastModified<span class="token punctuation">,</span>                fileSize<span class="token punctuation">,</span> isDirectory<span class="token punctuation">,</span> noMedia<span class="token punctuation">)</span><span class="token punctuation">;</span>        mEnv<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>pathStr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">checkAndClearExceptionFromCallback</span><span class="token punctuation">(</span>mEnv<span class="token punctuation">,</span> <span class="token string">"scanFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>é€šè¿‡JNIEnvè¾“å‡ºCallVoidMethodï¼Œå†æŠŠjobjectã€jMethodIDå’Œå¯¹åº”çš„å‚æ•°ä¼ è¿›å»ï¼ŒJNIå±‚å°±èƒ½å¤Ÿè°ƒç”¨Javaå¯¹è±¡çš„å‡½æ•°äº†ï¼</p><p>å®é™…ä¸ŠJNIEnvè¾“å‡ºäº†ä¸€ç³»åˆ—ç±»ä¼¼CallVoidMethodçš„å‡½æ•°ï¼Œå½¢å¼å¦‚ä¸‹ï¼š</p><pre class=" language-cpp"><code class="language-cpp">NativeType Call<span class="token operator">&lt;</span>type<span class="token operator">></span><span class="token function">Method</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jmethodID methodID<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></code></pre><p>å…¶ä¸­typeå¯¹åº”javaå‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œä¾‹å¦‚CallIntMethodã€CallVoidMethodç­‰ã€‚å¦‚æœæƒ³è°ƒç”¨Javaä¸­çš„staticå‡½æ•°ï¼Œåˆ™ç”¨JNIEnvè¾“å‡ºçš„CallStatic<type>Methodç³»åˆ—å‡½æ•°ã€‚</type></p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶jobjectæ˜¯é€æ˜çš„ï¼Œä½†æœ‰äº†JNIEnvçš„å¸®åŠ©ï¼Œè¿˜æ˜¯èƒ½è½»æ¾æ“ä½œjobjectèƒŒåçš„å®é™…å¯¹è±¡çš„ã€‚</p><h2 id="3-6-jstring"><a href="#3-6-jstring" class="headerlink" title="3.6 jstring"></a>3.6 jstring</h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬å•ç‹¬èŠèŠStringã€‚Javaä¸­çš„Stringä¹Ÿæ˜¯å¼•ç”¨ç±»å‹ï¼Œä¸è¿‡ç”±äºå®ƒçš„ä½¿ç”¨é¢‘ç‡å¾ˆé«˜ï¼Œæ‰€ä»¥åœ¨JNIè§„èŒƒä¸­å•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªjstringç±»å‹æ¥è¡¨ç¤ºJavaä¸­çš„Stringç±»å‹ã€‚<br>è™½ç„¶jstringæ˜¯ä¸€ç§ç‹¬ç«‹çš„æ•°æ®ç´¯å¿ƒï¼Œä½†æ˜¯å®ƒå¹¶æ²¡æœ‰æä¾›æˆå‘˜å‡½æ•°ä»¥ä¾¿æ“ä½œã€‚è€ŒC++ä¸­çš„stringç±»æ˜¯ç”±è‡ªå·±çš„æˆå‘˜å‡½æ•°çš„ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•æ“ä½œjstringå‘¢ï¼Ÿè¿˜æ˜¯å¾—ä¾é JNIEnvæä¾›å¸®åŠ©ã€‚</p><p>å…ˆçœ‹å‡ ä¸ªæœ‰å…³jstringçš„å‡½æ•°ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ è°ƒç”¨JNIEnvçš„NewString(const jchar<em> unicodeChars, jsize len)ï¼Œå¯ä»¥ä»Nativeçš„å­—ç¬¦ä¸²å¾—åˆ°ä¸€ä¸ªjstringå¯¹è±¡ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ è°ƒç”¨JNIEnvçš„NewStringUTF(const char</em> bytes)å°†æ ¹æ®Nativeçš„ä¸€ä¸ªUTF-8å­—ç¬¦ä¸²å¾—åˆ°ä¸€ä¸ªjstringå¯¹è±¡ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ ä¸Šé¢ä¸¤ä¸ªå‡½æ•°å°†æœ¬åœ°å­—ç¬¦ä¸²è½¬æ¢æˆäº†Javaçš„Stringå¯¹è±¡ï¼ŒJNIEnvè¿˜æä¾›äº†GetStringCharså‡½æ•°å’ŒGetStringUTFCharså‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥å°†Java Stringå¯¹è±¡è½¬æ¢æˆæœ¬åœ°å­—ç¬¦ä¸²ã€‚å…¶ä¸­GetStringCharså¾—åˆ°ä¸€ä¸ªUnicodeå­—ç¬¦ä¸²ï¼Œè€ŒGetStringUTFCharså¾—åˆ°ä¸€ä¸ªUTF-8å­—ç¬¦ä¸²ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ å¦å¤–ï¼Œå¦‚æœåœ¨ä»£ç ä¸­è°ƒç”¨äº†ä¸Šé¢å‡ ä¸ªå‡½æ•°ï¼Œåœ¨åšå®Œç›¸å…³å·¥ä½œåï¼Œå°±éƒ½éœ€è¦è°ƒç”¨ReleaseStringCharså‡½æ•°æˆ–ReleaseStringUTFCharså‡½æ•°æ¥å¯¹åº”åœ°é‡Šæ”¾èµ„æºï¼Œå¦è®¤ä¼šå¯¼è‡´JVMå†…å­˜æ³„æ¼ã€‚</p><p>æˆ‘ä»¬çœ‹æ®µä»£ç åŠ æ·±å°è±¡ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token function">android_media_MediaScanner_processFile</span><span class="token punctuation">(</span>        JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring path<span class="token punctuation">,</span>        jstring mimeType<span class="token punctuation">,</span> jobject client<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Lock already hold by processDirectory</span>    MediaScanner <span class="token operator">*</span>mp <span class="token operator">=</span> <span class="token function">getNativeScanner_l</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> thiz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mimeTypeStr <span class="token operator">=</span>        <span class="token punctuation">(</span>mimeType <span class="token operator">?</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mimeType <span class="token operator">&amp;&amp;</span> mimeTypeStr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Out of memory</span>        <span class="token comment" spellcheck="true">// ReleaseStringUTFChars can be called with an exception pending.</span>        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> pathStr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="3-7-JNIç±»å‹ç­¾å"><a href="#3-7-JNIç±»å‹ç­¾å" class="headerlink" title="3.7 JNIç±»å‹ç­¾å"></a>3.7 JNIç±»å‹ç­¾å</h2><p>æˆ‘ä»¬çœ‹ä¸‹åŠ¨æ€æ³¨å†Œä¸­çš„ä¸€æ®µä»£ç ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">const</span> JNINativeMethod gMethods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">{</span>        <span class="token string">"processFile"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// processFileçš„ç­¾åä¿¡æ¯ï¼Œè¿™ä¹ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</span>        <span class="token string">"(Ljava/lang/String;Ljava/lang/String;Landroid/media/MediaScannerClient;)V"</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>android_media_MediaScanner_processFile    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>ä¸Šé¢è¿™æ®µä»£ç æˆ‘ä»¬ä¹‹å‰æ—©å°±è§è¿‡äº†ï¼Œä¸è¿‡â€(Ljava/lang/String;Ljava/lang/String;Landroid/media/MediaScannerClient;)Vâ€æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œè¿™ä¸ªæ˜¯Javaä¸­å¯¹åº”å‡½æ•°çš„ç­¾åä¿¡æ¯ï¼Œç”±å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹å…±åŒç»„æˆï¼Œæœ‰äººå¯èƒ½æœ‰ç–‘é—®ï¼Œè¿™ä¸œè¥¿æ˜¯å¹²å˜›çš„ï¼Ÿ</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJavaæ”¯æŒå‡½æ•°é‡è½½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥å®šä¹‰åŒåä½†ä¸åŒå‚æ•°çš„å‡½æ•°ã€‚ä½†ä»…ä»…æ ¹æ®å‡½æ•°åæ˜¯æ²¡æ³•æ‰¾åˆ°å…·ä½“å‡½æ•°çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJNIæŠ€æœ¯ä¸­å°±å°†å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹çš„ç»„åˆä½œä¸ºä¸€ä¸ªå‡½æ•°çš„ç­¾åä¿¡æ¯ï¼Œæœ‰äº†ç­¾åä¿¡æ¯å’Œå‡½æ•°åï¼Œå°±èƒ½å¾ˆé¡ºåˆ©åœ°æ‰¾åˆ°Javaä¸­çš„å‡½æ•°äº†ã€‚</p><p>JNIè§„èŒƒå®šä¹‰çš„å‡½æ•°ç­¾åä¿¡æ¯çœ‹èµ·æ¥å¾ˆåˆ«æ‰­ï¼Œä¸è¿‡ä¹ æƒ¯å°±å¥½äº†ã€‚å®ƒçš„æ ¼å¼æ˜¯ï¼š</p><p>(å‚æ•° 1 ç±»å‹æ ‡è¯†å‚æ•° 2 ç±»å‹æ ‡è¯† â€¦ å‚æ•° n ç±»å‹æ ‡è¯†) è¿”å›å€¼ç±»å‹æ ‡è¯†</p><p>æˆ‘ä»¬ä»ç„¶æ‹¿processFileçš„ä¾‹å­æ¥çœ‹ä¸‹ï¼š</p><pre class=" language-cpp"><code class="language-cpp">    <span class="token punctuation">{</span>        <span class="token string">"processFile"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// Javaä¸­çš„å‡½æ•°å®šä¹‰ä¸º private native void processFile(String path, String mimeType, MediaScannerClient client);</span>        <span class="token comment" spellcheck="true">// å¯¹åº”çš„JNIå‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</span>        <span class="token string">"(Ljava/lang/String;Ljava/lang/String;Landroid/media/MediaScannerClient;)V"</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// voidç±»å‹å¯¹åº”çš„æ ‡ç¤ºæ˜¯V</span>        <span class="token comment" spellcheck="true">// å½“å‚æ•°çš„ç±»å‹æ˜¯å¼•ç”¨ç±»å‹æ—¶ï¼Œå…¶æ ¼å¼æ˜¯â€œLåŒ…åâ€ï¼Œå…¶ä¸­åŒ…åä¸­çš„â€œ.â€æ¢æˆâ€œ/â€ï¼ŒLjava/lang/Stringè¡¨ç¤ºæ˜¯ä¸€ä¸ªJava Stringç±»å‹</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>android_media_MediaScanner_processFile    <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre><p><strong>ã€æ³¨æ„ã€‘</strong>ï¼šå¼•ç”¨ç±»å‹ï¼ˆé™¤åŸºæœ¬ç±»å‹çš„æ•°ç»„å¤–ï¼‰çš„æ ‡è¯†æœ€åéƒ½æœ‰ä¸€ä¸ªâ€œ;â€ã€‚</p><p>å‡½æ•°ç­¾åä¸ä»…çœ‹èµ·æ¥éº»çƒ¦ï¼Œå†™èµ·æ¥æ›´éº»çƒ¦ï¼Œç¨å¾®å†™é”™ä¸€ä¸ªæ ‡ç‚¹éƒ½ä¼šå¯¼è‡´æ³¨å†Œå¤±è´¥ï¼Œæ‰€ä»¥åœ¨å…·ä½“ç¼–ç æ—¶ï¼Œå¯ä»¥å®šä¹‰å­—ç¬¦ä¸²å®ï¼ˆè¿™è¾¹å°±ä¸å¤šåšè§£é‡Šäº†ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥è¯¢äº†è§£å³å¯ï¼‰ã€‚</p><p>è™½ç„¶å‡½æ•°ç­¾åä¿¡æ¯å¾ˆå®¹æ˜“å†™é”™ï¼Œä½†æ˜¯Javaæä¾›äº†ä¸€ä¸ªå«javapçš„å·¥å…·èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ç”Ÿæˆå‡½æ•°æˆ–å˜é‡çš„ç­¾åä¿¡æ¯ï¼Œå®ƒçš„ç”¨æ³•å¦‚ä¸‹ï¼š</p><p>javap -s -p xxx</p><p>å…¶ä¸­ xxx ä¸ºç¼–è¯‘åçš„classæ–‡ä»¶ï¼Œsè¡¨ç¤ºè¾“å‡ºå†…éƒ¨æ•°æ®ç±»å‹çš„ç­¾åä¿¡æ¯ï¼Œpè¡¨ç¤ºæ‰“å°æ‰€æœ‰å‡½æ•°å’Œæˆå‘˜çš„ç­¾åä¿¡æ¯ï¼Œé»˜è®¤åªä¼šæ‰“å°publicæˆå‘˜å’Œå‡½æ•°çš„ç­¾åä¿¡æ¯ã€‚</p><h2 id="3-8-åƒåœ¾å›æ”¶åŠå¼‚å¸¸å¤„ç†"><a href="#3-8-åƒåœ¾å›æ”¶åŠå¼‚å¸¸å¤„ç†" class="headerlink" title="3.8 åƒåœ¾å›æ”¶åŠå¼‚å¸¸å¤„ç†"></a>3.8 åƒåœ¾å›æ”¶åŠå¼‚å¸¸å¤„ç†</h2><p>è¿™éƒ¨åˆ†æˆ‘æ‰“ç®—å•ç‹¬æ”¾åœ¨ä¸€ç¯‡åšæ–‡ä¸­æ¢è®¨ï¼Œç»“æœå…·ä½“é”™è¯¯è¿›è¡Œåˆ†æã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ ¸å¿ƒæŠ€æœ¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ ¸å¿ƒæŠ€æœ¯ </tag>
            
            <tag> JNI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ LowMemoryKiller</title>
      <link href="/2018/11/01/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhu-zhi-lowmemorykiller/"/>
      <url>/2018/11/01/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhu-zhi-lowmemorykiller/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€æ ¸å¿ƒæºç "><a href="#ä¸€ã€æ ¸å¿ƒæºç " class="headerlink" title="ä¸€ã€æ ¸å¿ƒæºç "></a>ä¸€ã€æ ¸å¿ƒæºç </h1><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">lmkd.c</font></td><td>system/core/lmkd/lmkd.c</td></tr><tr><td><font color="#D15FEE">lmkd.rc</font></td><td>system/core/lmkd/lmkd.rc</td></tr><tr><td><font color="#D15FEE">lowmemorykiller.c</font></td><td>kernel-3.18/drivers/staging/android/lowmemorykiller.c</td></tr><tr><td><font color="#D15FEE">ProcessList.java</font></td><td>frameworks/base/services/core/java/com/android/server/am/ProcessList.java</td></tr></tbody></table><h1 id="äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ"><a href="#äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ"></a>äºŒã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ</h1><p>Android ç³»ç»Ÿçš„è®¾è®¡ç†å¿µæ­£æ˜¯å¸Œæœ›åº”ç”¨è¿›ç¨‹èƒ½å°½é‡é•¿æ—¶é—´åœ°å­˜æ´»ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚åº”ç”¨é¦–æ¬¡æ‰“å¼€æ¯”è¾ƒæ…¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰è¿›ç¨‹åˆ›å»ºä»¥åŠ Application ç­‰ä¿¡æ¯çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥åº”ç”¨åœ¨å¯åŠ¨ä¹‹åï¼Œå³ä¾¿é€€åˆ°åå°å¹¶éç«‹åˆ»æ€æ­»ï¼Œè€Œæ˜¯å­˜æ´»ä¸€æ®µæ—¶é—´ï¼Œè¿™æ ·ä¸‹æ¬¡å†ä½¿ç”¨åˆ™ä¼šéå¸¸å¿«ã€‚å¯¹äº APP åŒæ ·å¸Œæœ›è‡ªèº«å°½å¯èƒ½å­˜æ´»æ›´é•¿çš„æ—¶é—´ï¼Œç°åœ¨å¾ˆå¤šå¼€å‘è€…éƒ½åœ¨æ¢ç´¢å„ç§ä¿æ´»é»‘ç§‘æŠ€ã€‚</p><p>ä½†ç‰©æå¿…åï¼Œå¦‚æœç³»ç»Ÿç»§ç»­æ”¾ä»»æ‰€æœ‰è¿›ç¨‹ä¸€ç›´å­˜æ´»ï¼Œé‚£ä¹ˆç³»ç»Ÿå¤„äºä½å†…å­˜çš„çŠ¶æ€ä¸‹ï¼Œæ€§èƒ½å°±ä¼šæœ‰æ‰€ä¸‹é™ï¼Œå†…å­˜ä¹Ÿä¼šå¾ˆå¿«æ¯ç«­è€Œäº¡ã€‚æ­¤æ—¶æˆ‘ä»¬å°±éœ€è¦è¿›ç¨‹å›æ”¶æœºåˆ¶å¸®åŠ©æˆ‘ä»¬åˆç†çš„æŠŠæ§é‚£äº›è¿›ç¨‹æ”¹å›æ”¶ï¼Œå“ªäº›ä¸è¯¥å›æ”¶ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç³»ç»Ÿå¦‚ä½•åˆ¤æ–­ï¼Ÿåˆ°åº•è¯¥å›æ”¶å“ªä¸ªè¿›ç¨‹ï¼Ÿ<strong><font color="#FF0000">å…¶å®ç³»ç»Ÿä¼šæ ¹æ®è¿›ç¨‹çš„ç»„ä»¶çŠ¶æ€æ¥å†³å®šæ¯ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆçº§å€¼ â€œADJâ€ï¼Œæ ¹æ®ä¸€å®šç­–ç•¥å…ˆæ€ä¼˜å…ˆçº§æœ€ä½çš„è¿›ç¨‹ï¼Œç„¶åé€æ­¥æ€ä¼˜å…ˆçº§æ›´ä½çš„è¿›ç¨‹ã€‚</font></strong>ä»¥æ­¤ç±»æ¨ï¼Œä»¥å›æ”¶é¢„æœŸçš„å¯ç”¨ç³»ç»Ÿèµ„æºï¼Œä»è€Œä¿è¯ç³»ç»Ÿæ­£å¸¸è¿è½¬ã€‚</p><p>æ¥ä¸‹æ¥å°±è¦å¼•å…¥æˆ‘ä»¬æœ¬æ–‡éœ€è¦è®¨è®ºçš„ä¸»è§’äº†ï¼š<strong><font color="#1874CD">LowMemoryKiller</font></strong>ï¼ˆç³»ç»Ÿç”¨äºåˆ¤å®šæ˜¯å¦éœ€è¦æ€è¿›ç¨‹å’Œæ€å“ªäº›è¿›ç¨‹çš„ä¸€ä¸ªæœºåˆ¶ï¼‰ã€‚</p><h1 id="ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§"></a>ä¸‰ã€è¿›ç¨‹ä¼˜å…ˆçº§</h1><p>ç³»ç»Ÿå†…è¿›ç¨‹ä¼˜å…ˆçº§åˆ† 5 çº§ï¼š</p><table><thead><tr><th>è¿›ç¨‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>å‰å°è¿›ç¨‹ï¼ˆForeground processï¼‰</td><td>ç”¨æˆ·å½“å‰æ“ä½œæ‰€å¿…éœ€çš„è¿›ç¨‹ã€‚</td></tr><tr><td>å¯è§è¿›ç¨‹ï¼ˆVisible processï¼‰</td><td>æ²¡æœ‰ä»»ä½•å‰å°ç»„ä»¶ã€ä½†ä»ä¼šå½±å“ç”¨æˆ·åœ¨å±å¹•ä¸Šæ‰€è§å†…å®¹çš„è¿›ç¨‹ã€‚<br>å¯è§è¿›ç¨‹è¢«è§†ä¸ºæ˜¯æå…¶é‡è¦çš„è¿›ç¨‹ï¼Œ<br>é™¤éä¸ºäº†ç»´æŒæ‰€æœ‰å‰å°è¿›ç¨‹åŒæ—¶è¿è¡Œè€Œå¿…é¡»ç»ˆæ­¢ï¼Œå¦åˆ™ç³»ç»Ÿä¸ä¼šç»ˆæ­¢è¿™äº›è¿›ç¨‹ã€‚</td></tr><tr><td>æœåŠ¡è¿›ç¨‹ï¼ˆService processï¼‰</td><td>æ­£åœ¨è¿è¡Œå·²ä½¿ç”¨ startService() æ–¹æ³•å¯åŠ¨çš„æœåŠ¡ä¸”ä¸å±äºä¸Šè¿°ä¸¤ä¸ªæ›´é«˜ç±»åˆ«è¿›ç¨‹çš„è¿›ç¨‹ã€‚<br>å°½ç®¡æœåŠ¡è¿›ç¨‹ä¸ç”¨æˆ·æ‰€è§å†…å®¹æ²¡æœ‰ç›´æ¥å…³è”ï¼Œä½†æ˜¯å®ƒä»¬é€šå¸¸åœ¨æ‰§è¡Œä¸€äº›ç”¨æˆ·å…³å¿ƒçš„æ“ä½œ<br>ï¼ˆä¾‹å¦‚ï¼Œåœ¨åå°æ’­æ”¾éŸ³ä¹æˆ–ä»ç½‘ç»œä¸‹è½½æ•°æ®ï¼‰ã€‚<br>å› æ­¤ï¼Œé™¤éå†…å­˜ä¸è¶³ä»¥ç»´æŒæ‰€æœ‰å‰å°è¿›ç¨‹å’Œå¯è§è¿›ç¨‹åŒæ—¶è¿è¡Œï¼Œå¦åˆ™ç³»ç»Ÿä¼šè®©æœåŠ¡è¿›ç¨‹ä¿æŒè¿è¡ŒçŠ¶æ€ã€‚</td></tr><tr><td>åå°è¿›ç¨‹ï¼ˆBackground processï¼‰</td><td>åŒ…å«ç›®å‰å¯¹ç”¨æˆ·ä¸å¯è§çš„ Activity çš„è¿›ç¨‹ï¼ˆå·²è°ƒç”¨ Activity çš„ onStop() æ–¹æ³•ï¼‰ã€‚<br>è¿™äº›è¿›ç¨‹å¯¹ç”¨æˆ·ä½“éªŒæ²¡æœ‰ç›´æ¥å½±å“ï¼Œç³»ç»Ÿå¯èƒ½éšæ—¶ç»ˆæ­¢å®ƒä»¬ã€‚</td></tr><tr><td>ç©ºè¿›ç¨‹ ï¼ˆEmpty processï¼‰</td><td>ä¸å«ä»»ä½•æ´»åŠ¨åº”ç”¨ç»„ä»¶çš„è¿›ç¨‹ã€‚<br>ä¿ç•™è¿™ç§è¿›ç¨‹çš„çš„å”¯ä¸€ç›®çš„æ˜¯ç”¨ä½œç¼“å­˜ï¼Œä»¥ç¼©çŸ­ä¸‹æ¬¡åœ¨å…¶ä¸­è¿è¡Œç»„ä»¶æ‰€éœ€çš„å¯åŠ¨æ—¶é—´ã€‚<br>ä¸ºä½¿æ€»ä½“ç³»ç»Ÿèµ„æºåœ¨è¿›ç¨‹ç¼“å­˜å’Œåº•å±‚å†…æ ¸ç¼“å­˜ä¹‹é—´ä¿æŒå¹³è¡¡ï¼Œç³»ç»Ÿå¾€å¾€ä¼šç»ˆæ­¢è¿™äº›è¿›ç¨‹ã€‚</td></tr></tbody></table><h1 id="å››ã€Framework-OOM-Adjustment"><a href="#å››ã€Framework-OOM-Adjustment" class="headerlink" title="å››ã€Framework OOM Adjustment"></a>å››ã€Framework OOM Adjustment</h1><h2 id="4-1-ADJ-çº§åˆ«"><a href="#4-1-ADJ-çº§åˆ«" class="headerlink" title="4.1 ADJ çº§åˆ«"></a>4.1 ADJ çº§åˆ«</h2><p>ADJ å®šä¹‰åœ¨ <strong><font color="#1874CD">ProcessList.java</font></strong> ä¸­ï¼š<strong><font color="#FF0000">oom_adj</font></strong> åˆ’åˆ†ä¸º16çº§ï¼Œå–å€¼èŒƒå›´[-1000~1001]</p><table><thead><tr><th>ADJ çº§åˆ«</th><th>å–å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>UNKNOWN_ADJ</td><td>1001</td><td>ä¸€èˆ¬æŒ‡å°†è¦ä¼šç¼“å­˜è¿›ç¨‹ï¼Œæ— æ³•è·å–ç¡®å®šå€¼</td></tr><tr><td>CACHED_APP_MAX_ADJ</td><td>906</td><td>ä¸å¯è§è¿›ç¨‹çš„ adj æœ€å¤§å€¼</td></tr><tr><td>CACHED_APP_MIN_ADJ</td><td>900</td><td>ä¸å¯è§è¿›ç¨‹çš„ adj æœ€å°å€¼</td></tr><tr><td>SERVICE_B_AD</td><td>800</td><td>B Listä¸­çš„Serviceï¼ˆè¾ƒè€çš„ã€ä½¿ç”¨å¯èƒ½æ€§æ›´å°ï¼‰</td></tr><tr><td>PREVIOUS_APP_ADJ</td><td>700</td><td>ä¸Šä¸€ä¸ªAppçš„è¿›ç¨‹(å¾€å¾€é€šè¿‡æŒ‰è¿”å›é”®)</td></tr><tr><td>HOME_APP_ADJ</td><td>600</td><td>Homeè¿›ç¨‹</td></tr><tr><td>SERVICE_ADJ</td><td>500</td><td>æœåŠ¡è¿›ç¨‹(Service process)</td></tr><tr><td>HEAVY_WEIGHT_APP_ADJ</td><td>400</td><td>åå°çš„é‡é‡çº§è¿›ç¨‹ï¼Œsystem/rootdir/init.rcæ–‡ä»¶ä¸­è®¾ç½®</td></tr><tr><td>BACKUP_APP_ADJ</td><td>300</td><td>å¤‡ä»½è¿›ç¨‹</td></tr><tr><td>PERCEPTIBLE_APP_ADJ</td><td>200</td><td>å¯æ„ŸçŸ¥è¿›ç¨‹ï¼Œæ¯”å¦‚åå°éŸ³ä¹æ’­æ”¾</td></tr><tr><td>VISIBLE_APP_ADJ</td><td>100</td><td>å¯è§è¿›ç¨‹(Visible process) </td></tr><tr><td>FOREGROUND_APP_ADJ</td><td>0</td><td>å‰å°è¿›ç¨‹ï¼ˆForeground processï¼‰</td></tr><tr><td>PERSISTENT_SERVICE_ADJ</td><td>-700</td><td>å…³è”ç€ç³»ç»Ÿæˆ– persistent è¿›ç¨‹</td></tr><tr><td>PERSISTENT_PROC_ADJ</td><td>-800</td><td>ç³»ç»Ÿ persistent è¿›ç¨‹ï¼Œæ¯”å¦‚ telephony</td></tr><tr><td>SYSTEM_ADJ</td><td>-900</td><td>ç³»ç»Ÿè¿›ç¨‹ï¼Œä»…æŒ‡system_serverè¿›ç¨‹</td></tr><tr><td>NATIVE_ADJ</td><td>-1000</td><td>nativeè¿›ç¨‹ï¼ˆä¸è¢«ç³»ç»Ÿç®¡ç†ï¼‰</td></tr></tbody></table><p>ä» Android 7.0 å¼€å§‹ï¼ŒADJ é‡‡ç”¨ 100ã€200ã€300 ç­‰æ•°å€¼ï¼›åœ¨è¿™ä¹‹å‰çš„ç‰ˆæœ¬ AD Jé‡‡ç”¨æ•°å­— 1ã€2ã€3 ç­‰æ•°å€¼ï¼Œè¿™æ ·çš„è°ƒæ•´æ˜¯ä¸ºäº†å¯ä»¥æ›´è¿›ä¸€æ­¥åœ°ç»†åŒ–è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œæ¯”å¦‚åœ¨ VISIBLE_APP_ADJ(100) ä¸ PERCEPTIBLE_APP_ADJ(200) ä¹‹é—´ï¼Œå¯ä»¥è®¾å®š ADJ = 101ã€ADJ = 102 çº§åˆ«çš„è¿›ç¨‹ã€‚</p><h2 id="4-2-STATE-çº§åˆ«"><a href="#4-2-STATE-çº§åˆ«" class="headerlink" title="4.2 STATE çº§åˆ«"></a>4.2 STATE çº§åˆ«</h2><p>STATE å®šä¹‰åœ¨ <strong><font color="#1874CD">ActivityManager.java</font></strong> ä¸­ï¼š<strong><font color="#FF0000">process_state</font></strong> åˆ’åˆ†20ç±»ï¼Œå–å€¼èŒƒå›´[-1~18]</p><table><thead><tr><th>STATE çº§åˆ«</th><th>å–å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>PROCESS_STATE_NONEXISTENT</td><td>18</td><td>ä¸å­˜åœ¨çš„è¿›ç¨‹</td></tr><tr><td>PROCESS_STATE_CACHED_EMPTY</td><td>17</td><td>è¿›ç¨‹å¤„äºcachedçŠ¶æ€ï¼Œä¸”ä¸ºç©ºè¿›ç¨‹</td></tr><tr><td>PROCESS_STATE_CACHED_ACTIVITY_CLIENT</td><td>16</td><td>è¿›ç¨‹å¤„äºcachedçŠ¶æ€ï¼Œä¸”ä¸ºå¦ä¸€ä¸ªcachedè¿›ç¨‹(å†…å«Activity)çš„clientè¿›ç¨‹ adj æœ€å¤§å€¼</td></tr><tr><td>PROCESS_STATE_CACHED_ACTIVITY</td><td>15</td><td>è¿›ç¨‹å¤„äºcachedçŠ¶æ€ï¼Œä¸”å†…å«Activity</td></tr><tr><td>PROCESS_STATE_LAST_ACTIVITY</td><td>14</td><td>åå°è¿›ç¨‹ï¼Œä¸”æ‹¥æœ‰ä¸Šä¸€æ¬¡æ˜¾ç¤ºçš„Activity</td></tr><tr><td>PROCESS_STATE_HOME</td><td>14</td><td>åå°è¿›ç¨‹ï¼Œä¸”æ‹¥æœ‰home Activity</td></tr><tr><td>PROCESS_STATE_RECEIVER</td><td>12</td><td>åå°è¿›ç¨‹ï¼Œä¸”æ­£åœ¨è¿è¡Œreceiver</td></tr><tr><td>PROCESS_STATE_SERVICE</td><td>11</td><td>åå°è¿›ç¨‹ï¼Œä¸”æ­£åœ¨è¿è¡Œservice</td></tr><tr><td>PROCESS_STATE_HEAVY_WEIGHT</td><td>10</td><td>åå°è¿›ç¨‹ï¼Œä½†æ— æ³•æ‰§è¡Œrestoreï¼Œå› æ­¤å°½é‡é¿å…killè¯¥è¿›ç¨‹</td></tr><tr><td>PROCESS_STATE_BACKUP</td><td>9</td><td>åå°è¿›ç¨‹ï¼Œæ­£åœ¨è¿è¡Œbackup/restoreæ“ä½œ</td></tr><tr><td>PROCESS_STATE_TRANSIENT_BACKGROUND</td><td>8</td><td>è¿›ç¨‹çŸ­æš‚è¿›å…¥åå°ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä¿æŒè¿è¡Œ</td></tr><tr><td>PROCESS_STATE_IMPORTANT_BACKGROUND</td><td>7</td><td>å¯¹ç”¨æˆ·å¾ˆé‡è¦çš„è¿›ç¨‹ï¼Œç”¨æˆ·ä¸å¯æ„ŸçŸ¥å…¶å­˜åœ¨</td></tr><tr><td>PROCESS_STATE_IMPORTANT_FOREGROUND</td><td>6</td><td>å¯¹ç”¨æˆ·å¾ˆé‡è¦çš„è¿›ç¨‹ï¼Œç”¨æˆ·å¯æ„ŸçŸ¥å…¶å­˜åœ¨</td></tr><tr><td>PROCESS_STATE_TOP_SLEEPING</td><td>5</td><td>ä¸PROCESS_STATE_TOPä¸€æ ·ï¼Œä½†æ­¤æ—¶è®¾å¤‡æ­£å¤„äºä¼‘çœ çŠ¶æ€</td></tr><tr><td>PROCESS_STATE_FOREGROUND_SERVICE</td><td>4</td><td>æ‹¥æœ‰ç»™ä¸€ä¸ªå‰å°Service</td></tr><tr><td>PROCESS_STATE_BOUND_FOREGROUND_SERVICE</td><td>3</td><td>æ‹¥æœ‰ç»™ä¸€ä¸ªå‰å°Serviceï¼Œä¸”ç”±ç³»ç»Ÿç»‘å®š</td></tr><tr><td>PROCESS_STATE_TOP</td><td>2</td><td>æ‹¥æœ‰å½“å‰ç”¨æˆ·å¯è§çš„top Activity</td></tr><tr><td>PROCESS_STATE_PERSISTENT_UI</td><td>1</td><td>persistentç³»ç»Ÿè¿›ç¨‹ï¼Œå¹¶æ­£åœ¨æ‰§è¡ŒUIæ“ä½œ</td></tr><tr><td>PROCESS_STATE_PERSISTENT</td><td>0</td><td>persistentç³»ç»Ÿè¿›ç¨‹</td></tr><tr><td>PROCESS_STATE_UNKNOWN</td><td>-1</td><td>ä¸å¯çŸ¥çš„è¿›ç¨‹</td></tr></tbody></table><h1 id="äº”ã€Read-The-Fucking-Code"><a href="#äº”ã€Read-The-Fucking-Code" class="headerlink" title="äº”ã€Read The Fucking Code"></a>äº”ã€Read The Fucking Code</h1><h2 id="5-1-lmkd"><a href="#5-1-lmkd" class="headerlink" title="5.1 lmkd"></a>5.1 lmkd</h2><p>é€šè¿‡å‰é¢çš„è¡¨æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼šProcessList ä¸­å®šä¹‰æœ‰è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œ<strong><font color="#FF0000">è¶Šé‡è¦çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§è¶Šä½</font></strong> ï¼Œå‰å° APP çš„ä¼˜å…ˆçº§ä¸º 0ï¼Œç³»ç»Ÿ APP çš„ä¼˜å…ˆçº§ä¸€èˆ¬éƒ½æ˜¯è´Ÿå€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹ç®¡ç†ä»¥åŠæ€è¿›ç¨‹éƒ½æ˜¯é’ˆå¯¹ä¸Šå±‚ APP æ¥è¯´çš„ã€‚</p><p><strong><font color="#FF0000">è¿›ç¨‹çš„ä¼˜å…ˆçº§è°ƒæ•´éƒ½åœ¨ ActivityManagerService é‡Œé¢</font></strong> ï¼ŒActivityManagerService æ ¹æ®è¿›ç¨‹ä¸­ç»„ä»¶çš„çŠ¶æ€å»ä¸æ–­çš„è®¡ç®—æ¯ä¸ªè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè®¡ç®—ä¹‹åä¼šåŠæ—¶æ›´æ–°åˆ°å¯¹åº”è¿›ç¨‹çš„æ–‡ä»¶èŠ‚ç‚¹ä¸­ï¼Œ<strong><font color="#FF0000">è€Œè¿™ä¸ªå¯¹æ–‡ä»¶èŠ‚ç‚¹çš„æ›´æ–°å¹¶ä¸æ˜¯ AMS å®Œæˆçš„ï¼Œè€Œæ˜¯ lmkd ï¼Œå®ƒä»¬ä¹‹é—´é€šè¿‡ socket é€šä¿¡</font></strong>ã€‚ </p><p>lmkd åœ¨æ‰‹æœºä¸­æ˜¯ä¸€ä¸ªå¸¸é©»è¿›ç¨‹ï¼Œç”¨æ¥å¤„ç†ä¸Šå±‚ ActivityManager åœ¨è¿›è¡Œ updateOomAdj ä¹‹åï¼Œé€šè¿‡ socket ä¸ lmkd è¿›è¡Œé€šä¿¡ï¼Œæ›´æ–°è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœå¿…è¦åˆ™æ€æ‰è¿›ç¨‹é‡Šæ”¾å†…å­˜ã€‚</p><p>lmkd æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™å¯åŠ¨çš„ï¼Œé€šè¿‡è§£æ init.rc æ–‡ä»¶æ¥å¯åŠ¨ lmkd å®ˆæŠ¤è¿›ç¨‹ã€‚åœ¨ lmkd ä¸­æœ‰å®šä¹‰ lmkd.rc:</p><pre class=" language-rc"><code class="language-rc">service lmkd /system/bin/lmkd    class core    group root readproc    critical    socket lmkd seqpacket 0660 system system    writepid /dev/cpuset/system-background/tasks</code></pre><p>lmkd ä¼šåˆ›å»ºåä¸º lmkd çš„ socketï¼ŒèŠ‚ç‚¹ä½äº/dev/socket/lmkdï¼Œè¯¥ socket ç”¨äºè·Ÿä¸Šå±‚ framework äº¤äº’ã€‚</p><p>ä¸Šå±‚ AMS è·Ÿ lmkd é€šä¿¡ä¸»è¦åˆ†ä¸ºä¸‰ç§ commandï¼Œæ¯ç§ command ä»£è¡¨ä¸€ç§æ•°æ®æ§åˆ¶æ–¹å¼ï¼Œåœ¨ ProcessList ä»¥åŠ lmkd ä¸­éƒ½æœ‰å®šä¹‰ï¼ŒProcessList æ–‡ä»¶ä¸­çš„å®šä¹‰å¿…é¡»è·Ÿ lmkd.c å®šä¹‰å®Œå…¨ä¸€è‡´ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// LMK_TARGET &lt;minfree> &lt;minkillprio> ... (up to 6 pairs)</span><span class="token comment" spellcheck="true">// LMK_PROCPRIO &lt;pid> &lt;uid> &lt;prio></span><span class="token comment" spellcheck="true">// LMK_PROCREMOVE &lt;pid></span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_TARGET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_PROCPRIO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_PROCREMOVE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* * Supported LMKD commands */</span><span class="token keyword">enum</span> lmk_cmd <span class="token punctuation">{</span>    LMK_TARGET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">/* Associate minfree with oom_adj_score */</span>    LMK_PROCPRIO<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* Register a process and set its oom_adj_score */</span>    LMK_PROCREMOVE<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">/* Unregister a process */</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>ä¸Šè¿°3ä¸ªå‘½ä»¤çš„ä½¿ç”¨éƒ½é€šè¿‡ ProcessList.java ä¸­çš„å¦‚ä¸‹æ–¹æ³•:</p><table><thead><tr><th>åŠŸèƒ½</th><th>å‘½ä»¤</th><th>å¯¹åº”æ–¹æ³•</th></tr></thead><tbody><tr><td>LMK_TARGET</td><td>æ›´æ–° oom_adj</td><td>PorcessList.updateOomLevels()</td></tr><tr><td>LMK_PROCPRIO</td><td>è®¾ç½®è¿›ç¨‹ adj</td><td>PorcessList.setOomAdj()</td></tr><tr><td>LMK_PROCREMOVE</td><td>ç§»é™¤è¿›ç¨‹</td><td>PorcessList.remove()</td></tr></tbody></table><p>åœ¨å¼€å§‹åˆ†æ lmkd çš„å¤„ç†é€»è¾‘ä¹‹å‰ï¼Œlmkd.c ä¸­æœ‰å‡ ä¸ªé‡è¦çš„å˜é‡ä¸æ•°æ®ç»“æ„æå‰è¯´æ˜ä¸€ä¸‹ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">// å†…å­˜çº§åˆ«é™é¢</span><span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"</span><span class="token comment" spellcheck="true">// ä¸åŒçº§åˆ«å†…å­˜å¯¹åº”è¦æ€çš„çš„ä¼˜å…ˆçº§</span><span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_ADJ_PATH "/sys/module/lowmemorykiller/parameters/adj"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">/* OOM score values used by both kernel and framework */</span><span class="token comment" spellcheck="true">// ä¼˜å…ˆçº§çš„æœ€å°å€¼</span><span class="token macro property">#<span class="token directive keyword">define</span> OOM_SCORE_ADJ_MIN       (-1000)</span><span class="token comment" spellcheck="true">// ä¼˜å…ˆçº§çš„æœ€å¤§å€¼</span><span class="token macro property">#<span class="token directive keyword">define</span> OOM_SCORE_ADJ_MAX       1000</span><span class="token comment" spellcheck="true">/* A threshold of minfree adjustment toward VMPRESS_LEVEL_CRITICAL (36MB) */</span><span class="token macro property">#<span class="token directive keyword">define</span> CACHED_THRESHOLD    (9216)</span><span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_adj<span class="token punctuation">[</span>MAX_TARGETS<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_minfree<span class="token punctuation">[</span>MAX_TARGETS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> CACHED_THRESHOLD <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_targets_size<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">// åŒå‘é“¾è¡¨ç»“æ„ä½“</span><span class="token keyword">struct</span> adjslot_list <span class="token punctuation">{</span>    <span class="token keyword">struct</span> adjslot_list <span class="token operator">*</span>next<span class="token punctuation">;</span>    <span class="token keyword">struct</span> adjslot_list <span class="token operator">*</span>prev<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è¿›ç¨‹åœ¨ lmkd ä¸­çš„æ•°æ®ç»“æ„ä½“</span><span class="token keyword">struct</span> proc <span class="token punctuation">{</span>    <span class="token keyword">struct</span> adjslot_list asl<span class="token punctuation">;</span>    <span class="token keyword">int</span> pid<span class="token punctuation">;</span>    uid_t uid<span class="token punctuation">;</span>    <span class="token keyword">int</span> oomadj<span class="token punctuation">;</span>    <span class="token keyword">struct</span> proc <span class="token operator">*</span>pidhash_next<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å­˜æ”¾è¿›ç¨‹ proc çš„ hashtable ï¼Œindex æ˜¯é€šè¿‡ pid çš„è®¡ç®—å¾—å‡º</span><span class="token macro property">#<span class="token directive keyword">define</span> PIDHASH_SZ 1024</span><span class="token keyword">static</span> <span class="token keyword">struct</span> proc <span class="token operator">*</span>pidhash<span class="token punctuation">[</span>PIDHASH_SZ<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æ ¹æ® pid è®¡ç®— index çš„ hash ç®—æ³•</span><span class="token macro property">#<span class="token directive keyword">define</span> pid_hashfn(x) ((((x) >> 8) ^ (x)) &amp; (PIDHASH_SZ - 1))</span><span class="token comment" spellcheck="true">// è¿›ç¨‹ä¼˜å…ˆçº§åˆ°æ•°ç»„çš„ index ä¹‹é—´çš„è½¬æ¢</span><span class="token comment" spellcheck="true">// å› ä¸ºè¿›ç¨‹çš„ä¼˜å…ˆçº§å¯ä»¥æ˜¯è´Ÿå€¼ï¼Œä½†æ˜¯æ•°ç»„çš„ index ä¸èƒ½ä¸ºè´Ÿå€¼</span><span class="token comment" spellcheck="true">// ä¸è¿‡å› ä¸ºè¿™ä¸ªè½¬æ¢åªæ˜¯ç®€å•åŠ äº† 1000ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œåé¢çš„æè¿°ä¸­å°±è®¤ä¸ºæ˜¯ä¼˜å…ˆçº§ç›´æ¥åšäº† index</span><span class="token macro property">#<span class="token directive keyword">define</span> ADJTOSLOT(adj) ((adj) + -OOM_SCORE_ADJ_MIN)</span><span class="token comment" spellcheck="true">// tableï¼Œç±»ä¼¼ hashtable ï¼Œä¸è¿‡è®¡ç®— index çš„æ–¹å¼ä¸æ˜¯ hash ï¼Œè€Œæ˜¯ oom_score_adj ç»è¿‡è½¬æ¢åç›´æ¥ä½œä¸º index</span><span class="token comment" spellcheck="true">// æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯åŒå‘å¾ªç¯é“¾è¡¨</span><span class="token comment" spellcheck="true">// è¿›ç¨‹çš„ä¼˜å…ˆçº§ä½œä¸ºæ•°ç»„çš„ index</span><span class="token comment" spellcheck="true">// å³ä»¥è¿›ç¨‹çš„ä¼˜å…ˆçº§ä¸º indexï¼Œä» -1000 åˆ° +1000 + 1 å¤§å°çš„æ•°ç»„ï¼Œæ ¹æ®ä¼˜å…ˆçº§ï¼ŒåŒä¼˜å…ˆçº§çš„è¿›ç¨‹ index ç›¸åŒ</span><span class="token comment" spellcheck="true">// æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ä¸Šçš„æ‰€æœ‰ proc çš„ä¼˜å…ˆçº§éƒ½ç›¸åŒ</span><span class="token comment" spellcheck="true">// è¿™æ ·æ ¹æ®ä¼˜å…ˆçº§æ€è¿›ç¨‹çš„æ—¶å€™å°±ä¼šéå¸¸æ–¹ä¾¿ï¼Œè¦æ€æŒ‡å®šä¼˜å…ˆçº§çš„è¿›ç¨‹å¯ä»¥æ ¹æ®ä¼˜å…ˆçº§è·å–åˆ°ä¸€ä¸ªè¿›ç¨‹é“¾è¡¨ï¼Œé€ä¸ªå»æ€</span><span class="token keyword">static</span> <span class="token keyword">struct</span> adjslot_list procadjslot_list<span class="token punctuation">[</span><span class="token function">ADJTOSLOT</span><span class="token punctuation">(</span>OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p><strong><font color="#FF0000">æ¥ä¸‹æ¥æˆ‘ä»¬æ­£å¼è®¨è®ºlmkdï¼</font></strong></p><h3 id="5-1-1-main"><a href="#5-1-1-main" class="headerlink" title="5.1.1 main()"></a>5.1.1 main()</h3><p>lmkd å¯åŠ¨åï¼Œæ¥ä¸‹é‡Œçš„æ“ä½œéƒ½åœ¨ /system/core/lmkd/lmkd.c æ–‡ä»¶ï¼Œé¦–å…ˆè¿›å…¥ main() æ–¹æ³•ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc __unused<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mlockall</span><span class="token punctuation">(</span>MCL_CURRENT <span class="token operator">|</span> MCL_FUTURE<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"mlockall failed: errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è®¾ç½®æ­¤çº¿ç¨‹çš„è°ƒåº¦ç­–ç•¥ä¸º SCHED_FIFOï¼Œfirst-in-first-outï¼Œparam ä¸­ä¸»è¦è®¾ç½® sched_priority</span>    <span class="token comment" spellcheck="true">// ç”±äº SCHED_FIFO æ˜¯ä¸€ç§å®æ—¶è°ƒåº¦ç­–ç•¥ï¼Œåœ¨è¿™ä¸ªç­–ç•¥ä¸‹ä¼˜å…ˆçº§ä»1(low) -> 99(high)</span>    <span class="token comment" spellcheck="true">// å®æ—¶çº¿ç¨‹é€šå¸¸ä¼šæ¯”æ™®é€šçº¿ç¨‹æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§</span>    <span class="token function">sched_setscheduler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆå§‹åŒ– epoll åŠä¸ ActivityManager çš„ socket è¿æ¥ï¼Œç­‰å¾… cmd å’Œ data</span>    <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// è¿›å…¥æ­»å¾ªç¯ epoll_wait ç­‰å¾…fdäº‹ä»¶</span>        <span class="token function">mainloop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å‰é¢å·²ç»æåˆ°ï¼Œè¿™ä¸ªè¿›ç¨‹å­˜åœ¨çš„ä¸»è¦ä½œç”¨æ˜¯è·Ÿ AMS è¿›è¡Œé€šä¿¡ï¼Œæ›´æ–° oomAdj ï¼Œåœ¨å¿…è¦çš„æ—¶å€™æ€æ‰è¿›ç¨‹ã€‚æ‰€ä»¥åœ¨ main å‡½æ•°ä¸­ä¸»è¦å°±æ˜¯åˆ›å»ºäº† epoll ä»¥åŠåˆå§‹åŒ– socket å¹¶è¿æ¥ ActivityManager ï¼Œç„¶åé˜»å¡ç­‰å¾…ä¸Šå±‚ä¼ é€’ cmd ä»¥åŠ data è¿‡æ¥ã€‚</p><h4 id="5-1-1-1-init"><a href="#5-1-1-1-init" class="headerlink" title="5.1.1.1 init()"></a>5.1.1.1 init()</h4><p>æ¥çœ‹çœ‹ init çš„é€»è¾‘ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> epoll_event epev<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>    page_k <span class="token operator">=</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>page_k <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        page_k <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>    page_k <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ›å»º epoll ç›‘å¬æ–‡ä»¶å¥æŸ„</span>    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span>MAX_EPOLL_EVENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>epollfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_create failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è·å– lmkd çš„ socket fd</span>    ctrl_lfd <span class="token operator">=</span> <span class="token function">android_get_control_socket</span><span class="token punctuation">(</span><span class="token string">"lmkd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl_lfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"get lmkd control socket failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ç›‘å¬ lmkd socket</span>    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>ctrl_lfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"lmkd control socket listen failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    epev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ctrl_connect_handler é‡Œé¢å®Œæˆäº† soclet çš„ accpet ä»¥åŠ read æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œç›¸åº”çš„å¤„ç†</span>    <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ä¸‹é¢ä¼šé‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>    ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_connect_handler<span class="token punctuation">;</span>    epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> ctrl_sock<span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl for lmkd control socket failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    maxevents<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è¯¥è·¯å¾„æ˜¯å¦å…·æœ‰å¯å†™çš„æƒé™</span>    <span class="token comment" spellcheck="true">/*     * è¿™é‡Œï¼Œé€šè¿‡æ£€éªŒ /sys/module/lowmemorykiller/parameters/minfree èŠ‚ç‚¹æ˜¯å¦å…·æœ‰å¯å†™æƒé™     *     *     #define INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"     *      * æ¥åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ kernel æ¥å£æ¥ç®¡ç† lmk äº‹ä»¶ã€‚     * é»˜è®¤è¯¥èŠ‚ç‚¹æ˜¯å…·æœ‰ç³»ç»Ÿå¯å†™çš„æƒé™ï¼Œä¹Ÿå°±æ„å‘³ç€ use_inkernel_interface = 1     */</span>    has_inkernel_module <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>INKERNEL_MINFREE_PATH<span class="token punctuation">,</span> W_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    use_inkernel_interface <span class="token operator">=</span> has_inkernel_module<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è¿™ä¸ª use_inkernel_interface æ˜¯æ ¹æ®æ˜¯å¦æœ‰ â€œ/sys/module/lowmemorykiller/parameters/minfreeâ€ çš„å†™æƒé™æ¥åˆ¤æ–­çš„ï¼Œæ²¡æœ‰çš„æƒ…å†µä¸‹å°±ä½¿ç”¨ kernel ç©ºé—´çš„é€»è¾‘</span>    <span class="token comment" spellcheck="true">// ç›®å‰é‡åˆ°çš„éƒ½æ˜¯ use_inkernel_interface</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Using in-kernel low memory killer interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_LOW<span class="token punctuation">)</span> <span class="token operator">||</span>            <span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_MEDIUM<span class="token punctuation">)</span> <span class="token operator">||</span>            <span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_CRITICAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Kernel does not support memory pressure events or in-kernel low memory killer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// åŒå‘é“¾è¡¨åˆå§‹åŒ–</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token function">ADJTOSLOT</span><span class="token punctuation">(</span>OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="5-1-1-2-mainloop"><a href="#5-1-1-2-mainloop" class="headerlink" title="5.1.1.2 mainloop()"></a>5.1.1.2 mainloop()</h4><p>æ¥çœ‹çœ‹ mainloop çš„é€»è¾‘ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// è¿›å…¥æ­»å¾ªç¯ï¼Œç„¶åè°ƒç”¨ epoll_wait é˜»å¡ç­‰å¾…äº‹ä»¶çš„åˆ°æ¥</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mainloop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">struct</span> epoll_event events<span class="token punctuation">[</span>maxevents<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> nevents<span class="token punctuation">;</span>        <span class="token keyword">int</span> i<span class="token punctuation">;</span>        <span class="token keyword">struct</span> timespec t1<span class="token punctuation">,</span> t2<span class="token punctuation">;</span>        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> elapsed_ms<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ç­‰å¾… epoll_wait ä¸Šçš„äº‹ä»¶</span>        nevents <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> maxevents<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nevents <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_wait failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nevents<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLERR<span class="token punctuation">)</span>                <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"EPOLLERR on event #%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å½“äº‹ä»¶åˆ°æ¥ï¼Œåˆ™è°ƒç”¨ ctrl_connect_handler æ–¹æ³•</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">)</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸»å¾ªç¯è°ƒç”¨ epoll_wait()ï¼Œç­‰å¾… epollfd ä¸Šçš„äº‹ä»¶ï¼Œå½“æ¥æ”¶åˆ°ä¸­æ–­æˆ–è€…ä¸å­˜åœ¨äº‹ä»¶ï¼Œåˆ™æ‰§è¡Œ continue æ“ä½œã€‚å½“äº‹ä»¶åˆ°æ¥ï¼Œåˆ™è°ƒç”¨çš„ ctrl_connect_handler æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ç”± init() è¿‡ç¨‹ä¸­è®¾å®šçš„æ–¹æ³•ï¼ˆæˆ‘ä»¬ä¹‹å‰åœ¨åˆ†æ init() çš„æ—¶å€™æè¿‡ï¼‰ã€‚</p><h3 id="5-1-2-ctrl-connect-handler"><a href="#5-1-2-ctrl-connect-handler" class="headerlink" title="5.1.2 ctrl_connect_handler()"></a>5.1.2 ctrl_connect_handler()</h3><p>æˆ‘ä»¬ä¹‹å‰åœ¨ init() ä¸­çœ‹åˆ°ä»¥ä¸‹ä»£ç ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// ctrl_connect_handler é‡Œé¢å®Œæˆäº† soclet çš„ accpet ä»¥åŠ read æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œç›¸åº”çš„å¤„ç†</span>ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_connect_handler<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨ ctrl_connect_handler()</span>epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>å®ƒæ˜¯ä¸“é—¨å¤„ç† Socket ä¼ é€’è¿‡æ¥çš„æ•°æ®çš„ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_connect_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> data __unused<span class="token punctuation">,</span> uint32_t events __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> epoll_event epev<span class="token punctuation">;</span>    <span class="token keyword">int</span> free_dscock_idx <span class="token operator">=</span> <span class="token function">get_free_dsock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>free_dscock_idx <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_DATA_CONN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">ctrl_data_close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        free_dscock_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"lmkd control socket accept failed; errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"lmkd data connection established"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* use data to store data connection idx */</span>    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>data <span class="token operator">=</span> free_dscock_idx<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è°ƒç”¨ ctrl_data_handler()</span>    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_data_handler<span class="token punctuation">;</span>    epev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>    epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl for data connection socket failed; errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">ctrl_data_close</span><span class="token punctuation">(</span>free_dscock_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    maxevents<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="5-1-3-ctrl-data-handler"><a href="#5-1-3-ctrl-data-handler" class="headerlink" title="5.1.3 ctrl_data_handler"></a>5.1.3 ctrl_data_handler</h3><p>å½“äº‹ä»¶è§¦å‘ï¼Œåˆ™è°ƒç”¨ ctrl_data_handler()ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_data_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">,</span> uint32_t events<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ctrl_command_handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="5-1-4-ctrl-command-handler"><a href="#5-1-4-ctrl-command-handler" class="headerlink" title="5.1.4 ctrl_command_handler"></a>5.1.4 ctrl_command_handler</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_command_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> dsock_idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    LMKD_CTRL_PACKET packet<span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>    <span class="token keyword">enum</span> lmk_cmd cmd<span class="token punctuation">;</span>    <span class="token keyword">int</span> nargs<span class="token punctuation">;</span>    <span class="token keyword">int</span> targets<span class="token punctuation">;</span>    len <span class="token operator">=</span> <span class="token function">ctrl_data_read</span><span class="token punctuation">(</span>dsock_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>packet<span class="token punctuation">,</span> CTRL_PACKET_MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Wrong control socket read length len=%d"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    cmd <span class="token operator">=</span> <span class="token function">lmkd_pack_get_cmd</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>    nargs <span class="token operator">=</span> len <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å°†ç½‘ç»œå­—èŠ‚é¡ºåºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚é¡ºåº</span>    cmd <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>ibuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä¸€å…±ä¸‰ç§command</span>    <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ›´æ–°å†…å­˜çº§åˆ«ä»¥åŠå¯¹åº”çº§åˆ«çš„è¿›ç¨‹ adj</span>    <span class="token keyword">case</span> LMK_TARGET<span class="token operator">:</span>        targets <span class="token operator">=</span> nargs <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">&amp;</span> <span class="token number">0x1</span> <span class="token operator">||</span> targets <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>        <span class="token function">cmd_target</span><span class="token punctuation">(</span>targets<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ ¹æ® pid æ›´æ–° adj</span>    <span class="token keyword">case</span> LMK_PROCPRIO<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span>            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ä¸‹é¢ä¼šé‡ç‚¹è®¨è®º ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥</span>        <span class="token function">cmd_procprio</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ ¹æ® pid ç§»é™¤ proc</span>    <span class="token keyword">case</span> LMK_PROCREMOVE<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>        <span class="token function">cmd_procremove</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Received unknown command code %d"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>wronglen<span class="token operator">:</span>    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Wrong control socket read length cmd=%d len=%d"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>è·å– framework ä¼ é€’è¿‡æ¥çš„ buf æ•°æ®åï¼Œæ ¹æ® 3 ç§ä¸åŒçš„å‘½ä»¤ï¼Œè¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹ï¼š</p><h2 id="5-2-ä¸‰ç§æ•°æ®"><a href="#5-2-ä¸‰ç§æ•°æ®" class="headerlink" title="5.2 ä¸‰ç§æ•°æ®"></a>5.2 ä¸‰ç§æ•°æ®</h2><h3 id="5-2-1-LMK-TARGET"><a href="#5-2-1-LMK-TARGET" class="headerlink" title="5.2.1 LMK_TARGET"></a>5.2.1 LMK_TARGET</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä¸Šå±‚é€»è¾‘æ˜¯åœ¨ ProcessList.updateOomLevels ä¸­</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateOomLevels</span><span class="token punctuation">(</span><span class="token keyword">int</span> displayWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> displayHeight<span class="token punctuation">,</span> <span class="token keyword">boolean</span> write<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mOomAdj<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_TARGET<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mOomAdj<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mOomMinFree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token operator">/</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>            buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>mOomAdj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"sys.sysctl.extra_free_kbytes"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>reserve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd å¤„ç†é€»è¾‘</span><span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"</span><span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_ADJ_PATH "/sys/module/lowmemorykiller/parameters/adj"</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_target</span><span class="token punctuation">(</span><span class="token keyword">int</span> ntargets<span class="token punctuation">,</span> LMKD_CTRL_PACKET packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">struct</span> lmk_target target<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ntargets <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è¿™ä¸ª for å¾ªç¯å¯¹åº”ä¸Šé¢çš„ for å¾ªç¯ï¼Œå°†æ•°æ®è¯»å‡ºè£…è¿›æ•°ç»„ä¸­</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ntargets<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">lmkd_pack_get_target</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>        lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>minfree<span class="token punctuation">;</span>        lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>oom_adj_score<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    lowmem_targets_size <span class="token operator">=</span> ntargets<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä½¿ç”¨ kernel ç©ºé—´çš„å¤„ç†é€»è¾‘</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>has_inkernel_module<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">char</span> minfreestr<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> killpriostr<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        minfreestr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>        killpriostr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å–å‡ºä¸¤ä¸ªæ•°ç»„ä¸­çš„æ•°æ®ï¼Œä»¥","åˆ†éš”ï¼Œåˆ†åˆ«æ‹¼æ¥æˆ string</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lowmem_targets_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">strlcat</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">strlcat</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> use_inkernel_interface <span class="token operator">?</span> lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strlcat</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> use_inkernel_interface <span class="token operator">?</span> lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strlcat</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å°†ç”Ÿæˆå¥½çš„ string å†™å…¥åˆ°æ–‡ä»¶èŠ‚ç‚¹ minfree ä»¥åŠ adj</span>        <span class="token function">writefilestring</span><span class="token punctuation">(</span>INKERNEL_MINFREE_PATH<span class="token punctuation">,</span> minfreestr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">writefilestring</span><span class="token punctuation">(</span>INKERNEL_ADJ_PATH<span class="token punctuation">,</span> killpriostr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢çš„å¤„ç†é€»è¾‘ä¸»è¦æ˜¯ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1. æŒ‰ç…§é¡ºåºå–å‡ºæ•°æ®ï¼Œè£…è¿› lmkd çš„æ•°ç»„ä¸­ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2. åˆ†åˆ«å°†ä¸¤ä¸ªæ•°ç»„ä¸­çš„æ•°å–å‡ºï¼Œç”¨â€,â€åˆ†éš”ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3. lowmem_minfree ä¸­çš„æ•°æ®æ‹¼æˆçš„ string å†™åˆ° â€œ/sys/module/lowmemorykiller/parameters/minfreeâ€ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;4. lowmem_adj ä¸­çš„æ•°æ®æ‹¼æˆçš„ string å†™åˆ° â€œ/sys/module/lowmemorykiller/parameters/adjâ€ã€‚</p><h3 id="5-2-2-LMK-PROCPRIO"><a href="#5-2-2-LMK-PROCPRIO" class="headerlink" title="5.2.2 LMK_PROCPRIO"></a>5.2.2 LMK_PROCPRIO</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä¸Šå±‚é€»è¾‘æ˜¯åœ¨ ProcessList.setOomAdj ä¸­</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setOomAdj</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> amt<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// This indicates that the process is not started yet and so no need to proceed further.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>amt <span class="token operator">==</span> UNKNOWN_ADJ<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> start <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_PROCPRIO<span class="token punctuation">)</span><span class="token punctuation">;</span>    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>amt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å°† 16Byte å­—èŠ‚å†™å…¥ socketï¼Œbuf å¤§å°ä¸º 16 ä¸ªå­—èŠ‚</span>    <span class="token comment" spellcheck="true">// ä¾æ¬¡å†™å…¥ LMK_PROCPRIO(å‘½ä»¤ç±»å‹), pid(è¿›ç¨‹pid), uid(è¿›ç¨‹uid), amt(ç›®æ ‡adj)ï¼Œå°†è¿™äº›å­—èŠ‚é€šè¿‡ socket å‘é€ç»™ lmkd.</span>    <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>now<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">250</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"ActivityManager"</span><span class="token punctuation">,</span> <span class="token string">"SLOW OOM ADJ: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms for pid "</span> <span class="token operator">+</span> pid <span class="token operator">+</span> <span class="token string">" = "</span> <span class="token operator">+</span> amt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd å¤„ç†é€»è¾‘</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_procprio</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> oomadj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>    <span class="token keyword">char</span> path<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> soft_limit_mult<span class="token punctuation">;</span>    <span class="token keyword">struct</span> lmk_procprio params<span class="token punctuation">;</span>    <span class="token function">lmkd_pack_get_procprio</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oomadj <span class="token operator">&lt;</span> OOM_SCORE_ADJ_MIN <span class="token operator">||</span> oomadj <span class="token operator">></span> OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Invalid PROCPRIO oomadj argument %d"</span><span class="token punctuation">,</span> oomadj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// LMK_PROCPRIO çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ›´æ–°è¿›ç¨‹çš„ oomAdj</span>    <span class="token comment" spellcheck="true">// å°†ä¸Šå±‚ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼ˆpidä»¥åŠä¼˜å…ˆçº§ï¼‰å†™åˆ°è¯¥è¿›ç¨‹å¯¹åº”çš„æ–‡ä»¶èŠ‚ç‚¹ï¼š/proc/pid/oom_score_adj</span>    <span class="token function">snprintf</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/proc/%d/oom_score_adj"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> oomadj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å‘èŠ‚ç‚¹ /proc/&lt;pid>/oom_score_adj å†™å…¥ oomAdj</span>    <span class="token function">writefilestring</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœä½¿ç”¨ kernel çš„é€»è¾‘ï¼Œåˆ™ return</span>    <span class="token comment" spellcheck="true">// å³è¿™ä¸ª command ä¼ é€’è¿‡æ¥åªæ˜¯æ›´æ–°äº†å¯¹åº”æ–‡ä»¶èŠ‚ç‚¹çš„ oom_score_adj</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>low_ram_device<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">900</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">800</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">700</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Launcher should be perceptible, don't kill it.</span>            params<span class="token punctuation">.</span>oomadj <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span>   <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Persistent processes will have a large</span>            <span class="token comment" spellcheck="true">// soft limit 512MB.</span>            soft_limit_mult <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">snprintf</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token string">"/dev/memcg/apps/uid_%d/pid_%d/memory.soft_limit_in_bytes"</span><span class="token punctuation">,</span>             params<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> soft_limit_mult <span class="token operator">*</span> EIGHT_MEGA<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">writefilestring</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ä» hashtable ä¸­æŸ¥æ‰¾ proc</span>    procp <span class="token operator">=</span> <span class="token function">pid_lookup</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿›ç¨‹æ˜¯æ–°åˆ›å»ºçš„ï¼Œlmkd ç»´æŠ¤çš„æ•°æ®ç»“æ„ä¸­è¿˜æ²¡æœ‰è¿™ä¸ª procï¼Œå› æ­¤éœ€è¦æ–°å»ºå¹¶æ·»åŠ åˆ° hashtable ä¸­</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span> <span class="token punctuation">{</span>            procp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> proc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Oh, the irony.  May need to rebuild our state.</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">=</span> params<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>            procp<span class="token operator">-</span><span class="token operator">></span>uid <span class="token operator">=</span> params<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>            procp<span class="token operator">-</span><span class="token operator">></span>oomadj <span class="token operator">=</span> params<span class="token punctuation">.</span>oomadj<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å°† proc æ’å…¥åˆ° lmkd ä¸­çš„æ•°æ®ç»“æ„ä¸­ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ•°æ®ç»“æ„</span>            <span class="token comment" spellcheck="true">// æ›´æ–° hashtableï¼Œé€šè¿‡ pid è®¡ç®— hash å€¼ï¼Œç„¶åå­˜å‚¨ï¼Œè§£å†³å†²çªæ˜¯è®©æ–°æ¥çš„ä½œä¸ºæ•°ç»„å…ƒç´ é“¾è¡¨çš„å¤´ç»“ç‚¹</span>            <span class="token comment" spellcheck="true">// ä¼˜å…ˆçº§ä¸º index çš„åŒå‘é“¾è¡¨ç»„æˆçš„ table</span>            <span class="token function">proc_insert</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// hashtable ä¸­å·²ç»æœ‰è¿™ä¸ª proc</span>        <span class="token comment" spellcheck="true">// ä½†æ˜¯å› ä¸ºä¼˜å…ˆçº§çš„å˜åŒ–ï¼Œéœ€è¦å…ˆæŠŠè¿™ä¸ª proc ä»åŸå…ˆçš„ä¼˜å…ˆçº§ table ä¸­å¯¹åº”ä½ç½®çš„åŒå‘é“¾è¡¨ä¸­ remove</span>        <span class="token comment" spellcheck="true">// ç„¶åæ–°åŠ åˆ°æ–°çš„ä¼˜å…ˆçº§å¯¹åº”çš„åŒå‘é“¾è¡¨ä¸­</span>        <span class="token comment" spellcheck="true">// åŒå‘é“¾è¡¨çš„æ·»åŠ æ˜¯æ–°æ¥çš„æ”¾åœ¨å¤´éƒ¨</span>        <span class="token function">proc_unslot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>        procp<span class="token operator">-</span><span class="token operator">></span>oomadj <span class="token operator">=</span> params<span class="token punctuation">.</span>oomadj<span class="token punctuation">;</span>        <span class="token function">proc_slot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// å…¶ä¸­ pid_lookupï¼šæŸ¥è¯¢ hashtableï¼Œå› ä¸ºè¿›ç¨‹çš„ pid æ˜¯å”¯ä¸€çš„ï¼Œç„¶åä»ä¸­å–å‡ºè¯¥ pid åœ¨ lmkd ä¸­çš„ proc ç»“æ„ä½“</span><span class="token keyword">static</span> <span class="token keyword">struct</span> proc <span class="token operator">*</span><span class="token function">pid_lookup</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>procp <span class="token operator">=</span> pidhash<span class="token punctuation">[</span><span class="token function">pid_hashfn</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> procp <span class="token operator">&amp;&amp;</span> procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">!=</span> pid<span class="token punctuation">;</span>         procp <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">)</span>            <span class="token punctuation">;</span>    <span class="token keyword">return</span> procp<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="5-2-3-LMK-PROCREMOVE"><a href="#5-2-3-LMK-PROCREMOVE" class="headerlink" title="5.2.3 LMK_PROCREMOVE"></a>5.2.3 LMK_PROCREMOVE</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä¸Šå±‚å¤„ç†é€»è¾‘åœ¨ ProcessList.remove ä¸­</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// This indicates that the process is not started yet and so no need to proceed further.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_PROCREMOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd å¤„ç†é€»è¾‘</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_procremove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> lmk_procremove params<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœä½¿ç”¨ kernel æ¥å£ï¼Œreturn</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token function">lmkd_pack_get_procremove</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ›´æ–°æ•°æ®ç»“æ„ï¼Œpid çš„ hashtable ä»¥åŠè¿›ç¨‹ä¼˜å…ˆçº§çš„åŒå‘é“¾è¡¨ table</span>    <span class="token function">pid_remove</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pid_remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> hval <span class="token operator">=</span> <span class="token function">pid_hashfn</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>    <span class="token keyword">struct</span> proc <span class="token operator">*</span>prevp<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>procp <span class="token operator">=</span> pidhash<span class="token punctuation">[</span>hval<span class="token punctuation">]</span><span class="token punctuation">,</span> prevp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> procp <span class="token operator">&amp;&amp;</span> procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">!=</span> pid<span class="token punctuation">;</span>         procp <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">)</span>            prevp <span class="token operator">=</span> procp<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevp<span class="token punctuation">)</span>        pidhash<span class="token punctuation">[</span>hval<span class="token punctuation">]</span> <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">;</span>    <span class="token keyword">else</span>        prevp<span class="token operator">-</span><span class="token operator">></span>pidhash_next <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">;</span>    <span class="token function">proc_unslot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ä»ä¸Šé¢çš„å¤„ç†é€»è¾‘å°±èƒ½çœ‹å‡ºæ¥ï¼Œä¸‰ç§ command çš„å¤„ç†é€»è¾‘ä¸­éƒ½å¯¹ use_inkernel_interface çš„æƒ…å†µä¸‹åšäº†ç‰¹æ®Šå¤„ç†ï¼Œåœ¨ use_inkernel_interface çš„æƒ…å†µä¸‹ï¼Œåšçš„äº‹æƒ…éƒ½æ˜¯å¾ˆç®€å•çš„ï¼Œåªæ˜¯æ›´æ–°ä¸€ä¸‹æ–‡ä»¶èŠ‚ç‚¹ã€‚å¦‚æœä¸ä½¿ç”¨ kernel interfaceï¼Œå°±éœ€è¦ lmkd è‡ªå·±ç»´æŠ¤ä¸¤ä¸ª tableï¼Œåœ¨æ¯æ¬¡æ›´æ–° adj çš„æ—¶å€™å»æ›´æ–° tableã€‚ ä¸”åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿèƒ½çœ‹åˆ°ï¼Œå¦‚æœä¸ä½¿ç”¨ kernel çš„ lowmemorykillerï¼Œåˆ™éœ€è¦ lmkd è‡ªå·±è·å–æ‰‹æœºå†…å­˜çŠ¶æ€ï¼Œå¦‚æœåŒ¹é…åˆ°äº† minfree ä¸­çš„ç­‰çº§ï¼Œåˆ™éœ€è¦é€šè¿‡æ€æ‰ä¸€äº›è¿›ç¨‹é‡Šæ”¾å†…å­˜ã€‚</p><p>åœ¨ä¸‰ç§æ•°æ®çš„ä»£ç åˆ†æä¸­ï¼Œæˆ‘ä»¬éƒ½çœ‹åˆ°äº† writeLmkd å‡½æ•°ï¼Œæ¥ä¸‹æ¥ç®€å•çœ‹ä¸‹ï¼</p><h3 id="5-2-4-writeLmkd"><a href="#5-2-4-writeLmkd" class="headerlink" title="5.2.4 writeLmkd"></a>5.2.4 writeLmkd</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeLmkd</span><span class="token punctuation">(</span>ByteBuffer buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å½“ socket æ‰“å¼€å¤±è´¥ä¼šå°è¯• 3 æ¬¡</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sLmkdSocket <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ‰“å¼€ socket</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">openLmkdSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            å°† buf ä¿¡æ¯å†™å…¥ lmkd socket            sLmkdOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>             Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error writing to lowmemorykiller socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                sLmkdSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>            sLmkdSocket <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æŸ¥çœ‹æ‰“å¼€ socket çš„å‡½æ•°ï¼š</p><h3 id="5-2-5-openLmkdSocket"><a href="#5-2-5-openLmkdSocket" class="headerlink" title="5.2.5 openLmkdSocket"></a>5.2.5 openLmkdSocket</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">openLmkdSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            sLmkdSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocket</span><span class="token punctuation">(</span>LocalSocket<span class="token punctuation">.</span>SOCKET_SEQPACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ä¸è¿œç¨‹ lmkd å®ˆæŠ¤è¿›ç¨‹å»ºç«‹ socket è¿æ¥</span>            sLmkdSocket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">LocalSocketAddress</span><span class="token punctuation">(</span><span class="token string">"lmkd"</span><span class="token punctuation">,</span>                        LocalSocketAddress<span class="token punctuation">.</span>Namespace<span class="token punctuation">.</span>RESERVED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sLmkdOutputStream <span class="token operator">=</span> sLmkdSocket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"lowmemorykiller daemon socket open failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sLmkdSocket <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>è¯¥æ–¹æ³•æ˜¯æ‰“å¼€ä¸€ä¸ªåä¸º lmkd çš„ socketï¼Œç±»å‹ä¸º LocalSocket.SOCKET_SEQPACKETï¼Œè¿™åªæ˜¯ä¸€ä¸ªå°è£…ï¼ŒçœŸå®ç±»å‹å°±æ˜¯ SOCK_SEQPACKETã€‚å…ˆè·Ÿè¿œç¨‹ lmkd å®ˆæŠ¤è¿›ç¨‹å»ºç«‹è¿æ¥ï¼Œå†å‘å…¶é€šè¿‡ write() å°†æ•°æ®å†™å…¥è¯¥ socketï¼Œå†æ¥ä¸‹æ¥è¿›å…¥ lmkd è¿‡ç¨‹ã€‚</p><h2 id="5-3-Kernel"><a href="#5-3-Kernel" class="headerlink" title="5.3 Kernel"></a>5.3 Kernel</h2><p>å‰é¢æè¿‡ï¼Œ<strong><font color="#FF0000">å¤§å¤šæƒ…å†µå…¶å®æ˜¯ä½¿ç”¨ kernel interface çš„ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ kernel ä¸­çš„ lowmemorykiller</font></strong>ã€‚</p><p>lowmemorykiller driver ä½äº kernel-x.xx/drivers/staging/android/lowmemorykiller.cã€‚</p><p>lowmemorykiller ä¸­æ˜¯é€šè¿‡ linux çš„ shrinker å®ç°çš„ï¼Œè¿™ä¸ªæ˜¯ linux çš„å†…å­˜å›æ”¶æœºåˆ¶çš„ä¸€ç§ï¼Œç”±å†…æ ¸çº¿ç¨‹ kswapd è´Ÿè´£ç›‘æ§ï¼Œåœ¨ lowmemorykiller åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œ register_shrinkerã€‚</p><h3 id="5-3-1-lowmemorykiller-åˆå§‹åŒ–"><a href="#5-3-1-lowmemorykiller-åˆå§‹åŒ–" class="headerlink" title="5.3.1 lowmemorykiller åˆå§‹åŒ–"></a>5.3.1 lowmemorykiller åˆå§‹åŒ–</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> shrinker lowmem_shrinker <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span>scan_objects <span class="token operator">=</span> lowmem_scan<span class="token punctuation">,</span>    <span class="token punctuation">.</span>count_objects <span class="token operator">=</span> lowmem_count<span class="token punctuation">,</span>    <span class="token punctuation">.</span>seeks <span class="token operator">=</span> DEFAULT_SEEKS <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">lowmem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token function">register_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// åˆå§‹åŒ–</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">lowmem_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">unregister_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// é€€å‡º</span><span class="token punctuation">}</span></code></pre><p>é€šè¿‡ register_shrinker å’Œ unregister_shrinker åˆ†åˆ«ç”¨äºåˆå§‹åŒ–å’Œé€€å‡ºã€‚</p><h3 id="5-3-2-minfree-min-adj"><a href="#5-3-2-minfree-min-adj" class="headerlink" title="5.3.2 minfree/min_adj"></a>5.3.2 minfree/min_adj</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// ä¸‹é¢ä¸¤ä¸ªæ•°ç»„åˆ†åˆ«ä»£è¡¨äº†ä¸¤ä¸ªå‚æ•°æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼ï¼Œæ•°ç»„é»˜è®¤çš„ size éƒ½æ˜¯ 9</span><span class="token comment" spellcheck="true">// å¯¹åº” "/sys/module/lowmemorykiller/parameters/adj"</span><span class="token keyword">static</span> <span class="token keyword">short</span> lowmem_adj<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token number">6</span><span class="token punctuation">,</span>    <span class="token number">12</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// å¯¹åº” "/sys/module/lowmemorykiller/parameters/minfree"</span><span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_adj_size <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span><span class="token keyword">int</span> lowmem_minfree<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">512</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 6MB */</span>    <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 8MB */</span>    <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 16MB */</span>    <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 64MB */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_minfree_size <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span></code></pre><h3 id="5-3-3-shrinker"><a href="#5-3-3-shrinker" class="headerlink" title="5.3.3 shrinker"></a>5.3.3 shrinker</h3><p>å½“å†…å­˜ä¸è¶³æ—¶ kswapd çº¿ç¨‹ä¼šéå†ä¸€å¼  shrinker é“¾è¡¨ï¼Œå¹¶å›è°ƒå·²æ³¨å†Œçš„ shrinker å‡½æ•°æ¥å›æ”¶å†…å­˜ pageï¼Œkswapd è¿˜ä¼šå‘¨æœŸæ€§å”¤é†’æ¥æ‰§è¡Œå†…å­˜æ“ä½œã€‚æ¯ä¸ª zone ç»´æŠ¤ active_list å’Œ inactive_list é“¾è¡¨ï¼Œå†…æ ¸æ ¹æ®é¡µé¢æ´»åŠ¨çŠ¶æ€å°† page åœ¨è¿™ä¸¤ä¸ªé“¾è¡¨ä¹‹é—´ç§»åŠ¨ï¼Œæœ€ç»ˆé€šè¿‡ shrink_slab å’Œ shrink_zone æ¥å›æ”¶å†…å­˜é¡µï¼Œæœ‰å…´è¶£æƒ³è¿›ä¸€æ­¥äº†è§£ linux å†…å­˜å›æ”¶æœºåˆ¶ï¼Œå¯è‡ªè¡Œç ”ç©¶ã€‚</p><h3 id="5-3-4-lowmem-count"><a href="#5-3-4-lowmem-count" class="headerlink" title="5.3.4 lowmem_count"></a>5.3.4 lowmem_count</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">lowmem_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> shrinker <span class="token operator">*</span>s<span class="token punctuation">,</span>                  <span class="token keyword">struct</span> shrink_control <span class="token operator">*</span>sc<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment" spellcheck="true">// ANONä»£è¡¨åŒ¿åæ˜ å°„ï¼Œæ²¡æœ‰åå¤‡å­˜å‚¨å™¨ï¼›</span>  <span class="token comment" spellcheck="true">// FILE ä»£è¡¨æ–‡ä»¶æ˜ å°„ï¼› å†…å­˜è®¡ç®—å…¬å¼ = æ´»åŠ¨åŒ¿åå†…å­˜ + æ´»åŠ¨æ–‡ä»¶å†…å­˜ + ä¸æ´»åŠ¨åŒ¿åå†…å­˜ + ä¸æ´»åŠ¨æ–‡ä»¶å†…å­˜</span>  <span class="token keyword">return</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_ACTIVE_ANON<span class="token punctuation">)</span> <span class="token operator">+</span>           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_ACTIVE_FILE<span class="token punctuation">)</span> <span class="token operator">+</span>           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_INACTIVE_ANON<span class="token punctuation">)</span> <span class="token operator">+</span>           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_INACTIVE_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="5-3-5-lowmem-scan"><a href="#5-3-5-lowmem-scan" class="headerlink" title="5.3.5 lowmem_scan"></a>5.3.5 lowmem_scan</h3><p>å½“è§¦å‘ lmkdï¼Œåˆ™å…ˆæ€ oom_score_adj æœ€å¤§çš„è¿›ç¨‹ï¼Œå½“ oom_adj ç›¸ç­‰æ—¶ï¼Œåˆ™é€‰æ‹© rss æœ€å¤§çš„è¿›ç¨‹ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> unsigned <span class="token keyword">long</span> <span class="token function">lowmem_scan</span><span class="token punctuation">(</span>struct shrinker <span class="token operator">*</span>s<span class="token punctuation">,</span> struct shrink_control <span class="token operator">*</span>sc<span class="token punctuation">)</span><span class="token punctuation">{</span>    struct task_struct <span class="token operator">*</span>tsk<span class="token punctuation">;</span>    struct task_struct <span class="token operator">*</span>selected <span class="token operator">=</span> NULL<span class="token punctuation">;</span>    unsigned <span class="token keyword">long</span> rem <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> tasksize<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">short</span> min_score_adj <span class="token operator">=</span> OOM_SCORE_ADJ_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> minfree <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> selected_tasksize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">short</span> selected_oom_score_adj<span class="token punctuation">;</span>    <span class="token keyword">int</span> array_size <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è·å–å½“å‰å‰©ä½™å†…å­˜å¤§å°</span>    <span class="token keyword">int</span> other_free <span class="token operator">=</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_FREE_PAGES<span class="token punctuation">)</span> <span class="token operator">-</span> totalreserve_pages<span class="token punctuation">;</span>    <span class="token keyword">int</span> other_file <span class="token operator">=</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_FILE_PAGES<span class="token punctuation">)</span> <span class="token operator">-</span>                        <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_SHMEM<span class="token punctuation">)</span> <span class="token operator">-</span>                        <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_UNEVICTABLE<span class="token punctuation">)</span> <span class="token operator">-</span>                        <span class="token function">total_swapcache_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// è·å–æ•°ç»„å¤§å°</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lowmem_adj_size <span class="token operator">&lt;</span> array_size<span class="token punctuation">)</span>        array_size <span class="token operator">=</span> lowmem_adj_size<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lowmem_minfree_size <span class="token operator">&lt;</span> array_size<span class="token punctuation">)</span>        array_size <span class="token operator">=</span> lowmem_minfree_size<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// éå† lowmem_minfree æ•°ç»„æ‰¾å‡ºç›¸åº”çš„æœ€å° adj å€¼</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        minfree <span class="token operator">=</span> lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>other_free <span class="token operator">&lt;</span> minfree <span class="token operator">&amp;&amp;</span> other_file <span class="token operator">&lt;</span> minfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>            min_score_adj <span class="token operator">=</span> lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>min_score_adj <span class="token operator">==</span> OOM_SCORE_ADJ_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    selected_oom_score_adj <span class="token operator">=</span> min_score_adj<span class="token punctuation">;</span>    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">for_each_process</span><span class="token punctuation">(</span>tsk<span class="token punctuation">)</span> <span class="token punctuation">{</span>        struct task_struct <span class="token operator">*</span>p<span class="token punctuation">;</span>        <span class="token keyword">short</span> oom_score_adj<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tsk<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> PF_KTHREAD<span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        p <span class="token operator">=</span> <span class="token function">find_lock_task_mm</span><span class="token punctuation">(</span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_tsk_thread_flag</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> TIF_MEMDIE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            <span class="token function">time_before_eq</span><span class="token punctuation">(</span>jiffies<span class="token punctuation">,</span> lowmem_deathpending_timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrink_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> SHRINK_STOP<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        oom_score_adj <span class="token operator">=</span> p<span class="token operator">-</span><span class="token operator">></span>signal<span class="token operator">-</span><span class="token operator">></span>oom_score_adj<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å°äºç›®æ ‡adjçš„è¿›ç¨‹ï¼Œåˆ™å¿½ç•¥</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">&lt;</span> min_score_adj<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è·å–çš„æ˜¯è¿›ç¨‹çš„ Resident Set Sizeï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹ç‹¬å å†…å­˜ + å…±äº«åº“å¤§å°</span>        tasksize <span class="token operator">=</span> <span class="token function">get_mm_rss</span><span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token operator">></span>mm<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tasksize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ç®—æ³•å…³é”®ï¼Œé€‰æ‹© oom_score_adj æœ€å¤§çš„è¿›ç¨‹ä¸­ï¼Œå¹¶ä¸” rss å†…å­˜æœ€å¤§çš„è¿›ç¨‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">&lt;</span> selected_oom_score_adj<span class="token punctuation">)</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">==</span> selected_oom_score_adj <span class="token operator">&amp;&amp;</span>                tasksize <span class="token operator">&lt;=</span> selected_tasksize<span class="token punctuation">)</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        selected <span class="token operator">=</span> p<span class="token punctuation">;</span>        selected_tasksize <span class="token operator">=</span> tasksize<span class="token punctuation">;</span>        selected_oom_score_adj <span class="token operator">=</span> oom_score_adj<span class="token punctuation">;</span>        <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"select '%s' (%d), adj %d, score_adj %hd, size %d, to kill\n"</span><span class="token punctuation">,</span>                 p<span class="token operator">-</span><span class="token operator">></span>comm<span class="token punctuation">,</span> p<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> <span class="token function">REVERT_ADJ</span><span class="token punctuation">(</span>oom_score_adj<span class="token punctuation">)</span><span class="token punctuation">,</span> oom_score_adj<span class="token punctuation">,</span> tasksize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> cache_size <span class="token operator">=</span> other_file <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> cache_limit <span class="token operator">=</span> minfree <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> free <span class="token operator">=</span> other_free <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">trace_lowmemory_kill</span><span class="token punctuation">(</span>selected<span class="token punctuation">,</span> cache_size<span class="token punctuation">,</span> cache_limit<span class="token punctuation">,</span> free<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è¾“å‡º kill çš„ log</span>        <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Killing '%s' (%d), adj %d, score_adj %hd, state(%ld)\n"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        lowmem_deathpending_timeout <span class="token operator">=</span> jiffies <span class="token operator">+</span> LOWMEM_DEATHPENDING_TIMEOUT<span class="token punctuation">;</span>        <span class="token function">set_tsk_thread_flag</span><span class="token punctuation">(</span>selected<span class="token punctuation">,</span> TIF_MEMDIE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// å‘é€‰ä¸­çš„ç›®æ ‡è¿›ç¨‹å‘é€ signal 9 æ¥æ€æ‰ç›®æ ‡è¿›ç¨‹</span>        <span class="token function">send_sig</span><span class="token punctuation">(</span>SIGKILL<span class="token punctuation">,</span> selected<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rem <span class="token operator">+=</span> selected_tasksize<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d_state_is_found <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"No selected (full of D-state processes at %d)\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>min_score_adj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"lowmem_scan %lu, %x, return %lu\n"</span><span class="token punctuation">,</span>             sc<span class="token operator">-</span><span class="token operator">></span>nr_to_scan<span class="token punctuation">,</span> sc<span class="token operator">-</span><span class="token operator">></span>gfp_mask<span class="token punctuation">,</span> rem<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrink_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> rem<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å½“å¦‚ä¸‹èŠ‚ç‚¹æ•°æ®å‘é€å˜åŒ–æ—¶ï¼Œä¼šé€šè¿‡ä¿®æ”¹ lowmem_minfree[ ] å’Œ lowmem_adj[ ] æ•°ç»„ï¼š</p><pre><code>/sys/module/lowmemorykiller/parameters/minfree/sys/module/lowmemorykiller/parameters/adj</code></pre><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡ä¸»è¦è®¨è®º frameworks çš„ ProcessList.java è°ƒæ•´ adjï¼Œé€šè¿‡ socket é€šä¿¡å°†äº‹ä»¶å‘é€ç»™ native çš„å®ˆæŠ¤è¿›ç¨‹ lmkdï¼›lmkd å†æ ¹æ®å…·ä½“çš„å‘½ä»¤æ¥æ‰§è¡Œç›¸åº”æ“ä½œï¼Œå…¶ä¸»è¦åŠŸèƒ½ æ›´æ–°è¿›ç¨‹çš„ oom_score_adj å€¼ä»¥åŠ lowmemorykiller é©±åŠ¨çš„ parameters (åŒ…æ‹¬ minfree å’Œ adj )ï¼›</p><p>æœ€åè®²åˆ°äº† lowmemorykiller é©±åŠ¨ï¼Œé€šè¿‡æ³¨å†Œ shrinkerï¼Œå€ŸåŠ© linux æ ‡å‡†çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œæ ¹æ®å½“å‰ç³»ç»Ÿå¯ç”¨å†…å­˜ä»¥åŠ parameters é…ç½®å‚æ•°( adj , minfree )æ¥é€‰å–åˆé€‚çš„ selected_oom_score_adjï¼Œå†ä»æ‰€æœ‰è¿›ç¨‹ä¸­é€‰æ‹© adj å¤§äºè¯¥ç›®æ ‡å€¼çš„å¹¶ä¸”å ç”¨ rss å†…å­˜æœ€å¤§çš„è¿›ç¨‹ï¼Œå°†å…¶æ€æ‰ï¼Œä»è€Œé‡Šæ”¾å‡ºå†…å­˜ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>&nbsp;01. <a href="http://gityuan.com/2016/09/17/android-lowmemorykiller/" target="_blank" rel="noopener">http://gityuan.com/2016/09/17/android-lowmemorykiller/</a><br>&nbsp;02. <a href="https://blog.csdn.net/u011733869/article/details/78820240" target="_blank" rel="noopener">https://blog.csdn.net/u011733869/article/details/78820240</a><br>&nbsp;03. <a href="https://blog.csdn.net/su749520/article/details/78595367" target="_blank" rel="noopener">https://blog.csdn.net/su749520/article/details/78595367</a><br>&nbsp;04. <a href="http://gityuan.com/2018/05/19/android-process-adj/" target="_blank" rel="noopener">http://gityuan.com/2018/05/19/android-process-adj/</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ ¸å¿ƒæŠ€æœ¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LowMemoryKiller </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ äº‹ä»¶åˆ†å‘</title>
      <link href="/2018/09/26/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-shi-jian-fen-fa/"/>
      <url>/2018/09/26/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-shi-jian-fen-fa/</url>
      
        <content type="html"><![CDATA[<h1 id="1-æ ¸å¿ƒæºç "><a href="#1-æ ¸å¿ƒæºç " class="headerlink" title="1. æ ¸å¿ƒæºç "></a>1. æ ¸å¿ƒæºç </h1><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">Activity.java</font></td><td>frameworks/base/core/java/android/app/Activity.java</td></tr><tr><td><font color="#D15FEE">DecorView.java</font></td><td>frameworks/base/core/java/com/android/internal/policy/DecorView.java</td></tr><tr><td><font color="#D15FEE">PhoneWindow.java</font></td><td>frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java</td></tr><tr><td><font color="#D15FEE">View.java</font></td><td>frameworks/base/core/java/android/view/View.java</td></tr><tr><td><font color="#D15FEE">ViewGroup.java</font></td><td>frameworks/base/core/core/java/android/view/ViewGroup.java</td></tr><tr><td><font color="#D15FEE">Window.java</font></td><td>frameworks/base/core/java/android/view/Window.java</td></tr></tbody></table><p><br></p><hr><h1 id="2-åŸºç¡€è®¤çŸ¥"><a href="#2-åŸºç¡€è®¤çŸ¥" class="headerlink" title="2. åŸºç¡€è®¤çŸ¥"></a>2. åŸºç¡€è®¤çŸ¥</h1><p>Android <strong> â€œViewâ€</strong>  è™½ç„¶ä¸æ˜¯å››å¤§ç»„ä»¶ï¼Œä½†å…¶å¹¶ä¸æ¯”å››å¤§ç»„ä»¶çš„åœ°ä½ä½ã€‚è€Œ View çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹<strong><font color="#FF0000"> â€œäº‹ä»¶åˆ†å‘æœºåˆ¶â€ </font></strong>åˆ™æ˜¯ä¸å°‘åˆšå…¥é—¨ç«¥é‹çš„æ‹¦è·¯è™ï¼ˆ<strong>1ã€é¡¹ç›®ä¸­å¤„å¤„é‡åˆ°äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼›2ã€é¢è¯•ç®¡æœ€å–œæ¬¢æåŠçš„é—®é¢˜</strong>ï¼‰ã€‚</p><p>åœ¨å®é™…é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒScrollView åµŒå¥— RecyclerViewï¼ˆæˆ–è€… ListViewï¼‰çš„æ»‘åŠ¨å†²çªè¿™ç§è€å¤§éš¾é—®é¢˜çš„ç†è®ºåŸºç¡€å°±æ˜¯â€œäº‹ä»¶åˆ†å‘æœºåˆ¶â€ã€‚</p><p><strong>é¦–å…ˆï¼Œæˆ‘ä»¬äº†è§£ä¸€ä¸‹â€œäº‹ä»¶åˆ†å‘æœºåˆ¶â€ä¸­çš„åŸºç¡€çŸ¥è¯†ç‚¹ï¼</strong></p><h2 id="2-1-äº‹ä»¶åˆ†å‘çš„å¯¹è±¡"><a href="#2-1-äº‹ä»¶åˆ†å‘çš„å¯¹è±¡" class="headerlink" title="2.1 äº‹ä»¶åˆ†å‘çš„å¯¹è±¡"></a>2.1 äº‹ä»¶åˆ†å‘çš„å¯¹è±¡</h2><p>äº‹ä»¶åˆ†å‘çš„å¯¹è±¡ï¼š<strong><font color="#0000FF">ç‚¹å‡»äº‹ä»¶ï¼ˆTouchäº‹ä»¶ï¼‰</font></strong></p><p><strong>1. å®šä¹‰</strong></p><p>å½“ç”¨æˆ·è§¦æ‘¸å±å¹•æ—¶ï¼ˆView æˆ– ViewGroup æ´¾ç”Ÿçš„æ§ä»¶ï¼‰ï¼Œå°†äº§ç”Ÿç‚¹å‡»äº‹ä»¶ï¼ˆTouchäº‹ä»¶ï¼‰</p><blockquote><p>Touch äº‹ä»¶çš„ç›¸å…³ç»†èŠ‚ï¼ˆå‘ç”Ÿè§¦æ‘¸çš„ä½ç½®ã€æ—¶é—´ç­‰ï¼‰è¢«å°è£…æˆ MotionEvent å¯¹è±¡ã€‚</p></blockquote><p><strong>2. äº‹ä»¶ç±»å‹</strong></p><table><thead><tr><th>äº‹ä»¶ç±»å‹</th><th>å…·ä½“åŠ¨ä½œ</th></tr></thead><tbody><tr><td>MotionEvent.ACTION_DOWN</td><td>æŒ‰ä¸‹ Viewï¼ˆæ‰€æœ‰äº‹ä»¶çš„å¼€å§‹ï¼‰</td></tr><tr><td>MotionEvent.ACTION_UP</td><td>æŠ¬èµ· Viewï¼ˆä¸DOWNå¯¹åº”ï¼‰</td></tr><tr><td>MotionEvent.ACTION_MOVE</td><td>æ»‘åŠ¨ View</td></tr><tr><td>MotionEvent.ACTION_CANCEL</td><td>ç»“æŸäº‹ä»¶ï¼ˆéäººä¸ºåŸå› ï¼‰</td></tr></tbody></table><p><br></p><p><strong>3. äº‹ä»¶åºåˆ—</strong></p><p>æ‰€è°“äº‹ä»¶åºåˆ—å°±æ˜¯æŒ‡ï¼šä»æ‰‹æŒ‡æ¥è§¦å±å¹•è‡³æ‰‹æŒ‡ç¦»å¼€å±å¹•ï¼Œè¿™ä¸ªè¿‡ç¨‹äº§ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<font color="#FF0000">äº‹ä»¶åˆ—éƒ½æ˜¯ä»¥ DOWN äº‹ä»¶å¼€å§‹ã€UP äº‹ä»¶ç»“æŸï¼Œä¸­é—´æœ‰æ— æ•°çš„ MOVE äº‹ä»¶</font>ã€‚</p><p>å¦‚ä¸‹å›¾ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-3bd69415acb30024.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="äº‹ä»¶åˆ—.png"></center><p>å³å½“ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼ˆMotionEvent ï¼‰äº§ç”Ÿåï¼Œç³»ç»Ÿéœ€æŠŠè¿™ä¸ªäº‹ä»¶ä¼ é€’ç»™ä¸€ä¸ªå…·ä½“çš„ View å»å¤„ç†ã€‚</p><h2 id="2-2-äº‹ä»¶åˆ†å‘çš„æœ¬è´¨"><a href="#2-2-äº‹ä»¶åˆ†å‘çš„æœ¬è´¨" class="headerlink" title="2.2 äº‹ä»¶åˆ†å‘çš„æœ¬è´¨"></a>2.2 äº‹ä»¶åˆ†å‘çš„æœ¬è´¨</h2><p><strong><font color="#FF0000" size="4">æœ¬è´¨ï¼š</font></strong> å°†ç‚¹å‡»äº‹ä»¶ï¼ˆMotionEventï¼‰ä¼ é€’åˆ°æŸä¸ªå…·ä½“çš„ View å¹¶å¤„ç†çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ </p><blockquote><p>å³ï¼šäº‹ä»¶ä¼ é€’çš„è¿‡ç¨‹ = åˆ†å‘è¿‡ç¨‹</p></blockquote><h2 id="2-3-äº‹ä»¶åˆ†å‘çš„å¯¹è±¡"><a href="#2-3-äº‹ä»¶åˆ†å‘çš„å¯¹è±¡" class="headerlink" title="2.3 äº‹ä»¶åˆ†å‘çš„å¯¹è±¡"></a>2.3 äº‹ä»¶åˆ†å‘çš„å¯¹è±¡</h2><p><strong><font color="#FF0000" size="4">å¯¹è±¡ï¼š</font></strong> Activityã€ViewGroupã€View </p><blockquote><p>Android çš„ UI ç•Œé¢ç”± Activityã€ViewGroupã€View åŠå…¶æ´¾ç”Ÿç±»ç»„æˆã€‚</p></blockquote><p>å¦‚ä¸‹å›¾ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-b8a64e07cc1ff705.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="UI ç•Œé¢.png"></center><h2 id="2-4-äº‹ä»¶åˆ†å‘çš„é¡ºåº"><a href="#2-4-äº‹ä»¶åˆ†å‘çš„é¡ºåº" class="headerlink" title="2.4 äº‹ä»¶åˆ†å‘çš„é¡ºåº"></a>2.4 äº‹ä»¶åˆ†å‘çš„é¡ºåº</h2><p><strong><font color="#FF0000" size="4">é¡ºåºï¼š</font></strong> Activity -&gt; ViewGroup -&gt; View </p><blockquote><p>å³ï¼š1ä¸ªç‚¹å‡»äº‹ä»¶å‘ç”Ÿåï¼Œäº‹ä»¶å…ˆä¼ åˆ° Activityã€å†ä¼ åˆ° ViewGroupã€æœ€ç»ˆå†ä¼ åˆ° Viewã€‚</p></blockquote><p>äº‹ä»¶åˆ†å‘çš„é¡ºåºæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-f9c8101c57333075.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¼ é€’.png"></center><h2 id="2-5-äº‹ä»¶åˆ†å‘çš„æ–¹æ³•"><a href="#2-5-äº‹ä»¶åˆ†å‘çš„æ–¹æ³•" class="headerlink" title="2.5 äº‹ä»¶åˆ†å‘çš„æ–¹æ³•"></a>2.5 äº‹ä»¶åˆ†å‘çš„æ–¹æ³•</h2><p><strong><font color="#FF0000" size="4">ä¸‰ä¸ªé‡è¦æ–¹æ³•ï¼š</font></strong> dispatchTouchEvent() ã€onInterceptTouchEvent() å’Œ onTouchEvent()ã€‚</p><blockquote><p><strong><font color="#0000FF">dispatchTouchEventï¼ˆäº‹ä»¶åˆ†å‘ï¼‰ï¼š</font></strong>å½“ç›‘å¬åˆ°æœ‰è§¦å‘äº‹ä»¶æ—¶ï¼Œé¦–å…ˆç”± Activity è¿›è¡Œæ•è·ï¼Œç„¶åäº‹ä»¶å°±è¿›å…¥äº‹ä»¶åˆ†å‘çš„æµç¨‹ã€‚Activity æœ¬èº«æ²¡æœ‰äº‹ä»¶æ‹¦æˆªï¼Œä»è€Œå°†äº‹ä»¶ä¼ é€’ç»™æœ€å¤–å±‚çš„ View çš„ dispatchTouchEvent(MotionEvent ev)ï¼Œè¯¥æ–¹æ³•å°†å¯¹äº‹ä»¶è¿›è¡Œåˆ†å‘ã€‚</p></blockquote><p><strong>è¿”å›å€¼ï¼š</strong>è¡¨ç¤ºæ˜¯å¦æ¶ˆè´¹äº†å½“å‰äº‹ä»¶ã€‚å¯èƒ½æ˜¯ View æœ¬èº«çš„ onTouchEvent() æ¶ˆè´¹ï¼Œä¹Ÿå¯èƒ½æ˜¯å­ View çš„ dispatchTouchEvent() ä¸­æ¶ˆè´¹ã€‚è¿”å› true è¡¨ç¤ºäº‹ä»¶è¢«æ¶ˆè´¹ï¼Œæœ¬æ¬¡çš„äº‹ä»¶ç»ˆæ­¢ã€‚è¿”å› false è¡¨ç¤º View ä»¥åŠå­ View å‡æ²¡æœ‰æ¶ˆè´¹äº‹ä»¶ï¼Œå°†è°ƒç”¨çˆ¶ View çš„ onTouchEvent()ã€‚</p><blockquote><p><strong><font color="#0000FF">onInterceptTouchEventï¼ˆäº‹ä»¶æ‹¦æˆªï¼‰ï¼š</font></strong>å½“ä¸€ä¸ª ViewGroup åœ¨æ¥åˆ° MotionEvent äº‹ä»¶åºåˆ—æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨æ­¤æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªã€‚ç‰¹åˆ«æ³¨æ„ï¼Œè¿™æ˜¯ ViewGroup ç‰¹æœ‰çš„æ–¹æ³•ï¼ŒView å¹¶æ²¡æœ‰æ‹¦æˆªæ–¹æ³•ã€‚</p></blockquote><p><strong>è¿”å›å€¼ï¼š</strong>æ˜¯å¦æ‹¦æˆªäº‹ä»¶ä¼ é€’ï¼Œè¿”å› true è¡¨ç¤ºæ‹¦æˆªäº†äº‹ä»¶ï¼Œé‚£ä¹ˆäº‹ä»¶å°†ä¸å†å‘ä¸‹åˆ†å‘è€Œæ˜¯è°ƒç”¨ View æœ¬èº«çš„ onTouchEvent()ã€‚è¿”å› false è¡¨ç¤ºä¸åšæ‹¦æˆªï¼Œäº‹ä»¶å°†å‘ä¸‹åˆ†å‘åˆ°å­ View çš„ dispatchTouchEvent()ã€‚</p><blockquote><p><strong><font color="#0000FF">onTouchEventï¼ˆäº‹ä»¶å“åº”ï¼‰ï¼š</font></strong>çœŸæ­£å¯¹ MotionEvent è¿›è¡Œå¤„ç†æˆ–è€…è¯´æ¶ˆè´¹çš„æ–¹æ³•ï¼Œåœ¨ dispatchTouchEvent() ä¸­è¿›è¡Œè°ƒç”¨ã€‚</p></blockquote><p><strong>è¿”å›å€¼ï¼š</strong>è¿”å› true è¡¨ç¤ºäº‹ä»¶è¢«æ¶ˆè´¹ï¼Œæœ¬æ¬¡çš„äº‹ä»¶ç»ˆæ­¢ã€‚è¿”å› false è¡¨ç¤ºäº‹ä»¶æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œå°†è°ƒç”¨çˆ¶ View çš„ onTouchEvent æ–¹æ³•ï¼Œç›´åˆ°è¿”å› true ä¸ºæ­¢ã€‚</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-13579e321d5f0f4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="äº‹ä»¶åˆ†å‘çš„æ–¹æ³•.png"></center><p><br></p><p>æˆ‘ä»¬å¯ä»¥åšä¸ªæ€»ç»“ï¼š</p><p>Activity çš„ç‚¹å‡»äº‹ä»¶äº‹å®ä¸Šæ˜¯è°ƒç”¨å®ƒå†…éƒ¨çš„ ViewGroup çš„ç‚¹å‡»äº‹ä»¶ï¼Œå¯ä»¥ç›´æ¥å½“æˆ ViewGroup å¤„ç†ã€‚</p><p>ViewGroup çš„ç›¸å…³äº‹ä»¶æ–¹æ³•æœ‰ä¸‰ä¸ªï¼š<code>onInterceptTouchEvent</code>ã€<code>dispatchTouchEvent</code>ã€<code>onTouchEvent</code>ã€‚</p><p>View çš„ç›¸å…³äº‹ä»¶æ–¹æ³•åªæœ‰ä¸¤ä¸ªï¼š<code>dispatchTouchEvent</code>ã€<code>onTouchEvent</code>ã€‚</p><hr><p>è¦æƒ³å……åˆ†ç†è§£ Android äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Œæœ¬è´¨ä¸Šæ˜¯è¦ç†è§£ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;âœ¯ <strong><font color="#0000FF">Activity - Touch äº‹ä»¶åˆ†å‘</font></strong>&nbsp;&nbsp;&nbsp;&nbsp; âœ¯ <strong><font color="#0000FF">ViewGroup - Touch äº‹ä»¶åˆ†å‘</font></strong> &nbsp;&nbsp;&nbsp;&nbsp; âœ¯ <strong><font color="#0000FF">View - Touch äº‹ä»¶åˆ†å‘</font></strong> </p><h1 id="3-Touch-äº‹ä»¶åˆ†å‘-â€“-Activity"><a href="#3-Touch-äº‹ä»¶åˆ†å‘-â€“-Activity" class="headerlink" title="3. Touch äº‹ä»¶åˆ†å‘ â€“ Activity"></a>3. Touch äº‹ä»¶åˆ†å‘ â€“ Activity</h1><p>å½“ä¸€ä¸ªç‚¹å‡»äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œäº‹ä»¶æœ€å…ˆä¼ åˆ° Activity çš„ dispatchTouchEvent() ï¼Œè¿›è¡Œäº‹ä»¶åˆ†å‘ã€‚</p><h2 id="3-1-dispatchTouchEvent"><a href="#3-1-dispatchTouchEvent" class="headerlink" title="3.1 dispatchTouchEvent"></a>3.1 dispatchTouchEvent</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>MotionEvent ev<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸€èˆ¬äº‹ä»¶åˆ—å¼€å§‹éƒ½æ˜¯ DOWN äº‹ä»¶ï¼Œå³æŒ‰ä¸‹äº‹ä»¶ï¼Œæ‰€ä»¥æ­¤å¤„åŸºæœ¬æ˜¯ true</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_DOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">onUserInteraction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">// 1</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 2</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>                <span class="token keyword">return</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">// 3</span>    <span class="token punctuation">}</span></code></pre><p>Activity çš„ dispatchTouchEvent æ–¹æ³•å¾ˆç®€å•ï¼Œä¸»è¦æ¶‰åŠä¸‰ä¸ªæ–¹æ³•ï¼š<code>onUserInteraction</code>ã€<code>superDispatchTouchEvent</code>ã€<code>onTouchEvent</code>ã€‚</p><h3 id="3-1-1-onUserInteraction"><a href="#3-1-1-onUserInteraction" class="headerlink" title="3.1.1 onUserInteraction"></a>3.1.1 onUserInteraction</h3><pre class=" language-java"><code class="language-java">   <span class="token comment" spellcheck="true">/**    * è¯´æ˜ï¼š    *    a. è¯¥æ–¹æ³•ä¸ºç©ºæ–¹æ³•ï¼Œä¸»è¦å®ç°å±ä¿åŠŸèƒ½    *    b. å½“æ­¤ activity åœ¨æ ˆé¡¶æ—¶ï¼Œè§¦å±ç‚¹å‡»æŒ‰ homeï¼Œbackï¼Œmenu é”®ç­‰éƒ½ä¼šè§¦å‘æ­¤æ–¹æ³•    */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUserInteraction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span></code></pre><h3 id="3-1-2-superDispatchTouchEvent"><a href="#3-1-2-superDispatchTouchEvent" class="headerlink" title="3.1.2 superDispatchTouchEvent"></a>3.1.2 superDispatchTouchEvent</h3><pre class=" language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/**    * getWindow()ï¼šè·å– Window ç±»çš„å¯¹è±¡ï¼ŒWindow ç±»æ˜¯æŠ½è±¡ç±»ï¼Œ    * å…¶å”¯ä¸€å®ç°ç±»æ˜¯ PhoneWindow ç±»ï¼›å³æ­¤å¤„çš„ Window ç±»å¯¹è±¡ = PhoneWindow ç±»å¯¹è±¡ã€‚    */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>Window ç±»çš„ superDispatchTouchEvent() æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±» PhoneWindow ç±»å®ç°ã€‚</p><h4 id="3-1-2-1-PhoneWindow"><a href="#3-1-2-1-PhoneWindow" class="headerlink" title="3.1.2.1 PhoneWindow"></a>3.1.2.1 PhoneWindow</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneWindow</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span> <span class="token keyword">implements</span> <span class="token class-name">MenuBuilder<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// This is the top-level view of the window, containing the window decor.</span>    <span class="token keyword">private</span> DecorView mDecor<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> mDecor<span class="token punctuation">.</span><span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å‘ç°ï¼ŒActivity çš„ superDispatchTouchEvent æ–¹æ³•æœ€ç»ˆä¼šèµ°åˆ° DecorView çš„ superDispatchTouchEvent æ–¹æ³•ã€‚</p><h4 id="3-1-2-2-DecorView"><a href="#3-1-2-2-DecorView" class="headerlink" title="3.1.2.2 DecorView"></a>3.1.2.2 DecorView</h4><pre class=" language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/**    * public class DecorView extends FrameLayoutï¼Œ    *       -- DecorView ç»§æ‰¿è‡ª FrameLayoutï¼Œæ˜¯æ‰€æœ‰ç•Œé¢çš„çˆ¶ç±»ã€‚             * public class FrameLayout extends ViewGroupï¼Œ            -- FrameLayout æ˜¯ ViewGroup çš„å­ç±»ï¼Œæ•… DecorView çš„é—´æ¥çˆ¶ç±»æ˜¯ ViewGroupã€‚    */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼šViewGroup çš„ dispatchTouchEvent()ï¼Œ</span>        <span class="token comment" spellcheck="true">// å³ï¼šå°†äº‹ä»¶ä¼ é€’åˆ° ViewGroup å»å¤„ç†ï¼Œæˆ‘ä»¬åœ¨ ViewGroup çš„äº‹ä»¶åˆ†å‘æœºåˆ¶ç»§ç»­è®¨è®ºã€‚</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>æ‰€ä»¥ä¸éš¾å‘ç°ï¼ŒActivity çš„ dispatchTouchEvent æ–¹æ³•æœ€ç»ˆä¼šèµ°åˆ° ViewGroup çš„ dispatchTouchEvent æ–¹æ³•ã€‚</p><h3 id="3-1-3-onTouchEvent"><a href="#3-1-3-onTouchEvent" class="headerlink" title="3.1.3 onTouchEvent"></a>3.1.3 onTouchEvent</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸€èˆ¬è¿”å› trueï¼Œé™¤é Touch äº‹ä»¶åœ¨ Window è¾¹ç•Œå¤–ï¼Œæ‰€ä»¥è¿™è¾¹æˆ‘ä»¬ä¸å†ç»§ç»­è·Ÿè¸ªã€‚</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span><span class="token function">shouldCloseOnTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="3-2-å°ç»“"><a href="#3-2-å°ç»“" class="headerlink" title="3.2 å°ç»“"></a>3.2 å°ç»“</h2><center><img src="https://upload-images.jianshu.io/upload_images/3517194-09f4ddd079792c82.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Activity äº‹ä»¶åˆ†å‘å¤„ç†æµç¨‹.png"></center><p><br></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬åˆ†æäº† Activity å¯¹ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘æœºåˆ¶å¤„ç†æµç¨‹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼ŒActivity çš„äº‹ä»¶èµ°åˆ°äº† ViewGroup è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯åˆ†æ ViewGroup å¯¹ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘æœºåˆ¶äº†ã€‚</p><p><br></p><h1 id="4-Touch-äº‹ä»¶åˆ†å‘-â€“-ViewGroup"><a href="#4-Touch-äº‹ä»¶åˆ†å‘-â€“-ViewGroup" class="headerlink" title="4. Touch äº‹ä»¶åˆ†å‘ â€“ ViewGroup"></a>4. Touch äº‹ä»¶åˆ†å‘ â€“ ViewGroup</h1><p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼ŒActivity çš„ dispatchTouchEvent æ–¹æ³•æœ€ç»ˆä¼šèµ°åˆ° ViewGroup çš„ dispatchTouchEvent æ–¹æ³•ã€‚</p><h2 id="4-1-dispatchTouchEvent"><a href="#4-1-dispatchTouchEvent" class="headerlink" title="4.1 dispatchTouchEvent"></a>4.1 dispatchTouchEvent</h2><p>ViewGroup å¯¹ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘æµç¨‹å°±å¤æ‚å¾ˆå¤šäº†ï¼Œæˆ‘ä»¬æ¥ç»†ç»†ç ”ç©¶ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// First touch target in the linked list of touch targets.</span><span class="token keyword">private</span> TouchTarget mFirstTouchTarget<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>MotionEvent ev<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// è¿™ä¸ªå˜é‡ç”¨äºè®°å½•äº‹ä»¶æ˜¯å¦è¢«å¤„ç†å®Œ</span>    <span class="token keyword">boolean</span> handled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è¿‡æ»¤æ‰ä¸€äº›ä¸åˆæ³•çš„äº‹ä»¶</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">onFilterTouchEventForSecurity</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> action <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> actionMasked <span class="token operator">=</span> action <span class="token operator">&amp;</span> MotionEvent<span class="token punctuation">.</span>ACTION_MASK<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯ä¸æ˜¯ Down äº‹ä»¶ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±è¦åšåˆå§‹åŒ–æ“ä½œ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_DOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ Down äº‹ä»¶ï¼Œå°±è¦æ¸…ç©ºæ‰ä¹‹å‰çš„çŠ¶æ€ï¼Œ</span>            <span class="token function">cancelAndClearTouchTargets</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">resetTouchState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// æ˜¯å¦æ‹¦æˆªäº‹ä»¶</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> intercepted<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰æ˜¯ Down äº‹ä»¶ï¼Œæˆ–è€…å·²ç»æœ‰å¤„ç† Touch äº‹ä»¶çš„ç›®æ ‡äº†</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">||</span> mFirstTouchTarget <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">/**              * disallowInterceptï¼šæ˜¯å¦ç¦ç”¨äº‹ä»¶æ‹¦æˆªçš„åŠŸèƒ½ï¼Œé»˜è®¤ä¸º falseï¼Œ              * æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ requestDisallowInterceptTouchEvent æ–¹æ³•              * å¯¹è¿™ä¸ªå€¼è¿›è¡Œä¿®æ”¹ã€‚              */</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span> disallowIntercept <span class="token operator">=</span>                                      <span class="token punctuation">(</span>mGroupFlags <span class="token operator">&amp;</span> FLAG_DISALLOW_INTERCEPT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                      <span class="token comment" spellcheck="true">// disallowIntercept é»˜è®¤ä¸º false æ‰€ä»¥ä¼šèµ°ä»¥ä¸‹æµç¨‹</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disallowIntercept<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ¯æ¬¡äº‹ä»¶åˆ†å‘æ—¶ï¼Œéƒ½éœ€è°ƒç”¨ onInterceptTouchEvent() è¯¢é—®æ˜¯å¦æ‹¦æˆªäº‹ä»¶</span>                intercepted <span class="token operator">=</span> <span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// é‡æ–°æ¢å¤ Actionï¼Œä»¥å… Action åœ¨ä¸Šé¢çš„æ­¥éª¤è¢«äººä¸ºåœ°æ”¹å˜äº†</span>                ev<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// restore action in case it was changed</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å¦‚æœç¦ç”¨äº†äº‹ä»¶æ‹¦æˆªåŠŸèƒ½ï¼Œåˆ™ intercepted è‚¯å®šä¸º false</span>                intercepted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœè¯´ï¼Œäº‹ä»¶å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œå¹¶ä¸”æ²¡æœ‰å­ View è¢«åˆ†é…å¤„ç†ï¼Œ</span>            <span class="token comment" spellcheck="true">// é‚£ä¹ˆå°±è¯´æ˜ï¼Œè¿™ä¸ª ViewGroup å·²ç»æ‹¦æˆªäº†è¿™ä¸ªäº‹ä»¶ã€‚</span>            intercepted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>intercepted <span class="token operator">||</span> mFirstTouchTarget <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            ev<span class="token punctuation">.</span><span class="token function">setTargetAccessibilityFocus</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Check for cancelationï¼Œæ ‡å¿—ç€å–æ¶ˆäº‹ä»¶.</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> canceled <span class="token operator">=</span> <span class="token function">resetCancelNextUpFlag</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>                   <span class="token operator">||</span> actionMasked <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_CANCEL<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å¦‚æœéœ€è¦ï¼ˆä¸å–æ¶ˆï¼Œä¹Ÿæ²¡æœ‰è¢«æ‹¦æˆªï¼‰ï¼Œé‚£ä¹ˆåœ¨è§¦æ‘¸ Down äº‹ä»¶çš„æ—¶å€™æ›´æ–°è§¦æ‘¸ç›®æ ‡åˆ—è¡¨</span>        <span class="token comment" spellcheck="true">// splitï¼šä»£è¡¨å½“å‰çš„ ViewGroup æ˜¯ä¸æ˜¯æ”¯æŒåˆ†å‰² MotionEvent åˆ°ä¸åŒçš„ View å½“ä¸­</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> split <span class="token operator">=</span> <span class="token punctuation">(</span>mGroupFlags <span class="token operator">&amp;</span> FLAG_SPLIT_MOTION_EVENTS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ–°çš„è§¦æ‘¸å¯¹è±¡</span>        TouchTarget newTouchTarget <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æ˜¯å¦æŠŠäº‹ä»¶åˆ†é…ç»™äº†æ–°çš„è§¦æ‘¸</span>        <span class="token keyword">boolean</span> alreadyDispatchedToNewTouchTarget <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        â˜… â˜… â˜… â˜… â˜… â˜… â˜… â˜… é‡ç‚¹æ–¹æ³• â˜… â˜… â˜… â˜… â˜… â˜… â˜… â˜…         <span class="token comment" spellcheck="true">// å¦‚æœäº‹ä»¶ä¸æ˜¯å–æ¶ˆäº‹ä»¶ï¼Œä¹Ÿæ²¡æœ‰æ‹¦æˆªï¼Œé‚£ä¹ˆè¿›å…¥æ­¤å‡½æ•°</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>canceled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>intercepted<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  View childWithAccessibilityFocus <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">isTargetAccessibilityFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token operator">?</span> <span class="token function">findChildWithAccessibilityFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/*             * å¦‚æœæ˜¯ä¸ªå…¨æ–°çš„ Down äº‹ä»¶ï¼Œæˆ–è€…æ˜¯æœ‰æ–°çš„è§¦æ‘¸ç‚¹ï¼Œæˆ–è€…æ˜¯å…‰æ ‡æ¥å›ç§»åŠ¨äº‹ä»¶             */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_DOWN                    <span class="token operator">||</span> <span class="token punctuation">(</span>split <span class="token operator">&amp;&amp;</span> actionMasked <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_POINTER_DOWN<span class="token punctuation">)</span>                    <span class="token operator">||</span> actionMasked <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_HOVER_MOVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// äº‹ä»¶çš„ç´¢å¼•ï¼ŒDown äº‹ä»¶çš„ indexï¼š0</span>                <span class="token keyword">final</span> <span class="token keyword">int</span> actionIndex <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getActionIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// always 0 for down</span>                <span class="token comment" spellcheck="true">// è·å–åˆ†é…çš„ ID çš„ bit æ•°é‡</span>                <span class="token keyword">final</span> <span class="token keyword">int</span> idBitsToAssign <span class="token operator">=</span> split <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>                        ev<span class="token punctuation">.</span><span class="token function">getPointerId</span><span class="token punctuation">(</span>actionIndex<span class="token punctuation">)</span> <span class="token operator">:</span> TouchTarget<span class="token punctuation">.</span>ALL_POINTER_IDS<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// æ¸…ç†ä¹‹å‰è§¦æ‘¸è¿™ä¸ªæŒ‡é’ˆæ ‡è¯†ï¼Œä»¥é˜²å®ƒä»¬çš„ç›®æ ‡å˜å¾—ä¸åŒæ­¥</span>                <span class="token function">removePointersFromTouchTargets</span><span class="token punctuation">(</span>idBitsToAssign<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">final</span> <span class="token keyword">int</span> childrenCount <span class="token operator">=</span> mChildrenCount<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// å¦‚æœæ–°çš„è§¦æ‘¸å¯¹è±¡ä¸º null &amp; å½“å‰ ViewGroup æœ‰å­å…ƒç´ </span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>newTouchTarget <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> childrenCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">final</span> <span class="token keyword">float</span> x <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span>actionIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">final</span> <span class="token keyword">float</span> y <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span>actionIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>View<span class="token operator">></span> preorderedList                                               <span class="token operator">=</span> <span class="token function">buildTouchDispatchChildList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">final</span> <span class="token keyword">boolean</span> customOrder <span class="token operator">=</span> preorderedList <span class="token operator">==</span> null                            <span class="token operator">&amp;&amp;</span> <span class="token function">isChildrenDrawingOrderEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">final</span> View<span class="token punctuation">[</span><span class="token punctuation">]</span> children <span class="token operator">=</span> mChildren<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// é€šè¿‡ for å¾ªç¯ï¼Œéå†äº†å½“å‰ ViewGroup ä¸‹çš„æ‰€æœ‰å­ View</span>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> childrenCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">final</span> <span class="token keyword">int</span> childIndex <span class="token operator">=</span> <span class="token function">getAndVerifyPreorderedIndex</span><span class="token punctuation">(</span>                                childrenCount<span class="token punctuation">,</span> i<span class="token punctuation">,</span> customOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">final</span> View child <span class="token operator">=</span> <span class="token function">getAndVerifyPreorderedView</span><span class="token punctuation">(</span>                                preorderedList<span class="token punctuation">,</span> children<span class="token punctuation">,</span> childIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>childWithAccessibilityFocus <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>childWithAccessibilityFocus <span class="token operator">!=</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">continue</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                            childWithAccessibilityFocus <span class="token operator">=</span> null<span class="token punctuation">;</span>                            i <span class="token operator">=</span> childrenCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// æ— å…³ç´§è¦çš„ä»£ç æˆ‘ä»¬è¿™è¾¹æš‚ä¸”çœç•¥</span>                        <span class="token comment" spellcheck="true">// æ´¾å‘äº‹ä»¶åˆ°å­ View å¤„ç†</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                             <span class="token comment" spellcheck="true">// Child wants to receive touch within its bounds.</span>                            mLastTouchDownTime <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getDownTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>preorderedList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> childrenCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">[</span>childIndex<span class="token punctuation">]</span> <span class="token operator">==</span> mChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                        mLastTouchDownIndex <span class="token operator">=</span> j<span class="token punctuation">;</span>                                        <span class="token keyword">break</span><span class="token punctuation">;</span>                                    <span class="token punctuation">}</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                mLastTouchDownIndex <span class="token operator">=</span> childIndex<span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                            mLastTouchDownX <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            mLastTouchDownY <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            newTouchTarget <span class="token operator">=</span> <span class="token function">addTouchTarget</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> idBitsToAssign<span class="token punctuation">)</span><span class="token punctuation">;</span>                            alreadyDispatchedToNewTouchTarget <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// å¦‚æœå­ View å¤„ç†äº†äº‹ä»¶ï¼Œåˆ™ breakï¼Œ</span>                            <span class="token comment" spellcheck="true">// ViewGroup ä¸åœ¨å¤„ç†äº‹ä»¶ï¼ˆäº‹ä»¶è¢«æ‹¦æˆªï¼‰ã€‚</span>                            <span class="token keyword">break</span><span class="token punctuation">;</span>                             <span class="token punctuation">}</span>                        ev<span class="token punctuation">.</span><span class="token function">setTargetAccessibilityFocus</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>preorderedList <span class="token operator">!=</span> null<span class="token punctuation">)</span> preorderedList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> handled<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>å…¶å® ViewGroup çš„ dispatchTouchEvent å¤„ç†æµç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸¤ä¸ªé‡ç‚¹æ–¹æ³•ï¼š<code>onInterceptTouchEvent</code> å’Œ <code>dispatchTransformedTouchEvent</code>ã€‚</p><h3 id="4-1-1-onInterceptTouchEvent"><a href="#4-1-1-onInterceptTouchEvent" class="headerlink" title="4.1.1 onInterceptTouchEvent"></a>4.1.1 onInterceptTouchEvent</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>MotionEvent ev<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸€å †åˆ¤æ–­ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ä¸€ç‚¹ï¼Œä¸€èˆ¬ Touch äº‹ä»¶é»˜è®¤è¿”å› false</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span><span class="token function">isFromSource</span><span class="token punctuation">(</span>InputDevice<span class="token punctuation">.</span>SOURCE_MOUSE<span class="token punctuation">)</span>                <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MotionEvent<span class="token punctuation">.</span>ACTION_DOWN                <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span><span class="token function">isButtonPressed</span><span class="token punctuation">(</span>MotionEvent<span class="token punctuation">.</span>BUTTON_PRIMARY<span class="token punctuation">)</span>                <span class="token operator">&amp;&amp;</span> <span class="token function">isOnScrollbarThumb</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ev<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="4-1-2-dispatchTransformedTouchEvent"><a href="#4-1-2-dispatchTransformedTouchEvent" class="headerlink" title="4.1.2 dispatchTransformedTouchEvent"></a>4.1.2 dispatchTransformedTouchEvent</h3><p>dispatchTransformedTouchEvent æ–¹æ³•çš„ä½œç”¨ï¼Œä¸»è¦å°±æ˜¯æŠŠäº‹ä»¶ä¸‹å‘ç»™å­ View è¿›è¡Œå¤„ç†ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>MotionEvent event<span class="token punctuation">,</span>             <span class="token keyword">boolean</span> cancel<span class="token punctuation">,</span> View child<span class="token punctuation">,</span> <span class="token keyword">int</span> desiredPointerIdBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> handled<span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">final</span> MotionEvent transformedEvent<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newPointerIdBits <span class="token operator">==</span> oldPointerIdBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> null <span class="token operator">||</span> child<span class="token punctuation">.</span><span class="token function">hasIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    handled <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token comment" spellcheck="true">// dispatchTouchEvent()</span>                    handled <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>                    event<span class="token punctuation">.</span><span class="token function">offsetLocation</span><span class="token punctuation">(</span><span class="token operator">-</span>offsetX<span class="token punctuation">,</span> <span class="token operator">-</span>offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> handled<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            transformedEvent <span class="token operator">=</span> MotionEvent<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            transformedEvent <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>newPointerIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Perform any necessary transformations and dispatch.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            handled <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>transformedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// dispatchTouchEvent()</span>            handled <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>transformedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// Done.</span>        transformedEvent<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> handled<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Ÿå½“å­˜åœ¨å­ View çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ View.dispatchTouchEvent æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šå‘ä¸Šè°ƒç”¨ super.dispatchTouchEvent æ–¹æ³•ã€‚</p><h2 id="4-2-Demo"><a href="#4-2-Demo" class="headerlink" title="4.2 Demo"></a>4.2 Demo</h2><p><strong>Layout å±‚æ¬¡ï¼š</strong></p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-e7ef15d4b48428d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="layout.png"></center><p><strong>Layout ä»£ç ï¼š</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span>android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>constraint<span class="token punctuation">.</span>ConstraintLayout xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res/android"</span>    xmlns<span class="token operator">:</span>app<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res-auto"</span>    xmlns<span class="token operator">:</span>tools<span class="token operator">=</span><span class="token string">"http://schemas.android.com/tools"</span>    android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/my_layout"</span>    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span>    tools<span class="token operator">:</span>context<span class="token operator">=</span><span class="token string">".MainActivity"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>Button        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/button_01"</span>        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"Button_01"</span>        tools<span class="token operator">:</span>layout_editor_absoluteX<span class="token operator">=</span><span class="token string">"94dp"</span>        tools<span class="token operator">:</span>layout_editor_absoluteY<span class="token operator">=</span><span class="token string">"106dp"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>Button        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/button_02"</span>        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"Button_02"</span>        tools<span class="token operator">:</span>layout_editor_absoluteX<span class="token operator">=</span><span class="token string">"94dp"</span>        tools<span class="token operator">:</span>layout_editor_absoluteY<span class="token operator">=</span><span class="token string">"211dp"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>constraint<span class="token punctuation">.</span>ConstraintLayout<span class="token operator">></span></code></pre><p><strong>Activity ä»£ç ï¼š</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>myapplication<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>constraint<span class="token punctuation">.</span>ConstraintLayout<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Button button_01<span class="token punctuation">;</span>    <span class="token keyword">private</span> Button button_02<span class="token punctuation">;</span>    <span class="token keyword">private</span> ViewGroup myLayout<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        button_01 <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>button_01<span class="token punctuation">)</span><span class="token punctuation">;</span>        button_02 <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>button_02<span class="token punctuation">)</span><span class="token punctuation">;</span>        myLayout <span class="token operator">=</span> <span class="token punctuation">(</span>ConstraintLayout<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>my_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 1. ViewGroup: myLayout å¸ƒå±€è®¾ç½®ç›‘å¬äº‹ä»¶</span>        myLayout<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"ç‚¹å‡»äº†ViewGroup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2. View: button_01 è®¾ç½®ç›‘å¬äº‹ä»¶</span>        button_01<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"ç‚¹å‡»äº†button_01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3. View: button_02è®¾ç½®ç›‘å¬äº‹ä»¶</span>        button_02<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"ç‚¹å‡»äº†button_02"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>æµ‹è¯•ç»“æœï¼š</strong></p><pre class=" language-java"><code class="language-java"><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">51.877</span> <span class="token number">16250</span> <span class="token number">16250</span> D TAG <span class="token operator">:</span> ç‚¹å‡»äº†button_01     <span class="token comment" spellcheck="true">// ç‚¹å‡»æŒ‰é’® button_01</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">53.875</span> <span class="token number">16250</span> <span class="token number">16250</span> D TAG <span class="token operator">:</span> ç‚¹å‡»äº†button_02     <span class="token comment" spellcheck="true">// ç‚¹å‡»æŒ‰é’® button_02</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">54.758</span> <span class="token number">16250</span> <span class="token number">16250</span> D TAG <span class="token operator">:</span> ç‚¹å‡»äº†ViewGroup     <span class="token comment" spellcheck="true">// ç‚¹å‡»ç©ºç™½å¤„</span></code></pre><p><strong>ç»“æœè¯´æ˜ï¼š</strong></p><ul><li>ç‚¹å‡» Button æ—¶ï¼Œæ‰§è¡Œ Button.onClick()ï¼Œä½† ViewGroup_Layout æ³¨å†Œçš„ onClick() ä¸ä¼šæ‰§è¡Œï¼›</li><li>åªæœ‰ç‚¹å‡»ç©ºç™½åŒºåŸŸæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œ ViewGroup_Layout çš„ onClick() æ–¹æ³•ã€‚</li></ul><p><strong>ç»“è®ºï¼š</strong>Button çš„ onClick() å°†äº‹ä»¶æ¶ˆè´¹æ‰äº†ï¼Œå› æ­¤äº‹ä»¶ä¸ä¼šå†ç»§ç»­å‘ä¸‹ä¼ é€’ã€‚</p><h2 id="4-3-å°ç»“"><a href="#4-3-å°ç»“" class="headerlink" title="4.3 å°ç»“"></a>4.3 å°ç»“</h2><center><img src="https://upload-images.jianshu.io/upload_images/3517194-751a10fb6d6dcd5d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ViewGroup äº‹ä»¶åˆ†å‘å¤„ç†æµç¨‹.png"></center><p><br></p><h1 id="5-Touch-äº‹ä»¶åˆ†å‘-â€“-View"><a href="#5-Touch-äº‹ä»¶åˆ†å‘-â€“-View" class="headerlink" title="5. Touch äº‹ä»¶åˆ†å‘ â€“ View"></a>5. Touch äº‹ä»¶åˆ†å‘ â€“ View</h1><p><strong><font color="#ff0000">è¿™è¾¹æˆ‘ä»¬å…ˆåšä¸ªè¯´æ˜ï¼š</font></strong></p><p>å…¶å®ï¼Œåªè¦ä½ è§¦æ‘¸äº†ä»»ä½•æ§ä»¶ï¼Œå°±ä¸€å®šä¼šè°ƒç”¨è¯¥æ§ä»¶çš„ <code>dispatchTouchEvent</code> æ–¹æ³•ï¼</p><p><strong><font color="#ff00ff">ä¸¥æ ¼ä¸€ç‚¹æ¥è¯´ï¼š</font></strong>å½“ä½ ç‚¹å‡»äº†æŸä¸ªæ§ä»¶ï¼Œé¦–å…ˆä¼šå»è°ƒç”¨è¯¥æ§ä»¶æ‰€åœ¨<code>å¸ƒå±€</code>çš„ <code>dispatchTouchEvent</code> æ–¹æ³•ï¼Œç„¶ååœ¨<code>å¸ƒå±€</code>çš„ <code>dispatchTouchEvent</code> æ–¹æ³•ä¸­<code>æ‰¾åˆ°è¢«ç‚¹å‡»çš„ç›¸åº”æ§ä»¶</code>ï¼Œå†å»è°ƒç”¨è¯¥<code>æ§ä»¶</code>çš„ <code>dispatchTouchEvent</code>æ–¹æ³•ã€‚</p><h3 id="3-3-1-dispatchTouchEvent"><a href="#3-3-1-dispatchTouchEvent" class="headerlink" title="3.3.1 dispatchTouchEvent"></a>3.3.1 dispatchTouchEvent</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">onFilterTouchEventForSecurity</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> ENABLED                                           <span class="token operator">&amp;&amp;</span> <span class="token function">handleScrollBarDragging</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//noinspection SimplifiableIfStatement</span>            ListenerInfo li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>            â˜… â˜… â˜… â˜… â˜… â˜… â˜… â˜… é‡ç‚¹æ–¹æ³• â˜… â˜… â˜… â˜… â˜… â˜… â˜… â˜…             <span class="token comment" spellcheck="true">/*             * æ³¨æ„ï¼šåªæœ‰ä»¥ä¸‹3ä¸ªæ¡ä»¶éƒ½ä¸ºçœŸï¼ŒdispatchTouchEvent() æ‰è¿”å› true             *       1. li != null &amp; li.mOnTouchListener != null             *       2. (mViewFlags &amp; ENABLED_MASK) == ENABLED             *       3. mListenerInfo.mOnTouchListener.onTouch(this, event)             */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener <span class="token operator">!=</span> null                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> ENABLED                    <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener<span class="token punctuation">.</span><span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            â˜… â˜… â˜… â˜… â˜… â˜… â˜… â˜… åˆ†åˆ«åˆ†æä»¥ä¸Šå‡ ä¸ªæ¡ä»¶ â˜… â˜… â˜… â˜… â˜… â˜… â˜… â˜…             <span class="token comment" spellcheck="true">// å¦‚æœä¸Šé¢æ²¡æœ‰è¿”å› trueï¼Œé‚£ä¹ˆæ‰§è¡Œ onTouchEvent()</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result <span class="token operator">&amp;&amp;</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ä¸‹é¢å†åˆ†æ</span>                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><blockquote><p><strong><font color="0000FF">æ¡ä»¶ 1ï¼šli != null &amp; li.mOnTouchListener != null</font></strong></p></blockquote><p>mOnTouchListener è¿™ä¸ªå˜é‡æ˜¯åœ¨å“ªé‡Œèµ‹å€¼çš„å‘¢ï¼Ÿ</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**      * æ¡ä»¶ 1ï¼šmListenerInfo.mOnTouchListener != null      * è¯´æ˜ï¼šmOnTouchListener å˜é‡åœ¨ View.setOnTouchListener() æ–¹æ³•é‡Œèµ‹å€¼      */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOnTouchListener</span><span class="token punctuation">(</span>OnTouchListener l<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åªè¦æˆ‘ä»¬ç»™æ§ä»¶æ³¨å†Œäº† Touch äº‹ä»¶ï¼ŒmOnTouchListener å°±ä¸€å®šè¢«èµ‹å€¼ï¼ˆä¸ä¸ºç©ºï¼‰</span>        <span class="token function">getListenerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mOnTouchListener <span class="token operator">=</span> l<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><blockquote><p><strong><font color="0000FF">æ¡ä»¶ 2ï¼š(mViewFlags &amp; ENABLED_MASK) == ENABLED</font></strong></p></blockquote><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**      * æ¡ä»¶ 2ï¼š(mViewFlags &amp; ENABLED_MASK) == ENABLED      * è¯´æ˜ï¼š      *     a. è¯¥æ¡ä»¶æ˜¯åˆ¤æ–­å½“å‰ç‚¹å‡»çš„æ§ä»¶æ˜¯å¦ enable      *     b. ä¸€èˆ¬ View é»˜è®¤ enableï¼Œæ•…è¯¥æ¡ä»¶æ’å®šä¸º true      */</span></code></pre><blockquote><p><strong><font color="0000FF">æ¡ä»¶ 3ï¼šmListenerInfo.mOnTouchListener.onTouch(this, event)</font></strong></p></blockquote><p>mListenerInfo.mOnTouchListener.onTouch(this, event)ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å»å›è°ƒæ§ä»¶æ³¨å†Œ touch äº‹ä»¶æ—¶çš„ onTouch æ–¹æ³•ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬åœ¨ onTouch æ–¹æ³•é‡Œè¿”å› trueï¼Œå°±ä¼šè®©è¿™ä¸‰ä¸ªæ¡ä»¶å…¨éƒ¨æˆç«‹ï¼Œä»è€Œæ•´ä¸ªæ–¹æ³•ç›´æ¥è¿”å› trueã€‚å¦‚æœæˆ‘ä»¬åœ¨ onTouch æ–¹æ³•é‡Œè¿”å› falseï¼Œå°±ä¼šå†å»æ‰§è¡Œ onTouchEvent(event) æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**      * æ¡ä»¶ 3ï¼šmOnTouchListener.onTouch(this, event)      * è¯´æ˜ï¼šå›è°ƒæ§ä»¶æ³¨å†Œ Touch äº‹ä»¶æ—¶çš„ onTouch()      */</span>    button<span class="token punctuation">.</span><span class="token function">setOnTouchListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OnTouchListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>View v<span class="token punctuation">,</span> MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="3-3-2-onTouchEvent"><a href="#3-3-2-onTouchEvent" class="headerlink" title="3.3.2 onTouchEvent"></a>3.3.2 onTouchEvent</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">float</span> x <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">float</span> y <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> viewFlags <span class="token operator">=</span> mViewFlags<span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> action <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> clickable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> CLICKABLE                <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> LONG_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> LONG_CLICKABLE<span class="token punctuation">)</span>                <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> CONTEXT_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> CONTEXT_CLICKABLE<span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">// è‹¥è¯¥æ§ä»¶å¯ç‚¹å‡»ï¼Œåˆ™è¿›å…¥ switch åˆ¤æ–­ä¸­</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>clickable <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> TOOLTIP<span class="token punctuation">)</span> <span class="token operator">==</span> TOOLTIP<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// a. è‹¥å½“å‰çš„äº‹ä»¶ = æŠ¬èµ· View</span>                <span class="token keyword">case</span> MotionEvent<span class="token punctuation">.</span>ACTION_UP<span class="token operator">:</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token keyword">boolean</span> prepressed <span class="token operator">=</span> <span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PREPRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> prepressed<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasPerformedLongPress <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIgnoreNextUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// This is a tap, so remove the longpress check</span>                            <span class="token function">removeLongPressCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focusTaken<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPerformClick <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    mPerformClick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">}</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">post</span><span class="token punctuation">(</span>mPerformClick<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// é‡ç‚¹åˆ†æå‡½æ•°</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// b. è‹¥å½“å‰çš„äº‹ä»¶ = æŒ‰ä¸‹ View</span>                <span class="token keyword">case</span> MotionEvent<span class="token punctuation">.</span>ACTION_DOWN<span class="token operator">:</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// c. è‹¥å½“å‰çš„äº‹ä»¶ = ç»“æŸäº‹ä»¶ï¼ˆéäººä¸ºåŸå› ï¼‰</span>                <span class="token keyword">case</span> MotionEvent<span class="token punctuation">.</span>ACTION_CANCEL<span class="token operator">:</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// d. è‹¥å½“å‰çš„äº‹ä»¶ = æ»‘åŠ¨ View</span>                <span class="token keyword">case</span> MotionEvent<span class="token punctuation">.</span>ACTION_MOVE<span class="token operator">:</span>                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// è‹¥è¯¥æ§ä»¶å¯ç‚¹å‡»ï¼Œå°±ä¸€å®šè¿”å›true</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è‹¥è¯¥æ§ä»¶ä¸å¯ç‚¹å‡»ï¼Œå°±ä¸€å®šè¿”å›false</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="3-3-3-performClick"><a href="#3-3-3-performClick" class="headerlink" title="3.3.3 performClick"></a>3.3.3 performClick</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>        <span class="token keyword">final</span> ListenerInfo li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*         * åªè¦æˆ‘ä»¬é€šè¿‡ setOnClickListener() ä¸ºæ§ä»¶ View æ³¨å†Œ1ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œ         * é‚£ä¹ˆå°±ä¼šç»™ li.mOnClickListener å˜é‡èµ‹å€¼ï¼ˆå³ä¸ä¸ºç©ºï¼‰ï¼Œ         * åˆ™ä¼šå¾€ä¸‹å›è°ƒ onClick()ï¼ŒperformClick() è¿”å› trueã€‚         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnClickListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">playSoundEffect</span><span class="token punctuation">(</span>SoundEffectConstants<span class="token punctuation">.</span>CLICK<span class="token punctuation">)</span><span class="token punctuation">;</span>            li<span class="token punctuation">.</span>mOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span>AccessibilityEvent<span class="token punctuation">.</span>TYPE_VIEW_CLICKED<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">notifyEnterOrExitForAutoFillIfNeeded</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="3-3-4-Demo"><a href="#3-3-4-Demo" class="headerlink" title="3.3.4 Demo"></a>3.3.4 Demo</h2><p><strong>Layoutä»£ç ï¼š</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span>LinearLayout xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res/android"</span>    xmlns<span class="token operator">:</span>app<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res-auto"</span>    xmlns<span class="token operator">:</span>tools<span class="token operator">=</span><span class="token string">"http://schemas.android.com/tools"</span>    android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/my_layout"</span>    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span>    android<span class="token operator">:</span>orientation<span class="token operator">=</span><span class="token string">"vertical"</span>    tools<span class="token operator">:</span>context<span class="token operator">=</span><span class="token string">".MainActivity"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>Button        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/button_01"</span>        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"Button_01"</span>        tools<span class="token operator">:</span>layout_editor_absoluteX<span class="token operator">=</span><span class="token string">"94dp"</span>        tools<span class="token operator">:</span>layout_editor_absoluteY<span class="token operator">=</span><span class="token string">"106dp"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>LinearLayout<span class="token operator">></span></code></pre><p><strong>Activityä»£ç ï¼š</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>myapplication<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>constraint<span class="token punctuation">.</span>ConstraintLayout<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>MotionEvent<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>LinearLayout<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Button button_01<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        button_01 <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>button_01<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**          * ç»“è®ºéªŒè¯1ï¼šåœ¨å›è°ƒ onTouch() é‡Œè¿”å› false        */</span>        <span class="token comment" spellcheck="true">// 1. é€šè¿‡ OnTouchListener() å¤å†™ onTouch()ï¼Œä»è€Œæ‰‹åŠ¨è®¾ç½®è¿”å› false</span>        button_01<span class="token punctuation">.</span><span class="token function">setOnTouchListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnTouchListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>View v<span class="token punctuation">,</span> MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"run onTouch(), action:"</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2. é€šè¿‡ OnClickListenerï¼ˆï¼‰ä¸ºæ§ä»¶è®¾ç½®ç‚¹å‡»äº‹ä»¶ï¼Œ</span>        <span class="token comment" spellcheck="true">//    ä¸º mOnClickListener å˜é‡èµ‹å€¼ï¼ˆå³ä¸ä¸ºç©ºï¼‰ï¼Œä»è€Œå¾€ä¸‹å›è°ƒ onClickï¼ˆï¼‰</span>        button_01<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"run onClick()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**          * ç»“è®ºéªŒè¯2ï¼šåœ¨å›è°ƒ onTouch() é‡Œè¿”å› true          */</span>        <span class="token comment" spellcheck="true">// 1. é€šè¿‡ OnTouchListener()å¤å†™ onTouch()ï¼Œä»è€Œæ‰‹åŠ¨è®¾ç½®è¿”å› true</span>        button_01<span class="token punctuation">.</span><span class="token function">setOnTouchListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnTouchListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>View v<span class="token punctuation">,</span> MotionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"run onTouch(), action:"</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2. é€šè¿‡ OnClickListenerï¼ˆï¼‰ä¸ºæ§ä»¶è®¾ç½®ç‚¹å‡»äº‹ä»¶ï¼Œ</span>        <span class="token comment" spellcheck="true">//    ä¸º mOnClickListener å˜é‡èµ‹å€¼ï¼ˆå³ä¸ä¸ºç©ºï¼‰ï¼Œä»è€Œå¾€ä¸‹å›è°ƒ onClickï¼ˆï¼‰</span>        button_01<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"run onClick()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>æµ‹è¯•ç»“æœï¼š</strong></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// é€šè¿‡ OnTouchListener() å¤å†™ onTouch()ï¼Œä»è€Œæ‰‹åŠ¨è®¾ç½®è¿”å› false</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">19.299</span> <span class="token number">23350</span> <span class="token number">23350</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">0</span>    <span class="token comment" spellcheck="true">// ACTION_DOWN</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">19.327</span> <span class="token number">23350</span> <span class="token number">23350</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">2</span>    <span class="token comment" spellcheck="true">// ACTION_MOVE</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">19.343</span> <span class="token number">23350</span> <span class="token number">23350</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">2</span>    <span class="token comment" spellcheck="true">// ACTION_MOVE</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">19.383</span> <span class="token number">23350</span> <span class="token number">23350</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">2</span>    <span class="token comment" spellcheck="true">// ACTION_MOVE</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">19.384</span> <span class="token number">23350</span> <span class="token number">23350</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">1</span>    <span class="token comment" spellcheck="true">// ACTION_UP</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">19.385</span> <span class="token number">23350</span> <span class="token number">23350</span> D TAG <span class="token operator">:</span> run <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// é€šè¿‡ OnTouchListener() å¤å†™ onTouch()ï¼Œä»è€Œæ‰‹åŠ¨è®¾ç½®è¿”å› true</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">29.758</span> <span class="token number">23847</span> <span class="token number">23847</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">0</span>    <span class="token comment" spellcheck="true">// ACTION_DOWN</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">29.773</span> <span class="token number">23847</span> <span class="token number">23847</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">2</span>    <span class="token comment" spellcheck="true">// ACTION_MOVE</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">29.856</span> <span class="token number">23847</span> <span class="token number">23847</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">2</span>    <span class="token comment" spellcheck="true">// ACTION_MOVE</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">29.858</span> <span class="token number">23847</span> <span class="token number">23847</span> D TAG <span class="token operator">:</span> run <span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token operator">:</span><span class="token number">1</span>    <span class="token comment" spellcheck="true">// ACTION_UP</span></code></pre><h2 id="3-3-5-å°ç»“"><a href="#3-3-5-å°ç»“" class="headerlink" title="3.3.5 å°ç»“"></a>3.3.5 å°ç»“</h2><center><img src="https://upload-images.jianshu.io/upload_images/3517194-812be931bd432a26.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="View äº‹ä»¶åˆ†å‘æœºåˆ¶æµç¨‹å›¾.png"></center><p><br></p><h1 id="6-æ€»ç»“"><a href="#6-æ€»ç»“" class="headerlink" title="6. æ€»ç»“"></a>6. æ€»ç»“</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;1ã€Android äº‹ä»¶åˆ†å‘æœºåˆ¶ä¸»è¦ç”±ã€â€œäº‹ä»¶åˆ†å‘â€ â€”&gt; â€œäº‹ä»¶æ‹¦æˆªâ€ â€”&gt; â€œäº‹ä»¶å“åº”â€ã€‘è¿™ä¸‰æ­¥æ¥è¿›è¡Œé€»è¾‘æ§åˆ¶çš„ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;2ã€ViewGroup é»˜è®¤ä¸æ‹¦æˆªä»»ä½•äº‹ä»¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;3ã€onInterceptTouchEvent è¿”å› true è¡¨ç¤ºäº‹ä»¶æ‹¦æˆªï¼ŒonTouchEvent è¿”å› true è¡¨ç¤ºäº‹ä»¶æ¶ˆè´¹ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;4ã€ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘è¿‡ç¨‹å¦‚ä¸‹ï¼šdispatchTouchEvent â€”&gt; onTouchListener çš„ OnTouch æ–¹æ³• â€”&gt; onTouchEvent â€”&gt; onClickListener çš„ onClick æ–¹æ³•ã€‚ä»è€Œä¹Ÿå¯ä»¥çœ‹å‡º onTouch æ˜¯ä¼˜å…ˆäº onClick æ‰§è¡Œï¼Œäº‹ä»¶ä¼ é€’çš„é¡ºåºæ˜¯å…ˆç»è¿‡ onTouchï¼Œå†ä¼ é€’åˆ° onClickã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;5ã€Android ä¸­çš„äº‹ä»¶ onClickã€onLongClickã€onScroll ç­‰ï¼Œéƒ½æ˜¯ç”±å¤šä¸ª Touch äº‹ä»¶ï¼ˆä¸€ä¸ª ACTION_DOWNï¼Œå¤šä¸ª ACTION_MOVEï¼Œä¸€ä¸ª ACTION_UPï¼‰ç»„æˆã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;6ã€å­ View å¯ä»¥é€šè¿‡ä½¿ç”¨ getParent().requestDisallowInterceptTouchEvent(true) ï¼Œé˜»æ­¢ ViewGroup å¯¹å…¶ MOVE æˆ– UP äº‹ä»¶è¿›è¡Œæ‹¦æˆªã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;7ã€MotionEvent å¯¹è±¡çš„å››ç§çŠ¶æ€ï¼šMotionEvent.ACTION_DOWNï¼šæ‰‹æŒ‡æŒ‰ä¸‹å±å¹•çš„ç¬é—´</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MotionEvent.ACTION_MOVEï¼šæ‰‹æŒ‡åœ¨å±å¹•ä¸Šç§»åŠ¨</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MotionEvent.ACTION_UPï¼šæ‰‹æŒ‡ç¦»å¼€å±å¹•ç¬é—´</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MotionEvent.ACTION_CANCELï¼šå–æ¶ˆæ‰‹åŠ¿</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;8ã€ç‚¹å‡»æŸä¸ªæ§ä»¶ï¼Œé¦–å…ˆä¼šå»è°ƒç”¨è¯¥æ§ä»¶æ‰€åœ¨å¸ƒå±€çš„ dispatchTouchEvent æ–¹æ³•ï¼Œç„¶ååœ¨å¸ƒå±€çš„ dispatchTouchEvent æ–¹æ³•ä¸­æ‰¾åˆ°è¢«ç‚¹å‡»çš„ç›¸åº”æ§ä»¶ï¼Œå†å»è°ƒç”¨è¯¥æ§ä»¶çš„ dispatchTouchEventæ–¹æ³•ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;9ã€å¦‚æœ View æ²¡æœ‰æ¶ˆè´¹ ACTION_DOWN äº‹ä»¶ï¼Œåˆ™ä¹‹åçš„ ACTION_MOVE ç­‰äº‹ä»¶éƒ½ä¸ä¼šå†æ¥æ”¶ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; âœ’&nbsp;10ã€äº‹ä»¶åœ¨ä» Activity.dispatchTouchEvent å¾€ä¸‹åˆ†å‘çš„è¿‡ç¨‹ä¸­ï¼š</p><blockquote><p>å¦‚æœä¸­é—´çš„ ViewGroup éƒ½ä¸æ‹¦æˆªï¼Œè¿›å…¥æœ€åº•å±‚çš„ View åï¼Œç”± View.onTouchEvent å¤„ç†ï¼Œå¦‚æœ View ä¹Ÿæ²¡æœ‰æ¶ˆè´¹äº‹ä»¶ï¼Œæœ€åä¼šè¿”å›åˆ° Activity.onTouchEventã€‚<br>å¦‚æœä¸­é—´ä»»ä½•ä¸€å±‚ ViewGroup æ‹¦æˆªäº‹ä»¶ï¼Œåˆ™äº‹ä»¶ä¸å†å¾€ä¸‹åˆ†å‘ï¼Œäº¤ç”±æ‹¦æˆªçš„ ViewGroup çš„ onTouchEvent æ¥å¤„ç†ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> æ ¸å¿ƒæœºåˆ¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äº‹ä»¶åˆ†å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Handlerï¼ˆåŸç†ç¯‡ï¼‰</title>
      <link href="/2018/09/13/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-handler-yuan-li-pian/"/>
      <url>/2018/09/13/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-handler-yuan-li-pian/</url>
      
        <content type="html"><![CDATA[<h1 id="1-å¼€ç¯‡"><a href="#1-å¼€ç¯‡" class="headerlink" title="1. å¼€ç¯‡"></a>1. å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">Looper.java</font></td><td>frameworks/base/core/java/android/os/Looper.java</td></tr><tr><td><font color="#D15FEE">Message.java</font></td><td>frameworks/base/core/java/android/os/Message.java</td></tr><tr><td><font color="#D15FEE">MessageQueue.java</font></td><td>frameworks/base/core/java/android/os/MessageQueue.java</td></tr></tbody></table><h2 id="1-2-ç®€è¿°"><a href="#1-2-ç®€è¿°" class="headerlink" title="1.2 ç®€è¿°"></a>1.2 ç®€è¿°</h2><p>åœ¨æ•´ä¸ª Android çš„æºç ä¸–ç•Œé‡Œï¼Œæœ‰ä¸¤å¤§åˆ©å‰‘ï¼Œå…¶ä¸€æ˜¯ Binder æœºåˆ¶ï¼Œå¦ä¸€ä¸ªä¾¿æ˜¯ Handler æ¶ˆæ¯æœºåˆ¶ã€‚æ¶ˆæ¯æœºåˆ¶æ¶‰åŠ <strong><font color="#FF0000">MessageQueueã€Messageã€Looperã€Handler è¿™4ä¸ªç±»</font></strong>ã€‚</p><p>Handler æ˜¯ Android ä¸­å¼•å…¥çš„ä¸€ç§è®©å¼€å‘è€…å‚ä¸å¤„ç†çº¿ç¨‹ä¸­æ¶ˆæ¯å¾ªç¯çš„æœºåˆ¶ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨ Handler çš„æ—¶å€™ä¸ Message æ‰“äº¤é“æœ€å¤šï¼ŒMessage æ˜¯ Hanlder æœºåˆ¶å‘å¼€å‘äººå‘˜æš´éœ²å‡ºæ¥çš„ç›¸å…³ç±»ï¼Œå¯ä»¥é€šè¿‡ Message ç±»å®Œæˆå¤§éƒ¨åˆ†æ“ä½œ Handler çš„åŠŸèƒ½ã€‚</p><p>ä½œä¸ºä¸€åç¨‹åºå‘˜ï¼Œæˆ‘ä»¬ä¸ä»…éœ€è¦çŸ¥é“ <a href="https://superandroid.pro/2018/09/10/03.%20Android%20%E6%9C%BA%E5%88%B6%E7%AF%87%20--%2003.%20%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90%20Handler%20%E6%9C%BA%E5%88%B6%EF%BC%88%E7%94%A8%E6%B3%95%E7%AF%87%EF%BC%89/">Handler æ€ä¹ˆç”¨</a>ï¼Œè¿˜è¦çŸ¥é“å…¶å†…éƒ¨å¦‚ä½•å®ç°çš„ï¼Œè¿™å°±æ˜¯æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„ç›®çš„ã€‚</p><h2 id="1-3-æ¨¡å‹"><a href="#1-3-æ¨¡å‹" class="headerlink" title="1.3 æ¨¡å‹"></a>1.3 æ¨¡å‹</h2><p><strong>æ¶ˆæ¯æœºåˆ¶ï¼ˆHandlerï¼‰ä¸»è¦åŒ…å«ï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#3A5FCD">Message</font></strong>ï¼šæ¶ˆæ¯åˆ†ä¸ºç¡¬ä»¶äº§ç”Ÿçš„æ¶ˆæ¯ï¼ˆå¦‚æŒ‰é’®ã€è§¦æ‘¸ï¼‰å’Œè½¯ä»¶ç”Ÿæˆçš„æ¶ˆæ¯ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#3A5FCD">MessageQueue</font></strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»è¦åŠŸèƒ½å‘æ¶ˆæ¯æ± æŠ•é€’æ¶ˆæ¯ï¼ˆMessageQueue.enqueueMessageï¼‰å’Œå–èµ°æ¶ˆæ¯æ± çš„æ¶ˆæ¯ï¼ˆMessageQueue.nextï¼‰ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#3A5FCD">Handler</font></strong>ï¼šæ¶ˆæ¯è¾…åŠ©ç±»ï¼Œä¸»è¦åŠŸèƒ½å‘æ¶ˆæ¯æ± å‘é€å„ç§æ¶ˆæ¯äº‹ä»¶ï¼ˆHandler.sendMessageï¼‰å’Œå¤„ç†ç›¸åº”æ¶ˆæ¯äº‹ä»¶ï¼ˆHandler.handleMessageï¼‰ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#3A5FCD">Looper</font></strong>ï¼šä¸æ–­å¾ªç¯æ‰§è¡Œï¼ˆLooper.loopï¼‰ï¼ŒæŒ‰åˆ†å‘æœºåˆ¶å°†æ¶ˆæ¯åˆ†å‘ç»™ç›®æ ‡å¤„ç†è€…ã€‚</p><h2 id="1-4-ç”¨æ³•"><a href="#1-4-ç”¨æ³•" class="headerlink" title="1.4 ç”¨æ³•"></a>1.4 ç”¨æ³•</h2><p>Looper æºç æœ€ä¸Šé¢çš„æ³¨é‡Šé‡Œæœ‰ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹å‡º Looper çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/* * A typical example of the implementation of a Looper thread, * using the separation of {@link #prepare} and {@link #loop} to create an * initial Handler to communicate with the Looper. */</span><span class="token keyword">class</span> <span class="token class-name">LooperThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Handler mHandler<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// å…ˆåˆå§‹åŒ– Looper               </span>        mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">// åˆ›å»º Handler</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// process incoming messages here</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment" spellcheck="true">// å¯ç”¨ Looper çš„ loop æ–¹æ³•å¼€å¯æ¶ˆæ¯è½®è¯¢</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å›´ç»•è¿™ä¸ªå®ä¾‹å±•å¼€è®²è§£ï¼</p><h1 id="2-Looper"><a href="#2-Looper" class="headerlink" title="2. Looper"></a>2. Looper</h1><p>æ¶ˆæ¯é˜Ÿåˆ— MessageQueue åªæ˜¯å­˜å‚¨ Message çš„åœ°æ–¹ï¼ŒçœŸæ­£è®©æ¶ˆæ¯é˜Ÿåˆ—å¾ªç¯èµ·æ¥çš„æ˜¯ Looperï¼Œæˆ‘ä»¬å…ˆæ¥é‡ç‚¹åˆ†æ Looperã€‚</p><p>Looper æ˜¯ç”¨æ¥ä½¿çº¿ç¨‹ä¸­çš„æ¶ˆæ¯å¾ªç¯èµ·æ¥çš„ã€‚é»˜è®¤æƒ…å†µä¸‹å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹é‡Œé¢æ˜¯æ²¡æœ‰æ¶ˆæ¯é˜Ÿåˆ— MessageQueue çš„ã€‚ä¸ºäº†èƒ½å¤Ÿè®©çº¿ç¨‹èƒ½å¤Ÿç»‘å®šä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©äº Looper ï¼š<font color="#3A5FCD">é¦–å…ˆæˆ‘ä»¬è¦è°ƒç”¨ Looper çš„ prepare() æ–¹æ³•ï¼Œç„¶åè°ƒç”¨ Looper çš„ Loop() æ–¹æ³•ã€‚</font></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ Looper.prepare() å’Œ Looper.loop() éƒ½æ˜¯åœ¨æ–°çº¿ç¨‹çš„ run æ–¹æ³•å†…è°ƒç”¨çš„ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>     <span class="token operator">--</span><span class="token operator">></span>     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h2 id="2-1-prepare"><a href="#2-1-prepare" class="headerlink" title="2.1 prepare()"></a>2.1 prepare()</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Looper.prepare()ï¼Œè¯¥æ–¹æ³•æ˜¯è®© Looper åšå¥½å‡†å¤‡ï¼Œåªæœ‰ Looper å‡†å¤‡å¥½äº†ä¹‹åæ‰èƒ½è°ƒç”¨ Looper.loop() æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// sThreadLocal.get() will return null unless you've called prepare().</span>    <span class="token comment" spellcheck="true">// æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ª ThreadLocal ç”¨æ¥ä¿å­˜ Looper å¯¹è±¡ï¼ˆé‡Œé¢åŒ…å«äº†ä¸»çº¿ç¨‹å’Œ MessageQueueï¼‰</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal<span class="token operator">&lt;</span>Looper<span class="token operator">></span> sThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>Looper<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä¸»çº¿ç¨‹çš„ Looper</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Looper sMainLooper<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// guarded by Looper.class</span>    <span class="token comment" spellcheck="true">// ä¿å­˜æ¶ˆæ¯é˜Ÿåˆ—</span>    <span class="token keyword">final</span> MessageQueue mQueue<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä¿å­˜ä¸»çº¿ç¨‹</span>    <span class="token keyword">final</span> Thread mThread<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ— å‚ï¼Œè°ƒç”¨ prepare(boolean quitAllowed)ï¼Œä¸ºå½“å‰çº¿ç¨‹åˆ›å»º Looper</span>        <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ª Looperï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Only one Looper may be created per thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// åˆ›å»º Looper å¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ°å½“å‰çº¿ç¨‹çš„æœ¬åœ°å­˜å‚¨åŒº</span>        sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ— MessageQueue </span>        mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>        mThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>å¯ä»¥çœ‹å‡ºåœ¨ prepare æ–¹æ³•ä¸­é¦–å…ˆé€šè¿‡ sThreadLocal.get() æ‹¿åˆ°çº¿ç¨‹ sThreadLocal æ‰€ç»‘å®šçš„ Looper å¯¹è±¡ï¼Œç”±äºåˆå§‹æƒ…å†µä¸‹ sThreadLocal å¹¶æ²¡æœ‰ç»‘å®š Looper ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨ prepare æ–¹æ³•æ—¶ï¼ŒsThreadLocal.get() è¿”å› nullï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><h2 id="2-2-prepareMainLooper"><a href="#2-2-prepareMainLooper" class="headerlink" title="2.2 prepareMainLooper()"></a>2.2 prepareMainLooper()</h2><p>å¦å¤–ï¼Œä¸ prepare() ç›¸è¿‘åŠŸèƒ½çš„ï¼Œè¿˜æœ‰ä¸€ä¸ª prepareMainLooper() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦åœ¨ ActivityThread ç±»ä¸­ä½¿ç”¨ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„ Looper</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è®¾ç½®ä¸å…è®¸é€€å‡ºçš„ Looper</span>        <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å°†å½“å‰çš„ Looper ä¿å­˜ä¸ºä¸» Looperï¼Œæ¯ä¸ªçº¿ç¨‹åªå…è®¸æ‰§è¡Œä¸€æ¬¡</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainLooper <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"The main Looper has already been prepared."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            sMainLooper <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// è·å–ä¸»çº¿ç¨‹çš„ Looper</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Looper <span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> sMainLooper<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h2 id="2-3-ThreadLocal"><a href="#2-3-ThreadLocal" class="headerlink" title="2.3 ThreadLocal"></a>2.3 ThreadLocal</h2><p><strong>ThreadLocal</strong>ï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨åŒºï¼ˆThread Local Storageï¼Œç®€ç§°ä¸º TLSï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç§æœ‰çš„æœ¬åœ°å­˜å‚¨åŒºåŸŸï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´å½¼æ­¤ä¸èƒ½è®¿é—®å¯¹æ–¹çš„ TLS åŒºåŸŸã€‚</p><p>æˆ‘ä»¬ç®€å•äº†è§£ä¸€ä¸‹ TLS å¸¸ç”¨çš„æ“ä½œæ–¹æ³•ï¼š</p><h3 id="2-3-1-set"><a href="#2-3-1-set" class="headerlink" title="2.3.1 set()"></a>2.3.1 set()</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// sThreadLocal.set(new Looper(quitAllowed));   </span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è·å–å½“å‰çº¿ç¨‹ </span>        ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// æŸ¥æ‰¾å½“å‰çº¿ç¨‹çš„æœ¬åœ°å‚¨å­˜åŒº</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span>            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// ä¿å­˜æ•°æ® value åˆ°å½“å‰çº¿ç¨‹ this</span>        <span class="token keyword">else</span>            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬çœ‹ä¸‹ getMap() å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    ThreadLocalMap <span class="token function">getMap</span><span class="token punctuation">(</span>Thread t<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>åˆ¤æ–­ map æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™åˆ›å»º ThreadLocalMap ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span>Thread t<span class="token punctuation">,</span> T firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>        t<span class="token punctuation">.</span>threadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="2-3-2-get"><a href="#2-3-2-get" class="headerlink" title="2.3.2 get()"></a>2.3.2 get()</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// if (sThreadLocal.get() != null) {</span>    <span class="token keyword">public</span> T <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è·å–å½“å‰çº¿ç¨‹ </span>        ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// æŸ¥æ‰¾å½“å‰çº¿ç¨‹çš„æœ¬åœ°å‚¨å­˜åŒº</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            ThreadLocalMap<span class="token punctuation">.</span>Entry e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>                T result <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>                <span class="token keyword">return</span> result<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// åˆ›å»º ThreadLocalMap</span>    <span class="token punctuation">}</span></code></pre><p>æŸ¥çœ‹ setInitialValue() ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> T <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        T value <span class="token operator">=</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span>            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> value<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>Looper é€šè¿‡å¦‚ä¸‹ä»£ç ä¿å­˜äº†å¯¹å½“å‰çº¿ç¨‹çš„å¼•ç”¨ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal<span class="token operator">&lt;</span>Looper<span class="token operator">></span> sThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>Looper<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// sThreadLocal ä¸º ThreadLocal ç±»å‹</span></code></pre><p>æ‰€ä»¥åœ¨ Looper å¯¹è±¡ä¸­é€šè¿‡ sThreadLocal å°±å¯ä»¥æ‰¾åˆ°å…¶ç»‘å®šçš„çº¿ç¨‹ã€‚ThreadLocal å¯ä»¥é€šè¿‡ set() å‘ ThreadLocal ä¸­å­˜å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå¯ä»¥é€šè¿‡ get() å–å‡ºå­˜å…¥çš„å¯¹è±¡ã€‚</p><p>ThreadLocal åœ¨ new çš„æ—¶å€™ä½¿ç”¨äº†æ³›å‹ï¼Œä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­¤å¤„çš„æ³›å‹ç±»å‹æ˜¯ Looper ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šè¿‡ ThreadLocal çš„ set() å’Œ get() æ–¹æ³•åªèƒ½å†™å…¥å’Œè¯»å– Looper å¯¹è±¡ç±»å‹ã€‚</p><h2 id="2-4-æ„é€ å‡½æ•°"><a href="#2-4-æ„é€ å‡½æ•°" class="headerlink" title="2.4 æ„é€ å‡½æ•°"></a>2.4 æ„é€ å‡½æ•°</h2><p>æˆ‘ä»¬å‘ç°æºç ä¸­ Looper çš„æ„é€ å‡½æ•°æ˜¯ privateï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šåœ¨è¯¥ç±»çš„å¤–éƒ¨æˆ‘ä»¬æ˜¯ä¸èƒ½ç”¨ new Looper() çš„å½¢å¼å¾—åˆ°ä¸€ä¸ª Looper å¯¹è±¡ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬çœ‹ä¸‹ä¸Šé¢ä»£ç ä¸­ new Looper() åˆ›å»º Looper å¯¹è±¡çš„å·¥ä½œï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// åˆ›å»º MessageQueue å¯¹è±¡</span>    mThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è®°å½•å½“å‰çº¿ç¨‹</span><span class="token punctuation">}</span></code></pre><p>Looper.prepare()åœ¨æ¯ä¸ªçº¿ç¨‹åªå…è®¸æ‰§è¡Œä¸€æ¬¡ï¼Œè¯¥æ–¹æ³•ä¼šåˆ›å»º Looper å¯¹è±¡ï¼ŒLooper çš„æ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºä¸€ä¸ª MessageQueue å¯¹è±¡ï¼Œå†å°† Looper å¯¹è±¡ä¿å­˜åˆ°å½“å‰çº¿ç¨‹ TLSã€‚</p><h2 id="2-5-loop"><a href="#2-5-loop" class="headerlink" title="2.5 loop()"></a>2.5 loop()</h2><p>è®¨è®ºå®Œ Looper.prepare() åï¼Œæˆ‘ä»¬çœ‹ä¸‹ Looper.loop()çš„ä»£ç :</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Run the message queue in this thread. Be sure to call     * {@link #quit()} to end the loop.     */</span>    <span class="token comment" spellcheck="true">// åœ¨å½“å‰çº¿ç¨‹ä¸­å¼€å¯è½®è¯¢</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä» ThreadLocal ä¸­å–å‡ºå½“å‰çº¿ç¨‹çš„ Looper å¯¹è±¡</span>        <span class="token keyword">final</span> Looper me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No Looper; Looper.prepare() wasn't called on this thread."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// è·å– Looper å¯¹è±¡ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—</span>        <span class="token keyword">final</span> MessageQueue queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Make sure the identity of this thread is that of the local process,</span>        <span class="token comment" spellcheck="true">// and keep track of what that identity token actually is.</span>        Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ç¡®ä¿åœ¨æƒé™æ£€æŸ¥æ—¶åŸºäºæœ¬åœ°è¿›ç¨‹ï¼Œè€Œä¸æ˜¯åŸºäºæœ€åˆè°ƒç”¨è¿›ç¨‹</span>        <span class="token keyword">final</span> <span class="token keyword">long</span> ident <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è¿›å…¥ loop çš„ä¸»å¾ªç¯æ–¹æ³•</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// æ­»å¾ªç¯</span>            Message msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// might block(å¯èƒ½ä¼šå µå¡)</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">// æ²¡æœ‰æ¶ˆæ¯ï¼Œåˆ™é€€å‡ºå¾ªç¯</span>                <span class="token comment" spellcheck="true">// No message indicates that the message queue is quitting.</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token keyword">final</span> <span class="token keyword">long</span> dispatchStart <span class="token operator">=</span> needStartTime <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">final</span> <span class="token keyword">long</span> dispatchEnd<span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å–å‡ºæ¶ˆæ¯çš„ target (ä¹Ÿå°±æ˜¯ Handler)ï¼Œæ‰§è¡Œåˆ†å‘æ¶ˆæ¯çš„æ“ä½œ</span>                msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                dispatchEnd <span class="token operator">=</span> needEndTime <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>traceTag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token comment" spellcheck="true">// æ¶ˆæ¯å·²ç»åˆ†å‘ï¼Œå°† Message æ”¾å…¥æ¶ˆæ¯æ± ï¼ˆå›æ”¶æ“ä½œï¼‰</span>            msg<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>æºç ä¸ç®—å¾ˆé•¿ï¼Œæˆ‘ä»¬é‡ç‚¹åˆ†æ loop() é‡Œé¢çš„å‡ ä¸ªå‡½æ•°ï¼š</p><h3 id="2-5-1-myLooper"><a href="#2-5-1-myLooper" class="headerlink" title="2.5.1 myLooper()"></a>2.5.1 myLooper()</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œåœ¨æ‰§è¡Œå®Œäº† Looper.prepare() ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¤–éƒ¨é€šè¿‡è°ƒç”¨ Looper.myLooper() è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„ Looper å¯¹è±¡ã€‚ </p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token annotation punctuation">@Nullable</span> Looper <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è¿˜æ˜¯é€šè¿‡ sThreadLocal.get()æ–¹æ³•è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„ Looper å¯¹è±¡</span>        <span class="token keyword">return</span> sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span></code></pre><h3 id="2-5-2-MessageQueue"><a href="#2-5-2-MessageQueue" class="headerlink" title="2.5.2 MessageQueue"></a>2.5.2 MessageQueue</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// Looper æ„é€ å‡½æ•°ä¸­åˆ›å»ºäº† mQueueï¼Œå³ MessageQueue</span>    <span class="token keyword">private</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// åˆ›å»º MessageQueue å¯¹è±¡</span>        mThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// è®°å½•å½“å‰çº¿ç¨‹</span>    <span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> Looper me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„ Looper å¯¹è±¡</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> MessageQueue queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// è·å– Looper å¯¹è±¡ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span></code></pre><p>å˜é‡ me æ˜¯é€šè¿‡é™æ€æ–¹æ³• myLooper() è·å¾—çš„å½“å‰çº¿ç¨‹æ‰€ç»‘å®šçš„ Looperï¼Œme.mQueue å°±æ˜¯å½“å‰çº¿ç¨‹æ‰€å…³è”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ </p><h3 id="2-5-3-for"><a href="#2-5-3-for" class="headerlink" title="2.5.3 for()"></a>2.5.3 for()</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// è¿›å…¥loopçš„ä¸»å¾ªç¯æ–¹æ³•</span></code></pre><p>æˆ‘ä»¬å‘ç°forå¾ªç¯æ²¡æœ‰è®¾ç½®å¾ªç¯ç»ˆæ­¢çš„æ¡ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªforå¾ªç¯æ˜¯ä¸ªæ­»å¾ªç¯ã€‚ </p><h4 id="2-5-3-1-Message"><a href="#2-5-3-1-Message" class="headerlink" title="2.5.3.1 Message"></a>2.5.3.1 Message</h4><pre class=" language-java"><code class="language-java">    Message msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// might block </span></code></pre><p>æˆ‘ä»¬é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ— MessageQueue çš„ next æ–¹æ³•ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚æœæ­¤æ—¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰ Messageï¼Œé‚£ä¹ˆ next æ–¹æ³•ä¼šç«‹å³è¿”å›è¯¥ Messageï¼Œå¦‚æœæ­¤æ—¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰ Messageï¼Œé‚£ä¹ˆ next æ–¹æ³•å°±ä¼šé˜»å¡å¼åœ°ç­‰å¾…è·å– Messageã€‚ </p><h4 id="2-5-3-2-dispatchMessage"><a href="#2-5-3-2-dispatchMessage" class="headerlink" title="2.5.3.2 dispatchMessage()"></a>2.5.3.2 dispatchMessage()</h4><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*package*/</span> Handler target<span class="token punctuation">;</span></code></pre><pre class=" language-java"><code class="language-java">    <span class="token keyword">try</span> <span class="token punctuation">{</span>        msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        dispatchEnd <span class="token operator">=</span> needEndTime <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>traceTag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>msg çš„ target å±æ€§æ˜¯ Handlerï¼Œè¯¥ä»£ç çš„æ„æ€æ˜¯è®© Message æ‰€å…³è”çš„ Handler é€šè¿‡ dispatchMessage æ–¹æ³•è®© Handler å¤„ç†è¯¥ Message ï¼Œå…³äº Handler çš„ dispatchMessage æ–¹æ³•å°†ä¼šåœ¨ä¸‹é¢è¯¦ç»†ä»‹ç»ã€‚</p><h4 id="2-5-3-3-recycleUnchecked"><a href="#2-5-3-3-recycleUnchecked" class="headerlink" title="2.5.3.3 recycleUnchecked()"></a>2.5.3.3 recycleUnchecked()</h4><pre class=" language-java"><code class="language-java">msg<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ†å‘åçš„ Message å›æ”¶åˆ°æ¶ˆæ¯æ± ï¼Œä»¥ä¾¿é‡å¤åˆ©ç”¨</span></code></pre><h3 id="2-5-4-å°ç»“"><a href="#2-5-4-å°ç»“" class="headerlink" title="2.5.4 å°ç»“"></a>2.5.4 å°ç»“</h3><pre><code>loop()è¿›å…¥å¾ªç¯æ¨¡å¼ï¼Œä¸æ–­é‡å¤ä¸‹é¢çš„æ“ä½œï¼Œç›´åˆ°æ²¡æœ‰æ¶ˆæ¯æ—¶é€€å‡ºå¾ªç¯ï¼š1ã€è¯»å– MessageQueue çš„ä¸‹ä¸€æ¡ Messageï¼›2ã€æŠŠ Message åˆ†å‘ç»™ç›¸åº”çš„ targetï¼›3ã€å†æŠŠåˆ†å‘åçš„ Message å›æ”¶åˆ°æ¶ˆæ¯æ± ï¼Œä»¥ä¾¿é‡å¤åˆ©ç”¨ã€‚</code></pre><h2 id="2-6-quit"><a href="#2-6-quit" class="headerlink" title="2.6 quit()"></a>2.6 quit()</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// ç›´æ¥é€€å‡ºæ¶ˆæ¯å¾ªç¯ï¼Œä¸ç®¡æ˜¯å¦è¿˜æœ‰æ¶ˆæ¯</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mQueue<span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ‰§è¡Œå®Œæ‰€æœ‰çš„æ¶ˆæ¯ï¼Œé€€å‡ºæ¶ˆæ¯å¾ªç¯</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quitSafely</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mQueue<span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>Looper.quit() æ–¹æ³•çš„å®ç°æœ€ç»ˆè°ƒç”¨çš„æ˜¯ MessageQueue.quit() æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">quit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> safe<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å½“ mQuitAllowed ä¸º falseï¼Œè¡¨ç¤ºä¸é€€å‡ºï¼Œå¼ºè¡Œè°ƒç”¨ quit() ä¼šæŠ›å‡ºå¼‚å¸¸</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mQuitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Main thread not allowed to quit."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            mQuitting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>safe<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">removeAllFutureMessagesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">removeAllMessagesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// We can assume mPtr != 0 because mQuitting was previously false.</span>            <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><pre><code>æ¶ˆæ¯ç§»é™¤çš„æ–¹å¼ï¼šå½“ safe = true æ—¶ï¼Œåªç§»é™¤å°šæœªè§¦å‘çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå¯¹äºæ­£åœ¨è§¦å‘çš„æ¶ˆæ¯å¹¶ä¸ç§»é™¤å½“ safe = flase æ—¶ï¼Œç§»é™¤æ‰€æœ‰çš„æ¶ˆæ¯</code></pre><h1 id="3-Handler"><a href="#3-Handler" class="headerlink" title="3. Handler"></a>3. Handler</h1><p>åˆ†æå®Œ Loopï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ Handler ç±»ï¼Œå®ƒæ˜¯æ€ä¹ˆä¸ Looper å’Œ MessageQueue ä¸€èµ·æ­é…å·¥ä½œçš„ã€‚</p><h2 id="3-1-æ„é€ å‡½æ•°"><a href="#3-1-æ„é€ å‡½æ•°" class="headerlink" title="3.1 æ„é€ å‡½æ•°"></a>3.1 æ„é€ å‡½æ•°</h2><p>ä¸¤ç§æ„é€ å‡½æ•°ï¼šæ— å‚å’Œæœ‰å‚ï¼</p><h3 id="3-1-1-æ— å‚æ„é€ "><a href="#3-1-1-æ— å‚æ„é€ " class="headerlink" title="3.1.1 æ— å‚æ„é€ "></a>3.1.1 æ— å‚æ„é€ </h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Callback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> async<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * ä¸»çº¿ç¨‹è°ƒç”¨çš„æ„é€ æ–¹æ³•ï¼Œä¸»çº¿ç¨‹å·²ç»è°ƒç”¨äº† Looper.prepareMainLooper();     */</span>    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Callback callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åŒ¿åç±»ã€å†…éƒ¨ç±»æˆ–æœ¬åœ°ç±»éƒ½å¿…é¡»ç”³æ˜ä¸º staticï¼Œå¦åˆ™ä¼šè­¦å‘Šå¯èƒ½å‡ºç°å†…å­˜æ³„éœ²</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>FIND_POTENTIAL_LEAKS<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// é»˜è®¤ä¸º false</span>            <span class="token keyword">final</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span><span class="token operator">></span> klass <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>klass<span class="token punctuation">.</span><span class="token function">isAnonymousClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> klass<span class="token punctuation">.</span><span class="token function">isMemberClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> klass<span class="token punctuation">.</span><span class="token function">isLocalClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                    <span class="token punctuation">(</span>klass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Modifier<span class="token punctuation">.</span>STATIC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"The following Handler class should be static or leaks might occur: "</span> <span class="token operator">+</span>                    klass<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¿…é¡»å…ˆæ‰§è¡Œ Looper.prepare()ï¼Œæ‰èƒ½è·å– Looper å¯¹è±¡ï¼Œå¦åˆ™ä¸ºnull</span>        mLooper <span class="token operator">=</span> Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLooper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                <span class="token string">"Can't create handler inside thread that has not called Looper.prepare()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mQueue <span class="token operator">=</span> mLooper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>        mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// å›è°ƒæ–¹æ³•</span>        mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// è®¾ç½®æ¶ˆæ¯æ˜¯å¦ä¸ºå¼‚æ­¥å¤„ç†æ–¹å¼</span>    <span class="token punctuation">}</span></code></pre><p>å¯¹äº Handler çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œé»˜è®¤é‡‡ç”¨å½“å‰çº¿ç¨‹ TLS ä¸­çš„ Looper å¯¹è±¡ï¼Œå¹¶ä¸” callback å›è°ƒæ–¹æ³•ä¸º nullï¼Œä¸”æ¶ˆæ¯ä¸ºåŒæ­¥å¤„ç†æ–¹å¼ã€‚åªè¦æ‰§è¡Œçš„ Looper.prepare() æ–¹æ³•ï¼Œé‚£ä¹ˆä¾¿å¯ä»¥è·å–æœ‰æ•ˆçš„ Looper å¯¹è±¡ã€‚</p><h3 id="3-1-2-æœ‰å‚æ„é€ "><a href="#3-1-2-æœ‰å‚æ„é€ " class="headerlink" title="3.1.2 æœ‰å‚æ„é€ "></a>3.1.2 æœ‰å‚æ„é€ </h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">,</span> Callback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * ç¬¬äºŒç§æ„é€ æ–¹æ³•ï¼Œä¸“é—¨ç»™å­çº¿ç¨‹ä¸­åˆ›å»º Handler æ—¶ä½¿ç”¨çš„     */</span>    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">,</span> Callback callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mLooper <span class="token operator">=</span> looper<span class="token punctuation">;</span>        mQueue <span class="token operator">=</span> looper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>        mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>        mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>Handler ç±»åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå¯æŒ‡å®š Looperï¼ŒCallback å›è°ƒæ–¹æ³•ä»¥åŠæ¶ˆæ¯çš„å¤„ç†æ–¹å¼(åŒæ­¥æˆ–å¼‚æ­¥)ï¼Œå¯¹äºæ— å‚çš„ handlerï¼Œé»˜è®¤æ˜¯å½“å‰çº¿ç¨‹çš„ Looperã€‚</p><h2 id="3-2-post"><a href="#3-2-post" class="headerlink" title="3.2 post"></a>3.2 post</h2><p>æˆ‘ä»¬çœ‹ä¸‹ post() æºç å¤„ç†æµç¨‹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// å‘é€ Runnable æ¶ˆæ¯</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">post</span><span class="token punctuation">(</span>Runnable r<span class="token punctuation">)</span>    <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// å¯ä»¥çœ‹åˆ°å†…éƒ¨è°ƒç”¨äº† getPostMessage æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼ å…¥ä¸€ä¸ª Runnable å¯¹è±¡ï¼Œå¾—åˆ°ä¸€ä¸ª Message å¯¹è±¡</span>       <span class="token keyword">return</span>  <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span><span class="token function">getPostMessage</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Message <span class="token function">getPostMessage</span><span class="token punctuation">(</span>Runnable r<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Message m <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        m<span class="token punctuation">.</span>callback <span class="token operator">=</span> r<span class="token punctuation">;</span>        <span class="token keyword">return</span> m<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ getPostMessage æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Message å¯¹è±¡ï¼Œå¹¶å°†ä¼ å…¥çš„ Runnable å¯¹è±¡èµ‹å€¼ç»™ Message çš„ callback æˆå‘˜å­—æ®µï¼Œç„¶åè¿”å›è¯¥ Message ï¼Œç„¶ååœ¨ post æ–¹æ³•ä¸­è¯¥æºå¸¦æœ‰ Runnable ä¿¡æ¯çš„ Message ä¼ å…¥åˆ° sendMessageDelayed æ–¹æ³•ä¸­ã€‚</p><h2 id="3-3-sendMessage"><a href="#3-3-sendMessage" class="headerlink" title="3.3 sendMessage"></a>3.3 sendMessage</h2><p>æˆ‘ä»¬çœ‹ä¸‹ sendMessage() æºç å¤„ç†æµç¨‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="3-4-sendMessageDelayed"><a href="#3-4-sendMessageDelayed" class="headerlink" title="3.4 sendMessageDelayed"></a>3.4 sendMessageDelayed</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            delayMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// æœ€ç»ˆè°ƒ sendMessageAtTime()</span>    <span class="token punctuation">}</span></code></pre><p>é€šè¿‡ä»¥ä¸Šä»£ç å¯ä»¥çœ‹ä¹¦ï¼šsendMessage() è°ƒç”¨äº† sendMessageDelayed() ï¼ŒsendMessageDelayed() åˆè°ƒç”¨äº† sendMessageAtTime()ã€‚</p><h2 id="3-5-sendMessageAtTime"><a href="#3-5-sendMessageAtTime" class="headerlink" title="3.5 sendMessageAtTime"></a>3.5 sendMessageAtTime</h2><p>åœ¨ Handler ä¸­æ‰€æœ‰å¯ä»¥ç›´æ¥æˆ–é—´æ¥å‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€ Message çš„æ–¹æ³•æœ€ç»ˆéƒ½è°ƒç”¨äº† sendMessageAtTime æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MessageQueue queue <span class="token operator">=</span> mQueue<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            RuntimeException e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                    <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" sendMessageAtTime() called with no mQueue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"Looper"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="3-6-enqueueMessage"><a href="#3-6-enqueueMessage" class="headerlink" title="3.6 enqueueMessage"></a>3.6 enqueueMessage</h3><p>æˆ‘ä»¬å‘ç° sendMessageAtTime() æ–¹æ³•å†…éƒ¨è°ƒç”¨äº† enqueueMessage() å‡½æ•°ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>MessageQueue queue<span class="token punctuation">,</span> Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>        msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAsynchronous<span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬éœ€è¦é‡ç‚¹æ³¨æ„ä¸¤è¡Œä»£ç ï¼š</p><pre class=" language-java"><code class="language-java">msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// å°† Message çš„ target ç»‘å®šä¸ºå½“å‰çš„ Handler </span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å˜é‡ queue è¡¨ç¤ºçš„æ˜¯ Handler æ‰€ç»‘å®šçš„æ¶ˆæ¯é˜Ÿåˆ— MessageQueue ï¼Œé€šè¿‡è°ƒç”¨ queue.enqueueMessage(msg, uptimeMillis) å°† Message æ”¾å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</span>queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="3-7-dispatchMessage"><a href="#3-7-dispatchMessage" class="headerlink" title="3.7 dispatchMessage()"></a>3.7 dispatchMessage()</h2><p>åœ¨ Looper.loop() ä¸­ï¼Œå½“å‘ç°æœ‰æ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨æ¶ˆæ¯çš„ç›®æ ‡ Handlerï¼Œæ‰§è¡Œ dispatchMessage() æ–¹æ³•æ¥åˆ†å‘æ¶ˆæ¯ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*package*/</span> Runnable callback<span class="token punctuation">;</span>    <span class="token keyword">final</span> Callback mCallback<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * @param msg A {@link android.os.Message Message} object         * @return True if no further handling is desired         */</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Handle system messages here.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>callback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// å¦‚æœæ¶ˆæ¯ä½“æ˜¯ Runnable å°±æ‰§è¡Œ run()</span>            <span class="token function">handleCallback</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å½“ Handler å­˜åœ¨ Callback æˆå‘˜å˜é‡æ—¶ï¼Œå›è°ƒæ–¹æ³• Callback é‡Œé¢çš„é€»è¾‘</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Handler è‡ªèº«çš„å›è°ƒæ–¹æ³• handleMessage()</span>            <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬éœ€è¦é‡ç‚¹åˆ†æä¸‹è¿™ä¸ªå‡½æ•°ï¼</p><p>é¦–å…ˆä¼šåˆ¤æ–­ msg.callback å­˜ä¸å­˜åœ¨ï¼Œmsg.callback æ˜¯ Runnable ç±»å‹ï¼Œ<strong><font color="#FF0000">å¦‚æœ msg.callback å­˜åœ¨ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥ Message æ˜¯é€šè¿‡æ‰§è¡Œ Handler çš„ post() ç³»åˆ—æ–¹æ³•å°† Message æ”¾å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„</font></strong>ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œ handleCallback(msg)ã€‚</p><h3 id="3-7-1-handleCallback"><a href="#3-7-1-handleCallback" class="headerlink" title="3.7.1 handleCallback"></a>3.7.1 handleCallback</h3><p>æºç å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span>Message message<span class="token punctuation">)</span> <span class="token punctuation">{</span>        message<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>è¿™æ ·æˆ‘ä»¬å°±æ¸…æ¥šåœ°çœ‹åˆ°æˆ‘ä»¬æ‰§è¡Œäº† msg.callback çš„ run æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº† post() æ‰€ä¼ é€’çš„ Runnable å¯¹è±¡çš„ run æ–¹æ³•ã€‚</p><h3 id="3-7-2-mCallback"><a href="#3-7-2-mCallback" class="headerlink" title="3.7.2 mCallback"></a>3.7.2 mCallback</h3><p>å¦‚æœæˆ‘ä»¬ä¸æ˜¯é€šè¿‡ post() ç³»åˆ—æ–¹æ³•å°† Message æ”¾å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ï¼Œé‚£ä¹ˆ msg.callback å°±æ˜¯ null ï¼Œä»£ç ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p><p>æ¥ç€æˆ‘ä»¬ä¼šåˆ¤æ–­ Handler çš„æˆå‘˜å­—æ®µ mCallback å­˜ä¸å­˜åœ¨ã€‚mCallback æ˜¯ Hanlder.Callback ç±»å‹çš„ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢æåˆ°è¿‡ï¼Œåœ¨ Handler çš„æ„é€ å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥ä¼ é€’ Hanlder.Callback ç±»å‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡éœ€è¦å®ç° handleMessage æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­ä¼ é€’äº†è¯¥ Callback å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šè®© Callback çš„ handleMessage æ–¹æ³•æ¥å¤„ç† Messageã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> Callback mCallback<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * @param msg A {@link android.os.Message Message} object         * @return True if no further handling is desired         */</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>å¦‚æœæˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­æ²¡æœ‰ä¼ å…¥ Callback ç±»å‹çš„å¯¹è±¡ï¼Œé‚£ä¹ˆ mCallback å°±ä¸º null ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šè°ƒç”¨ Handler è‡ªèº«çš„ hanldeMessage æ–¹æ³•ï¼Œè¯¥æ–¹æ³•é»˜è®¤æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±é‡å†™å®ç°è¯¥æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Subclasses must implement this to receive messages.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// ç©ºå‡½æ•°</span>    <span class="token punctuation">}</span></code></pre><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Handler æä¾›äº†ä¸‰ç§é€”å¾„å¤„ç† Message ï¼Œè€Œä¸”å¤„ç†æœ‰å‰åä¼˜å…ˆçº§ä¹‹åˆ†ï¼šé¦–å…ˆå°è¯•è®© post() ä¸­ä¼ é€’çš„ Runnable æ‰§è¡Œï¼Œå…¶æ¬¡å°è¯•è®© Handler æ„é€ å‡½æ•°ä¸­ä¼ å…¥çš„ Callback çš„ handleMessage æ–¹æ³•å¤„ç†ï¼Œæœ€åæ‰æ˜¯è®© Handler è‡ªèº«çš„ handleMessage æ–¹æ³•å¤„ç†Messageã€‚</p><h2 id="3-8-Callback"><a href="#3-8-Callback" class="headerlink" title="3.8 Callback"></a>3.8 Callback</h2><p>Callback æ˜¯ Handle rä¸­çš„å†…éƒ¨æ¥å£ï¼Œéœ€è¦å®ç°å…¶å†…éƒ¨çš„ handleMessage æ–¹æ³•ï¼ŒCallback ä»£ç å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>Handler.Callback æ˜¯ç”¨æ¥å¤„ç† Message çš„ä¸€ç§æ‰‹æ®µï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’è¯¥å‚æ•°ï¼Œé‚£ä¹ˆå°±åº”è¯¥é‡å†™ Handler çš„ handleMessage æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ºäº†ä½¿å¾— Handler èƒ½å¤Ÿå¤„ç† Message ï¼Œæœ‰ä¸¤ç§åŠæ³•ï¼š</p><ol><li><p>å‘ Hanlder çš„æ„é€ å‡½æ•°ä¼ å…¥ä¸€ä¸ª Handler.Callback å¯¹è±¡ï¼Œå¹¶å®ç° Handler.Callback çš„ handleMessage æ–¹æ³• </p></li><li><p>æ— éœ€å‘ Hanlder çš„æ„é€ å‡½æ•°ä¼ å…¥ Handler.Callback å¯¹è±¡ï¼Œä½†æ˜¯éœ€è¦é‡å†™ Handler æœ¬èº«çš„ handleMessage æ–¹æ³• </p></li></ol><p>ä¹Ÿå°±æ˜¯è¯´æ— è®ºå“ªç§æ–¹å¼ï¼Œæˆ‘ä»¬éƒ½å¾—é€šè¿‡æŸç§æ–¹å¼å®ç° handleMessage æ–¹æ³•ï¼Œè¿™ç‚¹ä¸ Java ä¸­å¯¹ Thread çš„è®¾è®¡æœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„ã€‚ </p><pre><code>åœ¨Javaä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œæœ‰ä¸¤ç§åŠæ³•ï¼š1. å‘ Thread çš„æ„é€ å‡½æ•°ä¼ å…¥ä¸€ä¸ª Runnable å¯¹è±¡ï¼Œå¹¶å®ç° Runnable çš„ run æ–¹æ³•2. æ— éœ€å‘ Thread çš„æ„é€ å‡½æ•°ä¼ å…¥ Runnable å¯¹è±¡ï¼Œä½†æ˜¯è¦é‡å†™ Thread æœ¬èº«çš„ run æ–¹æ³• æ‰€ä»¥åªè¦ç”¨è¿‡å¤šçº¿ç¨‹ Threadï¼Œåº”è¯¥å°±å¯¹ Hanlder è¿™ç§éœ€è¦å®ç° handleMessage çš„ä¸¤ç§æ–¹å¼äº†ç„¶äºå¿ƒäº†ã€‚</code></pre><h1 id="4-MessageQueue"><a href="#4-MessageQueue" class="headerlink" title="4. MessageQueue"></a>4. MessageQueue</h1><p>æ¯ä¸ªçº¿ç¨‹å†…éƒ¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— â€”â€” MessageQueueã€‚æ¶ˆæ¯é˜Ÿåˆ— MessageQueueï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚é‚£é˜Ÿåˆ—ä¸­å­˜å‚¨çš„æ¶ˆæ¯æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><strong><font color="#FF0000">æˆ‘ä»¬å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼š</font></strong>åœ¨ UI ç•Œé¢ä¸Šå•å‡»äº†æŸä¸ªæŒ‰é’®ï¼Œè€Œæ­¤æ—¶ç¨‹åºåˆæ°å¥½æ”¶åˆ°äº†æŸä¸ªå¹¿æ’­äº‹ä»¶ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•å¤„ç†è¿™ä¸¤ä»¶äº‹å‘¢ï¼Ÿå› ä¸ºä¸€ä¸ªçº¿ç¨‹åœ¨æŸä¸€æ—¶åˆ»åªèƒ½å¤„ç†ä¸€ä»¶äº‹æƒ…ï¼Œä¸èƒ½åŒæ—¶å¤„ç†å¤šä»¶äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åŒæ—¶å¤„ç†æŒ‰é’®çš„å•å‡»äº‹ä»¶å’Œå¹¿æ’­äº‹ä»¶ï¼Œæˆ‘ä»¬åªèƒ½æŒ¨ä¸ªå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œåªè¦æŒ¨ä¸ªå¤„ç†å°±è¦æœ‰å¤„ç†çš„å…ˆåé¡ºåºã€‚</p><p>ä¸ºæ­¤ Android æŠŠ UI ç•Œé¢ä¸Šå•å‡»æŒ‰é’®çš„äº‹ä»¶å°è£…æˆäº†ä¸€ä¸ª Message ï¼Œå°†å…¶æ”¾å…¥åˆ° MessageQueue é‡Œé¢å»ï¼Œå³å°†å•å‡»æŒ‰é’®äº‹ä»¶çš„ Message å…¥æ ˆåˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åå†å°†å¹¿æ’­äº‹ä»¶çš„å°è£…æˆ Message ï¼Œä¹Ÿå°†å…¶å…¥æ ˆåˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª Message å¯¹è±¡è¡¨ç¤ºçš„æ˜¯çº¿ç¨‹éœ€è¦å¤„ç†çš„ä¸€ä»¶äº‹æƒ…ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯ä¸€å †éœ€è¦å¤„ç†çš„ Message çš„æ± ã€‚çº¿ç¨‹ Thread ä¼šä¾æ¬¡å–å‡ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œä¾æ¬¡å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚</p><p>MessageQueue ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ enqueueMessage æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ next æ–¹æ³•ã€‚<font color="#0000FF">enqueueMessage æ–¹æ³•ç”¨äºå°†ä¸€ä¸ª Message æ”¾å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ— MessageQueue ä¸­ï¼Œnext æ–¹æ³•æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ— MessageQueue ä¸­é˜»å¡å¼åœ°å–å‡ºä¸€ä¸ª Message</font>ã€‚</p><h2 id="4-1-åˆ›å»º-MessageQueue"><a href="#4-1-åˆ›å»º-MessageQueue" class="headerlink" title="4.1 åˆ›å»º MessageQueue"></a>4.1 åˆ›å»º MessageQueue</h2><p>åœ¨ Looper ä¸­åˆ›å»ºäº† MessageQueueï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>        mThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// æ„é€ å‡½æ•°ï¼ŒquitAllowed ç”¨æ¥æ ‡è¯†æ˜¯å¦å…è®¸é€€å‡º</span>    <span class="token function">MessageQueue</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// ä¸»çº¿ç¨‹æ˜¯ä¸å…è®¸é€€å‡ºçš„ï¼ˆä¸ç„¶ä¼šé€€å‡ºæ•´ä¸ªç¨‹åºï¼‰ï¼Œå­çº¿ç¨‹å¯ä»¥é€€å‡º</span>        mQuitAllowed <span class="token operator">=</span> quitAllowed<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// é€šè¿‡ native æ–¹æ³•åˆå§‹åŒ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶ä¸­ mPtr æ˜¯ä¾› native ä»£ç ä½¿ç”¨</span>        mPtr <span class="token operator">=</span> <span class="token function">nativeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-2-next"><a href="#4-2-next" class="headerlink" title="4.2 next()"></a>4.2 next()</h2><pre class=" language-java"><code class="language-java">    Message <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> <span class="token keyword">long</span> ptr <span class="token operator">=</span> mPtr<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// å½“æ¶ˆæ¯å¾ªç¯å·²ç»é€€å‡ºï¼Œåˆ™ç›´æ¥è¿”å›</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// å¾ªç¯è¿­ä»£çš„é¦–æ¬¡ä¸º -1</span>        <span class="token keyword">int</span> pendingIdleHandlerCount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// -1 only during first iteration</span>        <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextPollTimeoutMillis <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Binder<span class="token punctuation">.</span><span class="token function">flushPendingCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// é˜»å¡æ“ä½œï¼Œå½“ç­‰å¾… nextPollTimeoutMillis æ—¶é•¿ï¼Œæˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—è¢«å”¤é†’ï¼Œéƒ½ä¼šè¿”å›</span>            <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Try to retrieve the next message.  Return if found.</span>                <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Message prevMsg <span class="token operator">=</span> null<span class="token punctuation">;</span>                Message msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// å½“æ¶ˆæ¯ Handler ä¸ºç©ºæ—¶ï¼ŒæŸ¥è¯¢ MessageQueue ä¸­çš„ä¸‹ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯ msgï¼Œåˆ™é€€å‡ºå¾ªç¯</span>                    <span class="token keyword">do</span> <span class="token punctuation">{</span>                        prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>                        msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// å½“å¼‚æ­¥æ¶ˆæ¯è§¦å‘æ—¶é—´å¤§äºå½“å‰æ—¶é—´ï¼Œåˆ™è®¾ç½®ä¸‹ä¸€æ¬¡è½®è¯¢çš„è¶…æ—¶æ—¶é•¿</span>                        nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// å–å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¾€åç§»åŠ¨ä¸€ä¸ª</span>                        mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        msg<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// è®¾ç½®æ¶ˆæ¯çš„ä½¿ç”¨çŠ¶æ€ï¼Œå³ flags |= FLAG_IN_USEï¼Œè¡¨ç¤ºå·²ä½¿ç”¨</span>                        msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// æˆåŠŸåœ°è·å– MessageQueue ä¸­çš„ä¸‹ä¸€æ¡å³å°†è¦æ‰§è¡Œçš„æ¶ˆæ¯</span>                        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// æ²¡æœ‰æ¶ˆæ¯</span>                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ­£åœ¨é€€å‡ºï¼Œè¿”å› null</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// å½“æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯æ—¶</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;</span> <span class="token number">0</span>                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mMessages <span class="token operator">==</span> null <span class="token operator">||</span> now <span class="token operator">&lt;</span> mMessages<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    pendingIdleHandlerCount <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// æ²¡æœ‰ idle handlers éœ€è¦è¿è¡Œï¼Œåˆ™å¾ªç¯å¹¶ç­‰å¾…</span>                    mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingIdleHandlers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mPendingIdleHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdleHandler</span><span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>pendingIdleHandlerCount<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                mPendingIdleHandlers <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>mPendingIdleHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// åªæœ‰ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œä¼šè¿è¡Œ idle handlersï¼Œæ‰§è¡Œå®Œæˆåï¼Œé‡ç½® pendingIdleHandlerCount ä¸º 0</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingIdleHandlerCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> IdleHandler idler <span class="token operator">=</span> mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å»æ‰ handler çš„å¼•ç”¨</span>                <span class="token keyword">boolean</span> keep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    keep <span class="token operator">=</span> idler<span class="token punctuation">.</span><span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// idle æ—¶æ‰§è¡Œçš„æ–¹æ³•</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"IdleHandler threw exception"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keep<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        mIdleHandlers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>idler<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// é‡ç½® idle handler ä¸ªæ•°ä¸º 0ï¼Œä»¥ä¿è¯ä¸ä¼šå†æ¬¡é‡å¤è¿è¡Œ</span>            pendingIdleHandlerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å½“è°ƒç”¨ä¸€ä¸ªç©ºé—² handler æ—¶ï¼Œä¸€ä¸ªæ–° message èƒ½å¤Ÿè¢«åˆ†å‘ï¼Œå› æ­¤æ— éœ€ç­‰å¾…å¯ä»¥ç›´æ¥æŸ¥è¯¢ pending message</span>            nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>nativePollOnce æ˜¯é˜»å¡æ“ä½œï¼Œå…¶ä¸­ nextPollTimeoutMillis ä»£è¡¨ä¸‹ä¸€ä¸ªæ¶ˆæ¯åˆ°æ¥å‰ï¼Œè¿˜éœ€è¦ç­‰å¾…çš„æ—¶é•¿ï¼›å½“ nextPollTimeoutMillis = -1 æ—¶ï¼Œè¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ— æ¶ˆæ¯ï¼Œä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚</p><p>å½“å¤„äºç©ºé—²æ—¶ï¼Œå¾€å¾€ä¼šæ‰§è¡Œ IdleHandler ä¸­çš„æ–¹æ³•ã€‚å½“ nativePollOnce() è¿”å›åï¼Œnext() ä» mMessages ä¸­æå–ä¸€ä¸ªæ¶ˆæ¯ã€‚</p><h2 id="4-3-enqueueMessage"><a href="#4-3-enqueueMessage" class="headerlink" title="4.3 enqueueMessage()"></a>4.3 enqueueMessage()</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ¯ä¸€ä¸ªæ™®é€š Message å¿…é¡»æœ‰ä¸€ä¸ª target</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Message must have a target."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">isInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">" This message is already in use."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ­£åœ¨é€€å‡ºæ—¶ï¼Œå›æ”¶ msgï¼ŒåŠ å…¥åˆ°æ¶ˆæ¯æ± </span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>                IllegalStateException e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>                        msg<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">" sending message to a Handler on a dead thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                msg<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>            Message p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>            <span class="token keyword">boolean</span> needWake<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// p ä¸º null (ä»£è¡¨MessageQueueæ²¡æœ‰æ¶ˆæ¯ï¼‰ æˆ–è€… msg çš„è§¦å‘æ—¶é—´æ˜¯é˜Ÿåˆ—ä¸­æœ€æ—©çš„ï¼Œåˆ™è¿›å…¥è¯¥è¯¥åˆ†æ”¯</span>                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>                mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>                needWake <span class="token operator">=</span> mBlocked<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// å½“é˜»å¡æ—¶éœ€è¦å”¤é†’</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯æŒ‰æ—¶é—´é¡ºåºæ’å…¥åˆ° MessageQueueã€‚ä¸€èˆ¬åœ°ï¼Œä¸éœ€è¦å”¤é†’äº‹ä»¶é˜Ÿåˆ—ï¼Œé™¤é</span>                <span class="token comment" spellcheck="true">// æ¶ˆæ¯é˜Ÿå¤´å­˜åœ¨ barrierï¼Œå¹¶ä¸”åŒæ—¶ Message æ˜¯é˜Ÿåˆ—ä¸­æœ€æ—©çš„å¼‚æ­¥æ¶ˆæ¯</span>                needWake <span class="token operator">=</span> mBlocked <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>target <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Message prev<span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    prev <span class="token operator">=</span> p<span class="token punctuation">;</span>                    p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// invariant: p == prev.next</span>                prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ²¡æœ‰é€€å‡ºï¼Œæˆ‘ä»¬è®¤ä¸ºæ­¤æ—¶ mPtr != 0</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>MessageQueue æ˜¯æŒ‰ç…§ Message è§¦å‘æ—¶é—´çš„å…ˆåé¡ºåºæ’åˆ—çš„ï¼Œé˜Ÿå¤´çš„æ¶ˆæ¯æ˜¯å°†è¦æœ€æ—©è§¦å‘çš„æ¶ˆæ¯ã€‚å½“æœ‰æ¶ˆæ¯éœ€è¦åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šä»é˜Ÿåˆ—å¤´å¼€å§‹éå†ï¼Œç›´åˆ°æ‰¾åˆ°æ¶ˆæ¯åº”è¯¥æ’å…¥çš„åˆé€‚ä½ç½®ï¼Œä»¥ä¿è¯æ‰€æœ‰æ¶ˆæ¯çš„æ—¶é—´é¡ºåºã€‚</p><h2 id="4-4-removeMessages"><a href="#4-4-removeMessages" class="headerlink" title="4.4 removeMessages()"></a>4.4 removeMessages()</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">removeMessages</span><span class="token punctuation">(</span>Handler h<span class="token punctuation">,</span> <span class="token keyword">int</span> what<span class="token punctuation">,</span> Object object<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Message p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ä»æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´éƒ¨å¼€å§‹ï¼Œç§»é™¤æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>target <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>what <span class="token operator">==</span> what                   <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> null <span class="token operator">||</span> p<span class="token punctuation">.</span>obj <span class="token operator">==</span> object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Message n <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                mMessages <span class="token operator">=</span> n<span class="token punctuation">;</span>                p<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                p <span class="token operator">=</span> n<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// ç§»é™¤å‰©ä½™çš„ç¬¦åˆè¦æ±‚çš„æ¶ˆæ¯</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Message n <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>target <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>what <span class="token operator">==</span> what                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> null <span class="token operator">||</span> n<span class="token punctuation">.</span>obj <span class="token operator">==</span> object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Message nn <span class="token operator">=</span> n<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        n<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        p<span class="token punctuation">.</span>next <span class="token operator">=</span> nn<span class="token punctuation">;</span>                        <span class="token keyword">continue</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                p <span class="token operator">=</span> n<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>è¿™ä¸ªç§»é™¤æ¶ˆæ¯çš„æ–¹æ³•ï¼Œé‡‡ç”¨äº†ä¸¤ä¸ª while å¾ªç¯ï¼Œç¬¬ä¸€ä¸ªå¾ªç¯æ˜¯ä»é˜Ÿå¤´å¼€å§‹ï¼Œç§»é™¤ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå¾ªç¯æ˜¯ä»å¤´éƒ¨ç§»é™¤å®Œè¿ç»­çš„æ»¡è¶³æ¡ä»¶çš„æ¶ˆæ¯ä¹‹åï¼Œå†ä»é˜Ÿåˆ—åé¢ç»§ç»­æŸ¥è¯¢æ˜¯å¦æœ‰æ»¡è¶³æ¡ä»¶çš„æ¶ˆæ¯éœ€è¦è¢«ç§»é™¤ã€‚</p><h1 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. æ€»ç»“</h1><p>æœ€åç”¨ä¸€å¼ å›¾ï¼Œæ¥è¡¨ç¤ºæ•´ä¸ªæ¶ˆæ¯æœºåˆ¶ï¼š<br><br></p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-bd6811a7ae7e3e63.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="handler_java.jpg"></center><p><strong>å›¾è§£ï¼š</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;Handler é€šè¿‡ sendMessage() å‘é€ Message åˆ° MessageQueue é˜Ÿåˆ—ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;Looper é€šè¿‡ loop()ï¼Œä¸æ–­æå–å‡ºè¾¾åˆ°è§¦å‘æ¡ä»¶çš„ Messageï¼Œå¹¶å°† Message äº¤ç»™ target æ¥å¤„ç†ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;ç»è¿‡ dispatchMessage() åï¼Œäº¤å›ç»™ Handler çš„ handleMessage() æ¥è¿›è¡Œç›¸åº”åœ°å¤„ç†ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;å°† Message åŠ å…¥ MessageQueue æ—¶ï¼Œå¾€ç®¡é“å†™å…¥å­—ç¬¦ï¼Œå¯ä»¥ä¼šå”¤é†’ loop çº¿ç¨‹ï¼›å¦‚æœ MessageQueue ä¸­æ²¡æœ‰ Messageï¼Œå¹¶å¤„äº Idle çŠ¶æ€ï¼Œåˆ™ä¼šæ‰§è¡Œ IdelHandler æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¾€å¾€ç”¨äºåšä¸€äº›æ¸…ç†æ€§åœ°å·¥ä½œã€‚</p><h1 id="å‚è€ƒBlog"><a href="#å‚è€ƒBlog" class="headerlink" title="å‚è€ƒBlog"></a>å‚è€ƒBlog</h1><p>&nbsp; 01. <a href="https://blog.csdn.net/iispring/article/details/47180325" target="_blank" rel="noopener">https://blog.csdn.net/iispring/article/details/47180325</a><br>&nbsp; 02. <a href="http://gityuan.com/2015/12/26/handler-message-framework/" target="_blank" rel="noopener">http://gityuan.com/2015/12/26/handler-message-framework/</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ ¸å¿ƒæœºåˆ¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Handler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒæœºåˆ¶ ä¹‹ Handlerï¼ˆç”¨æ³•ç¯‡ï¼‰</title>
      <link href="/2018/09/10/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-handler-yong-fa-pian/"/>
      <url>/2018/09/10/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-handler-yong-fa-pian/</url>
      
        <content type="html"><![CDATA[<h1 id="1-å¼€ç¯‡"><a href="#1-å¼€ç¯‡" class="headerlink" title="1. å¼€ç¯‡"></a>1. å¼€ç¯‡</h1><h2 id="1-1-å¼•å‡ºé—®é¢˜"><a href="#1-1-å¼•å‡ºé—®é¢˜" class="headerlink" title="1.1 å¼•å‡ºé—®é¢˜"></a>1.1 å¼•å‡ºé—®é¢˜</h2><p>åœ¨ Android å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™æ ·ä¸€ç§æƒ…å†µï¼šåœ¨ UI ç•Œé¢ä¸Šè¿›è¡ŒæŸé¡¹æ“ä½œåè¦æ‰§è¡Œä¸€æ®µå¾ˆè€—æ—¶çš„ä»£ç ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ç•Œé¢ä¸Šç‚¹å‡»äº†ä¸€ä¸ª â€œä¸‹è½½â€ æŒ‰é’®ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼Œè¿™æ˜¯ä¸€ä¸ªè€—æ—¶æ“ä½œã€‚</p><p>ä¸ºäº†ä¿è¯ä¸å½±å“ UI çº¿ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å»æ‰§è¡Œæˆ‘ä»¬çš„è€—æ—¶ä»£ç ã€‚å½“è€—æ—¶æ“ä½œå®Œæˆæ—¶ï¼Œéœ€è¦æ›´æ–° UI ç•Œé¢ä»¥å‘ŠçŸ¥ç”¨æˆ·æ“ä½œå®Œæˆäº†ã€‚</p><h2 id="1-2-ä»£ç å®ä¾‹"><a href="#1-2-ä»£ç å®ä¾‹" class="headerlink" title="1.2 ä»£ç å®ä¾‹"></a>1.2 ä»£ç å®ä¾‹</h2><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬çœ‹ä»¥ä¸‹ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>TextView<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">Button<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> TextView textView <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> Button btnDownload <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        textView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>textView<span class="token punctuation">)</span><span class="token punctuation">;</span>        btnDownload <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnDownload<span class="token punctuation">)</span><span class="token punctuation">;</span>        btnDownload<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>        DownLoadThread downLoadThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DownLoadThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        downLoadThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">class</span> <span class="token class-name">DownLoadThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹ä¸‹è½½æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä¸‹è½½å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶ä¸‹è½½å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// æ‰§è¡Œåï¼Œæ­¤å¤„å´©æºƒï¼ï¼ï¼</span>            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="1-3-æ‰§è¡Œç»“æœ"><a href="#1-3-æ‰§è¡Œç»“æœ" class="headerlink" title="1.3 æ‰§è¡Œç»“æœ"></a>1.3 æ‰§è¡Œç»“æœ</h2><pre class=" language-java"><code class="language-java">E<span class="token operator">/</span>AndroidRuntime<span class="token operator">:</span> FATAL EXCEPTION<span class="token operator">:</span> Thread<span class="token operator">-</span><span class="token number">4</span>    Process<span class="token operator">:</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo<span class="token punctuation">,</span> PID<span class="token operator">:</span> <span class="token number">14415</span>    android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewRootImpl$CalledFromWrongThreadException<span class="token operator">:</span> Only the original thread that created a view hierarchy can touch its views<span class="token punctuation">.</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewRootImpl<span class="token punctuation">.</span><span class="token function">checkThread</span><span class="token punctuation">(</span>ViewRootImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">7579</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewRootImpl<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>ViewRootImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1200</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22156</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22156</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22156</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22156</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22156</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22156</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>constraint<span class="token punctuation">.</span>ConstraintLayout<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>ConstraintLayout<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3172</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">requestLayout</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22156</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>TextView<span class="token punctuation">.</span><span class="token function">checkForRelayout</span><span class="token punctuation">(</span>TextView<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">8553</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>TextView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>TextView<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5416</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>TextView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>TextView<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5272</span><span class="token punctuation">)</span>        at android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>TextView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>TextView<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5229</span><span class="token punctuation">)</span>        at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo<span class="token punctuation">.</span>MainActivity$DownLoaderThread<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// é”™è¯¯å¼€å§‹</span></code></pre><h2 id="1-4-é”™è¯¯åˆ†æ"><a href="#1-4-é”™è¯¯åˆ†æ" class="headerlink" title="1.4 é”™è¯¯åˆ†æ"></a>1.4 é”™è¯¯åˆ†æ</h2><p>æ‰§è¡Œä¹‹åï¼Œæˆ‘ä»¬å‘ç°ç¨‹åºå´©æºƒï¼Œå¹¶ä¸”å‡ºç°äº†ä»¥ä¸Šçš„é”™è¯¯ï¼š<strong><font color="#ff0000">åªæœ‰åˆ›å»º View çš„åŸå§‹çº¿ç¨‹æ‰èƒ½æ›´æ–° Viewã€‚</font></strong>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Ÿ</p><p>å‡ºç°è¿™æ ·é”™è¯¯çš„åŸå› æ˜¯ Android ä¸­çš„ View ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨ Android åº”ç”¨å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå³ç¨‹åºçš„ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹è´Ÿè´£ UI çš„å±•ç¤ºã€UI äº‹ä»¶æ¶ˆæ¯çš„æ´¾å‘å¤„ç†ç­‰ç­‰ï¼Œå› æ­¤ä¸»çº¿ç¨‹ä¹Ÿå«åš UI çº¿ç¨‹ï¼ŒtextView æ˜¯åœ¨ UI çº¿ç¨‹ä¸­åˆ›å»ºçš„ï¼Œå½“æˆ‘ä»¬åœ¨ DownloadThread çº¿ç¨‹ä¸­å»æ›´æ–° UI çº¿ç¨‹ä¸­åˆ›å»ºçš„ textView æ—¶è‡ªç„¶ä¼šæŠ¥ä¸Šé¢çš„é”™è¯¯ã€‚</p><p>Android çš„ UI æ§ä»¶æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä¸åŒçš„å¹³å°æä¾›äº†ä¸åŒçš„è§£å†³æ–¹æ¡ˆä»¥å®ç°è·¨çº¿ç¨‹æ›´æ–° UI æ§ä»¶ï¼ŒAndroid ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜å¼•å…¥äº† <strong><font color="FF0000">Handleræœºåˆ¶</font></strong> ã€‚</p><h2 id="1-5-Handler-å¼•å…¥"><a href="#1-5-Handler-å¼•å…¥" class="headerlink" title="1.5 Handler å¼•å…¥"></a>1.5 Handler å¼•å…¥</h2><p>é‚£ä¹ˆ Handler åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ <strong><font color="#FF00FF">Handler æ˜¯ Android ä¸­å¼•å…¥çš„ä¸€ç§è®©å¼€å‘è€…å‚ä¸å¤„ç†çº¿ç¨‹ä¸­æ¶ˆæ¯å¾ªç¯çš„æœºåˆ¶ã€‚</font></strong></p><p>æ¯ä¸ª Hanlder éƒ½å…³è”äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å†…éƒ¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— MessageQueueï¼Œè¿™æ · Handler å®é™…ä¸Šä¹Ÿå°±å…³è”äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¯ä»¥é€šè¿‡ Handler å°† Message æˆ– Runnable å¯¹è±¡å‘é€åˆ°è¯¥ Handler æ‰€å…³è”çº¿ç¨‹çš„ MessageQueueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ä¸­ï¼Œç„¶åè¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸€ç›´åœ¨å¾ªç¯æ‹¿å‡ºä¸€ä¸ª Messageï¼Œå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œä¹‹åæ‹¿å‡ºä¸‹ä¸€ä¸ª Messageï¼Œç»§ç»­è¿›è¡Œå¤„ç†ï¼Œå‘¨è€Œå¤å§‹ã€‚</p><p>Handler å¯ä»¥ç”¨æ¥åœ¨å¤šçº¿ç¨‹é—´è¿›è¡Œé€šä¿¡ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ›´æ–° UI çº¿ç¨‹ä¸­çš„ UI æ§ä»¶åªæ˜¯ Handler ä½¿ç”¨ä¸­çš„ä¸€ç§å…¸å‹æ¡ˆä¾‹ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒHandler å¯ä»¥åšå¾ˆå¤šå…¶ä»–çš„äº‹æƒ…ã€‚æ¯ä¸ª Handler éƒ½ç»‘å®šäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå‡è®¾å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹ ThreadA å’Œ ThreadBï¼Œå¹¶ä¸” HandlerA ç»‘å®šäº† ThreadAï¼Œåœ¨ ThreadB ä¸­çš„ä»£ç æ‰§è¡Œåˆ°æŸå¤„æ—¶ï¼Œå‡ºäºæŸäº›åŸå› ï¼Œæˆ‘ä»¬éœ€è¦è®© ThreadA æ‰§è¡ŒæŸäº›ä»£ç ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Handlerï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ ThreadB ä¸­å‘ HandlerA ä¸­åŠ å…¥æŸäº›ä¿¡æ¯ä»¥å‘ŠçŸ¥ ThreadA ä¸­è¯¥åšæŸäº›å¤„ç†äº†ã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼ŒHandler æ˜¯ Thread çš„ä»£è¨€äººï¼Œæ˜¯å¤šçº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æ¡¥æ¢ï¼Œé€šè¿‡ Handlerï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ§åˆ¶å¦ä¸€ä¸ªçº¿ç¨‹å»åšæŸäº›äº‹æƒ…ã€‚</p><h1 id="2-Handler-ç”¨æ³•"><a href="#2-Handler-ç”¨æ³•" class="headerlink" title="2. Handler ç”¨æ³•"></a>2. Handler ç”¨æ³•</h1><p>Handler æä¾›äº†ä¸¤ç§æ–¹å¼è§£å†³å‰é¢é‡åˆ°çš„é—®é¢˜ï¼ˆåœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­æ›´æ–°ä¸»çº¿ç¨‹ä¸­çš„ UI æ§ä»¶ï¼‰ï¼Œä¸€ç§æ˜¯é€šè¿‡ <strong><font color="4F94CD">post</font></strong> æ–¹æ³•ï¼Œä¸€ç§æ˜¯è°ƒç”¨ <strong><font color="4F94CD">sendMessage</font></strong> æ–¹æ³•ã€‚</p><h2 id="2-1-post"><a href="#2-1-post" class="headerlink" title="2.1 post"></a>2.1 post</h2><h3 id="2-1-1-ä»£ç å®ä¾‹"><a href="#2-1-1-ä»£ç å®ä¾‹" class="headerlink" title="2.1.1 ä»£ç å®ä¾‹"></a>2.1.1 ä»£ç å®ä¾‹</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>TextView<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">Button<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> TextView textView <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> Button btnDownload <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> Handler uiHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        textView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>textView<span class="token punctuation">)</span><span class="token punctuation">;</span>        btnDownload <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnDownload<span class="token punctuation">)</span><span class="token punctuation">;</span>        btnDownload<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MainThread id "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>        DownLoadThread downLoadThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DownLoadThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        downLoadThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">class</span> <span class="token class-name">DownLoadThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DownloadThread id "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹ä¸‹è½½æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä¸‹è½½å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// MainActivity.this.textView.setText("æ–‡ä»¶ä¸‹è½½å®Œæˆ");</span>                Runnable runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"RunnableThread id "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶ä¸‹è½½å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">;</span>                uiHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-1-2-æ‰§è¡Œç»“æœ"><a href="#2-1-2-æ‰§è¡Œç»“æœ" class="headerlink" title="2.1.2 æ‰§è¡Œç»“æœ"></a>2.1.2 æ‰§è¡Œç»“æœ</h3><pre class=" language-java"><code class="language-java"><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">24.474</span> <span class="token number">15864</span><span class="token operator">-</span><span class="token number">15864</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> MainThread id <span class="token number">2</span><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">26.901</span> <span class="token number">15864</span><span class="token operator">-</span><span class="token number">15938</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> DownloadThread id <span class="token number">2441</span><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">26.901</span> <span class="token number">15864</span><span class="token operator">-</span><span class="token number">15938</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> å¼€å§‹ä¸‹è½½æ–‡ä»¶<span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">31.902</span> <span class="token number">15864</span><span class="token operator">-</span><span class="token number">15938</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> ä¸‹è½½å®Œæˆ<span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">31.906</span> <span class="token number">15864</span><span class="token operator">-</span><span class="token number">15864</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> RunnableThread id <span class="token number">2</span></code></pre><p>é€šè¿‡è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼ŒRunnable ä¸­çš„ä»£ç æ‰€æ‰§è¡Œçš„çº¿ç¨‹ ID ä¸ DownloadThread çš„çº¿ç¨‹ ID ä¸åŒï¼Œè€Œä¸ä¸»çº¿ç¨‹çš„çº¿ç¨‹ ID ç›¸åŒï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿç”±æ­¤çœ‹å‡ºåœ¨æ‰§è¡Œäº† Handler.post(Runnable) è¿™å¥ä»£ç ä¹‹åï¼Œè¿è¡Œ Runnable ä»£ç çš„çº¿ç¨‹ä¸ Handler æ‰€ç»‘å®šçš„çº¿ç¨‹æ˜¯ä¸€è‡´çš„ï¼Œè€Œä¸æ‰§è¡Œ Handler.post(Runnable) è¿™å¥ä»£ç çš„çº¿ç¨‹ï¼ˆDownloadThreadï¼‰æ— å…³ã€‚</p><h3 id="2-1-3-ç»“æœåˆ†æ"><a href="#2-1-3-ç»“æœåˆ†æ" class="headerlink" title="2.1.3 ç»“æœåˆ†æ"></a>2.1.3 ç»“æœåˆ†æ</h3><p>æˆ‘ä»¬åœ¨ Activity ä¸­åˆ›å»ºäº†ä¸€ä¸ª Handler æˆå‘˜å˜é‡ uiHandlerï¼ŒHandler æœ‰ä¸ªç‰¹ç‚¹ï¼Œåœ¨æ‰§è¡Œ new Handler() çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹ Handler ä¼šç»‘å®šå½“å‰ä»£ç æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­å®ä¾‹åŒ–äº† uiHandlerï¼Œæ‰€ä»¥ uiHandle rå°±è‡ªåŠ¨ç»‘å®šäº†ä¸»çº¿ç¨‹ï¼Œå³ UI çº¿ç¨‹ã€‚å½“æˆ‘ä»¬åœ¨ DownloadThread ä¸­æ‰§è¡Œå®Œè€—æ—¶ä»£ç åï¼Œæˆ‘ä»¬å°†ä¸€ä¸ª Runnable å¯¹è±¡é€šè¿‡ post æ–¹æ³•ä¼ å…¥åˆ°äº† Handler ä¸­ï¼ŒHandler ä¼šåœ¨åˆé€‚çš„æ—¶å€™è®©ä¸»çº¿ç¨‹æ‰§è¡Œ Runnable ä¸­çš„ä»£ç ï¼Œè¿™æ · Runnable å°±åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº†ï¼Œä»è€Œæ­£ç¡®æ›´æ–°äº†ä¸»çº¿ç¨‹ä¸­çš„ UIã€‚</p><h2 id="2-2-sendMessage"><a href="#2-2-sendMessage" class="headerlink" title="2.2 sendMessage"></a>2.2 sendMessage</h2><h3 id="2-2-1-ä»£ç å®ä¾‹"><a href="#2-2-1-ä»£ç å®ä¾‹" class="headerlink" title="2.2.1 ä»£ç å®ä¾‹"></a>2.2.1 ä»£ç å®ä¾‹</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Message<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>TextView<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">Button<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> TextView textView <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> Button btnDownload <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> Handler uiHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"handleMessage thread id "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"msg.arg1:"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"msg.arg2:"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>                    MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶ä¸‹è½½å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        textView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>textView<span class="token punctuation">)</span><span class="token punctuation">;</span>        btnDownload <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnDownload<span class="token punctuation">)</span><span class="token punctuation">;</span>        btnDownload<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MainThread id "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>        DownLoadThread downLoadThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DownLoadThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        downLoadThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">class</span> <span class="token class-name">DownLoadThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DownloadThread id "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹ä¸‹è½½æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä¸‹è½½å®Œæˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// æ–‡ä»¶ä¸‹è½½å®Œæˆåæ›´æ–° UI</span>                Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                msg<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>                msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> <span class="token number">456</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç»™ obj èµ‹å€¼ Object ç±»å‹ä¼ é€’å‘ Message ä¼ å…¥ä»»æ„æ•°æ®</span>                <span class="token comment" spellcheck="true">//msg.obj = null;</span>                <span class="token comment" spellcheck="true">// MainActivity.this.textView.setText("æ–‡ä»¶ä¸‹è½½å®Œæˆ");</span>                <span class="token comment" spellcheck="true">/* Runnable runnable = new Runnable() {                    @Override                    public void run() {                        System.out.println("RunnableThread id " + Thread.currentThread().getId());                        MainActivity.this.textView.setText("æ–‡ä»¶ä¸‹è½½å®Œæˆ");                    }                };                uiHandler.post(runnable);*/</span>                uiHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-2-æ‰§è¡Œç»“æœ"><a href="#2-2-2-æ‰§è¡Œç»“æœ" class="headerlink" title="2.2.2 æ‰§è¡Œç»“æœ"></a>2.2.2 æ‰§è¡Œç»“æœ</h3><pre class=" language-java"><code class="language-java"><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">16.613</span> <span class="token number">19652</span><span class="token operator">-</span><span class="token number">19652</span><span class="token operator">/</span><span class="token operator">?</span> I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> MainThread id <span class="token number">2</span><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">19.431</span> <span class="token number">19652</span><span class="token operator">-</span><span class="token number">19692</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> DownloadThread id <span class="token number">2493</span><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">19.431</span> <span class="token number">19652</span><span class="token operator">-</span><span class="token number">19692</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> å¼€å§‹ä¸‹è½½æ–‡ä»¶<span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">24.432</span> <span class="token number">19652</span><span class="token operator">-</span><span class="token number">19692</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> ä¸‹è½½å®Œæˆ<span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">24.434</span> <span class="token number">19652</span><span class="token operator">-</span><span class="token number">19652</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> handleMessage thread id <span class="token number">2</span><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">24.434</span> <span class="token number">19652</span><span class="token operator">-</span><span class="token number">19652</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> msg<span class="token punctuation">.</span>arg1<span class="token operator">:</span><span class="token number">123</span><span class="token number">2018</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">24.435</span> <span class="token number">19652</span><span class="token operator">-</span><span class="token number">19652</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>handlerdemo I<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span> msg<span class="token punctuation">.</span>arg2<span class="token operator">:</span><span class="token number">456</span></code></pre><h3 id="2-2-3-ç»“æœåˆ†æ"><a href="#2-2-3-ç»“æœåˆ†æ" class="headerlink" title="2.2.3 ç»“æœåˆ†æ"></a>2.2.3 ç»“æœåˆ†æ</h3><p>é€šè¿‡ Message ä¸ Handler è¿›è¡Œé€šä¿¡çš„æ­¥éª¤æ˜¯ï¼š</p><ol><li><p>é‡å†™ Handler çš„ handleMessage æ–¹æ³•ï¼Œæ ¹æ® Message çš„ what å€¼è¿›è¡Œä¸åŒçš„å¤„ç†æ“ä½œï¼› </p></li><li><p>è®¾ç½® Message çš„ what å€¼ï¼šMessage.what æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ª Message çš„è¯†åˆ«ç ï¼Œä»¥ä¾¿äºåœ¨ Handler çš„ handleMessage æ–¹æ³•ä¸­æ ¹æ® what     è¯†åˆ«å‡ºä¸åŒçš„ Message ï¼Œä»¥ä¾¿æˆ‘ä»¬åšå‡ºä¸åŒçš„å¤„ç†æ“ä½œï¼›</p></li><li><p>è®¾ç½® Message çš„æ‰€æºå¸¦çš„æ•°æ®ï¼Œç®€å•æ•°æ®å¯ä»¥é€šè¿‡ä¸¤ä¸ª int ç±»å‹çš„ field ï¼šarg1 å’Œ arg2 æ¥èµ‹å€¼ï¼Œå¹¶å¯ä»¥åœ¨ handleMessage ä¸­è¯»å–ï¼›</p></li><li><p>å¦‚æœ Message éœ€è¦æºå¸¦å¤æ‚çš„æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥è®¾ç½® Message çš„ obj å­—æ®µï¼Œobj æ˜¯ Object ç±»å‹ï¼Œå¯ä»¥èµ‹äºˆä»»æ„ç±»å‹çš„æ•°æ®ï¼›</p></li><li><p>æˆ‘ä»¬é€šè¿‡ Handler.sendMessage(Message) æ–¹æ³•å°† Message ä¼ å…¥ Handler ä¸­è®©å…¶åœ¨ handleMessage ä¸­å¯¹å…¶è¿›è¡Œå¤„ç†ï¼›</p></li><li><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœåœ¨ handleMessage ä¸­ä¸éœ€è¦åˆ¤æ–­ Message ç±»å‹ï¼Œé‚£ä¹ˆå°±æ— é¡»è®¾ç½® Message çš„ what å€¼ï¼›è€Œä¸”è®© Message æºå¸¦æ•°æ®ä¹Ÿä¸æ˜¯å¿…é¡»çš„ï¼Œåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™æ‰éœ€è¦è®©å…¶æºå¸¦æ•°æ®ï¼›å¦‚æœç¡®å®éœ€è¦è®© Message æºå¸¦æ•°æ®ï¼Œåº”è¯¥å°½é‡ä½¿ç”¨ arg1 æˆ– arg2 æˆ–ä¸¤è€…ï¼Œèƒ½ç”¨ arg1 å’Œ arg2 è§£å†³çš„è¯å°±ä¸è¦ç”¨objï¼Œå› ä¸ºç”¨ arg1 å’Œ arg2 æ›´é«˜æ•ˆã€‚</p></li><li><p>ç”±ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œ handleMessage çš„çº¿ç¨‹ä¸åˆ›å»º Handler çš„çº¿ç¨‹æ˜¯åŒä¸€çº¿ç¨‹ï¼Œåœ¨æœ¬ç¤ºä¾‹ä¸­éƒ½æ˜¯ä¸»çº¿ç¨‹ã€‚æ‰§è¡Œ handleMessage çš„çº¿ç¨‹ä¸æ‰§è¡Œ uiHandler.sendMessage(msg) çš„çº¿ç¨‹æ²¡æœ‰å…³ç³»ã€‚</p></li></ol><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>ç›¸å…³æ¨èï¼š<a href="https://superandroid.pro/2019/12/31/00.thinking-in-android-01.bo-ke-suo-yin/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ ¸å¿ƒæœºåˆ¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Handler </tag>
            
            <tag> UI æ›´æ–° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¸¦ä½ é¢†ç•¥ Android å†…å­˜æ³„æ¼çš„å‰ä¸–ä»Šç”Ÿ</title>
      <link href="/2018/09/03/07.xing-neng-you-hua-xi-lie-dai-ni-ling-lue-android-nei-cun-xie-lou-de-qian-shi-jin-sheng/"/>
      <url>/2018/09/03/07.xing-neng-you-hua-xi-lie-dai-ni-ling-lue-android-nei-cun-xie-lou-de-qian-shi-jin-sheng/</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºç¡€äº†è§£"><a href="#åŸºç¡€äº†è§£" class="headerlink" title="åŸºç¡€äº†è§£"></a>åŸºç¡€äº†è§£</h1><h2 id="ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ</h2><p>å†…å­˜æ³„æ¼æ˜¯å½“ç¨‹åºä¸å†ä½¿ç”¨åˆ°çš„å†…å­˜æ—¶ï¼Œé‡Šæ”¾å†…å­˜å¤±è´¥è€Œäº§ç”Ÿäº†æ— ç”¨çš„å†…å­˜æ¶ˆè€—ã€‚å†…å­˜æ³„æ¼å¹¶ä¸æ˜¯æŒ‡ç‰©ç†ä¸Šçš„å†…å­˜æ¶ˆå¤±ï¼Œè¿™é‡Œçš„å†…å­˜æ³„æ¼æ˜¯æŒ‡ç”±ç¨‹åºåˆ†é…çš„å†…å­˜ä½†æ˜¯ç”±äºç¨‹åºé€»è¾‘é”™è¯¯è€Œå¯¼è‡´ç¨‹åºå¤±å»äº†å¯¹è¯¥å†…å­˜çš„æ§åˆ¶ï¼Œä½¿å¾—å†…å­˜æµªè´¹ã€‚</p><h2 id="Java-å†…å­˜åˆ†é…ç­–ç•¥"><a href="#Java-å†…å­˜åˆ†é…ç­–ç•¥" class="headerlink" title="Java å†…å­˜åˆ†é…ç­–ç•¥"></a>Java å†…å­˜åˆ†é…ç­–ç•¥</h2><p>Java ç¨‹åºè¿è¡Œæ—¶çš„å†…å­˜åˆ†é…ç­–ç•¥æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ <strong><font color="#FF00FF">é™æ€åˆ†é…</font></strong>ã€<strong><font color="#FF00FF">æ ˆå¼åˆ†é…</font></strong> å’Œ <strong><font color="#FF00FF">å †å¼åˆ†é…</font></strong>ï¼Œå¯¹åº”çš„ä¸‰ç§å­˜å‚¨ç­–ç•¥ä½¿ç”¨çš„å†…å­˜ç©ºé—´ä¸»è¦åˆ†åˆ«æ˜¯ <strong><font color="#FF00FF">é™æ€å­˜å‚¨åŒºï¼ˆä¹Ÿç§°æ–¹æ³•åŒºï¼‰</font></strong>ã€<strong><font color="#FF00FF">æ ˆåŒº</font></strong> å’Œ <strong><font color="#FF00FF">å †åŒº</font></strong>ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° <strong>é™æ€å­˜å‚¨åŒºï¼ˆæ–¹æ³•åŒºï¼‰</strong>ï¼šä¸»è¦å­˜æ”¾ <u><strong>é™æ€æ•°æ®</strong></u>ã€<u><strong>å…¨å±€ static æ•°æ®</strong></u> å’Œ <u><strong>å¸¸é‡</strong></u>ã€‚è¿™å—å†…å­˜åœ¨ç¨‹åºç¼–è¯‘æ—¶å°±å·²ç»åˆ†é…å¥½ï¼Œå¹¶ä¸”åœ¨ç¨‹åºæ•´ä¸ªè¿è¡ŒæœŸé—´éƒ½å­˜åœ¨ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° <strong>æ ˆåŒº</strong>ï¼šå½“æ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œæ–¹æ³•ä½“å†…çš„ <u><strong>å±€éƒ¨å˜é‡</strong></u>ï¼ˆå…¶ä¸­åŒ…æ‹¬åŸºç¡€æ•°æ®ç±»å‹ã€å¯¹è±¡çš„å¼•ç”¨ï¼‰éƒ½åœ¨æ ˆä¸Šåˆ›å»ºï¼Œå¹¶åœ¨æ–¹æ³•æ‰§è¡Œç»“æŸæ—¶è¿™äº›å±€éƒ¨å˜é‡æ‰€æŒæœ‰çš„å†…å­˜å°†ä¼šè‡ªåŠ¨è¢«é‡Šæ”¾ã€‚å› ä¸ºæ ˆå†…å­˜åˆ†é…è¿ç®—å†…ç½®äºå¤„ç†å™¨çš„æŒ‡ä»¤é›†ä¸­ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯åˆ†é…çš„å†…å­˜å®¹é‡æœ‰é™ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° <strong>å †åŒº</strong>ï¼š åˆç§°åŠ¨æ€å†…å­˜åˆ†é…ï¼Œé€šå¸¸å°±æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œæ—¶ç›´æ¥ new å‡ºæ¥çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ <u><strong>å¯¹è±¡çš„å®ä¾‹</strong></u>ã€‚è¿™éƒ¨åˆ†å†…å­˜åœ¨ä¸ä½¿ç”¨æ—¶å°†ä¼šç”± Java åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰æ¥è´Ÿè´£å›æ”¶ã€‚</p><h2 id="æ ˆä¸å †çš„åŒºåˆ«"><a href="#æ ˆä¸å †çš„åŒºåˆ«" class="headerlink" title="æ ˆä¸å †çš„åŒºåˆ«"></a>æ ˆä¸å †çš„åŒºåˆ«</h2><p>åœ¨æ–¹æ³•ä½“å†…å®šä¹‰çš„ï¼ˆå±€éƒ¨å˜é‡ï¼‰ä¸€äº›åŸºæœ¬ç±»å‹çš„å˜é‡å’Œå¯¹è±¡çš„å¼•ç”¨å˜é‡éƒ½æ˜¯åœ¨æ–¹æ³•çš„æ ˆå†…å­˜ä¸­åˆ†é…çš„ã€‚å½“åœ¨ä¸€æ®µæ–¹æ³•å—ä¸­å®šä¹‰ä¸€ä¸ªå˜é‡æ—¶ï¼ŒJava å°±ä¼šåœ¨æ ˆä¸­ä¸ºè¯¥å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå½“è¶…è¿‡è¯¥å˜é‡çš„ä½œç”¨åŸŸåï¼Œè¯¥å˜é‡ä¹Ÿå°±æ— æ•ˆäº†ï¼Œåˆ†é…ç»™å®ƒçš„å†…å­˜ç©ºé—´ä¹Ÿå°†è¢«é‡Šæ”¾æ‰ï¼Œè¯¥å†…å­˜ç©ºé—´å¯ä»¥è¢«é‡æ–°ä½¿ç”¨ã€‚</p><p>å †å†…å­˜ç”¨æ¥å­˜æ”¾æ‰€æœ‰ç”± new åˆ›å»ºçš„å¯¹è±¡ï¼ˆåŒ…æ‹¬è¯¥å¯¹è±¡å…¶ä¸­çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼‰å’Œæ•°ç»„ã€‚åœ¨å †ä¸­åˆ†é…çš„å†…å­˜ï¼Œå°†ç”± Java åƒåœ¾å›æ”¶å™¨æ¥è‡ªåŠ¨ç®¡ç†ã€‚åœ¨å †ä¸­äº§ç”Ÿäº†ä¸€ä¸ªæ•°ç»„æˆ–è€…å¯¹è±¡åï¼Œè¿˜å¯ä»¥åœ¨æ ˆä¸­å®šä¹‰ä¸€ä¸ªç‰¹æ®Šçš„å˜é‡ï¼Œè¿™ä¸ªå˜é‡çš„å–å€¼ç­‰äºæ•°ç»„æˆ–è€…å¯¹è±¡åœ¨å †å†…å­˜ä¸­çš„é¦–åœ°å€ï¼Œè¿™ä¸ªç‰¹æ®Šçš„å˜é‡å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„å¼•ç”¨å˜é‡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå¼•ç”¨å˜é‡æ¥è®¿é—®å †ä¸­çš„å¯¹è±¡æˆ–è€…æ•°ç»„ã€‚</p><p>ä¸¾ä¾‹è¯´æ˜ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Sample</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> s1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    Sample mSample1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> s2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        Sample mSample2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Sample ç±»çš„å±€éƒ¨å˜é‡ s2 å’Œå¼•ç”¨å˜é‡ mSample2 éƒ½æ˜¯å­˜åœ¨äºæ ˆä¸­ï¼Œä½† mSample2 æŒ‡å‘çš„å¯¹è±¡æ˜¯å­˜åœ¨äºå †ä¸Š</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>Sample mSample3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// mSample3 æŒ‡å‘çš„å¯¹è±¡å®ä½“å­˜æ”¾åœ¨å †ä¸Šï¼ŒåŒ…æ‹¬è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰æˆå‘˜å˜é‡ s1 å’Œ mSample1ï¼Œè€Œå®ƒè‡ªå·±å­˜åœ¨äºæ ˆä¸­ã€‚</span></code></pre><h2 id="Javaæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜"><a href="#Javaæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜" class="headerlink" title="Javaæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜"></a>Javaæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜</h2><p>Javaçš„å†…å­˜ç®¡ç†å°±æ˜¯å¯¹è±¡çš„åˆ†é…å’Œé‡Šæ”¾é—®é¢˜ã€‚åœ¨ Java ä¸­ï¼Œç¨‹åºå‘˜éœ€è¦é€šè¿‡å…³é”®å­— new ä¸ºæ¯ä¸ªå¯¹è±¡ç”³è¯·å†…å­˜ç©ºé—´ (åŸºæœ¬ç±»å‹é™¤å¤–)ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨å † (Heap)ä¸­åˆ†é…ç©ºé—´ã€‚å¦å¤–ï¼Œå¯¹è±¡çš„é‡Šæ”¾æ˜¯ç”± GC å†³å®šå’Œæ‰§è¡Œçš„ã€‚åœ¨ Java ä¸­ï¼Œå†…å­˜çš„åˆ†é…æ˜¯ç”±ç¨‹åºå®Œæˆçš„ï¼Œè€Œå†…å­˜çš„é‡Šæ”¾æ˜¯ç”± GC å®Œæˆçš„ï¼Œè¿™ç§æ”¶æ”¯ä¸¤æ¡çº¿çš„æ–¹æ³•ç¡®å®ç®€åŒ–äº†ç¨‹åºå‘˜çš„å·¥ä½œã€‚ä½†åŒæ—¶ï¼Œå®ƒä¹ŸåŠ é‡äº†JVMçš„å·¥ä½œã€‚è¿™ä¹Ÿæ˜¯ Java ç¨‹åºè¿è¡Œé€Ÿåº¦è¾ƒæ…¢çš„åŸå› ä¹‹ä¸€ã€‚å› ä¸ºï¼ŒGC ä¸ºäº†èƒ½å¤Ÿæ­£ç¡®é‡Šæ”¾å¯¹è±¡ï¼ŒGC å¿…é¡»ç›‘æ§æ¯ä¸€ä¸ªå¯¹è±¡çš„è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬å¯¹è±¡çš„ç”³è¯·ã€å¼•ç”¨ã€è¢«å¼•ç”¨ã€èµ‹å€¼ç­‰ï¼ŒGC éƒ½éœ€è¦è¿›è¡Œç›‘æ§ã€‚</p><p>ç›‘è§†å¯¹è±¡çŠ¶æ€æ˜¯ä¸ºäº†æ›´åŠ å‡†ç¡®åœ°ã€åŠæ—¶åœ°é‡Šæ”¾å¯¹è±¡ï¼Œè€Œé‡Šæ”¾å¯¹è±¡çš„æ ¹æœ¬åŸåˆ™å°±æ˜¯è¯¥å¯¹è±¡ä¸å†è¢«å¼•ç”¨ã€‚</p><h2 id="Javaä¸­çš„å†…å­˜æ³„æ¼"><a href="#Javaä¸­çš„å†…å­˜æ³„æ¼" class="headerlink" title="Javaä¸­çš„å†…å­˜æ³„æ¼"></a>Javaä¸­çš„å†…å­˜æ³„æ¼</h2><p>åœ¨Javaä¸­ï¼Œå†…å­˜æ³„æ¼å°±æ˜¯å­˜åœ¨ä¸€äº›è¢«åˆ†é…çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡æœ‰ä¸‹é¢ä¸¤ä¸ªç‰¹ç‚¹ï¼Œé¦–å…ˆï¼Œè¿™äº›å¯¹è±¡æ˜¯å¯è¾¾çš„ï¼Œå³åœ¨æœ‰å‘å›¾ä¸­ï¼Œå­˜åœ¨é€šè·¯å¯ä»¥ä¸å…¶ç›¸è¿ï¼›å…¶æ¬¡ï¼Œè¿™äº›å¯¹è±¡æ˜¯æ— ç”¨çš„ï¼Œå³ç¨‹åºä»¥åä¸ä¼šå†ä½¿ç”¨è¿™äº›å¯¹è±¡ã€‚å¦‚æœå¯¹è±¡æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œè¿™äº›å¯¹è±¡å°±å¯ä»¥åˆ¤å®šä¸ºJavaä¸­çš„å†…å­˜æ³„æ¼ï¼Œè¿™äº›å¯¹è±¡ä¸ä¼šè¢«GCæ‰€å›æ”¶ï¼Œç„¶è€Œå®ƒå´å ç”¨å†…å­˜ã€‚</p><p>åœ¨C++ä¸­ï¼Œå†…å­˜æ³„æ¼çš„èŒƒå›´æ›´å¤§ä¸€äº›ã€‚æœ‰äº›å¯¹è±¡è¢«åˆ†é…äº†å†…å­˜ç©ºé—´ï¼Œç„¶åå´ä¸å¯è¾¾ï¼Œç”±äºC++ä¸­æ²¡æœ‰GCï¼Œè¿™äº›å†…å­˜å°†æ°¸è¿œæ”¶ä¸å›æ¥ã€‚åœ¨Javaä¸­ï¼Œè¿™äº›ä¸å¯è¾¾çš„å¯¹è±¡éƒ½ç”±GCè´Ÿè´£å›æ”¶ï¼Œå› æ­¤ç¨‹åºå‘˜ä¸éœ€è¦è€ƒè™‘è¿™éƒ¨åˆ†çš„å†…å­˜æ³„éœ²ã€‚</p><p>é€šè¿‡åˆ†æï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼Œå¯¹äºC++ï¼Œç¨‹åºå‘˜éœ€è¦è‡ªå·±ç®¡ç†è¾¹å’Œé¡¶ç‚¹ï¼Œè€Œå¯¹äºJavaç¨‹åºå‘˜åªéœ€è¦ç®¡ç†è¾¹å°±å¯ä»¥äº†(ä¸éœ€è¦ç®¡ç†é¡¶ç‚¹çš„é‡Šæ”¾)ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒJavaæé«˜äº†ç¼–ç¨‹çš„æ•ˆç‡ã€‚</p><p>å› æ­¤ï¼Œé€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬çŸ¥é“åœ¨Javaä¸­ä¹Ÿæœ‰å†…å­˜æ³„æ¼ï¼Œä½†èŒƒå›´æ¯”C++è¦å°ä¸€äº›ã€‚å› ä¸ºJavaä»è¯­è¨€ä¸Šä¿è¯ï¼Œä»»ä½•å¯¹è±¡éƒ½æ˜¯å¯è¾¾çš„ï¼Œæ‰€æœ‰çš„ä¸å¯è¾¾å¯¹è±¡éƒ½ç”±GCç®¡ç†ã€‚</p><p>å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼ŒGCåŸºæœ¬æ˜¯é€æ˜çš„ï¼Œä¸å¯è§çš„ã€‚è™½ç„¶ï¼Œæˆ‘ä»¬åªæœ‰å‡ ä¸ªå‡½æ•°å¯ä»¥è®¿é—®GCï¼Œä¾‹å¦‚è¿è¡ŒGCçš„å‡½æ•°System.gc()ï¼Œä½†æ˜¯æ ¹æ®Javaè¯­è¨€è§„èŒƒå®šä¹‰ï¼Œ è¯¥å‡½æ•°ä¸ä¿è¯JVMçš„åƒåœ¾æ”¶é›†å™¨ä¸€å®šä¼šæ‰§è¡Œã€‚å› ä¸ºï¼Œä¸åŒçš„JVMå®ç°è€…å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç®—æ³•ç®¡ç†GCã€‚é€šå¸¸ï¼ŒGCçš„çº¿ç¨‹çš„ä¼˜å…ˆçº§åˆ«è¾ƒä½ã€‚JVMè°ƒç”¨GCçš„ç­–ç•¥ä¹Ÿæœ‰å¾ˆå¤šç§ï¼Œæœ‰çš„æ˜¯å†…å­˜ä½¿ç”¨åˆ°è¾¾ä¸€å®šç¨‹åº¦æ—¶ï¼ŒGCæ‰å¼€å§‹å·¥ä½œï¼Œä¹Ÿæœ‰å®šæ—¶æ‰§è¡Œçš„ï¼Œæœ‰çš„æ˜¯å¹³ç¼“æ‰§è¡ŒGCï¼Œæœ‰çš„æ˜¯ä¸­æ–­å¼æ‰§è¡ŒGCã€‚ä½†é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒè¿™äº›ã€‚é™¤éåœ¨ä¸€äº›ç‰¹å®šçš„åœºåˆï¼ŒGCçš„æ‰§è¡Œå½±å“åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œä¾‹å¦‚å¯¹äºåŸºäºWebçš„å®æ—¶ç³»ç»Ÿï¼Œå¦‚ç½‘ç»œæ¸¸æˆç­‰ï¼Œç”¨æˆ·ä¸å¸Œæœ›GCçªç„¶ä¸­æ–­åº”ç”¨ç¨‹åºæ‰§è¡Œè€Œè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è°ƒæ•´GCçš„å‚æ•°ï¼Œè®©GCèƒ½å¤Ÿé€šè¿‡å¹³ç¼“çš„æ–¹å¼é‡Šæ”¾å†…å­˜ï¼Œä¾‹å¦‚å°†åƒåœ¾å›æ”¶åˆ†è§£ä¸ºä¸€ç³»åˆ—çš„å°æ­¥éª¤æ‰§è¡Œï¼ŒSunæä¾›çš„HotSpot JVMå°±æ”¯æŒè¿™ä¸€ç‰¹æ€§ã€‚</p><p>ä»¥ä¸‹ç»™å‡ºä¸€ä¸ª Java å†…å­˜æ³„æ¼çš„å…¸å‹ä¾‹å­ï¼š</p><pre class=" language-java"><code class="language-java">Vector v <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    v<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>    o <span class="token operator">=</span> null<span class="token punctuation">;</span>   <span class="token punctuation">}</span></code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¾ªç¯ç”³è¯·Objectå¯¹è±¡ï¼Œå¹¶å°†æ‰€ç”³è¯·çš„å¯¹è±¡æ”¾å…¥ä¸€ä¸ª Vector ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä»…ä»…é‡Šæ”¾å¼•ç”¨æœ¬èº«ï¼Œé‚£ä¹ˆ Vector ä»ç„¶å¼•ç”¨è¯¥å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªå¯¹è±¡å¯¹ GC æ¥è¯´æ˜¯ä¸å¯å›æ”¶çš„ã€‚å› æ­¤ï¼Œå¦‚æœå¯¹è±¡åŠ å…¥åˆ°Vector åï¼Œè¿˜å¿…é¡»ä» Vector ä¸­åˆ é™¤ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å°† Vector å¯¹è±¡è®¾ç½®ä¸º nullã€‚</p><h1 id="å¸¸è§å†…å­˜æ³„æ¼"><a href="#å¸¸è§å†…å­˜æ³„æ¼" class="headerlink" title="å¸¸è§å†…å­˜æ³„æ¼"></a>å¸¸è§å†…å­˜æ³„æ¼</h1><h2 id="æ°¸è¿œçš„å•ä¾‹"><a href="#æ°¸è¿œçš„å•ä¾‹" class="headerlink" title="æ°¸è¿œçš„å•ä¾‹"></a>æ°¸è¿œçš„å•ä¾‹</h2><p>å•ä¾‹çš„ä½¿ç”¨åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­éšå¤„å¯è§ï¼Œå› ä¸ºä½¿ç”¨å®ƒå¯ä»¥å®Œç¾çš„è§£å†³æˆ‘ä»¬åœ¨ç¨‹åºä¸­é‡å¤åˆ›å»ºå¯¹è±¡çš„é—®é¢˜ï¼Œä¸è¿‡å¯åˆ«å°ç§å®ƒã€‚ç”±äº <strong><font color="#CAFF70">å•ä¾‹çš„é™æ€ç‰¹æ€§ä½¿å¾—å…¶ç”Ÿå‘½å‘¨æœŸè·Ÿåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿</font></strong>ï¼Œæ‰€ä»¥ä¸€æ—¦ä½¿ç”¨æœ‰è¯¯ï¼Œå°å¿ƒæ— é™åˆ¶çš„æŒæœ‰Activityçš„å¼•ç”¨è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppManager</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> AppManager instance<span class="token punctuation">;</span>    <span class="token keyword">private</span> Context context<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">AppManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> AppManager <span class="token function">getInstance</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„å•ä¾‹æ¨¡å¼ï¼Œå½“åˆ›å»ºè¿™ä¸ªå•ä¾‹çš„æ—¶å€™ï¼Œç”±äºéœ€è¦ä¼ å…¥ä¸€ä¸ªContextï¼Œæ‰€ä»¥è¿™ä¸ªContextçš„ç”Ÿå‘½å‘¨æœŸçš„é•¿çŸ­è‡³å…³é‡è¦ï¼<strong><font color="#FF0000">ï¼ˆå®é™…å¸¸è§ï¼‰</font></strong></p><p>1ã€å¦‚æœæ­¤æ—¶ä¼ å…¥çš„æ˜¯ <font color="#BA55D3">Application çš„ Context</font>ï¼Œå› ä¸º Application çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯æ•´ä¸ªåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥è¿™å°†æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</p><p>2ã€å¦‚æœæ­¤æ—¶ä¼ å…¥çš„æ˜¯ <font color="#BA55D3">Activity çš„ Context</font>ï¼Œå½“è¿™ä¸ª Context æ‰€å¯¹åº”çš„ Activity é€€å‡ºæ—¶ï¼Œç”±äºè¯¥ Context çš„å¼•ç”¨è¢«å•ä¾‹å¯¹è±¡æ‰€æŒæœ‰ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸç­‰äºæ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥å½“å‰ Activity é€€å‡ºæ—¶å®ƒçš„å†…å­˜å¹¶ä¸ä¼šè¢«å›æ”¶ï¼Œè¿™å°±é€ æˆæ³„æ¼äº†ã€‚</p><p><strong><font color="#FFFFFF">æ­£ç¡®çš„æ–¹å¼ï¼ˆå†™æ³•ä¸€ï¼‰ï¼š</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppManager</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> AppManager instance<span class="token punctuation">;</span>    <span class="token keyword">private</span> Context context<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">AppManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä½¿ç”¨ Application çš„ context</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> AppManager <span class="token function">getInstance</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FFFFFF">æ­£ç¡®çš„æ–¹å¼ï¼ˆå†™æ³•äºŒï¼‰ï¼š</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// åœ¨ä½ çš„ Application ä¸­æ·»åŠ ä¸€ä¸ªé™æ€æ–¹æ³•ï¼ŒgetContext() è¿”å› Application çš„ context</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token comment" spellcheck="true">/**     * è·å–å…¨å±€çš„context     * @return è¿”å›å…¨å±€contextå¯¹è±¡     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Context <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> context<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppManager</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> AppManager instance<span class="token punctuation">;</span>    <span class="token keyword">private</span> Context context<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">AppManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> MyApplication<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä½¿ç”¨Application çš„context</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> AppManager <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="é™æ€Activity"><a href="#é™æ€Activity" class="headerlink" title="é™æ€Activity"></a>é™æ€Activity</h2><p>æˆ‘ä»¬çœ‹ä¸€æ®µä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> MainActivity activity<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// è¿™è¾¹è®¾ç½®äº†é™æ€Activityï¼Œå‘ç”Ÿäº†å†…å­˜æ³„æ¼</span>    TextView saButton<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        saButton <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>        saButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">setStaticActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">nextActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">void</span> <span class="token function">setStaticActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        activity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">void</span> <span class="token function">nextActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>RegisterActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SystemClock<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªé™æ€çš„ Activity å˜é‡å¹¶ä¸”åœ¨ TextView çš„ OnClick äº‹ä»¶é‡Œå¼•ç”¨äº†å½“å‰æ­£åœ¨è¿è¡Œçš„ Activity å®ä¾‹ï¼Œæ‰€ä»¥å¦‚æœåœ¨ activity çš„ç”Ÿå‘½å‘¨æœŸç»“æŸä¹‹å‰æ²¡æœ‰æ¸…é™¤è¿™ä¸ªå¼•ç”¨ï¼Œåˆ™ä¼šå¼•èµ·å†…å­˜æ³„æ¼ã€‚å› ä¸ºå£°æ˜çš„ activity æ˜¯é™æ€çš„ï¼Œä¼šå¸¸é©»å†…å­˜ï¼Œå¦‚æœè¯¥å¯¹è±¡ä¸æ¸…é™¤ï¼Œåˆ™åƒåœ¾å›æ”¶å™¨æ— æ³•å›æ”¶å˜é‡ã€‚</p><p><strong><font color="#FFFFFF">æˆ‘ä»¬å¯ä»¥è¿™æ ·è§£å†³ï¼š</font></strong></p><pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        activity <span class="token operator">=</span> null<span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// åœ¨onDestoryæ–¹æ³•ä¸­å°†é™æ€å˜é‡activityç½®ç©ºï¼Œè¿™æ ·åƒåœ¾å›æ”¶å™¨å°±å¯ä»¥å°†é™æ€å˜é‡å›æ”¶</span>    <span class="token punctuation">}</span></code></pre><h2 id="é™æ€View"><a href="#é™æ€View" class="headerlink" title="é™æ€View"></a>é™æ€View</h2><p>å…¶å®å’Œé™æ€Activityé¢‡ä¸ºç›¸ä¼¼ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> View view<span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// å®šä¹‰é™æ€View</span>    TextView saButton<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        saButton <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>        saButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">setStaticView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">nextActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">void</span> <span class="token function">setStaticView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        view <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>sv_view<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>Viewä¸€æ—¦è¢«åŠ è½½åˆ°ç•Œé¢ä¸­å°†ä¼šæŒæœ‰ä¸€ä¸ªContextå¯¹è±¡çš„å¼•ç”¨ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿™ä¸ªcontextå¯¹è±¡æ˜¯æˆ‘ä»¬çš„Activityï¼Œå£°æ˜ä¸€ä¸ªé™æ€å˜é‡å¼•ç”¨è¿™ä¸ªViewï¼Œä¹Ÿå°±å¼•ç”¨äº†activityï¼Œæ‰€ä»¥å½“activityç”Ÿå‘½å‘¨æœŸç»“æŸäº†ï¼Œé™æ€Viewæ²¡æœ‰æ¸…é™¤æ‰ï¼Œè¿˜æŒæœ‰activityçš„å¼•ç”¨ï¼Œå› æ­¤å†…å­˜æ³„æ¼äº†ã€‚</p><p><strong><font color="#FFFFFF">æˆ‘ä»¬å¯ä»¥è¿™æ ·è§£å†³ï¼š</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    view <span class="token operator">=</span> null<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// åœ¨onDestroyæ–¹æ³•é‡Œå°†é™æ€å˜é‡ç½®ç©º</span><span class="token punctuation">}</span> </code></pre><h2 id="åŒ¿åç±»-AsyncTask"><a href="#åŒ¿åç±»-AsyncTask" class="headerlink" title="åŒ¿åç±»/AsyncTask"></a>åŒ¿åç±»/AsyncTask</h2><p>æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">startAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Void<span class="token punctuation">,</span> Void<span class="token punctuation">,</span> Void<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> Void <span class="token function">doInBackground</span><span class="token punctuation">(</span>Void<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        View aicButton <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>at_button<span class="token punctuation">)</span><span class="token punctuation">;</span>        aicButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>             <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">startAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢ä»£ç åœ¨activityä¸­åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åç±» AsyncTaskï¼ŒåŒ¿åç±»å’Œéé™æ€å†…éƒ¨ç±»ç›¸åŒï¼Œä¼šæŒæœ‰å¤–éƒ¨ç±»å¯¹è±¡ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯activityï¼Œå› æ­¤å¦‚æœä½ åœ¨ Activity é‡Œå£°æ˜ä¸”å®ä¾‹åŒ–ä¸€ä¸ªåŒ¿åçš„AsyncTaskå¯¹è±¡ï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œå¦‚æœè¿™ä¸ªçº¿ç¨‹åœ¨Activityé”€æ¯åè¿˜ä¸€ç›´åœ¨åå°æ‰§è¡Œï¼Œé‚£è¿™ä¸ªçº¿ç¨‹ä¼šç»§ç»­æŒæœ‰è¿™ä¸ªActivityçš„å¼•ç”¨ä»è€Œä¸ä¼šè¢«GCå›æ”¶ï¼Œç›´åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæˆã€‚</p><p><strong><font color="#FFFFFF">æˆ‘ä»¬å¯ä»¥è¿™æ ·è§£å†³ï¼š</font></strong></p><p>è‡ªå®šä¹‰é™æ€ AsyncTask ç±»ï¼Œå¹¶ä¸”è®© AsyncTask çš„å‘¨æœŸå’Œ Activity å‘¨æœŸä¿æŒä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯åœ¨ Activity ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è¦å°† AsyncTask cancel æ‰ã€‚</p><h2 id="éé™æ€å†…éƒ¨ç±»"><a href="#éé™æ€å†…éƒ¨ç±»" class="headerlink" title="éé™æ€å†…éƒ¨ç±»"></a>éé™æ€å†…éƒ¨ç±»</h2><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¼šåœ¨å¯åŠ¨é¢‘ç¹çš„Activityä¸­ï¼Œä¸ºäº†é¿å…é‡å¤åˆ›å»ºç›¸åŒçš„æ•°æ®èµ„æºï¼Œå¯èƒ½ä¼šå‡ºç°è¿™ç§å†™æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> TestResource mResource <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>mManager <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            mManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//...</span>    <span class="token punctuation">}</span>    <span class="token keyword">class</span> <span class="token class-name">TestResource</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//...</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢è¿™æ®µä»£ç åœ¨Activityå†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªéé™æ€å†…éƒ¨ç±»çš„å•ä¾‹ï¼ˆmManagerï¼‰ï¼Œæ¯æ¬¡å¯åŠ¨Activityæ—¶éƒ½ä¼šä½¿ç”¨è¯¥å•ä¾‹çš„æ•°æ®ï¼Œè¿™æ ·è™½ç„¶é¿å…äº†èµ„æºçš„é‡å¤åˆ›å»ºï¼Œä¸è¿‡è¿™ç§å†™æ³•å´ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</p><p>å› ä¸ºéé™æ€å†…éƒ¨ç±»é»˜è®¤ä¼šæŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œè€Œè¯¥éé™æ€å†…éƒ¨ç±»åˆåˆ›å»ºäº†ä¸€ä¸ªé™æ€çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨çš„ä¸€æ ·é•¿ï¼Œè¿™å°±å¯¼è‡´äº†è¯¥é™æ€å®ä¾‹ä¸€ç›´ä¼šæŒæœ‰è¯¥Activityçš„å¼•ç”¨ï¼Œå¯¼è‡´Activityçš„å†…å­˜èµ„æºä¸èƒ½æ­£å¸¸å›æ”¶ã€‚</p><p><strong><font color="#FFFFFF">æ­£ç¡®çš„åšæ³•ä¸ºï¼š</font></strong></p><p>å°†è¯¥å†…éƒ¨ç±»è®¾ä¸ºé™æ€å†…éƒ¨ç±»æˆ–å°†è¯¥å†…éƒ¨ç±»æŠ½å–å‡ºæ¥å°è£…æˆä¸€ä¸ªå•ä¾‹ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨Contextï¼Œè¯·æŒ‰ç…§ä¸Šé¢æ¨èçš„ä½¿ç”¨Application çš„ Contextã€‚å½“ç„¶ï¼ŒApplication çš„ context ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½éšä¾¿ä¹±ç”¨ï¼Œå¯¹äºæœ‰äº›åœ°æ–¹åˆ™å¿…é¡»ä½¿ç”¨ Activity çš„ Contextã€‚</p><h2 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h2><p>Handler çš„ä½¿ç”¨é€ æˆçš„å†…å­˜æ³„æ¼é—®é¢˜åº”è¯¥è¯´æ˜¯<strong><font color="#FF0000"> æœ€ä¸ºå¸¸è§ </font></strong>äº†ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¸ºäº†é¿å… ANR è€Œä¸åœ¨ä¸»çº¿ç¨‹è¿›è¡Œè€—æ—¶æ“ä½œï¼Œåœ¨å¤„ç†ç½‘ç»œä»»åŠ¡æˆ–è€…å°è£…ä¸€äº›è¯·æ±‚å›è°ƒç­‰apiéƒ½å€ŸåŠ©Handleræ¥å¤„ç†ï¼Œä½† Handler ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå¯¹äº Handler çš„ä½¿ç”¨ä»£ç ç¼–å†™ä¸è§„èŒƒå³æœ‰å¯èƒ½é€ æˆå†…å­˜æ³„æ¼ã€‚å¦å¤–ï¼Œæˆ‘ä»¬çŸ¥é“ Handlerã€Message å’Œ MessageQueue éƒ½æ˜¯ç›¸äº’å…³è”åœ¨ä¸€èµ·çš„ï¼Œä¸‡ä¸€ Handler å‘é€çš„ Message å°šæœªè¢«å¤„ç†ï¼Œåˆ™è¯¥ Message åŠå‘é€å®ƒçš„ Handler å¯¹è±¡å°†è¢«çº¿ç¨‹ MessageQueue ä¸€ç›´æŒæœ‰ã€‚</p><p>ç”±äº Handler å±äº TLS(Thread Local Storage) å˜é‡, ç”Ÿå‘½å‘¨æœŸå’Œ Activity æ˜¯ä¸ä¸€è‡´çš„ã€‚å› æ­¤è¿™ç§å®ç°æ–¹å¼ä¸€èˆ¬å¾ˆéš¾ä¿è¯è·Ÿ View æˆ–è€… Activity çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ï¼Œæ•…å¾ˆå®¹æ˜“å¯¼è‡´æ— æ³•æ­£ç¡®é‡Šæ”¾ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Handler mLeakyHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// ...</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Post a message and delay its execution for 10 minutes.</span>        mLeakyHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* ... */</span> <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Go back to the previous Activity.</span>        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>åœ¨è¯¥ SampleActivity ä¸­å£°æ˜äº†ä¸€ä¸ªå»¶è¿Ÿ <strong>10åˆ†é’Ÿ</strong> æ‰§è¡Œçš„æ¶ˆæ¯ Messageï¼ŒmLeakyHandler å°†å…¶ push è¿›äº†æ¶ˆæ¯é˜Ÿåˆ— MessageQueue é‡Œã€‚å½“è¯¥ Activity è¢« finish() æ‰æ—¶ï¼Œå»¶è¿Ÿæ‰§è¡Œä»»åŠ¡çš„ Message è¿˜ä¼šç»§ç»­å­˜åœ¨äºä¸»çº¿ç¨‹ä¸­ï¼Œå®ƒæŒæœ‰è¯¥ Activity çš„ Handler å¼•ç”¨ï¼Œæ‰€ä»¥æ­¤æ—¶ finish() æ‰çš„ Activity å°±ä¸ä¼šè¢«å›æ”¶äº†ä»è€Œé€ æˆå†…å­˜æ³„æ¼ï¼ˆå›  Handler ä¸ºéé™æ€å†…éƒ¨ç±»ï¼Œå®ƒä¼šæŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œåœ¨è¿™é‡Œå°±æ˜¯æŒ‡ SampleActivityï¼‰ã€‚</p><p><strong><font color="#FFFFFF">æ­£ç¡®çš„åšæ³•ä¸ºï¼š</font></strong></p><p>åœ¨ Activity ä¸­é¿å…ä½¿ç”¨éé™æ€å†…éƒ¨ç±»ï¼Œæ¯”å¦‚ä¸Šé¢æˆ‘ä»¬å°† Handler å£°æ˜ä¸ºé™æ€çš„ï¼Œåˆ™å…¶å­˜æ´»æœŸè·Ÿ Activity çš„ç”Ÿå‘½å‘¨æœŸå°±æ— å…³äº†ã€‚åŒæ—¶é€šè¿‡å¼±å¼•ç”¨çš„æ–¹å¼å¼•å…¥ Activityï¼Œé¿å…ç›´æ¥å°† Activity ä½œä¸º context ä¼ è¿›å»ï¼Œè§ä¸‹é¢ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">final</span> WeakReference<span class="token operator">&lt;</span>SampleActivity<span class="token operator">></span> mActivity<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">MyHandler</span><span class="token punctuation">(</span>SampleActivity activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mActivity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>SampleActivity<span class="token operator">></span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            SampleActivity activity <span class="token operator">=</span> mActivity<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                              <span class="token comment" spellcheck="true">// æ¯æ¬¡ä½¿ç”¨å‰æ³¨æ„åˆ¤ç©º</span>                <span class="token comment" spellcheck="true">// ...</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> MyHandler mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Runnable sRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* ... */</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Post a message and delay its execution for 10 minutes.</span>        mHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>sRunnable<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Go back to the previous Activity.</span>        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¦‚ä½•é¿å…Handlerå†…å­˜æ³„æ¼ï¼Œæ¨èä½¿ç”¨ â€œé™æ€å†…éƒ¨ç±» + WeakReferenceâ€ è¿™ç§æ–¹å¼ï¼Œæ¯æ¬¡ä½¿ç”¨å‰æ³¨æ„åˆ¤ç©ºã€‚</p><p>Javaå¯¹å¼•ç”¨çš„åˆ†ç±»æœ‰Strong referenceã€SoftReferenceã€WeakReferenceã€PhatomReferenceå››ç§ã€‚</p><table><thead><tr><th>çº§åˆ«</th><th>å›æ”¶æœºåˆ¶</th><th>ç”¨é€”</th><th>ç”Ÿå­˜æ—¶é—´</th></tr></thead><tbody><tr><td>å¼º</td><td>ä»æ¥ä¸ä¼š</td><td>å¯¹è±¡çš„ä¸€èˆ¬çŠ¶æ€</td><td>JVMåœæ­¢è¿è¡Œæ—¶ç»ˆæ­¢</td></tr><tr><td>è½¯</td><td>åœ¨å†…å­˜ä¸è¶³æ—¶</td><td>è”åˆReferenceQueueæ„é€ æœ‰æ•ˆæœŸçŸ­/å å†…å­˜æ‰“/ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡çš„äºŒçº§é«˜é€Ÿç¼“å†²å™¨ï¼ˆå†…å­˜ä¸è¶³æ—¶æ‰æƒ…å†µï¼‰</td><td>å†…å­˜ä¸è¶³æ—¶ç»ˆæ­¢</td></tr><tr><td>å¼±</td><td>åœ¨åƒåœ¾å›æ”¶æ—¶</td><td>è”åˆReferenceQueueæ„é€ æœ‰æ•ˆæœŸçŸ­/å å†…å­˜æ‰“/ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡çš„ä¸€çº§é«˜é€Ÿç¼“å†²å™¨ï¼ˆç³»ç»Ÿå‘ç”Ÿgcæ—¶æ¸…ç©ºï¼‰</td><td>gcè¿è¡Œåç»ˆæ­¢</td></tr><tr><td>è™š</td><td>åœ¨åƒåœ¾å›æ”¶æ—¶</td><td>è”åˆReferenceQueueæ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶æœŸå›æ”¶çš„æ´»åŠ¨</td><td>gcè¿è¡Œåç»ˆæ­¢</td></tr></tbody></table><p>åœ¨Androidåº”ç”¨çš„å¼€å‘ä¸­ï¼Œä¸ºäº†é˜²æ­¢å†…å­˜æº¢å‡ºï¼Œåœ¨å¤„ç†ä¸€äº›å ç”¨å†…å­˜å¤§è€Œä¸”å£°æ˜å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡æ—¶å€™ï¼Œå¯ä»¥å°½é‡åº”ç”¨è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨æŠ€æœ¯ã€‚</p><p>è½¯/å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœè½¯å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼ŒJavaè™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªè½¯å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚åˆ©ç”¨è¿™ä¸ªé˜Ÿåˆ—å¯ä»¥å¾—çŸ¥è¢«å›æ”¶çš„è½¯/å¼±å¼•ç”¨çš„å¯¹è±¡åˆ—è¡¨ï¼Œä»è€Œä¸ºç¼“å†²å™¨æ¸…é™¤å·²å¤±æ•ˆçš„è½¯/å¼±å¼•ç”¨ã€‚</p><h2 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h2><p>çœ‹ä¸ªèŒƒä¾‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">spawnThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        View tButton <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>t_button<span class="token punctuation">)</span><span class="token punctuation">;</span>        tButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">spawnThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å…¶å®è¿™è¾¹å‘ç”Ÿçš„å†…å­˜æ³„æ¼åŸå› è·ŸAsyncTaskæ˜¯ä¸€æ ·çš„ã€‚</p><p><strong><font color="#FFFFFF">æ­£ç¡®çš„åšæ³•ä¸ºï¼š</font></strong></p><p>æˆ‘ä»¬è‡ªå®šä¹‰Threadå¹¶å£°æ˜æˆstaticè¿™æ ·å¯ä»¥å—ï¼Ÿå…¶å®è¿™æ ·çš„åšæ³•å¹¶ä¸æ¨èï¼Œå› ä¸ºThreadä½äºGCæ ¹éƒ¨ï¼ŒDVMä¼šå’Œæ‰€æœ‰çš„æ´»åŠ¨çº¿ç¨‹ä¿æŒhard referenceså…³ç³»ï¼Œæ‰€ä»¥è¿è¡Œä¸­çš„Threadç»ä¸ä¼šè¢«GCæ— ç«¯å›æ”¶äº†ï¼Œæ‰€ä»¥æ­£ç¡®çš„è§£å†³åŠæ³•æ˜¯åœ¨è‡ªå®šä¹‰é™æ€å†…éƒ¨ç±»çš„åŸºç¡€ä¸Šç»™çº¿ç¨‹åŠ ä¸Šå–æ¶ˆæœºåˆ¶ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨Activityçš„onDestroyæ–¹æ³•ä¸­å°†threadå…³é—­æ‰ã€‚</p><h2 id="Timer-Tasks"><a href="#Timer-Tasks" class="headerlink" title="Timer Tasks"></a>Timer Tasks</h2><p>çœ‹ä¸ªèŒƒä¾‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">scheduleTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        View ttButton <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tt_button<span class="token punctuation">)</span><span class="token punctuation">;</span>        ttButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">scheduleTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>è¿™é‡Œå†…å­˜æ³„æ¼åœ¨äºTimerå’ŒTimerTaskæ²¡æœ‰è¿›è¡ŒCancelï¼Œä»è€Œå¯¼è‡´Timerå’ŒTimerTaskä¸€ç›´å¼•ç”¨å¤–éƒ¨ç±»Activityã€‚</p><p><strong><font color="#FFFFFF">æ­£ç¡®çš„åšæ³•ä¸ºï¼š</font></strong></p><p>åœ¨é€‚å½“çš„æ—¶æœºè¿›è¡ŒCancelã€‚</p><h2 id="Sensor-Manager"><a href="#Sensor-Manager" class="headerlink" title="Sensor Manager"></a>Sensor Manager</h2><p>çœ‹ä¸ªèŒƒä¾‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           SensorManager sensorManager <span class="token operator">=</span> <span class="token punctuation">(</span>SensorManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>SENSOR_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>           Sensor sensor <span class="token operator">=</span> sensorManager<span class="token punctuation">.</span><span class="token function">getDefaultSensor</span><span class="token punctuation">(</span>Sensor<span class="token punctuation">.</span>TYPE_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>           sensorManager<span class="token punctuation">.</span><span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sensor<span class="token punctuation">,</span> SensorManager<span class="token punctuation">.</span>SENSOR_DELAY_FASTEST<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        View smButton <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>sm_button<span class="token punctuation">)</span><span class="token punctuation">;</span>        smButton<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>é€šè¿‡Contextè°ƒç”¨getSystemServiceè·å–ç³»ç»ŸæœåŠ¡ï¼Œè¿™äº›æœåŠ¡è¿è¡Œåœ¨ä»–ä»¬è‡ªå·±çš„è¿›ç¨‹æ‰§è¡Œä¸€ç³»åˆ—åå°å·¥ä½œæˆ–è€…æä¾›å’Œç¡¬ä»¶äº¤äº’çš„æ¥å£ï¼Œå¦‚æœContextå¯¹è±¡éœ€è¦åœ¨ä¸€ä¸ªServiceå†…éƒ¨äº‹ä»¶å‘ç”Ÿæ—¶éšæ—¶æ”¶åˆ°é€šçŸ¥ï¼Œåˆ™éœ€è¦æŠŠè‡ªå·±ä½œä¸ºä¸€ä¸ªç›‘å¬å™¨æ³¨å†Œè¿›å»ï¼Œè¿™æ ·æœåŠ¡å°±ä¼šæŒæœ‰ä¸€ä¸ªActivityï¼Œå¦‚æœå¼€å‘è€…å¿˜è®°äº†åœ¨Activityè¢«é”€æ¯å‰æ³¨é”€è¿™ä¸ªç›‘å¬å™¨ï¼Œè¿™æ ·å°±å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p><strong><font color="#FFFFFF">æ­£ç¡®çš„åšæ³•ä¸ºï¼š</font></strong></p><p>åœ¨onDestroyæ–¹æ³•é‡Œæ³¨é”€ç›‘å¬å™¨ã€‚</p><h2 id="å°½é‡é¿å…ä½¿ç”¨-static-æˆå‘˜å˜é‡"><a href="#å°½é‡é¿å…ä½¿ç”¨-static-æˆå‘˜å˜é‡" class="headerlink" title="å°½é‡é¿å…ä½¿ç”¨ static æˆå‘˜å˜é‡"></a>å°½é‡é¿å…ä½¿ç”¨ static æˆå‘˜å˜é‡</h2><p>å¦‚æœæˆå‘˜å˜é‡è¢«å£°æ˜ä¸º staticï¼Œé‚£æˆ‘ä»¬éƒ½çŸ¥é“å…¶ç”Ÿå‘½å‘¨æœŸå°†ä¸æ•´ä¸ªappè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸä¸€æ ·ã€‚</p><p>è¿™ä¼šå¯¼è‡´ä¸€ç³»åˆ—é—®é¢˜ï¼Œå¦‚æœä½ çš„appè¿›ç¨‹è®¾è®¡ä¸Šæ˜¯é•¿é©»å†…å­˜çš„ï¼Œé‚£å³ä½¿appåˆ‡åˆ°åå°ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚æŒ‰ç…§ç°åœ¨æ‰‹æœºappå†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå å†…å­˜è¾ƒå¤§çš„åå°è¿›ç¨‹å°†ä¼˜å…ˆå›æ”¶ï¼Œå¦‚æœæ­¤appåšè¿‡è¿›ç¨‹äº’ä¿ä¿æ´»ï¼Œé‚£ä¼šé€ æˆappåœ¨åå°é¢‘ç¹é‡å¯ã€‚å½“æ‰‹æœºå®‰è£…äº†ä½ å‚ä¸å¼€å‘çš„appä»¥åä¸€å¤œæ—¶é—´æ‰‹æœºè¢«æ¶ˆè€—ç©ºäº†ç”µé‡ã€æµé‡ï¼Œä½ çš„appä¸å¾—ä¸è¢«ç”¨æˆ·å¸è½½æˆ–è€…é™é»˜ã€‚</p><p><strong><font color="#FFFFFF">è¿™é‡Œä¿®å¤çš„æ–¹æ³•æ˜¯ï¼š</font></strong></p><p>ä¸è¦åœ¨ç±»åˆå§‹æ—¶åˆå§‹åŒ–é™æ€æˆå‘˜ã€‚å¯ä»¥è€ƒè™‘lazyåˆå§‹åŒ–ï¼ˆä½¿ç”¨æ—¶åˆå§‹åŒ–ï¼‰ã€‚æ¶æ„è®¾è®¡ä¸Šè¦æ€è€ƒæ˜¯å¦çœŸçš„æœ‰å¿…è¦è¿™æ ·åšï¼Œå°½é‡é¿å…ã€‚å¦‚æœæ¶æ„éœ€è¦è¿™ä¹ˆè®¾è®¡ï¼Œé‚£ä¹ˆæ­¤å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä½ æœ‰è´£ä»»ç®¡ç†èµ·æ¥ã€‚</p><h2 id="é¿å…-override-finalize"><a href="#é¿å…-override-finalize" class="headerlink" title="é¿å… override finalize()"></a>é¿å… override finalize()</h2><p>1ã€finalize æ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶é—´ä¸ç¡®å®šï¼Œä¸èƒ½ä¾èµ–ä¸å®ƒæ¥é‡Šæ”¾ç´§ç¼ºçš„èµ„æºã€‚æ—¶é—´ä¸ç¡®å®šçš„åŸå› æ˜¯ï¼š<br>è™šæ‹Ÿæœºè°ƒç”¨GCçš„æ—¶é—´ä¸ç¡®å®š<br>Finalize daemonçº¿ç¨‹è¢«è°ƒåº¦åˆ°çš„æ—¶é—´ä¸ç¡®å®š</p><p>2ã€finalize æ–¹æ³•åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå³ä½¿å¯¹è±¡è¢«å¤æ´»ï¼Œå¦‚æœå·²ç»æ‰§è¡Œè¿‡äº† finalize æ–¹æ³•ï¼Œå†æ¬¡è¢« GC æ—¶ä¹Ÿä¸ä¼šå†æ‰§è¡Œäº†ï¼ŒåŸå› æ˜¯ï¼š</p><p>å«æœ‰ finalize æ–¹æ³•çš„ object æ˜¯åœ¨ new çš„æ—¶å€™ç”±è™šæ‹Ÿæœºç”Ÿæˆäº†ä¸€ä¸ª finalize reference åœ¨æ¥å¼•ç”¨åˆ°è¯¥Objectçš„ï¼Œè€Œåœ¨ finalize æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œè¯¥ object æ‰€å¯¹åº”çš„ finalize Reference ä¼šè¢«é‡Šæ”¾æ‰ï¼Œå³ä½¿åœ¨è¿™ä¸ªæ—¶å€™æŠŠè¯¥ object å¤æ´»(å³ç”¨å¼ºå¼•ç”¨å¼•ç”¨ä½è¯¥ object )ï¼Œå†ç¬¬äºŒæ¬¡è¢« GC çš„æ—¶å€™ç”±äºæ²¡æœ‰äº† finalize reference ä¸ä¹‹å¯¹åº”ï¼Œæ‰€ä»¥ finalize æ–¹æ³•ä¸ä¼šå†æ‰§è¡Œã€‚</p><p>3ã€å«æœ‰Finalizeæ–¹æ³•çš„objectéœ€è¦è‡³å°‘ç»è¿‡ä¸¤è½®GCæ‰æœ‰å¯èƒ½è¢«é‡Šæ”¾ã€‚</p><h2 id="é›†åˆå¯¹è±¡åŠæ—¶æ¸…é™¤"><a href="#é›†åˆå¯¹è±¡åŠæ—¶æ¸…é™¤" class="headerlink" title="é›†åˆå¯¹è±¡åŠæ—¶æ¸…é™¤"></a>é›†åˆå¯¹è±¡åŠæ—¶æ¸…é™¤</h2><p>æˆ‘ä»¬é€šå¸¸ä¼šæŠŠä¸€äº›å¯¹è±¡çš„å¼•ç”¨åŠ å…¥åˆ°é›†åˆå®¹å™¨ï¼ˆæ¯”å¦‚ArrayListï¼‰ä¸­ï¼Œå½“æˆ‘ä»¬ä¸å†éœ€è¦è¯¥å¯¹è±¡æ—¶ï¼Œå¹¶æ²¡æœ‰æŠŠå®ƒçš„å¼•ç”¨ä»é›†åˆä¸­æ¸…ç†æ‰ï¼Œè¿™æ ·è¿™ä¸ªé›†åˆå°±ä¼šè¶Šæ¥è¶Šå¤§ã€‚å¦‚æœè¿™ä¸ªé›†åˆæ˜¯staticçš„è¯ï¼Œé‚£æƒ…å†µå°±æ›´ä¸¥é‡äº†ã€‚</p><p>æ‰€ä»¥åœ¨é€€å‡ºç¨‹åºä¹‹å‰ï¼Œå°†é›†åˆé‡Œé¢çš„ä¸œè¥¿clearï¼Œç„¶åç½®ä¸ºnullï¼Œå†é€€å‡ºç¨‹åºï¼Œå¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> nameList<span class="token punctuation">;</span><span class="token keyword">private</span> List<span class="token operator">&lt;</span>Fragment<span class="token operator">></span> list<span class="token punctuation">;</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nameList <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        nameList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        nameList <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        list<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="webView"><a href="#webView" class="headerlink" title="webView"></a>webView</h2><p>å½“æˆ‘ä»¬ä¸å†éœ€è¦ä½¿ç”¨webViewçš„æ—¶å€™ï¼Œåº”è¯¥è°ƒç”¨å®ƒçš„destory()æ–¹æ³•æ¥é”€æ¯å®ƒï¼Œå¹¶é‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ï¼Œå¦åˆ™å…¶å ç”¨çš„å†…å­˜é•¿æœŸä¹Ÿä¸èƒ½å›æ”¶ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p><p><strong><font color="#FFFFFF">æ­£ç¡®çš„åšæ³•ä¸ºï¼š</font></strong></p><p>ä¸ºwebViewå¼€å¯å¦å¤–ä¸€ä¸ªè¿›ç¨‹ï¼Œé€šè¿‡AIDLä¸ä¸»çº¿ç¨‹è¿›è¡Œé€šä¿¡ï¼ŒwebViewæ‰€åœ¨çš„è¿›ç¨‹å¯ä»¥æ ¹æ®ä¸šåŠ¡çš„éœ€è¦é€‰æ‹©åˆé€‚çš„æ—¶æœºè¿›è¡Œé”€æ¯ï¼Œä»è€Œè¾¾åˆ°å†…å­˜çš„å®Œæ•´é‡Šæ”¾ã€‚</p><h2 id="èµ„æºæœªå…³é—­"><a href="#èµ„æºæœªå…³é—­" class="headerlink" title="èµ„æºæœªå…³é—­"></a>èµ„æºæœªå…³é—­</h2><p>å¯¹äºä½¿ç”¨äº†BraodcastReceiverï¼ŒContentObserverï¼ŒFileï¼Œæ¸¸æ ‡ Cursorï¼ŒStreamï¼ŒBitmapç­‰èµ„æºçš„ä½¿ç”¨ï¼Œåº”è¯¥åœ¨Activityé”€æ¯æ—¶åŠæ—¶å…³é—­æˆ–è€…æ³¨é”€ï¼Œå¦åˆ™è¿™äº›èµ„æºå°†ä¸ä¼šè¢«å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p><h1 id="æ‹“å±•-â€“-ç›¸å…³çŸ¥è¯†ç‚¹"><a href="#æ‹“å±•-â€“-ç›¸å…³çŸ¥è¯†ç‚¹" class="headerlink" title="æ‹“å±• â€“ ç›¸å…³çŸ¥è¯†ç‚¹"></a>æ‹“å±• â€“ ç›¸å…³çŸ¥è¯†ç‚¹</h1><h2 id="static-å…³é”®å­—"><a href="#static-å…³é”®å­—" class="headerlink" title="static å…³é”®å­—"></a>static å…³é”®å­—</h2><h3 id="ä½¿ç”¨staticå£°æ˜å±æ€§"><a href="#ä½¿ç”¨staticå£°æ˜å±æ€§" class="headerlink" title="ä½¿ç”¨staticå£°æ˜å±æ€§"></a>ä½¿ç”¨staticå£°æ˜å±æ€§</h3><p>å¦‚æœåœ¨ç¨‹åºä¸­ä½¿ç”¨staticå£°æ˜å±æ€§ï¼Œåˆ™æ­¤å±æ€§ç§°ä¸ºå…¨å±€å±æ€§ï¼ˆä¹Ÿç§°é™æ€å±æ€§ï¼‰ï¼Œé‚£ä¹ˆå£°æ˜æˆå…¨å±€å±æ€§æœ‰ä»€ä¹ˆç”¨ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    String name<span class="token punctuation">;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">static</span> String country <span class="token operator">=</span> <span class="token string">"AåŸ"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Person</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å§“åï¼š"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"ï¼Œå¹´é¾„ï¼š"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token string">"ï¼ŒåŸå¸‚ï¼š"</span> <span class="token operator">+</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String agrs<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"å¼ ä¸‰"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"æå››"</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"ç‹äº”"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Person<span class="token punctuation">.</span>country <span class="token operator">=</span> <span class="token string">"BåŸ"</span><span class="token punctuation">;</span>        p1<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p2<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p3<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä»¥ä¸Šç¨‹åºå¾ˆæ¸…æ™°çš„è¯´æ˜äº†staticå£°æ˜å±æ€§çš„å¥½å¤„ï¼Œéœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œç±»çš„å…¬å…±å±æ€§åº”è¯¥ç”±ç±»è¿›è¡Œä¿®æ”¹æ˜¯æœ€åˆé€‚çš„ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥p1.country = â€¦ï¼‰ï¼Œæœ‰æ—¶ä¹Ÿå°±æŠŠä½¿ç”¨staticå£°æ˜çš„å±æ€§ç§°ä¸ºç±»å±æ€§ã€‚</p><h3 id="ä½¿ç”¨staticå£°æ˜æ–¹æ³•"><a href="#ä½¿ç”¨staticå£°æ˜æ–¹æ³•" class="headerlink" title="ä½¿ç”¨staticå£°æ˜æ–¹æ³•"></a>ä½¿ç”¨staticå£°æ˜æ–¹æ³•</h3><p>ç›´æ¥çœ‹ä¸‹ä»£ç å°±æ¸…æ¥šäº†ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String country <span class="token operator">=</span> <span class="token string">"AåŸ"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCountry</span><span class="token punctuation">(</span>String C<span class="token punctuation">)</span> <span class="token punctuation">{</span>        country <span class="token operator">=</span> c<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Person</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å§“åï¼š"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"ï¼Œå¹´é¾„ï¼š"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token string">"ï¼ŒåŸå¸‚ï¼š"</span> <span class="token operator">+</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getCountry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> country<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String agrs<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"å¼ ä¸‰"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"æå››"</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"ç‹äº”"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Person<span class="token punctuation">.</span><span class="token function">setCountry</span><span class="token punctuation">(</span><span class="token string">"BåŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p1<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p2<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p3<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FFFFFF">ã€ç‰¹æ®Šè¯´æ˜ã€‘</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ éstaticå£°æ˜çš„æ–¹æ³•å¯ä»¥è°ƒç”¨staticå£°æ˜çš„å±æ€§æˆ–æ–¹æ³•<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ staticå£°æ˜çš„æ–¹æ³•ä¸èƒ½è°ƒç”¨éstaticå£°æ˜çš„å±æ€§æˆ–æ–¹æ³•</p><p>æ¯”å¦‚ä»¥ä¸‹ä»£ç å°±ä¼šå‡ºé”™ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String country <span class="token operator">=</span> <span class="token string">"AåŸ"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> String name <span class="token operator">=</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sFun</span><span class="token punctuation">(</span>String C<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name = "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// é”™è¯¯ï¼Œä¸èƒ½è°ƒç”¨éstaticå±æ€§</span>        <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment" spellcheck="true">// é”™è¯¯ï¼Œä¸èƒ½è°ƒç”¨éstaticæ–¹æ³•</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"World!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="å†…éƒ¨ç±»"><a href="#å†…éƒ¨ç±»" class="headerlink" title="å†…éƒ¨ç±»"></a>å†…éƒ¨ç±»</h2><h3 id="åŸºæœ¬å®šä¹‰"><a href="#åŸºæœ¬å®šä¹‰" class="headerlink" title="åŸºæœ¬å®šä¹‰"></a>åŸºæœ¬å®šä¹‰</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ç±»å†…éƒ¨å¯ä»¥å®šä¹‰æˆå‘˜å˜é‡ä¸æ–¹æ³•ï¼ŒåŒæ ·ï¼Œåœ¨ç±»å†…éƒ¨ä¹Ÿå¯ä»¥å®šä¹‰å¦ä¸€ä¸ªç±»ã€‚å¦‚æœåœ¨ç±»Outerçš„å†…éƒ¨å®šä¹‰ä¸€ä¸ªç±»Innerï¼Œæ­¤æ—¶ç±»Innerå°±ç§°ä¸ºå†…éƒ¨ç±»ï¼Œè€Œç±»Outeråˆ™ç§°ä¸ºå¤–éƒ¨ç±»ã€‚</p><p>å†…éƒ¨ç±»å¯å£°æ˜æˆ public æˆ– privateã€‚å½“å†…éƒ¨ç±»å£°æ˜æˆ public æˆ– privateæ—¶ï¼Œå¯¹å…¶è®¿é—®çš„é™åˆ¶ä¸æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•å®Œå…¨ç›¸åŒã€‚</p><h3 id="å†…éƒ¨ç±»çš„å®šä¹‰æ ¼å¼"><a href="#å†…éƒ¨ç±»çš„å®šä¹‰æ ¼å¼" class="headerlink" title="å†…éƒ¨ç±»çš„å®šä¹‰æ ¼å¼"></a>å†…éƒ¨ç±»çš„å®šä¹‰æ ¼å¼</h3><pre class=" language-java"><code class="language-java">æ ‡è¯†ç¬¦ <span class="token keyword">class</span> å¤–éƒ¨ç±»çš„åç§° <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// å¤–éƒ¨ç±»çš„æˆå‘˜</span>    æ ‡è¯†ç¬¦ <span class="token keyword">class</span> å†…éƒ¨ç±»çš„åç§° <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å†…éƒ¨ç±»çš„æˆå‘˜</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="å†…éƒ¨ç±»çš„å¥½å¤„"><a href="#å†…éƒ¨ç±»çš„å¥½å¤„" class="headerlink" title="å†…éƒ¨ç±»çš„å¥½å¤„"></a>å†…éƒ¨ç±»çš„å¥½å¤„</h3><p>å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å¤–éƒ¨ç±»ä¸­çš„ç§æœ‰å±æ€§ï¼</p><h2 id="é™æ€å†…éƒ¨ç±»"><a href="#é™æ€å†…éƒ¨ç±»" class="headerlink" title="é™æ€å†…éƒ¨ç±»"></a>é™æ€å†…éƒ¨ç±»</h2><p>ä½¿ç”¨staticå¯ä»¥å£°æ˜å±æ€§æˆ–æ–¹æ³•ï¼Œè€Œä½¿ç”¨staticä¹Ÿå¯ä»¥å£°æ˜å†…éƒ¨ç±»ï¼Œç”¨staticå£°æ˜çš„å†…éƒ¨ç±»å°±å˜æˆäº†å¤–éƒ¨ç±»ï¼Œä½†æ˜¯ç”¨staticå£°æ˜çš„å†…éƒ¨ç±»ä¸èƒ½è®¿é—®éstaticçš„å¤–éƒ¨ç±»å±æ€§ã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹ä¾‹å­ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> String info <span class="token operator">=</span> <span class="token string">"Hello World!!!"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å¦‚æœæ­¤æ—¶infoä¸æ˜¯staticå±æ€§ï¼Œåˆ™ç¨‹åºè¿è¡ŒæŠ¥é”™</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Inner</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerClassDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Outer<span class="token punctuation">.</span>Inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æ‰§è¡Œç»“æœï¼š</p><pre><code>Hello World!!!</code></pre><h2 id="åœ¨å¤–éƒ¨è®¿é—®å†…éƒ¨ç±»"><a href="#åœ¨å¤–éƒ¨è®¿é—®å†…éƒ¨ç±»" class="headerlink" title="åœ¨å¤–éƒ¨è®¿é—®å†…éƒ¨ç±»"></a>åœ¨å¤–éƒ¨è®¿é—®å†…éƒ¨ç±»</h2><p>ä¸€ä¸ªå†…éƒ¨ç±»é™¤äº†å¯ä»¥é€šè¿‡å¤–éƒ¨ç±»è®¿é—®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨å…¶ä»–ç±»ä¸­è¿›è¡Œè°ƒç”¨ã€‚</p><p><strong><font color="#FFFFFF">ã€åœ¨å¤–éƒ¨è®¿é—®å†…éƒ¨ç±»çš„æ ¼å¼ã€‘</font></strong></p><pre class=" language-java"><code class="language-java">å¤–éƒ¨ç±»<span class="token punctuation">.</span>å†…éƒ¨ç±» å†…éƒ¨ç±»å¯¹è±¡ <span class="token operator">=</span> å¤–éƒ¨ç±»å®ä¾‹<span class="token punctuation">.</span><span class="token keyword">new</span> å†…éƒ¨ç±»<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String info <span class="token operator">=</span> <span class="token string">"Hello World!!!"</span><span class="token punctuation">;</span>      <span class="token keyword">class</span> <span class="token class-name">Inner</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerClassDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Outer out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Out</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–å¤–éƒ¨ç±»å¯¹è±¡</span>        Outer<span class="token punctuation">.</span>Inner in <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">Inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–å†…éƒ¨ç±»å¯¹è±¡</span>        in<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// è°ƒç”¨å†…éƒ¨ç±»æ–¹æ³•</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="åœ¨æ–¹æ³•ä¸­å®šä¹‰å†…éƒ¨ç±»"><a href="#åœ¨æ–¹æ³•ä¸­å®šä¹‰å†…éƒ¨ç±»" class="headerlink" title="åœ¨æ–¹æ³•ä¸­å®šä¹‰å†…éƒ¨ç±»"></a>åœ¨æ–¹æ³•ä¸­å®šä¹‰å†…éƒ¨ç±»</h2><p>é™¤äº†åœ¨å¤–éƒ¨ç±»ä¸­å®šä¹‰å†…éƒ¨ç±»ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ–¹æ³•ä¸­å®šä¹‰å†…éƒ¨ç±»ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ–¹æ³•ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ä¸èƒ½ç›´æ¥è®¿é—®æ–¹æ³•ä¸­çš„å‚æ•°ï¼Œå¦‚æœæ–¹æ³•ä¸­çš„å‚æ•°æƒ³è¦è¢«å†…éƒ¨ç±»è®¿é—®ï¼Œåˆ™å‚æ•°å‰å¿…é¡»åŠ ä¸Šfinalå…³é”®å­—ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String info <span class="token operator">=</span> <span class="token string">"Hello World!!!"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> temp<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å‚æ•°è¦è¢«è®¿é—®å¿…é¡»ç”¨finalå£°æ˜</span>        <span class="token keyword">class</span> <span class="token class-name">Inner</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç±»ä¸­çš„å±æ€§ï¼š"</span> <span class="token operator">+</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ–¹æ³•ä¸­çš„å‚æ•°ï¼š"</span> <span class="token operator">+</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerClassDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// è°ƒç”¨å¤–éƒ¨ç±»æ–¹æ³•              </span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨å¼€å‘ä¸­ï¼Œå†…å­˜æ³„æ¼æœ€åçš„æƒ…å†µæ˜¯appè€—å°½å†…å­˜å¯¼è‡´å´©æºƒï¼Œä½†æ˜¯å¾€å¾€çœŸå®æƒ…å†µä¸æ˜¯è¿™æ ·çš„ï¼Œç›¸åå®ƒåªä¼šè€—å°½å¤§é‡å†…å­˜ä½†ä¸è‡³äºé—ªé€€ï¼Œå¯åˆ†é…çš„å†…å­˜å°‘äº†ï¼ŒGCä¾¿ä¼šæ›´å¤šçš„å·¥ä½œé‡Šæ”¾å†…å­˜ï¼ŒGCæ˜¯éå¸¸è€—æ—¶çš„æ“ä½œï¼Œå› æ­¤ä¼šä½¿å¾—é¡µé¢å¡é¡¿ã€‚æˆ‘ä»¬åœ¨å¼€å‘ä¸­ä¸€å®šè¦æ³¨æ„å½“åœ¨Activityé‡Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶çœ‹çœ‹æ˜¯å¦æœ‰æ½œåœ¨çš„å†…å­˜æ³„æ¼ï¼Œä¸€å®šè¦ç»å¸¸å¯¹å†…å­˜æ³„æ¼è¿›è¡Œæ£€æµ‹ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>&nbsp;01. <a href="https://developer.android.google.cn/studio/profile/android-profiler" target="_blank" rel="noopener">https://developer.android.google.cn/studio/profile/android-profiler</a><br>&nbsp;02. <a href="https://developer.android.google.cn/studio/profile/memory-profiler" target="_blank" rel="noopener">https://developer.android.google.cn/studio/profile/memory-profiler</a><br>&nbsp;03. <a href="https://www.jianshu.com/p/f77fcb43b3d4" target="_blank" rel="noopener">https://www.jianshu.com/p/f77fcb43b3d4</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ€§èƒ½ä¼˜åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜æ³„æ¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android æ ¸å¿ƒåŸç† ä¹‹ è¿›ç¨‹è¢«æ€</title>
      <link href="/2018/08/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-yuan-li-zhi-jin-cheng-bei-sha/"/>
      <url>/2018/08/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-yuan-li-zhi-jin-cheng-bei-sha/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">Process.java</font></td><td>frameworks/base/core/java/android/os/Process.java</td></tr><tr><td><font color="#D15FEE">android_util_Process.cpp</font></td><td>frameworks/base/core/jni/android_util_Process.cpp</td></tr><tr><td><font color="#D15FEE">processgroup.cpp</font></td><td>system/core/libprocessgroup/processgroup.cpp</td></tr></tbody></table><p><br></p><h2 id="1-2-æ¦‚è¿°"><a href="#1-2-æ¦‚è¿°" class="headerlink" title="1.2 æ¦‚è¿°"></a>1.2 æ¦‚è¿°</h2><p>kill è¿›ç¨‹å…¶å®æ˜¯é€šè¿‡ <strong><font color="#FF0000">å‘é€ signal ä¿¡å·</font></strong> çš„æ–¹å¼æ¥å®Œæˆçš„ã€‚åˆ›å»ºè¿›ç¨‹ä» Process.start å¼€å§‹è¯´èµ·ï¼Œé‚£ä¹ˆæ€è¿›ç¨‹åˆ™ç›¸åº”ä» Process.killProcess å¼€å§‹è®²èµ·ã€‚</p><h1 id="äºŒã€ç”¨æˆ·æ€-Kill"><a href="#äºŒã€ç”¨æˆ·æ€-Kill" class="headerlink" title="äºŒã€ç”¨æˆ·æ€ Kill"></a>äºŒã€ç”¨æˆ·æ€ Kill</h1><p>åœ¨ Process.java æ–‡ä»¶æœ‰ 3 ä¸ªæ–¹æ³•ç”¨äºæ€è¿›ç¨‹ï¼Œä¸‹é¢è¯´è¯´è¿™ 3 ä¸ªæ–¹æ³•æ‰€åšçš„å·¥ä½œ!</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Kill the process with the given PID.     * Note that, though this API allows us to request to     * kill any process based on its PID, the kernel will     * still impose standard restrictions on which PIDs you     * are actually able to kill.  Typically this means only     * the process running the caller's packages/application     * and any additional processes created by that app; packages     * sharing a common UID will also be able to kill each     * other's processes.     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">killProcess</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">sendSignal</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGNAL_KILL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * @hide     * Private impl for avoiding a log message...  DO NOT USE without doing     * your own log, or the Android Illuminati will find you some night and     * beat you up.     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">killProcessQuiet</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">sendSignalQuiet</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGNAL_KILL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Kill all processes in a process group started for the given     * pid.     * @hide     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">killProcessGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="2-1-killProcess"><a href="#2-1-killProcess" class="headerlink" title="2.1 killProcess"></a>2.1 killProcess</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIGNAL_KILL <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">killProcess</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">sendSignal</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGNAL_KILL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Send a signal to the given process.     *      * @param pid The pid of the target process.     * @param signal The signal to send.     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">sendSignal</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> signal<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>åœ¨ Process.java ä¸­å®šä¹‰äº†ï¼špublic static final int SIGNAL_KILL = 9ï¼›æˆ‘ä»¬å‘ç°ï¼ŒsendSignal æ˜¯ä¸ª native æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬åœ¨<a href="https://superandroid.pro/2018/10/10/A_03.%20Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20Android%20%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%20%E4%B9%8B%20zygote/">ã€Šæ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ zygoteã€‹</a><a href="https://superandroid.pro/2018/10/28/N_01.%20Android%20%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20Android%20%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%20%E4%B9%8B%20JNI/">ã€Šæ·±å…¥é’»ç ” Android æ ¸å¿ƒæŠ€æœ¯ ä¹‹ JNIã€‹</a>ä¸¤ç¯‡åšæ–‡ä¸­è¯´è¿‡ï¼š<strong>è™šæ‹Ÿæœºä¼šæ³¨å†Œå„ç§ framework æ‰€éœ€çš„ JNI æ–¹æ³•ï¼Œå¾ˆå¤šæ—¶å€™æŸ¥è¯¢ Java å±‚çš„ native æ–¹æ³•æ‰€å¯¹åº”åˆ°çš„ native å±‚æ–¹æ³•ï¼Œå¯åœ¨è·¯å¾„ /framework/base/core/jni ä¸­æ‰¾åˆ°</strong>ã€‚</p><p>è¿™é‡Œçš„ sendSignal æ‰€å¯¹åº”çš„ JNI æ–¹æ³•æ˜¯ï¼šandroid_util_Process.cpp æ–‡ä»¶çš„ android_os_Process_SendSignal æ–¹æ³•ã€‚</p><p><strong><font color="#FF0000">android_os_Process_SendSignal</font></strong></p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">android_os_Process_sendSignal</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span> jint pid<span class="token punctuation">,</span> jint sig<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ‰“å° Signal ä¿¡æ¯</span>        <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Sending signal. PID: %"</span> PRId32 <span class="token string">" SIG: %"</span> PRId32<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ kill æ–¹æ³•</span>        <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-2-killProcessQuiet"><a href="#2-2-killProcessQuiet" class="headerlink" title="2.2 killProcessQuiet"></a>2.2 killProcessQuiet</h2><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">killProcessQuiet</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">sendSignalQuiet</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGNAL_KILL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * @hide     * Private impl for avoiding a log message...  DO NOT USE without doing     * your own log, or the Android Illuminati will find you some night and     * beat you up.     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">sendSignalQuiet</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> signal<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>sendSignalQuiet æ‰€å¯¹åº”çš„ JNI æ–¹æ³•æ˜¯ï¼šandroid_util_Process.cpp æ–‡ä»¶çš„ android_os_Process_sendSignalQuiet æ–¹æ³•ã€‚</p><p><strong><font color="#FF0000">android_os_Process_sendSignalQuiet</font></strong></p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">android_os_Process_sendSignalQuiet</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span> jint pid<span class="token punctuation">,</span> jint sig<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ kill æ–¹æ³•</span>        <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å…¶å® sendSignal å’Œ sendSignalQuiet çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯åœ¨äºæ˜¯å¦æœ‰ ALOGI() è¿™ä¸€è¡Œä»£ç ï¼ˆæ˜¯å¦æ‰“å° Log ä¿¡æ¯ï¼‰ã€‚</p><p>æœ€ç»ˆæ€è¿›ç¨‹çš„å®ç°æ–¹æ³•éƒ½æ˜¯è°ƒç”¨ kill(pid, sig) æ–¹æ³•ã€‚</p><h2 id="2-3-killProcessGroup"><a href="#2-3-killProcessGroup" class="headerlink" title="2.3 killProcessGroup"></a>2.3 killProcessGroup</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// killProcessGroup æœ¬èº«å°±æ˜¯ä¸ª native æ–¹æ³•</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">killProcessGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œä¸ç„¶å‘ç° killProcessGroup å¯¹åº”çš„ native å±‚æ–¹æ³•æ˜¯ï¼šandroid_os_Process_killProcessGroupã€‚</p><p><strong><font color="#FF0000">android_os_Process_killProcessGroup</font></strong></p><pre class=" language-cpp"><code class="language-cpp">jint <span class="token function">android_os_Process_killProcessGroup</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span> jint uid<span class="token punctuation">,</span> jint pid<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">killProcessGroup</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>çœ‹çœ‹ killProcessGroup æ–¹æ³•ï¼šä½äº system/core/libprocessgroup/processgroup.cpp</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">killProcessGroup</span><span class="token punctuation">(</span>uid_t uid<span class="token punctuation">,</span> <span class="token keyword">int</span> initialPid<span class="token punctuation">,</span> <span class="token keyword">int</span> signal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// é‡å¯ 40 æ¬¡é™å®š</span>    <span class="token keyword">return</span> <span class="token function">killProcessGroup</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> initialPid<span class="token punctuation">,</span> signal<span class="token punctuation">,</span> <span class="token number">40</span> <span class="token comment" spellcheck="true">/*retries*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ç»§ç»­è·Ÿè¸ªï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">killProcessGroup</span><span class="token punctuation">(</span>uid_t uid<span class="token punctuation">,</span> <span class="token keyword">int</span> initialPid<span class="token punctuation">,</span> <span class="token keyword">int</span> signal<span class="token punctuation">,</span> <span class="token keyword">int</span> retries<span class="token punctuation">)</span> <span class="token punctuation">{</span>    std<span class="token operator">::</span>chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point start <span class="token operator">=</span> std<span class="token operator">::</span>chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> retry <span class="token operator">=</span> retries<span class="token punctuation">;</span>    <span class="token keyword">int</span> processes<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>processes <span class="token operator">=</span> <span class="token function">doKillProcessGroupOnce</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> initialPid<span class="token punctuation">,</span> signal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å½“è¿˜æœ‰è¿›ç¨‹æœªè¢«æ€æ­»ï¼Œåˆ™é‡è¯•ï¼Œæœ€å¤š40æ¬¡</span>        <span class="token function">LOG</span><span class="token punctuation">(</span>VERBOSE<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Killed "</span> <span class="token operator">&lt;&lt;</span> processes                     <span class="token operator">&lt;&lt;</span> <span class="token string">" processes for processgroup "</span> <span class="token operator">&lt;&lt;</span> initialPid<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>retry <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            std<span class="token operator">::</span>this_thread<span class="token operator">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>5ms<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">--</span>retry<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// é‡è¯•40æ¬¡ï¼Œä»ç„¶æ²¡æœ‰æ€æ­»è¿›ç¨‹ï¼Œä»£è¡¨æ€è¿›ç¨‹å¤±è´¥</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>processes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Error encountered killing process cgroup uid "</span> <span class="token operator">&lt;&lt;</span> uid <span class="token operator">&lt;&lt;</span> <span class="token string">" pid "</span>                    <span class="token operator">&lt;&lt;</span> initialPid<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    std<span class="token operator">::</span>chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point end <span class="token operator">=</span> std<span class="token operator">::</span>chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> ms <span class="token operator">=</span> std<span class="token operator">::</span>chrono<span class="token operator">::</span>duration_cast<span class="token operator">&lt;</span>std<span class="token operator">::</span>chrono<span class="token operator">::</span>milliseconds<span class="token operator">></span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// We only calculate the number of 'processes' when killing the processes.</span>    <span class="token comment" spellcheck="true">// In the retries == 0 case, we only kill the processes once and therefore</span>    <span class="token comment" spellcheck="true">// will not have waited then recalculated how many processes are remaining</span>    <span class="token comment" spellcheck="true">// after the first signals have been sent.</span>    <span class="token comment" spellcheck="true">// Logging anything regarding the number of 'processes' here does not make sense.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>processes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>retries <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Successfully killed process cgroup uid "</span> <span class="token operator">&lt;&lt;</span> uid <span class="token operator">&lt;&lt;</span> <span class="token string">" pid "</span>                      <span class="token operator">&lt;&lt;</span> initialPid <span class="token operator">&lt;&lt;</span> <span class="token string">" in "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// ç§»é™¤è¿›ç¨‹ç»„ç›¸åº”çš„ç›®å½•</span>        <span class="token keyword">return</span> <span class="token function">removeProcessGroup</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> initialPid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>retries <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to kill process cgroup uid "</span> <span class="token operator">&lt;&lt;</span> uid <span class="token operator">&lt;&lt;</span> <span class="token string">" pid "</span> <span class="token operator">&lt;&lt;</span> initialPid                       <span class="token operator">&lt;&lt;</span> <span class="token string">" in "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ms, "</span> <span class="token operator">&lt;&lt;</span> processes                       <span class="token operator">&lt;&lt;</span> <span class="token string">" processes remain"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>çœ‹ä¸‹ doKillProcessGroupOnce æ–¹æ³•ï¼šä½äº system/core/libprocessgroup/processgroup.cpp</p><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// Returns number of processes killed on success</span><span class="token comment" spellcheck="true">// Returns 0 if there are no processes in the process cgroup left to kill</span><span class="token comment" spellcheck="true">// Returns -errno on error</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">doKillProcessGroupOnce</span><span class="token punctuation">(</span>uid_t uid<span class="token punctuation">,</span> <span class="token keyword">int</span> initialPid<span class="token punctuation">,</span> <span class="token keyword">int</span> signal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ProcessGroup process_group<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process_group<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> initialPid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to open process cgroup uid "</span> <span class="token operator">&lt;&lt;</span> uid <span class="token operator">&lt;&lt;</span> <span class="token string">" pid "</span> <span class="token operator">&lt;&lt;</span> initialPid<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// We separate all of the pids in the cgroup into those pids that are also the leaders of</span>    <span class="token comment" spellcheck="true">// process groups (stored in the pgids set) and those that are not (stored in </span>    <span class="token comment" spellcheck="true">// the pids set).</span>    std<span class="token operator">::</span>set<span class="token operator">&lt;</span>pid_t<span class="token operator">></span> pgids<span class="token punctuation">;</span>    pgids<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>initialPid<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token operator">::</span>set<span class="token operator">&lt;</span>pid_t<span class="token operator">></span> pids<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>    pid_t pid<span class="token punctuation">;</span>    <span class="token keyword">int</span> processes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// GetOneAppProcess æ–¹æ³•çš„ä½œç”¨æ˜¯ä»èŠ‚ç‚¹ /acct/uid_/pid_/cgroup.procs ä¸­è·å–ç›¸åº” pid</span>    <span class="token comment" spellcheck="true">// è¿™é‡Œæ˜¯è¿›ç¨‹ï¼Œè€Œéçº¿ç¨‹</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> process_group<span class="token punctuation">.</span><span class="token function">GetOneAppProcess</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        processes<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Should never happen...  but if it does, trying to kill this</span>            <span class="token comment" spellcheck="true">// will boomerang right back and kill us!  Let's not let that happen.</span>            <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Yikes, we've been told to kill pid 0! How about we don't do that?"</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ä¸ä¼šè¿›å…¥æ­¤åˆ†æ”¯</span>        <span class="token punctuation">}</span>        pid_t pgid <span class="token operator">=</span> <span class="token function">getpgid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pgid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"getpgid("</span> <span class="token operator">&lt;&lt;</span> pid <span class="token operator">&lt;&lt;</span> <span class="token string">") failed"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pgid <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>            pgids<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            pids<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Erase all pids that will be killed when we kill the process groups.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> pids<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> pids<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        pid_t pgid <span class="token operator">=</span> <span class="token function">getpgid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pgids<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>pgid<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            it <span class="token operator">=</span> pids<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token operator">++</span>it<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Kill all process groups.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span> pgid <span class="token operator">:</span> pgids<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">LOG</span><span class="token punctuation">(</span>VERBOSE<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Killing process group "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">-</span>pgid <span class="token operator">&lt;&lt;</span> <span class="token string">" in uid "</span> <span class="token operator">&lt;&lt;</span> uid                     <span class="token operator">&lt;&lt;</span> <span class="token string">" as part of process cgroup "</span> <span class="token operator">&lt;&lt;</span> initialPid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ kill(pid, sig) æ–¹æ³•</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pgid<span class="token punctuation">,</span> signal<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"kill("</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">-</span>pgid <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> signal <span class="token operator">&lt;&lt;</span> <span class="token string">") failed"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Kill remaining pids.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span> pid <span class="token operator">:</span> pids<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">LOG</span><span class="token punctuation">(</span>VERBOSE<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Killing pid "</span> <span class="token operator">&lt;&lt;</span> pid <span class="token operator">&lt;&lt;</span> <span class="token string">" in uid "</span> <span class="token operator">&lt;&lt;</span> uid                     <span class="token operator">&lt;&lt;</span> <span class="token string">" as part of process cgroup "</span> <span class="token operator">&lt;&lt;</span> initialPid<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è°ƒç”¨ kill(pid, sig) æ–¹æ³•</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> signal<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">PLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"kill("</span> <span class="token operator">&lt;&lt;</span> pid <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> signal <span class="token operator">&lt;&lt;</span> <span class="token string">") failed"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// processes ä»£è¡¨æ€»å…±æ€æ­»äº†è¿›ç¨‹ç»„ä¸­çš„è¿›ç¨‹ä¸ªæ•°</span>    <span class="token keyword">return</span> ret <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> processes <span class="token operator">:</span> ret<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><code>doKillProcessGroupOnce</code> çš„åŠŸèƒ½æ˜¯æ€æ‰ uid ä¸‹ï¼Œè·Ÿ initialPid åŒä¸€ä¸ªè¿›ç¨‹ç»„çš„æ‰€æœ‰è¿›ç¨‹ã€‚ä¹Ÿå°±æ„å‘³ç€é€šè¿‡ <code>kill &lt;pid&gt;</code> ï¼Œå½“ pid æ˜¯æŸä¸ªè¿›ç¨‹çš„å­çº¿ç¨‹æ—¶ï¼Œé‚£ä¹ˆæœ€ç»ˆæ€çš„ä»æ˜¯è¿›ç¨‹ã€‚</p><p>æœ€ç»ˆæ€è¿›ç¨‹çš„å®ç°æ–¹æ³•éƒ½æ˜¯è°ƒç”¨ <code>kill(pid, sig)</code> æ–¹æ³•ã€‚</p><p>å†çœ‹ä¸‹ removeProcessGroup æ–¹æ³•ï¼š</p><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">removeProcessGroup</span><span class="token punctuation">(</span>uid_t uid<span class="token punctuation">,</span> <span class="token keyword">int</span> pid<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>    <span class="token keyword">char</span> path<span class="token punctuation">[</span>PROCESSGROUP_MAX_PATH_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ é™¤ç›®å½• /acct/uid_&lt;uid>/pid_&lt;pid>/</span>    <span class="token function">convertUidPidToPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> uid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">rmdir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// åˆ é™¤ç›®å½• /acct/uid_&lt;uid>/</span>    <span class="token function">convertUidToPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">rmdir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="2-4-æµç¨‹å›¾"><a href="#2-4-æµç¨‹å›¾" class="headerlink" title="2.4 æµç¨‹å›¾"></a>2.4 æµç¨‹å›¾</h2><center><img src="https://upload-images.jianshu.io/upload_images/3517194-aedfee9f07c089e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1020" alt="åŸç†å›¾.png"></center><h2 id="2-5-æ€»ç»“"><a href="#2-5-æ€»ç»“" class="headerlink" title="2.5 æ€»ç»“"></a>2.5 æ€»ç»“</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Process.killProcess(int pid): æ€ pid è¿›ç¨‹<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Process.killProcessQuiet(int pid)ï¼šæ€ pid è¿›ç¨‹ï¼Œä¸”ä¸è¾“å‡º log ä¿¡æ¯<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨ Process.killProcessGroup(int uid, int pid)ï¼šæ€åŒä¸€ä¸ª uid ä¸‹åŒä¸€è¿›ç¨‹ç»„ä¸‹çš„æ‰€æœ‰è¿›ç¨‹</p><p>ä»¥ä¸Š 3 ä¸ªæ–¹æ³•ï¼Œæœ€ç»ˆæ€è¿›ç¨‹çš„å®ç°æ–¹æ³•éƒ½æ˜¯è°ƒç”¨ <code>kill(pid, sig)</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½äºç”¨æˆ·ç©ºé—´çš„ Native å±‚ï¼Œç»è¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥åˆ° Linux å†…æ ¸çš„ <code>sys_kill</code> æ–¹æ³•ã€‚å¯¹äºæ€è¿›ç¨‹æ­¤å¤„çš„ sig = 9ï¼Œå…¶å®ä¸å¤§å®¶å¹³æ—¶åœ¨ adb é‡Œè¾“å…¥çš„ <code>kill -9 &lt;pid&gt;</code> æ•ˆæœåŸºæœ¬ä¸€è‡´ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p><a href="http://gityuan.com/2016/04/16/kill-signal/" target="_blank" rel="noopener">ç†è§£æ€è¿›ç¨‹çš„å®ç°åŸç†</a></p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> æ ¸å¿ƒæœºåˆ¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Process </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥é’»ç ” Android è®¾è®¡æ¨¡å¼ ä¹‹ å•ä¾‹æ¨¡å¼</title>
      <link href="/2018/08/10/06.she-ji-mo-shi-xi-lie-shen-ru-yan-jiu-android-she-ji-mo-shi-zhi-dan-li-mo-shi/"/>
      <url>/2018/08/10/06.she-ji-mo-shi-xi-lie-shen-ru-yan-jiu-android-she-ji-mo-shi-zhi-dan-li-mo-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><h2 id="1-1-ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ</h2><p>è¿™ç§æ¨¡å¼æ¶‰åŠåˆ°ä¸€ä¸ªå•ä¸€çš„ç±»ï¼Œè¯¥ç±»è´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼ŒåŒæ—¶ç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚è¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚</p><p><strong><font color="#FF0000" size="4">æ³¨æ„ï¼š</font></strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ &nbsp;å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ &nbsp;å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ &nbsp;å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å…³äºâ€œå•ä¾‹æ¨¡å¼â€çš„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><p><strong><font color="#4876FF">å•ä¾‹æ„å›¾ï¼š</font></strong>ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚</p><p><strong><font color="#4876FF">ä¸»è¦è§£å†³ï¼š</font></strong>ä¸€ä¸ªå…¨å±€ä½¿ç”¨çš„ç±»é¢‘ç¹åœ°åˆ›å»ºä¸é”€æ¯ã€‚</p><p><strong><font color="#4876FF">ä½•æ—¶ä½¿ç”¨ï¼š</font></strong>å½“æ‚¨æƒ³æ§åˆ¶å®ä¾‹æ•°ç›®ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æºçš„æ—¶å€™ã€‚</p><p><strong><font color="#4876FF">å¦‚ä½•è§£å†³ï¼š</font></strong>åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦å·²ç»æœ‰è¿™ä¸ªå•ä¾‹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºã€‚</p><p><strong><font color="#4876FF">å…³é”®ä»£ç ï¼š</font></strong>æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ã€‚</p><p><strong><font color="#4876FF">å•ä¾‹ä¼˜ç‚¹ï¼š</font></strong> 1ã€åœ¨å†…å­˜é‡Œåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯å®ä¾‹ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2ã€é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ï¼ˆæ¯”å¦‚å†™æ–‡ä»¶æ“ä½œï¼‰ã€‚</p><p><strong><font color="#4876FF">å•ä¾‹ç¼ºç‚¹ï¼š</font></strong> 1ã€æ²¡æœ‰æ¥å£ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2ã€ä¸èƒ½ç»§æ‰¿ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3ã€ä¸å•ä¸€èŒè´£åŸåˆ™å†²çªï¼Œä¸€ä¸ªç±»åº”è¯¥åªå…³å¿ƒå†…éƒ¨é€»è¾‘ï¼Œè€Œä¸å…³å¿ƒå¤–é¢æ€ä¹ˆæ ·æ¥å®ä¾‹åŒ–ã€‚</p><p><strong><font color="#4876FF">ä½¿ç”¨åœºæ™¯ï¼š</font></strong> 1ã€è¦æ±‚ç”Ÿäº§å”¯ä¸€åºåˆ—å·ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2ã€WEB ä¸­çš„è®¡æ•°å™¨ï¼Œä¸ç”¨æ¯æ¬¡åˆ·æ–°éƒ½åœ¨æ•°æ®åº“é‡ŒåŠ ä¸€æ¬¡ï¼Œç”¨å•ä¾‹å…ˆç¼“å­˜èµ·æ¥ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3ã€åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡éœ€è¦æ¶ˆè€—çš„èµ„æºè¿‡å¤šï¼Œæ¯”å¦‚ I/O ä¸æ•°æ®åº“çš„è¿æ¥ç­‰ã€‚</p><p><strong><font color="#4876FF">æ³¨æ„äº‹é¡¹ï¼š</font></strong>getInstance() æ–¹æ³•ä¸­éœ€è¦ä½¿ç”¨åŒæ­¥é” synchronized (Singleton.class) é˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶è¿›å…¥é€ æˆ instance è¢«å¤šæ¬¡å®ä¾‹åŒ–ã€‚</p><h2 id="1-2-å•ä¾‹-DEMO"><a href="#1-2-å•ä¾‹-DEMO" class="headerlink" title="1.2 å•ä¾‹ DEMO"></a>1.2 å•ä¾‹ DEMO</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸ªç®€å•çš„å•ä¾‹è®¾è®¡çš„ Demoï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª Singleton ç±»ï¼šSingleObject.java</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingleObject</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//åˆ›å»º SingleObject çš„ä¸€ä¸ªå¯¹è±¡</span>   <span class="token keyword">private</span> <span class="token keyword">static</span> SingleObject instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SingleObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//è®©æ„é€ å‡½æ•°ä¸º privateï¼Œè¿™æ ·è¯¥ç±»å°±ä¸ä¼šè¢«å®ä¾‹åŒ–</span>   <span class="token keyword">private</span> <span class="token function">SingleObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">//è·å–å”¯ä¸€å¯ç”¨çš„å¯¹è±¡</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> SingleObject <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> instance<span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">showMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ç„¶åä» singleton ç±»è·å–å”¯ä¸€çš„å¯¹è±¡ï¼šSingletonPatternDemo.java</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingletonPatternDemo</span> <span class="token punctuation">{</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//ä¸åˆæ³•çš„æ„é€ å‡½æ•°</span>      <span class="token comment" spellcheck="true">//ç¼–è¯‘æ—¶é”™è¯¯ï¼šæ„é€ å‡½æ•° SingleObject() æ˜¯ä¸å¯è§çš„</span>      <span class="token comment" spellcheck="true">//SingleObject object = new SingleObject();</span>      <span class="token comment" spellcheck="true">//è·å–å”¯ä¸€å¯ç”¨çš„å¯¹è±¡</span>      SingleObject object <span class="token operator">=</span> SingleObject<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//æ˜¾ç¤ºæ¶ˆæ¯</span>      object<span class="token punctuation">.</span><span class="token function">showMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬çœ‹ä¸‹æ‰§è¡Œç»“æœï¼š</p><pre><code>Hello World!</code></pre><h1 id="2-å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼"><a href="#2-å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼" class="headerlink" title="2. å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼"></a>2. å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼</h1><h2 id="2-1-åŸºæœ¬ç‰ˆï¼šé¥¿æ±‰å¼"><a href="#2-1-åŸºæœ¬ç‰ˆï¼šé¥¿æ±‰å¼" class="headerlink" title="2.1 åŸºæœ¬ç‰ˆï¼šé¥¿æ±‰å¼"></a>2.1 åŸºæœ¬ç‰ˆï¼šé¥¿æ±‰å¼</h2><blockquote><p>ä»£ç </p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">private</span> <span class="token function">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> instance<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>è¯´æ˜</p></blockquote><p>è¿™ç§æ–¹å¼æ¯”è¾ƒå¸¸è§ï¼Œå…¸å‹çš„â€œé¥¿æ±‰å¼â€å†™æ³•ã€‚</p><p>ã€æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ã€‘ï¼šæ˜¯<br>ã€å®ç°éš¾åº¦ã€‘ï¼šæ˜“<br>ã€ä¼˜ç‚¹ã€‘ï¼šæ²¡æœ‰åŠ é”ï¼Œæ‰§è¡Œæ•ˆç‡ä¼šæé«˜ã€‚<br>ã€ç¼ºç‚¹ã€‘ï¼š<strong><font color="#FF0000">ç±»åŠ è½½æ—¶å°±åˆå§‹åŒ–ï¼Œæµªè´¹å†…å­˜ã€‚</font></strong></p><h2 id="2-2-æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼-çº¿ç¨‹ä¸å®‰å…¨"><a href="#2-2-æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼-çº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="2.2 æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼ - çº¿ç¨‹ä¸å®‰å…¨"></a>2.2 æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼ - çº¿ç¨‹ä¸å®‰å…¨</h2><blockquote><p>ä»£ç </p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>      <span class="token keyword">private</span> <span class="token function">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>              instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> instance<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>è¯´æ˜</p></blockquote><p><strong><font color="#1874CD">è¿™ç§æ–¹å¼æ˜¯å¤§å¤šæ•°é¢è¯•è€…çš„å†™æ³•ï¼Œä¹Ÿæ˜¯æ•™ç§‘ä¹¦ä¸Šçš„æ ‡é…ï¼Œ</font>ä½†è¿™æ®µä»£ç å´å­˜åœ¨ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜ï¼š<font color="#FF0000">å½“å¤šä¸ªçº¿ç¨‹å¹¶è¡Œè°ƒç”¨ getInstance() çš„æ—¶å€™ï¼Œå°±ä¼šåˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚</font></strong></p><h2 id="2-3-æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼-çº¿ç¨‹å®‰å…¨"><a href="#2-3-æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼-çº¿ç¨‹å®‰å…¨" class="headerlink" title="2.3 æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼ - çº¿ç¨‹å®‰å…¨"></a>2.3 æ”¹è¿›ç‰ˆï¼šæ‡’æ±‰å¼ - çº¿ç¨‹å®‰å…¨</h2><blockquote><p>ä»£ç </p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>      <span class="token keyword">private</span> <span class="token function">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>              instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> instance<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>è¯´æ˜</p></blockquote><p>æ—¢ç„¶è¦çº¿ç¨‹å®‰å…¨ï¼Œé‚£å°±å¦‚ä¸Šæ‰€è¿°â€œåŠ é”â€å¤„ç†ï¼</p><p>ã€æ˜¯å¦å¤šçº¿ç¨‹å®‰å…¨ã€‘ï¼šæ˜¯<br>ã€å®ç°éš¾åº¦ã€‘ï¼šæ˜“<br>ã€ä¼˜ç‚¹ã€‘ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æ‰åˆå§‹åŒ–ï¼Œé¿å…å†…å­˜æµªè´¹ã€‚<br>ã€ç¼ºç‚¹ã€‘ï¼š<strong><font color="#FF0000">å¿…é¡»åŠ é” synchronized æ‰èƒ½ä¿è¯å•ä¾‹ï¼Œä½†åŠ é”ï¼ˆåŠ é”æ“ä½œä¹Ÿæ˜¯è€—æ—¶çš„ï¼‰ä¼šå½±å“æ•ˆç‡ã€‚</font></strong></p><h2 id="2-4-æ”¹è¿›ç‰ˆï¼šåŒé‡æ ¡éªŒé”"><a href="#2-4-æ”¹è¿›ç‰ˆï¼šåŒé‡æ ¡éªŒé”" class="headerlink" title="2.4 æ”¹è¿›ç‰ˆï¼šåŒé‡æ ¡éªŒé”"></a>2.4 æ”¹è¿›ç‰ˆï¼šåŒé‡æ ¡éªŒé”</h2><blockquote><p>ä»£ç </p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>      <span class="token keyword">private</span> <span class="token function">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                      instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>              <span class="token punctuation">}</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> instance<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>è¯´æ˜</p></blockquote><p>ä¸ºä»€ä¹ˆéœ€è¦è¿›è¡Œ 2 æ¬¡åˆ¤æ–­æ˜¯å¦ä¸ºç©ºå‘¢ï¼Ÿ</p><p><strong><font color="#FF0000">ç¬¬ä¸€æ¬¡åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…ä¸å¿…è¦çš„åŒæ­¥ï¼Œç¬¬äºŒæ¬¡åˆ¤æ–­æ˜¯ç¡®ä¿åœ¨æ­¤ä¹‹å‰æ²¡æœ‰å…¶ä»–è¿›ç¨‹è¿›å…¥åˆ° synchronized å—åˆ›å»ºäº†æ–°å®ä¾‹ã€‚</font></strong></p><p>è¿™æ®µä»£ç çœ‹èµ·æ¥å¾ˆå®Œç¾ï¼Œå¾ˆå¯æƒœï¼Œå®ƒè¿˜æ˜¯æœ‰éšæ‚£ã€‚ä¸»è¦åœ¨äº instance = new Singleton() è¿™å¥ï¼Œè¿™å¹¶éæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œäº‹å®ä¸Šåœ¨ JVM ä¸­è¿™å¥è¯å¤§æ¦‚åšäº†ä¸‹é¢ 3 ä»¶äº‹æƒ…ï¼š</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;1ã€ç»™ instance åˆ†é…å†…å­˜<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;2ã€è°ƒç”¨ Singleton çš„æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–æˆå‘˜å˜é‡<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;3ã€å°† instance å¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´ï¼ˆæ‰§è¡Œå®Œè¿™æ­¥ instance å°±ä¸ºé null äº†ï¼‰</p><p>ä½†æ˜¯åœ¨ JVM çš„å³æ—¶ç¼–è¯‘å™¨ä¸­å­˜åœ¨æŒ‡ä»¤é‡æ’åºçš„ä¼˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥çš„é¡ºåºæ˜¯ä¸èƒ½ä¿è¯çš„ï¼Œæœ€ç»ˆçš„æ‰§è¡Œé¡ºåºå¯èƒ½æ˜¯ 1-2-3 ä¹Ÿå¯èƒ½æ˜¯ 1-3-2ã€‚å¦‚æœæ˜¯åè€…ï¼Œåˆ™åœ¨ 3 æ‰§è¡Œå®Œæ¯•ã€2 æœªæ‰§è¡Œä¹‹å‰ï¼Œè¢«çº¿ç¨‹äºŒæŠ¢å äº†ï¼Œè¿™æ—¶ instance å·²ç»æ˜¯é null äº†ï¼ˆä½†å´æ²¡æœ‰åˆå§‹åŒ–ï¼‰ï¼Œæ‰€ä»¥çº¿ç¨‹äºŒä¼šç›´æ¥è¿”å› instanceï¼Œç„¶åä½¿ç”¨ï¼Œç„¶åé¡ºç†æˆç« åœ°æŠ¥é”™ã€‚</p><h2 id="2-5-æ”¹è¿›ç‰ˆï¼šåŒæ£€é”ï¼ˆvolatileï¼‰"><a href="#2-5-æ”¹è¿›ç‰ˆï¼šåŒæ£€é”ï¼ˆvolatileï¼‰" class="headerlink" title="2.5 æ”¹è¿›ç‰ˆï¼šåŒæ£€é”ï¼ˆvolatileï¼‰"></a>2.5 æ”¹è¿›ç‰ˆï¼šåŒæ£€é”ï¼ˆvolatileï¼‰</h2><blockquote><p>ä»£ç </p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>      <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>      <span class="token keyword">private</span> <span class="token function">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                      instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>              <span class="token punctuation">}</span>          <span class="token punctuation">}</span>          <span class="token keyword">return</span> instance<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>è¯´æ˜</p></blockquote><p>æœ‰äº›äººè®¤ä¸ºä½¿ç”¨ volatile çš„åŸå› æ˜¯å¯è§æ€§ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¿è¯çº¿ç¨‹åœ¨æœ¬åœ°ä¸ä¼šå­˜æœ‰ instance çš„å‰¯æœ¬ï¼Œæ¯æ¬¡éƒ½æ˜¯å»ä¸»å†…å­˜ä¸­è¯»å–ã€‚ä½†å…¶å®æ˜¯ä¸å¯¹çš„ã€‚<strong><font color="#FF0000">ä½¿ç”¨ volatile çš„ä¸»è¦åŸå› æ˜¯å…¶å¦ä¸€ä¸ªç‰¹æ€§ï¼šç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</font>ã€‚</strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ volatile å˜é‡çš„èµ‹å€¼æ“ä½œåé¢ä¼šæœ‰ä¸€ä¸ªå†…å­˜å±éšœï¼ˆç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸Šï¼‰ï¼Œè¯»æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°å†…å­˜å±éšœä¹‹å‰ã€‚æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå–æ“ä½œå¿…é¡»åœ¨æ‰§è¡Œå®Œ 1-2-3 ä¹‹åæˆ–è€… 1-3-2 ä¹‹åï¼Œä¸å­˜åœ¨æ‰§è¡Œåˆ° 1-3 ç„¶åå–åˆ°å€¼çš„æƒ…å†µã€‚ä»ã€Œå…ˆè¡Œå‘ç”ŸåŸåˆ™ã€çš„è§’åº¦ç†è§£çš„è¯ï¼Œå°±æ˜¯å¯¹äºä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œï¼ˆè¿™é‡Œçš„â€œåé¢â€æ˜¯æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºï¼‰ã€‚</p><p>ä½†æ˜¯ç‰¹åˆ«æ³¨æ„åœ¨ Java 5 ä»¥å‰çš„ç‰ˆæœ¬ä½¿ç”¨äº† volatile çš„åŒæ£€é”è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚å…¶åŸå› æ˜¯ Java 5 ä»¥å‰çš„ JMM ï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰æ˜¯å­˜åœ¨ç¼ºé™·çš„ï¼Œå³ä½¿å°†å˜é‡å£°æ˜æˆ volatile ä¹Ÿä¸èƒ½å®Œå…¨é¿å…é‡æ’åºï¼Œä¸»è¦æ˜¯ volatile å˜é‡å‰åçš„ä»£ç ä»ç„¶å­˜åœ¨é‡æ’åºé—®é¢˜ã€‚è¿™ä¸ª volatile å±è”½é‡æ’åºçš„é—®é¢˜åœ¨ Java 5 ä¸­æ‰å¾—ä»¥ä¿®å¤ï¼Œæ‰€ä»¥åœ¨è¿™ä¹‹åæ‰å¯ä»¥æ”¾å¿ƒä½¿ç”¨ volatileã€‚</p><p><strong><font color="#FF0000">é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ—¢æœ‰æ‡’åŠ è½½ï¼Œåˆä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œè¿˜ç®€å•çš„æ–¹æ³•å‘¢ï¼Ÿ</font></strong></p><p>å½“ç„¶æœ‰ï¼Œ<strong><font color="#1874CD">é™æ€å†…éƒ¨ç±»å°±æ˜¯ä¸€ç§æˆ‘ä»¬æƒ³è¦çš„æ–¹æ³•<font></font></font></strong>ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠ Singleton å®ä¾‹æ”¾åœ¨ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ä¸­ï¼Œè¿™æ ·å°±é¿å…äº†é™æ€å®ä¾‹åœ¨ Singleton ç±»åŠ è½½çš„æ—¶å€™å°±åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”ç”±äºé™æ€å†…éƒ¨ç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™ç§å†™æ³•ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h2 id="2-6-ç»ˆæç‰ˆï¼šé™æ€å†…éƒ¨ç±»"><a href="#2-6-ç»ˆæç‰ˆï¼šé™æ€å†…éƒ¨ç±»" class="headerlink" title="2.6 ç»ˆæç‰ˆï¼šé™æ€å†…éƒ¨ç±»"></a>2.6 ç»ˆæç‰ˆï¼šé™æ€å†…éƒ¨ç±»</h2><blockquote><p>ä»£ç </p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingletonHolder</span> <span class="token punctuation">{</span>          <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">private</span> <span class="token function">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> SingletonHolder<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>è¯´æ˜</p></blockquote><p>è¿™æ˜¯æ¯”è¾ƒæ¨èçš„è§£æ³•ï¼Œè¿™ç§å†™æ³•ç”¨ JVM æœ¬èº«çš„æœºåˆ¶ä¿è¯äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼ŒåŒæ—¶è¯»å–å®ä¾‹çš„æ—¶å€™ä¹Ÿä¸ä¼šè¿›è¡ŒåŒæ­¥ï¼Œæ²¡ä»€ä¹ˆæ€§èƒ½ç¼ºé™·ï¼Œè¿˜ä¸ä¾èµ– JDK ç‰ˆæœ¬ã€‚</p><h2 id="2-7-ä¼ è¯´ç‰ˆï¼šæšä¸¾"><a href="#2-7-ä¼ è¯´ç‰ˆï¼šæšä¸¾" class="headerlink" title="2.7 ä¼ è¯´ç‰ˆï¼šæšä¸¾"></a>2.7 ä¼ è¯´ç‰ˆï¼šæšä¸¾</h2><blockquote><p>ä»£ç </p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> Singleton <span class="token punctuation">{</span>      INSTANCE<span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>è¯´æ˜</p></blockquote><p>è¿™æ˜¯ä» Java 1.5 å‘è¡Œç‰ˆæœ¬åå°±å¯ä»¥å®ç”¨çš„å•ä¾‹æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Singleton.INSTANCE æ¥è®¿é—®å®ä¾‹ï¼Œè¿™æ¯”è°ƒç”¨ getInstance() æ–¹æ³•ç®€å•å¤šäº†ã€‚</p><p>åˆ›å»ºæšä¸¾é»˜è®¤å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒ double checked lockingï¼Œè€Œä¸”è¿˜èƒ½é˜²æ­¢ååºåˆ—åŒ–å¯¼è‡´é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚</p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> è®¾è®¡æ¨¡å¼ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å•ä¾‹æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AsyncTask è¯¦è§£ï¼ˆç”¨æ³•ç¯‡ï¼‰</title>
      <link href="/2018/08/08/05.jin-cheng-xian-cheng-xi-lie-asynctask-xiang-jie-yong-fa-pian/"/>
      <url>/2018/08/08/05.jin-cheng-xian-cheng-xi-lie-asynctask-xiang-jie-yong-fa-pian/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong><font color="#AAAAAA">AsyncTask ä½œä¸ºä¸€ä¸ªæ¯” Handler è¿˜è¦å¥½ç”¨çš„æ¶ˆæ¯å¤„ç†ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨å®ƒçš„è¯ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªå­ç±»å»ç»§æ‰¿å®ƒã€‚</font></strong></p></blockquote><hr><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>çœ‹ä¸€ä¸‹è¿™ä¸ªæŠ½è±¡ç±»ï¼šandroid.os.AsyncTask&lt;Params, Progress, Result&gt;ï¼ŒæŒ‡å®šäº†ä¸‰ä¸ªæ³›å‹å‚æ•°ï¼Œåˆ†æä¸€ä¸‹ä¸‰ä¸ªå‚æ•°ï¼š</p><p>1ã€<strong><font color="#1874CD">Paramsï¼š</font></strong>åœ¨æ‰§è¡Œ AsyncTask æ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼Œå¯ç”¨äºåœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">DownloadTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token function">doInBackground</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span>               <span class="token comment" spellcheck="true">// è¿™è¾¹çš„ Integer å¯ä»¥è‡ªå®šä¹‰</span></code></pre><p>2ã€<strong><font color="#1874CD">Progressï¼š</font></strong>åå°ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå¦‚æœéœ€è¦åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå½“å‰çš„è¿›åº¦ï¼Œåˆ™ä½¿ç”¨è¿™é‡ŒæŒ‡å®šçš„æ³›å‹ä½œä¸ºè¿›åº¦å•ä½ã€‚</p><p>3ã€<strong><font color="#1874CD">Resultï¼š</font></strong>å½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœéœ€è¦å¯¹ç»“æœè¿›è¡Œè¿”å›ï¼Œåˆ™ä½¿ç”¨è¿™é‡ŒæŒ‡å®šçš„æ³›å‹ä½œä¸ºè¿”å›å€¼ç±»å‹ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸ä½¿ç”¨ Boolean æˆ– String ç±»å‹ä½œä¸ºè¿”å›ç±»å‹ã€‚</p><p><strong><font color="#FF0000" size="3">Noticeï¼š</font></strong>è¿™ä¸‰ä¸ªå‚æ•°æ˜¯æ³›å‹å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å‚æ•°ç±»å‹æ˜¯æ ¹æ®è¦æ±‚ä¼ å…¥çš„ï¼Œæ‰€ä»¥åœ¨æ–¹æ³•çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸€å®šè¦æ¸…æ™°å‚æ•°ç±»å‹çš„è®¾å®šå’Œä½¿ç”¨ã€‚</p><p><strong>è¿™é‡Œç»™å‡ºä¸€ä¸ªæœ€ç®€å•çš„è‡ªå®šä¹‰ AsyncTask çš„æ–¹å¼ï¼š</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DownloadTask</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Void<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Boolean<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>å½“ç„¶ï¼Œå®šä¹‰å®Œä¸€ä¸ªç»§æ‰¿ AsyncTask çš„å­ç±»åï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¦†å†™ AsyncTask çš„å‡ ä¸ªæ–¹æ³•ï¼š</p><p>ã€€ã€€ã€€ã€€ğŸ <strong><font color="#0000CD" size="3">1.     onPreExecute()                 </font></strong></p><p>ã€€ã€€ã€€ã€€ğŸ <strong><font color="#0000CD" size="3">2.     doInBackground(Paramsâ€¦)      </font></strong></p><p>ã€€ã€€ã€€ã€€ğŸ <strong><font color="#0000CD" size="3">3.     onProgressUpdate(Progressâ€¦)  </font></strong></p><p>ã€€ã€€ã€€ã€€ğŸ <strong><font color="#0000CD" size="3">4.     onPostExecute(Result)          </font></strong></p><hr><h3 id="å››å¤§æŠ¤æ³•"><a href="#å››å¤§æŠ¤æ³•" class="headerlink" title="å››å¤§æŠ¤æ³•"></a>å››å¤§æŠ¤æ³•</h3><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¯¹è¿™ 4 ä¸ªæ–¹æ³•çš„ä½¿ç”¨æµç¨‹ä½œä¸€ä¸ªè¯¦ç»†çš„ä»‹ç»ï¼</p><h4 id="onPreExecute"><a href="#onPreExecute" class="headerlink" title="onPreExecute()"></a>onPreExecute()</h4><p>è¿™ä¸ªæ–¹æ³•é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨å¼‚æ­¥ä»»åŠ¡å¤„ç†ä¹‹å‰éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼Œé‚£ä¹ˆå®ƒæ“ä½œä»€ä¹ˆï¼Ÿç®€å•çš„è¯´å°±æ˜¯è¿›è¡Œä¸€äº›ç•Œé¢ä¸Šçš„åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚ï¼šæ˜¾ç¤ºä¸€ä¸ªè¿›åº¦æ¡å¯¹è¯æ¡†ç­‰ã€‚è¿™ä¸ªæ–¹æ³•ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å·§å¦™ä½¿ç”¨å¯ä»¥å¢å¼ºç•Œé¢çš„å¯è§‚æ€§ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPreExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// å¯ä»¥è¿›è¡Œä¸€äº›é¢„å¤„ç†</span><span class="token punctuation">}</span></code></pre><h4 id="doInBackground"><a href="#doInBackground" class="headerlink" title="doInBackground()"></a>doInBackground()</h4><p>è¿™ä¸ªå°±æ˜¯ AsyncTask ä¸­æœ€ä¸ºé‡è¦çš„æ–¹æ³•äº†ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸­çš„æ‰€æœ‰ä»£ç éƒ½ä¼šåœ¨å­çº¿ç¨‹ä¸­è¿è¡Œï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å»å¤„ç†æ‰€æœ‰çš„è€—æ—¶ä»»åŠ¡ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// è¿™è¾¹ params æ˜¯ç”± execute() ä¼ è¿›æ¥çš„ï¼Œè¿™ä¸ª execute æ–¹æ³•å¯ä»¥åœ¨ä¸‹é¢æ‰¾åˆ°ç­”æ¡ˆã€‚</span><span class="token keyword">protected</span> Boolean <span class="token function">doInBackground</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>  ã€€ã€€<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">101</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token function">publishProgress</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// å¯¹ä¸»çº¿ç¨‹ UI è¿›è¡Œæ›´æ–°æ“ä½œï¼Œå°†è°ƒç”¨ onProgressUpdate() æ–¹æ³•</span>ã€€ã€€ã€€ã€€<span class="token keyword">try</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// ä¼‘çœ çº¿ç¨‹</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// ä»»åŠ¡å®Œæˆå return ä¸€ä¸ªç»“æœï¼Œè¿™è¾¹çš„ Boolean ç±»å‹çš„ç»“æœ</span><span class="token punctuation">}</span></code></pre><p>é€šè¿‡ä»¥ä¸Šçš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼šä»»åŠ¡ä¸€æ—¦å®Œæˆå°±å¯ä»¥é€šè¿‡ return è¯­å¥æ¥å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ï¼Œå¦‚æœ AsyncTask çš„ç¬¬ä¸‰ä¸ªæ³›å‹å‚æ•°è¢«æŒ‡å®šçš„æ˜¯ Voidï¼Œå°±å¯ä»¥ä¸è¿”å›ä»»åŠ¡æ‰§è¡Œç»“æœã€‚</p><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ˜¯ä¸å¯ä»¥è¿›è¡Œ UI æ“ä½œçš„ï¼ˆå­çº¿ç¨‹æ˜¯æ— æ³•å¯¹ä¸»çº¿ç¨‹è¿›è¡Œä¿®æ”¹çš„ï¼‰ï¼Œå¦‚æœéœ€è¦æ›´æ–° UI å…ƒç´ çš„è¯ï¼Œå°±éœ€è¦è°ƒç”¨ publishProgress(Progressâ€¦) æ–¹æ³•æ¥å®Œæˆäº†ã€‚</p><h4 id="onProgressUpdate"><a href="#onProgressUpdate" class="headerlink" title="onProgressUpdate()"></a>onProgressUpdate()</h4><p>å½“åœ¨åå°ä»»åŠ¡ä¸­è°ƒç”¨äº† publishProgress(Progressâ€¦) æ–¹æ³•åï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šå¾ˆå¿«è¢«è°ƒç”¨ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥å¯¹ UI è¿›è¡Œæ“ä½œï¼Œåˆ©ç”¨å‚æ•°ä¸­çš„æ•°å€¼å°±å¯ä»¥å¯¹ç•Œé¢å…ƒç´ è¿›è¡Œç›¸åº”åœ°æ›´æ–°ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onProgressUpdate</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                   <span class="token comment" spellcheck="true">// values[0] = i</span>    MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"å½“å‰è¿›åº¦æ˜¯ï¼š"</span> <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// ä¸»çº¿ç¨‹è¿›è¡Œæ“ä½œ</span><span class="token punctuation">}</span></code></pre><h4 id="onPostExecute"><a href="#onPostExecute" class="headerlink" title="onPostExecute()"></a>onPostExecute()</h4><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¥æ‰§è¡Œ return è¿”å›åçš„ä¸€äº›æ“ä½œã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span>Boolean b<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                         <span class="token comment" spellcheck="true">// b --> true</span>ã€€ã€€<span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Download succeed"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// åç»­æ“ä½œ</span>ã€€ã€€<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Download failed"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>é‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬å®šä¹‰å¥½äº†ç±»ï¼ŒåŒæ—¶è¦†å†™äº†å„ç§æ–¹æ³•ï¼Œä½†æ˜¯å¦‚ä½•å¯åŠ¨å®ƒï¼Ÿ</p><p>å¦‚æœæƒ³è¦å¯åŠ¨è¿™ä¸ªä»»åŠ¡ï¼Œåªéœ€ç¼–å†™ä¸€è¡Œä»£ç ï¼šnew DownloadTask().execute();</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token keyword">new</span> <span class="token class-name">DownloadTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// è¿™æ ·å°±å¯ä»¥å¯åŠ¨å¼‚æ­¥ç±»äº†</span><span class="token punctuation">}</span></code></pre><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> è¿›ç¨‹çº¿ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AsyncTask </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµ…æå¤šçº¿ç¨‹ä¸­çš„ â€œåŒæ­¥â€ å’Œ â€œæ­»é”â€</title>
      <link href="/2018/08/06/05.jin-cheng-xian-cheng-xi-lie-qian-xi-duo-xian-cheng-zhong-de-tong-bu-he-si-suo/"/>
      <url>/2018/08/06/05.jin-cheng-xian-cheng-xi-lie-qian-xi-duo-xian-cheng-zhong-de-tong-bu-he-si-suo/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong><font color="#AAAAAA">é€šè¿‡ä¸€ä¸ªæ—¥å¸¸å–ç¥¨ç³»ç»Ÿç»Ÿè®¡å‰©ä½™ç¥¨æ•°çš„å° Demo é—®é¢˜ï¼Œå¼•å…¥ synchronized ç”¨æ³•ï¼Œé‡ç‚¹æ¢è®¨ä½•ä¸ºâ€œæ­»é”â€ï¼Œäº§ç”ŸåŸå› ã€æ¡ä»¶åŠå¦‚ä½•è§£å†³ï¼</font></strong></p></blockquote><hr><h1 id="1-Thread-åŒæ­¥"><a href="#1-Thread-åŒæ­¥" class="headerlink" title="1. Thread - åŒæ­¥"></a>1. Thread - åŒæ­¥</h1><h2 id="1-1-é—®é¢˜å¼•å‡º"><a href="#1-1-é—®é¢˜å¼•å‡º" class="headerlink" title="1.1 é—®é¢˜å¼•å‡º"></a>1.1 é—®é¢˜å¼•å‡º</h2><p>æˆ‘ä»¬ç°åœ¨æ¥é€šè¿‡ Runnable æ¥å£å®ç°å¤šçº¿ç¨‹ï¼Œäº§ç”Ÿ 3 ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œæ¨¡æ‹Ÿå–ç¥¨çš„åœºæ™¯ï¼</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿæ—¥å¸¸å–ç¥¨åœºæ™¯</span><span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// åŠ å…¥å»¶è¿Ÿ</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å–ç¥¨ï¼šticket = "</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncDemo01</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MyThread mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>            t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿå¤šçª—å£å–ç¥¨</span>        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿå¤šçª—å£å–ç¥¨</span>        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿå¤šçª—å£å–ç¥¨</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬æ‰§è¡Œä¸‹è¿™æ®µä»£ç ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>å–ç¥¨ï¼šticket = 5å–ç¥¨ï¼šticket = 4å–ç¥¨ï¼šticket = 5å–ç¥¨ï¼šticket = 3å–ç¥¨ï¼šticket = 2å–ç¥¨ï¼šticket = 2å–ç¥¨ï¼šticket = 1å–ç¥¨ï¼šticket = 0å–ç¥¨ï¼šticket = -1    // ç¥¨æ•°ç«Ÿç„¶è¿˜èƒ½è´Ÿæ•°ï¼Ÿ</code></pre><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°â€œè´Ÿæ•°â€çš„æƒ…å†µï¼šåœ¨ä¸Šé¢çš„æ“ä½œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå› ä¸ºåŠ å…¥äº†â€œå»¶è¿Ÿæ“ä½œâ€ä¸€ä¸ªçº¿ç¨‹å¾ˆæœ‰å¯èƒ½åœ¨è¿˜æ²¡å¯¹ç¥¨æ•°è¿›è¡Œå‡æ“ä½œä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹å°±å·²ç»å°†ç¥¨æ•°å‡å°‘äº†ï¼Œè¿™æ ·å°±ä¼šå‡ºç°ç¥¨æ•°ä¸ºè´Ÿçš„æƒ…å†µã€‚</p><p>æœ‰æ²¡æœ‰æ–¹æ³•è§£å†³ï¼Ÿè‚¯å®šæ˜¯æœ‰çš„ï¼æƒ³è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œå°±å¿…é¡»ä½¿ç”¨åŒæ­¥ï¼æ‰€è°“åŒæ­¥ï¼Œå°±æ˜¯æŒ‡å¤šä¸ªæ“ä½œåœ¨åŒä¸€ä¸ªæ—¶é—´æ®µå†…åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œï¼Œå…¶ä»–çº¿ç¨‹è¦ç­‰å¾…æ­¤çº¿ç¨‹å®Œæˆä¹‹åæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</p><h2 id="1-2-è§£å†³é—®é¢˜"><a href="#1-2-è§£å†³é—®é¢˜" class="headerlink" title="1.2 è§£å†³é—®é¢˜"></a>1.2 è§£å†³é—®é¢˜</h2><p>è§£å†³èµ„æºå…±äº«çš„åŒæ­¥æ“ä½œï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š<strong><font color="#FF0000">â€œåŒæ­¥ä»£ç å—â€</font></strong> å’Œ <strong><font color="#FF0000">â€œåŒæ­¥æ–¹æ³•â€</font></strong> ï¼</p><h3 id="1-2-1-åŒæ­¥ä»£ç å—"><a href="#1-2-1-åŒæ­¥ä»£ç å—" class="headerlink" title="1.2.1 åŒæ­¥ä»£ç å—"></a>1.2.1 åŒæ­¥ä»£ç å—</h3><p>æ‰€è°“ä»£ç å—å°±æ˜¯æŒ‡ä½¿ç”¨â€œ{}â€æ‹¬èµ·æ¥çš„ä¸€æ®µä»£ç ï¼Œå¦‚æœåœ¨ä»£ç å—ä¸ŠåŠ ä¸Š synchronized å…³é”®å­—ï¼Œåˆ™æ­¤ä»£ç å—å°±æˆä¸ºâ€œåŒæ­¥ä»£ç å—â€ã€‚</p><p><strong><font color="#D15FEE">ã€åŒæ­¥ä»£ç å— - æ ¼å¼ã€‘</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">synchronized</span><span class="token punctuation">(</span>åŒæ­¥å¯¹è±¡<span class="token punctuation">)</span> <span class="token punctuation">{</span>    éœ€è¦åŒæ­¥çš„ä»£ç  <span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬å¯¹ä»£ç è¿›è¡Œä¿®æ”¹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">// åŠ å…¥åŒæ­¥æ“ä½œ</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// åŠ å…¥å»¶è¿Ÿ</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å–ç¥¨ï¼šticket = "</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncDemo01</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MyThread mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>            t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬é‡æ–°æ‰§è¡Œä¸‹è¿™æ®µä»£ç ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>å–ç¥¨ï¼šticket = 5å–ç¥¨ï¼šticket = 4å–ç¥¨ï¼šticket = 3å–ç¥¨ï¼šticket = 2å–ç¥¨ï¼šticket = 1</code></pre><h3 id="1-2-2-åŒæ­¥æ–¹æ³•"><a href="#1-2-2-åŒæ­¥æ–¹æ³•" class="headerlink" title="1.2.2 åŒæ­¥æ–¹æ³•"></a>1.2.2 åŒæ­¥æ–¹æ³•</h3><p>é™¤äº†å¯ä»¥å°†éœ€è¦çš„ä»£ç è®¾ç½®æˆåŒæ­¥ä»£ç å—å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ synchronized å…³é”®å­—å°†ä¸€ä¸ªæ–¹æ³•å£°æ˜æˆâ€œåŒæ­¥æ–¹æ³•â€ã€‚</p><p><strong><font color="#D15FEE">ã€åŒæ­¥æ–¹æ³• - æ ¼å¼ã€‘</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">synchronized</span> æ–¹æ³•è¿”å›å€¼ æ–¹æ³•åç§°<span class="token punctuation">(</span>å‚æ•°åˆ—è¡¨<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬é‡‡ç”¨åŒæ­¥æ–¹æ³•å¯¹ä»£ç è¿›è¡Œä¿®æ”¹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment" spellcheck="true">// è°ƒç”¨åŒæ­¥æ–¹æ³•</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// å£°æ˜åŒæ­¥æ–¹æ³•</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å–ç¥¨ï¼šticket = "</span> <span class="token operator">+</span> ticket<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncDemo01</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MyThread mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">)</span><span class="token punctuation">;</span>            t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬é‡æ–°æ‰§è¡Œä¸‹è¿™æ®µä»£ç ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>å–ç¥¨ï¼šticket = 5å–ç¥¨ï¼šticket = 4å–ç¥¨ï¼šticket = 3å–ç¥¨ï¼šticket = 2å–ç¥¨ï¼šticket = 1</code></pre><p>ä»ä»¥ä¸Šç¨‹åºçš„è¿è¡Œç»“æœå¯ä»¥å‘ç°ï¼Œæ­¤ä»£ç å®Œæˆäº†ä¸ä¹‹å‰åŒæ­¥ä»£ç å—åŒæ ·çš„åŠŸèƒ½ã€‚</p><h2 id="1-3-æ€»ç»“"><a href="#1-3-æ€»ç»“" class="headerlink" title="1.3 æ€»ç»“"></a>1.3 æ€»ç»“</h2><p>å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€èµ„æºæ—¶éœ€è¦è¿›è¡ŒåŒæ­¥ï¼Œä»¥ä¿è¯èµ„æºæ“ä½œçš„å®Œæ•´æ€§ã€‚</p><h1 id="2-Thread-æ­»é”"><a href="#2-Thread-æ­»é”" class="headerlink" title="2. Thread - æ­»é”"></a>2. Thread - æ­»é”</h1><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å‘ç°ï¼ŒåŒæ­¥è¿˜æ˜¯å¾ˆæœ‰å¥½å¤„çš„ï¼Œå®ƒå¯ä»¥ä¿è¯èµ„æºå…±äº«æ“ä½œçš„æ­£ç¡®æ€§ï¼Œä½†æ˜¯è¿‡å¤šçš„åŒæ­¥ä¹Ÿä¼šäº§ç”Ÿé—®é¢˜ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦è®¨è®ºâ€œæ­»é”â€é—®é¢˜ï¼</p><h2 id="2-1-ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ"><a href="#2-1-ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ"></a>2.1 ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ</h2><p>å¤šçº¿ç¨‹ä»¥åŠå¤šè¿›ç¨‹æ”¹å–„äº†ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡å¹¶æé«˜äº†ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ã€‚ç„¶è€Œï¼Œå¹¶å‘æ‰§è¡Œä¹Ÿå¸¦æ¥äº†æ–°çš„é—®é¢˜ - - <strong><font color="#FF0000">â€œæ­»é”â€</font></strong>ã€‚</p><p>åœ¨ç¼–å†™å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œå¿…é¡»è¦æ³¨æ„èµ„æºçš„ä½¿ç”¨é—®é¢˜ï¼Œå¦‚æœä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åˆ†åˆ«æ‹¥æœ‰ä¸åŒçš„èµ„æºï¼Œè€ŒåŒæ—¶åˆéœ€è¦å¯¹æ–¹é‡Šæ”¾èµ„æºæ‰èƒ½ç»§ç»­è¿è¡Œæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­»é”ã€‚</p><p><strong><font color="#8A2BE2">ç®€å•æ¥è¯´</font></strong>ï¼šæ­»é”å°±æ˜¯å½“ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ç³»ç»Ÿèµ„æºï¼Œè€Œèµ„æºæœ¬èº«åˆè¢«å ç”¨æ—¶æ‰€äº§ç”Ÿçš„ä¸€ç§çŠ¶æ€ã€‚</p><h2 id="2-2-é€ æˆæ­»é”çš„åŸå› "><a href="#2-2-é€ æˆæ­»é”çš„åŸå› " class="headerlink" title="2.2 é€ æˆæ­»é”çš„åŸå› "></a>2.2 é€ æˆæ­»é”çš„åŸå› </h2><p>å¤šä¸ªçº¿ç¨‹ç«äº‰å…±äº«èµ„æºï¼Œç”±äºèµ„æºè¢«å ç”¨ï¼Œèµ„æºä¸è¶³æˆ–è¿›ç¨‹æ¨è¿›é¡ºåºä¸å½“ç­‰åŸå› é€ æˆçº¿ç¨‹å¤„äºæ°¸ä¹…é˜»å¡çŠ¶æ€ï¼Œä»è€Œå¼•å‘æ­»é”ã€‚</p><h2 id="2-3-é€ æˆæ­»é”çš„å››ä¸ªæ¡ä»¶"><a href="#2-3-é€ æˆæ­»é”çš„å››ä¸ªæ¡ä»¶" class="headerlink" title="2.3 é€ æˆæ­»é”çš„å››ä¸ªæ¡ä»¶"></a>2.3 é€ æˆæ­»é”çš„å››ä¸ªæ¡ä»¶</h2><p>1ã€<strong><font color="#1874CD">äº’æ–¥æ¡ä»¶</font></strong>ï¼šè¿›ç¨‹å¯¹äºæ‰€åˆ†é…åˆ°çš„èµ„æºå…·æœ‰æ’å®ƒæ€§ï¼Œå³ä¸€ä¸ªèµ„æºåªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹å ç”¨ï¼Œç›´åˆ°è¢«è¯¥è¿›ç¨‹é‡Šæ”¾ã€‚<br>2ã€<strong><font color="#1874CD">è¯·æ±‚å’Œä¿æŒæ¡ä»¶</font></strong>ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚è¢«å ç”¨èµ„æºè€Œå‘ç”Ÿé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚<br>3ã€<strong><font color="#1874CD">ä¸å‰¥å¤ºæ¡ä»¶</font></strong>ï¼šä»»ä½•ä¸€ä¸ªèµ„æºåœ¨æ²¡è¢«è¯¥è¿›ç¨‹é‡Šæ”¾ä¹‹å‰ï¼Œä»»ä½•å…¶ä»–è¿›ç¨‹éƒ½æ— æ³•å¯¹ä»–å‰¥å¤ºå ç”¨ã€‚<br>4ã€<strong><font color="#1874CD">å¾ªç¯ç­‰å¾…æ¡ä»¶</font></strong>ï¼šå½“å‘ç”Ÿæ­»é”æ—¶ï¼Œæ‰€ç­‰å¾…çš„è¿›ç¨‹å¿…å®šä¼šå½¢æˆä¸€ä¸ªç¯è·¯ï¼ˆç±»ä¼¼äºæ­»å¾ªç¯ï¼‰ï¼Œé€ æˆæ°¸ä¹…é˜»å¡ã€‚</p><h2 id="2-4-é—®é¢˜å¼•å‡º"><a href="#2-4-é—®é¢˜å¼•å‡º" class="headerlink" title="2.4 é—®é¢˜å¼•å‡º"></a>2.4 é—®é¢˜å¼•å‡º</h2><p>ç°åœ¨å¼ ä¸‰æƒ³è¦æå››çš„ç”»ï¼Œæå››æƒ³è¦å¼ ä¸‰çš„ä¹¦ï¼Œäºæ˜¯äº§ç”Ÿäº†ä»¥ä¸‹å¯¹è¯ï¼š</p><p>å¼ ä¸‰å¯¹æå››è¯´ï¼šâ€œæŠŠä½ çš„ç”»ç»™æˆ‘ï¼Œæˆ‘å°±ç»™ä½ ä¹¦â€<br>æå››å¯¹å¼ ä¸‰è¯´ï¼šâ€œæŠŠä½ çš„ä¹¦ç»™æˆ‘ï¼Œæˆ‘å°±ç»™ä½ ç”»â€</p><p>æ­¤æ—¶ï¼Œå¼ å±±åœ¨ç­‰ç€æå››çš„ç­”å¤ï¼Œæå››ä¹Ÿåœ¨ç­‰ç€å¼ ä¸‰çš„ç­”å¤ï¼Œé‚£ä¹ˆè¿™æ ·ä¸‹å»çš„ç»“æœå°±æ˜¯ï¼Œä¸¤ä¸ªäººéƒ½åœ¨ç­‰å¾…ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰ç»“æœï¼Œè¿™å°±æ˜¯â€œæ­»é”â€ï¼</p><p>ä»çº¿ç¨‹è§’åº¦æ¥è¯´ï¼Œæ‰€è°“æ­»é”å°±æ˜¯æŒ‡ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰å¾…å½¼æ­¤å…ˆå®Œæˆï¼Œé€ æˆäº†ç¨‹åºçš„åœæ»ï¼Œä¸€èˆ¬ç¨‹åºçš„æ­»é”éƒ½æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶å‡ºç°ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä»£ç èŒƒä¾‹æ¥çœ‹çœ‹å‘ç”Ÿæ­»é”çš„åœºæ™¯ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Zhangsan</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Zhangsan say: give me your painting, i will give you my book!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Zhangsan got Lisi's painting!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Lisi</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Lisi say: give me your book, i will give you my painting!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Lisi got Zhangsan's book!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadDeadLock</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Zhangsan zs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Zhangsan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// å®ä¾‹åŒ– static å‹å¯¹è±¡ï¼Œæ•°æ®å…±äº«</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Lisi ls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lisi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// å®ä¾‹åŒ– static å‹å¯¹è±¡ï¼Œæ•°æ®å…±äº«</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// å£°æ˜æ ‡è®°ï¼Œç”¨äºåˆ¤æ–­å“ªä¸ªå¯¹è±¡å…ˆæ‰§è¡Œ</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// åˆ¤æ–­æ ‡å¿—ä½ï¼Œflag ä¸º trueï¼ŒZhangsan å…ˆæ‰§è¡Œ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>zs<span class="token punctuation">)</span> <span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">// åŒæ­¥ç¬¬ä¸€ä¸ªå¯¹è±¡</span>                zs<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>ls<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">// åŒæ­¥ç¬¬äºŒä¸ªå¯¹è±¡</span>                    zs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                     <span class="token comment" spellcheck="true">// Lisiå…ˆæ‰§è¡Œ</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>ls<span class="token punctuation">)</span> <span class="token punctuation">{</span>                      <span class="token comment" spellcheck="true">// åŒæ­¥ç¬¬äºŒä¸ªå¯¹è±¡</span>                ls<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>zs<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token comment" spellcheck="true">// åŒæ­¥ç¬¬ä¸€ä¸ªå¯¹è±¡</span>                    ls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ThreadDeadLock t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadDeadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ThreadDeadLock t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadDeadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t1<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        t2<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        Thread thA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread thB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">;</span>        thA<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        thB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æˆ‘ä»¬æ‰§è¡Œä¸‹è¿™æ®µä»£ç ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>Zhangsan say: give me your painting, i will give you my book!Lisi say: give me your book, i will give you my painting!</code></pre><p>ä»ç¨‹åºçš„è¿è¡Œç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨å½¼æ­¤ç­‰å¾…ç€å¯¹æ–¹çš„æ‰§è¡Œå®Œæˆï¼Œè¿™æ ·ï¼Œç¨‹åºå°±æ— æ³•å‘ä¸‹ç»§ç»­æ‰§è¡Œï¼Œä»è€Œé€ æˆäº†æ­»é”çš„ç°è±¡ã€‚</p><h2 id="2-5-è§£å†³é—®é¢˜"><a href="#2-5-è§£å†³é—®é¢˜" class="headerlink" title="2.5 è§£å†³é—®é¢˜"></a>2.5 è§£å†³é—®é¢˜</h2><p>è¦é¢„é˜²å’Œé¿å…æ­»é”çš„å‘ç”Ÿï¼Œåªéœ€å°†ä¸Šé¢æ‰€è®²åˆ°çš„ 4 ä¸ªæ¡ä»¶ç ´åæ‰å…¶ä¸­ä¹‹ä¸€å³å¯ã€‚</p><p>å¦‚ä¸Šé¢çš„ä»£ç å½“ä¸­ï¼Œæœ‰å››ä¸ªåŒæ­¥ä»£ç å—ï¼Œåªéœ€è¦å°†å…¶ä¸­ä¸€ä¸ªåŒæ­¥ä»£ç å—å»æ‰ï¼Œå³å¯è§£å†³æ­»é”é—®é¢˜ï¼Œä¸€èˆ¬è€Œè¨€ç ´åâ€œå¾ªç¯ç­‰å¾…â€è¿™ä¸ªæ¡ä»¶æ˜¯è§£å†³æ­»é”æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚</p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> è¿›ç¨‹çº¿ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Synchronized </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢è®¨ â€œåŠ¨æ€å¹¿æ’­â€ å’Œ â€œé™æ€å¹¿æ’­â€ çš„ç”¨æ³•å’ŒåŒºåˆ«</title>
      <link href="/2018/07/28/08.chang-yong-zu-jian-xi-lie-tan-tao-dong-tai-guang-bo-he-jing-tai-guang-bo-de-yong-fa-he-qu-bie/"/>
      <url>/2018/07/28/08.chang-yong-zu-jian-xi-lie-tan-tao-dong-tai-guang-bo-he-jing-tai-guang-bo-de-yong-fa-he-qu-bie/</url>
      
        <content type="html"><![CDATA[<h1 id="åŠ¨æ€æ³¨å†Œ"><a href="#åŠ¨æ€æ³¨å†Œ" class="headerlink" title="åŠ¨æ€æ³¨å†Œ"></a>åŠ¨æ€æ³¨å†Œ</h1><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p>æ–°å»ºä¸€ä¸ª BroadcastTest é¡¹ç›®ï¼Œä¿®æ”¹ MainActivity ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>broadcasttest<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>BroadcastReceiver<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Intent<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>IntentFilter<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Toast<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> IntentFilter intentFilter<span class="token punctuation">;</span>    <span class="token keyword">private</span> NetworkChangeReceiver networkChangeReceiver<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        intentFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token string">"android.net.conn.CONNECTIVITY_CHANGE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        networkChangeReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetworkChangeReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">registerReceiver</span><span class="token punctuation">(</span>networkChangeReceiver<span class="token punctuation">,</span> intentFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">unregisterReceiver</span><span class="token punctuation">(</span>networkChangeReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">NetworkChangeReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"network changes"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="é™æ€æ³¨å†Œ"><a href="#é™æ€æ³¨å†Œ" class="headerlink" title="é™æ€æ³¨å†Œ"></a>é™æ€æ³¨å†Œ</h1><p>â€œåŠ¨æ€æ³¨å†Œâ€çš„å¹¿æ’­æ¥æ”¶å™¨å¯ä»¥è‡ªç”±åœ°æ§åˆ¶æ³¨å†Œä¸æ³¨é”€ï¼Œåœ¨çµæ´»æ€§æ–¹é¢æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯å®ƒä¹Ÿå­˜åœ¨ä¸€ä¸ªç¼ºç‚¹ï¼šå¿…é¡»è¦åœ¨ç¨‹åºå¯åŠ¨ä¹‹åæ‰èƒ½æ¥æ”¶åˆ°å¹¿æ’­ï¼Œå› ä¸ºæ³¨å†Œçš„é€»è¾‘æ˜¯å†™åœ¨ onCreate() æ–¹æ³•ä¸­çš„ã€‚</p><p>é‚£ä¹ˆæœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥è®©ç¨‹åºåœ¨æœªå¯åŠ¨çš„æƒ…å†µä¸‹å°±èƒ½æ¥æ”¶åˆ°å¹¿æ’­å‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬å³å°†çœ‹åˆ°çš„â€œé™æ€æ³¨å†Œâ€æ–¹æ³•äº†ï¼</p><h2 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h2><p>ï¼ˆ1ï¼‰æ–°å»ºä¸€ä¸ª BroadcastReceiverï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>broadcasttest<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>BroadcastReceiver<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Intent<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Toast<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BootCompleteReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"Boot Complete"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ï¼ˆ2ï¼‰é™æ€å¹¿æ’­æ¥æ”¶å™¨ä¸€å®šè¦åœ¨ AndroidManifest.xml æ–‡ä»¶ä¸­æ³¨å†Œæ‰å¯ä»¥ä½¿ç”¨ï¼Œå¦‚æœä½ ä½¿ç”¨ Android Studio å¿«æ·æ–¹å¼åˆ›å»ºäº†è¿™ä¸ªå¹¿æ’­æ¥æ”¶å™¨ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨ AndroidManifest.xml ä¸­æ³¨å†Œå¥½è¿™ä¸ªå¹¿æ’­æ¥æ”¶å™¨ï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.marco.broadcasttest<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>        <span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>roundIcon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher_round<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>supportsRtl</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/AppTheme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>        &lt;receiver            android:name=".BootCompleteReceiver"            android:enabled="true"                  // æ˜¯å¦å¯ç”¨è¿™ä¸ªå¹¿æ’­æ¥æ”¶å™¨            android:exported="true"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>receiver</span><span class="token punctuation">></span></span>     // æ˜¯å¦å…è®¸è¿™ä¸ªå¹¿æ’­æ¥æ”¶å™¨æ¥æ”¶æœ¬ç¨‹åºä»¥å¤–çš„å¹¿æ’­    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span></code></pre><p>ï¼ˆ3ï¼‰æ­¤æ—¶å¹¿æ’­æ¥æ”¶å™¨è¿˜æœªèƒ½æ¥æ”¶åˆ°å¼€æœºå¹¿æ’­ï¼Œéœ€è¦æ·»åŠ  Action å’Œ æƒé™ï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.marco.broadcasttest<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    // æ·»åŠ æƒé™    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.RECEIVE_BOOT_COMPLETED<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>        <span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>roundIcon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher_round<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>supportsRtl</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/AppTheme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>receiver</span>            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.BootCompleteReceiver<span class="token punctuation">"</span></span>            <span class="token attr-name"><span class="token namespace">android:</span>enabled</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>            <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            // æ·»åŠ ç›¸åº”çš„ Action            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.BOOT_COMPLETED<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>receiver</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> å¸¸ç”¨ç»„ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Broadcast </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢è®¨ Service çš„ä½¿ç”¨æ–¹æ³•</title>
      <link href="/2018/07/25/08.chang-yong-zu-jian-xi-lie-tan-tao-service-de-shi-yong-fang-fa/"/>
      <url>/2018/07/25/08.chang-yong-zu-jian-xi-lie-tan-tao-service-de-shi-yong-fang-fa/</url>
      
        <content type="html"><![CDATA[<h1 id="å¼€ç¯‡"><a href="#å¼€ç¯‡" class="headerlink" title="å¼€ç¯‡"></a>å¼€ç¯‡</h1><h2 id="æ ¸å¿ƒæºç "><a href="#æ ¸å¿ƒæºç " class="headerlink" title="æ ¸å¿ƒæºç "></a>æ ¸å¿ƒæºç </h2><table><thead><tr><th>å…³é”®ç±»</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><font color="#D15FEE">Service.java</font></td><td>frameworks/base/core/java/android/app/Service.java</td></tr></tbody></table><h2 id="æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æœåŠ¡ï¼ˆServiceï¼‰æ˜¯ Android ä¸­å®ç°ç¨‹åºåå°è¿è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒéå¸¸é€‚åˆå»æ‰§è¡Œé‚£äº›ä¸éœ€è¦å’Œç”¨æˆ·äº¤äº’è€Œä¸”è¿˜éœ€è¦é•¿æœŸè¿›è¡Œçš„ä»»åŠ¡ã€‚æœåŠ¡çš„è¿è¡Œä¸ä¾èµ–äºä»»ä½•ç”¨æˆ·ç•Œé¢ï¼Œå³ä½¿ç¨‹åºè¢«åˆ‡æ¢åˆ°åå°ï¼Œæˆ–è€…ç”¨æˆ·æ‰“å¼€äº†å¦å¤–ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ŒæœåŠ¡ä»ç„¶èƒ½å¤Ÿä¿æŒæ­£å¸¸è¿è¡Œã€‚</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæœåŠ¡å¹¶ä¸æ˜¯è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹å½“ä¸­çš„ï¼Œè€Œæ˜¯ä¾èµ–äºåˆ›å»ºæœåŠ¡æ—¶æ‰€åœ¨çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚å½“æŸä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹è¢«æ€æ‰æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºè¯¥è¿›ç¨‹çš„æœåŠ¡ä¹Ÿä¼šåœæ­¢è¿è¡Œã€‚</p><h1 id="Service-ä½¿ç”¨æ–¹æ³•"><a href="#Service-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="Service ä½¿ç”¨æ–¹æ³•"></a>Service ä½¿ç”¨æ–¹æ³•</h1><h2 id="å®šä¹‰ä¸€ä¸ªæœåŠ¡"><a href="#å®šä¹‰ä¸€ä¸ªæœåŠ¡" class="headerlink" title="å®šä¹‰ä¸€ä¸ªæœåŠ¡"></a>å®šä¹‰ä¸€ä¸ªæœåŠ¡</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªMyService.javaç±»ï¼Œå½“ç„¶ä½œä¸ºä¸€ä¸ªæœåŠ¡ç±»ï¼Œå¿…é¡»è¦ç»§æ‰¿ Serviceï¼ˆandroid.app.Serviceï¼‰ï¼Œçœ‹ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/android/app/Service.java</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token keyword">extends</span> <span class="token class-name">ContextWrapper</span> <span class="token keyword">implements</span> <span class="token class-name">ComponentCallbacks2</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"Service"</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token annotation punctuation">@Nullable</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>Service å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³• onBindï¼Œå­ç±»ç»§æ‰¿å®ƒï¼Œå¿…é¡»å¤å†™æ­¤æ–¹æ³•ã€‚</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>ã€€ã€€<span class="token annotation punctuation">@Nullable</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆå­ç±»æ˜¯å¿…é¡»è¦é‡å†™çš„</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æœåŠ¡æ—¢ç„¶å·²ç»å®šä¹‰å¥½äº†ï¼Œè‡ªç„¶åº”è¯¥åœ¨æœåŠ¡ä¸­å»å¤„ç†ä¸€äº›äº‹æƒ…ï¼Œé‚£å¤„ç†äº‹æƒ…çš„é€»è¾‘åº”è¯¥å†™åœ¨å“ªé‡Œï¼Ÿæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡é‡Œé‡å†™ Service ä¸­çš„å¦ä¸€äº›å¸¸ç”¨çš„æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>ã€€ã€€<span class="token annotation punctuation">@Nullable</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆå­ç±»æ˜¯å¿…é¡»è¦é‡å†™çš„</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                <span class="token comment" spellcheck="true">// æœåŠ¡åˆ›å»ºæ—¶è°ƒç”¨</span>ã€€ã€€    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨</span>ã€€ã€€    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                               <span class="token comment" spellcheck="true">// æœåŠ¡é”€æ¯æ—¶è°ƒç”¨</span>ã€€ã€€    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>å’Œæ·»åŠ  Activity ä¸€æ ·ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆåœ¨ AndroidManifest.xml æ–‡ä»¶ä¸­å¿…é¡»è¿›è¡Œæ³¨å†Œæ‰èƒ½ç”Ÿæ•ˆï¼</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.xin02ma.myapplication<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ã€€ã€€<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>ã€€ã€€ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>ã€€ã€€ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher<span class="token punctuation">"</span></span>ã€€ã€€ã€€ã€€<span class="token attr-name">......</span>ã€€ã€€ã€€ã€€<span class="token attr-name">&lt;activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ã€€ã€€ã€€ã€€ã€€ã€€......ã€€ã€€ã€€ã€€<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>ã€€ã€€ã€€ã€€<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MyService<span class="token punctuation">"</span></span>                 <span class="token attr-name"><span class="token namespace">android:</span>enabled</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>                 <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>ã€€ã€€<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span></code></pre><h2 id="å¯åŠ¨å’Œåœæ­¢æœåŠ¡"><a href="#å¯åŠ¨å’Œåœæ­¢æœåŠ¡" class="headerlink" title="å¯åŠ¨å’Œåœæ­¢æœåŠ¡"></a>å¯åŠ¨å’Œåœæ­¢æœåŠ¡</h2><p>æœåŠ¡å®šä¹‰å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±åº”è¯¥è€ƒè™‘å¦‚ä½•å»å¯åŠ¨ä»¥åŠåœæ­¢è¿™ä¸ªæœåŠ¡äº†ã€‚</p><p>ï¼ˆ1ï¼‰å…ˆæ·»åŠ ä¸¤ä¸ªButtonï¼ˆactivity_main.xmlï¼‰</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/start_service<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@string/start_service<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/stop_service<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@string/stop_service<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><center><img src="https://upload-images.jianshu.io/upload_images/3517194-d7ec3fa46f355206.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ·»åŠ ä¸¤ä¸ªButton.png"></center><p>ã€€ã€€ï¼ˆ2ï¼‰æ¥ä¸‹æ¥ï¼Œä¿®æ”¹ä¸»å‡½æ•° MainActivity çš„ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">{</span>ã€€ã€€<span class="token keyword">private</span> Button startService<span class="token punctuation">;</span>                                              ã€€ã€€<span class="token keyword">private</span> Button stopService<span class="token punctuation">;</span>ã€€ã€€<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment" spellcheck="true">// é‡‡ç”¨å¸ƒå±€</span>ã€€ã€€ã€€ã€€startService <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>start_service<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// å–å¾—Buttonå®ä¾‹</span>ã€€ã€€ã€€ã€€stopService <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>stop_service<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// å–å¾—Buttonå®ä¾‹</span>ã€€ã€€ã€€ã€€startService<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment" spellcheck="true">// ç›‘æ§Button,æ³¨å†ŒæŒ‰é’®äº‹ä»¶</span>ã€€ã€€ã€€ã€€stopService<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment" spellcheck="true">// ç›‘æ§Button,æ³¨å†ŒæŒ‰é’®æ—¶é—´</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">switch</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>start_service<span class="token operator">:</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Intent startIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">startService</span><span class="token punctuation">(</span>startIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>                                          <span class="token comment" spellcheck="true">// å¯åŠ¨æœåŠ¡</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>stop_service<span class="token operator">:</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Intent stopIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">stopService</span><span class="token punctuation">(</span>stopIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment" spellcheck="true">// åœæ­¢æœåŠ¡</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">default</span><span class="token operator">:</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢çš„ä»£ç å¾ˆç®€å•ï¼Œä¸»è¦ä½œäº†ä»¥ä¸‹å·¥ä½œï¼š</p><p>ï¼ˆ1ï¼‰å–å¾— <font color="#FFFF00">startService</font> å’Œ <font color="#FFFF00">stopService</font> ä¸¤ä¸ªæŒ‰é’®å®ä¾‹ï¼Œå¹¶ä¸”æ³¨å†Œäº†ç‚¹å‡»äº‹ä»¶ï¼›</p><p>ï¼ˆ2ï¼‰é€šè¿‡ Intent å¯¹è±¡ï¼Œè°ƒç”¨ Activity çš„ <font color="#FFFF00">startService()</font> å’Œ <font color="#FFFF00">stopService()</font> æ–¹æ³•æ¥å¯åŠ¨å’Œåœæ­¢æœåŠ¡ã€‚</p><p><strong><font color="#FF0000" size="4">ã€Noticeã€‘</font></strong></p><p>è¿™é‡Œçš„æ´»åŠ¨çš„å¯åŠ¨å’Œåœæ­¢å®Œå…¨æ˜¯ç”±æ´»åŠ¨æœ¬èº«æ§åˆ¶çš„ï¼Œå¦‚æœæˆ‘ä»¬ start äº†æœåŠ¡ï¼Œä½†æ˜¯æ²¡æœ‰ç‚¹å‡» stopï¼Œé‚£ä¹ˆæœåŠ¡ä¼šä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ­¤æ—¶æœåŠ¡å¦‚ä½•è®©è‡ªå·±åœæ­¢ä¸‹æ¥ï¼Ÿ</p><p>åªéœ€è¦åœ¨ MyService çš„ä»»ä½•ä¸€ä¸ªä½ç½®è°ƒç”¨ <strong><font color="#836FFF">stopSelf()</font></strong> è¿™ä¸ªæ–¹æ³•å°±èƒ½è®©æœåŠ¡åœä¸‹æ¥ï¼</p><h2 id="Logæµ‹è¯•"><a href="#Logæµ‹è¯•" class="headerlink" title="Logæµ‹è¯•"></a>Logæµ‹è¯•</h2><p>æ·»åŠ Logï¼ŒæŸ¥çœ‹Serviceæ˜¯å¦‚ä½•è¿ä½œçš„ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"MyService"</span><span class="token punctuation">;</span>ã€€ã€€<span class="token annotation punctuation">@Nullable</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆå­ç±»æ˜¯å¿…é¡»è¦é‡å†™çš„</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                <span class="token comment" spellcheck="true">// æœåŠ¡åˆ›å»ºæ—¶è°ƒç”¨</span>ã€€ã€€    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCreate executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨</span>ã€€    ã€€Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onStartCommand executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€    ã€€<span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                               <span class="token comment" spellcheck="true">// æœåŠ¡é”€æ¯æ—¶è°ƒç”¨</span>ã€€ã€€    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onDestroy executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æ·»åŠ äº†3è¡ŒLogï¼Œç›®çš„å°±æ˜¯çœ‹ï¼šåœ¨æˆ‘ä»¬ç‚¹å‡»ä¸¤ä¸ªæŒ‰é’®çš„æ—¶å€™ï¼Œæ•´ä¸ªServiceä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Œä»€ä¹ˆæ—¶å€™å¯åŠ¨ï¼Œä»€ä¹ˆæ—¶å€™æ¯ç­ï¼</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œç»“æœï¼Œè¿è¡Œç¨‹åºï¼ŒæŸ¥çœ‹Logcatä¸­çš„æ‰“å°æ—¥å¿—ï¼š<br><br></p><center><img src="http://upload-images.jianshu.io/upload_images/3517194-0eede444c1a496ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="image"></center><p>ï¼ˆ1ï¼‰ç¬¬ä¸€æ¬¡ç‚¹å‡» <strong><font color="#836FFF">StartServiceæŒ‰é’®</font></strong> åï¼ŒMyServiceä¸­çš„ <strong><font color="#FFFF00">onCreate()</font></strong> å’Œ <strong><font color="#FFFF00">onStartCommand()</font></strong> æ–¹æ³•éƒ½æ‰§è¡Œäº†ï¼Œå›¾ä¸­é»„è‰²ç®­å¤´æ‰€ç¤ºï¼<br>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <strong><font color="#FFFFFF">æ‰‹æœº â€“&gt; è®¾ç½® â€“&gt; åº”ç”¨ â€“&gt; è¿è¡Œä¸­</font></strong> å¯ä»¥çœ‹åˆ°è¿™ä¸ªæœåŠ¡ï¼š<br><br></p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-e84ffff234f1eddd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="Service.png"></center><p>ï¼ˆ2ï¼‰ç„¶åæˆ‘ä»¬ç‚¹å‡» <strong><font color="#836FFF">stopServiceæŒ‰é’®</font></strong> åï¼ŒMyServiceä¸­çš„ <strong><font color="#00B2EE">onDestory()</font></strong> æ–¹æ³•è¢«æ‰§è¡Œï¼Œå›¾ä¸­è“è‰²ç®­å¤´æ‰€ç¤ºï¼</p><p>ï¼ˆ3ï¼‰æ­¤æ—¶å¯èƒ½ä½ ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Ÿå½“æˆ‘ä»¬ç‚¹å‡»äº† <strong><font color="#836FFF">startServiceæŒ‰é’®</font></strong> ä»¥åï¼Œ<strong><font color="#FFFF00">onCreate()</font></strong> å’Œ <strong><font color="#FFFF00">onStartCommand()</font></strong>æ–¹æ³•åŒæ—¶è¢«æ‰§è¡Œï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><p>å›¾ä¸­çš„ <strong><font color="#FF0000">çº¢è‰²ç®­å¤´</font></strong> ç»™äº†æˆ‘ä»¬ç­”æ¡ˆï¼š<strong><font color="#FFFF00">onCreat()</font></strong> æ–¹æ³•æ˜¯åœ¨æœåŠ¡ç¬¬ä¸€æ¬¡åˆ›å»ºçš„æ—¶å€™è°ƒç”¨çš„ï¼Œè€Œ <strong><font color="#FFFF00">onStartCommand()</font></strong> æ–¹æ³•åˆ™åœ¨æ¯æ¬¡å¯åŠ¨æœåŠ¡çš„æ—¶å€™éƒ½ä¼šè¢«è°ƒç”¨ã€‚</p><p>å½“æˆ‘ä»¬åœ¨ <strong><font color="#FFFFFF">æœåŠ¡æœªå¯åŠ¨</font></strong> çš„æ—¶å€™ï¼Œç‚¹å‡» <strong><font color="#836FFF">startService æŒ‰é’®</font></strong>ï¼Œåˆ™æ­¤æ—¶ä¼š <strong><font color="#FF0000">æ‰§è¡Œä¸¤ä¸ªæ–¹æ³•</font></strong>ï¼›</p><p>ä½†æ˜¯ <strong><font color="#FFFFFF">æœåŠ¡å¯åŠ¨å®Œæˆ</font></strong> ä¹‹åï¼Œå†æ¬¡ç‚¹å‡»ï¼ˆéšä¾¿ä½ ç‚¹å‡ æ¬¡ï¼‰<strong><font color="#836FFF">startServiceæŒ‰é’®</font></strong>ï¼Œä½ ä¼šå‘ç° <strong><font color="#FF0000">åªæœ‰onStartCommand()æ–¹æ³•è¢«æ‰§è¡Œ</font></strong>ã€‚</p><h1 id="Serviceç”Ÿå‘½å‘¨æœŸ"><a href="#Serviceç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Serviceç”Ÿå‘½å‘¨æœŸ"></a>Serviceç”Ÿå‘½å‘¨æœŸ</h1><p>ä¸Šé¢ä»‹ç»å®Œ Service çš„ä½¿ç”¨æ–¹æ³•ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹ Service çš„ <strong><font color="#FF0000">ç”Ÿå‘½å‘¨æœŸ</font></strong> ï¼šè·ŸActivityç›¸æ¯”ï¼ŒServiceçš„ç”Ÿå‘½å‘¨æœŸå¾ˆç®€å•ï¼š<strong><font color="#FFFF00">onCreate()-&gt;onStart()-&gt;onDestroy()<font></font></font></strong></p><p>æˆ‘ä»¬ä»¥å¦‚ä¸‹çš„æ–¹å¼å±•å¼€è¿™ç« èŠ‚çš„è®¨è®ºå·¥ä½œï¼</p><p><strong><font color="#FF7F00">ã€ä¸»é¢˜ã€‘</font>ï¼š</strong>Activity ä¸ Serviceä¹‹é—´çš„ Communication</p><p><strong><font color="#FF7F00">ã€é—®é¢˜ã€‘</font>ï¼š</strong>ç”±ä¸Šè´´æˆ‘ä»¬çŸ¥é“ï¼Œå½“æˆ‘ä»¬ç‚¹å‡» START SERVICE æŒ‰é’®åï¼ŒæœåŠ¡çš„ onCreate() å’Œ onStartCommand() æ–¹æ³•ä¼šå¾—åˆ°æ‰§è¡Œï¼Œæ­¤å Service æ˜¯ä¸€ç›´å­˜åœ¨äºåå°è¿è¡Œçš„ï¼ŒActivity æ— æ³•æ§åˆ¶ Service ä¸­å…·ä½“çš„é€»è¾‘è¿è¡Œï¼Œé‚£ä¹ˆè¿™æ · Activity åªç›¸å½“äºèµ·åˆ°ä¸€ä¸ªé€šçŸ¥çš„ä½œç”¨ï¼Œé™¤äº†å‘Šè¯‰ Service ä½ å¯ä»¥å¼€å§‹å·¥ä½œäº†ã€‚é‚£ä¹ˆè¿™æ ·æ˜¾ç„¶ä¼šåˆ†ç¦»ä¸¤è€…ä¹‹é—´çš„å…³è”æ€§ï¼Œè¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„ç»“æœï¼</p><p><strong><font color="#FF7F00">ã€åæœã€‘</font>ï¼š</strong>å¦‚æœå‡ºç°ä»¥ä¸Šçš„é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬å¹³æ—¶çš„é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸€ç›´å­˜åœ¨çš„ Service å¾ˆæœ‰å¯èƒ½ä¼šå¼•èµ·åŠŸè€—çš„é—®é¢˜ï¼Œå¯èƒ½å½±å“æ‰‹æœºçš„è¿è¡Œæ•ˆç‡ï¼</p><p><strong><font color="#FF7F00">ã€è¦æ±‚ã€‘</font>ï¼š</strong>æˆ‘ä»¬èƒ½å¦å°† Activity ä¸ Service å»ºç«‹ä¸€ç§è”ç³»ï¼Œå½“ Activity ç»ˆç»“ä¹‹æ—¶ï¼ŒService ä¹Ÿé”€æ¯ï¼Œä¹Ÿå°±æ˜¯æœ‰æ²¡æœ‰åŠæ³•è®© Activity å’Œ Service èƒ½å¤Ÿ<strong><font color="#FFFF00">â€œä¸æ±‚åŒç”Ÿï¼Œä½†æ±‚å…±æ­»â€</font></strong>ï¼Ÿ </p><p><strong><font color="#FF0000">ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼</font></strong>è¿™å°±æ¶‰åŠåˆ° Service çš„å¦ä¸€ä¸ªé‡è¦çŸ¥è¯†ç‚¹ï¼š<strong><font color="#1C86EE">ç»‘å®š</font></strong> ä¸ <strong><font color="#1C86EE">è§£ç»‘</font></strong>ï¼</p><p>è¿˜æ˜¯ä»¥ä»£ç ä¸ºä¾‹ï¼š</p><h2 id="MyService"><a href="#MyService" class="headerlink" title="MyService"></a>MyService</h2><p><strong><font color="#FFFF00">MyService.java</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>ã€€ã€€<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"MyService"</span><span class="token punctuation">;</span>ã€€ã€€<span class="token keyword">private</span> DownloadBinder mBinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DownloadBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment" spellcheck="true">// å®šä¹‰ä¸€ä¸ª DownloadBinder ç±»</span>ã€€ã€€<span class="token keyword">class</span> <span class="token class-name">DownloadBinder</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token punctuation">{</span>                               <span class="token comment" spellcheck="true">// è®© DownloadBinder æˆä¸º Binder çš„å­ç±»</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                   <span class="token comment" spellcheck="true">// å®šä¹‰å¼€å§‹ä¸‹è½½çš„æ–¹æ³•</span>ã€€ã€€ã€€ã€€ã€€ã€€Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"startDownload executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                   ã€€ <span class="token comment" spellcheck="true">// å®šä¹‰ä¸€ä¸ªæŸ¥çœ‹ä¸‹è½½è¿›åº¦çš„æ–¹æ³•</span>ã€€ã€€ã€€ã€€ã€€ã€€Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"getProgress executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                                 ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token annotation punctuation">@Nullable</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// onBind()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†åœ¨ç»‘å®šåè°ƒç”¨</span>ã€€ã€€ã€€ã€€<span class="token keyword">return</span> mBinder<span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// è¿”å› IBinder çš„å®ä¾‹ --> DownloadBinder ç±»çš„å®ä¾‹</span>ã€€ã€€<span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                               ã€€ã€€    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCreate executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>      ã€€    ã€€Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onStartCommand executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€    ã€€<span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                               ã€€ã€€    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onDestroy executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="BIND-SERVICE-UNBIND-SERVICE"><a href="#BIND-SERVICE-UNBIND-SERVICE" class="headerlink" title="BIND SERVICE / UNBIND SERVICE"></a>BIND SERVICE / UNBIND SERVICE</h2><p>æˆ‘ä»¬åœ¨Layoutä¸­æ·»åŠ ä¸¤ä¸ªæŒ‰é’® <strong><font color="#FFFF00">BIND SERVICE</font></strong> å’Œ <strong><font color="#FFFF00">UNBIND SERVICE</font></strong>ï¼š</p><left><img src="http://upload-images.jianshu.io/upload_images/3517194-3d48d691a13e1455.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"> </left><p><strong><font color="#FFFF00">MainActivity.java</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">{</span>ã€€ã€€<span class="token keyword">private</span> ServiceConnection connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                       <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ª ServiceConnection çš„åŒ¿åå†…éƒ¨ç±»</span>ã€€ã€€ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">// é‡å†™ onServiceConnected() æ–¹æ³•</span>ã€€ã€€ã€€ã€€ã€€ã€€MyService<span class="token punctuation">.</span>DownloadBinder downloadBinder <span class="token operator">=</span> <span class="token punctuation">(</span>MyService<span class="token punctuation">.</span>DownloadBinder<span class="token punctuation">)</span> service<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// å‘ä¸‹è½¬å‹å–å¾— downloadBinder å®ä¾‹</span>ã€€ã€€ã€€ã€€ã€€ã€€downloadBinder<span class="token punctuation">.</span><span class="token function">startDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                <span class="token comment" spellcheck="true">// åœ¨ Activity ä¸­è°ƒç”¨ Service çš„æ–¹æ³•</span>ã€€ã€€ã€€ã€€ã€€ã€€downloadBinder<span class="token punctuation">.</span><span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                  <span class="token comment" spellcheck="true">// åœ¨ Activity ä¸­è°ƒç”¨ Service çš„æ–¹æ³•</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// é‡å†™onServiceDisconnected()æ–¹æ³•</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">;</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€Button startService <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>start_service<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€Button stopService <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>stop_service<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€Button bindService <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>bind_service<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€Button unbindService <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>unbind_service<span class="token punctuation">)</span><span class="token punctuation">;</span>        ã€€ã€€ã€€ã€€startService<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€stopService<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€bindService<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€unbindService<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">switch</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>start_service<span class="token operator">:</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Intent startIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// START æœåŠ¡ --> onCreate() --> onStartCommand()</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">startService</span><span class="token punctuation">(</span>startIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>stop_service<span class="token operator">:</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Intent stopIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// STOP æœåŠ¡ --> onDestroy()</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">stopService</span><span class="token punctuation">(</span>stopIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>bind_service<span class="token operator">:</span>                                            <span class="token comment" spellcheck="true">// ç»‘å®š --> ï¼Ÿ</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Intent bindIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">bindService</span><span class="token punctuation">(</span>bindIntent<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> BIND_AUTO_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// ğŸ’¥ ğŸ’¥ ğŸ’¥ ğŸ’¥ é‡ç‚¹åˆ†æ</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>unbind_service<span class="token operator">:</span>                                          <span class="token comment" spellcheck="true">// è§£ç»‘ --> ï¼Ÿ</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">unbindService</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">default</span><span class="token operator">:</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">break</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="bindService"><a href="#bindService" class="headerlink" title="bindService"></a>bindService</h2><p>çœ‹ä¸€ä¸‹ <strong><font color="#FFFF00">bindService(bindIntent, connection, BIND_AUTO_CREATE)</font></strong> è¿™ä¸ªæ–¹æ³•ï¼š</p><p><strong><font color="#FFFF00">bindService</font></strong> æ¥æ”¶äº† <strong>3</strong> ä¸ªå‚æ•°ï¼š</p><p><strong><font color="#9F79EE">bindIntent</font></strong>ï¼šè¿™ä¸ªå‚æ•°ä¼ å…¥çš„å°±æ˜¯æˆ‘ä»¬çš„ intentï¼Œç›®çš„å°±æ˜¯è°ƒç”¨ MyService è¿™ä¸ªæœåŠ¡ã€‚</p><p><strong><font color="#9F79EE">connection</font></strong>ï¼šè¿™ä¸ªå‚æ•°ä¼ å…¥çš„å°±æ˜¯åˆ›å»ºå¥½çš„ ServiceConnection çš„å®ä¾‹ï¼Œè¿™ä¸ªå‚æ•°ä»£è¡¨ç€æˆ‘ä»¬çš„ Activity æ˜¯è¦å’Œ Service ç»‘å®šåœ¨ä¸€èµ·çš„ï¼</p><p><strong><font color="#9F79EE">BIND_AUTO_CREATE</font></strong>ï¼šè¿™æ˜¯ä¸€ä¸ª FLAGï¼Œè¡¨ç¤ºåœ¨æ´»åŠ¨å’ŒæœåŠ¡è¿›è¡Œç»‘å®šå <strong><font color="#FF0000">è‡ªåŠ¨åˆ›å»ºæœåŠ¡</font></strong>ã€‚æ³¨æ„ï¼æ˜¯è‡ªåŠ¨åˆ›å»ºæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ MyService ä¼šæ‰§è¡Œ onCreate() æ–¹æ³•ï¼Œä½†æ˜¯ä¸ä¼šæ‰§è¡Œ onStartCommand() æ–¹æ³•ï¼</p><p><strong><font color="#FFFF00">æ¥ä¸‹æ¥ï¼Œç›´æ¥çœ‹ä»£ç æœ€ç»ˆçš„æ•ˆæœï¼š</font></strong><br><br></p><left><img src="https://upload-images.jianshu.io/upload_images/3517194-173f58785a4d3eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="Service_buttons.png"></left>&nbsp;&nbsp;&nbsp;<left><img src="https://upload-images.jianshu.io/upload_images/3517194-06ddeca68cb55ecd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt="Service_Logcat.png"></left><p>é€šè¿‡æ’åˆ—ç»„åˆï¼Œå¯¹æŒ‰é’®è¿›è¡Œç‚¹å‡»ï¼ŒLogåˆ† 3 ç§æƒ…å†µï¼š</p><p><strong><font color="#9F79EE">START SERVICE + STOP SERVICEï¼š </font></strong></p><p>1ã€å½“æˆ‘ä»¬å…ˆç‚¹å‡» START SERVICE ï¼šæ­¤æ—¶æœåŠ¡å¯åŠ¨ï¼Œè°ƒç”¨ onCreat() å’Œ onStartCommand() æ–¹æ³•ï¼›</p><p>2ã€å½“æˆ‘ä»¬åç‚¹å‡» STOP SERVICE ï¼šæ­¤æ—¶ï¼ŒæœåŠ¡è¢«é”€æ¯ï¼Œè°ƒç”¨ onDestroy() æ–¹æ³•ã€‚</p><p><strong><font color="#9F79EE">BIND SERVICE + UNBIND SERVICEï¼š</font></strong></p><p>1ã€å½“æˆ‘ä»¬å…ˆç‚¹å‡» BIND SERVICE ï¼šæ­¤æ—¶æœåŠ¡ä»…ä»…æ˜¯åˆ›å»ºï¼Œå¹¶æœªå¯åŠ¨ï¼æ‰€ä»¥è°ƒç”¨çš„åªæ˜¯ onCreate() æ–¹æ³•ã€‚æ­¤æ—¶ Activity ä¸ Service ç»‘å®šï¼Œä¼šåŒæ—¶è°ƒç”¨ onBind() æ–¹æ³•ï¼Œæ­¤æ—¶ onServiceConnected() æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œè¿˜è®°çš„ onBind() æ–¹æ³•çš„è¿”å›ç±»å‹ä¸ï¼Ÿæˆ‘ä»¬é€šè¿‡ Log å¯ä»¥å¾ˆæ˜æ˜¾å‘ç°ï¼ŒActivity è°ƒç”¨äº†æœåŠ¡å†…éƒ¨çš„ä¸¤ä¸ªè‡ªå®šä¹‰æ–¹æ³•ã€‚</p><p>2ã€å½“æˆ‘ä»¬åç‚¹å‡» UNBIND SERVICE ï¼šç”±äºæœåŠ¡è¿˜æœªå¯åŠ¨ï¼Œè€Œ BIND SERVICE åªæ˜¯å°†æœåŠ¡åˆ›å»ºå¥½å¹¶ä¸æ´»åŠ¨è¿›è¡Œç»‘å®šï¼Œé‚£ä¹ˆè§£ç»‘åï¼ŒåŠ¿å¿…ä¼šé”€æ¯è¿™ä¸ª Serviceï¼Œæ‰€ä»¥ onDestroy() è¢«æ‰§è¡Œï¼</p><p><strong><font color="#9F79EE">START SERVICE + BIND SERVICE + UNBIND SERVICE + STOP SERVICEï¼š</font></strong></p><p>1ã€æˆ‘ä»¬å…ˆç‚¹å‡» START SERVICE ï¼šonCreat() å’Œ onStartCommand() æ–¹æ³•è¢«æ‰§è¡Œï¼Œè¿™ä¸ªå°±ä¸ç”¨å¤šè¯´äº†ï¼› </p><p>2ã€ç„¶åç‚¹å‡» BIND SERVICE ï¼šè¿™ä¸ªæ—¶å€™å…¶å®æ´»åŠ¨å·²ç»åœ¨åå°è¿è¡Œäº†ï¼Œæˆ‘ä»¬æ­¤æ—¶å°†æ´»åŠ¨å’ŒæœåŠ¡ç»‘å®šï¼Œé‚£ä¹ˆ onCreate() ä¸ä¼šå†æ‰§è¡Œï¼Œåªä¼šæ‰§è¡Œ onServiceConnected() æ–¹æ³•ï¼ŒLog é‡Œé¢æ‰“å‡ºæ¥çœ‹çš„å¾ˆæ¸…æ¥šã€‚</p><p>3ã€æ­¤æ—¶ä½ å¦‚æœæ‰‹è´±ï¼Œæƒ³ STOP SERVICEï¼šé‚£ä¹ˆæ­å–œä½ ï¼Œæ¯«æ— ååº”ï¼ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºä½ éƒ½æ²¡è§£ç»‘ï¼Œä½ æ€ä¹ˆé”€æ¯ï¼Ÿ</p><p>4ã€OKï¼Œé‚£æˆ‘ä»¬å…ˆè§£ç»‘ï¼Œæˆ‘ä»¬ç‚¹å‡» UNBIND SERVICE ï¼šæ­¤æ—¶ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡å‘ç”Ÿäº†ï¼ŒLOG æ—¥å¿—æ²¡æœ‰æ‰“å°å‡º Destroy() è¿™ä¸ªæ–¹æ³•å•Šï¼Ÿæ²¡æœ‰è¢«æ‰§è¡Œå•Šï¼ä¸æ˜¯è¯´ bind äº† Service ä¹‹åï¼Œunbind å°±ä¼šé”€æ¯è¿™ä¸ªæœåŠ¡å—ï¼Ÿè¿™è·Ÿæˆ‘ä»¬ä¹‹å‰åˆ†æçš„ä¸ç¬¦åˆå•Šã€‚</p><p>5ã€å¥½å§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆã€‚å…¶å®åŸå› å¾ˆç®€å•ï¼šæˆ‘ä»¬å…ˆ start äº† Serviceï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡å·²ç»åœ¨åå°è¿è¡Œäº†ï¼Œè¿™ä¸ªæ—¶å€™ä½  bindï¼Œè®© Service å’Œ Activity ç»‘å®šï¼Œå…¶å®æ˜¯æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„ã€‚ä½†æ˜¯æ—¢ç„¶ç»‘å®šäº†ï¼Œä½ å¦‚æœä¸è§£ç»‘ï¼Œé‚£ä¹ˆ Destroy() æ¯«æ— ç”¨æ­¦ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æƒ…å†µå’Œï¼ˆ2ï¼‰ä¸­åˆ†æçš„è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæ­¤æ˜¯è§£ç»‘å®Œåï¼ŒæœåŠ¡è¿˜æ˜¯èˆ’èˆ’æœæœçš„åœ¨åå°è¿è¡Œï¼Œæ‰€ä»¥ï¼Œè¦æƒ³å¹²æ‰è¿™ä¸ªæœåŠ¡ï¼Œä½ å¿…é¡»è¦ STOP SERVICEã€‚</p><p>6ã€é‚£æˆ‘ä»¬è§£ç»‘åï¼Œå† STOP SERVICE ï¼šè¿™ä¸ªæ—¶å€™ Service å°±è¢«æªæ¯™äº†ï¼</p><h1 id="Service-ä¸¤ä¸ªå®ç”¨å°æŠ€å·§"><a href="#Service-ä¸¤ä¸ªå®ç”¨å°æŠ€å·§" class="headerlink" title="Service ä¸¤ä¸ªå®ç”¨å°æŠ€å·§"></a>Service ä¸¤ä¸ªå®ç”¨å°æŠ€å·§</h1><h2 id="Forground-Service"><a href="#Forground-Service" class="headerlink" title="Forground Service"></a>Forground Service</h2><p>æœåŠ¡å‡ ä¹éƒ½æ˜¯åœ¨åå°è¿è¡Œçš„ï¼Œä¸€ç›´ä¸€æ¥å®ƒéƒ½æ˜¯é»˜é»˜åœ°åšç€è¾›è‹¦çš„å·¥ä½œã€‚ä½†æ˜¯æœåŠ¡çš„ç³»ç»Ÿä¼˜å…ˆçº§è¿˜æ˜¯æ¯”è¾ƒä½çš„ï¼Œå½“ç³»ç»Ÿå‡ºç°å†…å­˜ä¸è¶³çš„æƒ…å†µæ—¶ï¼Œå°±æœ‰å¯èƒ½ä¼šå›æ”¶æ‰æ­£åœ¨åå°è¿è¡Œçš„æœåŠ¡ã€‚å¦‚æœä½ å¸Œæœ›æœåŠ¡å¯ä»¥ä¸€ç›´ä¿æŒè¿è¡ŒçŠ¶æ€ï¼Œè€Œä¸æ˜¯ç”±äºç³»ç»Ÿå†…å­˜ä¸è¶³çš„åŸå› å¯¼è‡´è¢«å›æ”¶æ‰ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨å‰å°æœåŠ¡ã€‚å‰å°æœåŠ¡å’Œæ™®é€šæœåŠ¡æœ€å¤§çš„åŒºåˆ«å°±åœ¨äºï¼Œå®ƒä¼šä¸€ç›´æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å›¾æ ‡åœ¨ç³»ç»Ÿçš„çŠ¶æ€æ æ˜¾ç¤ºï¼Œä¸‹æ‹‰çŠ¶æ€æ åå¯ä»¥çœ‹åˆ°æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼Œéå¸¸ç±»ä¼¼äºé€šçŸ¥çš„æ•ˆæœã€‚å½“ç„¶æœ‰æ—¶å€™ä½ ä¹Ÿå¯èƒ½ä¸ä»…ä»…æ˜¯ä¸ºäº†é˜²æ­¢æœåŠ¡è¢«å›æ”¶æ‰æ‰ä½¿ç”¨å‰å°æœåŠ¡ï¼Œæœ‰äº›é¡¹ç›®ç”±äºç‰¹æ®Šçš„éœ€æ±‚ä¼šè¦æ±‚å¿…é¡»ä½¿ç”¨å‰å°æœåŠ¡ï¼Œæ¯”å¦‚è¯´å¤©æ°”ç±»è½¯ä»¶ï¼Œå®ƒçš„æœåŠ¡åœ¨åå°æ›´æ–°å¤©æ°”æ•°æ®çš„åŒæ—¶ï¼Œè¿˜ä¼šåœ¨ç³»ç»ŸçŠ¶æ€æ ä¸€ç›´æ˜¾ç¤ºå½“å‰çš„å¤©æ°”ä¿¡æ¯ã€‚</p><p><strong><font color="#FF7F00">ã€é—®é¢˜ã€‘</font></strong>ï¼šæˆ‘ä»¬éƒ½çŸ¥é“æœåŠ¡æ˜¯è¿è¡Œåœ¨åå°çš„ï¼Œå¦‚æœç³»ç»Ÿå‡ºç°å†…å­˜ä¸è¶³çš„æƒ…å†µï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œç³»ç»Ÿå°±å¯èƒ½å›æ”¶åå°çš„æœåŠ¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¿è¯æœåŠ¡å¯ä»¥ä¸€ç›´è¿è¡Œï¼Ÿ</p><p><strong><font color="#FF7F00">ã€è§£å†³ã€‘</font></strong>ï¼šåœ¨æœåŠ¡ä¸­ï¼Œæœ‰ä¸€ä¸ª <strong><font color="#FFFF00">å‰å°æœåŠ¡</font></strong> çš„æ¦‚å¿µï¼Œè°ƒç”¨ <strong><font color="#FF0000">startForground()</font></strong> æ–¹æ³•å¯ä»¥å®ç°ã€‚</p><p>å¦‚ä½•åˆ›å»ºä¸€ä¸ªå‰å°æœåŠ¡ï¼Œçœ‹ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>ã€€ã€€<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"MyService"</span><span class="token punctuation">,</span> <span class="token string">"onCreate executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MainActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€PendingIntent pi <span class="token operator">=</span> PendingIntent<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€Notification notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">// å¯åŠ¨æœåŠ¡åï¼Œåœ¨å‰å°æ·»åŠ ä¸€ä¸ªNotification</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">.</span><span class="token function">setContentTitle</span><span class="token punctuation">(</span><span class="token string">"This is a content title"</span><span class="token punctuation">)</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">.</span><span class="token function">setContentText</span><span class="token punctuation">(</span><span class="token string">"This is content text"</span><span class="token punctuation">)</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">.</span><span class="token function">setWhen</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">.</span><span class="token function">setSmallIcon</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>ic_launcher<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setLargeIcon</span><span class="token punctuation">(</span>BitmapFactory<span class="token punctuation">.</span><span class="token function">decodeResource</span><span class="token punctuation">(</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>ic_launcher<span class="token punctuation">)</span><span class="token punctuation">)</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">.</span><span class="token function">setContentIntent</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token function">startForeground</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>ä»¥ä¸Šçš„ä»£ç æ˜¯åœ¨ Service çš„åˆ›å»ºä¸­æ·»åŠ äº†ä¸€ä¸ª Notificationï¼Œè°ƒç”¨ startForground() å°±å¯ä»¥ä¿è¯ï¼šåªè¦æœåŠ¡ä¸€ç›´å­˜åœ¨ï¼Œé‚£ä¹ˆåœ¨å‰å°å°±ä¼šä¸€ç›´æ˜¾ç¤ºè¿™ä¸ª Notificationã€‚</p><p>å¦‚æœæˆ‘ä»¬åœ¨ onDestroy() ä¸­è°ƒç”¨ stopForground() æ–¹æ³•ï¼Œä¼šé”€æ¯è¿™ä¸ª Notificationï¼Œä½†æ˜¯ Service è¿˜æ˜¯å­˜æ´»çš„ï¼Œæ­¤æ—¶ Service å°±ä¼šé¢ä¸´è¢« System å¹²æ‰çš„é£é™©ã€‚</p><p>å¦‚æœç›´æ¥ STOP SERVICEï¼Œé‚£ä¹ˆ Notification å’Œ Service éƒ½ä¼šé”€æ¯ã€‚ </p><h2 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h2><p><strong><font color="#FF7F00">ã€é—®é¢˜ã€‘</font></strong>ï¼šæˆ‘ä»¬çŸ¥é“æœåŠ¡çš„ä»£ç é€»è¾‘æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­éœ€è¦æ‰§è¡Œä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½å‡ºç°ANRï¼ˆç¨‹åºæš‚æ— å“åº”ï¼‰çš„çŠ¶å†µã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ Android çš„å¤šçº¿ç¨‹ç¼–ç¨‹çš„æ–¹å¼ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æœåŠ¡çš„æ¯ä¸ªå…·ä½“çš„æ–¹æ³•é‡Œå¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œç„¶ååœ¨è¿™é‡Œå»å¤„ç†é‚£äº›è€—æ—¶çš„é€»è¾‘ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ªæ¯”è¾ƒæ ‡å‡†çš„æœåŠ¡å°±å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>ã€€ã€€<span class="token annotation punctuation">@Nullable</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">return</span> null<span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// å¼€å¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œ</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token comment" spellcheck="true">// å¤„ç†å…·ä½“çš„é€»è¾‘                     </span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ç°åœ¨ï¼ŒæœåŠ¡å¯ä»¥å¯åŠ¨èµ·æ¥äº†ã€‚ä½†æ˜¯å¦‚æœä¸è°ƒç”¨ <strong><font color="#FF7F00">StopService()</font></strong> æˆ– <strong><font color="#FF7F00">stopSelf()</font></strong> æ–¹æ³•ï¼ŒæœåŠ¡ä¼šä¸€ç›´è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span><span class="token punctuation">{</span>ã€€ã€€<span class="token annotation punctuation">@Nullable</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">return</span> null<span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token comment" spellcheck="true">// å¤„ç†å…·ä½“çš„é€»è¾‘                  // å¼€å¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œ</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">stopSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// è®©æœåŠ¡æ‰§è¡Œå®Œé€»è¾‘åè‡ªè¡Œåœæ­¢</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStartCommand</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>ä¸Šé¢çš„ä»£ç å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Service çš„ä¹¦å†™å½¢å¼ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼šThreadå­çº¿ç¨‹çš„åˆ›å»º å’Œ stopSelf() æ–¹æ³•çš„è°ƒç”¨ã€‚</p><p>è™½è¯´è¿™ç§å†™æ³•å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯æ€»ä¼šæœ‰äººå¿˜è®°å¼€å¯çº¿ç¨‹ï¼Œæˆ–è€…å¿˜è®°è°ƒç”¨ stopSelf()ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•èƒ½å¤Ÿå®ç°ä¸Šé¢ä¸¤ä¸ªéœ€æ±‚å‘¢ï¼Ÿ</p><p><strong><font color="#FF7F00">ã€è§£å†³ã€‘ï¼š</font></strong>åœ¨ Android ä¸­ï¼Œä¸“é—¨æä¾›äº†ä¸€ä¸ª IntentService ç±»ï¼ˆandroid.app.IntentServiceï¼‰ï¼Œè¿™ä¸ªç±»å°±èƒ½å¾ˆå¥½çš„æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼æˆ‘ä»¬ç›´æ¥é€šè¿‡ä»£ç æ¥çœ‹ï¼š</p><p>æ–°å»ºä¸€ä¸ª MyIntentService ç±»ç»§æ‰¿è‡ª IntentServiceï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyIntentService</span> <span class="token keyword">extends</span> <span class="token class-name">IntentService</span><span class="token punctuation">{</span>ã€€ã€€<span class="token keyword">public</span> <span class="token function">MyIntentService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">"MyIntentService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// è°ƒç”¨çˆ¶ç±»çš„æœ‰å‚æ„é€ å‡½æ•°</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onHandleIntent</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// æ‰“å°å½“å‰çº¿ç¨‹çš„ id</span>ã€€ã€€ã€€ã€€Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"MyIntentService"</span><span class="token punctuation">,</span> <span class="token string">"MyIntentServiceThread id is "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"MyIntentService"</span><span class="token punctuation">,</span> <span class="token string">"onDestroy executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong><font color="#FFFF00">ä»¥ä¸Šä»£ç åšäº†å‡ ä»¶äº‹ï¼š</font></strong></p><p>1ã€æä¾›äº†ä¸€ä¸ªæ— å‚çš„æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”è°ƒç”¨äº†çˆ¶ç±»çš„æœ‰å‚æ„é€ å‡½æ•°ï¼›</p><p>2ã€å­ç±»å®ç°çˆ¶ç±»çš„ onHandleIntent() æŠ½è±¡æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¥½å°±å¥½åœ¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªå·²ç»è¿è¡Œåœ¨å­çº¿ç¨‹ä¸­çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡è°ƒç”¨äº†å®ƒï¼Œé‚£ä¹ˆæ‰§è¡Œçš„é€»è¾‘å°±å¦‚åŒ Thread å­çº¿ç¨‹ï¼›</p><p>3ã€æ ¹æ® IntentService çš„ç‰¹æ€§ï¼Œè¿™ä¸ªæœåŠ¡åœ¨è¿è¡Œç»“æŸååº”è¯¥æ˜¯ä¼šè‡ªåŠ¨åœæ­¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆé‡å†™äº† onDestroy()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œä¹Ÿæ‰“å°ä¸€è¡Œæ—¥å¿—ï¼Œä»¥è¯å®æœåŠ¡æ˜¯ä¸æ˜¯åœæ­¢æ‰äº†ã€‚</p><p>æˆ‘ä»¬åœ¨ xml æ–‡ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª MyIntentService æœåŠ¡æŒ‰é’®ï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/start_intent_service<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>ã€€ã€€<span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@string/intent_service<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre><p>ç„¶åä¿®æ”¹ MainActivity ä¸­çš„ä»£ç ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€<span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ã€€ã€€ã€€ã€€Button startIntentService <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>start_intent_service<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€startIntentService<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token annotation punctuation">@Override</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"MyIntentService"</span><span class="token punctuation">,</span> <span class="token string">"MainActivity Thread id is "</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æŸ¥çœ‹ä¸»çº¿ç¨‹çš„id</span>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Intent intentService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MyIntentService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="token function">startService</span><span class="token punctuation">(</span>intentService<span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€ã€€ã€€ã€€ã€€<span class="token punctuation">}</span>ã€€ã€€ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ã€€ã€€<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æœ€åï¼Œåœ¨AndroidMainfestä¸­æ³¨å†ŒæœåŠ¡ï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MyIntentService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><p><strong><font color="#FF7F00">ã€ç»“æœã€‘</font></strong>ï¼š</p><left><img src="http://upload-images.jianshu.io/upload_images/3517194-ccb5506a4bf47f0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"> </left><p>ä»æ‰“å‡ºçš„LOGå¯ä»¥çœ‹å‡ºï¼š</p><p>1ã€MyIntentService å’Œ MainActivity æ‰€åœ¨è¿›ç¨‹çš„ <strong><font color="#FF0000">idæ˜¯ä¸ä¸€æ ·çš„</font></strong> ï¼›</p><p>2ã€onHandleIntent() æ–¹æ³•åœ¨æ‰§è¡Œå®Œé€»è¾‘åç¡®å®é”€æ¯äº†æœåŠ¡ï¼Œæ•ˆæœç­‰åŒäº stopSelf()ã€‚</p><p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡º onHandleIntent() æ–¹æ³•ç¡®å®ç›¸å½“çš„å¥½ç”¨ï¼</p>]]></content>
      
      
      <categories>
          
          <category> å¸¸ç”¨ç»„ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Service </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢è®¨ Fragment çš„ç”Ÿå‘½å‘¨æœŸ</title>
      <link href="/2018/07/22/08.chang-yong-zu-jian-xi-lie-tan-tao-fragment-de-sheng-ming-zhou-qi/"/>
      <url>/2018/07/22/08.chang-yong-zu-jian-xi-lie-tan-tao-fragment-de-sheng-ming-zhou-qi/</url>
      
        <content type="html"><![CDATA[<h1 id="1-ç¢ç‰‡çŠ¶æ€"><a href="#1-ç¢ç‰‡çŠ¶æ€" class="headerlink" title="1. ç¢ç‰‡çŠ¶æ€"></a>1. ç¢ç‰‡çŠ¶æ€</h1><p>æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡ Activity ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€ï¼ˆè¿è¡ŒçŠ¶æ€ã€æš‚åœçŠ¶æ€ã€åœæ­¢çŠ¶æ€ã€é”€æ¯çŠ¶æ€ï¼‰ã€‚é‚£ä¹ˆç¢ç‰‡ï¼ˆFragmentï¼‰çš„çŠ¶æ€å¦‚ä½•ï¼Ÿå…¶å® Fragment å’Œ Activity ç±»ä¼¼ï¼Œåªæ˜¯æœ‰äº›è®¸ç»†å¾®çš„å·®åˆ«ï¼</p><p>æ¯ä¸ª Fragment åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­ä¹Ÿæœ‰ <strong><font color="#FF0000">4</font></strong> ç§çŠ¶æ€ï¼š</p><p><strong><font color="#436EEE">1ã€è¿è¡ŒçŠ¶æ€</font></strong></p><p>å½“ä¸€ä¸ªç¢ç‰‡æ˜¯å¯è§çš„ï¼Œå¹¶ä¸”å®ƒæ‰€å…³è”çš„æ´»åŠ¨æ­£å¤„äºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œè¯¥ç¢ç‰‡ä¹Ÿå¤„äºè¿è¡ŒçŠ¶æ€ã€‚</p><p><strong><font color="#436EEE">2ã€æš‚åœçŠ¶æ€</font></strong></p><p>å½“ä¸€ä¸ªæ´»åŠ¨è¿›å…¥æš‚åœçŠ¶æ€æ—¶ï¼ˆç”±äºå¦ä¸€ä¸ªæœªæ²¾æ»¡å±å¹•çš„æ´»åŠ¨è¢«æ·»åŠ åˆ°äº†æ ˆé¡¶ï¼‰ï¼Œä¸å®ƒç›¸å…³è”çš„å¯è§ç¢ç‰‡ä¹Ÿå°±è¿›å…¥äº†æš‚åœçŠ¶æ€ã€‚</p><p><strong><font color="#436EEE">3ã€åœæ­¢çŠ¶æ€</font></strong></p><p>å½“ä¸€ä¸ªæ´»åŠ¨è¿›å…¥åœæ­¢çŠ¶æ€æ—¶ï¼Œä¸å®ƒç›¸å…³è”çš„ç¢ç‰‡å°±ä¼šè¿›å…¥åœæ­¢çŠ¶æ€ï¼Œæˆ–è€…é€šè¿‡è°ƒç”¨ FragmentTransaction çš„ remove()ã€replace() æ–¹æ³•å°†ç¢ç‰‡ä»æ´»åŠ¨ä¸­ç§»é™¤ï¼Œä½†å¦‚æœåœ¨äº‹åŠ¡æäº¤ä¹‹å‰è°ƒç”¨ addToBackStack() æ–¹æ³•ï¼Œè¿™æ—¶çš„ç¢ç‰‡ä¹Ÿä¼šè¿›å…¥åœæ­¢çŠ¶æ€ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œè¿›å…¥åœæ­¢çŠ¶æ€çš„ç¢ç‰‡å¯¹ç”¨æˆ·æ¥è¯´æ˜¯å®Œå…¨ä¸å¯è§çš„ï¼Œæœ‰å¯èƒ½ä¼šè¢«ç³»ç»Ÿå›æ”¶ã€‚</p><p><strong><font color="#436EEE">4ã€é”€æ¯çŠ¶æ€</font></strong></p><p>ç¢ç‰‡æ€»æ˜¯ä¾é™„äºæ´»åŠ¨è€Œå­˜åœ¨çš„ï¼Œå› æ­¤å½“æ´»åŠ¨è¢«é”€æ¯æ—¶ï¼Œä¸å®ƒå…³è”çš„ç¢ç‰‡å°±ä¼šè¿›å…¥åˆ°é”€æ¯çŠ¶æ€ã€‚æˆ–è€…é€šè¿‡è°ƒç”¨ </p><h1 id="2-å›è°ƒæ–¹æ³•"><a href="#2-å›è°ƒæ–¹æ³•" class="headerlink" title="2. å›è°ƒæ–¹æ³•"></a>2. å›è°ƒæ–¹æ³•</h1><p>Fragment ç±»ä¹Ÿæä¾›äº†ä¸€ç³»åˆ—çš„å›è°ƒæ–¹æ³•ï¼Œä»¥è¦†ç›–éšä¾¿ç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸ªç¯èŠ‚ã€‚å…¶ä¸­ï¼Œæ´»åŠ¨ä¸­æœ‰çš„å›è°ƒæ–¹æ³•ï¼Œéšä¾¿ä¸­å‡ ä¹éƒ½æœ‰ï¼Œä¸è¿‡ç¢ç‰‡è¿˜æä¾›äº†ä¸€äº›é™„åŠ çš„å›è°ƒæ–¹æ³•ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ï¼š</p><p><strong><font color="#436EEE">1ã€onAttach()</font></strong>ï¼šå½“ç¢ç‰‡å’Œæ´»åŠ¨å»ºç«‹å…³è”çš„æ—¶å€™è°ƒç”¨ã€‚</p><p><strong><font color="#436EEE">2ã€onCreateView()</font></strong>ï¼šå½“ç¢ç‰‡åˆ›å»ºè§†å›¾ï¼ˆåŠ è½½å¸ƒå±€ï¼‰æ—¶è°ƒç”¨ã€‚</p><p><strong><font color="#436EEE">3ã€onActivityCreated()</font></strong>ï¼šç¡®ä¿ä¸ç¢ç‰‡ç›¸å…³è”çš„æ´»åŠ¨ä¸€å®šå·²ç»åˆ›å»ºå®Œæ¯•çš„æ—¶å€™è°ƒç”¨ã€‚</p><p><strong><font color="#436EEE">4ã€onDestroyView()</font></strong>ï¼šå½“ä¸ç¢ç‰‡å…³è”çš„è§†å›¾è¢«ç§»é™¤çš„æ—¶å€™è°ƒç”¨ã€‚</p><p><strong><font color="#436EEE">5ã€onDetach()</font></strong>ï¼šå½“ç¢ç‰‡å’Œæ´»åŠ¨è§£é™¤å…³è”çš„æ—¶å€™è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹å®˜æ–¹ç»™å‡ºçš„ Activity ç”Ÿå‘½å‘¨æœŸçš„ç¤ºæ„å›¾ï¼š<br><br></p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-3977c31967b1a8f6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="Fragment.png"></center><h1 id="3-å®æˆ˜æ¼”ç»ƒ"><a href="#3-å®æˆ˜æ¼”ç»ƒ" class="headerlink" title="3. å®æˆ˜æ¼”ç»ƒ"></a>3. å®æˆ˜æ¼”ç»ƒ</h1><h2 id="3-1-Code"><a href="#3-1-Code" class="headerlink" title="3.1 Code"></a>3.1 Code</h2><blockquote><p>LeftFragment</p></blockquote><p>ï¼ˆ1ï¼‰ä¿®æ”¹ left_fragment.xml</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/button<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_gravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center_horizontal<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span></code></pre><p>ï¼ˆ2ï¼‰ä¿®æ”¹ LeftFragment.java</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>NonNull<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Nullable<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>LayoutInflater<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LeftFragment</span> <span class="token keyword">extends</span> <span class="token class-name">Fragment</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Nullable</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> View <span class="token function">onCreateView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> LayoutInflater inflater<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup container<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        View view <span class="token operator">=</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>left_fragment<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> view<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>RightFragment</p></blockquote><p>ï¼ˆ1ï¼‰ä¿®æ”¹ right_fragment.xml</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#00ff00<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20sp<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_gravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center_horizontal<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>This is right fragment<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span></code></pre><p>ï¼ˆ2ï¼‰ä¿®æ”¹ RightFragment.java</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>NonNull<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Nullable<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>LayoutInflater<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RightFragment</span> <span class="token keyword">extends</span> <span class="token class-name">Fragment</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"RightFragment"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAttach</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAttach</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onAttach"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCreate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Nullable</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> View <span class="token function">onCreateView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> LayoutInflater inflater<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup container<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCreateView"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        View view <span class="token operator">=</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>right_fragment<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> view<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActivityCreated</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onActivityCreated</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onActivityCreated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onResume"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onPause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onStop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroyView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroyView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onDestroyView"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onDestroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>AnotherRightFragment</p></blockquote><p>ï¼ˆ1ï¼‰ä¿®æ”¹ anotheright_right_fragment.xml</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#ffff00<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_gravity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center_horizontal<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20sp<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>This is another right fragment<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span></code></pre><p>ï¼ˆ2ï¼‰ä¿®æ”¹ AnotherRightFragment.java</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>NonNull<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Nullable<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>LayoutInflater<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnotherRightFragment</span> <span class="token keyword">extends</span> <span class="token class-name">Fragment</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Nullable</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> View <span class="token function">onCreateView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> LayoutInflater inflater<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ViewGroup container<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        View view <span class="token operator">=</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>another_right_fragment<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> view<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>MainActivity</p></blockquote><p>ï¼ˆ1ï¼‰ ä¿®æ”¹ activity_main.xml</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fragment</span>        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/left_fragment<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.marco.fragmenttest.LeftFragment<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0dp<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_weight</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FrameLayout</span>        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/right_layout<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0dp<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_weight</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span></code></pre><p>ï¼ˆ2ï¼‰ä¿®æ”¹ MainActivity.java</p><pre><code>package com.example.marco.fragmenttest;import android.app.FragmentManager;import android.app.FragmentTransaction;import android.support.v4.app.Fragment;import android.support.v7.app.AppCompatActivity;import android.os.Bundle;import android.view.View;import android.widget.Button;public class MainActivity extends AppCompatActivity implements View.OnClickListener {    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_main);        Button button = findViewById(R.id.button);        button.setOnClickListener(this);        replaceFragment(new RightFragment());    }    private void replaceFragment(Fragment fragment) {        android.support.v4.app.FragmentManager fragmentManager = getSupportFragmentManager();        android.support.v4.app.FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();        fragmentTransaction.replace(R.id.right_layout, fragment);        fragmentTransaction.addToBackStack(null);        fragmentTransaction.commit();    }    @Override    public void onClick(View v) {        switch (v.getId()) {            case R.id.button:                replaceFragment(new AnotherRightFragment());                break;            default:                break;        }    }}</code></pre><h2 id="3-2-Result"><a href="#3-2-Result" class="headerlink" title="3.2 Result"></a>3.2 Result</h2><p>ï¼ˆ1ï¼‰è¿è¡Œç¨‹åºï¼ŒLog å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"> <span class="token number">09</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">21.960</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onAttach <span class="token number">09</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">21.960</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onCreate <span class="token number">09</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">21.961</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onCreateView <span class="token number">09</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">21.968</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onActivityCreated <span class="token number">09</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">21.968</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onStart <span class="token number">09</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">21.975</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onResume</code></pre><p>ï¼ˆ2ï¼‰ç‚¹å‡» Button åï¼ŒLog å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"> <span class="token number">09</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">24.660</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onPause <span class="token number">09</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">24.660</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onStop <span class="token number">09</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">24.661</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onDestroyView</code></pre><p>ç”±äº AnotherRightFragment æ›¿æ¢äº† RightFragmentï¼Œæ­¤æ—¶çš„ RightFragment è¿›å…¥äº†åœæ­¢çŠ¶æ€ï¼Œå› æ­¤ onPause()ã€onStop() å’Œ onDestroyView() æ–¹æ³•ä¼šå¾—åˆ°æ‰§è¡Œã€‚</p><p>æ³¨æ„ï¼Œå¦‚æœåœ¨æ›¿æ¢çš„æ—¶å€™æ²¡æœ‰è°ƒç”¨ addToBackStack() æ–¹æ³•ï¼Œæ­¤æ—¶çš„ RightFragment å°±ä¼šè¿›å…¥é”€æ¯çŠ¶æ€ï¼ŒonDestroy() å’Œ onDetach() æ–¹æ³•å°±ä¼šå¾—åˆ°æ‰§è¡Œã€‚</p><p>ï¼ˆ3ï¼‰æŒ‰ä¸‹ Back é”®ï¼ŒLog å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"> <span class="token number">09</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">41.213</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onCreateView <span class="token number">09</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">41.227</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onActivityCreated <span class="token number">09</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">41.227</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onStart <span class="token number">09</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">41.227</span> <span class="token number">13896</span><span class="token operator">-</span><span class="token number">13896</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onResume</code></pre><p>ï¼ˆ4ï¼‰ç»§ç»­æŒ‰ä¸‹ Back é”®ï¼Œç¨‹åºé€€å‡ºï¼ŒLog å¦‚ä¸‹ï¼š</p><pre class=" language-java"><code class="language-java"> <span class="token number">09</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">13.778</span> <span class="token number">14435</span><span class="token operator">-</span><span class="token number">14435</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onPause <span class="token number">09</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">13.778</span> <span class="token number">14435</span><span class="token operator">-</span><span class="token number">14435</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onStop <span class="token number">09</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">13.779</span> <span class="token number">14435</span><span class="token operator">-</span><span class="token number">14435</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onDestroyView <span class="token number">09</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">13.783</span> <span class="token number">14435</span><span class="token operator">-</span><span class="token number">14435</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onDestroy <span class="token number">09</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">13.783</span> <span class="token number">14435</span><span class="token operator">-</span><span class="token number">14435</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>fragmenttest D<span class="token operator">/</span>RightFragment<span class="token operator">:</span> onDetach</code></pre><h1 id="4-ç–‘é—®"><a href="#4-ç–‘é—®" class="headerlink" title="4. ç–‘é—®"></a>4. ç–‘é—®</h1><p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨è®¨è®º Activity çš„æ—¶å€™æåˆ°è¿‡ä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœ Activity è¿›å…¥åœæ­¢çŠ¶æ€ï¼Œæœ‰å¯èƒ½ä¼šè¢«å›æ”¶æ‰ï¼Œé‚£ä¹ˆæ•°æ®å’ŒçŠ¶æ€å°±ä¼šä¸¢å¤±ï¼Œç¢ç‰‡æ˜¯ä¸æ˜¯ä¹Ÿå­˜åœ¨å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼é‚£æ€ä¹ˆåŠï¼Ÿ</p><p>å…¶å®åœ¨ç¢ç‰‡ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ onSaveInstanceState() æ–¹æ³•æ¥ä¿å­˜æ•°æ®ï¼Œä¿å­˜ä¸‹æ¥çš„æ•°æ®åœ¨ onCreate()ã€onCreateView() å’Œ onActivityCreate() è¿™ 3 ä¸ªæ–¹æ³•ä¸­éƒ½å¯ä»¥é‡æ–°å¾—åˆ°ï¼Œå› ä¸ºå®ƒä»¬éƒ½å«æœ‰ä¸€ä¸ª Bundle ç±»å‹çš„ savedInstanceState å‚æ•°ã€‚</p><h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a></p>]]></content>
      
      
      <categories>
          
          <category> å¸¸ç”¨ç»„ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fragment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢è®¨ Activity çš„ç”Ÿå‘½å‘¨æœŸ</title>
      <link href="/2018/07/20/08.chang-yong-zu-jian-xi-lie-tan-tao-activity-de-sheng-ming-zhou-qi/"/>
      <url>/2018/07/20/08.chang-yong-zu-jian-xi-lie-tan-tao-activity-de-sheng-ming-zhou-qi/</url>
      
        <content type="html"><![CDATA[<h3 id="1ã€æ´»åŠ¨çŠ¶æ€"><a href="#1ã€æ´»åŠ¨çŠ¶æ€" class="headerlink" title="1ã€æ´»åŠ¨çŠ¶æ€"></a>1ã€æ´»åŠ¨çŠ¶æ€</h3><p>æ¯ä¸ªæ´»åŠ¨åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­æœ€å¤šå¯èƒ½ä¼šæœ‰ <strong><font color="#FF0000">4</font></strong> ç§çŠ¶æ€ï¼š</p><blockquote><p>è¿è¡ŒçŠ¶æ€</p></blockquote><p>å½“ä¸€ä¸ªæ´»åŠ¨ä½äºè¿”å›æ ˆçš„æ ˆé¡¶æ—¶ï¼Œè¿™æ—¶æ´»åŠ¨å°±å¤„äºè¿è¡ŒçŠ¶æ€ã€‚ç³»ç»Ÿæœ€ä¸æ„¿æ„å›æ”¶çš„å°±æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€çš„æ´»åŠ¨ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥éå¸¸å·®çš„ç”¨æˆ·ä½“éªŒã€‚</p><blockquote><p>æš‚åœçŠ¶æ€</p></blockquote><p>å½“ä¸€ä¸ªæ´»åŠ¨ä¸å†å¤„äºæ ˆé¡¶ä½ç½®ï¼Œä½†ä»ç„¶å¯è§æ—¶ï¼Œè¿™æ—¶æ´»åŠ¨å°±è¿›å…¥äº†æš‚åœçŠ¶æ€ã€‚ä½ å¯èƒ½ä¼šè§‰å¾—æ—¢ç„¶æ´»åŠ¨å·²ç»ä¸åœ¨æ ˆé¡¶äº†ï¼Œè¿˜æ€ä¹ˆä¼šå¯è§å‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªæ´»åŠ¨éƒ½ä¼šå æ»¡æ•´ä¸ªå±å¹•ï¼Œæ¯”å¦‚å¯¹è¯æ¡†å½¢å¼çš„æ´»åŠ¨åªä¼šå ç”¨å±å¹•ä¸­é—´çš„éƒ¨åˆ†åŒºåŸŸã€‚å¤„äºæš‚åœçŠ¶æ€çš„æ´»åŠ¨ä»ç„¶æ˜¯å®Œå…¨å­˜æ´»ç€çš„ï¼Œç³»ç»Ÿä¹Ÿä¸æ„¿æ„å»å›æ”¶è¿™ç§æ´»åŠ¨ï¼ˆå› ä¸ºå®ƒè¿˜æ˜¯å¯è§çš„ï¼Œå›æ”¶å¯è§çš„ä¸œè¥¿éƒ½ä¼šåœ¨ç”¨æˆ·ä½“éªŒæ–¹é¢æœ‰ä¸å¥½çš„å½±å“ï¼Œï¼‰åªæœ‰åœ¨å†…å­˜æä½çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿæ‰ä¼šå»è€ƒè™‘å›æ”¶è¿™ç§æ´»åŠ¨ã€‚</p><blockquote><p>3ã€åœæ­¢çŠ¶æ€</p></blockquote><p>å½“ä¸€ä¸ªæ´»åŠ¨ä¸å†å¤„äºæ ˆé¡¶ä½ç½®ï¼Œå¹¶ä¸”å®Œå…¨ä¸å¯è§çš„çŠ¶æ€ï¼Œå°±è¿›å…¥äº†åœæ­¢çŠ¶æ€ã€‚ç³»ç»Ÿä»ç„¶ä¼šä¸ºè¿™ç§æ´»åŠ¨ä¿æŒç›¸åº”çš„çŠ¶æ€å’Œæˆå‘˜å˜é‡ï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯å®Œå…¨å¯é çš„ï¼Œå½“å…¶ä»–åœ°æ–¹éœ€è¦å†…å­˜æ—¶ï¼Œå¤„äºåœæ­¢çŠ¶æ€çš„æ´»åŠ¨æœ‰å¯èƒ½ä¼šè¢«ç³»ç»Ÿå›æ”¶ã€‚</p><blockquote><p>4ã€é”€æ¯çŠ¶æ€</p></blockquote><p>å½“ä¸€ä¸ªæ´»åŠ¨ä»è¿”å›æ ˆä¸­ç§»é™¤åå°±å˜æˆäº†é”€æ¯çŠ¶æ€ã€‚ç³»ç»Ÿä¼šæœ€å€¾å‘äºå›æ”¶å¤„äºè¿™ç§çŠ¶æ€çš„æ´»åŠ¨ï¼Œä»è€Œä¿è¯æ‰‹æœºçš„å†…å­˜å……è¶³ã€‚</p><hr><h3 id="2ã€å›è°ƒæ–¹æ³•"><a href="#2ã€å›è°ƒæ–¹æ³•" class="headerlink" title="2ã€å›è°ƒæ–¹æ³•"></a>2ã€å›è°ƒæ–¹æ³•</h3><p>Activity ç±»ä¸­å®šä¹‰äº† <strong><font color="#FF0000">7</font></strong> ä¸ªå›è°ƒæ–¹æ³•ï¼Œè¦†ç›–äº† Activity ç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸€ä¸ªç¯èŠ‚ï¼š</p><blockquote><p>onCreate()</p></blockquote><p>è¿™ä¸ªæ–¹æ³•ä½ å·²ç»çœ‹åˆ°è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œæ¯ä¸ªæ´»åŠ¨ä¸­æˆ‘ä»¬éƒ½é‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒä¼šåœ¨æ´»åŠ¨ç¬¬ä¸€æ¬¡è¢«åˆ›å»ºçš„æ—¶å€™è°ƒç”¨ã€‚ä½ åº”è¯¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®Œæˆæ´»åŠ¨çš„åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚åŠ è½½å¸ƒå±€ã€ç»‘å®šäº‹ä»¶ç­‰ã€‚</p><blockquote><p>onStart()</p></blockquote><p>è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨ç”±ä¸å¯è§å˜ä¸ºå¯è§çš„æ—¶å€™è°ƒç”¨ã€‚</p><blockquote><p>onResume()</p></blockquote><p>è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨å‡†å¤‡å¥½å’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„æ—¶å€™è°ƒç”¨ã€‚æ­¤æ—¶çš„æ´»åŠ¨ä¸€å®šä½äºè¿”å›æ ˆçš„æ ˆé¡¶ï¼Œå¹¶ä¸”å¤„äºè¿è¡ŒçŠ¶æ€ã€‚</p><blockquote><p>onPause()</p></blockquote><p>è¿™ä¸ªæ–¹æ³•åœ¨ç³»ç»Ÿå‡†å¤‡å»å¯åŠ¨æˆ–è€…æ¢å¤å¦ä¸€ä¸ªæ´»åŠ¨çš„æ—¶å€™è°ƒç”¨ã€‚æˆ‘ä»¬é€šå¸¸ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°†ä¸€äº›æ¶ˆè€— CPU çš„èµ„æºé‡Šæ”¾æ‰ï¼Œä»¥åŠä¿å­˜ä¸€äº›å…³é”®æ•°æ®ï¼Œä½†è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œé€Ÿåº¦ä¸€å®šè¦å¿«ï¼Œä¸ç„¶ä¼šå½±å“åˆ°æ–°çš„æ ˆé¡¶æ´»åŠ¨çš„ä½¿ç”¨ã€‚</p><blockquote><p>onStop()</p></blockquote><p>è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨å®Œå…¨ä¸å¯è§çš„æ—¶å€™è°ƒç”¨ã€‚å®ƒå’Œ onPause() æ–¹æ³•çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå¦‚æœå¯åŠ¨çš„æ–°æ´»åŠ¨æ˜¯ä¸€ä¸ªå¯¹è¯æ¡†å¼çš„æ´»åŠ¨ï¼Œé‚£ä¹ˆ onPause() æ–¹æ³•ä¼šå¾—åˆ°æ‰§è¡Œï¼Œè€Œ onStop() æ–¹æ³•å¹¶ä¸ä¼šæ‰§è¡Œã€‚</p><blockquote><p>onDestroy()</p></blockquote><p>è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨è¢«é”€æ¯ä¹‹åè°ƒç”¨ï¼Œä¹‹åæ´»åŠ¨çš„çŠ¶æ€å°†å˜ä¸ºé”€æ¯çŠ¶æ€ã€‚</p><blockquote><p>onRestart()</p></blockquote><p>è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨ç”±åœæ­¢çŠ¶æ€å˜ä¸ºè¿è¡ŒçŠ¶æ€ä¹‹å‰è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æ´»åŠ¨è¢«é‡æ–°å¯åŠ¨äº†ã€‚</p><hr><h3 id="3ã€ç”Ÿå­˜æœŸ"><a href="#3ã€ç”Ÿå­˜æœŸ" class="headerlink" title="3ã€ç”Ÿå­˜æœŸ"></a>3ã€ç”Ÿå­˜æœŸ</h3><p>ä»¥ä¸Š <strong><font color="#FF0000">7</font></strong> ä¸ªæ–¹æ³•ä¸­é™¤äº† onRestart() æ–¹æ³•ï¼Œå…¶ä»–éƒ½æ˜¯ä¸¤ä¸¤å¯¹åº”çš„ï¼Œä»è€Œå¯ä»¥å°†æ´»åŠ¨åˆ†ä¸º <strong><font color="#FF0000">3</font></strong> ç§ç”Ÿå­˜æœŸã€‚</p><p><strong><font color="#FF0000">å®Œæ•´ç”Ÿå­˜æœŸ</font></strong>ï¼šæ´»åŠ¨åœ¨ onCreate() æ–¹æ³•å’Œ onDestroy() æ–¹æ³•ä¹‹é—´æ‰€ç»å†çš„ï¼Œå°±æ˜¯å®Œæ•´ç”Ÿå­˜æœŸã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ´»åŠ¨ä¼šåœ¨ onCreate() æ–¹æ³•ä¸­å®Œæˆå„ç§åˆå§‹åŒ–æ“ä½œï¼Œè€Œåœ¨ onDestroy() æ–¹æ³•ç§å®Œæˆé‡Šæ”¾å†…å­˜çš„æ“ä½œã€‚</p><p><strong><font color="#FF0000">å¯è§ç”Ÿå­˜æœŸ()</font></strong>ï¼šæ´»åŠ¨åœ¨ onStart() æ–¹æ³•å’Œ onStop() æ–¹æ³•ä¹‹é—´æ‰€ç»å†çš„ï¼Œå°±æ˜¯å¯è§ç”Ÿå­˜æœŸã€‚åœ¨å¯è§ç”Ÿå­˜æœŸå†…ï¼Œæ´»åŠ¨å¯¹äºç”¨æˆ·æ€»æ˜¯å¯è§çš„ï¼Œå³ä¾¿æœ‰å¯èƒ½æ— æ³•å’Œç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆç†åœ°ç®¡ç†é‚£äº›å¯¹ç”¨æˆ·å¯è§çš„èµ„æºã€‚æ¯”å¦‚åœ¨ onStart() æ–¹æ³•ä¸­å¯¹èµ„æºè¿›è¡ŒåŠ è½½ï¼Œè€Œåœ¨ onStop() æ–¹æ³•ä¸­å¯¹èµ„æºè¿›è¡Œé‡Šæ”¾ï¼Œä»è€Œä¿è¯å¤„äºåœæ­¢çŠ¶æ€çš„æ´»åŠ¨ä¸ä¼šå ç”¨è¿‡å¤šå†…å­˜ã€‚</p><p><strong><font color="#FF0000">å‰å°ç”Ÿå­˜æœŸ</font></strong>ï¼šæ´»åŠ¨åœ¨ onResume() æ–¹æ³•å’Œ onPause() æ–¹æ³•ä¹‹é—´æ‰€ç»å†çš„ï¼Œå°±æ˜¯å‰å°ç”Ÿå­˜æœŸã€‚åœ¨å‰å°ç”Ÿå­˜æœŸå†…ï¼Œæ´»åŠ¨æ€»æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€çš„ï¼Œæ­¤æ—¶çš„æ´»åŠ¨æ˜¯å¯ä»¥å’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„ï¼Œæˆ‘ä»¬å¹³æ—¶çœ‹åˆ°å’Œæ¥è§¦æœ€å¤šçš„å°±æ˜¯è¿™ä¸ªçŠ¶æ€ä¸‹çš„æ´»åŠ¨ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹å®˜æ–¹ç»™å‡ºçš„ Activity ç”Ÿå‘½å‘¨æœŸçš„ç¤ºæ„å›¾ï¼š<br><br></p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-a82dadc7f3f3b829.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/720" alt="Activity.png"></center><hr><h3 id="4ã€å®æˆ˜æ¼”ç»ƒ"><a href="#4ã€å®æˆ˜æ¼”ç»ƒ" class="headerlink" title="4ã€å®æˆ˜æ¼”ç»ƒ"></a>4ã€å®æˆ˜æ¼”ç»ƒ</h3><h4 id="4-1-Code"><a href="#4-1-Code" class="headerlink" title="4.1 Code"></a>4.1 Code</h4><p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªï¼šNormalActivity</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>android.support.constraint.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.NormalActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>This is a normal activity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>android.support.constraint.ConstraintLayout</span><span class="token punctuation">></span></span></code></pre><p>å†å®šä¹‰ä¸€ä¸ªï¼šDialogActivity</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>android.support.constraint.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.DialogActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>This is a dialog activity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>android.support.constraint.ConstraintLayout</span><span class="token punctuation">></span></span></code></pre><p>ä¸ºäº†è®© DialogActivity ä½¿ç”¨å¯¹è¯æ¡†å¼ä¸»é¢˜ï¼Œæˆ‘ä»¬åœ¨ AndroidManifest.xml ä¸­åšå¦‚ä¸‹è®¾ç½®ï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.marco.activitylifecycletest<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>        <span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>roundIcon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher_round<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>supportsRtl</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/AppTheme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.NormalActivity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.DialogActivity<span class="token punctuation">"</span></span>            <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/Theme.AppCompat.Dialog<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    // Look here        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span></code></pre><p>æ¥ä¸‹æ¥ä¿®æ”¹ activity_main.xmlï¼Œé‡æ–°å®šåˆ¶ä¸»æ´»åŠ¨çš„å¸ƒå±€ï¼š</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/start_normal_activity<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Start NormalActivity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/start_dialog_activity<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Start DialogActivity<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">></span></span></code></pre><p>ä¿®æ”¹ MainActivity ï¼š</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>marco<span class="token punctuation">.</span>activitylifecycletest<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Intent<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Button<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"MainActivity"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Button startNormalActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> Button startDialogActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        startNormalActivity <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>start_normal_activity<span class="token punctuation">)</span><span class="token punctuation">;</span>        startDialogActivity <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>start_dialog_activity<span class="token punctuation">)</span><span class="token punctuation">;</span>        startNormalActivity<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> NormalActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        startDialogActivity<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> DialogActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onResume"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onPause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onStop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onDestroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onRestart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRestart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onRestart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="4-2-Result"><a href="#4-2-Result" class="headerlink" title="4.2 Result"></a>4.2 Result</h4><p>ï¼ˆ1ï¼‰å½“ MainActivity ç¬¬ä¸€æ¬¡è¢«åˆ›å»ºæ—¶ï¼Œå¦‚ä¸‹æ–¹æ³•è¢«æ‰§è¡Œï¼š</p><pre><code>2018-10-18 04:31:29.071 2526-2526/? D/MainActivity: onCreate2018-10-18 04:31:29.077 2526-2526/? D/MainActivity: onStart2018-10-18 04:31:29.083 2526-2526/? D/MainActivity: onResume</code></pre><p>ï¼ˆ2ï¼‰ç‚¹å‡» Start NormalActivity æŒ‰é’®ï¼š</p><pre><code>2018-10-18 04:33:02.159 2526-2526/com.example.marco.activitylifecycletest D/MainActivity: onPause2018-10-18 04:33:02.745 2526-2526/com.example.marco.activitylifecycletest D/MainActivity: onStop</code></pre><p>å› ä¸º NormalActivity å·²ç»æŠŠ MainActivity å®Œå…¨é®æŒ¡ä½ï¼Œå› æ­¤ onPause() å’Œ onStop() æ–¹æ³•éƒ½ä¼šå¾—åˆ°æ‰§è¡Œã€‚</p><p>ï¼ˆ3ï¼‰ç‚¹å‡» Back é”®è¿”å› MainActivityï¼š</p><pre><code>2018-10-18 04:35:00.010 2526-2526/com.example.marco.activitylifecycletest D/MainActivity: onRestart2018-10-18 04:35:00.012 2526-2526/com.example.marco.activitylifecycletest D/MainActivity: onStart2018-10-18 04:35:00.014 2526-2526/com.example.marco.activitylifecycletest D/MainActivity: onResume</code></pre><p>ç”±äºä¹‹å‰ MainActivity å·²ç»è¿›å…¥äº†åœæ­¢çŠ¶æ€ï¼Œæ‰€ä»¥ onRestart() æ–¹æ³•ä¼šå¾—åˆ°æ‰§è¡Œï¼Œä¹‹ååˆä¼šæ‰§è¡Œ onStart() å’Œ onResume() æ–¹æ³•ã€‚æ³¨æ„ï¼Œæ­¤æ—¶ onCreate() æ–¹æ³•ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸º MainActivity å¹¶æ²¡æœ‰é‡æ–°åˆ›å»ºã€‚</p><p>ï¼ˆ4ï¼‰ç‚¹å‡» Start DialogActivity æŒ‰é’®ï¼š</p><pre><code>2018-10-18 04:43:38.006 3555-3555/com.example.marco.activitylifecycletest D/MainActivity: onPause</code></pre><p>é€šè¿‡ Log å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ onPause() æ–¹æ³•å¾—åˆ°äº†æ‰§è¡Œï¼ŒonStop() æ–¹æ³•å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸º DialogActivity å¹¶æ²¡æœ‰å®Œå…¨é®æŒ¡ä½ MainActivityï¼Œæ­¤æ—¶ MainActivity åªæ˜¯è¿›å…¥äº†æš‚åœçŠ¶æ€ï¼Œå¹¶æ²¡æœ‰è¿›å…¥åœæ­¢çŠ¶æ€ã€‚</p><p>ï¼ˆ5ï¼‰ç‚¹å‡» Back é”®è¿”å› MainActivityï¼š</p><pre><code>2018-10-18 04:50:12.222 3555-3555/com.example.marco.activitylifecycletest D/MainActivity: onResume</code></pre><p>æŒ‰ä¸‹ Back é”®è¿”å› MainActivity ä¹Ÿåº”è¯¥åªæœ‰ onResume() æ–¹æ³•ä¼šå¾—åˆ°æ‰§è¡Œã€‚</p><p>ï¼ˆ6ï¼‰åœ¨ MainActivity ç•Œé¢æŒ‰ä¸‹ Back é”®é€€å‡ºç¨‹åºï¼š</p><pre><code>2018-10-18 04:51:47.673 3555-3555/com.example.marco.activitylifecycletest D/MainActivity: onPause2018-10-18 04:51:48.013 3555-3555/com.example.marco.activitylifecycletest D/MainActivity: onStop2018-10-18 04:51:48.015 3555-3555/com.example.marco.activitylifecycletest D/MainActivity: onDestroy</code></pre><p>ä¾æ¬¡ä¼šæ‰§è¡Œ onPause()ã€onStop() å’Œ onDestroy æ–¹æ³•ï¼Œæœ€ç»ˆé”€æ¯ MainActivityã€‚</p><h3 id="5ã€ç–‘é—®"><a href="#5ã€ç–‘é—®" class="headerlink" title="5ã€ç–‘é—®"></a>5ã€ç–‘é—®</h3><p>æˆ‘ä»¬åœ¨ä¹‹å‰åˆ†æ Activity çš„ç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™æ›¾ç»æåˆ°è¿‡ï¼šå¦‚æœä¸€ä¸ªæ´»åŠ¨è¿›å…¥äº† onStop ï¼ˆåœæ­¢ï¼‰çŠ¶æ€ï¼Œæ˜¯æœ‰å¯èƒ½è¢«ç³»ç»Ÿå›æ”¶çš„ï¼</p><h4 id="5-1-åœºæ™¯"><a href="#5-1-åœºæ™¯" class="headerlink" title="5.1 åœºæ™¯"></a>5.1 åœºæ™¯</h4><p>æ¯”å¦‚æˆ‘ä»¬çœ‹ä»¥ä¸‹çš„åœºæ™¯ï¼š</p><p>åº”ç”¨ä¸­æœ‰ä¸€ä¸ªæ´»åŠ¨ A ï¼Œç”¨æˆ·åœ¨æ´»åŠ¨ A çš„åŸºç¡€ä¸Šå¯åŠ¨äº†æ´»åŠ¨ B ï¼Œæ´»åŠ¨ A å°±è¿›å…¥äº†åœæ­¢çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™ç”±äºç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œå°†æ´»åŠ¨ A å›æ”¶æ‰äº†ï¼Œç„¶åç”¨æˆ·æŒ‰ä¸‹ Back é”®è¿”å›æ´»åŠ¨ A ï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><p>å…¶å®è¿˜æ˜¯ä¼šæ­£å¸¸æ˜¾ç¤ºæ´»åŠ¨ A çš„ï¼Œä½†æ˜¯æ­¤æ—¶å¹¶ä¸ä¼šæ‰§è¡Œ onRestart() æ–¹æ³•äº†ï¼Œè€Œæ˜¯ä¼šæ‰§è¡Œæ´»åŠ¨ A çš„ onCreate() æ–¹æ³•ï¼Œå› ä¸ºæ´»åŠ¨ A åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šè¢«é‡æ–°åˆ›å»ºä¸€æ¬¡ã€‚</p><p>å¯èƒ½è¿™å¹¶ä¸ä¼šå½±å“æ­£å¸¸çš„åŠŸèƒ½ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼šå¦‚æœæ´»åŠ¨ A ä¸­å­˜åœ¨ä¸´æ—¶æ•°æ®å’ŒçŠ¶æ€ï¼ˆæ¯”å¦‚ A ä¸­æœ‰ä¸€ä¸ªæ–‡æœ¬è¾“å…¥æ¡†ï¼Œæˆ‘ä»¬è¾“å…¥äº†ä¸€äº›æ–‡å­—ï¼Œç„¶åå¯åŠ¨äº† B æ´»åŠ¨ï¼Œå¦‚æœ A è¢« killäº†ï¼Œåœ¨é‡æ–°å›åˆ° A åï¼ŒA æ´»åŠ¨é‡æ–°åˆ›å»ºï¼Œé‚£ä¹ˆæ•°æ®éƒ½ä¸¢å¤±äº†ï¼‰ï¼Œæ­¤æ—¶ä¼šä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p><h4 id="5-2-ç­–ç•¥"><a href="#5-2-ç­–ç•¥" class="headerlink" title="5.2 ç­–ç•¥"></a>5.2 ç­–ç•¥</h4><p>å…¶å®å®˜æ–¹æ–‡æ¡£ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼ŒActivity ä¸­æä¾›äº†ä¸€ä¸ª onSaveInstanceState() å›è°ƒæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ä¿è¯åœ¨æ´»åŠ¨è¢«å›æ”¶ä¹‹å‰ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è§£å†³æ´»åŠ¨è¢«å›æ”¶æ—¶ä¸´æ—¶æ•°æ®å¾—ä¸åˆ°ä¿å­˜çš„é—®é¢˜ã€‚</p><p>onSaveInstanceState() æ–¹æ³•ä¼šæºå¸¦ä¸€ä¸ª Bundle ç±»å‹çš„å‚æ•°ï¼ŒBundle æä¾›äº†ä¸€ç³»åˆ—çš„æ–¹æ³•ç”¨äºä¿å­˜æ•°æ®ï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨ putString() æ–¹æ³•ä¿å­˜å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ putInt() æ–¹æ³•ä¿å­˜æ•´å‹æ•°æ®ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p><p>æ¯ä¸ªä¿å­˜æ–¹æ³•éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”®ï¼Œç”¨äºåé¢ä» Bundle ä¸­å–å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯çœŸæ­£è¦ä¿å­˜çš„å†…å®¹ã€‚</p><h4 id="5-3-Code"><a href="#5-3-Code" class="headerlink" title="5.3 Code"></a>5.3 Code</h4><p>æˆ‘ä»¬ç°åœ¨å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œä¿®æ”¹ï¼Œåœ¨ MainActivity ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç å°†ä¸´æ—¶æ•°æ®è¿›è¡Œä¿å­˜ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onSaveInstanceState</span><span class="token punctuation">(</span>Bundle outState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onSaveInstanceState</span><span class="token punctuation">(</span>outState<span class="token punctuation">)</span><span class="token punctuation">;</span>        String tempData <span class="token operator">=</span> <span class="token string">"Something you just typed"</span><span class="token punctuation">;</span>        outState<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"data_key"</span><span class="token punctuation">,</span> tempData<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>Okï¼Œæ•°æ®ä¿å­˜å¥½äº†ï¼Œé‚£æˆ‘ä»¬åº”è¯¥åœ¨å“ªè¾¹è¿›è¡Œæ¢å¤ï¼Ÿ</p><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œåœ¨ onCreate() æ–¹æ³•ä¸­æœ‰ä¸€ä¸ª Bundle ç±»å‹çš„å‚æ•°ã€‚è¿™ä¸ªå‚æ•°ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ null ï¼Œä½†æ˜¯å¦‚æœåœ¨æ´»åŠ¨è¢«ç³»ç»Ÿå›æ”¶ä¹‹å‰æœ‰é€šè¿‡ onSaveInstanceState() æ–¹æ³•æ¥ä¿å­˜æ•°æ®çš„è¯ï¼Œè¿™ä¸ªå‚æ•°å°±ä¼šå¸¦æœ‰ä¹‹å‰æ‰€ä¿å­˜çš„å…¨éƒ¨æ•°æ®ï¼Œæˆ‘ä»¬åªéœ€è¦å†é€šè¿‡ç›¸åº”çš„å–å€¼æ–¹æ³•å°†æ•°æ®å–å‡ºå³å¯ã€‚</p><p>ä¿®æ”¹ MainActivity çš„ onCreate() æ–¹æ³•ï¼š</p><pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCreate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            String tempData <span class="token operator">=</span> savedInstanceState<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"data_key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> tempData<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">}</span></code></pre><p>é€šè¿‡ä¸Šé¢çš„æ–¹æ³•å–å‡ºå€¼ä¹‹åå†åšç›¸åº”çš„æ¢å¤æ“ä½œå°±å¯ä»¥äº†ï¼Œæ¯”å¦‚è¯´å°†æ–‡æœ¬å†…å®¹é‡æ–°èµ‹å€¼åˆ°æ–‡æœ¬è¾“å…¥æ¡†ä¸Šå³å¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¸¸ç”¨ç»„ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢è®¨ Activity çš„å¯åŠ¨æ¨¡å¼</title>
      <link href="/2018/07/18/08.chang-yong-zu-jian-xi-lie-tan-tao-activity-de-qi-dong-mo-shi/"/>
      <url>/2018/07/18/08.chang-yong-zu-jian-xi-lie-tan-tao-activity-de-qi-dong-mo-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="LaunchMode"><a href="#LaunchMode" class="headerlink" title="LaunchMode"></a>LaunchMode</h1><p>å¯ä»¥åœ¨ AndroidManifest.xml ä¸­é€šè¿‡ç»™ <activity> æ ‡ç­¾æŒ‡å®š <strong><font color="#0000FF">android:launchMode</font></strong> å±æ€§æ¥é€‰æ‹©å¯åŠ¨æ¨¡å¼ã€‚</activity></p><blockquote><p><strong>standard</strong></p></blockquote><p>standard æ˜¯æ´»åŠ¨é»˜è®¤çš„å¯åŠ¨æ¨¡å¼ï¼Œåœ¨ä¸è¿›è¡Œæ˜¾å¼æŒ‡å®šçš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ´»åŠ¨éƒ½ä¼šè‡ªåŠ¨ä½¿ç”¨è¿™ç§å¯åŠ¨æ¨¡å¼ã€‚æˆ‘ä»¬çŸ¥é“ Android æ˜¯ä½¿ç”¨è¿”å›æ ˆæ¥ç®¡ç†æ´»åŠ¨çš„ï¼Œåœ¨ standard æ¨¡å¼ä¸‹ï¼Œæ¯å½“å¯åŠ¨ä¸€ä¸ªæ–°çš„æ´»åŠ¨ï¼Œå®ƒå°±ä¼šåœ¨è¿”å›æ ˆä¸­å…¥æ ˆï¼Œå¹¶å¤„äºæ ˆé¡¶çš„ä½ç½®ã€‚</p><p>å¯¹äºä½¿ç”¨ standard æ¨¡å¼çš„æ´»åŠ¨ï¼Œç³»ç»Ÿä¸ä¼šåœ¨ä¹è¿™ä¸ªæ´»åŠ¨æ˜¯å¦å·²ç»åœ¨è¿”å›æ ˆä¸­å­˜åœ¨ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½ä¼šåˆ›å»ºè¯¥æ´»åŠ¨çš„ä¸€ä¸ªæ–°å®ä¾‹ã€‚</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-3bb5f57fa0e5d7a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3994917-5cc3d0d8dd2be549.png"></center><blockquote><p><strong>singleTop</strong></p></blockquote><p>æœ‰æ²¡æœ‰è§‰å¾— standard æ¨¡å¼ä¼¼ä¹ä¸å¤ªåˆç†ï¼Œæ´»åŠ¨æ˜æ˜å·²ç»åœ¨æ ˆé¡¶äº†ï¼Œä¸ºä»€ä¹ˆå†æ¬¡å¯åŠ¨çš„æ—¶å€™è¿˜è¦åˆ›å»ºä¸€æ¬¡æ–°çš„æ´»åŠ¨å®ä¾‹å‘¢ï¼Ÿå½“ç„¶ï¼Œè¿™åªæ˜¯ç³»ç»Ÿé»˜è®¤çš„ä¸€ç§å¯åŠ¨æ¨¡å¼è€Œå·²ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æ ¹æ®è‡ªå·±çš„è¦æ±‚è¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ singleTop æ¨¡å¼ã€‚</p><p>å½“æ´»åŠ¨çš„å¯åŠ¨æ¨¡å¼æŒ‡å®šä¸º singleTopï¼Œåœ¨å¯åŠ¨æ´»åŠ¨æ—¶å¦‚æœå‘ç°è¿”å›æ ˆçš„æ ˆé¡¶å·²ç»æ˜¯è¯¥æ´»åŠ¨ï¼Œåˆ™è®¤ä¸ºå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒï¼Œç›´æ¥è°ƒç”¨ <strong><font color="#FF0000">onNewIntent()</font></strong> æ–¹æ³•æ¥å®ç°é‡ç”¨ï¼Œä¸ä¼šå†åˆ›å»ºæ–°çš„æ´»åŠ¨å®ä¾‹ã€‚</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-16bb62b6b0e00580.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3994917-051def7f0abafef5.png"></center><blockquote><p><strong>singleTask</strong></p></blockquote><p>ä½¿ç”¨ singleTop æ¨¡å¼å¯ä»¥å¾ˆå¥½çš„è§£å†³é‡å¤åˆ›å»ºæ ˆé¡¶æ´»åŠ¨çš„é—®é¢˜ï¼Œä½†æ˜¯è¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜äº†ï¼Œå¦‚æœæ´»åŠ¨å¤„äºæ ˆé¡¶ï¼Œé‚£ä¹ˆä¸ä¼šå†é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œä½†å¦‚æœä¸å¤„äºæ ˆé¡¶ï¼Œåˆ™ä¼šé‡æ–°åˆ›å»ºã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è‡ªç„¶è€Œç„¶è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥è®©æŸä¸ªæ´»åŠ¨åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¸­åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© singleTask æ¨¡å¼æ¥å®ç°ã€‚</p><p>å½“æ´»åŠ¨çš„å¯åŠ¨æ¨¡å¼æŒ‡å®šä¸º singleTaskï¼Œæ¯æ¬¡å¯åŠ¨è¯¥æ´»åŠ¨æ—¶ç³»ç»Ÿé¦–å…ˆä¼šåœ¨è¿”å›æ ˆä¸­æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥æ´»åŠ¨çš„å®ä¾‹ï¼Œå¦‚æœå‘ç°å·²ç»å­˜åœ¨åˆ™ç›´æ¥è°ƒç”¨ <strong><font color="#FF0000">onNewIntent()</font></strong> æ–¹æ³•æ¥å®ç°é‡ç”¨å®ä¾‹ï¼Œå¹¶æŠŠåœ¨è¿™ä¸ªæ´»åŠ¨ä¹‹ä¸Šçš„æ‰€æœ‰æ´»åŠ¨ç»Ÿç»Ÿå‡ºæ ˆï¼Œå¦‚æœæ²¡æœ‰å‘ç°å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ´»åŠ¨å®ä¾‹ã€‚</p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-473f55d3138f4e87.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3994917-2811e48d580c4b0e.png"></center><blockquote><p><strong>singleInstance</strong></p></blockquote><p>singleInstance æ¨¡å¼åº”è¯¥ç®—æ˜¯ 4 ä¸ªå¯åŠ¨æ¨¡å¼ä¸­æœ€ç‰¹æ®Šä¹Ÿæœ€å¤æ‚çš„ä¸€ä¸ªäº†ã€‚ä¸åŒäºä»¥ä¸Š 3 ç§å¯åŠ¨æ¨¡å¼ï¼ŒæŒ‡å®šä¸º singleInstance æ¨¡å¼çš„æ´»åŠ¨ä¼šåœ¨ä¸€ä¸ªæ–°æ ˆä¸­åˆ›å»ºè¯¥ Activity çš„å®ä¾‹ï¼Œå¹¶è®©å¤šä¸ªåº”ç”¨å…±äº«è¯¥æ ˆä¸­çš„è¯¥ Activity å®ä¾‹ã€‚</p><p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-701cfc5a5c45a355.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3994917-2811e48d580c4b0e.png"></center><br><br></p><h1 id="Intent-æ ‡ç­¾"><a href="#Intent-æ ‡ç­¾" class="headerlink" title="Intent æ ‡ç­¾"></a>Intent æ ‡ç­¾</h1><p>åœ¨ Android ä¸­ï¼Œæˆ‘ä»¬é™¤äº†åœ¨æ¸…å•æ–‡ä»¶ AndroidManifest.xml ä¸­é…ç½® launchModeï¼Œå½“ç„¶å¯ä»¥ç”¨ Intent æ ‡ç­¾è¯´äº‹å„¿ã€‚</p><p>å¯åŠ¨ Activity ï¼Œæˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ª Intentï¼Œå®Œå…¨å¯ä»¥é€šè¿‡è®¾ç½® <strong><font color="#0000FF">Intent.setFlags(int flags)</font></strong> æ¥è®¾ç½®å¯åŠ¨çš„ Activity çš„å¯åŠ¨æ¨¡å¼ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šé€šè¿‡ä»£ç æ¥è®¾ç½® Activity çš„å¯åŠ¨æ¨¡å¼çš„æ–¹å¼ï¼Œä¼˜å…ˆçº§æ¯”æ¸…å•æ–‡ä»¶è®¾ç½®æ›´é«˜ã€‚</p></blockquote><table><thead><tr><th>Flag</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><font color="#0000FF">FLAG_ACTIVITY_NEW_TASK</font></td><td>è¿™ä¸ªæ ‡è¯†ä¼šä½¿æ–°å¯åŠ¨çš„ Activity ç‹¬ç«‹åˆ›å»ºä¸€ä¸ª Taskã€‚</td></tr><tr><td><font color="#0000FF">FLAG_ACTIVITY_CLEAR_TOP</font></td><td>è¿™ä¸ªæ ‡è¯†ä¼šä½¿æ–°å¯åŠ¨çš„ Activity æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº Task ä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™æ¸…é™¤å…¶ä¹‹ä¸Šçš„ Activityï¼Œä½¿å®ƒè·å¾—ç„¦ç‚¹ï¼Œå¹¶ä¸é‡æ–°å®ä¾‹åŒ–ä¸€ä¸ª Activityï¼Œä¸€èˆ¬ç»“åˆ FLAG_ACTIVITY_NEW_TASK ä¸€èµ·ä½¿ç”¨ã€‚</td></tr><tr><td><font color="#0000FF">FLAG_ACTIVITY_SINGLE_TOP</font></td><td>åŒäºåœ¨ launcherMode å±æ€§è®¾ç½®ä¸º singleTopã€‚</td></tr></tbody></table><p><br></p><h1 id="é¢è¯•é¢˜èŒƒä¾‹"><a href="#é¢è¯•é¢˜èŒƒä¾‹" class="headerlink" title="é¢è¯•é¢˜èŒƒä¾‹"></a>é¢è¯•é¢˜èŒƒä¾‹</h1><blockquote><p>1ã€è®¾ç½®ä¸º singleTask çš„å¯åŠ¨æ¨¡å¼ï¼Œå½“ Activity çš„å®ä¾‹å·²ç»å­˜åœ¨æ—¶ï¼Œå†å¯åŠ¨å®ƒï¼Œå®ƒçš„å“ªä¸ªå›è°ƒå‡½æ•°ä¼šè¢«æ‰§è¡Œï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨å“ªä¸ªå›è°ƒä¸­å¤„ç†æ–°çš„ Intent åå¸¦çš„å‚æ•°ï¼Ÿ<br>2ã€è®¾ç½®ä¸º singleTop çš„å¯åŠ¨æ¨¡å¼ï¼Œå½“ Activity çš„å®ä¾‹å·²ç»å­˜åœ¨äº Task çš„æ ˆé¡¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å“ªä¸ªå›è°ƒä¸­å¤„ç†æ–°çš„ Intent åå¸¦çš„å‚æ•°ï¼Ÿ</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> å¸¸ç”¨ç»„ä»¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activity </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
