<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="聊聊 LowMemoryKiller 机制, Thinking in Android">
    <meta name="description" content="一、核心源码


关键类
路径




lmkd.c
system/core/lmkd/lmkd.c


lmkd.rc
system/core/lmkd/lmkd.rc


lowmemorykiller.c
kernel-3.18/dr">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>聊聊 LowMemoryKiller 机制 | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color-header-marco nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/常用组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/系统启动/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/核心机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>机制</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>拓展</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术细节/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="检索博文"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/常用组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/系统启动/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/核心机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                机制
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                拓展
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        <li>
            <a href="/categories/技术细节/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/LowMemoryKiller.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        聊聊 LowMemoryKiller 机制
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/LowMemoryKiller/" target="_blank">
                                <span class="chip bg-color">LowMemoryKiller</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/核心技术/" class="post-category" target="_blank">
                                核心技术
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;发布日期 :&nbsp;
                    2019-05-01
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;文章字数 :&nbsp;
                        6.4k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;阅读时长 :&nbsp;
                        28 分钟
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;阅读次数 :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="一、核心源码"><a href="#一、核心源码" class="headerlink" title="一、核心源码"></a>一、核心源码</h1><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">lmkd.c</font></td>
<td>system/core/lmkd/lmkd.c</td>
</tr>
<tr>
<td><font color="#D15FEE">lmkd.rc</font></td>
<td>system/core/lmkd/lmkd.rc</td>
</tr>
<tr>
<td><font color="#D15FEE">lowmemorykiller.c</font></td>
<td>kernel-3.18/drivers/staging/android/lowmemorykiller.c</td>
</tr>
<tr>
<td><font color="#D15FEE">ProcessList.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/am/ProcessList.java</td>
</tr>
</tbody>
</table>
<h1 id="二、进程生命周期"><a href="#二、进程生命周期" class="headerlink" title="二、进程生命周期"></a>二、进程生命周期</h1><p>Android 系统的设计理念正是希望应用进程能尽量长时间地存活，以提升用户体验。应用首次打开比较慢，这个过程有进程创建以及 Application 等信息的初始化，所以应用在启动之后，即便退到后台并非立刻杀死，而是存活一段时间，这样下次再使用则会非常快。对于 APP 同样希望自身尽可能存活更长的时间，现在很多开发者都在探索各种保活黑科技。</p>
<p>但物极必反，如果系统继续放任所有进程一直存活，那么系统处于低内存的状态下，性能就会有所下降，内存也会很快枯竭而亡。此时我们就需要进程回收机制帮助我们合理的把控那些进程改回收，哪些不该回收。</p>
<p>那么问题来了，系统如何判断？到底该回收哪个进程？<strong><font color="#FF0000">其实系统会根据进程的组件状态来决定每个进程的优先级值 “ADJ”，根据一定策略先杀优先级最低的进程，然后逐步杀优先级更低的进程。</font></strong>以此类推，以回收预期的可用系统资源，从而保证系统正常运转。</p>
<p>接下来就要引入我们本文需要讨论的主角了：<strong><font color="#1874CD">LowMemoryKiller</font></strong>（系统用于判定是否需要杀进程和杀哪些进程的一个机制）。</p>
<h1 id="三、进程优先级"><a href="#三、进程优先级" class="headerlink" title="三、进程优先级"></a>三、进程优先级</h1><p>系统内进程优先级分 5 级：</p>
<table>
<thead>
<tr>
<th>进程</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>前台进程（Foreground process）</td>
<td>用户当前操作所必需的进程。</td>
</tr>
<tr>
<td>可见进程（Visible process）</td>
<td>没有任何前台组件、但仍会影响用户在屏幕上所见内容的进程。<br>可见进程被视为是极其重要的进程，<br>除非为了维持所有前台进程同时运行而必须终止，否则系统不会终止这些进程。</td>
</tr>
<tr>
<td>服务进程（Service process）</td>
<td>正在运行已使用 startService() 方法启动的服务且不属于上述两个更高类别进程的进程。<br>尽管服务进程与用户所见内容没有直接关联，但是它们通常在执行一些用户关心的操作<br>（例如，在后台播放音乐或从网络下载数据）。<br>因此，除非内存不足以维持所有前台进程和可见进程同时运行，否则系统会让服务进程保持运行状态。</td>
</tr>
<tr>
<td>后台进程（Background process）</td>
<td>包含目前对用户不可见的 Activity 的进程（已调用 Activity 的 onStop() 方法）。<br>这些进程对用户体验没有直接影响，系统可能随时终止它们。</td>
</tr>
<tr>
<td>空进程 （Empty process）</td>
<td>不含任何活动应用组件的进程。<br>保留这种进程的的唯一目的是用作缓存，以缩短下次在其中运行组件所需的启动时间。<br>为使总体系统资源在进程缓存和底层内核缓存之间保持平衡，系统往往会终止这些进程。</td>
</tr>
</tbody>
</table>
<h1 id="四、Framework-OOM-Adjustment"><a href="#四、Framework-OOM-Adjustment" class="headerlink" title="四、Framework OOM Adjustment"></a>四、Framework OOM Adjustment</h1><h2 id="4-1-ADJ-级别"><a href="#4-1-ADJ-级别" class="headerlink" title="4.1 ADJ 级别"></a>4.1 ADJ 级别</h2><p>ADJ 定义在 <strong><font color="#1874CD">ProcessList.java</font></strong> 中：<strong><font color="#FF0000">oom_adj</font></strong> 划分为16级，取值范围[-1000~1001]</p>
<table>
<thead>
<tr>
<th>ADJ 级别</th>
<th>取值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>UNKNOWN_ADJ</td>
<td>1001</td>
<td>一般指将要会缓存进程，无法获取确定值</td>
</tr>
<tr>
<td>CACHED_APP_MAX_ADJ</td>
<td>906</td>
<td>不可见进程的 adj 最大值</td>
</tr>
<tr>
<td>CACHED_APP_MIN_ADJ</td>
<td>900</td>
<td>不可见进程的 adj 最小值</td>
</tr>
<tr>
<td>SERVICE_B_AD</td>
<td>800</td>
<td>B List中的Service（较老的、使用可能性更小）</td>
</tr>
<tr>
<td>PREVIOUS_APP_ADJ</td>
<td>700</td>
<td>上一个App的进程(往往通过按返回键)</td>
</tr>
<tr>
<td>HOME_APP_ADJ</td>
<td>600</td>
<td>Home进程</td>
</tr>
<tr>
<td>SERVICE_ADJ</td>
<td>500</td>
<td>服务进程(Service process)</td>
</tr>
<tr>
<td>HEAVY_WEIGHT_APP_ADJ</td>
<td>400</td>
<td>后台的重量级进程，system/rootdir/init.rc文件中设置</td>
</tr>
<tr>
<td>BACKUP_APP_ADJ</td>
<td>300</td>
<td>备份进程</td>
</tr>
<tr>
<td>PERCEPTIBLE_APP_ADJ</td>
<td>200</td>
<td>可感知进程，比如后台音乐播放</td>
</tr>
<tr>
<td>VISIBLE_APP_ADJ</td>
<td>100</td>
<td>可见进程(Visible process) </td>
</tr>
<tr>
<td>FOREGROUND_APP_ADJ</td>
<td>0</td>
<td>前台进程（Foreground process）</td>
</tr>
<tr>
<td>PERSISTENT_SERVICE_ADJ</td>
<td>-700</td>
<td>关联着系统或 persistent 进程</td>
</tr>
<tr>
<td>PERSISTENT_PROC_ADJ</td>
<td>-800</td>
<td>系统 persistent 进程，比如 telephony</td>
</tr>
<tr>
<td>SYSTEM_ADJ</td>
<td>-900</td>
<td>系统进程，仅指system_server进程</td>
</tr>
<tr>
<td>NATIVE_ADJ</td>
<td>-1000</td>
<td>native进程（不被系统管理）</td>
</tr>
</tbody>
</table>
<p>从 Android 7.0 开始，ADJ 采用 100、200、300 等数值；在这之前的版本 AD J采用数字 1、2、3 等数值，这样的调整是为了可以更进一步地细化进程的优先级，比如在 VISIBLE_APP_ADJ(100) 与 PERCEPTIBLE_APP_ADJ(200) 之间，可以设定 ADJ = 101、ADJ = 102 级别的进程。</p>
<h2 id="4-2-STATE-级别"><a href="#4-2-STATE-级别" class="headerlink" title="4.2 STATE 级别"></a>4.2 STATE 级别</h2><p>STATE 定义在 <strong><font color="#1874CD">ActivityManager.java</font></strong> 中：<strong><font color="#FF0000">process_state</font></strong> 划分20类，取值范围[-1~18]</p>
<table>
<thead>
<tr>
<th>STATE 级别</th>
<th>取值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>PROCESS_STATE_NONEXISTENT</td>
<td>18</td>
<td>不存在的进程</td>
</tr>
<tr>
<td>PROCESS_STATE_CACHED_EMPTY</td>
<td>17</td>
<td>进程处于cached状态，且为空进程</td>
</tr>
<tr>
<td>PROCESS_STATE_CACHED_ACTIVITY_CLIENT</td>
<td>16</td>
<td>进程处于cached状态，且为另一个cached进程(内含Activity)的client进程 adj 最大值</td>
</tr>
<tr>
<td>PROCESS_STATE_CACHED_ACTIVITY</td>
<td>15</td>
<td>进程处于cached状态，且内含Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_LAST_ACTIVITY</td>
<td>14</td>
<td>后台进程，且拥有上一次显示的Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_HOME</td>
<td>14</td>
<td>后台进程，且拥有home Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_RECEIVER</td>
<td>12</td>
<td>后台进程，且正在运行receiver</td>
</tr>
<tr>
<td>PROCESS_STATE_SERVICE</td>
<td>11</td>
<td>后台进程，且正在运行service</td>
</tr>
<tr>
<td>PROCESS_STATE_HEAVY_WEIGHT</td>
<td>10</td>
<td>后台进程，但无法执行restore，因此尽量避免kill该进程</td>
</tr>
<tr>
<td>PROCESS_STATE_BACKUP</td>
<td>9</td>
<td>后台进程，正在运行backup/restore操作</td>
</tr>
<tr>
<td>PROCESS_STATE_TRANSIENT_BACKGROUND</td>
<td>8</td>
<td>进程短暂进入后台，我们应该尽量保持运行</td>
</tr>
<tr>
<td>PROCESS_STATE_IMPORTANT_BACKGROUND</td>
<td>7</td>
<td>对用户很重要的进程，用户不可感知其存在</td>
</tr>
<tr>
<td>PROCESS_STATE_IMPORTANT_FOREGROUND</td>
<td>6</td>
<td>对用户很重要的进程，用户可感知其存在</td>
</tr>
<tr>
<td>PROCESS_STATE_TOP_SLEEPING</td>
<td>5</td>
<td>与PROCESS_STATE_TOP一样，但此时设备正处于休眠状态</td>
</tr>
<tr>
<td>PROCESS_STATE_FOREGROUND_SERVICE</td>
<td>4</td>
<td>拥有给一个前台Service</td>
</tr>
<tr>
<td>PROCESS_STATE_BOUND_FOREGROUND_SERVICE</td>
<td>3</td>
<td>拥有给一个前台Service，且由系统绑定</td>
</tr>
<tr>
<td>PROCESS_STATE_TOP</td>
<td>2</td>
<td>拥有当前用户可见的top Activity</td>
</tr>
<tr>
<td>PROCESS_STATE_PERSISTENT_UI</td>
<td>1</td>
<td>persistent系统进程，并正在执行UI操作</td>
</tr>
<tr>
<td>PROCESS_STATE_PERSISTENT</td>
<td>0</td>
<td>persistent系统进程</td>
</tr>
<tr>
<td>PROCESS_STATE_UNKNOWN</td>
<td>-1</td>
<td>不可知的进程</td>
</tr>
</tbody>
</table>
<h1 id="五、Read-The-Fucking-Code"><a href="#五、Read-The-Fucking-Code" class="headerlink" title="五、Read The Fucking Code"></a>五、Read The Fucking Code</h1><h2 id="5-1-lmkd"><a href="#5-1-lmkd" class="headerlink" title="5.1 lmkd"></a>5.1 lmkd</h2><p>通过前面的表格，我们可以看到：ProcessList 中定义有进程的优先级，<strong><font color="#FF0000">越重要的进程的优先级越低</font></strong> ，前台 APP 的优先级为 0，系统 APP 的优先级一般都是负值，所以一般进程管理以及杀进程都是针对上层 APP 来说的。</p>
<p><strong><font color="#FF0000">进程的优先级调整都在 ActivityManagerService 里面</font></strong> ，ActivityManagerService 根据进程中组件的状态去不断的计算每个进程的优先级，计算之后会及时更新到对应进程的文件节点中，<strong><font color="#FF0000">而这个对文件节点的更新并不是 AMS 完成的，而是 lmkd ，它们之间通过 socket 通信</font></strong>。 </p>
<p>lmkd 在手机中是一个常驻进程，用来处理上层 ActivityManager 在进行 updateOomAdj 之后，通过 socket 与 lmkd 进行通信，更新进程的优先级，如果必要则杀掉进程释放内存。</p>
<p>lmkd 是在 init 进程启动的时候启动的，通过解析 init.rc 文件来启动 lmkd 守护进程。在 lmkd 中有定义 lmkd.rc:</p>
<pre class=" language-rc"><code class="language-rc">service lmkd /system/bin/lmkd
    class core
    group root readproc
    critical
    socket lmkd seqpacket 0660 system system
    writepid /dev/cpuset/system-background/tasks
</code></pre>
<p>lmkd 会创建名为 lmkd 的 socket，节点位于/dev/socket/lmkd，该 socket 用于跟上层 framework 交互。</p>
<p>上层 AMS 跟 lmkd 通信主要分为三种 command，每种 command 代表一种数据控制方式，在 ProcessList 以及 lmkd 中都有定义，ProcessList 文件中的定义必须跟 lmkd.c 定义完全一致，格式如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// LMK_TARGET &lt;minfree> &lt;minkillprio> ... (up to 6 pairs)</span>
<span class="token comment" spellcheck="true">// LMK_PROCPRIO &lt;pid> &lt;uid> &lt;prio></span>
<span class="token comment" spellcheck="true">// LMK_PROCREMOVE &lt;pid></span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_TARGET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_PROCPRIO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> LMK_PROCREMOVE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * Supported LMKD commands
 */</span>
<span class="token keyword">enum</span> lmk_cmd <span class="token punctuation">{</span>
    LMK_TARGET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">/* Associate minfree with oom_adj_score */</span>
    LMK_PROCPRIO<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* Register a process and set its oom_adj_score */</span>
    LMK_PROCREMOVE<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">/* Unregister a process */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>上述3个命令的使用都通过 ProcessList.java 中的如下方法:</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>命令</th>
<th>对应方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>LMK_TARGET</td>
<td>更新 oom_adj</td>
<td>PorcessList.updateOomLevels()</td>
</tr>
<tr>
<td>LMK_PROCPRIO</td>
<td>设置进程 adj</td>
<td>PorcessList.setOomAdj()</td>
</tr>
<tr>
<td>LMK_PROCREMOVE</td>
<td>移除进程</td>
<td>PorcessList.remove()</td>
</tr>
</tbody>
</table>
<p>在开始分析 lmkd 的处理逻辑之前，lmkd.c 中有几个重要的变量与数据结构提前说明一下：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true">// 内存级别限额</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"</span>
<span class="token comment" spellcheck="true">// 不同级别内存对应要杀的的优先级</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_ADJ_PATH "/sys/module/lowmemorykiller/parameters/adj"</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true">/* OOM score values used by both kernel and framework */</span>
<span class="token comment" spellcheck="true">// 优先级的最小值</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OOM_SCORE_ADJ_MIN       (-1000)</span>

<span class="token comment" spellcheck="true">// 优先级的最大值</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OOM_SCORE_ADJ_MAX       1000</span>

<span class="token comment" spellcheck="true">/* A threshold of minfree adjustment toward VMPRESS_LEVEL_CRITICAL (36MB) */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CACHED_THRESHOLD    (9216)</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_adj<span class="token punctuation">[</span>MAX_TARGETS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_minfree<span class="token punctuation">[</span>MAX_TARGETS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> CACHED_THRESHOLD <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_targets_size<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true">// 双向链表结构体</span>
<span class="token keyword">struct</span> adjslot_list <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> adjslot_list <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> adjslot_list <span class="token operator">*</span>prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 进程在 lmkd 中的数据结构体</span>
<span class="token keyword">struct</span> proc <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> adjslot_list asl<span class="token punctuation">;</span>
    <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
    uid_t uid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oomadj<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>pidhash_next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 存放进程 proc 的 hashtable ，index 是通过 pid 的计算得出</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PIDHASH_SZ 1024</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> proc <span class="token operator">*</span>pidhash<span class="token punctuation">[</span>PIDHASH_SZ<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 根据 pid 计算 index 的 hash 算法</span>
<span class="token macro property">#<span class="token directive keyword">define</span> pid_hashfn(x) ((((x) >> 8) ^ (x)) &amp; (PIDHASH_SZ - 1))</span>

<span class="token comment" spellcheck="true">// 进程优先级到数组的 index 之间的转换</span>
<span class="token comment" spellcheck="true">// 因为进程的优先级可以是负值，但是数组的 index 不能为负值</span>
<span class="token comment" spellcheck="true">// 不过因为这个转换只是简单加了 1000，为了方便，后面的描述中就认为是优先级直接做了 index</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ADJTOSLOT(adj) ((adj) + -OOM_SCORE_ADJ_MIN)</span>

<span class="token comment" spellcheck="true">// table，类似 hashtable ，不过计算 index 的方式不是 hash ，而是 oom_score_adj 经过转换后直接作为 index</span>
<span class="token comment" spellcheck="true">// 数组的每个元素都是双向循环链表</span>
<span class="token comment" spellcheck="true">// 进程的优先级作为数组的 index</span>
<span class="token comment" spellcheck="true">// 即以进程的优先级为 index，从 -1000 到 +1000 + 1 大小的数组，根据优先级，同优先级的进程 index 相同</span>
<span class="token comment" spellcheck="true">// 每个元素是一个双向链表，这个链表上的所有 proc 的优先级都相同</span>
<span class="token comment" spellcheck="true">// 这样根据优先级杀进程的时候就会非常方便，要杀指定优先级的进程可以根据优先级获取到一个进程链表，逐个去杀</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> adjslot_list procadjslot_list<span class="token punctuation">[</span><span class="token function">ADJTOSLOT</span><span class="token punctuation">(</span>OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p><strong><font color="#FF0000">接下来我们正式讨论lmkd！</font></strong></p>
<h3 id="5-1-1-main"><a href="#5-1-1-main" class="headerlink" title="5.1.1 main()"></a>5.1.1 main()</h3><p>lmkd 启动后，接下里的操作都在 /system/core/lmkd/lmkd.c 文件，首先进入 main() 方法：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc __unused<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mlockall</span><span class="token punctuation">(</span>MCL_CURRENT <span class="token operator">|</span> MCL_FUTURE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"mlockall failed: errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 设置此线程的调度策略为 SCHED_FIFO，first-in-first-out，param 中主要设置 sched_priority</span>
    <span class="token comment" spellcheck="true">// 由于 SCHED_FIFO 是一种实时调度策略，在这个策略下优先级从1(low) -> 99(high)</span>
    <span class="token comment" spellcheck="true">// 实时线程通常会比普通线程有更高的优先级</span>
    <span class="token function">sched_setscheduler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 初始化 epoll 及与 ActivityManager 的 socket 连接，等待 cmd 和 data</span>
    <span class="token comment" spellcheck="true">// 💥 💥 💥 💥 💥 💥 重点讨论 💥 💥 💥 💥 💥 💥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 进入死循环 epoll_wait 等待fd事件</span>
        <span class="token function">mainloop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 💥 💥 💥 💥 💥 💥 重点讨论 💥 💥 💥 💥 💥 💥</span>

    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>前面已经提到，这个进程存在的主要作用是跟 AMS 进行通信，更新 oomAdj ，在必要的时候杀掉进程。所以在 main 函数中主要就是创建了 epoll 以及初始化 socket 并连接 ActivityManager ，然后阻塞等待上层传递 cmd 以及 data 过来。</p>
<h4 id="5-1-1-1-init"><a href="#5-1-1-1-init" class="headerlink" title="5.1.1.1 init()"></a>5.1.1.1 init()</h4><p>来看看 init 的逻辑：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event epev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    page_k <span class="token operator">=</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>page_k <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        page_k <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>
    page_k <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 创建 epoll 监听文件句柄</span>
    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span>MAX_EPOLL_EVENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>epollfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_create failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 获取 lmkd 的 socket fd</span>
    ctrl_lfd <span class="token operator">=</span> <span class="token function">android_get_control_socket</span><span class="token punctuation">(</span><span class="token string">"lmkd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl_lfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"get lmkd control socket failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 监听 lmkd socket</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>ctrl_lfd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"lmkd control socket listen failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    epev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// ctrl_connect_handler 里面完成了 soclet 的 accpet 以及 read 数据，并对数据进行相应的处理</span>
    <span class="token comment" spellcheck="true">// 💥 💥 💥 💥 💥 💥 下面会重点讨论 💥 💥 💥 💥 💥 💥</span>
    ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_connect_handler<span class="token punctuation">;</span>
    epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> ctrl_sock<span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl for lmkd control socket failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    maxevents<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 该路径是否具有可写的权限</span>
    <span class="token comment" spellcheck="true">/*
     * 这里，通过检验 /sys/module/lowmemorykiller/parameters/minfree 节点是否具有可写权限
     *
     *     #define INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"
     * 
     * 来判断是否使用 kernel 接口来管理 lmk 事件。
     * 默认该节点是具有系统可写的权限，也就意味着 use_inkernel_interface = 1
     */</span>
    has_inkernel_module <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>INKERNEL_MINFREE_PATH<span class="token punctuation">,</span> W_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    use_inkernel_interface <span class="token operator">=</span> has_inkernel_module<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 这个 use_inkernel_interface 是根据是否有 “/sys/module/lowmemorykiller/parameters/minfree” 的写权限来判断的，没有的情况下就使用 kernel 空间的逻辑</span>
    <span class="token comment" spellcheck="true">// 目前遇到的都是 use_inkernel_interface</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Using in-kernel low memory killer interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_LOW<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_MEDIUM<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token function">init_mp_common</span><span class="token punctuation">(</span>VMPRESS_LEVEL_CRITICAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Kernel does not support memory pressure events or in-kernel low memory killer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 双向链表初始化</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token function">ADJTOSLOT</span><span class="token punctuation">(</span>OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>procadjslot_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="5-1-1-2-mainloop"><a href="#5-1-1-2-mainloop" class="headerlink" title="5.1.1.2 mainloop()"></a>5.1.1.2 mainloop()</h4><p>来看看 mainloop 的逻辑：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// 进入死循环，然后调用 epoll_wait 阻塞等待事件的到来</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mainloop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           
        <span class="token keyword">struct</span> epoll_event events<span class="token punctuation">[</span>maxevents<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nevents<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> timespec t1<span class="token punctuation">,</span> t2<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> elapsed_ms<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 等待 epoll_wait 上的事件</span>
        nevents <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> maxevents<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nevents <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_wait failed (errno=%d)"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nevents<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLERR<span class="token punctuation">)</span>
                <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"EPOLLERR on event #%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 当事件到来，则调用 ctrl_connect_handler 方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">)</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>主循环调用 epoll_wait()，等待 epollfd 上的事件，当接收到中断或者不存在事件，则执行 continue 操作。当事件到来，则调用的 ctrl_connect_handler 方法，该方法是由 init() 过程中设定的方法（我们之前在分析 init() 的时候提过）。</p>
<h3 id="5-1-2-ctrl-connect-handler"><a href="#5-1-2-ctrl-connect-handler" class="headerlink" title="5.1.2 ctrl_connect_handler()"></a>5.1.2 ctrl_connect_handler()</h3><p>我们之前在 init() 中看到以下代码：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// ctrl_connect_handler 里面完成了 soclet 的 accpet 以及 read 数据，并对数据进行相应的处理</span>
ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_connect_handler<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 调用 ctrl_connect_handler()</span>
epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>它是专门处理 Socket 传递过来的数据的：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_connect_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> data __unused<span class="token punctuation">,</span> uint32_t events __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> epoll_event epev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> free_dscock_idx <span class="token operator">=</span> <span class="token function">get_free_dsock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>free_dscock_idx <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_DATA_CONN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ctrl_data_close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        free_dscock_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>ctrl_sock<span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"lmkd control socket accept failed; errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"lmkd data connection established"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* use data to store data connection idx */</span>
    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>data <span class="token operator">=</span> free_dscock_idx<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 调用 ctrl_data_handler()</span>
    data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">.</span>handler <span class="token operator">=</span> ctrl_data_handler<span class="token punctuation">;</span>

    epev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
    epev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>handler_info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> data_sock<span class="token punctuation">[</span>free_dscock_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>sock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epev<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl for data connection socket failed; errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ctrl_data_close</span><span class="token punctuation">(</span>free_dscock_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    maxevents<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-1-3-ctrl-data-handler"><a href="#5-1-3-ctrl-data-handler" class="headerlink" title="5.1.3 ctrl_data_handler"></a>5.1.3 ctrl_data_handler</h3><p>当事件触发，则调用 ctrl_data_handler()：</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_data_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">,</span> uint32_t events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ctrl_command_handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-1-4-ctrl-command-handler"><a href="#5-1-4-ctrl-command-handler" class="headerlink" title="5.1.4 ctrl_command_handler"></a>5.1.4 ctrl_command_handler</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrl_command_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> dsock_idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    LMKD_CTRL_PACKET packet<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> lmk_cmd cmd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nargs<span class="token punctuation">;</span>
    <span class="token keyword">int</span> targets<span class="token punctuation">;</span>

    len <span class="token operator">=</span> <span class="token function">ctrl_data_read</span><span class="token punctuation">(</span>dsock_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>packet<span class="token punctuation">,</span> CTRL_PACKET_MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Wrong control socket read length len=%d"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cmd <span class="token operator">=</span> <span class="token function">lmkd_pack_get_cmd</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nargs <span class="token operator">=</span> len <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 将网络字节顺序转换为主机字节顺序</span>
    cmd <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>ibuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 一共三种command</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 更新内存级别以及对应级别的进程 adj</span>
    <span class="token keyword">case</span> LMK_TARGET<span class="token operator">:</span>
        targets <span class="token operator">=</span> nargs <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">&amp;</span> <span class="token number">0x1</span> <span class="token operator">||</span> targets <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>
        <span class="token function">cmd_target</span><span class="token punctuation">(</span>targets<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 根据 pid 更新 adj</span>
    <span class="token keyword">case</span> LMK_PROCPRIO<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 💥 💥 💥 💥 💥 💥 下面会重点讨论 💥 💥 💥 💥 💥 💥</span>
        <span class="token function">cmd_procprio</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 根据 pid 移除 proc</span>
    <span class="token keyword">case</span> LMK_PROCREMOVE<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nargs <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> wronglen<span class="token punctuation">;</span>
        <span class="token function">cmd_procremove</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Received unknown command code %d"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>

wronglen<span class="token operator">:</span>
    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Wrong control socket read length cmd=%d len=%d"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>获取 framework 传递过来的 buf 数据后，根据 3 种不同的命令，进入不同的分支，我们分别看下：</p>
<h2 id="5-2-三种数据"><a href="#5-2-三种数据" class="headerlink" title="5.2 三种数据"></a>5.2 三种数据</h2><h3 id="5-2-1-LMK-TARGET"><a href="#5-2-1-LMK-TARGET" class="headerlink" title="5.2.1 LMK_TARGET"></a>5.2.1 LMK_TARGET</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 上层逻辑是在 ProcessList.updateOomLevels 中</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateOomLevels</span><span class="token punctuation">(</span><span class="token keyword">int</span> displayWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> displayHeight<span class="token punctuation">,</span> <span class="token keyword">boolean</span> write<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mOomAdj<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_TARGET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>mOomAdj<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mOomMinFree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token operator">/</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>mOomAdj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        SystemProperties<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"sys.sysctl.extra_free_kbytes"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>reserve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd 处理逻辑</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_MINFREE_PATH "/sys/module/lowmemorykiller/parameters/minfree"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INKERNEL_ADJ_PATH "/sys/module/lowmemorykiller/parameters/adj"</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_target</span><span class="token punctuation">(</span><span class="token keyword">int</span> ntargets<span class="token punctuation">,</span> LMKD_CTRL_PACKET packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> lmk_target target<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ntargets <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 这个 for 循环对应上面的 for 循环，将数据读出装进数组中</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ntargets<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lmkd_pack_get_target</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>minfree<span class="token punctuation">;</span>
        lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>oom_adj_score<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    lowmem_targets_size <span class="token operator">=</span> ntargets<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 使用 kernel 空间的处理逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>has_inkernel_module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> minfreestr<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> killpriostr<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        minfreestr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        killpriostr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 取出两个数组中的数据，以","分隔，分别拼接成 string</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lowmem_targets_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">strlcat</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strlcat</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> use_inkernel_interface <span class="token operator">?</span> lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strlcat</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>minfreestr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> use_inkernel_interface <span class="token operator">?</span> lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strlcat</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>killpriostr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 将生成好的 string 写入到文件节点 minfree 以及 adj</span>
        <span class="token function">writefilestring</span><span class="token punctuation">(</span>INKERNEL_MINFREE_PATH<span class="token punctuation">,</span> minfreestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writefilestring</span><span class="token punctuation">(</span>INKERNEL_ADJ_PATH<span class="token punctuation">,</span> killpriostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上面的处理逻辑主要是：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;1. 按照顺序取出数据，装进 lmkd 的数组中。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;2. 分别将两个数组中的数取出，用”,”分隔。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;3. lowmem_minfree 中的数据拼成的 string 写到 “/sys/module/lowmemorykiller/parameters/minfree”。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;4. lowmem_adj 中的数据拼成的 string 写到 “/sys/module/lowmemorykiller/parameters/adj”。</p>
<h3 id="5-2-2-LMK-PROCPRIO"><a href="#5-2-2-LMK-PROCPRIO" class="headerlink" title="5.2.2 LMK_PROCPRIO"></a>5.2.2 LMK_PROCPRIO</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 上层逻辑是在 ProcessList.setOomAdj 中</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setOomAdj</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> amt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// This indicates that the process is not started yet and so no need to proceed further.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>amt <span class="token operator">==</span> UNKNOWN_ADJ<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> start <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_PROCPRIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>amt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 将 16Byte 字节写入 socket，buf 大小为 16 个字节</span>
    <span class="token comment" spellcheck="true">// 依次写入 LMK_PROCPRIO(命令类型), pid(进程pid), uid(进程uid), amt(目标adj)，将这些字节通过 socket 发送给 lmkd.</span>
    <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>now<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">250</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"ActivityManager"</span><span class="token punctuation">,</span> <span class="token string">"SLOW OOM ADJ: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms for pid "</span> <span class="token operator">+</span> pid <span class="token operator">+</span> <span class="token string">" = "</span> <span class="token operator">+</span> amt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd 处理逻辑</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_procprio</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> oomadj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> path<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> soft_limit_mult<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> lmk_procprio params<span class="token punctuation">;</span>

    <span class="token function">lmkd_pack_get_procprio</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oomadj <span class="token operator">&lt;</span> OOM_SCORE_ADJ_MIN <span class="token operator">||</span> oomadj <span class="token operator">></span> OOM_SCORE_ADJ_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Invalid PROCPRIO oomadj argument %d"</span><span class="token punctuation">,</span> oomadj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// LMK_PROCPRIO 的主要作用就是更新进程的 oomAdj</span>
    <span class="token comment" spellcheck="true">// 将上层传递过来的数据（pid以及优先级）写到该进程对应的文件节点：/proc/pid/oom_score_adj</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/proc/%d/oom_score_adj"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> oomadj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 向节点 /proc/&lt;pid>/oom_score_adj 写入 oomAdj</span>
    <span class="token function">writefilestring</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果使用 kernel 的逻辑，则 return</span>
    <span class="token comment" spellcheck="true">// 即这个 command 传递过来只是更新了对应文件节点的 oom_score_adj</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>low_ram_device<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">900</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">800</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">700</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Launcher should be perceptible, don't kill it.</span>
            params<span class="token punctuation">.</span>oomadj <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>oomadj <span class="token operator">>=</span>   <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Persistent processes will have a large</span>
            <span class="token comment" spellcheck="true">// soft limit 512MB.</span>
            soft_limit_mult <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">snprintf</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token string">"/dev/memcg/apps/uid_%d/pid_%d/memory.soft_limit_in_bytes"</span><span class="token punctuation">,</span>
             params<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> soft_limit_mult <span class="token operator">*</span> EIGHT_MEGA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writefilestring</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 从 hashtable 中查找 proc</span>
    procp <span class="token operator">=</span> <span class="token function">pid_lookup</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果没有查找到，也就是说这个进程是新创建的，lmkd 维护的数据结构中还没有这个 proc，因此需要新建并添加到 hashtable 中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            procp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> proc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Oh, the irony.  May need to rebuild our state.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">=</span> params<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
            procp<span class="token operator">-</span><span class="token operator">></span>uid <span class="token operator">=</span> params<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
            procp<span class="token operator">-</span><span class="token operator">></span>oomadj <span class="token operator">=</span> params<span class="token punctuation">.</span>oomadj<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将 proc 插入到 lmkd 中的数据结构中，主要包括两个数据结构</span>
            <span class="token comment" spellcheck="true">// 更新 hashtable，通过 pid 计算 hash 值，然后存储，解决冲突是让新来的作为数组元素链表的头结点</span>
            <span class="token comment" spellcheck="true">// 优先级为 index 的双向链表组成的 table</span>
            <span class="token function">proc_insert</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// hashtable 中已经有这个 proc</span>
        <span class="token comment" spellcheck="true">// 但是因为优先级的变化，需要先把这个 proc 从原先的优先级 table 中对应位置的双向链表中 remove</span>
        <span class="token comment" spellcheck="true">// 然后新加到新的优先级对应的双向链表中</span>
        <span class="token comment" spellcheck="true">// 双向链表的添加是新来的放在头部</span>
        <span class="token function">proc_unslot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        procp<span class="token operator">-</span><span class="token operator">></span>oomadj <span class="token operator">=</span> params<span class="token punctuation">.</span>oomadj<span class="token punctuation">;</span>
        <span class="token function">proc_slot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 其中 pid_lookup：查询 hashtable，因为进程的 pid 是唯一的，然后从中取出该 pid 在 lmkd 中的 proc 结构体</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> proc <span class="token operator">*</span><span class="token function">pid_lookup</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>procp <span class="token operator">=</span> pidhash<span class="token punctuation">[</span><span class="token function">pid_hashfn</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> procp <span class="token operator">&amp;&amp;</span> procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">!=</span> pid<span class="token punctuation">;</span>
         procp <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">)</span>
            <span class="token punctuation">;</span>

    <span class="token keyword">return</span> procp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-2-3-LMK-PROCREMOVE"><a href="#5-2-3-LMK-PROCREMOVE" class="headerlink" title="5.2.3 LMK_PROCREMOVE"></a>5.2.3 LMK_PROCREMOVE</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 上层处理逻辑在 ProcessList.remove 中</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// This indicates that the process is not started yet and so no need to proceed further.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ByteBuffer buf <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>LMK_PROCREMOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writeLmkd</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// lmkd 处理逻辑</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_procremove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> lmk_procremove params<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果使用 kernel 接口，return</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>use_inkernel_interface<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token function">lmkd_pack_get_procremove</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 更新数据结构，pid 的 hashtable 以及进程优先级的双向链表 table</span>
    <span class="token function">pid_remove</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pid_remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> hval <span class="token operator">=</span> <span class="token function">pid_hashfn</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>procp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> proc <span class="token operator">*</span>prevp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>procp <span class="token operator">=</span> pidhash<span class="token punctuation">[</span>hval<span class="token punctuation">]</span><span class="token punctuation">,</span> prevp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> procp <span class="token operator">&amp;&amp;</span> procp<span class="token operator">-</span><span class="token operator">></span>pid <span class="token operator">!=</span> pid<span class="token punctuation">;</span>
         procp <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">)</span>
            prevp <span class="token operator">=</span> procp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>procp<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevp<span class="token punctuation">)</span>
        pidhash<span class="token punctuation">[</span>hval<span class="token punctuation">]</span> <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        prevp<span class="token operator">-</span><span class="token operator">></span>pidhash_next <span class="token operator">=</span> procp<span class="token operator">-</span><span class="token operator">></span>pidhash_next<span class="token punctuation">;</span>

    <span class="token function">proc_unslot</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>procp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>从上面的处理逻辑就能看出来，三种 command 的处理逻辑中都对 use_inkernel_interface 的情况下做了特殊处理，在 use_inkernel_interface 的情况下，做的事情都是很简单的，只是更新一下文件节点。如果不使用 kernel interface，就需要 lmkd 自己维护两个 table，在每次更新 adj 的时候去更新 table。 且在初始化的时候也能看到，如果不使用 kernel 的 lowmemorykiller，则需要 lmkd 自己获取手机内存状态，如果匹配到了 minfree 中的等级，则需要通过杀掉一些进程释放内存。</p>
<p>在三种数据的代码分析中，我们都看到了 writeLmkd 函数，接下来简单看下！</p>
<h3 id="5-2-4-writeLmkd"><a href="#5-2-4-writeLmkd" class="headerlink" title="5.2.4 writeLmkd"></a>5.2.4 writeLmkd</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeLmkd</span><span class="token punctuation">(</span>ByteBuffer buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 当 socket 打开失败会尝试 3 次</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sLmkdSocket <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 打开 socket</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">openLmkdSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            将 buf 信息写入 lmkd socket
            sLmkdOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error writing to lowmemorykiller socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                sLmkdSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

            sLmkdSocket <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>查看打开 socket 的函数：</p>
<h3 id="5-2-5-openLmkdSocket"><a href="#5-2-5-openLmkdSocket" class="headerlink" title="5.2.5 openLmkdSocket"></a>5.2.5 openLmkdSocket</h3><pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">openLmkdSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            sLmkdSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocket</span><span class="token punctuation">(</span>LocalSocket<span class="token punctuation">.</span>SOCKET_SEQPACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 与远程 lmkd 守护进程建立 socket 连接</span>
            sLmkdSocket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">LocalSocketAddress</span><span class="token punctuation">(</span><span class="token string">"lmkd"</span><span class="token punctuation">,</span>
                        LocalSocketAddress<span class="token punctuation">.</span>Namespace<span class="token punctuation">.</span>RESERVED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sLmkdOutputStream <span class="token operator">=</span> sLmkdSocket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"lowmemorykiller daemon socket open failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sLmkdSocket <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>该方法是打开一个名为 lmkd 的 socket，类型为 LocalSocket.SOCKET_SEQPACKET，这只是一个封装，真实类型就是 SOCK_SEQPACKET。先跟远程 lmkd 守护进程建立连接，再向其通过 write() 将数据写入该 socket，再接下来进入 lmkd 过程。</p>
<h2 id="5-3-Kernel"><a href="#5-3-Kernel" class="headerlink" title="5.3 Kernel"></a>5.3 Kernel</h2><p>前面提过，<strong><font color="#FF0000">大多情况其实是使用 kernel interface 的，其实也就是 kernel 中的 lowmemorykiller</font></strong>。</p>
<p>lowmemorykiller driver 位于 kernel-x.xx/drivers/staging/android/lowmemorykiller.c。</p>
<p>lowmemorykiller 中是通过 linux 的 shrinker 实现的，这个是 linux 的内存回收机制的一种，由内核线程 kswapd 负责监控，在 lowmemorykiller 初始化的时候注册 register_shrinker。</p>
<h3 id="5-3-1-lowmemorykiller-初始化"><a href="#5-3-1-lowmemorykiller-初始化" class="headerlink" title="5.3.1 lowmemorykiller 初始化"></a>5.3.1 lowmemorykiller 初始化</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> shrinker lowmem_shrinker <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>scan_objects <span class="token operator">=</span> lowmem_scan<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>count_objects <span class="token operator">=</span> lowmem_count<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>seeks <span class="token operator">=</span> DEFAULT_SEEKS <span class="token operator">*</span> <span class="token number">16</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">lowmem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">register_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 初始化</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">lowmem_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">unregister_shrinker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrinker<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 退出</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过 register_shrinker 和 unregister_shrinker 分别用于初始化和退出。</p>
<h3 id="5-3-2-minfree-min-adj"><a href="#5-3-2-minfree-min-adj" class="headerlink" title="5.3.2 minfree/min_adj"></a>5.3.2 minfree/min_adj</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// 下面两个数组分别代表了两个参数文件中的默认值，数组默认的 size 都是 9</span>
<span class="token comment" spellcheck="true">// 对应 "/sys/module/lowmemorykiller/parameters/adj"</span>
<span class="token keyword">static</span> <span class="token keyword">short</span> lowmem_adj<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token number">12</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 对应 "/sys/module/lowmemorykiller/parameters/minfree"</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_adj_size <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> lowmem_minfree<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">512</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 6MB */</span>
    <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 8MB */</span>
    <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 16MB */</span>
    <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* 64MB */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> lowmem_minfree_size <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="5-3-3-shrinker"><a href="#5-3-3-shrinker" class="headerlink" title="5.3.3 shrinker"></a>5.3.3 shrinker</h3><p>当内存不足时 kswapd 线程会遍历一张 shrinker 链表，并回调已注册的 shrinker 函数来回收内存 page，kswapd 还会周期性唤醒来执行内存操作。每个 zone 维护 active_list 和 inactive_list 链表，内核根据页面活动状态将 page 在这两个链表之间移动，最终通过 shrink_slab 和 shrink_zone 来回收内存页，有兴趣想进一步了解 linux 内存回收机制，可自行研究。</p>
<h3 id="5-3-4-lowmem-count"><a href="#5-3-4-lowmem-count" class="headerlink" title="5.3.4 lowmem_count"></a>5.3.4 lowmem_count</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">lowmem_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> shrinker <span class="token operator">*</span>s<span class="token punctuation">,</span>
                  <span class="token keyword">struct</span> shrink_control <span class="token operator">*</span>sc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment" spellcheck="true">// ANON代表匿名映射，没有后备存储器；</span>
  <span class="token comment" spellcheck="true">// FILE 代表文件映射； 内存计算公式 = 活动匿名内存 + 活动文件内存 + 不活动匿名内存 + 不活动文件内存</span>
  <span class="token keyword">return</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_ACTIVE_ANON<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_ACTIVE_FILE<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_INACTIVE_ANON<span class="token punctuation">)</span> <span class="token operator">+</span>
           <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_INACTIVE_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-3-5-lowmem-scan"><a href="#5-3-5-lowmem-scan" class="headerlink" title="5.3.5 lowmem_scan"></a>5.3.5 lowmem_scan</h3><p>当触发 lmkd，则先杀 oom_score_adj 最大的进程，当 oom_adj 相等时，则选择 rss 最大的进程。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> unsigned <span class="token keyword">long</span> <span class="token function">lowmem_scan</span><span class="token punctuation">(</span>struct shrinker <span class="token operator">*</span>s<span class="token punctuation">,</span> struct shrink_control <span class="token operator">*</span>sc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct task_struct <span class="token operator">*</span>tsk<span class="token punctuation">;</span>
    struct task_struct <span class="token operator">*</span>selected <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
    unsigned <span class="token keyword">long</span> rem <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tasksize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">short</span> min_score_adj <span class="token operator">=</span> OOM_SCORE_ADJ_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> minfree <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> selected_tasksize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">short</span> selected_oom_score_adj<span class="token punctuation">;</span>
    <span class="token keyword">int</span> array_size <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>lowmem_adj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 获取当前剩余内存大小</span>
    <span class="token keyword">int</span> other_free <span class="token operator">=</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_FREE_PAGES<span class="token punctuation">)</span> <span class="token operator">-</span> totalreserve_pages<span class="token punctuation">;</span>
    <span class="token keyword">int</span> other_file <span class="token operator">=</span> <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_FILE_PAGES<span class="token punctuation">)</span> <span class="token operator">-</span>
                        <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_SHMEM<span class="token punctuation">)</span> <span class="token operator">-</span>
                        <span class="token function">global_page_state</span><span class="token punctuation">(</span>NR_UNEVICTABLE<span class="token punctuation">)</span> <span class="token operator">-</span>
                        <span class="token function">total_swapcache_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 获取数组大小</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lowmem_adj_size <span class="token operator">&lt;</span> array_size<span class="token punctuation">)</span>
        array_size <span class="token operator">=</span> lowmem_adj_size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lowmem_minfree_size <span class="token operator">&lt;</span> array_size<span class="token punctuation">)</span>
        array_size <span class="token operator">=</span> lowmem_minfree_size<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 遍历 lowmem_minfree 数组找出相应的最小 adj 值</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        minfree <span class="token operator">=</span> lowmem_minfree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>other_free <span class="token operator">&lt;</span> minfree <span class="token operator">&amp;&amp;</span> other_file <span class="token operator">&lt;</span> minfree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            min_score_adj <span class="token operator">=</span> lowmem_adj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>min_score_adj <span class="token operator">==</span> OOM_SCORE_ADJ_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    selected_oom_score_adj <span class="token operator">=</span> min_score_adj<span class="token punctuation">;</span>


    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">for_each_process</span><span class="token punctuation">(</span>tsk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        struct task_struct <span class="token operator">*</span>p<span class="token punctuation">;</span>
        <span class="token keyword">short</span> oom_score_adj<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tsk<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> PF_KTHREAD<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        p <span class="token operator">=</span> <span class="token function">find_lock_task_mm</span><span class="token punctuation">(</span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_tsk_thread_flag</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> TIF_MEMDIE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">time_before_eq</span><span class="token punctuation">(</span>jiffies<span class="token punctuation">,</span> lowmem_deathpending_timeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrink_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> SHRINK_STOP<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        oom_score_adj <span class="token operator">=</span> p<span class="token operator">-</span><span class="token operator">></span>signal<span class="token operator">-</span><span class="token operator">></span>oom_score_adj<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 小于目标adj的进程，则忽略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">&lt;</span> min_score_adj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 获取的是进程的 Resident Set Size，也就是进程独占内存 + 共享库大小</span>
        tasksize <span class="token operator">=</span> <span class="token function">get_mm_rss</span><span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token operator">></span>mm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">task_unlock</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tasksize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 算法关键，选择 oom_score_adj 最大的进程中，并且 rss 内存最大的进程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">&lt;</span> selected_oom_score_adj<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oom_score_adj <span class="token operator">==</span> selected_oom_score_adj <span class="token operator">&amp;&amp;</span>
                tasksize <span class="token operator">&lt;=</span> selected_tasksize<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        selected <span class="token operator">=</span> p<span class="token punctuation">;</span>
        selected_tasksize <span class="token operator">=</span> tasksize<span class="token punctuation">;</span>
        selected_oom_score_adj <span class="token operator">=</span> oom_score_adj<span class="token punctuation">;</span>
        <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"select '%s' (%d), adj %d, score_adj %hd, size %d, to kill\n"</span><span class="token punctuation">,</span>
                 p<span class="token operator">-</span><span class="token operator">></span>comm<span class="token punctuation">,</span> p<span class="token operator">-</span><span class="token operator">></span>pid<span class="token punctuation">,</span> <span class="token function">REVERT_ADJ</span><span class="token punctuation">(</span>oom_score_adj<span class="token punctuation">)</span><span class="token punctuation">,</span> oom_score_adj<span class="token punctuation">,</span> tasksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> cache_size <span class="token operator">=</span> other_file <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> cache_limit <span class="token operator">=</span> minfree <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> free <span class="token operator">=</span> other_free <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PAGE_SIZE <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">trace_lowmemory_kill</span><span class="token punctuation">(</span>selected<span class="token punctuation">,</span> cache_size<span class="token punctuation">,</span> cache_limit<span class="token punctuation">,</span> free<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 输出 kill 的 log</span>
        <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Killing '%s' (%d), adj %d, score_adj %hd, state(%ld)\n"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lowmem_deathpending_timeout <span class="token operator">=</span> jiffies <span class="token operator">+</span> LOWMEM_DEATHPENDING_TIMEOUT<span class="token punctuation">;</span>
        <span class="token function">set_tsk_thread_flag</span><span class="token punctuation">(</span>selected<span class="token punctuation">,</span> TIF_MEMDIE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 向选中的目标进程发送 signal 9 来杀掉目标进程</span>
        <span class="token function">send_sig</span><span class="token punctuation">(</span>SIGKILL<span class="token punctuation">,</span> selected<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rem <span class="token operator">+=</span> selected_tasksize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d_state_is_found <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"No selected (full of D-state processes at %d)\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>min_score_adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">lowmem_print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"lowmem_scan %lu, %x, return %lu\n"</span><span class="token punctuation">,</span>
             sc<span class="token operator">-</span><span class="token operator">></span>nr_to_scan<span class="token punctuation">,</span> sc<span class="token operator">-</span><span class="token operator">></span>gfp_mask<span class="token punctuation">,</span> rem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowmem_shrink_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当如下节点数据发送变化时，会通过修改 lowmem_minfree[ ] 和 lowmem_adj[ ] 数组：</p>
<pre><code>/sys/module/lowmemorykiller/parameters/minfree
/sys/module/lowmemorykiller/parameters/adj
</code></pre><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文主要讨论 frameworks 的 ProcessList.java 调整 adj，通过 socket 通信将事件发送给 native 的守护进程 lmkd；lmkd 再根据具体的命令来执行相应操作，其主要功能 更新进程的 oom_score_adj 值以及 lowmemorykiller 驱动的 parameters (包括 minfree 和 adj )；</p>
<p>最后讲到了 lowmemorykiller 驱动，通过注册 shrinker，借助 linux 标准的内存回收机制，根据当前系统可用内存以及 parameters 配置参数( adj , minfree )来选取合适的 selected_oom_score_adj，再从所有进程中选择 adj 大于该目标值的并且占用 rss 内存最大的进程，将其杀掉，从而释放出内存。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>&nbsp;01. <a href="http://gityuan.com/2016/09/17/android-lowmemorykiller/" target="_blank" rel="noopener">http://gityuan.com/2016/09/17/android-lowmemorykiller/</a><br>&nbsp;02. <a href="https://blog.csdn.net/u011733869/article/details/78820240" target="_blank" rel="noopener">https://blog.csdn.net/u011733869/article/details/78820240</a><br>&nbsp;03. <a href="https://blog.csdn.net/su749520/article/details/78595367" target="_blank" rel="noopener">https://blog.csdn.net/su749520/article/details/78595367</a><br>&nbsp;04. <a href="http://gityuan.com/2018/05/19/android-process-adj/" target="_blank" rel="noopener">http://gityuan.com/2018/05/19/android-process-adj/</a></p>
<h1 id="索引链接"><a href="#索引链接" class="headerlink" title="索引链接"></a>索引链接</h1><p>推荐跳转：<a href="https://superandroid.pro/2019/01/01/00.%20Thinking%20in%20Android%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">博客索引（Android 9.0）</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/05/01/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhu-zhi-lowmemorykiller/" class="b-link-green">聊聊 LowMemoryKiller 机制</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/05/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-yuan-li-zhi-jin-cheng-bei-sha/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/杀进程.jpg" class="responsive-img" alt="“进程被杀”的前因后果">
                        
                        <span class="card-title">“进程被杀”的前因后果</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">一、开篇1.1 核心源码


关键类
路径




Process.java
frameworks/base/core/java/android/os/Process.java


android_util_Process.cpp
fram</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/核心机制/" class="post-category" target="_blank">
                                    核心机制
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Process/" target="_blank">
                        <span class="chip bg-color">Process</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/04/20/04.he-xin-ji-zhi-xi-lie-shen-ru-yan-jiu-android-he-xin-ji-zhi-zhi-handler-yuan-li-pian/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/Handler.jpg" class="responsive-img" alt="关于 Handler 机制（原理）">
                        
                        <span class="card-title">关于 Handler 机制（原理）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">1. 开篇1.1 核心源码


关键类
路径




Looper.java
frameworks/base/core/java/android/os/Looper.java


Message.java
frameworks/base/c</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-04-20
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/核心机制/" class="post-category" target="_blank">
                                    核心机制
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Handler/" target="_blank">
                        <span class="chip bg-color">Handler</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Thinking in Android<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    

</main>


<footer class="page-footer bg-color-foot-marco">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


<!--
    <a href="https://blog.csdn.net/pepsimaxin" class="tooltipped" data-tooltip="访问我的CSDN" data-position="top" data-delay="50">
        <i class="fa fa-chain-broken"></i>
    </a>
-->


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<!--<div class="progress-bar"></div>-->

<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;检索博文</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的技术关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<!--<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>-->


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>