<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="è°ˆè°ˆ ANR ä¹‹ Input è¶…æ—¶, Hexo">
    <meta name="description" content="1. æ ¸å¿ƒæºç 


å…³é”®ç±»
è·¯å¾„ï¼ˆ/frameworks/base/ï¼‰




ActiveServices.java
services/core/java/com/android/server/am/ActiveServices.java">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è°ˆè°ˆ ANR ä¹‹ Input è¶…æ—¶ | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>é¦–é¡µ</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>ç›®å½•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>æ ‡ç­¾</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>ç»„ä»¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å¯åŠ¨é˜¶æ®µ/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>å¼€æœº</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>æ¡†æ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>æœºåˆ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>ä¼˜åŒ–</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>æ¨¡å¼</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>ç®—æ³•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>æ‹“å±•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>ä½œè€…</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="æ£€ç´¢åšæ–‡"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                é¦–é¡µ
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                ç›®å½•
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                æ ‡ç­¾
            </a>
        </li>
        
        <li>
            <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                ç»„ä»¶
            </a>
        </li>
        
        <li>
            <a href="/categories/å¯åŠ¨é˜¶æ®µ/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                å¼€æœº
            </a>
        </li>
        
        <li>
            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                æ¡†æ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                æœºåˆ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                ä¼˜åŒ–
            </a>
        </li>
        
        <li>
            <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                æ¨¡å¼
            </a>
        </li>
        
        <li>
            <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                ç®—æ³•
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                æ‹“å±•
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                ä½œè€…
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/ANR-02.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        è°ˆè°ˆ ANR ä¹‹ Input è¶…æ—¶
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/æ€§èƒ½ä¼˜åŒ–/" target="_blank">
                                <span class="chip bg-color">æ€§èƒ½ä¼˜åŒ–</span>
                            </a>
                        
                            <a href="/tags/ANR/" target="_blank">
                                <span class="chip bg-color">ANR</span>
                            </a>
                        
                            <a href="/tags/æ— å“åº”/" target="_blank">
                                <span class="chip bg-color">æ— å“åº”</span>
                            </a>
                        
                            <a href="/tags/Input/" target="_blank">
                                <span class="chip bg-color">Input</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="post-category" target="_blank">
                                æ€§èƒ½ä¼˜åŒ–
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;å‘å¸ƒæ—¥æœŸ :&nbsp;
                    2019-05-26
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;æ–‡ç« å­—æ•° :&nbsp;
                        4k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;é˜…è¯»æ—¶é•¿ :&nbsp;
                        15 åˆ†é’Ÿ
                    </div>
                    
                
				
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1-æ ¸å¿ƒæºç "><a href="#1-æ ¸å¿ƒæºç " class="headerlink" title="1. æ ¸å¿ƒæºç "></a>1. æ ¸å¿ƒæºç </h1><table>
<thead>
<tr>
<th>å…³é”®ç±»</th>
<th>è·¯å¾„ï¼ˆ/frameworks/base/ï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">ActiveServices.java</font></td>
<td>services/core/java/com/android/server/am/ActiveServices.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ActivityManagerService.java</font></td>
<td>services/core/java/com/android/server/am/ActivityManagerService.java</td>
</tr>
<tr>
<td><font color="#D15FEE">AppErrors.java</font></td>
<td>services/core/java/com/android/server/am/AppErrors.java</td>
</tr>
<tr>
<td><font color="#D15FEE">BroadcastQueue.java</font></td>
<td>services/core/java/com/android/server/am/BroadcastQueue.java</td>
</tr>
</tbody>
</table>
<p><br></p>
<hr>
<h1 id="2-ANR-åŸºç¡€è®¤çŸ¥"><a href="#2-ANR-åŸºç¡€è®¤çŸ¥" class="headerlink" title="2. ANR åŸºç¡€è®¤çŸ¥"></a>2. ANR åŸºç¡€è®¤çŸ¥</h1><h2 id="2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-1-ANR-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2.1 ANR æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><strong><font color="#FF00FF">ANR(Application Not Responding)</font></strong>ï¼Œåº”ç”¨ç¨‹åºæ— å“åº”ï¼Œç®€å•ä¸€ä¸ªå®šä¹‰ï¼Œå´æ¶µç›–äº†å¾ˆå¤š Android ç³»ç»Ÿçš„è®¾è®¡æ€æƒ³ã€‚</p>
<p>é¦–å…ˆï¼Œ<font color="#0000FF">ANR å±äºåº”ç”¨ç¨‹åºçš„èŒƒç•´</font>ï¼Œè¿™ä¸åŒäº SNR(System Not Respoding)ï¼ŒSNR åæ˜ çš„é—®é¢˜æ˜¯ç³»ç»Ÿè¿›ç¨‹(system_server)å¤±å»äº†å“åº”èƒ½åŠ›ï¼Œè€Œ ANR æ˜ç¡®å°†é—®é¢˜åœˆå®šåœ¨åº”ç”¨ç¨‹åºã€‚<strong><code>SNR ç”± Watchdog æœºåˆ¶ä¿è¯ï¼ŒANR ç”±æ¶ˆæ¯å¤„ç†æœºåˆ¶ä¿è¯</code></strong>ï¼ŒAndroid åœ¨ç³»ç»Ÿå±‚å®ç°äº†ä¸€å¥—ç²¾å¯†çš„æœºåˆ¶æ¥å‘ç° ANRï¼Œæ ¸å¿ƒåŸç†æ˜¯<strong><code>æ¶ˆæ¯è°ƒåº¦</code></strong>å’Œ<strong><code>è¶…æ—¶å¤„ç†</code></strong>ã€‚</p>
<p>å…¶æ¬¡ï¼ŒANR æœºåˆ¶<strong><code>ä¸»ä½“å®ç°åœ¨ç³»ç»Ÿå±‚</code></strong>ã€‚æ‰€æœ‰ä¸ ANR ç›¸å…³çš„æ¶ˆæ¯ï¼Œéƒ½ä¼šç»è¿‡ç³»ç»Ÿè¿›ç¨‹(system_server)è°ƒåº¦ï¼Œç„¶åæ´¾å‘åˆ°åº”ç”¨è¿›ç¨‹å®Œæˆå¯¹æ¶ˆæ¯çš„å®é™…å¤„ç†ï¼ŒåŒæ—¶ï¼Œç³»ç»Ÿè¿›ç¨‹è®¾è®¡äº†ä¸åŒçš„è¶…æ—¶é™åˆ¶æ¥è·Ÿè¸ªæ¶ˆæ¯çš„å¤„ç†ã€‚ä¸€æ—¦åº”ç”¨ç¨‹åºå¤„ç†æ¶ˆæ¯ä¸å½“ï¼Œè¶…æ—¶é™åˆ¶å°±èµ·ä½œç”¨äº†ï¼Œå®ƒæ”¶é›†ä¸€äº›ç³»ç»ŸçŠ¶æ€ï¼Œä¾‹å¦‚ï¼šCPU/IOä½¿ç”¨æƒ…å†µã€è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆï¼Œå¹¶ä¸”æŠ¥å‘Šç”¨æˆ·æœ‰è¿›ç¨‹<strong><code>æ— å“åº”äº†ï¼ˆANR å¯¹è¯æ¡†ï¼‰</code></strong>ã€‚</p>
<p>ç„¶åï¼ŒANR é—®é¢˜<strong><code>æœ¬è´¨æ˜¯ä¸€ä¸ªæ€§èƒ½é—®é¢˜</code></strong>ã€‚ANR æœºåˆ¶å®é™…ä¸Šå¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„é™åˆ¶ï¼Œè¦æ±‚ä¸»çº¿ç¨‹åœ¨é™å®šçš„æ—¶é—´å†…å¤„ç†å®Œä¸€äº›æœ€å¸¸è§çš„æ“ä½œ(å¯åŠ¨æœåŠ¡ã€å¤„ç†å¹¿æ’­ã€å¤„ç†è¾“å…¥)ï¼Œå¦‚æœå¤„ç†è¶…æ—¶ï¼Œåˆ™è®¤ä¸ºä¸»çº¿ç¨‹å·²ç»å¤±å»äº†å“åº”å…¶ä»–æ“ä½œçš„èƒ½åŠ›ã€‚ä¸»çº¿ç¨‹ä¸­çš„<strong><code>è€—æ—¶æ“ä½œ</code></strong>ï¼Œä¾‹å¦‚ï¼šå¯†é›†CPUè¿ç®—ã€å¤§é‡IOã€å¤æ‚ç•Œé¢å¸ƒå±€ç­‰ï¼Œéƒ½ä¼šé™ä½åº”ç”¨ç¨‹åºçš„å“åº”èƒ½åŠ›ã€‚</p>
<p>æœ€åï¼Œéƒ¨åˆ† ANR é—®é¢˜æ˜¯å¾ˆéš¾åˆ†æçš„ï¼Œæœ‰æ—¶å€™ç”±äºç³»ç»Ÿåº•å±‚çš„ä¸€äº›å½±å“ï¼Œå¯¼è‡´æ¶ˆæ¯è°ƒåº¦å¤±è´¥ï¼Œå‡ºç°é—®é¢˜çš„åœºæ™¯åˆéš¾ä»¥å¤ç°ã€‚è¿™ç±» ANR é—®é¢˜å¾€å¾€éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´å»äº†è§£ç³»ç»Ÿçš„ä¸€äº›è¡Œä¸ºï¼Œè¶…å‡ºäº† ANR æœºåˆ¶æœ¬èº«çš„èŒƒç•´ã€‚</p>
<h2 id="2-2-ANR-æœºåˆ¶"><a href="#2-2-ANR-æœºåˆ¶" class="headerlink" title="2.2 ANR æœºåˆ¶"></a>2.2 ANR æœºåˆ¶</h2><p>åˆ†æä¸€äº›åˆçº§çš„ ANR é—®é¢˜ï¼Œåªéœ€è¦ç®€å•ç†è§£æœ€ç»ˆè¾“å‡ºçš„æ—¥å¿—å³å¯ï¼Œä½†å¯¹äºä¸€äº›ç”±ç³»ç»Ÿé—®é¢˜(ä¾‹å¦‚ï¼šCPU è´Ÿè½½è¿‡é«˜ã€è¿›ç¨‹å¡æ­»)å¼•å‘çš„ ANRï¼Œå°±éœ€è¦å¯¹æ•´ä¸ª ANR æœºåˆ¶æœ‰æ‰€äº†è§£ï¼Œæ‰èƒ½å®šä½å‡ºé—®é¢˜çš„åŸå› ã€‚</p>
<p><strong><font color="#FF0000" size="3">ANR æœºåˆ¶å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„ç›‘æµ‹</strong>ï¼šAndroid å¯¹äºä¸åŒçš„ ANR ç±»å‹(Broadcastï¼ŒServiceï¼ŒInputEvent)éƒ½æœ‰ä¸€å¥—ç›‘æµ‹æœºåˆ¶ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<strong>ANRçš„æŠ¥å‘Š</strong>ï¼šåœ¨ç›‘æµ‹åˆ° ANR ä»¥åï¼Œéœ€è¦æ˜¾ç¤º ANR å¯¹è¯æ¡†ã€è¾“å‡ºæ—¥å¿—(å‘ç”Ÿ ANR æ—¶çš„è¿›ç¨‹å‡½æ•°è°ƒç”¨æ ˆã€CPU ä½¿ç”¨æƒ…å†µç­‰)ã€‚</p>
<h2 id="2-3-ANR-çš„è§¦å‘åŸå› "><a href="#2-3-ANR-çš„è§¦å‘åŸå› " class="headerlink" title="2.3 ANR çš„è§¦å‘åŸå› "></a>2.3 ANR çš„è§¦å‘åŸå› </h2><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œå‡ºç° ANR ä¹‹åä¸€ä¸ªç›´è§‚ç°è±¡å°±æ˜¯ç³»ç»Ÿä¼šå±•ç¤ºå‡ºä¸€ä¸ª ANR å¯¹è¯æ¡†ã€‚</p>
<p><strong><font color="#FF0000" size="3">è°·æ­Œæ–‡æ¡£ä¸­å¯¹ ANR äº§ç”Ÿçš„åŸå› æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</font></strong></p>
<p>Android ç³»ç»Ÿä¸­çš„åº”ç”¨è¢« <code>ActivityManagerService</code> åŠ <code>WindowManagerService</code> ä¸¤ä¸ªç³»ç»ŸæœåŠ¡ç›‘æ§ç€ï¼Œç³»ç»Ÿä¼šåœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µå±•ç¤ºå‡º ANR çš„å¯¹è¯æ¡†ï¼</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">KeyDispatchTimeout</font>&nbsp;(<font color="#FF0000"> 5 seconds</font> ) ï¼šæŒ‰é”®æˆ–è§¦æ‘¸äº‹ä»¶åœ¨ç‰¹å®šæ—¶é—´å†…æ— å“åº”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">BroadcastTimeout</font>&nbsp;(<font color="#FF0000"> 10 seconds</font> )ï¼šBroadcastReceiver åœ¨ç‰¹å®šæ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ &nbsp;<font color="#ff00ff" size="3">ServiceTimeout</font>&nbsp;(<font color="#FF0000"> 20 seconds</font> ) ï¼šService åœ¨ç‰¹å®šçš„æ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ</p>
<h1 id="3-ANR-çš„ç›‘æµ‹æœºåˆ¶"><a href="#3-ANR-çš„ç›‘æµ‹æœºåˆ¶" class="headerlink" title="3. ANR çš„ç›‘æµ‹æœºåˆ¶"></a>3. ANR çš„ç›‘æµ‹æœºåˆ¶</h1><h2 id="3-3-Input-è¶…æ—¶å¤„ç†"><a href="#3-3-Input-è¶…æ—¶å¤„ç†" class="headerlink" title="3.3 Input è¶…æ—¶å¤„ç†"></a>3.3 Input è¶…æ—¶å¤„ç†</h2><p>åº”ç”¨ç¨‹åºå¯ä»¥æ¥æ”¶è¾“å…¥äº‹ä»¶(æŒ‰é”®ã€è§¦å±ã€è½¨è¿¹çƒç­‰)ï¼Œå½“ <strong><font color="#FF0000">5ç§’</font></strong> å†…æ²¡æœ‰å¤„ç†å®Œæ¯•æ—¶ï¼Œåˆ™ä¼šå¼•å‘ ANRã€‚</p>
<p><strong><font color="#7FF000" size="3">å’Œåˆ†æ Broadcast ANR ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆæŠ›å‡º Input ANR ä¸¤ä¸ªé—®é¢˜ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ è¾“å…¥äº‹ä»¶ç»å†äº†ä¸€äº›ä»€ä¹ˆå·¥åºæ‰èƒ½è¢«æ´¾å‘åˆ°åº”ç”¨çš„ç•Œé¢ï¼Ÿ</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ å¦‚ä½•æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶ï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p>
<h3 id="è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº"><a href="#è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº" class="headerlink" title="è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº"></a>è¾“å…¥äº‹ä»¶æ´¾å‘å·¥åº</h3><p>è¾“å…¥äº‹ä»¶æœ€å¼€å§‹ç”±ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚æŒ‰é”®æˆ–è§¦æ‘¸å±å¹•ï¼‰å‘èµ·ï¼ŒAndroid æœ‰ä¸€å¥—è¾“å…¥å­ç³»ç»Ÿæ¥å‘ç°å„ç§è¾“å…¥äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶æœ€ç»ˆéƒ½ä¼šè¢« <font color="#FF00FF">InputDispatcher</font> åˆ†å‘åˆ°å„ä¸ªéœ€è¦æ¥æ”¶äº‹ä»¶çš„çª—å£ã€‚é‚£ä¹ˆï¼Œçª—å£å¦‚ä½•å‘Šä¹‹ InputDispatcher è‡ªå·±éœ€è¦å¤„ç†è¾“å…¥äº‹ä»¶å‘¢ï¼ŸAndroid é€šè¿‡ <font color="#FF00FF">InputChannel</font> è¿æ¥ InputDispatcher å’Œçª—å£ï¼Œ<font color="#FF7F24">InputChannel å…¶å®æ˜¯å°è£…åçš„ Linuxç®¡é“(Pipe)ã€‚æ¯ä¸€ä¸ªçª—å£éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„ InputChannel ï¼Œçª—å£éœ€è¦å°†è¿™ä¸ª InputChannel æ³¨å†Œåˆ° InputDispatcher ä¸­</font>:</p>
<pre class=" language-cpp"><code class="language-cpp">status_t InputDispatcher<span class="token operator">::</span><span class="token function">registerInputChannel</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputChannel<span class="token operator">></span><span class="token operator">&amp;</span> inputChannel<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> inputWindowHandle<span class="token punctuation">,</span> <span class="token keyword">bool</span> monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    sp<span class="token operator">&lt;</span>Connection<span class="token operator">></span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Connection</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">,</span> inputWindowHandle<span class="token punctuation">,</span> monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> inputChannel<span class="token operator">-</span><span class="token operator">></span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConnectionsByFd<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ALOOPER_EVENT_INPUT<span class="token punctuation">,</span> handleReceiveCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯¹äº InputDispatcher è€Œè¨€ï¼Œæ¯æ³¨å†Œä¸€ä¸ª InputChannel éƒ½è¢«è§†ä¸ºä¸€ä¸ª Connection ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥åŒºåˆ«ã€‚InputDispatcher æ˜¯ä¸€ä¸ªæ¶ˆæ¯å¤„ç†å¾ªç¯ï¼Œå½“æœ‰æ–°çš„ Connection æ—¶ï¼Œå°±éœ€è¦å”¤é†’æ¶ˆæ¯å¾ªç¯é˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚</p>
<p>è¾“å…¥äº‹ä»¶çš„ç±»å‹æœ‰å¾ˆå¤šï¼ŒæŒ‰é”®ã€è½¨è¿¹çƒã€è§¦å±ç­‰ï¼ŒAndroid å¯¹è¿™äº›äº‹ä»¶è¿›è¡Œäº†åˆ†ç±»ï¼Œå¤„ç†è¿™äº›äº‹ä»¶çš„çª—å£ä¹Ÿè¢«èµ‹äºˆäº†ä¸€ä¸ªç±»å‹(targetType)ï¼šFoucused æˆ– Touchedã€‚</p>
<p>å¦‚æœå½“å‰è¾“å…¥äº‹ä»¶æ˜¯æŒ‰é”®ç±»å‹ï¼Œåˆ™å¯»æ‰¾ Focused ç±»å‹çš„çª—å£ã€‚å¦‚æœå½“å‰è¾“å…¥äº‹ä»¶ç±»å‹æ˜¯è§¦æ‘¸ç±»å‹ï¼Œåˆ™å¯»æ‰¾ Touched ç±»å‹çš„çª—å£ã€‚</p>
<p>InputDispatcher éœ€è¦ç»è¿‡ä»¥ä¸‹å¤æ‚çš„è°ƒç”¨å…³ç³»ï¼Œæ‰èƒ½æŠŠä¸€ä¸ªè¾“å…¥äº‹ä»¶æ´¾å‘å‡ºå»(è°ƒç”¨å…³ç³»ä»¥æŒ‰é”®äº‹ä»¶ä¸ºä¾‹ï¼Œè§¦å±äº‹ä»¶çš„è°ƒç”¨å…³ç³»ç±»ä¼¼)ï¼š</p>
<pre><code>InputDispatcherThread::threadLoop()
â””â”€â”€ InputDispatcher::dispatchOnce()
    â””â”€â”€ InputDispatcher::dispatchOnceInnerLocked()
        â””â”€â”€ InputDispatcher::dispatchKeyLocked()
            â””â”€â”€ InputDispatcher::dispatchEventLocked()
                â””â”€â”€ InputDispatcher::prepareDispatchCycleLocked()
                    â””â”€â”€ InputDispatcher::enqueueDispatchEntriesLocked()
                        â””â”€â”€ InputDispatcher::startDispatchCycleLocked()
                            â””â”€â”€ InputPublisher::publishKeyEvent()
</code></pre><p>å…·ä½“æ¯ä¸ªå‡½æ•°çš„å®ç°é€»è¾‘æ­¤å¤„ä¸è¡¨ã€‚æˆ‘ä»¬æç‚¼å‡ºå‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ InputDispatcherThread æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒå¤„ç†ä¸€æ¬¡æ¶ˆæ¯çš„æ´¾å‘ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ è¾“å…¥äº‹ä»¶ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ï¼Œéœ€è¦æ’é˜Ÿç­‰å¾…æ´¾å‘ï¼Œæ¯ä¸€ä¸ª Connection éƒ½ç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼š<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Â· outboundQueue: ç­‰å¾…å‘é€ç»™çª—å£çš„äº‹ä»¶ã€‚æ¯ä¸€ä¸ªæ–°æ¶ˆæ¯åˆ°æ¥ï¼Œéƒ½ä¼šå…ˆè¿›å…¥åˆ°æ­¤é˜Ÿåˆ—ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Â· waitQueue: å·²ç»å‘é€ç»™çª—å£çš„äº‹ä»¶ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ publishKeyEvent å®Œæˆåï¼Œè¡¨ç¤ºäº‹ä»¶å·²ç»æ´¾å‘äº†ï¼Œå°±å°†äº‹ä»¶ä» outboundQueue æŒªåˆ°äº† waitQueueã€‚</p>
<p>äº‹ä»¶ç»è¿‡è¿™ä¹ˆä¸€è½®å¤„ç†ï¼Œå°±ç®—æ˜¯ä» InputDispatcher æ´¾å‘å‡ºå»äº†ï¼Œä½†äº‹ä»¶æ˜¯ä¸æ˜¯è¢«çª—å£æ”¶åˆ°äº†ï¼Œè¿˜éœ€è¦ç­‰å¾…æ¥æ”¶æ–¹çš„ <font color="#FF00FF">â€œfinishedâ€</font> é€šçŸ¥ã€‚åœ¨å‘ InputDispatcher æ³¨å†Œ InputChannel çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•° handleReceiveCallback():</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> InputDispatcher<span class="token operator">::</span><span class="token function">handleReceiveCallback</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        status <span class="token operator">=</span> connection<span class="token operator">-</span><span class="token operator">></span>inputPublisher<span class="token punctuation">.</span><span class="token function">receiveFinishedSignal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>seq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        d<span class="token operator">-</span><span class="token operator">></span><span class="token function">finishDispatchCycleLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> handled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    d<span class="token operator">-</span><span class="token operator">></span><span class="token function">unregisterInputChannelLocked</span><span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>inputChannel<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å½“æ”¶åˆ°çš„ status ä¸º OK æ—¶ï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">finishDispatchCycleLocked()</font> æ¥å®Œæˆä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ï¼š</p>
<pre><code>InputDispatcher::finishDispatchCycleLocked()
â””â”€â”€ InputDispatcher::onDispatchCycleFinishedLocked()
    â””â”€â”€ InputDispatcher::doDispatchCycleFinishedLockedInterruptible()
        â””â”€â”€ InputDispatcher::startDispatchCycleLocked()
</code></pre><p>è°ƒç”¨åˆ° <font color="#FF00FF">doDispatchCycleFinishedLockedInterruptible()</font> æ–¹æ³•æ—¶ï¼Œä¼šå°†å·²ç»æˆåŠŸæ´¾å‘çš„æ¶ˆæ¯ä» <font color="#FF00FF">waitQueue</font> ä¸­ç§»é™¤ï¼Œ è¿›ä¸€æ­¥è°ƒç”¨ä¼š <font color="#FF00FF">startDispatchCycleLocked</font> å¼€å§‹æ´¾å‘æ–°çš„äº‹ä»¶ã€‚</p>
<p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</font></strong></p>
<p><strong><font color="#FF7F24">ä¸€ä¸ªæ­£å¸¸çš„è¾“å…¥äº‹ä»¶ä¼šç»è¿‡ä» outboundQueue æŒªåˆ° waitQueue çš„è¿‡ç¨‹ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»æ´¾å‘å‡ºå»ï¼›å†ç»è¿‡ä» waitQueue ä¸­ç§»é™¤çš„è¿‡ç¨‹ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»è¢«çª—å£æ¥æ”¶ã€‚InputDispatcher ä½œä¸ºä¸­æ¢ï¼Œä¸åœåœ°åœ¨é€’é€ç€è¾“å…¥äº‹ä»¶ï¼Œå½“ä¸€ä¸ªäº‹ä»¶æ— æ³•å¾—åˆ°å¤„ç†çš„æ—¶å€™ï¼ŒInputDispatcher ä¸èƒ½å°±æ­¤æ­»æ‰å•Šï¼Œå¦åˆ™ç³»ç»Ÿä¹Ÿå¤ªå®¹æ˜“å´©æºƒäº†ã€‚InputDispatcher çš„ç­–ç•¥æ˜¯æ”¾å¼ƒæ‰å¤„ç†ä¸è¿‡æ¥çš„äº‹ä»¶ï¼Œå¹¶å‘å‡ºé€šçŸ¥(è¿™ä¸ªé€šçŸ¥æœºåˆ¶å°±æ˜¯ANR)ï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€è½®æ¶ˆæ¯çš„å¤„ç†ã€‚</font></strong></p>
<p><strong><font color="#FF0000">ç†è§£è¾“å…¥äº‹ä»¶åˆ†å‘æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š</font></strong></p>
<pre><code>æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶å¯ä»¥æ¯”åšä¸€ä¸ªå¿«é€’ï¼ŒInputDispatcher å°±åƒä¸€ä¸ªå¿«é€’ä¸­è½¬ç«™ï¼Œçª—å£å°±åƒæ˜¯æ”¶ä»¶äººï¼ŒInputChannel å°±åƒæ˜¯å¿«é€’å‘˜ã€‚
æ‰€æœ‰å¿«é€’éƒ½ä¼šç»è¿‡ä¸­è½¬ç«™ä¸­å¤„ç†ï¼Œä¸­è½¬ç«™éœ€è¦çŸ¥é“æ¯ä¸€ä¸ªå¿«é€’çš„æ”¶ä»¶äººæ˜¯è°ï¼Œé€šè¿‡å¿«é€’å‘˜å°†å¿«é€’å‘é€åˆ°å…·ä½“çš„æ”¶ä»¶äººã€‚
è¿™å…¶ä¸­æœ‰å¾ˆå¤šåœºæ™¯å¯¼è‡´å¿«é€’ä¸èƒ½åŠæ—¶é€åˆ°ï¼šè­¬å¦‚è”ç³»ä¸åˆ°æ”¶ä»¶äºº;å¿«é€’å¾ˆå¤šï¼Œå¿«é€’å‘˜ä¼šå¿™ä¸è¿‡æ¥;å¿«é€’å‘˜å—ä¼¤ä¼‘å‡äº†ç­‰ç­‰â€¦
è¿™æ—¶å€™å¿«é€’å‘˜å°±éœ€è¦å‘ŠçŸ¥ä¸­è½¬ç«™ï¼šæœ‰å¿«é€’æ— æ³•åŠæ—¶é€åˆ°äº†ã€‚ä¸­è½¬ç«™åœ¨æ”¶åˆ°å¿«é€’å‘˜çš„é€šçŸ¥åï¼Œä¸€è¾¹ç»§ç»­æ´¾å‘å…¶ä»–å¿«é€’ï¼Œä¸€è¾¹æŠ¥å‘Šä¸Šçº§ã€‚
</code></pre><h3 id="æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶"><a href="#æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶" class="headerlink" title="æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶"></a>æ£€æµ‹è¾“å…¥äº‹ä»¶å¤„ç†è¶…æ—¶</h3><p>åœ¨äº†è§£è¾“å…¥äº‹ä»¶åˆ†å‘æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è§è¯†ä¸€ä¸‹ANRæœºåˆ¶äº†ã€‚åœ¨æ´¾å‘äº‹ä»¶æ—¶ï¼Œ<font color="#FF00FF">dispatchKeyLocked()</font> å’Œ <font color="#FF00FF">dispatchMotionLocked()</font>ï¼Œéœ€è¦æ‰¾åˆ°å½“å‰çš„ç„¦ç‚¹çª—å£ï¼Œç„¦ç‚¹çª—å£æ‰æ˜¯æœ€ç»ˆæ¥æ”¶äº‹ä»¶çš„åœ°æ–¹ï¼Œæ‰¾çª—å£çš„è¿‡ç¨‹å°±ä¼šåˆ¤æ–­æ˜¯å¦å·²ç»å‘ç”Ÿäº†ANRï¼š</p>
<pre><code>InputDispatcher::findFocusedWindowTargetsLocked()
InputDispatcher::findTouchedWindowTargetsLocked()
â””â”€â”€ InputDispatcher::handleTargetsNotReadyLocked()
    â””â”€â”€ InputDispatcher::onANRLocked()
        â””â”€â”€ InputDispatcher::doNotifyANRLockedInterruptible()
            â””â”€â”€ NativeInputManager::notifyANR()
</code></pre><p>ï¼ˆ1ï¼‰é¦–å…ˆï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">findFocusedWindowTargetsLocked()</font> æˆ– <font color="#FF00FF">findTouchedWindowTargetsLocked()</font> å¯»æ‰¾æ¥æ”¶è¾“å…¥äº‹ä»¶çš„çª—å£ã€‚</p>
<p>åœ¨æ‰¾åˆ°çª—å£ä»¥åï¼Œä¼šè°ƒç”¨ <font color="#FF00FF">checkWindowReadyForMoreInputLocked()</font> æ£€æŸ¥çª—å£æ˜¯å¦æœ‰èƒ½åŠ›å†æ¥æ”¶æ–°çš„è¾“å…¥äº‹ä»¶ï¼Œä¼šæœ‰ä¸€ç³»åˆ—çš„åœºæ™¯é˜»ç¢äº‹ä»¶çš„ç»§ç»­æ´¾å‘ï¼š</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯1: çª—å£å¤„äºpausedçŠ¶æ€ï¼Œä¸èƒ½å¤„ç†è¾“å…¥äº‹ä»¶</font></strong></p>
<p>â€œWaiting because the [targetType] window is paused.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯2: çª—å£è¿˜æœªå‘InputDispatcheræ³¨å†Œï¼Œæ— æ³•å°†äº‹ä»¶æ´¾å‘åˆ°çª—å£</font></strong></p>
<p>â€œWaiting because the [targetType] windowâ€™s input channel is not registered with the input dispatcher. The window may be in the process of being removed.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯3: çª—å£å’ŒInputDispatcherçš„è¿æ¥å·²ç»ä¸­æ–­ï¼Œå³InputChannelä¸èƒ½æ­£å¸¸å·¥ä½œ</font></strong></p>
<p>â€œWaiting because the [targetType] windowâ€™s input connection is [status]. The window may be in the process of being removed.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯4: InputChannelå·²ç»é¥±å’Œï¼Œä¸èƒ½å†å¤„ç†æ–°çš„äº‹ä»¶</font></strong></p>
<p>â€œWaiting because the [targetType] windowâ€™s input channel is full. Outbound queue length: %d. Wait queue length: %d.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯5: å¯¹äºæŒ‰é”®ç±»å‹(KeyEvent)çš„è¾“å…¥äº‹ä»¶ï¼Œéœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªäº‹ä»¶å¤„ç†å®Œæ¯•</font></strong></p>
<p>â€œWaiting to send key event because the [targetType] window has not finished processing all of the input events that were previously delivered to it. Outbound queue length: %d. Wait queue length: %d.â€</p>
<p><strong><font color="#7FF000" size="3">åœºæ™¯6: å¯¹äºè§¦æ‘¸ç±»å‹(TouchEvent)çš„è¾“å…¥äº‹ä»¶ï¼Œå¯ä»¥ç«‹å³æ´¾å‘åˆ°å½“å‰çš„çª—å£ï¼Œå› ä¸ºTouchEventéƒ½æ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·å½“å‰å¯è§çš„çª—å£ã€‚ä½†æœ‰ä¸€ç§æƒ…å†µï¼Œ å¦‚æœå½“å‰åº”ç”¨ç”±äºé˜Ÿåˆ—æœ‰å¤ªå¤šçš„è¾“å…¥äº‹ä»¶ç­‰å¾…æ´¾å‘ï¼Œå¯¼è‡´å‘ç”Ÿäº†ANRï¼Œé‚£TouchEventäº‹ä»¶å°±éœ€è¦æ’é˜Ÿç­‰å¾…æ´¾å‘ã€‚</font></strong></p>
<p>â€œWaiting to send non-key event because the %s window has not finished processing certain input events that were delivered to it over %0.1fms ago. Wait queue length: %d. Wait queue head age: %0.1fms.â€</p>
<p>ï¼ˆ2ï¼‰ç„¶åï¼Œä¸Šè¿°æœ‰ä»»ä½•ä¸€ä¸ªåœºæ™¯å‘ç”Ÿäº†ï¼Œåˆ™è¾“å…¥äº‹ä»¶éœ€è¦ç»§ç»­ç­‰å¾…ï¼Œç´§æ¥ç€å°±ä¼šè°ƒç”¨ <font color="#FF00FF">handleTargetsNotReadyLocked()</font> æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»çš„ç­‰å¾…è¶…æ—¶äº†ï¼š</p>
<pre class=" language-cpp"><code class="language-cpp">int32_t InputDispatcher<span class="token operator">::</span><span class="token function">handleTargetsNotReadyLocked</span><span class="token punctuation">(</span>nsecs_t currentTime<span class="token punctuation">,</span>
        <span class="token keyword">const</span> EventEntry<span class="token operator">*</span> entry<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputApplicationHandle<span class="token operator">></span><span class="token operator">&amp;</span> applicationHandle<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>InputWindowHandle<span class="token operator">></span><span class="token operator">&amp;</span> windowHandle<span class="token punctuation">,</span>
        nsecs_t<span class="token operator">*</span> nextWakeupTime<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">>=</span> mInputTargetWaitTimeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onANRLocked</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> applicationHandle<span class="token punctuation">,</span> windowHandle<span class="token punctuation">,</span>
            entry<span class="token operator">-</span><span class="token operator">></span>eventTime<span class="token punctuation">,</span> mInputTargetWaitStartTime<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>nextWakeupTime <span class="token operator">=</span> LONG_LONG_MIN<span class="token punctuation">;</span>
        <span class="token keyword">return</span> INPUT_EVENT_INJECTION_PENDING<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre>
<p>æœ€åï¼Œå¦‚æœå½“å‰äº‹ä»¶æ´¾å‘å·²ç»è¶…æ—¶ï¼Œåˆ™è¯´æ˜å·²ç»æ£€æµ‹åˆ°äº† ANR ï¼Œè°ƒç”¨ <font color="#FF00FF">onANRLocked()</font> æ–¹æ³•ï¼Œç„¶åå°† <font color="#FF00FF">nextWakeupTime</font> è®¾ç½®ä¸ºæœ€å°å€¼ï¼Œé©¬ä¸Šå¼€å§‹ä¸‹ä¸€è½®è°ƒåº¦ã€‚åœ¨ onANRLocked() æ–¹æ³•ä¸­ï¼Œ ä¼šä¿å­˜ ANR çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œè°ƒç”¨ <font color="#FF00FF">doNotifyANRLockedInterruptible()</font> ï¼Œè¿›ä¸€æ­¥ä¼šè°ƒç”¨åˆ° JNI å±‚çš„ <font color="#FF00FF">NativeInputManager::notifyANR()</font> æ–¹æ³•ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è¡”æ¥ Native å±‚å’Œ Java å±‚ï¼Œç›´æ¥è°ƒç”¨ Java å±‚çš„ <font color="#FF00FF">InputManagerService.notifyANR()</font> æ–¹æ³•ã€‚</p>
<p><strong><font color="#FF0000">è‡³æ­¤ï¼ŒANRçš„å¤„ç†é€»è¾‘è½¬äº¤åˆ°äº†Javaå±‚ã€‚</font></strong>åº•å±‚(Native)å‘ç°ä¸€æ—¦æœ‰è¾“å…¥äº‹ä»¶æ´¾å‘è¶…æ—¶ï¼Œå°±ä¼šé€šçŸ¥ä¸Šå±‚(Java)ï¼Œä¸Šå±‚æ”¶åˆ°ANRé€šçŸ¥åï¼Œå†³å®šæ˜¯å¦ç»ˆæ­¢å½“å‰è¾“å…¥äº‹ä»¶çš„æ´¾å‘ã€‚</p>
<p>å‘ç”ŸANRæ—¶ï¼ŒJavaå±‚æœ€å¼€å§‹çš„å…¥å£æ˜¯ <font color="#FF00FF">InputManagerService.notifyANR()</font> ï¼Œå®ƒæ˜¯ç›´æ¥è¢« Native å±‚è°ƒç”¨çš„ã€‚æˆ‘ä»¬å…ˆæŠŠ ANR çš„Javaå±‚è°ƒç”¨å…³ç³»åˆ—å‡ºæ¥ï¼š</p>
<pre><code>InputManagerService.notifyANR()
â””â”€â”€ InputMonitor.notifyANR()
    â”œâ”€â”€ IApplicationToken.keyDispatchingTimedOut()
    â”‚   â””â”€â”€ ActivityRecord.keyDispatchingTimedOut()
    â”‚       â””â”€â”€ AMS.inputDispatchingTimedOut()
    â”‚           â””â”€â”€ AMS.appNotResponding()
    â”‚
    â””â”€â”€ AMS.inputDispatchingTimedOut()
        â””â”€â”€ AMS.appNotResponding()
</code></pre><p><font color="#FF00FF">InputManagerService.notifyANR()</font> åªæ˜¯ä¸º Nativeå±‚ å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œå®ƒç›´æ¥è°ƒç”¨ <font color="#FF00FF">InputMonitor.notifyANR()</font>ã€‚å¦‚æœè¯¥æ–¹æ³•çš„è¿”å›å€¼ç­‰äº0ï¼Œåˆ™æ”¾å¼ƒæœ¬æ¬¡è¾“å…¥äº‹ä»¶ï¼›å¦‚æœå¤§äº0ï¼Œåˆ™è¡¨ç¤ºéœ€è¦ç»§ç»­ç­‰å¾…çš„æ—¶é—´ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">notifyANR</span><span class="token punctuation">(</span>InputApplicationHandle inputApplicationHandle<span class="token punctuation">,</span>
      InputWindowHandle inputWindowHandle<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appWindowToken <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> appWindowToken<span class="token punctuation">.</span>appToken <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// appTokenå®é™…ä¸Šå°±æ˜¯å½“å‰çš„ActivityRecordã€‚</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå‘ç”ŸANRçš„Activityè¿˜å­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡ActivityRecordé€šçŸ¥äº‹ä»¶æ´¾å‘è¶…æ—¶</span>
        <span class="token keyword">boolean</span> abort <span class="token operator">=</span> appWindowToken<span class="token punctuation">.</span>appToken<span class="token punctuation">.</span><span class="token function">keyDispatchingTimedOut</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> abort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> appWindowToken<span class="token punctuation">.</span>inputDispatchingTimeoutNanos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowState <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå‘ç”ŸANRçš„Activityå·²ç»é”€æ¯äº†ï¼Œåˆ™é€šè¿‡AMSé€šçŸ¥äº‹ä»¶æ´¾å‘è¶…æ—¶</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> ActivityManagerNative<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>
                        windowState<span class="token punctuation">.</span>mSession<span class="token punctuation">.</span>mPid<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// abort dispatching</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸Šè¿°æ–¹æ³•ä¸­æœ‰ä¸¤ç§ä¸åŒçš„è°ƒç”¨æ–¹å¼ï¼Œä½†æœ€ç»ˆéƒ½ä¼šäº¤ç”± <font color="#FF00FF">AMS.inputDispatchingTimedOut()</font> å¤„ç†ã€‚AMS æœ‰é‡è½½çš„ <font color="#FF00FF">inputDispatchingTimedOut()</font> æ–¹æ³•ï¼Œä»–ä»¬çš„å‚æ•°ä¸ä¸€æ ·ã€‚ActivityRecord è°ƒç”¨æ—¶ï¼Œå¯ä»¥ä¼ å…¥çš„ä¿¡æ¯æ›´å¤šä¸€ç‚¹(å½“å‰å‘ç”ŸANRçš„ç•Œé¢æ˜¯å“ªä¸€ä¸ª)ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. æ ¹æ®è¿›ç¨‹å·è·å–åˆ°ProcessRecord</span>
    proc <span class="token operator">=</span> mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// 2. è·å–è¶…æ—¶æ—¶é—´</span>
    <span class="token comment" spellcheck="true">// æµ‹è¯•ç¯å¢ƒä¸‹çš„è¶…æ—¶æ—¶é—´æ˜¯INSTRUMENTATION_KEY_DISPATCHING_TIMEOUT(60ç§’)ï¼Œ</span>
    <span class="token comment" spellcheck="true">// æ­£å¸¸ç¯å¢ƒä¸‹çš„è¶…æ—¶æ—¶é—´æ˜¯KEY_DISPATCHING_TIMEOUT(5ç§’)</span>
    timeout <span class="token operator">=</span> <span class="token function">getInputDispatchingTimeoutLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è°ƒç”¨é‡è½½çš„å‡½æ•°ï¼Œå¦‚æœè¿”å›Trueï¼Œåˆ™è¡¨ç¤ºéœ€è¦ä¸­æ–­å½“å‰çš„äº‹ä»¶æ´¾å‘;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 3. è¿”å›ç»§ç»­ç­‰å¾…çš„æ—¶é—´ï¼Œè¿™ä¸ªå€¼ä¼šä¼ é€’åˆ°Nativeå±‚</span>
    <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">inputDispatchingTimedOut</span><span class="token punctuation">(</span><span class="token keyword">final</span> ProcessRecord proc<span class="token punctuation">,</span>
        <span class="token keyword">final</span> ActivityRecord activity<span class="token punctuation">,</span> <span class="token keyword">final</span> ActivityRecord parent<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">// 1. å‘ç”ŸANRè¿›ç¨‹æ­£å¤„äºè°ƒè¯•çŠ¶æ€ï¼Œä¸éœ€è¦ä¸­æ–­äº‹ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>debugging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 2. å½“å‰æ­£åœ¨åšdexoptæ“ä½œï¼Œè¿™ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œä¸éœ€è¦ä¸­æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDidDexOpt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Give more time since we were dexopting.</span>
        mDidDexOpt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 3. å‘ç”ŸANRçš„è¿›ç¨‹æ˜¯æµ‹è¯•è¿›ç¨‹ï¼Œéœ€è¦ä¸­æ–­ï¼Œä½†ä¸åœ¨UIç•Œé¢æ˜¾ç¤ºANRä¿¡æ¯åˆ¤æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>instrumentationClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">finishInstrumentationLocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> Activity<span class="token punctuation">.</span>RESULT_CANCELED<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 4. é€šçŸ¥UIç•Œé¢æ˜¾ç¤ºANRä¿¡æ¯</span>
    mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">appNotResponding</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> aboveSystem<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#FF0000">è‡³æ­¤ï¼Œæˆ‘ä»¬å›ç­”äº†ç¬¬äºŒä¸ªé—®é¢˜ï¼š</font></strong></p>
<p><strong><font color="#FF7F24">åœ¨ InputDispatcher æ´¾å‘è¾“å…¥äº‹ä»¶æ—¶ï¼Œä¼šå¯»æ‰¾æ¥æ”¶äº‹ä»¶çš„çª—å£ï¼Œå¦‚æœæ— æ³•æ­£å¸¸æ´¾å‘ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´å½“å‰éœ€è¦æ´¾å‘çš„äº‹ä»¶è¶…æ—¶(é»˜è®¤æ˜¯5ç§’)ã€‚Nativeå±‚å‘ç°è¶…æ—¶äº†ï¼Œä¼šé€šçŸ¥Javaå±‚ï¼ŒJavaå±‚ç»è¿‡ä¸€äº›å¤„ç†åï¼Œä¼šåé¦ˆç»™Nativeå±‚ï¼Œæ˜¯ç»§ç»­ç­‰å¾…è¿˜æ˜¯ä¸¢å¼ƒå½“å‰æ´¾å‘çš„äº‹ä»¶ã€‚</font></strong></p>
<h2 id="3-4-å°ç»“"><a href="#3-4-å°ç»“" class="headerlink" title="3.4 å°ç»“"></a>3.4 å°ç»“</h2><p><strong>ANRç›‘æµ‹æœºåˆ¶åŒ…å«ä¸‰ç§ï¼š</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Service ANR</font></strong>ï¼Œå‰å°è¿›ç¨‹ä¸­Serviceç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡ <strong><font color="#FF0000">20ç§’</font></strong>ï¼Œåå°è¿›ç¨‹ä¸­Serviceçš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡<strong><font color="#FF0000"> 200ç§’</font></strong>ã€‚ åœ¨å¯åŠ¨Serviceæ—¶ï¼ŒæŠ›å‡ºå®šæ—¶æ¶ˆæ¯ <strong><font color="#FF34B3">SERVICE_TIMEOUT_MSG</font></strong> æˆ– <strong><font color="#FF34B3">SERVICE_BACKGOURND_TIMEOUT_MSG</font></strong>ï¼Œå¦‚æœå®šæ—¶æ¶ˆæ¯å“åº”äº†ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Broadcast ANR</font></strong>ï¼Œå‰å°çš„â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€å¿…é¡»åœ¨ <strong><font color="#FF0000">10ç§’</font></strong> å†…å¤„ç†å®Œæ¯•ï¼Œåå°çš„â€œä¸²è¡Œå¹¿æ’­æ¶ˆæ¯â€å¿…é¡»åœ¨<strong><font color="#FF0000"> 60ç§’ </font></strong>å¤„ç†å®Œæ¯•ï¼Œ æ¯æ´¾å‘ä¸²è¡Œå¹¿æ’­æ¶ˆæ¯åˆ°ä¸€ä¸ªæ¥æ”¶å™¨æ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºä¸€ä¸ªå®šæ—¶æ¶ˆæ¯ <strong><font color="#FF34B3">BROADCAST_TIMEOUT_MSG</font></strong>ï¼Œå¦‚æœå®šæ—¶æ¶ˆæ¯å“åº”ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å¹¿æ’­æ¶ˆæ¯å¤„ç†è¶…æ—¶ï¼Œè¶…æ—¶å°±è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ <strong><font color="#7FF000">Input ANR</font></strong>ï¼Œè¾“å…¥äº‹ä»¶å¿…é¡»åœ¨ <strong><font color="#FF0000">5ç§’</font></strong> å†…å¤„ç†å®Œæ¯•ã€‚åœ¨æ´¾å‘ä¸€ä¸ªè¾“å…¥äº‹ä»¶æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰è¾“å…¥äº‹ä»¶æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œå¦‚æœéœ€è¦ç­‰å¾…ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ç­‰å¾…å·²ç»è¶…æ—¶ï¼Œè¶…æ—¶å°±è¯´æ˜å‘ç”Ÿäº†ANRã€‚</p>
<p>ANRç›‘æµ‹æœºåˆ¶å®é™…ä¸Šæ˜¯å¯¹åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹çš„è¦æ±‚ï¼Œè¦æ±‚ä¸»çº¿æˆå¿…é¡»åœ¨é™å®šçš„æ—¶é—´å†…ï¼Œå®Œæˆå¯¹å‡ ç§æ“ä½œçš„å“åº”ï¼›å¦åˆ™ï¼Œå°±å¯ä»¥è®¤ä¸ºåº”ç”¨ç¨‹åºä¸»çº¿ç¨‹å¤±å»å“åº”èƒ½åŠ›ã€‚</p>
<p><strong>ä»ANRçš„ä¸‰ç§ç›‘æµ‹æœºåˆ¶ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸åŒè¶…æ—¶æœºåˆ¶çš„è®¾è®¡ï¼š</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ Service å’Œ Broadcast éƒ½æ˜¯ç”± AMS è°ƒåº¦ï¼Œåˆ©ç”¨ Handler å’Œ Looperï¼Œè®¾è®¡äº†ä¸€ä¸ª TIMEOUT æ¶ˆæ¯äº¤ç”± AMS çº¿ç¨‹æ¥å¤„ç†ï¼Œæ•´ä¸ªè¶…æ—¶æœºåˆ¶çš„å®ç°éƒ½æ˜¯åœ¨Javaå±‚ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’¥ InputEvent ç”± InputDispatcher è°ƒåº¦ï¼Œå¾…å¤„ç†çš„è¾“å…¥äº‹ä»¶éƒ½ä¼šè¿›å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œè®¾è®¡äº†ä¸€ä¸ªç­‰å¾…è¶…æ—¶çš„åˆ¤æ–­ï¼Œè¶…æ—¶æœºåˆ¶çš„å®ç°åœ¨Nativeå±‚ã€‚</p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>å¾®ä¿¡é‡Œç‚¹â€œå‘ç°â€->â€œæ‰«ä¸€æ‰«â€äºŒç»´ç ä¾¿å¯æŸ¥çœ‹åˆ†äº«ã€‚</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;è½¬è½½è¯·æ³¨æ˜:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Hexo</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/05/26/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-input-chao-shi/" class="b-link-green">è°ˆè°ˆ ANR ä¹‹ Input è¶…æ—¶</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScriptã€‚</noscript>
    </div>
    <!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2019/12/29/00.thinking-in-android-03.xiu-gai-ri-zhi/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/åšå®¢æ—¥å¿—.jpg" class="responsive-img" alt="åšå®¢æ—¥å¿—">
                        
                        <span class="card-title">åšå®¢æ—¥å¿—</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">Thinking in Android â€“ â€œæ–°å¢â€



æ—¥æœŸ
æ–°å¢åšæ–‡




2019.05.26
 ã€Šæ·±å…¥é’»ç ” Android åº”ç”¨ ANR ä¹‹ Input è¶…æ—¶ã€‹ 


2019.05.10
 ã€Šæ·±å…¥é’»ç ” Android åº”ç”¨ A</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-12-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category" target="_blank">
                                    Android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/åšå®¢ä¼˜åŒ–/" target="_blank">
                        <span class="chip bg-color">åšå®¢ä¼˜åŒ–</span>
                    </a>
                    
                    <a href="/tags/ä¿®è®¢è®°å½•/" target="_blank">
                        <span class="chip bg-color">ä¿®è®¢è®°å½•</span>
                    </a>
                    
                    <a href="/tags/æ–¹å‘è§„åˆ’/" target="_blank">
                        <span class="chip bg-color">æ–¹å‘è§„åˆ’</span>
                    </a>
                    
                    <a href="/tags/æ—¥å¿—/" target="_blank">
                        <span class="chip bg-color">æ—¥å¿—</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/05/10/07.xing-neng-you-hua-xi-lie-tan-tan-ying-yong-anr-zhi-broadcast-chao-shi/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/ANR-02.jpg" class="responsive-img" alt="è°ˆè°ˆ ANR ä¹‹ Broadcast è¶…æ—¶">
                        
                        <span class="card-title">è°ˆè°ˆ ANR ä¹‹ Broadcast è¶…æ—¶</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">1. æ ¸å¿ƒæºç 


å…³é”®ç±»
è·¯å¾„ï¼ˆ/frameworks/base/ï¼‰




ActiveServices.java
services/core/java/com/android/server/am/ActiveServices.java</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="post-category" target="_blank">
                                    æ€§èƒ½ä¼˜åŒ–
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Broadcast/" target="_blank">
                        <span class="chip bg-color">Broadcast</span>
                    </a>
                    
                    <a href="/tags/æ€§èƒ½ä¼˜åŒ–/" target="_blank">
                        <span class="chip bg-color">æ€§èƒ½ä¼˜åŒ–</span>
                    </a>
                    
                    <a href="/tags/ANR/" target="_blank">
                        <span class="chip bg-color">ANR</span>
                    </a>
                    
                    <a href="/tags/æ— å“åº”/" target="_blank">
                        <span class="chip bg-color">æ— å“åº”</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: Hexo<br />'
            + 'ä½œè€…: Marco<br />'
            + 'é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
		</div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQè”ç³»æˆ‘: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;æ£€ç´¢åšæ–‡</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„æŠ€æœ¯å…³é”®å­—" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->





</body>
</html>