<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="关于 &#34;自动背光&#34; 的原理, Thinking in Android">
    <meta name="description" content="
一、开篇1.1 核心源码


关键类
路径




BrightnessController.java
frameworks/base/packages/SystemUI/src/com/android/systemui/settings">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>关于 &#34;自动背光&#34; 的原理 | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color-header-marco nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/常用组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/系统启动/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/核心机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>机制</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>经验</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="检索博文"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/常用组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/系统启动/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/核心机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                机制
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                经验
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/自动背光.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        关于 &#34;自动背光&#34; 的原理
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android-9-0/" target="_blank">
                                <span class="chip bg-color">Android 9.0</span>
                            </a>
                        
                            <a href="/tags/自动背光/" target="_blank">
                                <span class="chip bg-color">自动背光</span>
                            </a>
                        
                            <a href="/tags/亮度调节/" target="_blank">
                                <span class="chip bg-color">亮度调节</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/核心机制/" class="post-category" target="_blank">
                                核心机制
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;发布日期 :&nbsp;
                    2019-05-31
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;文章字数 :&nbsp;
                        5.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;阅读时长 :&nbsp;
                        26 分钟
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;阅读次数 :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<h1 id="一、开篇"><a href="#一、开篇" class="headerlink" title="一、开篇"></a>一、开篇</h1><h2 id="1-1-核心源码"><a href="#1-1-核心源码" class="headerlink" title="1.1 核心源码"></a>1.1 核心源码</h2><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">BrightnessController.java</font></td>
<td>frameworks/base/packages/SystemUI/src/com/android/systemui/settings/BrightnessController.java</td>
</tr>
<tr>
<td><font color="#D15FEE">DisplayManager.java</font></td>
<td>frameworks/base/core/java/android/hardware/display/DisplayManager.java</td>
</tr>
<tr>
<td><font color="#D15FEE">DisplayManagerGlobal.java</font></td>
<td>frameworks/base/core/java/android/hardware/display/DisplayManagerGlobal.java</td>
</tr>
<tr>
<td><font color="#D15FEE">DisplayManagerService.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/display/DisplayManagerService.java</td>
</tr>
<tr>
<td><font color="#D15FEE">DisplayPowerController.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</td>
</tr>
<tr>
<td><font color="#D15FEE">BrightnessMappingStrategy.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</td>
</tr>
<tr>
<td><font color="#D15FEE">AutomaticBrightnessController.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</td>
</tr>
</tbody>
</table>
<h2 id="1-2-国际单位制"><a href="#1-2-国际单位制" class="headerlink" title="1.2 国际单位制"></a>1.2 国际单位制</h2><p><strong><font color="#0000ff">光照度：</font></strong>从光源照射到单位面积上的光通量，以 <code>E</code> 表示，照度的单位为<code>勒克斯</code>（Lux，简称 lx）；</p>
<p><strong><font color="#0000ff">光亮度：</font></strong>指一个表面的明亮程度，以 <code>L</code> 表示，即从一个表面反射出来的光通量。不同物体对光有不同的反射系数或吸收系数。光的强度可用照在平面上的光的总量来度量，这叫<code>入射光</code>(inci-dentlight)或<code>照度</code>(illuminance)。若用从平面反射到眼球中的光量来度量光的强度，这种光称为<code>反射光</code>或<code>亮度</code>。例如，一般白纸大约吸收入射光量的20%，反射光量为80%；黑纸只反射入射光量的3%。所以，白纸和黑纸在亮度上差异很大。</p>
<p><strong><font color="#ff0000">“光照度”</font></strong> 和 <strong><font color="#ff0000">“光亮度”</font></strong> 的关系可以用如下公式表示：<strong><font color="#ff0000">L = R × E</font></strong>，式中 <code>L 为亮度</code>，<code>R 为反射系数</code>，<code>E 为照度</code>。</p>
<h1 id="二、手动调节亮度"><a href="#二、手动调节亮度" class="headerlink" title="二、手动调节亮度"></a>二、手动调节亮度</h1><h2 id="2-1-BrightnessController"><a href="#2-1-BrightnessController" class="headerlink" title="2.1 BrightnessController"></a>2.1 BrightnessController</h2><p>手动调节亮度主要两种方式：<code>SysmemUI</code>、<code>Settings</code>，入口：<code>BrightnessController.java</code>。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/packages/SystemUI/src/com/android/systemui/settings/BrightnessController.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChanged</span><span class="token punctuation">(</span>ToggleSlider toggleSlider<span class="token punctuation">,</span> <span class="token keyword">boolean</span> tracking<span class="token punctuation">,</span> <span class="token keyword">boolean</span> automatic<span class="token punctuation">,</span>
            <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> stopTracking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 获取亮度值</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token function">convertGammaToLinear</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> min<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stopTracking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MetricsLogger<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> metric<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 设置亮度值</span>
        <span class="token function">setBrightness</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tracking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 在异步任务中将新的亮度值保存在 SettingsProvider 中</span>
            AsyncTask<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Settings<span class="token punctuation">.</span>System<span class="token punctuation">.</span><span class="token function">putIntForUser</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                setting<span class="token punctuation">,</span> val<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_CURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-2-setBrightness"><a href="#2-2-setBrightness" class="headerlink" title="2.2 setBrightness"></a>2.2 setBrightness</h2><p>我们来看一下设置亮度值得方法：<code>setBrightness</code>。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/packages/SystemUI/src/com/android/systemui/settings/BrightnessController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBrightness</span><span class="token punctuation">(</span><span class="token keyword">int</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 调用 DisplayManager 对象的 setTemporaryBrightness 方法设置亮度</span>
        mDisplayManager<span class="token punctuation">.</span><span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-3-DisplayManager"><a href="#2-3-DisplayManager" class="headerlink" title="2.3 DisplayManager"></a>2.3 DisplayManager</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/core/java/android/hardware/display/DisplayManager.java</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> DisplayManagerGlobal mGlobal<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span><span class="token keyword">int</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 调用 DisplayManagerGlobal 对象的 setTemporaryBrightness 方法设置亮度</span>
        mGlobal<span class="token punctuation">.</span><span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-4-DisplayManagerGlobal"><a href="#2-4-DisplayManagerGlobal" class="headerlink" title="2.4 DisplayManagerGlobal"></a>2.4 DisplayManagerGlobal</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/core/java/android/hardware/display/DisplayManagerGlobal.java</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> IDisplayManager mDm<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span><span class="token keyword">int</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 调用 IDisplayManager 对象的 setTemporaryBrightness 方法设置亮度</span>
            mDm<span class="token punctuation">.</span><span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-5-DisplayManagerService"><a href="#2-5-DisplayManagerService" class="headerlink" title="2.5 DisplayManagerService"></a>2.5 DisplayManagerService</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayManagerService.java</span>

    <span class="token comment" spellcheck="true">// Display power controller.</span>
    <span class="token keyword">private</span> DisplayPowerController mDisplayPowerController<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span> <span class="token comment" spellcheck="true">// Binder call</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span><span class="token keyword">int</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext<span class="token punctuation">.</span><span class="token function">enforceCallingOrSelfPermission</span><span class="token punctuation">(</span>
                 Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CONTROL_DISPLAY_BRIGHTNESS<span class="token punctuation">,</span>
                 <span class="token string">"Permission required to set the display's brightness"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> token <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSyncRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 调用 DisplayPowerController 对象的 setTemporaryBrightness 方法设置亮度</span>
                mDisplayPowerController<span class="token punctuation">.</span><span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            Binder<span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>最终进入到 <code>DisplayPowerController</code> 中，调用 <code>setTemporaryBrightness</code> 方法。</p>
<h2 id="2-6-DisplayPowerController"><a href="#2-6-DisplayPowerController" class="headerlink" title="2.6 DisplayPowerController"></a>2.6 DisplayPowerController</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token comment" spellcheck="true">// Our handler.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> DisplayControllerHandler mHandler<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTemporaryBrightness</span><span class="token punctuation">(</span><span class="token keyword">int</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 通过 Handler 发送消息</span>
        Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MSG_SET_TEMPORARY_BRIGHTNESS<span class="token punctuation">,</span>
                brightness<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*unused*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-7-DisplayControllerHandler"><a href="#2-7-DisplayControllerHandler" class="headerlink" title="2.7 DisplayControllerHandler"></a>2.7 DisplayControllerHandler</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DisplayControllerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">DisplayControllerHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*async*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token keyword">case</span> MSG_SET_TEMPORARY_BRIGHTNESS<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// TODO: Should we have a a timeout for the temporary brightness?</span>
                    <span class="token comment" spellcheck="true">// 将 brightness 赋值给了 mTemporaryScreenBrightness</span>
                    mTemporaryScreenBrightness <span class="token operator">=</span> msg<span class="token punctuation">.</span>arg1<span class="token punctuation">;</span>
                    <span class="token function">updatePowerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-8-updatePowerState"><a href="#2-8-updatePowerState" class="headerlink" title="2.8 updatePowerState"></a>2.8 updatePowerState</h2><p>接下来的分析重点就是 <code>updatePowerState</code> 方法，源码量有300多行，我们这边只关注”亮度调节”相关逻辑。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updatePowerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 手动设置亮度是否改变</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> userSetBrightnessChanged <span class="token operator">=</span> <span class="token function">updateUserSetScreenBrightness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userSetBrightnessChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mTemporaryScreenBrightness <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Use the temporary screen brightness if there isn't an override, either from</span>
        <span class="token comment" spellcheck="true">// WindowManager or based on the display state.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTemporaryScreenBrightness <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            brightness <span class="token operator">=</span> mTemporaryScreenBrightness<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 使用手动设置的亮度</span>
            mAppliedTemporaryBrightness <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mAppliedTemporaryBrightness <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// Animate the screen brightness when the screen is on or dozing.</span>
        <span class="token comment" spellcheck="true">// Skip the animation when the screen is off or suspended or transition to/from VR.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingScreenOff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isDisplayContentVisible <span class="token operator">=</span>
                    mColorFadeEnabled <span class="token operator">&amp;&amp;</span> mPowerState<span class="token punctuation">.</span><span class="token function">getColorFadeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> brightnessIsTemporary <span class="token operator">=</span>
                    mAppliedTemporaryBrightness <span class="token operator">||</span> mAppliedTemporaryAutoBrightnessAdjustment<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 最终会调用 animateScreenBrightness() 方法去设置亮度</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>initialRampSkip <span class="token operator">||</span> hasBrightnessBuckets
                    <span class="token operator">||</span> wasOrWillBeInVr <span class="token operator">||</span> <span class="token operator">!</span>isDisplayContentVisible <span class="token operator">||</span> brightnessIsTemporary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">animateScreenBrightness</span><span class="token punctuation">(</span>brightness<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">animateScreenBrightness</span><span class="token punctuation">(</span>brightness<span class="token punctuation">,</span>
                        slowChange <span class="token operator">?</span> mBrightnessRampRateSlow <span class="token operator">:</span> mBrightnessRampRateFast<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>brightnessIsTemporary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">notifyBrightnessChanged</span><span class="token punctuation">(</span>brightness<span class="token punctuation">,</span> userInitiatedChange<span class="token punctuation">,</span> hadUserBrightnessPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span>

</code></pre>
<h2 id="2-9-updateUserSetScreenBrightness"><a href="#2-9-updateUserSetScreenBrightness" class="headerlink" title="2.9 updateUserSetScreenBrightness"></a>2.9 updateUserSetScreenBrightness</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">updateUserSetScreenBrightness</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 根据 mPendingScreenBrightnessSetting 的值做不同的处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingScreenBrightnessSetting <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentScreenBrightnessSetting <span class="token operator">==</span> mPendingScreenBrightnessSetting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPendingScreenBrightnessSetting <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mCurrentScreenBrightnessSetting <span class="token operator">=</span> mPendingScreenBrightnessSetting<span class="token punctuation">;</span>
        mLastUserSetScreenBrightness <span class="token operator">=</span> mPendingScreenBrightnessSetting<span class="token punctuation">;</span>
        mPendingScreenBrightnessSetting <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="2-10-mPendingScreenBrightnessSetting"><a href="#2-10-mPendingScreenBrightnessSetting" class="headerlink" title="2.10 mPendingScreenBrightnessSetting"></a>2.10 mPendingScreenBrightnessSetting</h2><p><code>mPendingScreenBrightnessSetting</code> 是从哪边获取的？它是通过 <code>SettingsObserver</code> 监测 <code>Settings</code> 数据库中的值得到的。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSettingsChange</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> userSwitch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPendingScreenBrightnessSetting <span class="token operator">=</span> <span class="token function">getScreenBrightnessSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">sendUpdatePowerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getScreenBrightnessSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> brightness <span class="token operator">=</span> Settings<span class="token punctuation">.</span>System<span class="token punctuation">.</span><span class="token function">getIntForUser</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Settings<span class="token punctuation">.</span>System<span class="token punctuation">.</span>SCREEN_BRIGHTNESS<span class="token punctuation">,</span> mScreenBrightnessDefault<span class="token punctuation">,</span>
                UserHandle<span class="token punctuation">.</span>USER_CURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">clampAbsoluteBrightness</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h1 id="三、自动调节亮度"><a href="#三、自动调节亮度" class="headerlink" title="三、自动调节亮度"></a>三、自动调节亮度</h1><h2 id="3-1-创建背光样条曲线"><a href="#3-1-创建背光样条曲线" class="headerlink" title="3.1 创建背光样条曲线"></a>3.1 创建背光样条曲线</h2><p>在 <code>Android 9.0</code> 中，自动背光曲线的创建放在了 <code>BrightnessMappingStrategy</code> 中，当系统启动后，进入 <code>DisplayPowerController</code> 构造方法后，就会开始<code>创建背光曲线</code>。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token comment" spellcheck="true">/**
     * Creates the display power controller.
     */</span>
    <span class="token keyword">public</span> <span class="token function">DisplayPowerController</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span>
            DisplayPowerCallbacks callbacks<span class="token punctuation">,</span> Handler handler<span class="token punctuation">,</span>
            SensorManager sensorManager<span class="token punctuation">,</span> DisplayBlanker blanker<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mUseSoftwareAutoBrightnessConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment" spellcheck="true">// 获取映射 Lux-Nits-Backlight 值的对象</span>
            mBrightnessMapper <span class="token operator">=</span> BrightnessMappingStrategy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-1-1-BrightnessMappingStrategy"><a href="#3-1-1-BrightnessMappingStrategy" class="headerlink" title="3.1.1 BrightnessMappingStrategy"></a>3.1.1 BrightnessMappingStrategy</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> BrightnessMappingStrategy <span class="token function">create</span><span class="token punctuation">(</span>Resources resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Lux 值的数组，getLuxLevels() 中会将 Lux[0] = 0</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> luxLevels <span class="token operator">=</span> <span class="token function">getLuxLevels</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">getIntArray</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>config_autoBrightnessLevels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Lux 值对应的背光值，Android 9.0 中将不会再使用它</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> brightnessLevelsBacklight <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">getIntArray</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>config_autoBrightnessLcdBacklightValues<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//描述和 Lux 值对应的屏幕亮度的 Nits 值数组，长度比 Lux 值数组大 1。如果配置了该值，则：</span>
        <span class="token comment" spellcheck="true">// ---config_screenBrightnessNits 必须配置</span>
        <span class="token comment" spellcheck="true">// ---config_screenBrightnessBacklight 必须配置</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> brightnessLevelsNits <span class="token operator">=</span> <span class="token function">getFloatArray</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">obtainTypedArray</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>config_autoBrightnessDisplayValuesNits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 用户可调整的最大 Gama 值</span>
        <span class="token keyword">float</span> autoBrightnessAdjustmentMaxGamma <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">getFraction</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>fraction<span class="token punctuation">.</span>config_autoBrightnessAdjustmentMaxGamma<span class="token punctuation">,</span>
                <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 描述屏幕亮度的 nits 值数组</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nitsRange <span class="token operator">=</span> <span class="token function">getFloatArray</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">obtainTypedArray</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>config_screenBrightnessNits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 描述与 nitsRange 数组中的亮度值(单位为 Nits)相对应的屏幕背光值</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> backlightRange <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">getIntArray</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>config_screenBrightnessBacklight<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 判断是否是有效映射</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidMapping</span><span class="token punctuation">(</span>nitsRange<span class="token punctuation">,</span> backlightRange<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token function">isValidMapping</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> brightnessLevelsNits<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment" spellcheck="true">// 最小背光值 6</span>
            <span class="token keyword">int</span> minimumBacklight <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>integer<span class="token punctuation">.</span>config_screenBrightnessSettingMinimum<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 最大背光值 255</span>
            <span class="token keyword">int</span> maximumBacklight <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
                    com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>integer<span class="token punctuation">.</span>config_screenBrightnessSettingMaximum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>backlightRange<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> minimumBacklight
                    <span class="token operator">||</span> backlightRange<span class="token punctuation">[</span>backlightRange<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> maximumBacklight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Screen brightness mapping does not cover whole range of available "</span> <span class="token operator">+</span>
                        <span class="token string">"backlight values, autobrightness functionality may be impaired."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 获取 BrightnessConfiguration.Builder 实例</span>
            BrightnessConfiguration<span class="token punctuation">.</span>Builder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrightnessConfiguration<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将读取的 Lux 值和 nits 值保存在 builder 对象中</span>
            builder<span class="token punctuation">.</span><span class="token function">setCurve</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> brightnessLevelsNits<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 映射 Lux 值和 Nits 值，而非 Lux 值和直接显示的背光值，物理映射</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PhysicalMappingStrategy</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nitsRange<span class="token punctuation">,</span> backlightRange<span class="token punctuation">,</span>
                    autoBrightnessAdjustmentMaxGamma<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidMapping</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> brightnessLevelsBacklight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 直接映射 Lux 值和背光值，简单映射</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleMappingStrategy</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> brightnessLevelsBacklight<span class="token punctuation">,</span>
                    autoBrightnessAdjustmentMaxGamma<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-1-2-PhysicalMappingStrategy"><a href="#3-1-2-PhysicalMappingStrategy" class="headerlink" title="3.1.2 PhysicalMappingStrategy"></a>3.1.2 PhysicalMappingStrategy</h3><p>接下来进入到物理映射关系对象 <code>PhysicalMappingStrategy</code> 的创建，看其构造方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PhysicalMappingStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">BrightnessMappingStrategy</span> <span class="token punctuation">{</span>

        <span class="token keyword">public</span> <span class="token function">PhysicalMappingStrategy</span><span class="token punctuation">(</span>BrightnessConfiguration config<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nits<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> backlight<span class="token punctuation">,</span> <span class="token keyword">float</span> maxGamma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            mMaxGamma <span class="token operator">=</span> maxGamma<span class="token punctuation">;</span>
            mAutoBrightnessAdjustment <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 自动亮度调节值</span>
            mUserLux <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 在自动背光开启的情况下，用户手动调节亮度时的当前 Lux 值</span>
            mUserBrightness <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// 在自动背光开启的情况下，用户手动调节设置的亮度</span>

            <span class="token comment" spellcheck="true">// Setup the backlight spline</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> nits<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> normalizedBacklight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">float</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 将背光值/255后，存储在 normalizedBacklight 数组中</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                normalizedBacklight<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">normalizeAbsoluteBrightness</span><span class="token punctuation">(</span>backlight<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 创建 Nits-Backlight 样条曲线</span>
            mNitsToBacklightSpline <span class="token operator">=</span> Spline<span class="token punctuation">.</span><span class="token function">createSpline</span><span class="token punctuation">(</span>nits<span class="token punctuation">,</span> normalizedBacklight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 创建 Backlight-Nits 样条曲线</span>
            mBacklightToNitsSpline <span class="token operator">=</span> Spline<span class="token punctuation">.</span><span class="token function">createSpline</span><span class="token punctuation">(</span>normalizedBacklight<span class="token punctuation">,</span> nits<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mDefaultConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                PLOG<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"physical mapping strategy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>
            <span class="token function">computeSpline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">// 将根据不同的场景，创建 Lux-Nits 样条曲线</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-1-3-computeSpline"><a href="#3-1-3-computeSpline" class="headerlink" title="3.1.3 computeSpline"></a>3.1.3 computeSpline</h3><p><code>computeSpline()</code> 是很重要的一个方法，这个方法中除了创建另外一条 <code>Lux-Nits 曲线</code>外，还会根据用户当前对亮度的调整，插入用户调整后的值，并<code>调整 Lux-Nits 曲线</code>。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">computeSpline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 得到 BrightnessConfiguration 中的 Lux 数组和 Lux 值对应的 Nits 数组，并放入 Pair 对象中</span>
        Pair<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> defaultCurve <span class="token operator">=</span> mConfig<span class="token punctuation">.</span><span class="token function">getCurve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Lux 数组</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> defaultLux <span class="token operator">=</span> defaultCurve<span class="token punctuation">.</span>first<span class="token punctuation">;</span>    
        <span class="token comment" spellcheck="true">// 和 Lux 数组映射的 Nits 数组</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> defaultNits <span class="token operator">=</span> defaultCurve<span class="token punctuation">.</span>second<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 创建一个和 defaultNits 数组等长的数组，用来存放对应的背光值，从 Nits-backlights 曲线中获取</span>
        <span class="token comment" spellcheck="true">// 根据 Lux-Nit 值，从 NitsToBacklight 曲线中获取背光值</span>
        <span class="token comment" spellcheck="true">// 即根据 config_autoBrightnessDisplayValuesNits 值从 config_screenBrightnessNits</span>
        <span class="token comment" spellcheck="true">// 与 config_screenBrightnessBacklight 的曲线中获取默认的背光值</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> defaultBacklight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">float</span><span class="token punctuation">[</span>defaultNits<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> defaultBacklight<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            defaultBacklight<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> mNitsToBacklightSpline<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>defaultNits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 对得到的默认背光值进一步加工，如果用户设置过亮度，需要将用户设置的亮度值添加进曲线，得到</span>
        <span class="token comment" spellcheck="true">// 调整后的 Lux 值数组和 backlight 值数组</span>
        Pair<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> curve <span class="token operator">=</span> <span class="token function">getAdjustedCurve</span><span class="token punctuation">(</span>defaultLux<span class="token punctuation">,</span> defaultBacklight<span class="token punctuation">,</span> mUserLux<span class="token punctuation">,</span>
                mUserBrightness<span class="token punctuation">,</span> mAutoBrightnessAdjustment<span class="token punctuation">,</span> mMaxGamma<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 最终的 Lux 值和背光值</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lux <span class="token operator">=</span> curve<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> backlight <span class="token operator">=</span> curve<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">float</span><span class="token punctuation">[</span>backlight<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 根据背光值，从 config_screenBrightnessNits 和 config_screenBrightnessBacklight 构建的</span>
        <span class="token comment" spellcheck="true">// mBacklightToNitsSpline 曲线中获取 Nit 值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nits<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> mBacklightToNitsSpline<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>backlight<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Lux-Nits 曲线，最终的背光值从此 mNitsToBacklightSpline 曲线获取</span>
        mBrightnessSpline <span class="token operator">=</span> Spline<span class="token punctuation">.</span><span class="token function">createSpline</span><span class="token punctuation">(</span>lux<span class="token punctuation">,</span> nits<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="3-2-AutomaticBrightnessController"><a href="#3-2-AutomaticBrightnessController" class="headerlink" title="3.2 AutomaticBrightnessController"></a>3.2 AutomaticBrightnessController</h2><h3 id="3-2-1-初始化"><a href="#3-2-1-初始化" class="headerlink" title="3.2.1 初始化"></a>3.2.1 初始化</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token comment" spellcheck="true">// 获取映射 Lux-Nits-Backlight 值的对象</span>
    mBrightnessMapper <span class="token operator">=</span> BrightnessMappingStrategy<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 初始化 AutomaticBrightnessController</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBrightnessMapper <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 实例化自动背光控制器</span>
        mAutomaticBrightnessController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutomaticBrightnessController</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sensorManager<span class="token punctuation">,</span> mBrightnessMapper<span class="token punctuation">,</span>
                lightSensorWarmUpTimeConfig<span class="token punctuation">,</span> mScreenBrightnessRangeMinimum<span class="token punctuation">,</span>
                mScreenBrightnessRangeMaximum<span class="token punctuation">,</span> dozeScaleFactor<span class="token punctuation">,</span> lightSensorRate<span class="token punctuation">,</span>
                initialLightSensorRate<span class="token punctuation">,</span> brighteningLightDebounce<span class="token punctuation">,</span> darkeningLightDebounce<span class="token punctuation">,</span>
                autoBrightnessResetAmbientLuxAfterWarmUp<span class="token punctuation">,</span> hysteresisLevels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mUseSoftwareAutoBrightnessConfig <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-2-2-配置"><a href="#3-2-2-配置" class="headerlink" title="3.2.2 配置"></a>3.2.2 配置</h3><p>在 <code>DisplayPowerController</code> 中，每一次调用 <code>updatePowerState()</code> 更新状态时，都会对 <code>AutomaticBrightnessController</code> 进行配置。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updatePowerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">boolean</span> hadUserBrightnessPoint <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Configure auto-brightness.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAutomaticBrightnessController <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 曲线中是否有用户设置的短期点</span>
            hadUserBrightnessPoint <span class="token operator">=</span> mAutomaticBrightnessController<span class="token punctuation">.</span><span class="token function">hasUserDataPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 配置 mAutomaticBrightnessController</span>
            mAutomaticBrightnessController<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>autoBrightnessEnabled<span class="token punctuation">,</span>
                    mBrightnessConfiguration<span class="token punctuation">,</span>
                    mLastUserSetScreenBrightness <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> PowerManager<span class="token punctuation">.</span>BRIGHTNESS_ON<span class="token punctuation">,</span>
                    userSetBrightnessChanged<span class="token punctuation">,</span> autoBrightnessAdjustment<span class="token punctuation">,</span>
                    autoBrightnessAdjustmentChanged<span class="token punctuation">,</span> mPowerRequest<span class="token punctuation">.</span>policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span>
</code></pre>
<p>在以上逻辑中，<code>hadUserBrightnessPoint</code> 表示是否在自动背光打开的情况下拖动亮度条调节过亮度，判断依据是 <code>BrightnessMappingStrategy</code> 中的 <code>mUserLux</code> 成员，它表示用户在开启自动背光后手动设置亮度时的<code>Lux</code>值。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasUserDataPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mBrightnessMapper<span class="token punctuation">.</span><span class="token function">hasUserDataPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasUserDataPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mUserLux <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-2-3-configure"><a href="#3-2-3-configure" class="headerlink" title="3.2.3 configure"></a>3.2.3 configure</h3><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token comment" spellcheck="true">/**
     * @param enable：自动背光功能是否可用
     * @param configuration：BrightnessConfiguration 对象
     * @param brightness：当前背光值/255的形式
     * @param userChangedBrightness：用户是否改变过背光值
     * @param adjustment：自动背光调节值
     * @param userChangedAutoBrightnessAdjustment：用户是否改变过自动背光调节值
     * @param displayPolicy：PMS 中要请求的 Diplay 状态值
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enable<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> BrightnessConfiguration configuration<span class="token punctuation">,</span>
            <span class="token keyword">float</span> brightness<span class="token punctuation">,</span> <span class="token keyword">boolean</span> userChangedBrightness<span class="token punctuation">,</span> <span class="token keyword">float</span> adjustment<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> userChangedAutoBrightnessAdjustment<span class="token punctuation">,</span> <span class="token keyword">int</span> displayPolicy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 是否屏幕要进入 Doze 状态</span>
        <span class="token keyword">boolean</span> dozing <span class="token operator">=</span> <span class="token punctuation">(</span>displayPolicy <span class="token operator">==</span> DisplayPowerRequest<span class="token punctuation">.</span>POLICY_DOZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置 BrightnessConfigure 对象，若 BrightnessConfigure 发生改变，返回 true</span>
        <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token function">setBrightnessConfiguration</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置 Display 状态，若发生改变，返回 true</span>
        changed <span class="token operator">|=</span> <span class="token function">setDisplayPolicy</span><span class="token punctuation">(</span>displayPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 如果用户改变自动背光调节值，设置自动背光调节值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userChangedAutoBrightnessAdjustment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            changed <span class="token operator">|=</span> <span class="token function">setAutoBrightnessAdjustment</span><span class="token punctuation">(</span>adjustment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 如果在自动亮度开启的情况下调节了亮度，需要将当前的 Lux 值和用户设置的亮度添加到曲线中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userChangedBrightness <span class="token operator">&amp;&amp;</span> enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Update the brightness curve with the new user control point. It's critical this</span>
            <span class="token comment" spellcheck="true">// happens after we update the autobrightness adjustment since it may reset it.</span>
            changed <span class="token operator">|=</span> <span class="token function">setScreenBrightnessByUser</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> userInitiatedChange <span class="token operator">=</span>
                userChangedBrightness <span class="token operator">||</span> userChangedAutoBrightnessAdjustment<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userInitiatedChange <span class="token operator">&amp;&amp;</span> enable <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dozing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 做旧值的记录</span>
            <span class="token function">prepareBrightnessAdjustmentSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 注册解除注册 LSensor</span>
        changed <span class="token operator">|=</span> <span class="token function">setLightSensorEnabled</span><span class="token punctuation">(</span>enable <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dozing<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果 changed 为 true，更新自动背光亮度值，但不会主动调用 DPC 更新背光</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">updateAutoBrightness</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment" spellcheck="true">/*sendUpdate*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>在 <code>config</code> 方法中，囊括了所有的配置，我们对这些配置进行拆分，逐个分析。</p>
<h3 id="3-2-4-setBrightnessConfiguration"><a href="#3-2-4-setBrightnessConfiguration" class="headerlink" title="3.2.4 setBrightnessConfiguration"></a>3.2.4 setBrightnessConfiguration</h3><p>这个方法负责配置当前自动背光的 <code>BrighnessConfiguration</code> 对象，在前面也说了，这个对象中带有 <code>Lux</code> 值和 <code>Nits</code> 值，用来<code>创建曲线</code>和<code>获取背光值</code>。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setBrightnessConfiguration</span><span class="token punctuation">(</span>BrightnessConfiguration configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBrightnessMapper<span class="token punctuation">.</span><span class="token function">setBrightnessConfiguration</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果 config 对象发生改变，重置用户设置的曲线点</span>
            <span class="token function">resetShortTermModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这个方法中，又调用进入了 <code>mBrightnessMapper</code> 中，看下源码：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setBrightnessConfiguration</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> BrightnessConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> mDefaultConfig<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PLOG<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"brightness configuration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果 config 对象发生改变，则替换后，调用 computeSpline 重新创建 Lux-Nits 曲线</span>
        mConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>
        <span class="token function">computeSpline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>从以上方法中得知，如果 <code>BrightnessConfiguration</code> 对象发生改变，则会根据 <code>BrightnessConfiguration</code> 中携带的 <code>Lux</code> 和 <code>Nit</code> 值数组重新创建曲线，并清除之前用户的设置。</p>
<p>那么 <code>BrightnessConfiguration</code> 何时会改变呢？答案是：<code>切换一个新用户后</code>。在 <code>Android 9.0</code>中，针对每个用户，都会有一个 <code>BrightnessConfiguration</code> 和<code>映射</code>，所以当<code>切换用户</code>后，设备的<code>背光将可能发生改变</code>。</p>
<p>当 <code>BrightnessConfiguration</code> 发生改变且在 <code>BrighnessMappingStragety</code> 中设置完成后，将会通过 <code>resetShortTermModel()</code> 清除原有用户的配置:</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resetShortTermModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBrightnessMapper<span class="token punctuation">.</span><span class="token function">clearUserDataPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 清除用户添加的曲线点</span>
        mShortTermModelValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">// 表示短期模型仍旧有效</span>
        mShortTermModelAnchor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>看下 <code>clearUserDataPoints</code> 方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearUserDataPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mUserLux <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAutoBrightnessAdjustment <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 恢复自动背光调节值为 0</span>
            mUserLux <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// 用户设置亮度时 Lux 值</span>
            mUserBrightness <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// 用户设置亮度</span>
            <span class="token function">computeSpline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 重新创建曲线</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-2-5-setDisplayPolicy"><a href="#3-2-5-setDisplayPolicy" class="headerlink" title="3.2.5 setDisplayPolicy"></a>3.2.5 setDisplayPolicy</h3><p>这个方法主要根据屏幕状态来设置 <code>mShortTermModelValid</code> 的值。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setDisplayPolicy</span><span class="token punctuation">(</span><span class="token keyword">int</span> policy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDisplayPolicy <span class="token operator">==</span> policy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> oldPolicy <span class="token operator">=</span> mDisplayPolicy<span class="token punctuation">;</span>
        mDisplayPolicy <span class="token operator">=</span> policy<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Display policy transitioning from "</span> <span class="token operator">+</span> oldPolicy <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果 Display 状态值由交互变为不可交互状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInteractivePolicy</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isInteractivePolicy</span><span class="token punctuation">(</span>oldPolicy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 发送一个 30s 的延迟消息，30s 后将 mShortTermModelValid 置为 false</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessageDelayed</span><span class="token punctuation">(</span>MSG_INVALIDATE_SHORT_TERM_MODEL<span class="token punctuation">,</span>
                    SHORT_TERM_MODEL_TIMEOUT_MILLIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果 Display 状态值由不可交互变为交互状态，移除延时消息的发送</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInteractivePolicy</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isInteractivePolicy</span><span class="token punctuation">(</span>oldPolicy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>MSG_INVALIDATE_SHORT_TERM_MODEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>从这个方法中可以看出，当屏幕状态进入 <code>Doze</code> 或者 <code>Asleep</code> 后，会发送一个定义 <code>Handler</code>，并在到达时间后将 <code>mShortTermModelValid</code> 值置为 <code>false</code>。</p>
<h3 id="3-2-6-setAutoBrightnessAdjustment"><a href="#3-2-6-setAutoBrightnessAdjustment" class="headerlink" title="3.2.6 setAutoBrightnessAdjustment"></a>3.2.6 setAutoBrightnessAdjustment</h3><p>这个方法用来设置自动背光调整值，前提是自动背光调整值已经发生变化。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setAutoBrightnessAdjustment</span><span class="token punctuation">(</span><span class="token keyword">float</span> adjustment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mBrightnessMapper<span class="token punctuation">.</span><span class="token function">setAutoBrightnessAdjustment</span><span class="token punctuation">(</span>adjustment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>我们发现其调用到了 <code>BrightnessMappingStragety</code> 的同名方法中。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setAutoBrightnessAdjustment</span><span class="token punctuation">(</span><span class="token keyword">float</span> adjustment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 对 adjust 进行限制，取值范围为 [-1,1]</span>
        adjustment <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>adjustment<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adjustment <span class="token operator">==</span> mAutoBrightnessAdjustment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mAutoBrightnessAdjustment <span class="token operator">=</span> adjustment<span class="token punctuation">;</span>
        <span class="token function">computeSpline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 重新创建曲线</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-2-7-setScreenBrightnessByUser"><a href="#3-2-7-setScreenBrightnessByUser" class="headerlink" title="3.2.7 setScreenBrightnessByUser"></a>3.2.7 setScreenBrightnessByUser</h3><p>这个方法用于将用户拖动亮度条设置的亮度和当时的 <code>Lux</code> 值添加到用于创建曲线的数组中，并重新创建曲线。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setScreenBrightnessByUser</span><span class="token punctuation">(</span><span class="token keyword">float</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAmbientLuxValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If we don't have a valid ambient lux then we don't have a valid brightness anyways,</span>
            <span class="token comment" spellcheck="true">// and we can't use this data to add a new control point to the short-term model.</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 将当前的 Lux 值和用户设置的背光值添加到曲线中</span>
        mBrightnessMapper<span class="token punctuation">.</span><span class="token function">addUserDataPoint</span><span class="token punctuation">(</span>mAmbientLux<span class="token punctuation">,</span> brightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mShortTermModelValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//设置 mShortTermModelAnchor 为当前 Lux 值</span>
        mShortTermModelAnchor <span class="token operator">=</span> mAmbientLux<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="3-2-8-prepareBrightnessAdjustmentSample"><a href="#3-2-8-prepareBrightnessAdjustmentSample" class="headerlink" title="3.2.8 prepareBrightnessAdjustmentSample"></a>3.2.8 prepareBrightnessAdjustmentSample</h3><p>这个方法主要是当配置元素发生改变后，对旧值做一个记录，并打印一些 Log。</p>
<h3 id="3-2-9-setLightSensorEnabled"><a href="#3-2-9-setLightSensorEnabled" class="headerlink" title="3.2.9 setLightSensorEnabled"></a>3.2.9 setLightSensorEnabled</h3><p>这个方法负责 <code>LightSensor</code> 的<code>注册</code>和<code>解除注册</code>，当设备处于亮屏状态且打开自动背光功能时，将注册一个 <code>LightSensor</code>，以监听环境光的强度变化。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setLightSensorEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mLightSensorEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 表示 LSensor 启用</span>
                mLightSensorEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// LSensor开启的时间</span>
                mLightSensorEnableTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 当前 LSensor 的事件速率</span>
                mCurrentLightSensorRate <span class="token operator">=</span> mInitialLightSensorRate<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 注册 LSensor</span>
                mSensorManager<span class="token punctuation">.</span><span class="token function">registerListener</span><span class="token punctuation">(</span>mLightSensorListener<span class="token punctuation">,</span> mLightSensor<span class="token punctuation">,</span>
                        mCurrentLightSensorRate <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mLightSensorEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLightSensorEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mAmbientLuxValid <span class="token operator">=</span> <span class="token operator">!</span>mResetAmbientLuxAfterWarmUpConfig<span class="token punctuation">;</span>
            mRecentLightSamples <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            mAmbientLightRingBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCurrentLightSensorRate <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>MSG_UPDATE_AMBIENT_LUX<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mSensorManager<span class="token punctuation">.</span><span class="token function">unregisterListener</span><span class="token punctuation">(</span>mLightSensorListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>当环境光强度发生变化后，将回调 <code>mLightSensorListener</code> 接口的方法来更新：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> SensorEventListener mLightSensorListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SensorEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSensorChanged</span><span class="token punctuation">(</span>SensorEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLightSensorEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> time <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">float</span> lux <span class="token operator">=</span> event<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">handleLightSensorEvent</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> lux<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 处理 LSensor 上报事件</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAccuracyChanged</span><span class="token punctuation">(</span>Sensor sensor<span class="token punctuation">,</span> <span class="token keyword">int</span> accuracy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Not used.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="3-2-10-updateAutoBrightness"><a href="#3-2-10-updateAutoBrightness" class="headerlink" title="3.2.10 updateAutoBrightness"></a>3.2.10 updateAutoBrightness</h3><p>来看下 <code>configure</code> 中最后一个方法，这个方法用来更新最终计算的自动亮度。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateAutoBrightness</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> sendUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAmbientLuxValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 根据 Lux 值从样条曲线中获取对应的背光值，区间为 (0,1.0] 的浮点数</span>
        <span class="token keyword">float</span> value <span class="token operator">=</span> mBrightnessMapper<span class="token punctuation">.</span><span class="token function">getBrightness</span><span class="token punctuation">(</span>mAmbientLux<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 得到最终的自动背光值</span>
        <span class="token keyword">int</span> newScreenAutoBrightness <span class="token operator">=</span>
                <span class="token function">clampScreenBrightness</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>value <span class="token operator">*</span> PowerManager<span class="token punctuation">.</span>BRIGHTNESS_ON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScreenAutoBrightness <span class="token operator">!=</span> newScreenAutoBrightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mScreenAutoBrightness <span class="token operator">=</span> newScreenAutoBrightness<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 是否主动调用 DPC 进行背光的更新</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mCallbacks<span class="token punctuation">.</span><span class="token function">updateBrightness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>在这个方法中，我们发现：通过当前的 <code>Lux</code> 值从 <code>mBrightnessMapper</code> 中获取到了最终的背光值，也就是调用了 <code>getBrightness</code> 方法：</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getBrightness</span><span class="token punctuation">(</span><span class="token keyword">float</span> lux<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 先根据 Lux 值，从 mBrightnessSpline 曲线中寻找对应的 Nit 值</span>
        <span class="token keyword">float</span> nits <span class="token operator">=</span> mBrightnessSpline<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>lux<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 再根据 Nit 值，从 mNitsToBacklightSpline 曲线中寻找读应的背光值</span>
        <span class="token keyword">float</span> backlight <span class="token operator">=</span> mNitsToBacklightSpline<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>nits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> backlight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong>从这个方法可以得知读取自动背光值的原理:</strong></p>
<p>首先会根据当前的 <code>Lux</code> 值，从 <code>mBrightnessSpline</code> 曲线中寻找对应的 <code>Nit</code> 值，然后根据 <code>Nit</code> 值，从曲线 <code>mNitsToBacklightSpline</code> 中获取到最终的背光值。</p>
<h1 id="三、关于-adjustment-值的计算"><a href="#三、关于-adjustment-值的计算" class="headerlink" title="三、关于 adjustment 值的计算"></a>三、关于 adjustment 值的计算</h1><p>在 <code>Android 9.0</code> 中，它会直接设置用户选择的亮度值作为设备新的背光值，还会将此时的环境光强 Lux 值和设置的亮度值作为创建样条曲线的控制点添加到创建样条曲线的数组中，并重新创建样条曲线。</p>
<p>除此之外，在 <code>Android 9.0</code> 中，<code>自动背光的调整值将不再由用户主动设置</code>，而是<code>根据用户的调整自动进行推断得出</code>。</p>
<p>当通过<code>亮度条调节亮度</code>时，将调用进入 <code>DisplayPowerController</code>（以下简称 DPC）的 <code>setTemporaryAutoBrightnessAdjustment()</code> 方法，并执行<code>手动亮度调节流程</code>，然后执行<code>自动背光控制器的配置流程</code>。</p>
<p>由于用户对亮度的手动设置，因此将有：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;01. <code>mLastUserSetScreenBrightness</code> 发生改变，由默认 <code>0</code> 变为<code>用户设置的亮度值</code>；<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;02. <code>userSetBrightnessChanged</code> 由 <code>false</code> 变为 <code>true</code>。</p>
<p>此时这两个值已经发生改变，但其他值还未发生变化。</p>
<p>那么结合 <code>AutomaticBrightnessController</code>（以下简称 ABC）的配置，在调用 <code>configure()</code> 方法时将调用 <code>setScreenBrightnessByUser()</code> 方法用于将用户拖动亮度条设置的亮度和当时的 Lux 值添加到用于创建曲线的数组中，具体是调用 <code>BrigtnessMappingStrategy</code> 对象的 <code>addUserDataPoint()</code> 方法实现，而这个方法中，将会通过计算得出新的 <code>adjustment</code> 值来。</p>
<h2 id="3-1-addUserDataPoint"><a href="#3-1-addUserDataPoint" class="headerlink" title="3.1 addUserDataPoint"></a>3.1 addUserDataPoint</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUserDataPoint</span><span class="token punctuation">(</span><span class="token keyword">float</span> lux<span class="token punctuation">,</span> <span class="token keyword">float</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取默认配置值创建的曲线中 Lux 值对应的背光值</span>
        <span class="token keyword">float</span> unadjustedBrightness <span class="token operator">=</span> <span class="token function">getUnadjustedBrightness</span><span class="token punctuation">(</span>lux<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 通过传入的三个值推段自动背光调整值</span>
        <span class="token keyword">float</span> adjustment <span class="token operator">=</span> <span class="token function">inferAutoBrightnessAdjustment</span><span class="token punctuation">(</span>mMaxGamma<span class="token punctuation">,</span>
                brightness <span class="token comment" spellcheck="true">/* desiredBrightness */</span><span class="token punctuation">,</span>
                unadjustedBrightness <span class="token comment" spellcheck="true">/* currentBrightness */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 更新自动背光调整值</span>
        mAutoBrightnessAdjustment <span class="token operator">=</span> adjustment<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 表示用户在开启自动背光情况下拖动亮度条调节亮度时的当时 Lux 值</span>
        mUserLux <span class="token operator">=</span> lux<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 表示用户在开启自动背光情况下拖动亮度条调节亮度值</span>
        mUserBrightness <span class="token operator">=</span> brightness<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 重新创建曲线</span>
        <span class="token function">computeSpline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>在上面方法中，首先将从配置文件中的数组值创建的原始样条曲线中获取当前 Lux 的值，调用 <code>getUnadjustedBrightness</code> 方法。</p>
<h2 id="3-2-getUnadjustedBrightness"><a href="#3-2-getUnadjustedBrightness" class="headerlink" title="3.2 getUnadjustedBrightness"></a>3.2 getUnadjustedBrightness</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> <span class="token function">getUnadjustedBrightness</span><span class="token punctuation">(</span><span class="token keyword">float</span> lux<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 得到 BrightnessConfiguration 中的 Lux-Nit 映射</span>
        Pair<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> curve <span class="token operator">=</span> mConfig<span class="token punctuation">.</span><span class="token function">getCurve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 创建一个 Lux-Nit 样条曲线</span>
        Spline spline <span class="token operator">=</span> Spline<span class="token punctuation">.</span><span class="token function">createSpline</span><span class="token punctuation">(</span>curve<span class="token punctuation">.</span>first<span class="token punctuation">,</span> curve<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 根据 Lux 值得到 Nit 值，再根据 Nit 值从 mNitsToBacklightSpline 得到相对应的背光值</span>
        <span class="token keyword">return</span> mNitsToBacklightSpline<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>spline<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>lux<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="3-3-inferAutoBrightnessAdjustment"><a href="#3-3-inferAutoBrightnessAdjustment" class="headerlink" title="3.3 inferAutoBrightnessAdjustment"></a>3.3 inferAutoBrightnessAdjustment</h2><p>接下来开始计算自动背光调整值，调用 <code>inferAutoBrightnessAdjustment()</code>方法，并且将根据配置文件中的 <code>MaxGamma</code> 值、从原始样条曲线中获取的 <code>Lux</code> 对应的<code>背光值</code>以及<code>用户所希望要设置的背光值</code>，计算出 <code>adjustment</code>。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">float</span> <span class="token function">inferAutoBrightnessAdjustment</span><span class="token punctuation">(</span><span class="token keyword">float</span> maxGamma<span class="token punctuation">,</span>
            <span class="token keyword">float</span> desiredBrightness<span class="token punctuation">,</span> <span class="token keyword">float</span> currentBrightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">float</span> adjustment <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> gamma <span class="token operator">=</span> Float<span class="token punctuation">.</span>NaN<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 当前 Lux 值对应的默认配置亮度值 &lt;=25.5 || >= 229.5</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBrightness <span class="token operator">&lt;=</span> <span class="token number">0.1f</span> <span class="token operator">||</span> currentBrightness <span class="token operator">>=</span> <span class="token number">0.9f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            adjustment <span class="token operator">=</span> <span class="token punctuation">(</span>desiredBrightness <span class="token operator">-</span> currentBrightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 亮度：0，最低只能是 6</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>desiredBrightness <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            adjustment <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 最大亮度：255</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>desiredBrightness <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            adjustment <span class="token operator">=</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 根据换底公式，得到 currentBrightness 为底 desiredBrightness 的对数</span>
            gamma <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>desiredBrightness<span class="token punctuation">)</span> <span class="token operator">/</span> MathUtils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>currentBrightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// maxGamma 为底 gamma 的对数</span>
            adjustment <span class="token operator">=</span> <span class="token operator">-</span>MathUtils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gamma<span class="token punctuation">)</span> <span class="token operator">/</span> MathUtils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>maxGamma<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        adjustment <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>adjustment<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> adjustment<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>到这里，自动背光的调整值 <code>adjustment</code> 已经计算出了，接下来再看看有了 <code>adjustment</code> 后如何调整背光样条曲线。</p>
<h2 id="3-4-getAdjustedCurve"><a href="#3-4-getAdjustedCurve" class="headerlink" title="3.4 getAdjustedCurve"></a>3.4 getAdjustedCurve</h2><p>计算完毕 <code>adjustment</code> 后，会将用户设置的 <code>Lux</code> 和 <code>Brightness</code> 分别赋给 <code>BrightnessMappingStrategy</code> 对象成员 <code>mUserLux</code> 和 <code>mUserBrightness</code>，并调用 <code>computeSpline</code> 重新创建样条曲线，我们看看其中的 <code>getAdjustedCurve</code> 方法。</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> Pair<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">getAdjustedCurve</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lux<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> brightness<span class="token punctuation">,</span>
            <span class="token keyword">float</span> userLux<span class="token punctuation">,</span> <span class="token keyword">float</span> userBrightness<span class="token punctuation">,</span> <span class="token keyword">float</span> adjustment<span class="token punctuation">,</span> <span class="token keyword">float</span> maxGamma<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// 初始化两个新数组，分别存储 Lux 值和背光值</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newLux <span class="token operator">=</span> lux<span class="token punctuation">;</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newBrightness <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>brightness<span class="token punctuation">,</span> brightness<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 限定 adjustment 为 [-1,1]</span>
        adjustment <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">constrain</span><span class="token punctuation">(</span>adjustment<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// maxGamma 的 -adjustment 次方得到 gamma 值</span>
        <span class="token keyword">float</span> gamma <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>maxGamma<span class="token punctuation">,</span> <span class="token operator">-</span>adjustment<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// gamma != 1 说明 adjustment 不为 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gamma <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 重新设置亮度值，新的亮度值为就亮度值的 gamma 次方</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newBrightness<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newBrightness<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> MathUtils<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>newBrightness<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gamma<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 用户在 BrightnessController 拖动条上手动调节了亮度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userLux <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 插入一对新的 Lux 和对应背光值</span>
            Pair<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> curve <span class="token operator">=</span> <span class="token function">insertControlPoint</span><span class="token punctuation">(</span>newLux<span class="token punctuation">,</span> newBrightness<span class="token punctuation">,</span> userLux<span class="token punctuation">,</span>
                    userBrightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newLux <span class="token operator">=</span> curve<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
            newBrightness <span class="token operator">=</span> curve<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                PLOG<span class="token punctuation">.</span><span class="token function">logCurve</span><span class="token punctuation">(</span><span class="token string">"gamma and user adjusted curve"</span><span class="token punctuation">,</span> newLux<span class="token punctuation">,</span> newBrightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// This is done for comparison.</span>
                curve <span class="token operator">=</span> <span class="token function">insertControlPoint</span><span class="token punctuation">(</span>lux<span class="token punctuation">,</span> brightness<span class="token punctuation">,</span> userLux<span class="token punctuation">,</span> userBrightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
                PLOG<span class="token punctuation">.</span><span class="token function">logCurve</span><span class="token punctuation">(</span><span class="token string">"user adjusted curve"</span><span class="token punctuation">,</span> curve<span class="token punctuation">.</span>first <span class="token punctuation">,</span>curve<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Pair<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>newLux<span class="token punctuation">,</span> newBrightness<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>计算出新的背光值后，调用 <code>insertControlPoint()</code> 将用户设置的点作为曲线控制点插入相关数组中。</p>
<h2 id="3-5-insertControlPoint"><a href="#3-5-insertControlPoint" class="headerlink" title="3.5 insertControlPoint"></a>3.5 insertControlPoint</h2><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// frameworks/base/services/core/java/com/android/server/display/BrightnessMappingStrategy.java</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> Pair<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">insertControlPoint</span><span class="token punctuation">(</span>
            <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> luxLevels<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> brightnessLevels<span class="token punctuation">,</span> <span class="token keyword">float</span> lux<span class="token punctuation">,</span> <span class="token keyword">float</span> brightness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 找到插入点索引，以保持值的递增</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">findInsertionPoint</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> lux<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newLuxLevels<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newBrightnessLevels<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 如果插入索引等于数组长度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> luxLevels<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 需要插入到末尾位置，且新 Lux 数组长度比原来大 1</span>
            newLuxLevels <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> luxLevels<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newBrightnessLevels  <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>brightnessLevels<span class="token punctuation">,</span> brightnessLevels<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newLuxLevels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> lux<span class="token punctuation">;</span>
            newBrightnessLevels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> brightness<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>luxLevels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> lux<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果用户 lux 值已处于 Lux 值数组中</span>
            <span class="token comment" spellcheck="true">// copy 原数组即可</span>
            newLuxLevels <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> luxLevels<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newBrightnessLevels <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>brightnessLevels<span class="token punctuation">,</span> brightnessLevels<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newBrightnessLevels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> brightness<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 初始化新 Lux 数组，长度比原数组大 1</span>
            newLuxLevels <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>luxLevels<span class="token punctuation">,</span> luxLevels<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将原数组从 idx 位置起的元素，向后移动 1 位，将新的 Lux 值插入到 idx 位置</span>
            System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>newLuxLevels<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> newLuxLevels<span class="token punctuation">,</span> idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> luxLevels<span class="token punctuation">.</span>length <span class="token operator">-</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newLuxLevels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> lux<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 初始化新亮度值数组，长度比原数组大 1</span>
            newBrightnessLevels  <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>brightnessLevels<span class="token punctuation">,</span> brightnessLevels<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将原数组从 idx 位置起的元素，向后移动 1 位，将新的亮度值值插入到 idx 位置</span>
            System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>newBrightnessLevels<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> newBrightnessLevels<span class="token punctuation">,</span> idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
                    brightnessLevels<span class="token punctuation">.</span>length <span class="token operator">-</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newBrightnessLevels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> brightness<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 平滑曲线，newLuxLevels 之后的 Lux 对应的亮度值将全部为 newBrightnessLevels</span>
        <span class="token function">smoothCurve</span><span class="token punctuation">(</span>newLuxLevels<span class="token punctuation">,</span> newBrightnessLevels<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Pair<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>newLuxLevels<span class="token punctuation">,</span> newBrightnessLevels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>该方法调用完毕后，返回一个携带有 <code>Lux</code> 和背光值的 <code>Pair</code> 对象给 <code>getAdjustedCurve()</code>，在 <code>getAdjustedCurve()</code> 中将返回该 <code>Pair</code> 对象给到 <code>computeSpline()</code> 中，在 <code>computeSpline()</code> 将从返回的 <code>Pair</code> 对像中取出 <code>Lux</code> 数组值和背光数组值，完成曲线的创建。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://blog.csdn.net/FightFightFight/article/details/85797336" target="_blank" rel="noopener">01. Android 9.0 自动背光机制分析</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/05/31/2019.05.31-he-xin-ji-zhi-xi-lie-guan-yu-zi-dong-bei-guang-de-yuan-li/" class="b-link-green">关于 &#34;自动背光&#34; 的原理</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/06/06/2019.06.06-xing-neng-you-hua-xi-lie-nei-cun-xie-lou-de-qian-shi-jin-sheng/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/内存泄漏.jpg" class="responsive-img" alt="“内存泄漏” 的前世今生">
                        
                        <span class="card-title">“内存泄漏” 的前世今生</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">1. 基础了解1.1 什么是内存泄漏？内存泄漏是当程序不再使用到内存，释放内存失败而产生了无用的内存消耗。内存泄漏并不是指物理上的内存消失，这里的内存泄漏是指由程序分配的内存，由于程序逻辑错误而导致程序失去了对该内存的控制，使得内存浪费。
</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-06-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/性能优化/" class="post-category" target="_blank">
                                    性能优化
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/性能优化/" target="_blank">
                        <span class="chip bg-color">性能优化</span>
                    </a>
                    
                    <a href="/tags/内存泄漏/" target="_blank">
                        <span class="chip bg-color">内存泄漏</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/05/20/2019.05.20-he-xin-ji-zhi-xi-lie-jin-cheng-bei-sha-de-qian-yin-hou-guo/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/杀进程.jpg" class="responsive-img" alt="“进程被杀”的前因后果">
                        
                        <span class="card-title">“进程被杀”的前因后果</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">一、开篇1.1 核心源码


关键类
路径




Process.java
frameworks/base/core/java/android/os/Process.java


android_util_Process.cpp
fram</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-20
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/核心机制/" class="post-category" target="_blank">
                                    核心机制
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Process/" target="_blank">
                        <span class="chip bg-color">Process</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Thinking in Android<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    

</main>


<footer class="page-footer bg-color-foot-marco">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


<!--
    <a href="https://blog.csdn.net/pepsimaxin" class="tooltipped" data-tooltip="访问我的CSDN" data-position="top" data-delay="50">
        <i class="fa fa-chain-broken"></i>
    </a>
-->


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<!--<div class="progress-bar"></div>-->

<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;检索博文</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的技术关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<!--<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>-->


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>