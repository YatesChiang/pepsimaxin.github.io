<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="PackageManagerService 钻研（2）- 构造函数, Thinking in Android">
    <meta name="description" content="
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&amp;nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PackageManagerService 钻研（2）- 构造函数 | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/四大组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/系统启动/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/核心机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>机制</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>拓展</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术细节/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="检索博文"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/四大组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/系统启动/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/核心机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                机制
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                拓展
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        <li>
            <a href="/categories/技术细节/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/PackageManagerService.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        PackageManagerService 钻研（2）- 构造函数
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/PackageManagerService/" target="_blank">
                                <span class="chip bg-color">PackageManagerService</span>
                            </a>
                        
                            <a href="/tags/PMS-构造函数/" target="_blank">
                                <span class="chip bg-color">PMS 构造函数</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                框架服务
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;发布日期 :&nbsp;
                    2019-01-05
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;文章字数 :&nbsp;
                        5.1k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;阅读时长 :&nbsp;
                        26 分钟
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;阅读次数 :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<p><strong><center><font color="#3A5FCD" size="4">PackageManagerService 系列文章如下（基于 Android 9.0 源码）</font><center></center></center></strong><br></p>
<table>
<thead>
<tr>
<th style="text-align:center">&nbsp;</th>
<th style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（1）- 启动流程</font></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（2）- 构造函数</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（3）- PackageManager</font></a></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（4）- PackageInstaller</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（5）- APK 安装流程（1）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（6）- APK 安装流程（2）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（7）- PackageParser</font></a></td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong><font color="#3A5FCD" size="4">修订日志</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1、重新梳理 Android 9.0 源码中扫描系统 Apk 及非系统 Apk 的代码逻辑；</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2、细化源码，添加更为详细的注释说明；</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">3、新增流程图及时序图；</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">4、博文格式，文章排版优化；</font><br><br></p>
<hr>
<h1 id="一、开篇"><a href="#一、开篇" class="headerlink" title="一、开篇"></a>一、开篇</h1><h2 id="1-1-核心源码"><a href="#1-1-核心源码" class="headerlink" title="1.1 核心源码"></a>1.1 核心源码</h2><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">Process.java</font></td>
<td>frameworks/base/core/java/android/os/Process.java</td>
</tr>
<tr>
<td><font color="#D15FEE">Settings.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/Settings.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SystemConfig.java</font></td>
<td>frameworks/base/core/java/com/android/server/SystemConfig.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SystemServer.java</font></td>
<td>frameworks/base/services/java/com/android/server/SystemServer.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageManagerService.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td>
</tr>
</tbody>
</table>
<h2 id="1-2-回顾"><a href="#1-2-回顾" class="headerlink" title="1.2 回顾"></a>1.2 回顾</h2><p>在 PackageManagerService 系列第一篇中，我们将 <strong>“构造函数”</strong> 分成了两部分研究，如下：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">🍁 &nbsp;构造函数（1） - 前期准备工作</font></strong>&nbsp;<strong><font color="#FF0000">（分析完）</font></strong><a href="https://superandroid.pro/2019/01/01/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%881%EF%BC%89%E4%B9%8B%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">《Framework 核心服务之 PMS 钻研（1）- 启动流程》</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">🍁 &nbsp;构造函数（2） - 扫描 Package 和 扫尾工作</font></strong>&nbsp;<strong><font color="#FF0000">（本篇文章要讨论的内容）</font></strong><br><br></p>
<hr>
<h1 id="二、扫描-Package"><a href="#二、扫描-Package" class="headerlink" title="二、扫描 Package"></a>二、扫描 Package</h1><p>PMS 构造函数第二阶段（我们前面分析的 Settings 和 XML 解析作为构造函数的第一部分）的工作就是 <code>扫描系统中的 APK</code>了。由于需要逐个扫描文件，因此手机上装的程序越多，PMS 的工作量就越大，系统启动速度也就越慢，这就是为什么你的手机启动速度有快慢的原因<strong><font color="#0000FF">（所以优化开机启动速度，了解 PMS 也是很关键的）</font></strong>。</p>
<h2 id="2-1-第一阶段（剩余工作）"><a href="#2-1-第一阶段（剩余工作）" class="headerlink" title="2.1 第一阶段（剩余工作）"></a>2.1 第一阶段（剩余工作）</h2><p>接着前面的 PMS 构造函数继续分析源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// writer </span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        mFirstBoot <span class="token operator">=</span> <span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">readLPw</span><span class="token punctuation">(</span>sUserManager<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> packageSettingCount <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 清理那些代码路径不存在的异常 package</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> packageSettingCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isExternal</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ps<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>ps<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">requestCopyPreoptedFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 设置模块来代替 framework-res.apk 中缺省的 ResolverActivity</span>
        String customResolverActivity <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>config_customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            customResolverActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mCustomResolverComponentName <span class="token operator">=</span> ComponentName<span class="token punctuation">.</span><span class="token function">unflattenFromString</span><span class="token punctuation">(</span>
                    customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 记录扫描开始的时间</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 需要系统提前加载的一些 jar</span>
        <span class="token keyword">final</span> String bootClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"BOOTCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String systemServerClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SYSTEMSERVERCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 至此，第一阶段代码全部结束！</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-2-扫描系统-Package"><a href="#2-2-扫描系统-Package" class="headerlink" title="2.2 扫描系统 Package"></a>2.2 扫描系统 Package</h2><p>接下来看 PMS 第二阶段工作的核心内容，即 <code>扫描 Package</code>，源码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>　　　　<span class="token comment" spellcheck="true">// 第一阶段分析结束！</span>

    <span class="token comment" spellcheck="true">// 定义 frameworkDir 指向 /system/frameworks 目录</span>
    File frameworkDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"framework"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> VersionInfo ver <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getInternalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mIsUpgrade <span class="token operator">=</span> <span class="token operator">!</span>Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ver<span class="token punctuation">.</span>fingerprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token string">"Upgrading from "</span> <span class="token operator">+</span> 
                        ver<span class="token punctuation">.</span>fingerprint <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mPromoteSystemApps <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>LOLLIPOP_MR1<span class="token punctuation">;</span>
    mIsPreNUpgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">;</span>
    mIsPreNMR1Upgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N_MR1<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 是否需要提升权限</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPromoteSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> pkgSettingIter <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pkgSettingIter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageSetting ps <span class="token operator">=</span> pkgSettingIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystemApp</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 遍历 Settings::mPackages 集合，将系统 APP 加入到</span>
                <span class="token comment" spellcheck="true">// PackageManagerService::mExistingSystemPackages</span>
                mExistingSystemPackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mCacheDir <span class="token operator">=</span> <span class="token function">preparePackageParserCache</span><span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 定义扫描参数</span>
    <span class="token keyword">int</span> scanFlags <span class="token operator">=</span> SCAN_BOOTING <span class="token operator">|</span> SCAN_INITIAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">||</span> mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scanFlags <span class="token operator">=</span> scanFlags <span class="token operator">|</span> SCAN_FIRST_BOOT_OR_UPGRADE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// private static final String VENDOR_OVERLAY_DIR = "/vendor/overlay";</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>VENDOR_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// 扫描 /vendor/overlay 目录</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// private static final String PRODUCT_OVERLAY_DIR = "/product/overlay";</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>PRODUCT_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// 扫描 /product/overlay 目录</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mParallelPackageParserCallback<span class="token punctuation">.</span><span class="token function">findStaticOverlayPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Find base frameworks (resource packages without code).</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>frameworkDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// 扫描 /system/frameworks 目录</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_NO_DEX
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Collected privileged system packages.</span>
    <span class="token keyword">final</span> File privilegedAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"priv-app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">// 扫描 /system/priv-app 目录</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Collect ordinary system packages.</span>
    <span class="token keyword">final</span> File systemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// 扫描 /system/app 目录</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// Collect ordinary vendor packages.</span>
    File vendorAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        vendorAppDir <span class="token operator">=</span> vendorAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
    <span class="token punctuation">}</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// 扫描 /vendor/app 目录</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// Collect all OEM packages.</span>
    <span class="token keyword">final</span> File oemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">// 扫描 /oem/app 目录</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
｝
</code></pre>
<p>我们发现 PMS 扫描了很多目录，我们列举几个重点说明：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;<strong><code>/system/frameworks</code></strong> ：该目录中的文件都是系统库，例如：framework.jar、services.jar、framework-res.apk。不过 scanDirTracedLI 只扫描 APK 文件，所以 <code>framework-res.apk</code> 是该目录中唯一被扫描的文件。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;<strong><code>/system/app</code></strong> ：该目录下全是默认的系统应用。例如：Browser.apk、SettingsProvider.apk 等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;<strong><code>/vendor/app</code></strong> ：该目录中的文件由厂商提供，即全是厂商定制的 APK 文件。</p>
<h3 id="2-2-1-scanDirTracedLI"><a href="#2-2-1-scanDirTracedLI" class="headerlink" title="2.2.1 scanDirTracedLI"></a>2.2.1 scanDirTracedLI</h3><p>PMS 扫描目录统一调用 <code>scanDirTracedLI()</code> 方法（出现次数最多的也是最重要的函数），我们深入跟踪源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>File scanDir<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> 
                                          <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 跳转至 scanDirLI 方法</span>
        <span class="token function">scanDirLI</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-2-scanDirLI"><a href="#2-2-2-scanDirLI" class="headerlink" title="2.2.2 scanDirLI"></a>2.2.2 scanDirLI</h3><p>下面的重点就转移到 <code>scanDirLI()</code> 方法了：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanDirLI</span><span class="token punctuation">(</span>File scanDir<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 扫描该目录下所有后缀为 .apk 的文件</span>
    <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> scanDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No files in app dir "</span> <span class="token operator">+</span> scanDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ParallelPackageParser 是 Android 9.0　新增的一个类，我们可以理解它其实就是一个队列，</span>
    <span class="token comment" spellcheck="true">// 收集系统 apk 文件，然后从这个队列里面一个个取出 apk ，调用 PackageParser　解析！</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span>ParallelPackageParser parallelPackageParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParallelPackageParser</span><span class="token punctuation">(</span>
            mSeparateProcesses<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> mCacheDir<span class="token punctuation">,</span>
            mParallelPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Submit files for parsing in parallel    -->    收集 apk</span>
        <span class="token keyword">int</span> fileCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPackage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isApkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                       <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>PackageInstallerService<span class="token punctuation">.</span><span class="token function">isStageName</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 过滤掉非 apk 文件，如果不是则跳过继续扫描</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ignore entries which are not packages</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            parallelPackageParser<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fileCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Process results one by one              -->    解析 apk</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> fileCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> fileCount<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ParallelPackageParser<span class="token punctuation">.</span>ParseResult parseResult <span class="token operator">=</span> parallelPackageParser<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Throwable throwable <span class="token operator">=</span> parseResult<span class="token punctuation">.</span>throwable<span class="token punctuation">;</span>
            <span class="token keyword">int</span> errorCode <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Static shared libraries have synthetic package names</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">renameStaticSharedLibraryPackage</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">/*
                         * Android 9.0 调用 scanPackageChildLI，
                         * Android 8.0 调用 scanPackageLI，
                         * Android 7.0 调用 scanPackageTracedLI，
                         * 
                         * 调用 scanPackageChildLI 函数扫描一个特定的 apk 文件，
                         * 返回值是 PackageParser 的内部类 Package，
                         * 该类的实例代表一个 APK 文件，所以它就是和 apk 文件对应的数据结构。
                         */</span>
                        <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                                currentTime<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 扫描 APK 过程中发生异常</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    errorCode <span class="token operator">=</span> e<span class="token punctuation">.</span>error<span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to scan "</span> <span class="token operator">+</span> parseResult<span class="token punctuation">.</span>scanFile <span class="token operator">+</span> <span class="token string">": "</span> 
                                                              <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token keyword">instanceof</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>PackageParserException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Delete invalid userdata apps -- 如果解析失败，并且是非系统 apk</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    errorCode <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 非系统 Package 扫描失败，删除文件</span>
                <span class="token function">removeCodePathLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>继续分析 <code>scanPackageChildLI()</code> 方法之前，我们看看 9.0 新增的 <code>ParallelPackageParser</code> 这个类。</p>
<h4 id="2-2-2-1-ParallelPackageParser"><a href="#2-2-2-1-ParallelPackageParser" class="headerlink" title="2.2.2.1 ParallelPackageParser"></a>2.2.2.1 ParallelPackageParser</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Helper class for parallel parsing of packages using {@link PackageParser}.
 * &lt;p>Parsing requests are processed by a thread-pool of {@link #MAX_THREADS}.
 * At any time, at most {@link #QUEUE_CAPACITY} results are kept in RAM&lt;/p>
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ParallelPackageParser</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> BlockingQueue<span class="token operator">&lt;</span>ParseResult<span class="token operator">></span> mQueue <span class="token operator">=</span> 
                                             <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>QUEUE_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ParallelPackageParser</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> separateProcesses<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCoreApps<span class="token punctuation">,</span>
            DisplayMetrics metrics<span class="token punctuation">,</span> File cacheDir<span class="token punctuation">,</span> PackageParser<span class="token punctuation">.</span>Callback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mSeparateProcesses <span class="token operator">=</span> separateProcesses<span class="token punctuation">;</span>
        mOnlyCore <span class="token operator">=</span> onlyCoreApps<span class="token punctuation">;</span>
        mMetrics <span class="token operator">=</span> metrics<span class="token punctuation">;</span>
        mCacheDir <span class="token operator">=</span> cacheDir<span class="token punctuation">;</span>
        mPackageParserCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">/**
     * Submits the file for parsing
     * @param scanFile file to scan
     * @param parseFlags parse falgs
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            ParseResult pr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParseResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setOnlyCoreApps</span><span class="token punctuation">(</span>mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setCacheDir</span><span class="token punctuation">(</span>mCacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pr<span class="token punctuation">.</span>scanFile <span class="token operator">=</span> scanFile<span class="token punctuation">;</span>
                pr<span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token function">parsePackage</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pr<span class="token punctuation">.</span>throwable <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInterruptedInThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们再看下 <code>ParallelPackageParser</code> 的内部类 <code>ParseResult</code>。</p>
<h4 id="2-2-2-2-ParseResult"><a href="#2-2-2-2-ParseResult" class="headerlink" title="2.2.2.2 ParseResult"></a>2.2.2.2 ParseResult</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Helper class for parallel parsing of packages using {@link PackageParser}.
 * &lt;p>Parsing requests are processed by a thread-pool of {@link #MAX_THREADS}.
 * At any time, at most {@link #QUEUE_CAPACITY} results are kept in RAM&lt;/p>
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ParallelPackageParser</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ParseResult</span> <span class="token punctuation">{</span>

        PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Parsed package</span>
        File scanFile<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// File that was parsed</span>
        Throwable throwable<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Set if an error occurs during parsing</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">"ParseResult{"</span> <span class="token operator">+</span>　<span class="token string">"pkg="</span> <span class="token operator">+</span> pkg <span class="token operator">+</span>　<span class="token string">", scanFile="</span> <span class="token operator">+</span> scanFile <span class="token operator">+</span>
                    <span class="token string">", throwable="</span> <span class="token operator">+</span> throwable <span class="token operator">+</span>　<span class="token string">'}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Take the parsed package from the parsing queue, waiting if necessary until the element
     * appears in the queue.
     * @return parsed package
     */</span>
    <span class="token keyword">public</span> ParseResult <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInterruptedInThread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token string">"Interrupted in "</span> <span class="token operator">+</span> mInterruptedInThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We cannot recover from interrupt here</span>
            Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-3-scanPackageChildLI"><a href="#2-2-3-scanPackageChildLI" class="headerlink" title="2.2.3 scanPackageChildLI"></a>2.2.3 scanPackageChildLI</h3><p>源码中，如果 apk 文件没有问题，会走如下流程：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * Android 9.0 调用 scanPackageChildLI，
         * Android 8.0 调用 scanPackageLI，
         * Android 7.0 调用 scanPackageTracedLI，
         * 
         * 调用 scanPackageChildLI 函数扫描一个特定的 apk 文件，
         * 返回值是 PackageParser 的内部类 Package，
         * 该类的实例代表一个 APK 文件，所以它就是和 apk 文件对应的数据结构。
         *
         * PackageParser.Package pkg;    // Parsed package
         */</span>
        <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>　currentTime<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接下来的重点就是分析 <code>scanPackageChildLI()</code> 方法！</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 *  Scans a package and returns the newly parsed package. 
 *  扫描一个 apk 文件并返回 package！
 *  @throws PackageManagerException on a parse error.
 */</span>
<span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            scanFlags <span class="token operator">|=</span> SCAN_CHECK_ONLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        scanFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>SCAN_CHECK_ONLY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Scan the parent</span>
    PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> <span class="token function">addForInitLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span>
            scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Scan the children</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> childCount <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PackageParser<span class="token punctuation">.</span>Package childPackage <span class="token operator">=</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addForInitLI</span><span class="token punctuation">(</span>childPackage<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> scannedPkg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-4-addForInitLI"><a href="#2-2-4-addForInitLI" class="headerlink" title="2.2.4 addForInitLI"></a>2.2.4 addForInitLI</h3><p>继续跟踪源码，调用 <code>addForInitLI()</code> 方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">addForInitLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span>　<span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token keyword">boolean</span> scanSystemPartition <span class="token operator">=</span> <span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> 
                                         PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> String renamedPkgName<span class="token punctuation">;</span>
    <span class="token keyword">final</span> PackageSetting disabledPkgSetting<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isSystemPkgUpdated<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> pkgAlreadyExists<span class="token punctuation">;</span>
    PackageSetting pkgSetting<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">/* 
     * 判断系统 APK 是否需要更新
     * final ArrayMap&lt;String, PackageParser.Package> mPackages = 
     *                                      new ArrayMap&lt;String, PackageParser.Package>();
     */</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        renamedPkgName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mRealPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String realPkgName <span class="token operator">=</span> <span class="token function">getRealPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>realPkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensurePackageRenamed</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> PackageSetting originalPkgSetting <span class="token operator">=</span> 
                                           <span class="token function">getOriginalPackageLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> PackageSetting installedPkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkgSetting <span class="token operator">=</span> originalPkgSetting <span class="token operator">==</span> null <span class="token operator">?</span> installedPkgSetting <span class="token operator">:</span> originalPkgSetting<span class="token punctuation">;</span>
        pkgAlreadyExists <span class="token operator">=</span> pkgSetting <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">final</span> String disabledPkgName <span class="token operator">=</span> pkgAlreadyExists <span class="token operator">?</span> pkgSetting<span class="token punctuation">.</span>name <span class="token operator">:</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
        disabledPkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>disabledPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isSystemPkgUpdated <span class="token operator">=</span> disabledPkgSetting <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">final</span> SharedUserSetting sharedUserSetting <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                <span class="token operator">?</span> mSettings<span class="token punctuation">.</span><span class="token function">getSharedUserLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId<span class="token punctuation">,</span>
                        <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgFlags*/</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgPrivateFlags*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>scanSystemPartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSystemPkgUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> scannedChildCount <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                        <span class="token operator">?</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> disabledChildCount <span class="token operator">=</span> disabledPkgSetting<span class="token punctuation">.</span>childPackageNames <span class="token operator">!=</span> null
                        <span class="token operator">?</span> disabledPkgSetting<span class="token punctuation">.</span>childPackageNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> disabledChildCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
　　　　                String disabledChildPackageName <span class="token operator">=</span>
                            disabledPkgSetting<span class="token punctuation">.</span>childPackageNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> disabledPackageAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> scannedChildCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        PackageParser<span class="token punctuation">.</span>Package childPkg <span class="token operator">=</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>childPkg<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>disabledChildPackageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            disabledPackageAvailable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disabledPackageAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mSettings<span class="token punctuation">.</span><span class="token function">removeDisabledSystemPackageLPw</span><span class="token punctuation">(</span>disabledChildPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// we're updating the disabled package, so, scan it as the package setting</span>
                <span class="token keyword">final</span> ScanRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanRequest</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> sharedUserSetting<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        disabledPkgSetting <span class="token comment" spellcheck="true">/* pkgSetting */</span><span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/* disabledPkgSetting */</span><span class="token punctuation">,</span>
                        null <span class="token comment" spellcheck="true">/* originalPkgSetting */</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>pkg <span class="token operator">==</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">applyPolicy</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scanPackageOnlyLI</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mFactoryTest<span class="token punctuation">,</span> <span class="token operator">-</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newPkgChangedPaths <span class="token operator">=</span>
            pkgAlreadyExists <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newPkgVersionGreater <span class="token operator">=</span>
            pkgAlreadyExists <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> pkgSetting<span class="token punctuation">.</span>versionCode<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isSystemPkgBetter <span class="token operator">=</span> scanSystemPartition <span class="token operator">&amp;&amp;</span> isSystemPkgUpdated
            <span class="token operator">&amp;&amp;</span> newPkgChangedPaths <span class="token operator">&amp;&amp;</span> newPkgVersionGreater<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isSystemPkgBetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 更新安装包到系统分区中</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 从 PackageManagerService 的安装包列表中删除该包</span>
            mPackages<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 创建安装参数 InstallArgs</span>
        <span class="token keyword">final</span> InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgsForExisting</span><span class="token punctuation">(</span>
                <span class="token function">packageFlagsToInstallFlags</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">,</span>
                pkgSetting<span class="token punctuation">.</span>resourcePathString<span class="token punctuation">,</span> <span class="token function">getAppDexInstructionSets</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">cleanUpResourcesLI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 安装包校验</span>
    <span class="token function">collectCertificatesLI</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> forceCollect<span class="token punctuation">,</span> skipVerify<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * A new system app appeared, but we already had a non-system one of the
     * same name installed earlier.
     *
     * 当我们安装一个系统 apk 的时候，发现已经有了一个相同包名的 apk，
     * 而且这个相同包名 apk 是在非系统的分区中
     */</span>

    <span class="token keyword">boolean</span> shouldHideSystemApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// A new application appeared on /system, but, we already have a copy of</span>
    <span class="token comment" spellcheck="true">// the application installed on /data.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scanSystemPartition <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isSystemPkgUpdated <span class="token operator">&amp;&amp;</span> pkgAlreadyExists
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>
                PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>INSTALLED_DATA<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>
                                pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>
                                PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>ROLLBACK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> <span class="token string">"System package signature mismatch;"</span>
                                           <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span>PackageFreezer freezer <span class="token operator">=</span> <span class="token function">freezePackage</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    <span class="token string">"scanPackageInternalLI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果两个 apk 签名不匹配，则调用 deletePackageLI 方法清除 apk 文件及其数据</span>
                <span class="token function">deletePackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pkgSetting <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newPkgVersionGreater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The application on /system is newer than the application on /data.</span>
            <span class="token comment" spellcheck="true">// Simply remove the application on /data [keeping application data]</span>
            <span class="token comment" spellcheck="true">// and replace it with the version on /system.</span>
            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> <span class="token string">"System package enabled;"</span> <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name
                    <span class="token operator">+</span> <span class="token string">"; "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>versionCode <span class="token operator">+</span> <span class="token string">" --> "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">"; "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>codePathString <span class="token operator">+</span> <span class="token string">" --> "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 更新系统 apk 程序</span>
            InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgsForExisting</span><span class="token punctuation">(</span>
                    <span class="token function">packageFlagsToInstallFlags</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">,</span>
                    pkgSetting<span class="token punctuation">.</span>resourcePathString<span class="token punctuation">,</span> <span class="token function">getAppDexInstructionSets</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                args<span class="token punctuation">.</span><span class="token function">cleanUpResourcesLI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The application on /system is older than the application on /data. Hide</span>
            <span class="token comment" spellcheck="true">// the application on /system and the version on /data will be scanned later</span>
            <span class="token comment" spellcheck="true">// and re-added like an update.</span>
            shouldHideSystemApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>
                    <span class="token string">"System package disabled;"</span>
                    <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name
                    <span class="token operator">+</span> <span class="token string">"; old: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>codePathString <span class="token operator">+</span> <span class="token string">" @ "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>versionCode
                    <span class="token operator">+</span> <span class="token string">"; new: "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath <span class="token operator">+</span> <span class="token string">" @ "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 🔥 🔥 🔥 🔥 🔥 🔥 重点方法 🔥 🔥 🔥 🔥 🔥 🔥</span>
    <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> <span class="token function">scanPackageNewLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags
            <span class="token operator">|</span> SCAN_UPDATE_SIGNATURE<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果新安装的系统 APK 会被旧的 APK 数据覆盖，</span>
    <span class="token comment" spellcheck="true">// 所以需要隐藏隐藏系统应用程序，并重新扫描 /data/app 目录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldHideSystemApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSettings<span class="token punctuation">.</span><span class="token function">disableSystemPackageLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> scannedPkg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-5-scanPackageNewLI"><a href="#2-2-5-scanPackageNewLI" class="headerlink" title="2.2.5 scanPackageNewLI"></a>2.2.5 scanPackageNewLI</h3><p>我们再来看看 <code>scanPackageNewLI()</code> 方法源码！</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageNewLI</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token keyword">final</span> String renamedPkgName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mRealPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> String realPkgName <span class="token operator">=</span> <span class="token function">getRealPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>realPkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ensurePackageRenamed</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> PackageSetting originalPkgSetting <span class="token operator">=</span> 
                                           <span class="token function">getOriginalPackageLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> PackageSetting pkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> PackageSetting disabledPkgSetting <span class="token operator">=</span>
                         mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTransferedPackages<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName
                <span class="token operator">+</span> <span class="token string">" was transferred to another, but its .apk remains"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    scanFlags <span class="token operator">=</span> <span class="token function">adjustScanFlags</span><span class="token punctuation">(</span>scanFlags<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> disabledPkgSetting<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyPolicy</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertPackageIsValid</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        SharedUserSetting sharedUserSetting <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// SIDE EFFECTS; may potentially allocate a new shared user</span>
            sharedUserSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getSharedUserLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId<span class="token punctuation">,</span> 
                           <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgFlags*/</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgPrivateFlags*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*create*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PACKAGE_SCANNING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> PackageParser<span class="token punctuation">.</span>PARSE_CHATTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Shared UserID "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>mSharedUserId
                            <span class="token operator">+</span> <span class="token string">" (uid="</span> <span class="token operator">+</span> sharedUserSetting<span class="token punctuation">.</span>userId <span class="token operator">+</span> <span class="token string">"):"</span>
                            <span class="token operator">+</span> <span class="token string">" packages="</span> <span class="token operator">+</span> sharedUserSetting<span class="token punctuation">.</span>packages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> scanSucceeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ScanRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanRequest</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> sharedUserSetting<span class="token punctuation">,</span>
                    pkgSetting <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> pkgSetting<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> 
                    disabledPkgSetting<span class="token punctuation">,</span> originalPkgSetting<span class="token punctuation">,</span> realPkgName<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> 
                    scanFlags<span class="token punctuation">,</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ScanResult result <span class="token operator">=</span> <span class="token function">scanPackageOnlyLI</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mFactoryTest<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 将 pkg 中的数据保存到对应的 PMS 变量中，用于以后的管理查询调用等</span>
                <span class="token comment" spellcheck="true">// 🔥 🔥 🔥 🔥 🔥 🔥 重点方法 🔥 🔥 🔥 🔥 🔥 🔥</span>
                <span class="token function">commitScanResultsLocked</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            scanSucceeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scanSucceeded <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span>
                  <span class="token function">destroyAppDataLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">,</span>
                          StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_DE <span class="token operator">|</span> StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_CE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">destroyAppProfilesLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-5-commitScanResultsLocked"><a href="#2-2-5-commitScanResultsLocked" class="headerlink" title="2.2.5 commitScanResultsLocked"></a>2.2.5 commitScanResultsLocked</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitScanResultsLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ScanRequest request<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> ScanResult result<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPkgSetting <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>oldPkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">,</span> oldPkgSetting<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> user <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Modify state for the given package setting</span>
        <span class="token comment" spellcheck="true">// 将 pkg 中的数据保存到对应的 PMS 变量中，用于以后的管理查询调用等</span>
        <span class="token comment" spellcheck="true">// 🔥 🔥 🔥 🔥 🔥 🔥 重点方法 🔥 🔥 🔥 🔥 🔥 🔥</span>
        <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> oldPkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> user<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> PackageParser<span class="token punctuation">.</span>PARSE_CHATTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*chatty*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span><span class="token function">getInstantApp</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mInstantAppRegistry<span class="token punctuation">.</span><span class="token function">addInstantAppLPw</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-6-commitPackageSettings"><a href="#2-2-6-commitPackageSettings" class="headerlink" title="2.2.6 commitPackageSettings"></a>2.2.6 commitPackageSettings</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Adds a scanned package to the system. When this method is finished, the package will
 * be available for query, resolution, etc...
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> PackageParser<span class="token punctuation">.</span>Package oldPkg<span class="token punctuation">,</span> PackageSetting pkgSetting<span class="token punctuation">,</span> 
            UserHandle user<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> chatty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> String pkgName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// mCustomResolverComponentName 是从系统资源中读出的，可以配置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCustomResolverComponentName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                mCustomResolverComponentName<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 这里的用途和下面判断 packageName 是否为 "android" 有联系，</span>
        <span class="token comment" spellcheck="true">// 因为调用 setUpCustomResolverActivity(pkg) 后 mResolverReplaced 为true</span>
        <span class="token function">setUpCustomResolverActivity</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 针对包名为 "android" 的 apk 进行处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Set up information for our fall-back user intent resolution activity.</span>
                <span class="token comment" spellcheck="true">// 为我们回退的页面配置信息</span>
                mPlatformPackage <span class="token operator">=</span> pkg<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">=</span> mSdkVersion<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>mVersionCodeMajor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                mAndroidApplication <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果上面的代码中调用了 setUpCustomResolverActivity 方法，</span>
                <span class="token comment" spellcheck="true">// 在 setUpCustomResolverActivity 方法里面设置了 mResolverReplaced = true</span>
                <span class="token comment" spellcheck="true">// 如果没有调用 setUpCustomResolverActivity 方法，</span>
                <span class="token comment" spellcheck="true">// 配置相应 mResolveActivity 的属性</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mResolverReplaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mResolveActivity<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> mAndroidApplication<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>name <span class="token operator">=</span> ResolverActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>packageName <span class="token operator">=</span> mAndroidApplication<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>processName <span class="token operator">=</span> <span class="token string">"system:ui"</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>launchMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>LAUNCH_MULTIPLE<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>documentLaunchMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_NEVER<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>flags <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_EXCLUDE_FROM_RECENTS<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>theme <span class="token operator">=</span> R<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Theme_Material_Dialog_Alert<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>exported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>RESIZE_MODE_RESIZEABLE<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>configChanges <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SCREEN_SIZE
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SMALLEST_SCREEN_SIZE
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SCREEN_LAYOUT
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_ORIENTATION
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_KEYBOARD
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_KEYBOARD_HIDDEN<span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> mResolveActivity<span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>priority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>preferredOrder <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>match <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    mResolveComponentName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                             mAndroidApplication<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> mResolveActivity<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// 在此之前，四大组件的信息都是 Package 对象的私有变量，通过下面的代码，</span>
        <span class="token comment" spellcheck="true">// 将他们注册到 PackageManagerService 里面，</span>
        <span class="token comment" spellcheck="true">// 这样 PackageManagerService 就有了所有的组件信息</span>
        <span class="token keyword">int</span> N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StringBuilder r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 注册 pkg 里面的 provider 到 PackageManagerService 上的 mProvider 上</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageParser<span class="token punctuation">.</span>Provider p <span class="token operator">=</span> pkg<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 设置进程名称，如果在 AndroidManifest 里面配置了进程名称，就以配置为准，</span>
            <span class="token comment" spellcheck="true">// 如果没有配置，就是默认包名</span>
            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>processName <span class="token operator">=</span> <span class="token function">fixProcessName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                        p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProviders<span class="token punctuation">.</span><span class="token function">addProvider</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span>syncable <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>isSyncable<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String names<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>syncable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>Provider</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        p<span class="token punctuation">.</span>syncable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">+</span> <span class="token string">";"</span> <span class="token operator">+</span> names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        PackageParser<span class="token punctuation">.</span>Provider other <span class="token operator">=</span> mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>chatty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 注册该 Package 中的 service 到 PackageManagerService 的 mServices 上</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 注册 pkg 里面的 receiver 到 PackageManagerService 上的 mReceivers 上</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mReceivers<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 注册 pkg 里面的 activity 到 PackageManagerService 上的 mActivities 上</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mActivities<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Don't allow ephemeral applications to define new permissions groups.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permission groups from package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName
                    <span class="token operator">+</span> <span class="token string">" ignored: instant apps cannot define new permission groups."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mPermissionManager<span class="token punctuation">.</span><span class="token function">addAllPermissionGroups</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Don't allow ephemeral applications to define new permissions.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permissions from package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName
                    <span class="token operator">+</span> <span class="token string">" ignored: instant apps cannot define new permissions."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mPermissionManager<span class="token punctuation">.</span><span class="token function">addAllPermissions</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//  注册 pkg 里面的 instrumentation 到 PackageManagerService 的 mInstrumentation 中</span>
        <span class="token comment" spellcheck="true">// Instrumentation 用来跟踪本应用内的 application 及 activity 的生命周期</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageParser<span class="token punctuation">.</span>Instrumentation a <span class="token operator">=</span> pkg<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>sourceDir <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>sourceDir<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>publicSourceDir <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>publicSourceDir<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitSourceDirs <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitSourceDirs<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            mInstrumentation<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getComponentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 如果有包内广播</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>protectedBroadcasts <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mProtectedBroadcasts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mProtectedBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-3-扫描非系统-Package"><a href="#2-3-扫描非系统-Package" class="headerlink" title="2.3 扫描非系统 Package"></a>2.3 扫描非系统 Package</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/* 
 * mOnlyCore 用于控制是否扫描非系统 Package
 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do this first before mucking with mPackages for the "expecting better" case</span>
    <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageParser<span class="token punctuation">.</span>Package<span class="token operator">></span> pkgIterator <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>pkgIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg <span class="token operator">=</span> pkgIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>isStub<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stubSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> psit <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>psit<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PackageSetting ps <span class="token operator">=</span> psit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * If this is not a system app, it can't be a
         * disable system app.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*
         * If the package is scanned, it's not erased.
         */</span>
        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scannedPkg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">removePackageLI</span><span class="token punctuation">(</span>scannedPkg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mExpectingBetter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ps<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            psit<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PackageSetting disabledPs <span class="token operator">=</span>
                    mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>disabledPs<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>disabledPs<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> disabledPs<span class="token punctuation">.</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                possiblyDeletedUpdatedSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 扫描 /data/app 目录</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>mAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 扫描 /data/app-private 目录</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>mDrmAppPrivateInstallDir<span class="token punctuation">,</span> mDefParseFlags
            <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_FORWARD_LOCK<span class="token punctuation">,</span>
            scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 这里检查用户目录下升级文件是否还存在，然后进行处理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String deletedAppName <span class="token operator">:</span> possiblyDeletedUpdatedSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PackageParser<span class="token punctuation">.</span>Package deletedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 从 mSettings.mDisabledSysPackages 变量中移除去此应用</span>
        mSettings<span class="token punctuation">.</span><span class="token function">removeDisabledSystemPackageLPw</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String msg<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 用户目录中也没有升级包，则肯定是残留的应用信息，则把它的数据目录删除掉</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deletedPkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">=</span> <span class="token string">"Updated system package "</span> <span class="token operator">+</span> deletedAppName
                    <span class="token operator">+</span> <span class="token string">" no longer exists; removing its data"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果在用户空间找到了文件，则说明系统目录下的文件可能被删除了，</span>
        <span class="token comment" spellcheck="true">// 因此，把应用的系统属性去掉，以普通应用的方式运行</span>
            msg <span class="token operator">=</span> <span class="token string">"Updated system package + "</span> <span class="token operator">+</span> deletedAppName
                    <span class="token operator">+</span> <span class="token string">" no longer exists; revoking system privileges"</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PackageSetting deletedPs <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            deletedPkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>
            deletedPs<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 报告系统发生了不一致的情况</span>
        <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 处理 mExpectingBetter 列表，这个列表的应用是带有升级包的系统的应用，</span>
    <span class="token comment" spellcheck="true">// 前面把他们从 mPackages 列表中清除了并放到 mExpectingBetter 列表，</span>
    <span class="token comment" spellcheck="true">// 最后也对他们进行扫描处理，但不会放到 mPackages 中。</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String packageName <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> File scanFile <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> reparseFlags<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> rescanFlags<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 确保应用位于下面的系统应用目录中，如果不在，则不需要处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedVendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>
                       <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedOdmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_VENDOR
                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>
                       <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>odmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedProductAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_PRODUCT
                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>productAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Ignoring unexpected fallback path "</span> <span class="token operator">+</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果应用不在上面这些目录，继续循环，不要处理</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 重新扫描一下这个文件，会添加一个 &lt;update-package> 标签</span>
                <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>scanFile<span class="token punctuation">,</span> reparseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to parse original system package: "</span>
                        <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Uncompress and install any stubbed system applications.</span>
    <span class="token comment" spellcheck="true">// This must be done last to ensure all stubs are replaced or disabled.</span>
    <span class="token function">decompressSystemApplications</span><span class="token punctuation">(</span>stubSystemApps<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> cachedNonSystemApps <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>sCachedPackageReadCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">-</span> cachedSystemApps<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">long</span> dataScanTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemScanTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> dataPackagesCount <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemPackagesCount<span class="token punctuation">;</span>
    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Finished scanning non-system apps. Time: "</span> <span class="token operator">+</span> dataScanTime
            <span class="token operator">+</span> <span class="token string">" ms, packageCount: "</span> <span class="token operator">+</span> dataPackagesCount
            <span class="token operator">+</span> <span class="token string">" , timePerPackage: "</span>
            <span class="token operator">+</span> <span class="token punctuation">(</span>dataPackagesCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> dataScanTime <span class="token operator">/</span> dataPackagesCount<span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token string">" , cached: "</span> <span class="token operator">+</span> cachedNonSystemApps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">&amp;&amp;</span> dataPackagesCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MetricsLogger<span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"ota_package_manager_data_app_avg_scan_time"</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> dataScanTime<span class="token punctuation">)</span> <span class="token operator">/</span> dataPackagesCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>　　　　<span class="token comment" spellcheck="true">//　扫描非系统 apk　工作完成！</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="三、扫尾工作"><a href="#三、扫尾工作" class="headerlink" title="三、扫尾工作"></a>三、扫尾工作</h1><p>这部分任务比较简单，就是将第二阶段 APK 的信息再集中整理一次，可自行研究。</p>
<hr>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>&nbsp;📕 01. <a href="https://www.2cto.com/kf/201609/551752.html" target="_blank" rel="noopener">Android7.0 PackageManagerService (2) PKMS构造函数的主要工作</a><br>&nbsp;📕 02. <a href="https://www.jianshu.com/p/8e2831428110" target="_blank" rel="noopener">APK安装流程详解7——PackageManagerService的启动流程(上)</a></p>
<hr>
<h1 id="索引链接"><a href="#索引链接" class="headerlink" title="索引链接"></a>索引链接</h1><p>推荐跳转：<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">博客索引（Android 9.0）</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/01/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%881%EF%BC%89%E4%B9%8B%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">Framework 核心服务之 PMS 钻研（1）- 启动流程</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/10/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%883%EF%BC%89%E4%B9%8B%20PackageManager/">Framework 核心服务之 PMS 钻研（3）- PackageManager</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/01/05/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-2-gou-zao-han-shu/" class="b-link-green">PackageManagerService 钻研（2）- 构造函数</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript。</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/01/12/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-3-packagemanager/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService 钻研（3）- PackageManager">
                        
                        <span class="card-title">PackageManagerService 钻研（3）- PackageManager</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                    <a href="/tags/PackageManager/" target="_blank">
                        <span class="chip bg-color">PackageManager</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/01/01/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-1-qi-dong-liu-cheng/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService 钻研（1）- 启动流程">
                        
                        <span class="card-title">PackageManagerService 钻研（1）- 启动流程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Thinking in Android<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;检索博文</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的技术关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src=""></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>