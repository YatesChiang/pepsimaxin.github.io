<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°, Thinking in Android">
    <meta name="description" content="
PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰



&amp;nbsp;
ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹





ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ Packag">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•° | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>é¦–é¡µ</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>ç›®å½•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>æ ‡ç­¾</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>ç»„ä»¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>å¼€æœº</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>æ¡†æ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>æœºåˆ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>ä¼˜åŒ–</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>æ¨¡å¼</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>ç®—æ³•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>æ‹“å±•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>ä½œè€…</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="æ£€ç´¢åšæ–‡"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                é¦–é¡µ
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                ç›®å½•
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                æ ‡ç­¾
            </a>
        </li>
        
        <li>
            <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                ç»„ä»¶
            </a>
        </li>
        
        <li>
            <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                å¼€æœº
            </a>
        </li>
        
        <li>
            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                æ¡†æ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                æœºåˆ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                ä¼˜åŒ–
            </a>
        </li>
        
        <li>
            <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                æ¨¡å¼
            </a>
        </li>
        
        <li>
            <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                ç®—æ³•
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                æ‹“å±•
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                ä½œè€…
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/PackageManagerService.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/PackageManagerService/" target="_blank">
                                <span class="chip bg-color">PackageManagerService</span>
                            </a>
                        
                            <a href="/tags/PMS-æ„é€ å‡½æ•°/" target="_blank">
                                <span class="chip bg-color">PMS æ„é€ å‡½æ•°</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="post-category" target="_blank">
                                æ¡†æ¶æœåŠ¡
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;å‘å¸ƒæ—¥æœŸ :&nbsp;
                    2019-01-05
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;æ–‡ç« å­—æ•° :&nbsp;
                        5.1k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;é˜…è¯»æ—¶é•¿ :&nbsp;
                        26 åˆ†é’Ÿ
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;é˜…è¯»æ¬¡æ•° :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p>
<table>
<thead>
<tr>
<th style="text-align:center">&nbsp;</th>
<th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† Android 9.0 æºç ä¸­æ‰«æç³»ç»Ÿ Apk åŠéç³»ç»Ÿ Apk çš„ä»£ç é€»è¾‘ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€ç»†åŒ–æºç ï¼Œæ·»åŠ æ›´ä¸ºè¯¦ç»†çš„æ³¨é‡Šè¯´æ˜ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">3ã€æ–°å¢æµç¨‹å›¾åŠæ—¶åºå›¾ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">4ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆä¼˜åŒ–ï¼›</font><br><br></p>
<hr>
<h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table>
<thead>
<tr>
<th>å…³é”®ç±»</th>
<th>è·¯å¾„</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">Process.java</font></td>
<td>frameworks/base/core/java/android/os/Process.java</td>
</tr>
<tr>
<td><font color="#D15FEE">Settings.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/Settings.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SystemConfig.java</font></td>
<td>frameworks/base/core/java/com/android/server/SystemConfig.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SystemServer.java</font></td>
<td>frameworks/base/services/java/com/android/server/SystemServer.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageManagerService.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td>
</tr>
</tbody>
</table>
<h2 id="1-2-å›é¡¾"><a href="#1-2-å›é¡¾" class="headerlink" title="1.2 å›é¡¾"></a>1.2 å›é¡¾</h2><p>åœ¨ PackageManagerService ç³»åˆ—ç¬¬ä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬å°† <strong>â€œæ„é€ å‡½æ•°â€</strong> åˆ†æˆäº†ä¸¤éƒ¨åˆ†ç ”ç©¶ï¼Œå¦‚ä¸‹ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ1ï¼‰ - å‰æœŸå‡†å¤‡å·¥ä½œ</font></strong>&nbsp;<strong><font color="#FF0000">ï¼ˆåˆ†æå®Œï¼‰</font></strong><a href="https://superandroid.pro/2019/01/01/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%881%EF%BC%89%E4%B9%8B%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">ã€ŠFramework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹ã€‹</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ2ï¼‰ - æ‰«æ Package å’Œ æ‰«å°¾å·¥ä½œ</font></strong>&nbsp;<strong><font color="#FF0000">ï¼ˆæœ¬ç¯‡æ–‡ç« è¦è®¨è®ºçš„å†…å®¹ï¼‰</font></strong><br><br></p>
<hr>
<h1 id="äºŒã€æ‰«æ-Package"><a href="#äºŒã€æ‰«æ-Package" class="headerlink" title="äºŒã€æ‰«æ Package"></a>äºŒã€æ‰«æ Package</h1><p>PMS æ„é€ å‡½æ•°ç¬¬äºŒé˜¶æ®µï¼ˆæˆ‘ä»¬å‰é¢åˆ†æçš„ Settings å’Œ XML è§£æä½œä¸ºæ„é€ å‡½æ•°çš„ç¬¬ä¸€éƒ¨åˆ†ï¼‰çš„å·¥ä½œå°±æ˜¯ <code>æ‰«æç³»ç»Ÿä¸­çš„ APK</code>äº†ã€‚ç”±äºéœ€è¦é€ä¸ªæ‰«ææ–‡ä»¶ï¼Œå› æ­¤æ‰‹æœºä¸Šè£…çš„ç¨‹åºè¶Šå¤šï¼ŒPMS çš„å·¥ä½œé‡å°±è¶Šå¤§ï¼Œç³»ç»Ÿå¯åŠ¨é€Ÿåº¦ä¹Ÿå°±è¶Šæ…¢ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ çš„æ‰‹æœºå¯åŠ¨é€Ÿåº¦æœ‰å¿«æ…¢çš„åŸå› <strong><font color="#0000FF">ï¼ˆæ‰€ä»¥ä¼˜åŒ–å¼€æœºå¯åŠ¨é€Ÿåº¦ï¼Œäº†è§£ PMS ä¹Ÿæ˜¯å¾ˆå…³é”®çš„ï¼‰</font></strong>ã€‚</p>
<h2 id="2-1-ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰"><a href="#2-1-ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰" class="headerlink" title="2.1 ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰"></a>2.1 ç¬¬ä¸€é˜¶æ®µï¼ˆå‰©ä½™å·¥ä½œï¼‰</h2><p>æ¥ç€å‰é¢çš„ PMS æ„é€ å‡½æ•°ç»§ç»­åˆ†ææºç ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// writer </span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        mFirstBoot <span class="token operator">=</span> <span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">readLPw</span><span class="token punctuation">(</span>sUserManager<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> packageSettingCount <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// æ¸…ç†é‚£äº›ä»£ç è·¯å¾„ä¸å­˜åœ¨çš„å¼‚å¸¸ package</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> packageSettingCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageSetting ps <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isExternal</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ps<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>ps<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">requestCopyPreoptedFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// è®¾ç½®æ¨¡å—æ¥ä»£æ›¿ framework-res.apk ä¸­ç¼ºçœçš„ ResolverActivity</span>
        String customResolverActivity <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>config_customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            customResolverActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mCustomResolverComponentName <span class="token operator">=</span> ComponentName<span class="token punctuation">.</span><span class="token function">unflattenFromString</span><span class="token punctuation">(</span>
                    customResolverActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// è®°å½•æ‰«æå¼€å§‹çš„æ—¶é—´</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// éœ€è¦ç³»ç»Ÿæå‰åŠ è½½çš„ä¸€äº› jar</span>
        <span class="token keyword">final</span> String bootClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"BOOTCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String systemServerClassPath <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SYSTEMSERVERCLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è‡³æ­¤ï¼Œç¬¬ä¸€é˜¶æ®µä»£ç å…¨éƒ¨ç»“æŸï¼</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-2-æ‰«æç³»ç»Ÿ-Package"><a href="#2-2-æ‰«æç³»ç»Ÿ-Package" class="headerlink" title="2.2 æ‰«æç³»ç»Ÿ Package"></a>2.2 æ‰«æç³»ç»Ÿ Package</h2><p>æ¥ä¸‹æ¥çœ‹ PMS ç¬¬äºŒé˜¶æ®µå·¥ä½œçš„æ ¸å¿ƒå†…å®¹ï¼Œå³ <code>æ‰«æ Package</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ã€€ã€€ã€€ã€€<span class="token comment" spellcheck="true">// ç¬¬ä¸€é˜¶æ®µåˆ†æç»“æŸï¼</span>

    <span class="token comment" spellcheck="true">// å®šä¹‰ frameworkDir æŒ‡å‘ /system/frameworks ç›®å½•</span>
    File frameworkDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"framework"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> VersionInfo ver <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getInternalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mIsUpgrade <span class="token operator">=</span> <span class="token operator">!</span>Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ver<span class="token punctuation">.</span>fingerprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token string">"Upgrading from "</span> <span class="token operator">+</span> 
                        ver<span class="token punctuation">.</span>fingerprint <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> Build<span class="token punctuation">.</span>FINGERPRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mPromoteSystemApps <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>LOLLIPOP_MR1<span class="token punctuation">;</span>
    mIsPreNUpgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">;</span>
    mIsPreNMR1Upgrade <span class="token operator">=</span> mIsUpgrade <span class="token operator">&amp;&amp;</span> ver<span class="token punctuation">.</span>sdkVersion <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N_MR1<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// æ˜¯å¦éœ€è¦æå‡æƒé™</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPromoteSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> pkgSettingIter <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pkgSettingIter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageSetting ps <span class="token operator">=</span> pkgSettingIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystemApp</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// éå† Settings::mPackages é›†åˆï¼Œå°†ç³»ç»Ÿ APP åŠ å…¥åˆ°</span>
                <span class="token comment" spellcheck="true">// PackageManagerService::mExistingSystemPackages</span>
                mExistingSystemPackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mCacheDir <span class="token operator">=</span> <span class="token function">preparePackageParserCache</span><span class="token punctuation">(</span>mIsUpgrade<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å®šä¹‰æ‰«æå‚æ•°</span>
    <span class="token keyword">int</span> scanFlags <span class="token operator">=</span> SCAN_BOOTING <span class="token operator">|</span> SCAN_INITIAL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">||</span> mFirstBoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scanFlags <span class="token operator">=</span> scanFlags <span class="token operator">|</span> SCAN_FIRST_BOOT_OR_UPGRADE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// private static final String VENDOR_OVERLAY_DIR = "/vendor/overlay";</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>VENDOR_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// æ‰«æ /vendor/overlay ç›®å½•</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// private static final String PRODUCT_OVERLAY_DIR = "/product/overlay";</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>PRODUCT_OVERLAY_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// æ‰«æ /product/overlay ç›®å½•</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mParallelPackageParserCallback<span class="token punctuation">.</span><span class="token function">findStaticOverlayPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Find base frameworks (resource packages without code).</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>frameworkDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// æ‰«æ /system/frameworks ç›®å½•</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_NO_DEX
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Collected privileged system packages.</span>
    <span class="token keyword">final</span> File privilegedAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"priv-app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span>                  <span class="token comment" spellcheck="true">// æ‰«æ /system/priv-app ç›®å½•</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Collect ordinary system packages.</span>
    <span class="token keyword">final</span> File systemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// æ‰«æ /system/app ç›®å½•</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// Collect ordinary vendor packages.</span>
    File vendorAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        vendorAppDir <span class="token operator">=</span> vendorAppDir<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// failed to look up canonical path, continue with original one</span>
    <span class="token punctuation">}</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// æ‰«æ /vendor/app ç›®å½•</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span>
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// Collect all OEM packages.</span>
    <span class="token keyword">final</span> File oemAppDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">// æ‰«æ /oem/app ç›®å½•</span>
                    mDefParseFlags
                    <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">,</span> 
                    scanFlags
                    <span class="token operator">|</span> SCAN_AS_SYSTEM
                    <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ï½
</code></pre>
<p>æˆ‘ä»¬å‘ç° PMS æ‰«æäº†å¾ˆå¤šç›®å½•ï¼Œæˆ‘ä»¬åˆ—ä¸¾å‡ ä¸ªé‡ç‚¹è¯´æ˜ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><code>/system/frameworks</code></strong> ï¼šè¯¥ç›®å½•ä¸­çš„æ–‡ä»¶éƒ½æ˜¯ç³»ç»Ÿåº“ï¼Œä¾‹å¦‚ï¼šframework.jarã€services.jarã€framework-res.apkã€‚ä¸è¿‡ scanDirTracedLI åªæ‰«æ APK æ–‡ä»¶ï¼Œæ‰€ä»¥ <code>framework-res.apk</code> æ˜¯è¯¥ç›®å½•ä¸­å”¯ä¸€è¢«æ‰«æçš„æ–‡ä»¶ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><code>/system/app</code></strong> ï¼šè¯¥ç›®å½•ä¸‹å…¨æ˜¯é»˜è®¤çš„ç³»ç»Ÿåº”ç”¨ã€‚ä¾‹å¦‚ï¼šBrowser.apkã€SettingsProvider.apk ç­‰ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><code>/vendor/app</code></strong> ï¼šè¯¥ç›®å½•ä¸­çš„æ–‡ä»¶ç”±å‚å•†æä¾›ï¼Œå³å…¨æ˜¯å‚å•†å®šåˆ¶çš„ APK æ–‡ä»¶ã€‚</p>
<h3 id="2-2-1-scanDirTracedLI"><a href="#2-2-1-scanDirTracedLI" class="headerlink" title="2.2.1 scanDirTracedLI"></a>2.2.1 scanDirTracedLI</h3><p>PMS æ‰«æç›®å½•ç»Ÿä¸€è°ƒç”¨ <code>scanDirTracedLI()</code> æ–¹æ³•ï¼ˆå‡ºç°æ¬¡æ•°æœ€å¤šçš„ä¹Ÿæ˜¯æœ€é‡è¦çš„å‡½æ•°ï¼‰ï¼Œæˆ‘ä»¬æ·±å…¥è·Ÿè¸ªæºç ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>File scanDir<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> 
                                          <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·³è½¬è‡³ scanDirLI æ–¹æ³•</span>
        <span class="token function">scanDirLI</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-2-scanDirLI"><a href="#2-2-2-scanDirLI" class="headerlink" title="2.2.2 scanDirLI"></a>2.2.2 scanDirLI</h3><p>ä¸‹é¢çš„é‡ç‚¹å°±è½¬ç§»åˆ° <code>scanDirLI()</code> æ–¹æ³•äº†ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanDirLI</span><span class="token punctuation">(</span>File scanDir<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// æ‰«æè¯¥ç›®å½•ä¸‹æ‰€æœ‰åç¼€ä¸º .apk çš„æ–‡ä»¶</span>
    <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> scanDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No files in app dir "</span> <span class="token operator">+</span> scanDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ParallelPackageParser æ˜¯ Android 9.0ã€€æ–°å¢çš„ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£å®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œ</span>
    <span class="token comment" spellcheck="true">// æ”¶é›†ç³»ç»Ÿ apk æ–‡ä»¶ï¼Œç„¶åä»è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ä¸€ä¸ªä¸ªå–å‡º apk ï¼Œè°ƒç”¨ PackageParserã€€è§£æï¼</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span>ParallelPackageParser parallelPackageParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParallelPackageParser</span><span class="token punctuation">(</span>
            mSeparateProcesses<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> mCacheDir<span class="token punctuation">,</span>
            mParallelPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Submit files for parsing in parallel    -->    æ”¶é›† apk</span>
        <span class="token keyword">int</span> fileCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPackage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isApkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                       <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>PackageInstallerService<span class="token punctuation">.</span><span class="token function">isStageName</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿‡æ»¤æ‰é apk æ–‡ä»¶ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ç»§ç»­æ‰«æ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ignore entries which are not packages</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            parallelPackageParser<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fileCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Process results one by one              -->    è§£æ apk</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> fileCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> fileCount<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ParallelPackageParser<span class="token punctuation">.</span>ParseResult parseResult <span class="token operator">=</span> parallelPackageParser<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Throwable throwable <span class="token operator">=</span> parseResult<span class="token punctuation">.</span>throwable<span class="token punctuation">;</span>
            <span class="token keyword">int</span> errorCode <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Static shared libraries have synthetic package names</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">isStaticSharedLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">renameStaticSharedLibraryPackage</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">/*
                         * Android 9.0 è°ƒç”¨ scanPackageChildLIï¼Œ
                         * Android 8.0 è°ƒç”¨ scanPackageLIï¼Œ
                         * Android 7.0 è°ƒç”¨ scanPackageTracedLIï¼Œ
                         * 
                         * è°ƒç”¨ scanPackageChildLI å‡½æ•°æ‰«æä¸€ä¸ªç‰¹å®šçš„ apk æ–‡ä»¶ï¼Œ
                         * è¿”å›å€¼æ˜¯ PackageParser çš„å†…éƒ¨ç±» Packageï¼Œ
                         * è¯¥ç±»çš„å®ä¾‹ä»£è¡¨ä¸€ä¸ª APK æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯å’Œ apk æ–‡ä»¶å¯¹åº”çš„æ•°æ®ç»“æ„ã€‚
                         */</span>
                        <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                                currentTime<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ‰«æ APK è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    errorCode <span class="token operator">=</span> e<span class="token punctuation">.</span>error<span class="token punctuation">;</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to scan "</span> <span class="token operator">+</span> parseResult<span class="token punctuation">.</span>scanFile <span class="token operator">+</span> <span class="token string">": "</span> 
                                                              <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token keyword">instanceof</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>PackageParserException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Delete invalid userdata apps -- å¦‚æœè§£æå¤±è´¥ï¼Œå¹¶ä¸”æ˜¯éç³»ç»Ÿ apk</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    errorCode <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// éç³»ç»Ÿ Package æ‰«æå¤±è´¥ï¼Œåˆ é™¤æ–‡ä»¶</span>
                <span class="token function">removeCodePathLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ç»§ç»­åˆ†æ <code>scanPackageChildLI()</code> æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹çœ‹ 9.0 æ–°å¢çš„ <code>ParallelPackageParser</code> è¿™ä¸ªç±»ã€‚</p>
<h4 id="2-2-2-1-ParallelPackageParser"><a href="#2-2-2-1-ParallelPackageParser" class="headerlink" title="2.2.2.1 ParallelPackageParser"></a>2.2.2.1 ParallelPackageParser</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Helper class for parallel parsing of packages using {@link PackageParser}.
 * &lt;p>Parsing requests are processed by a thread-pool of {@link #MAX_THREADS}.
 * At any time, at most {@link #QUEUE_CAPACITY} results are kept in RAM&lt;/p>
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ParallelPackageParser</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> BlockingQueue<span class="token operator">&lt;</span>ParseResult<span class="token operator">></span> mQueue <span class="token operator">=</span> 
                                             <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>QUEUE_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ParallelPackageParser</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> separateProcesses<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCoreApps<span class="token punctuation">,</span>
            DisplayMetrics metrics<span class="token punctuation">,</span> File cacheDir<span class="token punctuation">,</span> PackageParser<span class="token punctuation">.</span>Callback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mSeparateProcesses <span class="token operator">=</span> separateProcesses<span class="token punctuation">;</span>
        mOnlyCore <span class="token operator">=</span> onlyCoreApps<span class="token punctuation">;</span>
        mMetrics <span class="token operator">=</span> metrics<span class="token punctuation">;</span>
        mCacheDir <span class="token operator">=</span> cacheDir<span class="token punctuation">;</span>
        mPackageParserCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">/**
     * Submits the file for parsing
     * @param scanFile file to scan
     * @param parseFlags parse falgs
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span>File scanFile<span class="token punctuation">,</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            ParseResult pr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParseResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setSeparateProcesses</span><span class="token punctuation">(</span>mSeparateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setOnlyCoreApps</span><span class="token punctuation">(</span>mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setDisplayMetrics</span><span class="token punctuation">(</span>mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setCacheDir</span><span class="token punctuation">(</span>mCacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pp<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>mPackageParserCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pr<span class="token punctuation">.</span>scanFile <span class="token operator">=</span> scanFile<span class="token punctuation">;</span>
                pr<span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token function">parsePackage</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> scanFile<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pr<span class="token punctuation">.</span>throwable <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>TRACE_TAG_PACKAGE_MANAGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mInterruptedInThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æˆ‘ä»¬å†çœ‹ä¸‹ <code>ParallelPackageParser</code> çš„å†…éƒ¨ç±» <code>ParseResult</code>ã€‚</p>
<h4 id="2-2-2-2-ParseResult"><a href="#2-2-2-2-ParseResult" class="headerlink" title="2.2.2.2 ParseResult"></a>2.2.2.2 ParseResult</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Helper class for parallel parsing of packages using {@link PackageParser}.
 * &lt;p>Parsing requests are processed by a thread-pool of {@link #MAX_THREADS}.
 * At any time, at most {@link #QUEUE_CAPACITY} results are kept in RAM&lt;/p>
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ParallelPackageParser</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ParseResult</span> <span class="token punctuation">{</span>

        PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Parsed package</span>
        File scanFile<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// File that was parsed</span>
        Throwable throwable<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Set if an error occurs during parsing</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">"ParseResult{"</span> <span class="token operator">+</span>ã€€<span class="token string">"pkg="</span> <span class="token operator">+</span> pkg <span class="token operator">+</span>ã€€<span class="token string">", scanFile="</span> <span class="token operator">+</span> scanFile <span class="token operator">+</span>
                    <span class="token string">", throwable="</span> <span class="token operator">+</span> throwable <span class="token operator">+</span>ã€€<span class="token string">'}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Take the parsed package from the parsing queue, waiting if necessary until the element
     * appears in the queue.
     * @return parsed package
     */</span>
    <span class="token keyword">public</span> ParseResult <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInterruptedInThread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token string">"Interrupted in "</span> <span class="token operator">+</span> mInterruptedInThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We cannot recover from interrupt here</span>
            Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-3-scanPackageChildLI"><a href="#2-2-3-scanPackageChildLI" class="headerlink" title="2.2.3 scanPackageChildLI"></a>2.2.3 scanPackageChildLI</h3><p>æºç ä¸­ï¼Œå¦‚æœ apk æ–‡ä»¶æ²¡æœ‰é—®é¢˜ï¼Œä¼šèµ°å¦‚ä¸‹æµç¨‹ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * Android 9.0 è°ƒç”¨ scanPackageChildLIï¼Œ
         * Android 8.0 è°ƒç”¨ scanPackageLIï¼Œ
         * Android 7.0 è°ƒç”¨ scanPackageTracedLIï¼Œ
         * 
         * è°ƒç”¨ scanPackageChildLI å‡½æ•°æ‰«æä¸€ä¸ªç‰¹å®šçš„ apk æ–‡ä»¶ï¼Œ
         * è¿”å›å€¼æ˜¯ PackageParser çš„å†…éƒ¨ç±» Packageï¼Œ
         * è¯¥ç±»çš„å®ä¾‹ä»£è¡¨ä¸€ä¸ª APK æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯å’Œ apk æ–‡ä»¶å¯¹åº”çš„æ•°æ®ç»“æ„ã€‚
         *
         * PackageParser.Package pkg;    // Parsed package
         */</span>
        <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>parseResult<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>ã€€currentTime<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯åˆ†æ <code>scanPackageChildLI()</code> æ–¹æ³•ï¼</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 *  Scans a package and returns the newly parsed package. 
 *  æ‰«æä¸€ä¸ª apk æ–‡ä»¶å¹¶è¿”å› packageï¼
 *  @throws PackageManagerException on a parse error.
 */</span>
<span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            scanFlags <span class="token operator">|=</span> SCAN_CHECK_ONLY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        scanFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>SCAN_CHECK_ONLY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Scan the parent</span>
    PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> <span class="token function">addForInitLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span>
            scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Scan the children</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> childCount <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PackageParser<span class="token punctuation">.</span>Package childPackage <span class="token operator">=</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addForInitLI</span><span class="token punctuation">(</span>childPackage<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">scanPackageChildLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> scannedPkg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-4-addForInitLI"><a href="#2-2-4-addForInitLI" class="headerlink" title="2.2.4 addForInitLI"></a>2.2.4 addForInitLI</h3><p>ç»§ç»­è·Ÿè¸ªæºç ï¼Œè°ƒç”¨ <code>addForInitLI()</code> æ–¹æ³•ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">addForInitLI</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span>ã€€<span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token keyword">boolean</span> scanSystemPartition <span class="token operator">=</span> <span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> 
                                         PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> String renamedPkgName<span class="token punctuation">;</span>
    <span class="token keyword">final</span> PackageSetting disabledPkgSetting<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isSystemPkgUpdated<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> pkgAlreadyExists<span class="token punctuation">;</span>
    PackageSetting pkgSetting<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">/* 
     * åˆ¤æ–­ç³»ç»Ÿ APK æ˜¯å¦éœ€è¦æ›´æ–°
     * final ArrayMap&lt;String, PackageParser.Package> mPackages = 
     *                                      new ArrayMap&lt;String, PackageParser.Package>();
     */</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        renamedPkgName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mRealPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String realPkgName <span class="token operator">=</span> <span class="token function">getRealPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>realPkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ensurePackageRenamed</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> PackageSetting originalPkgSetting <span class="token operator">=</span> 
                                           <span class="token function">getOriginalPackageLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> PackageSetting installedPkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkgSetting <span class="token operator">=</span> originalPkgSetting <span class="token operator">==</span> null <span class="token operator">?</span> installedPkgSetting <span class="token operator">:</span> originalPkgSetting<span class="token punctuation">;</span>
        pkgAlreadyExists <span class="token operator">=</span> pkgSetting <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">final</span> String disabledPkgName <span class="token operator">=</span> pkgAlreadyExists <span class="token operator">?</span> pkgSetting<span class="token punctuation">.</span>name <span class="token operator">:</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
        disabledPkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>disabledPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isSystemPkgUpdated <span class="token operator">=</span> disabledPkgSetting <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">final</span> SharedUserSetting sharedUserSetting <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                <span class="token operator">?</span> mSettings<span class="token punctuation">.</span><span class="token function">getSharedUserLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId<span class="token punctuation">,</span>
                        <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgFlags*/</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgPrivateFlags*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>scanSystemPartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSystemPkgUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> scannedChildCount <span class="token operator">=</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>childPackages <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                        <span class="token operator">?</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> disabledChildCount <span class="token operator">=</span> disabledPkgSetting<span class="token punctuation">.</span>childPackageNames <span class="token operator">!=</span> null
                        <span class="token operator">?</span> disabledPkgSetting<span class="token punctuation">.</span>childPackageNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> disabledChildCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
ã€€ã€€ã€€ã€€                String disabledChildPackageName <span class="token operator">=</span>
                            disabledPkgSetting<span class="token punctuation">.</span>childPackageNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> disabledPackageAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> scannedChildCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        PackageParser<span class="token punctuation">.</span>Package childPkg <span class="token operator">=</span> pkg<span class="token punctuation">.</span>childPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>childPkg<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>disabledChildPackageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            disabledPackageAvailable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disabledPackageAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mSettings<span class="token punctuation">.</span><span class="token function">removeDisabledSystemPackageLPw</span><span class="token punctuation">(</span>disabledChildPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// we're updating the disabled package, so, scan it as the package setting</span>
                <span class="token keyword">final</span> ScanRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanRequest</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> sharedUserSetting<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        disabledPkgSetting <span class="token comment" spellcheck="true">/* pkgSetting */</span><span class="token punctuation">,</span> null <span class="token comment" spellcheck="true">/* disabledPkgSetting */</span><span class="token punctuation">,</span>
                        null <span class="token comment" spellcheck="true">/* originalPkgSetting */</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>pkg <span class="token operator">==</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">applyPolicy</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scanPackageOnlyLI</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mFactoryTest<span class="token punctuation">,</span> <span class="token operator">-</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newPkgChangedPaths <span class="token operator">=</span>
            pkgAlreadyExists <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> newPkgVersionGreater <span class="token operator">=</span>
            pkgAlreadyExists <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> pkgSetting<span class="token punctuation">.</span>versionCode<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> isSystemPkgBetter <span class="token operator">=</span> scanSystemPartition <span class="token operator">&amp;&amp;</span> isSystemPkgUpdated
            <span class="token operator">&amp;&amp;</span> newPkgChangedPaths <span class="token operator">&amp;&amp;</span> newPkgVersionGreater<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isSystemPkgBetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°å®‰è£…åŒ…åˆ°ç³»ç»Ÿåˆ†åŒºä¸­</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä» PackageManagerService çš„å®‰è£…åŒ…åˆ—è¡¨ä¸­åˆ é™¤è¯¥åŒ…</span>
            mPackages<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// åˆ›å»ºå®‰è£…å‚æ•° InstallArgs</span>
        <span class="token keyword">final</span> InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgsForExisting</span><span class="token punctuation">(</span>
                <span class="token function">packageFlagsToInstallFlags</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">,</span>
                pkgSetting<span class="token punctuation">.</span>resourcePathString<span class="token punctuation">,</span> <span class="token function">getAppDexInstructionSets</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">cleanUpResourcesLI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// å®‰è£…åŒ…æ ¡éªŒ</span>
    <span class="token function">collectCertificatesLI</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span> forceCollect<span class="token punctuation">,</span> skipVerify<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * A new system app appeared, but we already had a non-system one of the
     * same name installed earlier.
     *
     * å½“æˆ‘ä»¬å®‰è£…ä¸€ä¸ªç³»ç»Ÿ apk çš„æ—¶å€™ï¼Œå‘ç°å·²ç»æœ‰äº†ä¸€ä¸ªç›¸åŒåŒ…åçš„ apkï¼Œ
     * è€Œä¸”è¿™ä¸ªç›¸åŒåŒ…å apk æ˜¯åœ¨éç³»ç»Ÿçš„åˆ†åŒºä¸­
     */</span>

    <span class="token keyword">boolean</span> shouldHideSystemApp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// A new application appeared on /system, but, we already have a copy of</span>
    <span class="token comment" spellcheck="true">// the application installed on /data.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scanSystemPartition <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isSystemPkgUpdated <span class="token operator">&amp;&amp;</span> pkgAlreadyExists
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>
                PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>INSTALLED_DATA<span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkgSetting<span class="token punctuation">.</span>signatures<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">.</span><span class="token function">checkCapability</span><span class="token punctuation">(</span>
                                pkg<span class="token punctuation">.</span>mSigningDetails<span class="token punctuation">,</span>
                                PackageParser<span class="token punctuation">.</span>SigningDetails<span class="token punctuation">.</span>CertCapabilities<span class="token punctuation">.</span>ROLLBACK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> <span class="token string">"System package signature mismatch;"</span>
                                           <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span>PackageFreezer freezer <span class="token operator">=</span> <span class="token function">freezePackage</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    <span class="token string">"scanPackageInternalLI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœä¸¤ä¸ª apk ç­¾åä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ deletePackageLI æ–¹æ³•æ¸…é™¤ apk æ–‡ä»¶åŠå…¶æ•°æ®</span>
                <span class="token function">deletePackageLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pkgSetting <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newPkgVersionGreater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The application on /system is newer than the application on /data.</span>
            <span class="token comment" spellcheck="true">// Simply remove the application on /data [keeping application data]</span>
            <span class="token comment" spellcheck="true">// and replace it with the version on /system.</span>
            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> <span class="token string">"System package enabled;"</span> <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name
                    <span class="token operator">+</span> <span class="token string">"; "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>versionCode <span class="token operator">+</span> <span class="token string">" --> "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">"; "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>codePathString <span class="token operator">+</span> <span class="token string">" --> "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// æ›´æ–°ç³»ç»Ÿ apk ç¨‹åº</span>
            InstallArgs args <span class="token operator">=</span> <span class="token function">createInstallArgsForExisting</span><span class="token punctuation">(</span>
                    <span class="token function">packageFlagsToInstallFlags</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>codePathString<span class="token punctuation">,</span>
                    pkgSetting<span class="token punctuation">.</span>resourcePathString<span class="token punctuation">,</span> <span class="token function">getAppDexInstructionSets</span><span class="token punctuation">(</span>pkgSetting<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                args<span class="token punctuation">.</span><span class="token function">cleanUpResourcesLI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The application on /system is older than the application on /data. Hide</span>
            <span class="token comment" spellcheck="true">// the application on /system and the version on /data will be scanned later</span>
            <span class="token comment" spellcheck="true">// and re-added like an update.</span>
            shouldHideSystemApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>
                    <span class="token string">"System package disabled;"</span>
                    <span class="token operator">+</span> <span class="token string">" name: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>name
                    <span class="token operator">+</span> <span class="token string">"; old: "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>codePathString <span class="token operator">+</span> <span class="token string">" @ "</span> <span class="token operator">+</span> pkgSetting<span class="token punctuation">.</span>versionCode
                    <span class="token operator">+</span> <span class="token string">"; new: "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath <span class="token operator">+</span> <span class="token string">" @ "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ é‡ç‚¹æ–¹æ³• ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥</span>
    <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> <span class="token function">scanPackageNewLI</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags
            <span class="token operator">|</span> SCAN_UPDATE_SIGNATURE<span class="token punctuation">,</span> currentTime<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å¦‚æœæ–°å®‰è£…çš„ç³»ç»Ÿ APK ä¼šè¢«æ—§çš„ APK æ•°æ®è¦†ç›–ï¼Œ</span>
    <span class="token comment" spellcheck="true">// æ‰€ä»¥éœ€è¦éšè—éšè—ç³»ç»Ÿåº”ç”¨ç¨‹åºï¼Œå¹¶é‡æ–°æ‰«æ /data/app ç›®å½•</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldHideSystemApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSettings<span class="token punctuation">.</span><span class="token function">disableSystemPackageLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> scannedPkg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-5-scanPackageNewLI"><a href="#2-2-5-scanPackageNewLI" class="headerlink" title="2.2.5 scanPackageNewLI"></a>2.2.5 scanPackageNewLI</h3><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ <code>scanPackageNewLI()</code> æ–¹æ³•æºç ï¼</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">scanPackageNewLI</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> parseFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">long</span> currentTime<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> UserHandle user<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token keyword">final</span> String renamedPkgName <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getRenamedPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mRealPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> String realPkgName <span class="token operator">=</span> <span class="token function">getRealPackageName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>realPkgName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ensurePackageRenamed</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> PackageSetting originalPkgSetting <span class="token operator">=</span> 
                                           <span class="token function">getOriginalPackageLocked</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> renamedPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> PackageSetting pkgSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getPackageLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> PackageSetting disabledPkgSetting <span class="token operator">=</span>
                         mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTransferedPackages<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName
                <span class="token operator">+</span> <span class="token string">" was transferred to another, but its .apk remains"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    scanFlags <span class="token operator">=</span> <span class="token function">adjustScanFlags</span><span class="token punctuation">(</span>scanFlags<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> disabledPkgSetting<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyPolicy</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertPackageIsValid</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        SharedUserSetting sharedUserSetting <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// SIDE EFFECTS; may potentially allocate a new shared user</span>
            sharedUserSetting <span class="token operator">=</span> mSettings<span class="token punctuation">.</span><span class="token function">getSharedUserLPw</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mSharedUserId<span class="token punctuation">,</span> 
                           <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgFlags*/</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*pkgPrivateFlags*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*create*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_PACKAGE_SCANNING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> PackageParser<span class="token punctuation">.</span>PARSE_CHATTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Shared UserID "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>mSharedUserId
                            <span class="token operator">+</span> <span class="token string">" (uid="</span> <span class="token operator">+</span> sharedUserSetting<span class="token punctuation">.</span>userId <span class="token operator">+</span> <span class="token string">"):"</span>
                            <span class="token operator">+</span> <span class="token string">" packages="</span> <span class="token operator">+</span> sharedUserSetting<span class="token punctuation">.</span>packages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> scanSucceeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ScanRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanRequest</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> sharedUserSetting<span class="token punctuation">,</span>
                    pkgSetting <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> pkgSetting<span class="token punctuation">.</span>pkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> 
                    disabledPkgSetting<span class="token punctuation">,</span> originalPkgSetting<span class="token punctuation">,</span> realPkgName<span class="token punctuation">,</span> parseFlags<span class="token punctuation">,</span> 
                    scanFlags<span class="token punctuation">,</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> mPlatformPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ScanResult result <span class="token operator">=</span> <span class="token function">scanPackageOnlyLI</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mFactoryTest<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°† pkg ä¸­çš„æ•°æ®ä¿å­˜åˆ°å¯¹åº”çš„ PMS å˜é‡ä¸­ï¼Œç”¨äºä»¥åçš„ç®¡ç†æŸ¥è¯¢è°ƒç”¨ç­‰</span>
                <span class="token comment" spellcheck="true">// ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ é‡ç‚¹æ–¹æ³• ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥</span>
                <span class="token function">commitScanResultsLocked</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            scanSucceeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scanSucceeded <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_DELETE_DATA_ON_FAILURES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span>
                  <span class="token function">destroyAppDataLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">,</span>
                          StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_DE <span class="token operator">|</span> StorageManager<span class="token punctuation">.</span>FLAG_STORAGE_CE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">destroyAppProfilesLIF</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> UserHandle<span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-5-commitScanResultsLocked"><a href="#2-2-5-commitScanResultsLocked" class="headerlink" title="2.2.5 commitScanResultsLocked"></a>2.2.5 commitScanResultsLocked</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitScanResultsLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ScanRequest request<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> ScanResult result<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> PackageManagerException <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPkgSetting <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>oldPkgSetting<span class="token punctuation">.</span>name<span class="token punctuation">,</span> oldPkgSetting<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> user <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Modify state for the given package setting</span>
        <span class="token comment" spellcheck="true">// å°† pkg ä¸­çš„æ•°æ®ä¿å­˜åˆ°å¯¹åº”çš„ PMS å˜é‡ä¸­ï¼Œç”¨äºä»¥åçš„ç®¡ç†æŸ¥è¯¢è°ƒç”¨ç­‰</span>
        <span class="token comment" spellcheck="true">// ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ é‡ç‚¹æ–¹æ³• ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥ ğŸ”¥</span>
        <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> oldPkg<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">,</span> user<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>parseFlags <span class="token operator">&amp;</span> PackageParser<span class="token punctuation">.</span>PARSE_CHATTY<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">/*chatty*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgSetting<span class="token punctuation">.</span><span class="token function">getInstantApp</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mInstantAppRegistry<span class="token punctuation">.</span><span class="token function">addInstantAppLPw</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> pkgSetting<span class="token punctuation">.</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-2-6-commitPackageSettings"><a href="#2-2-6-commitPackageSettings" class="headerlink" title="2.2.6 commitPackageSettings"></a>2.2.6 commitPackageSettings</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Adds a scanned package to the system. When this method is finished, the package will
 * be available for query, resolution, etc...
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commitPackageSettings</span><span class="token punctuation">(</span>PackageParser<span class="token punctuation">.</span>Package pkg<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> PackageParser<span class="token punctuation">.</span>Package oldPkg<span class="token punctuation">,</span> PackageSetting pkgSetting<span class="token punctuation">,</span> 
            UserHandle user<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> scanFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> chatty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> String pkgName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// mCustomResolverComponentName æ˜¯ä»ç³»ç»Ÿèµ„æºä¸­è¯»å‡ºçš„ï¼Œå¯ä»¥é…ç½®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCustomResolverComponentName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
                mCustomResolverComponentName<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è¿™é‡Œçš„ç”¨é€”å’Œä¸‹é¢åˆ¤æ–­ packageName æ˜¯å¦ä¸º "android" æœ‰è”ç³»ï¼Œ</span>
        <span class="token comment" spellcheck="true">// å› ä¸ºè°ƒç”¨ setUpCustomResolverActivity(pkg) å mResolverReplaced ä¸ºtrue</span>
        <span class="token function">setUpCustomResolverActivity</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// é’ˆå¯¹åŒ…åä¸º "android" çš„ apk è¿›è¡Œå¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_CHECK_ONLY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Set up information for our fall-back user intent resolution activity.</span>
                <span class="token comment" spellcheck="true">// ä¸ºæˆ‘ä»¬å›é€€çš„é¡µé¢é…ç½®ä¿¡æ¯</span>
                mPlatformPackage <span class="token operator">=</span> pkg<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">=</span> mSdkVersion<span class="token punctuation">;</span>
                pkg<span class="token punctuation">.</span>mVersionCodeMajor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                mAndroidApplication <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœä¸Šé¢çš„ä»£ç ä¸­è°ƒç”¨äº† setUpCustomResolverActivity æ–¹æ³•ï¼Œ</span>
                <span class="token comment" spellcheck="true">// åœ¨ setUpCustomResolverActivity æ–¹æ³•é‡Œé¢è®¾ç½®äº† mResolverReplaced = true</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰è°ƒç”¨ setUpCustomResolverActivity æ–¹æ³•ï¼Œ</span>
                <span class="token comment" spellcheck="true">// é…ç½®ç›¸åº” mResolveActivity çš„å±æ€§</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mResolverReplaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mResolveActivity<span class="token punctuation">.</span>applicationInfo <span class="token operator">=</span> mAndroidApplication<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>name <span class="token operator">=</span> ResolverActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>packageName <span class="token operator">=</span> mAndroidApplication<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>processName <span class="token operator">=</span> <span class="token string">"system:ui"</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>launchMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>LAUNCH_MULTIPLE<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>documentLaunchMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>DOCUMENT_LAUNCH_NEVER<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>flags <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>FLAG_EXCLUDE_FROM_RECENTS<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>theme <span class="token operator">=</span> R<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Theme_Material_Dialog_Alert<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>exported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>resizeMode <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>RESIZE_MODE_RESIZEABLE<span class="token punctuation">;</span>
                    mResolveActivity<span class="token punctuation">.</span>configChanges <span class="token operator">=</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SCREEN_SIZE
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SMALLEST_SCREEN_SIZE
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SCREEN_LAYOUT
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_ORIENTATION
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_KEYBOARD
                            <span class="token operator">|</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_KEYBOARD_HIDDEN<span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> mResolveActivity<span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>priority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>preferredOrder <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    mResolveInfo<span class="token punctuation">.</span>match <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    mResolveComponentName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
                             mAndroidApplication<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> mResolveActivity<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// åœ¨æ­¤ä¹‹å‰ï¼Œå››å¤§ç»„ä»¶çš„ä¿¡æ¯éƒ½æ˜¯ Package å¯¹è±¡çš„ç§æœ‰å˜é‡ï¼Œé€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œ</span>
        <span class="token comment" spellcheck="true">// å°†ä»–ä»¬æ³¨å†Œåˆ° PackageManagerService é‡Œé¢ï¼Œ</span>
        <span class="token comment" spellcheck="true">// è¿™æ · PackageManagerService å°±æœ‰äº†æ‰€æœ‰çš„ç»„ä»¶ä¿¡æ¯</span>
        <span class="token keyword">int</span> N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StringBuilder r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ³¨å†Œ pkg é‡Œé¢çš„ provider åˆ° PackageManagerService ä¸Šçš„ mProvider ä¸Š</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageParser<span class="token punctuation">.</span>Provider p <span class="token operator">=</span> pkg<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®è¿›ç¨‹åç§°ï¼Œå¦‚æœåœ¨ AndroidManifest é‡Œé¢é…ç½®äº†è¿›ç¨‹åç§°ï¼Œå°±ä»¥é…ç½®ä¸ºå‡†ï¼Œ</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°±æ˜¯é»˜è®¤åŒ…å</span>
            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>processName <span class="token operator">=</span> <span class="token function">fixProcessName</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                        p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mProviders<span class="token punctuation">.</span><span class="token function">addProvider</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span>syncable <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>isSyncable<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String names<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>syncable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>Provider</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        p<span class="token punctuation">.</span>syncable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>authority <span class="token operator">+</span> <span class="token string">";"</span> <span class="token operator">+</span> names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        PackageParser<span class="token punctuation">.</span>Provider other <span class="token operator">=</span> mProvidersByAuthority<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>chatty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// æ³¨å†Œè¯¥ Package ä¸­çš„ service åˆ° PackageManagerService çš„ mServices ä¸Š</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// æ³¨å†Œ pkg é‡Œé¢çš„ receiver åˆ° PackageManagerService ä¸Šçš„ mReceivers ä¸Š</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mReceivers<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// æ³¨å†Œ pkg é‡Œé¢çš„ activity åˆ° PackageManagerService ä¸Šçš„ mActivities ä¸Š</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            mActivities<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Don't allow ephemeral applications to define new permissions groups.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permission groups from package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName
                    <span class="token operator">+</span> <span class="token string">" ignored: instant apps cannot define new permission groups."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mPermissionManager<span class="token punctuation">.</span><span class="token function">addAllPermissionGroups</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Don't allow ephemeral applications to define new permissions.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>scanFlags <span class="token operator">&amp;</span> SCAN_AS_INSTANT_APP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Permissions from package "</span> <span class="token operator">+</span> pkg<span class="token punctuation">.</span>packageName
                    <span class="token operator">+</span> <span class="token string">" ignored: instant apps cannot define new permissions."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mPermissionManager<span class="token punctuation">.</span><span class="token function">addAllPermissions</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> chatty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//  æ³¨å†Œ pkg é‡Œé¢çš„ instrumentation åˆ° PackageManagerService çš„ mInstrumentation ä¸­</span>
        <span class="token comment" spellcheck="true">// Instrumentation ç”¨æ¥è·Ÿè¸ªæœ¬åº”ç”¨å†…çš„ application åŠ activity çš„ç”Ÿå‘½å‘¨æœŸ</span>
        N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageParser<span class="token punctuation">.</span>Instrumentation a <span class="token operator">=</span> pkg<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>sourceDir <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>sourceDir<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>publicSourceDir <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>publicSourceDir<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitSourceDirs <span class="token operator">=</span> pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitSourceDirs<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            mInstrumentation<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getComponentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// å¦‚æœæœ‰åŒ…å†…å¹¿æ’­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>protectedBroadcasts <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            N <span class="token operator">=</span> pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mProtectedBroadcasts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mProtectedBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>protectedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-3-æ‰«æéç³»ç»Ÿ-Package"><a href="#2-3-æ‰«æéç³»ç»Ÿ-Package" class="headerlink" title="2.3 æ‰«æéç³»ç»Ÿ Package"></a>2.3 æ‰«æéç³»ç»Ÿ Package</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/* 
 * mOnlyCore ç”¨äºæ§åˆ¶æ˜¯å¦æ‰«æéç³»ç»Ÿ Package
 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do this first before mucking with mPackages for the "expecting better" case</span>
    <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageParser<span class="token punctuation">.</span>Package<span class="token operator">></span> pkgIterator <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>pkgIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package pkg <span class="token operator">=</span> pkgIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>isStub<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stubSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> psit <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>psit<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PackageSetting ps <span class="token operator">=</span> psit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * If this is not a system app, it can't be a
         * disable system app.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*
         * If the package is scanned, it's not erased.
         */</span>
        <span class="token keyword">final</span> PackageParser<span class="token punctuation">.</span>Package scannedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scannedPkg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">removePackageLI</span><span class="token punctuation">(</span>scannedPkg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mExpectingBetter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">,</span> ps<span class="token punctuation">.</span>codePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSettings<span class="token punctuation">.</span><span class="token function">isDisabledSystemPackageLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            psit<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PackageSetting disabledPs <span class="token operator">=</span>
                    mSettings<span class="token punctuation">.</span><span class="token function">getDisabledSystemPkgLPr</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>disabledPs<span class="token punctuation">.</span>codePath <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>disabledPs<span class="token punctuation">.</span>codePath<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> disabledPs<span class="token punctuation">.</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                possiblyDeletedUpdatedSystemApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mOnlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// æ‰«æ /data/app ç›®å½•</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>mAppInstallDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// æ‰«æ /data/app-private ç›®å½•</span>
    <span class="token function">scanDirTracedLI</span><span class="token punctuation">(</span>mDrmAppPrivateInstallDir<span class="token punctuation">,</span> mDefParseFlags
            <span class="token operator">|</span> PackageParser<span class="token punctuation">.</span>PARSE_FORWARD_LOCK<span class="token punctuation">,</span>
            scanFlags <span class="token operator">|</span> SCAN_REQUIRE_KNOWN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è¿™é‡Œæ£€æŸ¥ç”¨æˆ·ç›®å½•ä¸‹å‡çº§æ–‡ä»¶æ˜¯å¦è¿˜å­˜åœ¨ï¼Œç„¶åè¿›è¡Œå¤„ç†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String deletedAppName <span class="token operator">:</span> possiblyDeletedUpdatedSystemApps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PackageParser<span class="token punctuation">.</span>Package deletedPkg <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// ä» mSettings.mDisabledSysPackages å˜é‡ä¸­ç§»é™¤å»æ­¤åº”ç”¨</span>
        mSettings<span class="token punctuation">.</span><span class="token function">removeDisabledSystemPackageLPw</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String msg<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// ç”¨æˆ·ç›®å½•ä¸­ä¹Ÿæ²¡æœ‰å‡çº§åŒ…ï¼Œåˆ™è‚¯å®šæ˜¯æ®‹ç•™çš„åº”ç”¨ä¿¡æ¯ï¼Œåˆ™æŠŠå®ƒçš„æ•°æ®ç›®å½•åˆ é™¤æ‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deletedPkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">=</span> <span class="token string">"Updated system package "</span> <span class="token operator">+</span> deletedAppName
                    <span class="token operator">+</span> <span class="token string">" no longer exists; removing its data"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœåœ¨ç”¨æˆ·ç©ºé—´æ‰¾åˆ°äº†æ–‡ä»¶ï¼Œåˆ™è¯´æ˜ç³»ç»Ÿç›®å½•ä¸‹çš„æ–‡ä»¶å¯èƒ½è¢«åˆ é™¤äº†ï¼Œ</span>
        <span class="token comment" spellcheck="true">// å› æ­¤ï¼ŒæŠŠåº”ç”¨çš„ç³»ç»Ÿå±æ€§å»æ‰ï¼Œä»¥æ™®é€šåº”ç”¨çš„æ–¹å¼è¿è¡Œ</span>
            msg <span class="token operator">=</span> <span class="token string">"Updated system package + "</span> <span class="token operator">+</span> deletedAppName
                    <span class="token operator">+</span> <span class="token string">" no longer exists; revoking system privileges"</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> PackageSetting deletedPs <span class="token operator">=</span> mSettings<span class="token punctuation">.</span>mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deletedAppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            deletedPkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>
            deletedPs<span class="token punctuation">.</span>pkgFlags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æŠ¥å‘Šç³»ç»Ÿå‘ç”Ÿäº†ä¸ä¸€è‡´çš„æƒ…å†µ</span>
        <span class="token function">logCriticalInfo</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>WARN<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// å¤„ç† mExpectingBetter åˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨çš„åº”ç”¨æ˜¯å¸¦æœ‰å‡çº§åŒ…çš„ç³»ç»Ÿçš„åº”ç”¨ï¼Œ</span>
    <span class="token comment" spellcheck="true">// å‰é¢æŠŠä»–ä»¬ä» mPackages åˆ—è¡¨ä¸­æ¸…é™¤äº†å¹¶æ”¾åˆ° mExpectingBetter åˆ—è¡¨ï¼Œ</span>
    <span class="token comment" spellcheck="true">// æœ€åä¹Ÿå¯¹ä»–ä»¬è¿›è¡Œæ‰«æå¤„ç†ï¼Œä½†ä¸ä¼šæ”¾åˆ° mPackages ä¸­ã€‚</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String packageName <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> File scanFile <span class="token operator">=</span> mExpectingBetter<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token annotation punctuation">@ParseFlags</span> <span class="token keyword">int</span> reparseFlags<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token annotation punctuation">@ScanFlags</span> <span class="token keyword">int</span> rescanFlags<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¡®ä¿åº”ç”¨ä½äºä¸‹é¢çš„ç³»ç»Ÿåº”ç”¨ç›®å½•ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™ä¸éœ€è¦å¤„ç†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>systemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedVendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>
                       <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedOdmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_VENDOR
                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>vendorAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span>
                       <span class="token operator">||</span> FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>odmAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_VENDOR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>oemAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_OEM<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>privilegedProductAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_PRODUCT
                        <span class="token operator">|</span> SCAN_AS_PRIVILEGED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>FileUtils<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>productAppDir<span class="token punctuation">,</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                reparseFlags <span class="token operator">=</span>
                        mDefParseFlags <span class="token operator">|</span>
                        PackageParser<span class="token punctuation">.</span>PARSE_IS_SYSTEM_DIR<span class="token punctuation">;</span>
                rescanFlags <span class="token operator">=</span>
                        scanFlags
                        <span class="token operator">|</span> SCAN_AS_SYSTEM
                        <span class="token operator">|</span> SCAN_AS_PRODUCT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Ignoring unexpected fallback path "</span> <span class="token operator">+</span> scanFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœåº”ç”¨ä¸åœ¨ä¸Šé¢è¿™äº›ç›®å½•ï¼Œç»§ç»­å¾ªç¯ï¼Œä¸è¦å¤„ç†</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mSettings<span class="token punctuation">.</span><span class="token function">enableSystemPackageLPw</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡æ–°æ‰«æä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ª &lt;update-package> æ ‡ç­¾</span>
                <span class="token function">scanPackageTracedLI</span><span class="token punctuation">(</span>scanFile<span class="token punctuation">,</span> reparseFlags<span class="token punctuation">,</span> scanFlags<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManagerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Slog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to parse original system package: "</span>
                        <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Uncompress and install any stubbed system applications.</span>
    <span class="token comment" spellcheck="true">// This must be done last to ensure all stubs are replaced or disabled.</span>
    <span class="token function">decompressSystemApplications</span><span class="token punctuation">(</span>stubSystemApps<span class="token punctuation">,</span> scanFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> cachedNonSystemApps <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>sCachedPackageReadCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">-</span> cachedSystemApps<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">long</span> dataScanTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemScanTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> dataPackagesCount <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> systemPackagesCount<span class="token punctuation">;</span>
    Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Finished scanning non-system apps. Time: "</span> <span class="token operator">+</span> dataScanTime
            <span class="token operator">+</span> <span class="token string">" ms, packageCount: "</span> <span class="token operator">+</span> dataPackagesCount
            <span class="token operator">+</span> <span class="token string">" , timePerPackage: "</span>
            <span class="token operator">+</span> <span class="token punctuation">(</span>dataPackagesCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> dataScanTime <span class="token operator">/</span> dataPackagesCount<span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token string">" , cached: "</span> <span class="token operator">+</span> cachedNonSystemApps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIsUpgrade <span class="token operator">&amp;&amp;</span> dataPackagesCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MetricsLogger<span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"ota_package_manager_data_app_avg_scan_time"</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> dataScanTime<span class="token punctuation">)</span> <span class="token operator">/</span> dataPackagesCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ã€€ã€€ã€€ã€€<span class="token comment" spellcheck="true">//ã€€æ‰«æéç³»ç»Ÿ apkã€€å·¥ä½œå®Œæˆï¼</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="ä¸‰ã€æ‰«å°¾å·¥ä½œ"><a href="#ä¸‰ã€æ‰«å°¾å·¥ä½œ" class="headerlink" title="ä¸‰ã€æ‰«å°¾å·¥ä½œ"></a>ä¸‰ã€æ‰«å°¾å·¥ä½œ</h1><p>è¿™éƒ¨åˆ†ä»»åŠ¡æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†ç¬¬äºŒé˜¶æ®µ APK çš„ä¿¡æ¯å†é›†ä¸­æ•´ç†ä¸€æ¬¡ï¼Œå¯è‡ªè¡Œç ”ç©¶ã€‚</p>
<hr>
<h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://www.2cto.com/kf/201609/551752.html" target="_blank" rel="noopener">Android7.0 PackageManagerService (2) PKMSæ„é€ å‡½æ•°çš„ä¸»è¦å·¥ä½œ</a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/8e2831428110" target="_blank" rel="noopener">APKå®‰è£…æµç¨‹è¯¦è§£7â€”â€”PackageManagerServiceçš„å¯åŠ¨æµç¨‹(ä¸Š)</a></p>
<hr>
<h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/01/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%881%EF%BC%89%E4%B9%8B%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/10/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%883%EF%BC%89%E4%B9%8B%20PackageManager/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ3ï¼‰- PackageManager</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>å¾®ä¿¡é‡Œç‚¹â€œå‘ç°â€->â€œæ‰«ä¸€æ‰«â€äºŒç»´ç ä¾¿å¯æŸ¥çœ‹åˆ†äº«ã€‚</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;è½¬è½½è¯·æ³¨æ˜:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/01/05/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-2-gou-zao-han-shu/" class="b-link-green">PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScriptã€‚</noscript>
    </div>
    <!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2019/01/12/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-3-packagemanager/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager">
                        
                        <span class="card-title">PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰



&nbsp;
ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹





ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ Packag</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="post-category" target="_blank">
                                    æ¡†æ¶æœåŠ¡
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                    <a href="/tags/PackageManager/" target="_blank">
                        <span class="chip bg-color">PackageManager</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/01/01/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-1-qi-dong-liu-cheng/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹">
                        
                        <span class="card-title">PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰



&nbsp;
ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹





ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ Packag</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="post-category" target="_blank">
                                    æ¡†æ¶æœåŠ¡
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: Thinking in Android<br />'
            + 'ä½œè€…: Marco<br />'
            + 'é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQè”ç³»æˆ‘: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;æ£€ç´¢åšæ–‡</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„æŠ€æœ¯å…³é”®å­—" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src=""></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>