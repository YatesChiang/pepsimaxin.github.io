<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="PackageManagerService 钻研（5）- PackageParser, Hexo">
    <meta name="description" content="
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&amp;nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PackageManagerService 钻研（5）- PackageParser | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/四大组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/启动阶段/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/核心机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>机制</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>拓展</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术细节/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="检索博文"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/四大组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/启动阶段/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/核心机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                机制
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                拓展
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        <li>
            <a href="/categories/技术细节/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/PackageManagerService.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        PackageManagerService 钻研（5）- PackageParser
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/PackageManagerService/" target="_blank">
                                <span class="chip bg-color">PackageManagerService</span>
                            </a>
                        
                            <a href="/tags/PackageParser/" target="_blank">
                                <span class="chip bg-color">PackageParser</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                框架服务
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;发布日期 :&nbsp;
                    2019-01-22
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;文章字数 :&nbsp;
                        3.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;阅读时长 :&nbsp;
                        15 分钟
                    </div>
                    
                
				
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<p><strong><center><font color="#3A5FCD" size="4">PackageManagerService 系列文章如下（基于 Android 9.0 源码）</font><center></center></center></strong><br></p>
<table>
<thead>
<tr>
<th style="text-align:center">&nbsp;</th>
<th style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（1）- 启动流程</font></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（2）- 构造函数</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（3）- PackageManager</font></a></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（4）- PackageInstaller</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（5）- APK 安装流程（1）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（6）- APK 安装流程（2）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（7）- PackageParser</font></a></td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong><font color="#3A5FCD" size="4">修订日志</font></strong><br></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1、博文格式，文章排版优化；</font></p>
<hr>
<h1 id="一、开篇"><a href="#一、开篇" class="headerlink" title="一、开篇"></a>一、开篇</h1><h2 id="1-1-核心源码"><a href="#1-1-核心源码" class="headerlink" title="1.1 核心源码"></a>1.1 核心源码</h2><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">PackageParser.java</font></td>
<td>frameworks/base/core/java/android/content/pm/PackageParser.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageManagerService.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td>
</tr>
</tbody>
</table>
<p><br></p>
<h2 id="1-2-简介"><a href="#1-2-简介" class="headerlink" title="1.2 简介"></a>1.2 简介</h2><p>在分析 <code>PackageManagerService</code> 构造函数的时候，我们知道：Android 安装一个 APK 的时候首先会解析 APK，而解析 APK 则需要用到一个工具类，这个工具类就是我们这篇博文的主角 <code>PackageParser</code>（在我们之前研究的源码中，你已经见过它的身影了）！<br><br></p>
<h1 id="二、PackageParser"><a href="#二、PackageParser" class="headerlink" title="二、PackageParser"></a>二、PackageParser</h1><h2 id="2-1-官方说明"><a href="#2-1-官方说明" class="headerlink" title="2.1 官方说明"></a>2.1 官方说明</h2><p>首先我们看下官方对 PackageParser 的说明：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Parser for package files (APKs) on disk. This supports apps packaged either
 * as a single "monolithic" APK, or apps packaged as a "cluster" of multiple
 * APKs in a single directory.
 * &lt;p>
 * Apps packaged as multiple APKs always consist of a single "base" APK (with a
 * {@code null} split name) and zero or more "split" APKs (with unique split
 * names). Any subset of those split APKs are a valid install, as long as the
 * following constraints are met:
 * &lt;ul>
 * &lt;li>All APKs must have the exact same package name, version code, and signing
 * certificates.
 * &lt;li>All APKs must have unique split names.
 * &lt;li>All installations must contain a single base APK.
 * &lt;/ul>
 *
 * 翻译如下：
 * 解析磁盘上的 APK 安装包文件。它既能解析一个"单一" APK 文件，也能解析一个"集群" APK 文件
　* (即一个 APK 文件里面包含多个 APK 文件)。一个"集群" APK 有一个"基准" APK (base APK) 组成
 * 和其他一些"分割" APK ("split" APKs) 构成，其中这些"分割" APK 用一些数字来分割。
 * 这些"分割"的 APK 必须都是有效的安装，同时必须满足下面的几个条件：
 *     所有的 APK 必须具有完全相同的软件包名称，版本代码和签名证书；
 *     所有的 APK 必须具有唯一的拆分名称；
 *     所有安装必须包含一个单一的APK；
 * 
 * @hide
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageParser</span> <span class="token punctuation">{</span>
</code></pre>
<p><br></p>
<h2 id="2-2-创建解析器"><a href="#2-2-创建解析器" class="headerlink" title="2.2 创建解析器"></a>2.2 创建解析器</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 具体源码及逻辑流程省略...</span>

<span class="token comment" spellcheck="true">// 创建解析器</span>
<span class="token keyword">final</span> PackageParser pp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 APK</span>
tmpPkg <span class="token operator">=</span> pp<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>codePath<span class="token punctuation">,</span> parseFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><br></p>
<h2 id="2-3-解析-APK"><a href="#2-3-解析-APK" class="headerlink" title="2.3 解析 APK"></a>2.3 解析 APK</h2><p>在分析 PackageParser 解析 APK 之前，我们有必要了解一下 Split APK 机制！<br><br></p>
<h3 id="2-3-1-Split-APK机制"><a href="#2-3-1-Split-APK机制" class="headerlink" title="2.3.1 Split APK机制"></a>2.3.1 Split APK机制</h3><p>Split APK 是 Google 为解决 65536 上限，以及 APK 安装包越来越大等问题，在 <code>Android L</code> 中引入的机制。 Split APK 可以将一个庞大的 APK，按屏幕密度，ABI 等形式拆分成多个独立的 APK，在应用程序更新时，不必下载整个 APK，只需单独下载某个模块即可安装更新。</p>
<p>Split APK 将原来一个 APK 中多个模块共享同一份资源的模型分离成多个 APK 使用各自的资源，并且可以继承 Base APK 中的资源，多个 APK 有相同的 data，cache 目录。</p>
<blockquote>
<p>在引入了 Split APK 机制后，APK 有两种分类：<br><code>Single APK</code>：安装文件为一个完整的 APK，即 Base APK，源码中定义为 <code>Monolithic</code>。<br><code>Mutiple APK</code>：安装文件在一个文件目录中，其内部有多个被拆分的 APK，这些 APK 由一个 Base APK 和一个或多个 Split APK 组成，源码中定义为 <code>Cluster</code>。</p>
</blockquote>
<h3 id="2-3-2-parsePackage"><a href="#2-3-2-parsePackage" class="headerlink" title="2.3.2 parsePackage"></a>2.3.2 parsePackage</h3><p>接下来我们开始正式分析 parsePackage 方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Equivalent to {@link #parsePackage(File, int, boolean)} with {@code useCaches == false}.
 */</span>
<span class="token keyword">public</span> Package <span class="token function">parsePackage</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">parsePackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* useCaches */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>新增一个 <code>useCaches</code> 参数：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Package <span class="token function">parsePackage</span><span class="token punctuation">(</span>File packageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useCaches<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
    Package parsed <span class="token operator">=</span> useCaches <span class="token operator">?</span> <span class="token function">getCachedResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> parsed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> parseTime <span class="token operator">=</span> LOG_PARSE_TIMINGS <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果解析的 packageFile 是一个目录，则调用 parseClusterPackage 方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageFile<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parsed <span class="token operator">=</span> <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果是单个 APK 文件，则调用 parseMonolithicPackage　方法</span>
        parsed <span class="token operator">=</span> <span class="token function">parseMonolithicPackage</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> cacheTime <span class="token operator">=</span> LOG_PARSE_TIMINGS <span class="token operator">?</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">cacheResult</span><span class="token punctuation">(</span>packageFile<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG_PARSE_TIMINGS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parseTime <span class="token operator">=</span> cacheTime <span class="token operator">-</span> parseTime<span class="token punctuation">;</span>
        cacheTime <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cacheTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parseTime <span class="token operator">+</span> cacheTime <span class="token operator">></span> LOG_PARSE_TIMINGS_THRESHOLD_MS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Slog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Parse times for '"</span> <span class="token operator">+</span> packageFile <span class="token operator">+</span> <span class="token string">"': parse="</span> <span class="token operator">+</span> parseTime
                    <span class="token operator">+</span> <span class="token string">"ms, update_cache="</span> <span class="token operator">+</span> cacheTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> parsed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们这边选取 parseClusterPackage 作为分析的分支，当你搞懂这个方法的具体逻辑，单个 APK 的解析原理就很简单了。</p>
<center><img src="https://upload-images.jianshu.io/upload_images/3517194-702816956a0fec31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></center>

<p><br></p>
<h1 id="三、parseClusterPackage"><a href="#三、parseClusterPackage" class="headerlink" title="三、parseClusterPackage"></a>三、parseClusterPackage</h1><p>我们来看看 <code>parseClusterPackage()</code> 的源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Package <span class="token function">parseClusterPackage</span><span class="token punctuation">(</span>File packageDir<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*
     * 调用 parseClusterPackageLite 方法用于轻量级解析目录文件，
     * 之所以要轻量级解析是因为解析 APK 是一个复杂耗时的操作，这里的逻辑并不需要 APK 所有的信息。
     */</span>
    <span class="token keyword">final</span> PackageLite lite <span class="token operator">=</span> <span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * mOnlyCoreApps 用来指示 PackageParser 是否只解析“核心”应用，
     * “核心”应用指的是 AndroidManifest 中 coreApp 的属性值为 true，
     * 只解析“核心”应用是为了创建一个极简的启动环境，
     * 我们可以通过 PackageParser 的 setOnlyCoreApps 方法来设置 mOnlyCoreApps 的值。
     *
     * lite.coreApp 表示当前包是否包含“核心”应用，如果不满足条件就会抛出异常。
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mOnlyCoreApps <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lite<span class="token punctuation">.</span>coreApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">,</span>
                <span class="token string">"Not a coreApp: "</span> <span class="token operator">+</span> packageDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Build the split dependency tree.</span>
    SparseArray<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> splitDependencies <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">final</span> SplitAssetLoader assetLoader<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lite<span class="token punctuation">.</span>isolatedSplits <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            splitDependencies <span class="token operator">=</span> 
                          SplitAssetDependencyLoader<span class="token punctuation">.</span><span class="token function">createDependenciesFromPackage</span><span class="token punctuation">(</span>lite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            assetLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SplitAssetDependencyLoader</span><span class="token punctuation">(</span>lite<span class="token punctuation">,</span> splitDependencies<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SplitAssetDependencyLoader<span class="token punctuation">.</span>IllegalDependencyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span> 
                                             e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        assetLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSplitAssetLoader</span><span class="token punctuation">(</span>lite<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取 AssetManager 对象</span>
        <span class="token keyword">final</span> AssetManager assets <span class="token operator">=</span> assetLoader<span class="token punctuation">.</span><span class="token function">getBaseAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> File baseApk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 解析 base APK，获得对应的 Package 对象</span>
        <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>baseApk<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_NOT_APK<span class="token punctuation">,</span>
                    <span class="token string">"Failed to parse base APK: "</span> <span class="token operator">+</span> baseApk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取 split APK 的数量</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

            pkg<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>splitCodePaths <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitCodePaths<span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>splitRevisionCodes <span class="token operator">=</span> lite<span class="token punctuation">.</span>splitRevisionCodes<span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>splitFlags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>splitPrivateFlags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitNames <span class="token operator">=</span> pkg<span class="token punctuation">.</span>splitNames<span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitDependencies <span class="token operator">=</span> splitDependencies<span class="token punctuation">;</span>
            pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>splitClassLoaderNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> AssetManager splitAssets <span class="token operator">=</span> assetLoader<span class="token punctuation">.</span><span class="token function">getSplitAssetManager</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 解析每个 split APK</span>
                <span class="token function">parseSplitApk</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> i<span class="token punctuation">,</span> splitAssets<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 设置相应属性</span>
        pkg<span class="token punctuation">.</span><span class="token function">setCodePath</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">.</span><span class="token function">getCanonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span><span class="token function">setUse32bitAbi</span><span class="token punctuation">(</span>lite<span class="token punctuation">.</span>use32bitAbi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION<span class="token punctuation">,</span>
                <span class="token string">"Failed to get path: "</span> <span class="token operator">+</span> lite<span class="token punctuation">.</span>baseCodePath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>assetLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="3-1-parseClusterPackageLite"><a href="#3-1-parseClusterPackageLite" class="headerlink" title="3.1 parseClusterPackageLite"></a>3.1 parseClusterPackageLite</h2><p>我们来看看轻量级解析函数 <code>parseClusterPackageLite()</code> 的源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> PackageLite <span class="token function">parseClusterPackageLite</span><span class="token punctuation">(</span>File packageDir<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> 
                                           <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isApkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 通过 parseApkLite 方法解析每个 Mutiple APK，</span>
            <span class="token comment" spellcheck="true">// 得到每个 Mutiple APK 对应的 ApkLite（轻量级 APK 信息）。</span>
            <span class="token keyword">final</span> ApkLite lite <span class="token operator">=</span> <span class="token function">parseApkLite</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">final</span> String codePath <span class="token operator">=</span> packageDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 将这些 ApkLite 封装为一个 PackageLite（轻量级包信息）并返回</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PackageLite</span><span class="token punctuation">(</span>codePath<span class="token punctuation">,</span> baseApk<span class="token punctuation">,</span> splitNames<span class="token punctuation">,</span> isFeatureSplits<span class="token punctuation">,</span> usesSplitNames<span class="token punctuation">,</span>
            configForSplits<span class="token punctuation">,</span> splitCodePaths<span class="token punctuation">,</span> splitRevisionCodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><br></p>
<h2 id="3-2-parseBaseApk"><a href="#3-2-parseBaseApk" class="headerlink" title="3.2 parseBaseApk"></a>3.2 parseBaseApk</h2><p>我们来看看 Base Apk 的解析函数 <code>parseBaseApk()</code> 的源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String MNT_EXPAND <span class="token operator">=</span> <span class="token string">"/mnt/expand/"</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>File apkFile<span class="token punctuation">,</span> AssetManager assets<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
                             <span class="token keyword">throws</span> PackageParserException <span class="token punctuation">{</span>
    <span class="token keyword">final</span> String apkPath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    String volumeUuid <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>apkPath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> end <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果 APK 的路径以 /mnt/expand/ 开头，就截取该路径获取 volumeUuid</span>
        volumeUuid <span class="token operator">=</span> apkPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>MNT_EXPAND<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_SUCCEEDED<span class="token punctuation">;</span>
    mArchiveSourcePath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG_JAR<span class="token punctuation">)</span> Slog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Scanning base APK: "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    XmlResourceParser parser <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> cookie <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">findCookieForPath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_BAD_MANIFEST<span class="token punctuation">,</span>
                    <span class="token string">"Failed adding asset path: "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        parser <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">openXmlResourceParser</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> ANDROID_MANIFEST_FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Resources res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resources</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> mMetrics<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 再次调用 parseBaseApk 方法</span>
        <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>mParseError<span class="token punctuation">,</span>
                    apkPath <span class="token operator">+</span> <span class="token string">" (at "</span> <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"): "</span> <span class="token operator">+</span> outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 用于以后标识这个解析后的 Package</span>
        pkg<span class="token punctuation">.</span><span class="token function">setVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 用于标识该 App 所在的存储卷 UUID</span>
        pkg<span class="token punctuation">.</span><span class="token function">setApplicationVolumeUuid</span><span class="token punctuation">(</span>volumeUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span><span class="token function">setBaseCodePath</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pkg<span class="token punctuation">.</span><span class="token function">setSigningDetails</span><span class="token punctuation">(</span>SigningDetails<span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PackageParserException</span><span class="token punctuation">(</span>INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION<span class="token punctuation">,</span>
                <span class="token string">"Failed to read manifest from "</span> <span class="token operator">+</span> apkPath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        IoUtils<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这个方法内部主要就是做了两件事：</p>
<blockquote>
<p>1、解析 volumeUuid<br>  2、调用 parseBaseApk(res, parser, flags, outError) 来获取 Package 对象 pkg 并返回</p>
</blockquote>
<p><br></p>
<h2 id="3-3-parseBaseApk-重载"><a href="#3-3-parseBaseApk-重载" class="headerlink" title="3.3 parseBaseApk 重载"></a>3.3 parseBaseApk 重载</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Package <span class="token function">parseBaseApk</span><span class="token punctuation">(</span>String apkPath<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span> XmlResourceParser parser<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">final</span> String splitName<span class="token punctuation">;</span>
    <span class="token keyword">final</span> String pkgName<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 用包名创建一个 Package 对象</span>
    <span class="token keyword">final</span> Package pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 从资源中提取自定义属性集 com.android.internal.R.styleable.AndroidManifest 得到 TypedArray </span>
    TypedArray sa <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">obtainAttributes</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span>
            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 初始化 pkg 的属性</span>
    pkg<span class="token punctuation">.</span>mVersionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkg<span class="token punctuation">.</span>mVersionCodeMajor <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionCodeMajor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span><span class="token function">setVersionCode</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">getLongVersionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkg<span class="token punctuation">.</span>baseRevisionCode <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_revisionCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_versionName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pkg<span class="token punctuation">.</span>mVersionName <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mVersionName<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 读取 APK 的 AndroidManifest 中的 coreApp 的值，判断是否为核心 Apk</span>
    pkg<span class="token punctuation">.</span>coreApp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeBooleanValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"coreApp"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pkg<span class="token punctuation">.</span>mCompileSdkVersion <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>
            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_compileSdkVersion<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>compileSdkVersion <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersion<span class="token punctuation">;</span>
    pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">=</span> sa<span class="token punctuation">.</span><span class="token function">getNonConfigurationString</span><span class="token punctuation">(</span>
            com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>styleable<span class="token punctuation">.</span>AndroidManifest_compileSdkVersionCodename<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>compileSdkVersionCodename <span class="token operator">=</span> pkg<span class="token punctuation">.</span>mCompileSdkVersionCodename<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 获取资源后要回收</span>
    sa<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">parseBaseApkCommon</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> null<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><br></p>
<h2 id="3-4-parseBaseApkCommon"><a href="#3-4-parseBaseApkCommon" class="headerlink" title="3.4 parseBaseApkCommon"></a>3.4 parseBaseApkCommon</h2><p>最终调用了 <code>parseBaseApkCommon</code> 方法，这个方法主要用来解析 APK 的 <code>AndroidManifest</code> 中的 <code>各个标签</code>，比如 application、permission、uses-sdk、feature-group 等等。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Package <span class="token function">parseBaseApkCommon</span><span class="token punctuation">(</span>Package pkg<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>String<span class="token operator">></span> acceptedTags<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>
        XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span> <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span>
        IOException <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 是否要安装在 SD 卡上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PARSE_EXTERNAL_STORAGE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pkg<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>flags <span class="token operator">|=</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_EXTERNAL_STORAGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 开始解析 xml</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> outerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// private static final String TAG_APPLICATION = "application";</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>foundApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>RIGID_PARSER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outError<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"&lt;manifest> has more than one &lt;application>"</span><span class="token punctuation">;</span>
                    mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"&lt;manifest> has more than one &lt;application>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            foundApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 其中四大组件的标签在 application 标签下，</span>
            <span class="token comment" spellcheck="true">// 解析 application 标签的方法为 parseBaseApplication。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TAG_OVERLAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><br></p>
<h2 id="3-5-parseBaseApplication"><a href="#3-5-parseBaseApplication" class="headerlink" title="3.5 parseBaseApplication"></a>3.5 parseBaseApplication</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// parseBaseApplication 方法很长，我们这里只截取了解析四大组件相关的代码。</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseBaseApplication</span><span class="token punctuation">(</span>Package owner<span class="token punctuation">,</span> Resources res<span class="token punctuation">,</span>
        XmlResourceParser parser<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> outError<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> XmlPullParserException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_DOCUMENT
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> parser<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> innerDepth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>END_TAG <span class="token operator">||</span> type <span class="token operator">==</span> XmlPullParser<span class="token punctuation">.</span>TEXT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String tagName <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 调用 parseActivity 方法解析 activity 标签，</span>
            <span class="token comment" spellcheck="true">// 得到一个 Activity 对象（PackageParser 的静态内部类）</span>
            Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    owner<span class="token punctuation">.</span>baseHardwareAccelerated<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 将解析得到的 Activity 对象保存在 Package 的列表 activities 中</span>
            owner<span class="token punctuation">.</span>activities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            parsedComponent <span class="token operator">=</span> a<span class="token punctuation">.</span>info<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"receiver"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Activity a <span class="token operator">=</span> <span class="token function">parseActivity</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">,</span>
                    <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            owner<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            parsedComponent <span class="token operator">=</span> a<span class="token punctuation">.</span>info<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Service s <span class="token operator">=</span> <span class="token function">parseService</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            owner<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            parsedComponent <span class="token operator">=</span> s<span class="token punctuation">.</span>info<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"provider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Provider p <span class="token operator">=</span> <span class="token function">parseProvider</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> outError<span class="token punctuation">,</span> cachedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParseError <span class="token operator">=</span> PackageManager<span class="token punctuation">.</span>INSTALL_PARSE_FAILED_MANIFEST_MALFORMED<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            owner<span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            parsedComponent <span class="token operator">=</span> p<span class="token punctuation">.</span>info<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><br></p>
<h2 id="3-6-总结"><a href="#3-6-总结" class="headerlink" title="3.6 总结"></a>3.6 总结</h2><p>PackageParser 解析 APK 的代码逻辑非常庞大且复杂，基本了解了本文所涉及的逻辑和原理，分析问题基本上足够了，如果有兴趣可以自行深入的研究源码。</p>
<p>parseBaseApk 方法主要的解析结构可以理解为以下简图：<br><br></p>
<center><img src="https://upload-images.jianshu.io/upload_images/3517194-f8f66b9d2ba70154.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt="1417629-1a9039e0ad81bf21.png"></center>

<h1 id="四、Package-数据结构"><a href="#四、Package-数据结构" class="headerlink" title="四、Package 数据结构"></a>四、Package 数据结构</h1><p>包被解析后，最终存储在 <code>Package</code> ，它是 <code>PackageParser</code> 的<code>内部类</code>，它的部分成员变量如下所示。</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * Representation of a full package parsed from APK files on disk. A package
 * consists of a single base APK, and zero or more split APKs.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Package</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> String packageName<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// The package name declared in the manifest as the package can be</span>
    <span class="token comment" spellcheck="true">// renamed, for example static shared libs use synthetic package names.</span>
    <span class="token keyword">public</span> String manifestPackageName<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** Names of any split APKs, ordered by parsed splitName */</span>
    <span class="token keyword">public</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitNames<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// TODO: work towards making these paths invariant</span>

    <span class="token keyword">public</span> String volumeUuid<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * Path where this package was found on disk. For monolithic packages
     * this is path to single base APK file; for cluster packages this is
     * path to the cluster directory.
     */</span>
    <span class="token keyword">public</span> String codePath<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** Path of base APK */</span>
    <span class="token keyword">public</span> String baseCodePath<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/** Paths of any split APKs, ordered by parsed splitName */</span>
    <span class="token keyword">public</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> splitCodePaths<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


    <span class="token comment" spellcheck="true">// For now we only support one application per package.</span>
    <span class="token keyword">public</span> ApplicationInfo applicationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Permission<span class="token operator">></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Permission<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>PermissionGroup<span class="token operator">></span> permissionGroups <span class="token operator">=</span> 
                                                     <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>PermissionGroup<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* 
     * activities 列表中存储了类型为 Activity 的对象，需要注意的是这个 Acticity 并不是
     * 我们常用的那个 Activity ，而是 PackageParser 的静态内部类，Package 中的其他列表也都是如此。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Activity<span class="token operator">></span> activities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Activity<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Activity<span class="token operator">></span> receivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Activity<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Provider<span class="token operator">></span> providers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Provider<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Service<span class="token operator">></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Service<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Instrumentation<span class="token operator">></span> instrumentation <span class="token operator">=</span> 
                                               <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Instrumentation<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Package 的数据结构简图如下所示：</p>
<center><img src="https://upload-images.jianshu.io/upload_images/3517194-12ea4aeb503246b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></center>

<p>从这个简图中可以发现 Package 的数据结构是如何设计的：</p>
<p>1、Package 中存有许多组件，比如 Acticity、Provider、Permission 等等，它们都继承基类 Component。<br>2、每个组件都包含一个 info 数据，比如 Activity 类中包含了成员变量 ActivityInfo，这个 ActivityInfo 才是真正的 Activity 数据。<br>3、四大组件的标签内可能包含 <intent-filter> 来过滤 Intent 信息，因此需要 IntentInfo 来保存组件的 intent 信息，组件基类 Component 依赖于 IntentInfo，IntentInfo 有三个子类 ActivityIntentInfo、ServiceIntentInfo 和 ProviderIntentInfo，不同组件依赖的 IntentInfo 会有所不同，比如 Activity 继承自Component<activityintentinfo> ，Permission 继承自 Component<intentinfo> 。</intentinfo></activityintentinfo></intent-filter></p>
<p>最终的解析的数据会封装到 Package 中。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>&nbsp;📕 01. <a href="http://liuwangshu.cn/framework/pms/5-packageparser.html" target="_blank" rel="noopener">Android包管理机制（五）APK是如何被解析的</a><br>&nbsp;📕 02. <a href="https://www.jianshu.com/p/69fb6f9a6ac7" target="_blank" rel="noopener">APK安装流程详解9——PackageParser解析APK(上)</a></p>
<h1 id="索引链接"><a href="#索引链接" class="headerlink" title="索引链接"></a>索引链接</h1><p>推荐跳转：<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">博客索引（Android 9.0）</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/15/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%884%EF%BC%89%E4%B9%8B%20PackageInstaller/">Framework 核心服务之 PMS 钻研（4）- PackageInstaller</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/23/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%886%EF%BC%89%E4%B9%8B%20APK%20%E5%AE%89%E8%A3%85%EF%BC%88%E4%B8%8A%EF%BC%89/">Framework 核心服务之 PMS 钻研（6）- APK 安装流程（上）</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Hexo</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/01/22/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-5-zhi-packageparser/" class="b-link-green">PackageManagerService 钻研（5）- PackageParser</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript。</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/01/26/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-6-zhi-apk-an-zhuang-shang/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService 钻研（6）- APK 安装（上）">
                        
                        <span class="card-title">PackageManagerService 钻研（6）- APK 安装（上）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                    <a href="/tags/APK-安装/" target="_blank">
                        <span class="chip bg-color">APK 安装</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/01/16/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-4-zhi-packageinstaller/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService 钻研（4）- PackageInstaller">
                        
                        <span class="card-title">PackageManagerService 钻研（4）- PackageInstaller</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                    <a href="/tags/PackageInstaller/" target="_blank">
                        <span class="chip bg-color">PackageInstaller</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Hexo<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
		</div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;检索博文</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的技术关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->





</body>
</html>