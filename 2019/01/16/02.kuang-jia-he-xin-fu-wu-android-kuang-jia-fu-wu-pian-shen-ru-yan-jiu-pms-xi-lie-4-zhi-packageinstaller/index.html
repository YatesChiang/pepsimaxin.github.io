<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="PackageManagerService 钻研（4）- PackageInstaller, Hexo">
    <meta name="description" content="
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&amp;nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PackageManagerService 钻研（4）- PackageInstaller | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>目录</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/四大组件/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>组件</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/启动阶段/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>开机</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/框架服务/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>框架</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/核心机制/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>机制</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/性能优化/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>优化</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/设计模式/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>模式</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/算法专栏/" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>算法</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术储备/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>拓展</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>作者</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/技术细节/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="检索博文"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                目录
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories/四大组件/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                组件
            </a>
        </li>
        
        <li>
            <a href="/categories/启动阶段/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                开机
            </a>
        </li>
        
        <li>
            <a href="/categories/框架服务/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                框架
            </a>
        </li>
        
        <li>
            <a href="/categories/核心机制/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                机制
            </a>
        </li>
        
        <li>
            <a href="/categories/性能优化/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                优化
            </a>
        </li>
        
        <li>
            <a href="/categories/设计模式/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                模式
            </a>
        </li>
        
        <li>
            <a href="/categories/算法专栏/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                算法
            </a>
        </li>
        
        <li>
            <a href="/categories/技术储备/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                拓展
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                作者
            </a>
        </li>
        
        <li>
            <a href="/categories/技术细节/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/PackageManagerService.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        PackageManagerService 钻研（4）- PackageInstaller
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/PackageManagerService/" target="_blank">
                                <span class="chip bg-color">PackageManagerService</span>
                            </a>
                        
                            <a href="/tags/PackageInstaller/" target="_blank">
                                <span class="chip bg-color">PackageInstaller</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                框架服务
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;发布日期 :&nbsp;
                    2019-01-16
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;文章字数 :&nbsp;
                        5.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;阅读时长 :&nbsp;
                        26 分钟
                    </div>
                    
                
				
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<p><strong><center><font color="#3A5FCD" size="4">PackageManagerService 系列文章如下（基于 Android 9.0 源码）</font><center></center></center></strong><br></p>
<table>
<thead>
<tr>
<th style="text-align:center">&nbsp;</th>
<th style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（1）- 启动流程</font></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（2）- 构造函数</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（3）- PackageManager</font></a></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（4）- PackageInstaller</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（5）- APK 安装流程（1）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（6）- APK 安装流程（2）</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">系统核心服务之 PackageManagerService 钻研（7）- PackageParser</font></a></td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong><font color="#3A5FCD" size="4">修订日志</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1、重新梳理 PackageInstaller 源码流程（Android 9.0）；</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2、博文格式，文章排版优化；</font></p>
<hr>
<h1 id="一、开篇"><a href="#一、开篇" class="headerlink" title="一、开篇"></a>一、开篇</h1><h2 id="1-1-核心源码"><a href="#1-1-核心源码" class="headerlink" title="1.1 核心源码"></a>1.1 核心源码</h2><table>
<thead>
<tr>
<th>关键类</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">PackageInstaller.java</font></td>
<td>/frameworks/base/core/java/android/content/pm/PackageInstaller.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageManager.java</font></td>
<td>/frameworks/base/core/java/android/content/pm/PackageManager.java</td>
</tr>
<tr>
<td><font color="#D15FEE">ApplicationPackageManager.java</font></td>
<td>/frameworks/base/core/java/android/app/ApplicationPackageManager.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageUtil.java</font></td>
<td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageUtil.java</td>
</tr>
<tr>
<td><font color="#D15FEE">InstallStart.java</font></td>
<td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStart.java</td>
</tr>
<tr>
<td><font color="#D15FEE">InstallStaging.java</font></td>
<td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStaging.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageInstallerActivity.java</font></td>
<td>/packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageInstallerActivity.java</td>
</tr>
</tbody>
</table>
<h2 id="1-2-PackageManager"><a href="#1-2-PackageManager" class="headerlink" title="1.2 PackageManager"></a>1.2 PackageManager</h2><p>在详细讲解包管理机制如何安装 APK 之前，我们回顾一下前面一篇文章讲解的 <font color="#FF0000"><strong>PackageManager</strong></font>。</p>
<p><code>PackageManager</code> 是一个<code>抽象类</code>，它的具体实现类为 <code>ApplicationPackageManager</code> 。</p>
<p><code>ApplicationPackageManager</code> 中的方法会通过 <code>IPackageManager</code> 与 <code>PackageManagerService</code> 进行进程间通信，因此 <code>PackageManager</code> 所提供的功能最终是由 <code>PackageManagerService</code> 来实现的，这么设计的主要用意是为了避免系统服务 PMS 直接被访问。</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// PackageManager 是一个抽象类</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ApplicationPackageManager 继承自 PackageManager</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="1-3-关于-APK"><a href="#1-3-关于-APK" class="headerlink" title="1.3 关于 APK"></a>1.3 关于 APK</h2><blockquote>
<p>文件结构和安装方式</p>
</blockquote>
<p><code>APK</code> 是 <code>AndroidPackage</code> 的缩写，即 <code>Android 安装包</code>，它实际上是 <code>zip</code> 格式的压缩文件，一般情况下，解压后的文件结构如下表所示。</p>
<table>
<thead>
<tr>
<th>目录/文件</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>assert</td>
<td>存放的原生资源文件，通过 AssetManager 类访问。</td>
</tr>
<tr>
<td>lib</td>
<td>存放库文件。</td>
</tr>
<tr>
<td>META-INF</td>
<td>保存应用的签名信息，签名信息可以验证 APK 文件的完整性。</td>
</tr>
<tr>
<td>res</td>
<td>存放资源文件。res 中除了 raw 子目录，其他的子目录都参与编译，这些子目录下的资源是通过编译出的 R 类在代码中访问。</td>
</tr>
<tr>
<td>AndroidManifest.xml</td>
<td>用来声明应用程序的包名称、版本、组件和权限等数据。 apk 中的 AndroidManifest.xml 经过压缩，可以通过 AXMLPrinter2 工具解开。</td>
</tr>
<tr>
<td>classes.dex</td>
<td>Java 源码编译后生成的 Java 字节码文件。</td>
</tr>
<tr>
<td>resources.arsc</td>
<td>编译后的二进制资源文件。</td>
</tr>
</tbody>
</table>
<blockquote>
<p>安装场景</p>
</blockquote>
<p>目前，我们常见的安装 APK 的场景主要分为以下 <font color="#FF0000"><strong>四种</strong></font>：（这四种方式后面都单独进行研究）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;1、通过 adb 命令安装：adb 命令包括 <code>adb push/install</code>。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;2、用户下载的 Apk，通过系统安装器 <code>packageinstaller</code>（系统内置的应用程序，用于安装和卸载应用程序）安装该 Apk。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;3、系统开机时安装系统应用。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;4、电脑或者手机上的应用商店自动安装。</p>
<p>其实，这 4 种方式最终都是由 <code>PackageManagerService</code> 来进行处理，只是在此之前的调用链（逻辑）是不同的。</p>
<p>我们在接下来的分析中，会优先选择第二种方式，因为对于开发者来说，这是调用链比较长的安装方式，其他三种方式也会再跟一遍逻辑，梳理 4 种逻辑的差异点。</p>
<p>我们首先看下这种安装方式的<font color="#0000CD"> <strong>实际效果图</strong> </font>：（后面我们分析源码的流程会紧密联系着这几张图，大家可以对比理解！）</p>
<p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-7404e3513b6871cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="未知权限.png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-7f3099737f62e7b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="开启权限.png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-836d60ebb88bea77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="确定安装.png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-088d3c221086bffb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="安装界面.png">&nbsp;&nbsp;<img src="https://upload-images.jianshu.io/upload_images/3517194-6ce997c33e3193a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="安装完成.png"></center><br><br></p>
<blockquote>
<p>安装目录</p>
</blockquote>
<table>
<thead>
<tr>
<th>目录/文件</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/system/app</td>
<td>系统自带的应用程序，获得 adb root 权限才能删除。</td>
</tr>
<tr>
<td>/data/app</td>
<td>用户程序安装的目录，安装时把 apk 文件复制到此目录。</td>
</tr>
<tr>
<td>/data/data</td>
<td>存放应用程序的数据。</td>
</tr>
<tr>
<td>/data/dalvik-cache</td>
<td>将 apk 中的 dex 文件安装到 dalvik-cache 目录下，用于虚拟机安装的可执行文件。</td>
</tr>
<tr>
<td>/data/system</td>
<td>该目录下的 packages.xml 文件类似于 Window 的注册表，这个文件是解析 apk 时由 writeLP() 创建的，里面记录了系统的 permissons，以及每个 apk 的 name，codePath，flag，ts，version ，userid 等信息，这些信息主要通过 apk 的 AndroidManifest 解析获取，解析完 apk 后将更新信息写入这个文件并保存到 flash，下次开机的时候直接从里面读取相关信息并添加到内存相关列表中。当有 apk 升级，安装或删除时会更新这个文件。</td>
</tr>
<tr>
<td>/data/system/package.xml</td>
<td>包含了该应用申请的权限、签名和代码所在的位置等信息系，并且两者都有同一个 userld。之所以每个应用都要一个 userId，是因为 Android 在系统设计上把每个应用当做 Linux 系统上的一个用户对待，这样就可以利用已有的 Linux 用户管理机制来设计 Android 应用，比如应用目录，应用权限，应用进程管理等。</td>
</tr>
<tr>
<td>/data/system/package.list</td>
<td>指定了应用的默认存储位置 /data/data/com.xxx.xxx。</td>
</tr>
</tbody>
</table>
<h1 id="二、PackageInstaller"><a href="#二、PackageInstaller" class="headerlink" title="二、PackageInstaller"></a>二、PackageInstaller</h1><h2 id="2-1-初始化"><a href="#2-1-初始化" class="headerlink" title="2.1 初始化"></a>2.1 初始化</h2><p>首先，我们需要指出的是：从 Android 8.0 开始系统是通过如下代码安装指定路径中的 APK：</p>
<pre class=" language-java"><code class="language-java">Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
intent<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"file://"</span> <span class="token operator">+</span> apkfile<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Intent 的 <code>Action</code> 属性为 <code>ACTION_VIEW</code>，Type 属性指定 <code>Intent</code> 的数据类型为 <code>application/vnd.android.package-archive</code>。</p>
<font color="#0000CD"><strong>“application/vnd.android.package-archive” 是什么？</strong></font>

<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> MIME_MapTable<span class="token operator">=</span><span class="token punctuation">{</span> 
    <span class="token comment" spellcheck="true">//{后缀名，MIME类型} </span>
    <span class="token punctuation">{</span><span class="token string">".3gp"</span><span class="token punctuation">,</span>    <span class="token string">"video/3gpp"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{</span><span class="token string">".apk"</span><span class="token punctuation">,</span>    <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{</span><span class="token string">".asf"</span><span class="token punctuation">,</span>    <span class="token string">"video/x-ms-asf"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{</span><span class="token string">".avi"</span><span class="token punctuation">,</span>    <span class="token string">"video/x-msvideo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p>我们发现 <code>&quot;application/vnd.android.package-archive&quot;</code> 其实就是<code>文件类型</code>，具体对应 <code>apk</code> 类型。</p>
<p>那么这个 <code>Intent 隐式匹配的 Activity</code> 是什么？这边我们直接告诉你：<font color="#FF0000"><strong>InstallStart</strong></font> ！为什么？源码为证！</p>
<p>（源码中，7.0 隐式匹配的 Activity 为 <font color="#FF0000"><strong>PackageInstallerActivity</strong></font> ，两者的区别我们后面会讲解到！）。</p>
<pre class=" language-xml"><code class="language-xml">// packages/apps/PackageInstaller/AndroidManifest.xml
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.InstallStart<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>excludeFromRecents</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span> <span class="token attr-name"><span class="token namespace">android:</span>priority</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.VIEW<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.action.INSTALL_PACKAGE<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.intent.category.DEFAULT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>scheme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>data</span> <span class="token attr-name"><span class="token namespace">android:</span>mimeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>application/vnd.android.package-archive<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
    ... ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span>
</code></pre>
<h2 id="2-2-InstallStart"><a href="#2-2-InstallStart" class="headerlink" title="2.2 InstallStart"></a>2.2 InstallStart</h2><p>其实，<code>InstallStart</code> 是 <code>PackageInstaller</code> 的<code>入口</code>。当我们调用 <code>PackageInstaller</code> 来安装应用时会跳转到 <code>InstallStart</code>，并调用它的 <code>onCreate</code> 方法，我们来看看源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallStart</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mIPackageManager <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Intent intent <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String callingPackage <span class="token operator">=</span> <span class="token function">getCallingPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">/**
         * public static final String ACTION_CONFIRM_PERMISSIONS = 
                                     "android.content.pm.action.CONFIRM_PERMISSIONS";
         * 判断 Intent 的 Action 是否为 CONFIRM_PERMISSIONS ;
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ACTION_CONFIRM_PERMISSIONS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 我们探讨的情景会走这边</span>
            Uri packageUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 保证 packageUri 不为 null，判断 packageUri 的 Scheme 协议是否是 content 或者 File</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">!=</span> null 
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ContentResolver<span class="token punctuation">.</span>SCHEME_FILE<span class="token punctuation">)</span>
                    <span class="token operator">||</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ContentResolver<span class="token punctuation">.</span>SCHEME_CONTENT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 跳转到 InstallStaging （Android 8.0 - 9.0）</span>
                nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> InstallStaging<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">!=</span> null
                <span class="token operator">&amp;&amp;</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>PackageInstallerActivity<span class="token punctuation">.</span>SCHEME_PACKAGE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 跳转到 PackageInstallerActivity（Android 7.0）</span>
                nextActivity<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                Intent result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_INSTALL_RESULT<span class="token punctuation">,</span>
                        PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setResult</span><span class="token punctuation">(</span>RESULT_FIRST_USER<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

                nextActivity <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextActivity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 启动相应的 Activity（InstallStaging 或者 PackageInstallerActivity）</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span>nextActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-3-InstallStaging"><a href="#2-3-InstallStaging" class="headerlink" title="2.3 InstallStaging"></a>2.3 InstallStaging</h2><p>我们是基于 Android 9.0 的代码进行的分析，所以会走到 <code>InstallStaging</code> 分支，继续看源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallStaging</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// This is the first onResume in a single life of the activity</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStagingTask <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// File does not exist, or became invalid</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mStagedFile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Create file delayed to be able to show error</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果 File 类型的 mStagedFile 为 null，</span>
                    <span class="token comment" spellcheck="true">// 则创建 mStagedFile，mStagedFile 用于存储临时数据</span>
                    mStagedFile <span class="token operator">=</span> TemporaryFileManager<span class="token punctuation">.</span><span class="token function">getStagedFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">showError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mStagingTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StagingAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 启动 StagingAsyncTask 线程，并传入了 content 协议的 Uri</span>
            mStagingTask<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们可以看到，<font color="#0000CD"><strong>InstallStaging 主要做了两部分工作</strong></font>：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;1、判断 <code>mStagingTask</code> 是否为空，主要用于存储临时数据；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;2、创建并启动 <code>StagingAsyncTask</code> 线程。</p>
<h2 id="2-4-StagingAsyncTask"><a href="#2-4-StagingAsyncTask" class="headerlink" title="2.4 StagingAsyncTask"></a>2.4 StagingAsyncTask</h2><p>接下来，我们看看这个线程所做的工作：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// /packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStaging.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstallStaging</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">StagingAsyncTask</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Uri<span class="token punctuation">,</span> Void<span class="token punctuation">,</span> Boolean<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> Boolean <span class="token function">doInBackground</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> null <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Uri packageUri <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span>InputStream in <span class="token operator">=</span> <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openInputStream</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 将 packageUri（content协议的Uri）的内容写入到 mStagedFile 中                 </span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span>OutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>mStagedFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> bytesRead<span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesRead <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> SecurityException <span class="token operator">|</span> IllegalStateException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Error staging apk from content URI"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span>Boolean success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Intent installIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 如果写入成功，跳转到 DeleteStagedFileOnResult            </span>
                installIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span>InstallStaging<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> DeleteStagedFileOnResult<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 并将 mStagedFile 传进去</span>
                installIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span>mStagedFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>installIntent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_RETURN_RESULT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    installIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_FORWARD_RESULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                installIntent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">startActivity</span><span class="token punctuation">(</span>installIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

                InstallStaging<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">showError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-5-DeleteStagedFileOnResult"><a href="#2-5-DeleteStagedFileOnResult" class="headerlink" title="2.5 DeleteStagedFileOnResult"></a>2.5 DeleteStagedFileOnResult</h2><p><code>doInBackground</code> 方法中将 <code>packageUri</code>（content 协议的 Uri）的内容写入到 <code>mStagedFile</code> 中，如果写入成功，<code>onPostExecute</code> 方法中会跳转到 <code>DeleteStagedFileOnResult</code> 中，并将 <code>mStagedFile</code> 传进去。</p>
<p>直接看下源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeleteStagedFileOnResult</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Intent installIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 跳转到 PackageInstallerActivity</span>
            installIntent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> PackageInstallerActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            installIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NO_ANIMATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>installIntent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sourceFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setResult</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-6-小结"><a href="#2-6-小结" class="headerlink" title="2.6 小结"></a>2.6 小结</h2><p><font color="#0000CD"><strong>绕了一圈又回到了 PackageInstallerActivity</strong></font>，这里可以看出 <code>InstallStaging</code> 主要起了转换的作用，将 <code>content</code> 协议的 <code>Uri</code> 转换为 <code>File</code> 协议，然后跳转到 <code>PackageInstallerActivity</code>，接下来的安装流程就和 Android 7.0 一样了。</p>
<h1 id="三、PackageInstallerActivity"><a href="#三、PackageInstallerActivity" class="headerlink" title="三、PackageInstallerActivity"></a>三、PackageInstallerActivity</h1><p>接下来，我们就要重点分析 <code>PackageInstallerActivity</code> ！从功能上来说，<font color="#FF0000"><strong>PackageInstallerActivity 才是应用安装器 PackageInstaller 真正的入口 Activity</strong></font>。</p>
<p>我们看下官方对于这个类的说明：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * This activity is launched when a new application is installed via side loading
 * The package is first parsed and the user is notified of parse errors via a dialog.
 * If the package is successfully parsed, the user is notified to turn on the install unknown
 * applications setting. A memory check is made at this point and the user is notified of out
 * of memory conditions if any. If the package is already existing on the device,
 * a confirmation dialog (to replace the existing package) is presented to the user.
 * Based on the user response the package is then installed by launching InstallAppConfirm
 * sub activity. All state transitions are handled in this activity.
 */</span>

<span class="token comment" spellcheck="true">/**
 * 当通过渠道安装一个应用程序的时候，会启动这个 Activity。
 * 如果在首次解析这个安装包的时候出现解析错误，会通过对话框的形式告诉用户。
 * 如果首次解析安装包的时候，成功解析了，则会通知用户去打开"安装未知应用程序设置"。
 * 在启动 Activity 的时候会进行内存检查，如果内存不足会通知用户。
 * 如果这个应用程序已经在这个设备安装过了，则会向用户弹出一个对话框询问用户是否"替换现有应用程序的安装包"。
 * 基于用户的回应，然后通过 InstallAppConfirm 的子类来安装应用程序。
 * 所有状态的转换都是在这 Activity 中处理。
 */</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>了解完了官方说明，接下来我们查看它的 <code>onCreate()</code> 方法！</p>
<h2 id="3-1-onCreate"><a href="#3-1-onCreate" class="headerlink" title="3.1 onCreate"></a>3.1 onCreate</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    PackageManager mPm<span class="token punctuation">;</span>
    IPackageManager mIpm<span class="token punctuation">;</span>
    AppOpsManager mAppOpsManager<span class="token punctuation">;</span>
    PackageInstaller mInstaller<span class="token punctuation">;</span>
    UserManager mUserManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle icicle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>icicle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>icicle <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAllowUnknownSources <span class="token operator">=</span> icicle<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>ALLOW_UNKNOWN_SOURCES_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 初始话 PackageManager 对象：具体用来执行安装操作，最终的功能由 PMS 来实现；</span>
        mPm <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token comment" spellcheck="true">// 初始话 IPackageManager 对象：一个 AIDL 的接口，用于和 PMS 进行进程间通信；</span>
        mIpm <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token comment" spellcheck="true">// 初始化 AppOpsManager 对象：用于权限动态检测，在，Android 4.3 中被引入；</span>
        mAppOpsManager <span class="token operator">=</span> <span class="token punctuation">(</span>AppOpsManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>APP_OPS_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token comment" spellcheck="true">// 初始化 PackageInstaller 对象：在该对象中包含了安装 APK 的基本信息；</span>
        mInstaller <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getPackageInstaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token comment" spellcheck="true">// 初始化 UserManager 对象：用于多用户管理；</span>
        mUserManager <span class="token operator">=</span> <span class="token punctuation">(</span>UserManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>USER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> Uri packageUri<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>ACTION_CONFIRM_PERMISSIONS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 可能是系统级别的应用安装时，需要授权走这个流程</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> sessionId <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>PackageInstaller<span class="token punctuation">.</span>EXTRA_SESSION_ID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> PackageInstaller<span class="token punctuation">.</span>SessionInfo info <span class="token operator">=</span> mInstaller<span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            mSessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>
            packageUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">fromFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>resolvedBaseCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOriginatingURI <span class="token operator">=</span> null<span class="token punctuation">;</span>
            mReferrerURI <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果是用户自己拉起来的安装，则默认 sessionId 为 -1，并且获取 packageUri</span>
            mSessionId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            packageUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOriginatingURI <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_ORIGINATING_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mReferrerURI <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>EXTRA_REFERRER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 返回 URI 解析错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageUri <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unspecified source"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_URI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 如果设备为手表，则不支持</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DeviceUtils<span class="token punctuation">.</span><span class="token function">isWear</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_NOT_SUPPORTED_ON_WEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 根据 Uri 的 Scheme 进行预处理</span>
        <span class="token comment" spellcheck="true">// 💥 💥 💥 重点方法 1 💥 💥 💥 </span>
        <span class="token keyword">boolean</span> wasSetUp <span class="token operator">=</span> <span class="token function">processPackageUri</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasSetUp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 判断是否是未知来源的应用，如果开启允许安装未知来源选项则直接初始化安装</span>
        <span class="token comment" spellcheck="true">// 💥 💥 💥 重点方法 2 💥 💥 💥</span>
        <span class="token function">checkIfAllowedAndInitiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="3-2-processPackageUri"><a href="#3-2-processPackageUri" class="headerlink" title="3.2 processPackageUri"></a>3.2 processPackageUri</h2><p>我们首先来看看 <code>processPackageUri</code> 所做的工作：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processPackageUri</span><span class="token punctuation">(</span><span class="token keyword">final</span> Uri packageUri<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPackageURI <span class="token operator">=</span> packageUri<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 得到 packageUri 的 Scheme 协议</span>
        <span class="token keyword">final</span> String scheme <span class="token operator">=</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 根据这个 Scheme 协议分别对 package 协议和 file 协议进行处理</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>scheme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 处理 scheme 为 package 的情况</span>
            <span class="token keyword">case</span> SCHEME_PACKAGE<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 获取 package 对应的 Android 应用信息 PackageInfo</span>
                    <span class="token comment" spellcheck="true">// 如：应用名称，权限列表等...</span>
                    mPkgInfo <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        PackageManager<span class="token punctuation">.</span>GET_PERMISSIONS
                                        <span class="token operator">|</span> PackageManager<span class="token punctuation">.</span>MATCH_UNINSTALLED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// 如果无法获取 PackageInfo ，弹出一个错误的对话框，然后直接退出安装</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPkgInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Requested package "</span> <span class="token operator">+</span> packageUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" not available. Discontinuing installation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_PACKAGE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_APK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 创建 AppSnipet 对象，该对象封装了待安装 Android 应用的标题和图标</span>
                mAppSnippet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageUtil<span class="token punctuation">.</span>AppSnippet</span><span class="token punctuation">(</span>
                                  mPm<span class="token punctuation">.</span><span class="token function">getApplicationLabel</span><span class="token punctuation">(</span>mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  mPm<span class="token punctuation">.</span><span class="token function">getApplicationIcon</span><span class="token punctuation">(</span>mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 处理 scheme 为 file 的情况</span>
            <span class="token keyword">case</span> ContentResolver<span class="token punctuation">.</span>SCHEME_FILE<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 根据 packageUri 创建一个新的 File</span>
                File sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 创建 APK 文件的分析器 parsed，💥 💥 💥 重点方法 💥 💥 💥 </span>
                PackageParser<span class="token punctuation">.</span>Package parsed <span class="token operator">=</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 说明解析错误，则弹出对话框，并退出安装</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Parse error when parsing manifest..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_PACKAGE_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setPmResult</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>INSTALL_FAILED_INVALID_APK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// 走到这边，说明解析成功，对 parsed 进一步处理得到包信息 PackageInfo，获取权限部分</span>
                mPkgInfo <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span><span class="token function">generatePackageInfo</span><span class="token punctuation">(</span>parsed<span class="token punctuation">,</span> null<span class="token punctuation">,</span>
                        PackageManager<span class="token punctuation">.</span>GET_PERMISSIONS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PackageUserState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// private PackageUtil.AppSnippet mAppSnippet; 获取 PackageUtil.AppSnippet，</span>
                <span class="token comment" spellcheck="true">// AppSnippet 是 PackageUtil 的静态内部类，内部封装了icon和label；</span>
                <span class="token comment" spellcheck="true">// AppSnippet 中只有两个属性：lable（应用名称）、icon（应用图标）;</span>
                <span class="token comment" spellcheck="true">// return new PackageUtil.AppSnippet(label, icon); 返回的是 label 和 icon.</span>
                mAppSnippet <span class="token operator">=</span> PackageUtil<span class="token punctuation">.</span><span class="token function">getAppSnippet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> 
                                                    mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 如果不是这两个协议就会抛出异常</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unexpected URI scheme "</span> <span class="token operator">+</span> packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-2-1-PackageUtil-getPackageInfo"><a href="#3-2-1-PackageUtil-getPackageInfo" class="headerlink" title="3.2.1 PackageUtil.getPackageInfo"></a>3.2.1 PackageUtil.getPackageInfo</h3><p>上面源码中创建 <code>APK</code> 文件的分析器 <code>parsed</code> 时，涉及一个重要的方法 <code>getPackageInfo()</code>，我们看下：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageUtil.java</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageUtil</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> PackageParser<span class="token punctuation">.</span>Package <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> File sourceFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 创建一个 PackageParser 对象</span>
        <span class="token keyword">final</span> PackageParser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        parser<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PackageParser<span class="token punctuation">.</span>CallbackImpl</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parsePackage</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="3-3-checkIfAllowedAndInitiateInstall"><a href="#3-3-checkIfAllowedAndInitiateInstall" class="headerlink" title="3.3 checkIfAllowedAndInitiateInstall"></a>3.3 checkIfAllowedAndInitiateInstall</h2><p>接下来我们看看 <code>checkIfAllowedAndInitiateInstall</code> 做所工作：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkIfAllowedAndInitiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> installAppsRestrictionSource <span class="token operator">=</span> mUserManager<span class="token punctuation">.</span><span class="token function">getUserRestrictionSource</span><span class="token punctuation">(</span>
                UserManager<span class="token punctuation">.</span>DISALLOW_INSTALL_APPS<span class="token punctuation">,</span> Process<span class="token punctuation">.</span><span class="token function">myUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>installAppsRestrictionSource <span class="token operator">&amp;</span> UserManager<span class="token punctuation">.</span>RESTRICTION_SOURCE_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_INSTALL_APPS_RESTRICTED_FOR_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>installAppsRestrictionSource <span class="token operator">!=</span> UserManager<span class="token punctuation">.</span>RESTRICTION_NOT_SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>ACTION_SHOW_ADMIN_SUPPORT_DETAILS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// isInstallRequestFromUnknownSource  -->  安装请求是否来自一个未知的源</span>
        <span class="token comment" spellcheck="true">// 判断如果允许安装未知来源或者根据 Intent 判断得出该 APK 不是未知来源</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAllowUnknownSources <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isInstallRequestFromUnknownSource</span><span class="token punctuation">(</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 初始化安装</span>
            <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// 💥 💥 💥 重点方法 1 💥 💥 💥 </span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> unknownSourcesRestrictionSource <span class="token operator">=</span> mUserManager<span class="token punctuation">.</span>
                            <span class="token function">getUserRestrictionSource</span><span class="token punctuation">(</span>
                                          UserManager<span class="token punctuation">.</span>DISALLOW_INSTALL_UNKNOWN_SOURCES<span class="token punctuation">,</span> 
                                          Process<span class="token punctuation">.</span><span class="token function">myUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果管理员限制来自未知源的安装, 就弹出提示 Dialog</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>unknownSourcesRestrictionSource <span class="token operator">&amp;</span> 
                                              UserManager<span class="token punctuation">.</span>RESTRICTION_SOURCE_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_UNKNOWN_SOURCES_RESTRICTED_FOR_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>unknownSourcesRestrictionSource <span class="token operator">!=</span> UserManager<span class="token punctuation">.</span>RESTRICTION_NOT_SET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>ACTION_SHOW_ADMIN_SUPPORT_DETAILS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">handleUnknownSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 💥 💥 💥 重点方法 2 💥 💥 💥 </span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="3-4-handleUnknownSources"><a href="#3-4-handleUnknownSources" class="headerlink" title="3.4 handleUnknownSources"></a>3.4 handleUnknownSources</h2><p>我们先来看看 <code>handleUnknownSources()</code> 的源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleUnknownSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOriginatingPackage <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"No source found for package "</span> <span class="token operator">+</span> mPkgInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_ANONYMOUS_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> appOpCode <span class="token operator">=</span> 
            AppOpsManager<span class="token punctuation">.</span><span class="token function">permissionToOpCode</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>REQUEST_INSTALL_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> appOpMode <span class="token operator">=</span> mAppOpsManager<span class="token punctuation">.</span><span class="token function">noteOpNoThrow</span><span class="token punctuation">(</span>appOpCode<span class="token punctuation">,</span>
                                                     mOriginatingUid<span class="token punctuation">,</span> mOriginatingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>appOpMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> AppOpsManager<span class="token punctuation">.</span>MODE_DEFAULT<span class="token operator">:</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> result <span class="token operator">=</span> mIpm<span class="token punctuation">.</span><span class="token function">checkUidPermission</span><span class="token punctuation">(</span>
                            Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>REQUEST_INSTALL_PACKAGES<span class="token punctuation">,</span> mOriginatingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> exc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Unable to talk to package manager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mAppOpsManager<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span>appOpCode<span class="token punctuation">,</span> mOriginatingUid<span class="token punctuation">,</span>
                        mOriginatingPackage<span class="token punctuation">,</span> AppOpsManager<span class="token punctuation">.</span>MODE_ERRORED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// fall through</span>

            <span class="token comment" spellcheck="true">// 我们看下这边，当系统默认不允许安装位置来源的应用时，会弹出一个 Dialog 等待用户确认</span>
            <span class="token keyword">case</span> AppOpsManager<span class="token punctuation">.</span>MODE_ERRORED<span class="token operator">:</span>
                <span class="token function">showDialogInner</span><span class="token punctuation">(</span>DLG_EXTERNAL_SOURCE_BLOCKED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AppOpsManager<span class="token punctuation">.</span>MODE_ALLOWED<span class="token operator">:</span>
                <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-4-1-showDialogInner"><a href="#3-4-1-showDialogInner" class="headerlink" title="3.4.1 showDialogInner"></a>3.4.1 showDialogInner</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">showDialogInner</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DialogFragment currentDialog <span class="token operator">=</span>
                <span class="token punctuation">(</span>DialogFragment<span class="token punctuation">)</span> <span class="token function">getFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFragmentByTag</span><span class="token punctuation">(</span><span class="token string">"dialog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentDialog <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentDialog<span class="token punctuation">.</span><span class="token function">dismissAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 创建一个 Dialog</span>
        DialogFragment newDialog <span class="token operator">=</span> <span class="token function">createDialog</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newDialog <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newDialog<span class="token punctuation">.</span><span class="token function">showAllowingStateLoss</span><span class="token punctuation">(</span><span class="token function">getFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dialog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-4-2-createDialog"><a href="#3-4-2-createDialog" class="headerlink" title="3.4.2 createDialog"></a>3.4.2 createDialog</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> DialogFragment <span class="token function">createDialog</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">case</span> DLG_EXTERNAL_SOURCE_BLOCKED<span class="token operator">:</span>
                <span class="token keyword">return</span> ExternalSourcesBlockedDialog<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>mOriginatingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> DLG_ANONYMOUS_SOURCE<span class="token operator">:</span>
                <span class="token keyword">return</span> AnonymousSourceDialog<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-4-3-ExternalSourcesBlockedDialog"><a href="#3-4-3-ExternalSourcesBlockedDialog" class="headerlink" title="3.4.3 ExternalSourcesBlockedDialog"></a>3.4.3 ExternalSourcesBlockedDialog</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">/**
     * An error dialog shown when external sources are not allowed
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExternalSourcesBlockedDialog</span> <span class="token keyword">extends</span> <span class="token class-name">AppErrorDialog</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> AppErrorDialog <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> String originationPkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ExternalSourcesBlockedDialog dialog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExternalSourcesBlockedDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dialog<span class="token punctuation">.</span><span class="token function">setArgument</span><span class="token punctuation">(</span>originationPkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> dialog<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> Dialog <span class="token function">createDialog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> CharSequence argument<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                PackageManager pm <span class="token operator">=</span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                ApplicationInfo sourceInfo <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>argument<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AlertDialog<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span><span class="token function">getApplicationLabel</span><span class="token punctuation">(</span>sourceInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span><span class="token function">getApplicationIcon</span><span class="token punctuation">(</span>sourceInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// untrusted_external_source_warning：出于安全考虑，已禁止您的手机安装</span>
                        <span class="token comment" spellcheck="true">// 来自此来源的未知应用，对应文章开头的操作图</span>
                        <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>untrusted_external_source_warning<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setPositiveButton</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>external_sources_settings<span class="token punctuation">,</span>
                                <span class="token punctuation">(</span>dialog<span class="token punctuation">,</span> which<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                                    Intent settingsIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    settingsIntent<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>
                                            Settings<span class="token punctuation">.</span>ACTION_MANAGE_UNKNOWN_APP_SOURCES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">final</span> Uri packageUri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"package:"</span> <span class="token operator">+</span> argument<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    settingsIntent<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>packageUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// ExternalSourcesDetails.java</span>
                                        <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span>settingsIntent<span class="token punctuation">,</span>
                                                REQUEST_TRUST_EXTERNAL_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ActivityNotFoundException</span> exc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setNegativeButton</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>cancel<span class="token punctuation">,</span>
                                <span class="token punctuation">(</span>dialog<span class="token punctuation">,</span> which<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Did not find app info for "</span> <span class="token operator">+</span> argument<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="3-5-initiateInstall"><a href="#3-5-initiateInstall" class="headerlink" title="3.5 initiateInstall"></a>3.5 initiateInstall</h2><p>解决了 <code>handleUnknownSources</code> 方法，我们再来看下遗留的 <code>initiateInstall</code> 方法的源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 判断如果允许安装未知来源或者根据 Intent 判断得出该 APK 不是未知来源</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initiateInstall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 得到包名</span>
        String pkgName <span class="token operator">=</span> mPkgInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 是否有同名应用已经安装上去了，在此安装则被认为是替换安装</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> oldName <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">canonicalToCurrentPackageNames</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> pkgName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> oldName<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> oldName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pkgName <span class="token operator">=</span> oldName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            mPkgInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkgName<span class="token punctuation">;</span>
            mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> pkgName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 检查这个包是否已安装，如果要替换，则显示替换对话框</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取设备上的残存数据，并且标记为 “installed” 的，实际上已经被卸载的应用</span>
            mAppInfo <span class="token operator">=</span> mPm<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span>
                    PackageManager<span class="token punctuation">.</span>MATCH_UNINSTALLED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mAppInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>ApplicationInfo<span class="token punctuation">.</span>FLAG_INSTALLED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果应用是被卸载的，但是又是被标识成安装过的，则认为是新安装</span>
                mAppInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAppInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 列出权限列表，等待用户确认安装</span>
        <span class="token function">startInstallConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们可以看到，<font color="#0000CD"><strong>initiateInstall 主要做了三件事</strong></font>：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;1、检查设备是否是同名安装，如果是则后续是替换安装。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;2、检查设备上是否已经安装了这个安装包，如果是，后面是替换安装。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;3、调用 <code>startInstallConfirm()</code> ，这个方法是安装的核心代码。</p>
<h2 id="3-6-startInstallConfirm"><a href="#3-6-startInstallConfirm" class="headerlink" title="3.6 startInstallConfirm"></a>3.6 startInstallConfirm</h2><p>下面我们就来看下 <code>startInstallConfirm()</code> 方法里面的具体实现：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageInstallerActivity</span> <span class="token keyword">extends</span> <span class="token class-name">OverlayTouchActivity</span> <span class="token keyword">implements</span> <span class="token class-name">OnClickListener</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInstallConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We might need to show permissions, load layout with permissions</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm_perm_update<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm_perm<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">(</span><span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>install_confirm_question<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question<span class="token punctuation">)</span><span class="token punctuation">;</span>
        TabHost tabHost <span class="token operator">=</span> <span class="token punctuation">(</span>TabHost<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tabhost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tabHost<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ViewPager viewPager <span class="token operator">=</span> <span class="token punctuation">(</span>ViewPager<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>pager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        TabsAdapter adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TabsAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tabHost<span class="token punctuation">,</span> viewPager<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 根据 sdk 版本来判断 app 是否支持运行时权限</span>
        <span class="token comment" spellcheck="true">// 如果 app 支持运行时权限，这里会显示新的运行时权限</span>
        <span class="token keyword">boolean</span> supportsRuntimePermissions <span class="token operator">=</span> mPkgInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>targetSdkVersion
                <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>M<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 显示权限列表的变量，true：显示权限列表，false：未显示权限列表</span>
        <span class="token keyword">boolean</span> permVisible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mScrollView <span class="token operator">=</span> null<span class="token punctuation">;</span>
        mOkCanInstall <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> msg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// perms 这个对象包括了该应用的用户的 uid 以及相应的一些权限，以及权限组信息</span>
        AppSecurityPermissions perms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppSecurityPermissions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mPkgInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 获取隐私相关权限的数量</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> N <span class="token operator">=</span> perms<span class="token punctuation">.</span><span class="token function">getPermissionCount</span><span class="token punctuation">(</span>AppSecurityPermissions<span class="token punctuation">.</span>WHICH_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 判断是否为已经安装过的应用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果已经安装过则继续判断是否为系统应用</span>
            msg <span class="token operator">=</span> <span class="token punctuation">(</span>mAppInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                    <span class="token operator">?</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update_system
                    <span class="token operator">:</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 用来显示权限列表的 scrollview</span>
            mScrollView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CaffeinatedScrollView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果显示的内容超过了 mScrollView ，则就会折叠可以滚动</span>
            mScrollView<span class="token punctuation">.</span><span class="token function">setFillViewport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> newPermissionsFound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsRuntimePermissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 针对更新应用程序相对于旧版本而判断是否加入新的权限</span>
                <span class="token comment" spellcheck="true">// AppSecurityPermissions.WHICH_NEW  -->  新加入的权限</span>
                newPermissionsFound <span class="token operator">=</span>
                        <span class="token punctuation">(</span>perms<span class="token punctuation">.</span><span class="token function">getPermissionCount</span><span class="token punctuation">(</span>AppSecurityPermissions<span class="token punctuation">.</span>WHICH_NEW<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newPermissionsFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 将新的权限列表视频添加到滚动视图中</span>
                    permVisible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 调用 AppSecurityPermissions 的 getPermissionsView 方法来获取</span>
                    <span class="token comment" spellcheck="true">// PermissionItemView，将 PermissionItemView 添加到 </span>
                    <span class="token comment" spellcheck="true">// CaffeinatedScrollView，这样安装该 APK 需要访问的</span>
                    <span class="token comment" spellcheck="true">// 系统权限就可以全部的展示出来了</span>
                    mScrollView<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>perms<span class="token punctuation">.</span><span class="token function">getPermissionsView</span><span class="token punctuation">(</span>
                            AppSecurityPermissions<span class="token punctuation">.</span>WHICH_NEW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsRuntimePermissions <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newPermissionsFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果既不支持可运行权限项也没有新权限发现，</span>
                <span class="token comment" spellcheck="true">// 则提示没有新权限（没有设置任何权限，只显示应用程序名称和图标）</span>
                LayoutInflater inflater <span class="token operator">=</span> <span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">)</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>
                        Context<span class="token punctuation">.</span>LAYOUT_INFLATER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                TextView label <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span>inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>label<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                label<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>no_new_perms<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mScrollView<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            adapter<span class="token punctuation">.</span><span class="token function">addTab</span><span class="token punctuation">(</span>tabHost<span class="token punctuation">.</span><span class="token function">newTabSpec</span><span class="token punctuation">(</span>TAB_ID_NEW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIndicator</span><span class="token punctuation">(</span>
                    <span class="token function">getText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>newPerms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mScrollView<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果至少设置了一个权限</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsRuntimePermissions <span class="token operator">&amp;&amp;</span> N <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            permVisible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            LayoutInflater inflater <span class="token operator">=</span> <span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">)</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>
                    Context<span class="token punctuation">.</span>LAYOUT_INFLATER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 解析权限列表的视图</span>
            View root <span class="token operator">=</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>permissions_list<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mScrollView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mScrollView <span class="token operator">=</span> <span class="token punctuation">(</span>CaffeinatedScrollView<span class="token punctuation">)</span>root<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>scrollview<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 添加到权限列表的视图</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>ViewGroup<span class="token punctuation">)</span>root<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>permission_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>
                        perms<span class="token punctuation">.</span><span class="token function">getPermissionsView</span><span class="token punctuation">(</span>AppSecurityPermissions<span class="token punctuation">.</span>WHICH_ALL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            adapter<span class="token punctuation">.</span><span class="token function">addTab</span><span class="token punctuation">(</span>tabHost<span class="token punctuation">.</span><span class="token function">newTabSpec</span><span class="token punctuation">(</span>TAB_ID_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIndicator</span><span class="token punctuation">(</span>
                    <span class="token function">getText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>allPerms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 默认为 false，如果有新的权限会置为 true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mAppInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">/*
                 * 更新安装包，并且没有任何权限要求，会走这边的逻辑
                 * 根据是否为内置应用，做不同的字串提醒
                 * install_confirm_question_update_system_no_perms：系统应用
                 * install_confirm_question_update_no_perms：非系统应用
                 */</span>
                msg <span class="token operator">=</span> <span class="token punctuation">(</span>mAppInfo<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
                        <span class="token operator">?</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update_system_no_perms
                        <span class="token operator">:</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_update_no_perms<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 是新安装的 app 并且没有权限列表</span>
                msg <span class="token operator">=</span> R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install_confirm_question_no_perms<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 设置相应的 UI</span>
            <span class="token function">bindUi</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>install_confirm<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mScrollView <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>TextView<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>install_confirm_question<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mScrollView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// There is nothing to scroll view, so the ok button is immediately</span>
            <span class="token comment" spellcheck="true">// set to install.</span>
            mOk<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOkCanInstall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mScrollView<span class="token punctuation">.</span><span class="token function">setFullScrollAction</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mOk<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>install<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mOkCanInstall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这个方法其实主要是根据不同的情况来设置相应的 <code>UI</code>，主要是将安装包分为<code>新安装</code>和<code>更新安装</code>，在更新安装里面又分为<code>系统应用</code>和<code>非系统应用</code>，然后根据不同的情况来显示不同的 <code>UI</code>，<code>UI</code> 这块主要是通过 <code>getPermissionsView</code> 方法来获取不同的权限 <code>View</code>。</p>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p><strong>PackageInstaller 初始化的过程：</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;1、根据 <code>Uri</code> 的 <code>Scheme</code> 协议不同，跳转到不同的界面，<code>content</code> 协议跳转到 <code>InstallStart</code>，其他的跳转到 <code>PackageInstallerActivity</code>。本文应用场景中，如果是 <code>Android 7.0</code> 以及更高版本会跳转到 <code>InstallStart</code>。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;2、<code>InstallStart</code> 将 <code>content</code> 协议的 <code>Uri 转换</code>为 <code>File 协议</code>，然后跳转到 <code>PackageInstallerActivity</code>。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;3、<code>PackageInstallerActivity</code> 会分别对 <code>package 协议</code> 和 <code>file 协议</code> 的 <code>Uri</code> 进行处理，如果是 <code>file 协议</code>会解析 <code>APK</code> 文件得到包信息 <code>PackageInfo</code>。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;✨&nbsp;4、<code>PackageInstallerActivity</code> 中会对<code>未知来源</code>进行处理，如果<code>允许安装未知来源</code>或者根据 <code>Intent</code> 判断得出该 <code>APK 不是未知来源</code>，就会<code>初始化安装确认界面</code>，如果管理员<code>限制来自未知源的安装</code>, 就弹出提示 <code>Dialog</code> 或者跳转到设置界面。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>&nbsp;📕 01. <a href="http://liuwangshu.cn/framework/pms/1-packageinstaller-initialize.html" target="_blank" rel="noopener">Android包管理机制（一）PackageInstaller的初始化</a><br>&nbsp;📕 02. <a href="https://www.cnblogs.com/ouyanliu/articles/7100682.html" target="_blank" rel="noopener">android 7.0 安装器安装过程分析</a><br>&nbsp;📕 03. <a href="https://www.jianshu.com/p/cbf8e73f41ed" target="_blank" rel="noopener">APK安装流程详解11——普通应用安装简介</a></p>
<h1 id="索引链接"><a href="#索引链接" class="headerlink" title="索引链接"></a>索引链接</h1><p>推荐跳转：<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">博客索引（Android 9.0）</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/10/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%883%EF%BC%89%E4%B9%8B%20PackageManager/">Framework 核心服务之 PMS 钻研（3）- PackageManager</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/19/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%885%EF%BC%89%E4%B9%8B%20PackageParser/">Framework 核心服务之 PMS 钻研（5）- PackageParser</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Hexo</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/01/16/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-4-zhi-packageinstaller/" class="b-link-green">PackageManagerService 钻研（4）- PackageInstaller</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript。</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/01/22/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-5-zhi-packageparser/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService 钻研（5）- PackageParser">
                        
                        <span class="card-title">PackageManagerService 钻研（5）- PackageParser</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                    <a href="/tags/PackageParser/" target="_blank">
                        <span class="chip bg-color">PackageParser</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/01/12/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-shen-ru-yan-jiu-pms-xi-lie-3-zhi-packagemanager/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService 钻研（3）-PackageManager">
                        
                        <span class="card-title">PackageManagerService 钻研（3）-PackageManager</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService 系列文章如下（基于 Android 9.0 源码）



&nbsp;
系统核心服务之 PackageManagerService 钻研（1）- 启动流程





系统核心服务之 Packag</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架服务/" class="post-category" target="_blank">
                                    框架服务
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                    <a href="/tags/PackageManager/" target="_blank">
                        <span class="chip bg-color">PackageManager</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Hexo<br />'
            + '作者: Marco<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;By Marco<br>
            
			
		</div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQ联系我: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;检索博文</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的技术关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->





</body>
</html>