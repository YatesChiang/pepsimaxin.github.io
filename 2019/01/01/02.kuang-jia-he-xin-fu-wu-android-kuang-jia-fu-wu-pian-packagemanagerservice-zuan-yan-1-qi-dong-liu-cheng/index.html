<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹, Thinking in Android">
    <meta name="description" content="
PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰



&amp;nbsp;
ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹





ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ Packag">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹ | Thinking in Android</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color-header-marco nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <!--<div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Thinking in Android</span>
                </a>
            </div>-->
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>é¦–é¡µ</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>ç›®å½•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>æ ‡ç­¾</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
            
            <i class="fa fa-cube"></i>
            
            <span>ç»„ä»¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="waves-effect waves-light">
            
            <i class="fa fa-spinner"></i>
            
            <span>å¼€æœº</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
            
            <i class="fa fa-superpowers"></i>
            
            <span>æ¡†æ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
            
            <i class="fa fa-link"></i>
            
            <span>æœºåˆ¶</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
            
            <i class="fa fa-yelp"></i>
            
            <span>ä¼˜åŒ–</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
            
            <i class="fa fa-envira"></i>
            
            <span>æ¨¡å¼</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
            
            <i class="fa fa-modx"></i>
            
            <span>ç®—æ³•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
            
            <i class="fa fa-linode"></i>
            
            <span>æ‹“å±•</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>ä½œè€…</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
            
            <i class="fa fa-file-text"></i>
            
            <span>FAQ</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="æ£€ç´¢åšæ–‡"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Thinking in Android</div>
        <div class="logo-desc">
            
            Victory belongs to the most persevering.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                é¦–é¡µ
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                ç›®å½•
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                æ ‡ç­¾
            </a>
        </li>
        
        <li>
            <a href="/categories/å››å¤§ç»„ä»¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-cube"></i>
                
                ç»„ä»¶
            </a>
        </li>
        
        <li>
            <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-spinner"></i>
                
                å¼€æœº
            </a>
        </li>
        
        <li>
            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-superpowers"></i>
                
                æ¡†æ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ ¸å¿ƒæœºåˆ¶/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                æœºåˆ¶
            </a>
        </li>
        
        <li>
            <a href="/categories/æ€§èƒ½ä¼˜åŒ–/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-yelp"></i>
                
                ä¼˜åŒ–
            </a>
        </li>
        
        <li>
            <a href="/categories/è®¾è®¡æ¨¡å¼/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envira"></i>
                
                æ¨¡å¼
            </a>
        </li>
        
        <li>
            <a href="/categories/ç®—æ³•ä¸“æ /" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-modx"></i>
                
                ç®—æ³•
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯å‚¨å¤‡/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-linode"></i>
                
                æ‹“å±•
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                ä½œè€…
            </a>
        </li>
        
        <li>
            <a href="/categories/æŠ€æœ¯ç»†èŠ‚/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-file-text"></i>
                
                FAQ
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/PackageManagerService.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/PackageManagerService/" target="_blank">
                                <span class="chip bg-color">PackageManagerService</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="post-category" target="_blank">
                                æ¡†æ¶æœåŠ¡
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>&nbsp;å‘å¸ƒæ—¥æœŸ :&nbsp;
                    2019-01-01
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>&nbsp;æ–‡ç« å­—æ•° :&nbsp;
                        7.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>&nbsp;é˜…è¯»æ—¶é•¿ :&nbsp;
                        34 åˆ†é’Ÿ
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>&nbsp;é˜…è¯»æ¬¡æ•° :&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
		<br>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><br></p>
<p><strong><center><font color="#3A5FCD" size="4">PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰</font><center></center></center></strong><br></p>
<table>
<thead>
<tr>
<th style="text-align:center">&nbsp;</th>
<th style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</font></a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ3ï¼‰- PackageManager</font></a></td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#EE2C2C" size="3">PackageManagerService</font></strong></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ4ï¼‰- PackageInstaller</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ5ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ1ï¼‰</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ6ï¼‰- APK å®‰è£…æµç¨‹ï¼ˆ2ï¼‰</font></a></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left"><a href><font color="#B452CD">ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ7ï¼‰- PackageParser</font></a></td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong><font color="#3A5FCD" size="4">ä¿®è®¢æ—¥å¿—</font></strong><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">1ã€é‡æ–°æ¢³ç† Android 9.0 æºç ä¸­ PMS çš„å¯åŠ¨æµç¨‹ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">2ã€é‡æ–°æ¢³ç†æ¶‰åŠ Settings çš„ä»£ç é€»è¾‘ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">3ã€é‡æ–°æ¢³ç† XML æ–‡ä»¶æ‰«æçš„ä»£ç é€»è¾‘ï¼›</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#8E388E">4ã€åšæ–‡æ ¼å¼ï¼Œæ–‡ç« æ’ç‰ˆç­‰ä¼˜åŒ–ï¼›</font></p>
<p><br></p>
<hr>
<h1 id="ä¸€ã€å¼€ç¯‡"><a href="#ä¸€ã€å¼€ç¯‡" class="headerlink" title="ä¸€ã€å¼€ç¯‡"></a>ä¸€ã€å¼€ç¯‡</h1><h2 id="1-1-æ ¸å¿ƒæºç "><a href="#1-1-æ ¸å¿ƒæºç " class="headerlink" title="1.1 æ ¸å¿ƒæºç "></a>1.1 æ ¸å¿ƒæºç </h2><table>
<thead>
<tr>
<th>å…³é”®ç±»</th>
<th>è·¯å¾„</th>
</tr>
</thead>
<tbody>
<tr>
<td><font color="#D15FEE">Process.java</font></td>
<td>frameworks/base/core/java/android/os/Process.java</td>
</tr>
<tr>
<td><font color="#D15FEE">Settings.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/Settings.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SettingBase.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/SettingBase.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SystemConfig.java</font></td>
<td>frameworks/base/core/java/com/android/server/SystemConfig.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SystemServer.java</font></td>
<td>frameworks/base/services/java/com/android/server/SystemServer.java</td>
</tr>
<tr>
<td><font color="#D15FEE">SharedUserSetting.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/SharedUserSetting.java</td>
</tr>
<tr>
<td><font color="#D15FEE">PackageManagerService.java</font></td>
<td>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</td>
</tr>
</tbody>
</table>
<h2 id="1-2-ç®€ä»‹"><a href="#1-2-ç®€ä»‹" class="headerlink" title="1.2 ç®€ä»‹"></a>1.2 ç®€ä»‹</h2><p><strong><font color="#0000CD">PackageManagerServiceï¼ˆPMSï¼‰</font></strong>æ˜¯ SystemServer å¯åŠ¨åçš„ç¬¬ä¸€ä¸ªæ ¸å¿ƒæœåŠ¡ï¼Œä¹Ÿæ˜¯ Android ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„æœåŠ¡ä¹‹ä¸€ã€‚å®ƒè´Ÿè´£ç³»ç»Ÿä¸­ Package çš„ç®¡ç†ï¼Œåº”ç”¨ç¨‹åºçš„å®‰è£…ã€å¸è½½ã€ä¿¡æ¯æŸ¥è¯¢ç­‰ã€‚å¦‚æœä½ æ˜¯é¢å‘ Android ç³»ç»Ÿå¼€å‘çš„å·¥ç¨‹å¸ˆï¼ŒåŸºç¡€æ¦‚å¿µæˆ‘ä¹Ÿä¸éœ€è¦å†å¤šèµ˜è¿°ï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯é˜…è¯»åˆ†ææºç ï¼Œé’»ç ”æ›´æ·±å±‚æ¬¡çš„åŸç†ã€‚</p>
<h2 id="1-3-å®¶æ—è°±"><a href="#1-3-å®¶æ—è°±" class="headerlink" title="1.3 å®¶æ—è°±"></a>1.3 å®¶æ—è°±</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ PackageManagerService åŠå®¢æˆ·ç«¯çš„å®¶æ—è°±ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè¿™å¼ å›¾æš‚ä¸”åªéœ€è¦æœ‰ä¸ªå°è±¡ï¼Œæ•´ä¸ªç³»åˆ—åˆ†æå®Œå†å›æ¥çœ‹è¿™ä¸ªå®¶æ—è°±ï¼Œä½ ä¼šæ¸…æ™°å¾ˆå¤šï¼ï¼‰</p>
<center><img src="https://upload-images.jianshu.io/upload_images/3517194-ece68587e315bc1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å®¶æ—è°±.png"></center>

<p><strong><font color="#436EEE" size="3">ç®€å•è¯´æ˜ï¼š</font></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° IPackageManager æ¥å£ç±»ä¸­å®šä¹‰äº†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é€šä¿¡çš„ä¸šåŠ¡å‡½æ•°ï¼Œè¿˜å®šä¹‰äº†å†…éƒ¨ç±» Stubï¼Œè¯¥ç±»ä» Binder æ´¾ç”Ÿå¹¶å®ç°äº† IPackageManager æ¥å£ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° PackageManagerService ç»§æ‰¿è‡ª IPackageManager.Stubç±»ï¼Œç”±äº Stub ç±»ä» Binder æ´¾ç”Ÿï¼Œå› æ­¤ PackageManagerService å°†ä½œä¸ºæœåŠ¡ç«¯å‚ä¸ Binder é€šä¿¡ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° Stub ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±» Proxyï¼Œè¯¥ç±»æœ‰ä¸€ä¸ª IBinderç±»å‹ï¼ˆå®é™…ç±»å‹ä¸º BinderProxyï¼‰çš„æˆå‘˜å˜é‡ mRemoteï¼ŒmRemote ç”¨äºå’ŒæœåŠ¡ç«¯ PackageManagerServiceé€šä¿¡ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° IPackageManager æ¥å£ç±»ä¸­å®šä¹‰äº†è®¸å¤šä¸šåŠ¡å‡½æ•°ï¼Œä½†æ˜¯å¤„äºå®‰å…¨ç­‰æ–¹é¢çš„è€ƒè™‘ï¼ŒAndroid å¯¹å¤–ï¼ˆå³SDKï¼‰æä¾›çš„åªæ˜¯ä¸€ä¸ªå­é›†ï¼Œè¯¥å­ç±»è¢«å°è£…åœ¨æŠ½è±¡ç±» PackageManagerä¸­ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬é€šè¿‡ Context çš„ getPackageManager å‡½æ•°è¿”å›ä¸€ä¸ªç±»å‹ä¸º PackageManagerçš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„å®é™…ç±»å‹æ˜¯ PackageManager çš„å­ç±» ApplicationPackageManagerã€‚è¿™ç§åŸºäºæ¥å£ç¼–ç¨‹çš„æ–¹å¼ï¼Œè™½ç„¶æå¤§é™ä½äº†æ¨¡å—ä¹‹é—´çš„è€¦åˆæ€§ï¼Œå´ç»™ä»£ç åˆ†æå¸¦æ¥äº†ä¸å°çš„éº»çƒ¦ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”° ApplicationPackageManager ç±»ç»§æ‰¿è‡ª PackageManagerç±»ã€‚å®ƒå¹¶æ²¡æœ‰ç›´æ¥å‚ä¸ Binder é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡ mPM æˆå‘˜å˜é‡æŒ‡å‘ä¸€ä¸ª IPackageManager.Stub.Proxy ç±»å‹çš„å¯¹è±¡ã€‚</p>
<blockquote>
<p><strong><font color="#FF0000">ã€æç¤ºã€‘ï¼š</font></strong>åœ¨ä½ è‡ªå·±çš„åˆ†æè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‘ç°æºç ä¸­æ‰¾ä¸åˆ° IPackageManager.java è¿™ä¸ªæ–‡ä»¶ã€‚å…¶å®è¯¥æ–‡ä»¶æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ï¼Œæœ€ç»ˆçš„æ–‡ä»¶ä½äº Android æºç  outï¼ˆ<code>/out/target/common/obj/JAVA_LIBRARIES/framework_intermediates/core/java/android/content/pm</code>ï¼‰ç›®å½•ä¸‹é¢ã€‚</p>
</blockquote>
<p><strong><font color="#0000FF">IPackageManager.javaï¼š</font></strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPackageManager</span> <span class="token keyword">extends</span> <span class="token class-name">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IInterface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/** Local-side IPC implementation stub class. */</span>
    <span class="token comment" spellcheck="true">// å®šä¹‰å†…éƒ¨ç±» Stubï¼Œæ´¾ç”Ÿè‡ª Binderï¼Œå®ç° IPackageManager æ¥å£</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Stub</span> <span class="token keyword">extends</span> <span class="token class-name">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Binder</span>
                                      <span class="token keyword">implements</span> <span class="token class-name">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>IPackageManager</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String DESCRIPTOR <span class="token operator">=</span> 
                                      <span class="token string">"android.content.pm.IPackageManager"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/** Construct the stub at attach it to the interface. */</span>
        <span class="token keyword">public</span> <span class="token function">Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// å®šä¹‰ Stub çš„å†…éƒ¨ç±» Proxyï¼Œå®ç° IPackageManager æ¥å£</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span>IPackageManager</span> <span class="token punctuation">{</span>
            <span class="token keyword">private</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IBinder mRemote<span class="token punctuation">;</span>
            <span class="token function">Proxy</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IBinder remote<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#436EEE">çœ‹æºç ï¼Œæ¢³ç†æµç¨‹ï¼Œå°±åƒæ˜¯èµ°è¿›è¿·å®«ï¼Œå¾ˆå®¹æ˜“è¿·å¤±ï¼</font></strong></p>
<p>æ‰€ä»¥åœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ç»™å¤§å®¶ä¸€äº›å»ºè®®ï¼š<strong><font color="#FF0000">ç´§æŠ“ä¸»å¹²ï¼Œç†Ÿæ‚‰æµç¨‹ï¼Œå†å•ƒç»†èŠ‚ï¼</font></strong></p>
<hr>
<h1 id="äºŒã€SystemServer"><a href="#äºŒã€SystemServer" class="headerlink" title="äºŒã€SystemServer"></a>äºŒã€SystemServer</h1><p>å…ˆæ¥è¯´è¯´ PackageManagerService æ˜¯æ€ä¹ˆå¯åŠ¨çš„ï¼Ÿ</p>
<p><code>PackageManagerService</code> ä½œä¸ºç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡ï¼Œç”± <code>SystemServer</code> åˆ›å»ºï¼Œ<code>SystemServer</code> è°ƒç”¨äº† <code>PackageManagerService</code> çš„ <code>main()</code> åˆ›å»º <code>PackageManagerService å®ä¾‹</code>ã€‚</p>
<h2 id="2-1-main"><a href="#2-1-main" class="headerlink" title="2.1 main"></a>2.1 main</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/java/com/android/server/SystemServer.java</span>

<span class="token comment" spellcheck="true">/**
  * The main entry point from zygote.
  */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">SystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Start services.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-2-startBootstrapServices"><a href="#2-2-startBootstrapServices" class="headerlink" title="2.2 startBootstrapServices"></a>2.2 startBootstrapServices</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/java/com/android/server/SystemServer.java</span>

<span class="token keyword">private</span> PackageManagerService mPackageManagerService<span class="token punctuation">;</span>
<span class="token keyword">private</span> Context mSystemContext<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> mOnlyCore<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// è°ƒç”¨ PMS çš„ main å‡½æ•°ï¼Œä¸»è¦æ˜¯åˆ›å»º PMS æœåŠ¡ï¼Œå¹¶æ³¨å†Œåˆ° ServiceManagerï¼ˆæœåŠ¡ç®¡å®¶ï¼‰</span>
    mPackageManagerService <span class="token operator">=</span> PackageManagerService<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>mSystemContext<span class="token punctuation">,</span> installer<span class="token punctuation">,</span>
                mFactoryTestMode <span class="token operator">!=</span> FactoryTest<span class="token punctuation">.</span>FACTORY_TEST_OFF<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// è·å– PackageManager</span>
    mPackageManager <span class="token operator">=</span> mSystemContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-3-startOtherServices"><a href="#2-3-startOtherServices" class="headerlink" title="2.3 startOtherServices"></a>2.3 startOtherServices</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/java/com/android/server/SystemServer.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"MakePackageManagerServiceReady"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mPackageManagerService<span class="token punctuation">.</span><span class="token function">systemReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<h1 id="ä¸‰ã€PackageManagerService"><a href="#ä¸‰ã€PackageManagerService" class="headerlink" title="ä¸‰ã€PackageManagerService"></a>ä¸‰ã€PackageManagerService</h1><p>æŸ¥çœ‹æºç ï¼Œæˆ‘ä»¬çŸ¥é“äº† <code>SystemServer</code> è°ƒç”¨ <code>PackageManagerService</code> çš„ <code>main()</code> åˆ›å»ºäº† <code>PackageManagerService å®ä¾‹</code>ã€‚</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯å…³æ³¨ PackageManagerService çš„ <code>main()</code> æ–¹æ³•ï¼</p>
<h2 id="3-1-main"><a href="#3-1-main" class="headerlink" title="3.1 main"></a>3.1 main</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/</span>
            PackageManagerService<span class="token punctuation">.</span>java

<span class="token keyword">public</span> <span class="token keyword">static</span> PackageManagerService <span class="token function">main</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
                                         <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Self-check for initial settings: æ­¤å¤„ä¸»è¦æ£€æŸ¥ç³»ç»Ÿå±æ€§</span>
    PackageManagerServiceCompilerMapping<span class="token punctuation">.</span><span class="token function">checkProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// æ­¤å¤„åˆ›å»ºæ„é€ å‡½æ•°ï¼Œå…¶ä¸­ï¼ŒfactoryTestï¼šå†³å®šæ˜¯å¦æµ‹è¯•ç‰ˆæœ¬ï¼ŒonlyCoreï¼šå†³å®šæ˜¯å¦åªè§£æç³»ç»Ÿç›®å½•</span>
    PackageManagerService m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installer<span class="token punctuation">,</span> 
                                                        factoryTest<span class="token punctuation">,</span> onlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    m<span class="token punctuation">.</span><span class="token function">enableSystemUserPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// åˆ©ç”¨ Binder é€šä¿¡ï¼Œå°†è‡ªå·±æ³¨å†Œåˆ° ServiceManager è¿›ç¨‹ä¸­ï¼ˆè¿™æ˜¯ Binder æœåŠ¡çš„å¸¸è§„æ³¨å†Œæµç¨‹ï¼‰</span>
    ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> PackageManagerNative pmn <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">PackageManagerNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ServiceManager<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"package_native"</span><span class="token punctuation">,</span> pmn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>è¯¥æ–¹æ³•ä¸»è¦<code>åˆ›å»º PMS å¯¹è±¡</code>ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ° <code>ServiceManager</code> ä¸­ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ª <code>HashMap</code> çš„é›†åˆï¼Œå­˜å‚¨äº†å¾ˆå¤šç›¸å…³çš„ Binder æœåŠ¡ï¼Œç¼“å­˜èµ·æ¥ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ <code>getService(key)</code> çš„æ–¹å¼å» <code>Map</code> ä¸­è·å–ã€‚</p>
<blockquote>
<p><strong><font color="#436EEE">main å‡½æ•°çœ‹ä¼¼å‡ è¡Œä»£ç å¾ˆç®€å•ï¼Œä½†æ‰§è¡Œæ—¶é—´å´å¾ˆé•¿ã€‚ä¸»è¦åŸå› æ˜¯ PMS åœ¨å…¶â€œæ„é€ å‡½æ•°â€ä¸­åšäº†å¾ˆå¤šâ€œé‡ä½“åŠ›æ´»â€ï¼Œè¿™ä¹Ÿæ˜¯ Android å¯åŠ¨é€Ÿåº¦æ…¢çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</font></strong></p>
</blockquote>
<p><strong><font color="#FF0000">å…·ä½“åˆ†æå‰ï¼Œæˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸€ä¸‹ PMS æ„é€ å‡½æ•°çš„ä¸»è¦åŠŸèƒ½ï¼š</font></strong></p>
<p>æ‰«æ Android ç³»ç»Ÿä¸­å‡ ä¸ªç›®æ ‡æ–‡ä»¶å¤¹ä¸­çš„ APKï¼Œä»è€Œå»ºç«‹åˆé€‚çš„æ•°æ®ç»“æ„æ¥ç®¡ç†å„ç§ä¿¡æ¯ï¼Œå¦‚ï¼šPackage ä¿¡æ¯ã€å››å¤§ç»„ä»¶ä¿¡æ¯ã€æƒé™ä¿¡æ¯ç­‰ã€‚</p>
<p>æŠ½è±¡åœ°æ¥çœ‹ï¼ŒPMS åƒä¸€ä¸ªåŠ å·¥å‚ï¼Œå®ƒè§£æå®é™…çš„ç‰©ç†æ–‡ä»¶ï¼ˆAPKæ–‡ä»¶ï¼‰ä»¥ç”Ÿæˆç¬¦åˆè‡ªå·±è¦æ±‚çš„äº§å“ã€‚ï¼ˆä¾‹å¦‚ï¼šPMS å°†è§£æ APK åŒ…ä¸­çš„ <code>AndroidManifest.xml</code>ï¼Œå¹¶æ ¹æ®å…¶ä¸­å£°æ˜çš„ <code>Activity æ ‡ç­¾</code>æ¥åˆ›å»ºä¸æ­¤å¯¹åº”çš„å¯¹è±¡å¹¶åŠ ä»¥ä¿ç®¡ã€‚ï¼‰</p>
<p>ä»æºç è§’åº¦æ¥çœ‹ï¼ŒPMS çš„å·¥ä½œæµç¨‹ç›¸å¯¹ç®€å•ã€‚ä½†æ·±å…¥ç ”ç©¶åï¼Œå‘ç°å…¶å¾ˆå¤æ‚ï¼</p>
<blockquote>
<p><strong><font color="#A020F0">å¤æ‚çš„æ˜¯å…¶ä¸­ç”¨äºä¿å­˜å„ç§ä¿¡æ¯çš„<code>æ•°æ®ç»“æ„</code>å’Œ<code>å®ƒä»¬ä¹‹é—´çš„å…³ç³»</code>ï¼Œä»¥åŠå½±å“æœ€ç»ˆç»“æœçš„<code>ç­–ç•¥æ§åˆ¶</code></font></strong>ã€‚</p>
</blockquote>
<p>å¦‚æœä½ è‡ªè¡Œç ”ç©¶è¿‡ PMSï¼Œä½ ä¼šå‘ç°ä»£ç ä¸­å­˜åœ¨å¤§é‡ä¸åŒçš„æ•°æ®ç»“æ„ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ä¼šè®©äººå¤§ä¸ºå¤´ç–¼ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬é™¤äº†åˆ†æ PMS çš„å·¥ä½œæµç¨‹ä»¥å¤–ï¼Œä¼šé‡ç‚¹å…³æ³¨é‡è¦çš„æ•°æ®ç»“æ„ä»¥åŠå®ƒä»¬çš„ä½œç”¨ã€‚</p>
<p><strong><font color="#FF0000">æ¥ä¸‹æ¥å¼€å§‹é‡ç‚¹åˆ†æ PMS çš„æ„é€ å‡½æ•°</font></strong>ï¼Œå¦‚æœæ”¾åœ¨ä¸€ç¯‡æ–‡ç« ä¸­å»åˆ†ææ˜¯å®Œå…¨ä¸å¯èƒ½æ¢³ç†æ¸…æ¥šçš„ï¼</p>
<p>æˆ‘ä»¬åˆ†ä¸¤éƒ¨åˆ†ç ”ç©¶ï¼Œå¦‚ä¸‹ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ1ï¼‰ - å‰æœŸå‡†å¤‡å·¥ä½œ</font></strong>&nbsp;<strong><font color="#FF0000">ï¼ˆæœ¬ç¯‡æ–‡ç« è¦è®¨è®ºçš„å†…å®¹ï¼‰</font></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><font color="#551A8B">ğŸ &nbsp;æ„é€ å‡½æ•°ï¼ˆ2ï¼‰ - æ‰«æ Package å’Œ æ‰«å°¾å·¥ä½œ</font></strong> <a href="https://superandroid.pro/2018/11/05/B_02.%20Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%882%EF%BC%89%E4%B9%8B%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/">ã€ŠFramework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°ã€‹</a></p>
<hr>
<p>æ­£å¼å¼€å§‹åˆ†æ PMS çš„æ„é€ å‡½æ•°ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æ­¤å¤„åˆ›å»ºæ„é€ å‡½æ•°ï¼Œå…¶ä¸­ï¼ŒfactoryTestï¼šå†³å®šæ˜¯å¦æµ‹è¯•ç‰ˆæœ¬ï¼ŒonlyCoreï¼šå†³å®šæ˜¯å¦åªè§£æç³»ç»Ÿç›®å½•</span>
PackageManagerService m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installer<span class="token punctuation">,</span> 
                                                    factoryTest<span class="token punctuation">,</span> onlyCore<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="3-2-Settings"><a href="#3-2-Settings" class="headerlink" title="3.2 Settings"></a>3.2 Settings</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// public static final int SDK_INT = SystemProperties.getInt("ro.build.version.sdk", 0);</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> mSdkVersion <span class="token operator">=</span> Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*
     * mSdkVersionæ˜¯ PMS çš„æˆå‘˜å˜é‡ï¼Œå®šä¹‰çš„æ—¶å€™è¿›è¡Œèµ‹å€¼ï¼Œå…¶å€¼å–è‡ªç³»ç»Ÿå±æ€§ ro.build.version.sdk
     * å¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œåˆ™ APK å°±æ— æ³•çŸ¥é“è‡ªå·±è¿è¡Œåœ¨ Android å“ªä¸ªç‰ˆæœ¬ä¸Š
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mSdkVersion <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"**** ro.build.version.sdk not set!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>

    mFactoryTest <span class="token operator">=</span> factoryTest<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// è¿è¡Œåœ¨éå·¥å‚æ¨¡å¼ä¸‹</span>
    mOnlyCore <span class="token operator">=</span> onlyCore<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// æ ‡è®°æ˜¯å¦åªåŠ è½½æ ¸å¿ƒæœåŠ¡</span>
    mMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å­˜å‚¨ä¸æ˜¾ç¤ºå±ç›¸å…³çš„ä¸€äº›å±æ€§ï¼Œä¾‹å¦‚å±å¹•çš„å®½/é«˜å°ºå¯¸ï¼Œåˆ†è¾¨ç‡ç­‰ä¿¡æ¯</span>
    mInstaller <span class="token operator">=</span> installer<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// åˆ›å»º Installer å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å’Œ Native è¿›ç¨‹ installd äº¤äº’</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mInstallLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Expose private service for system components to use.</span>
        LocalServices<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span>PackageManagerInternal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                                 <span class="token keyword">new</span> <span class="token class-name">PackageManagerInternalImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sUserManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserManagerService</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">UserDataPreparer</span><span class="token punctuation">(</span>mInstaller<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">,</span> mContext<span class="token punctuation">,</span> mOnlyCore<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPermissionManager <span class="token operator">=</span> PermissionManagerService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">DefaultPermissionGrantedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDefaultRuntimePermissionsGranted</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mSettings<span class="token punctuation">.</span><span class="token function">onDefaultRuntimePermissionsGrantedLPr</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> mPackages <span class="token comment" spellcheck="true">/*externalLock*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDefaultPermissionPolicy <span class="token operator">=</span> mPermissionManager<span class="token punctuation">.</span><span class="token function">getDefaultPermissionGrantPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Settings æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç±»ï¼Œè¯¥ç±»ç”¨äºå­˜å‚¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€äº›è®¾ç½®ï¼Œæˆ‘ä»¬åé¢ä¼šé‡ç‚¹åˆ†æè¿™ä¸ªç±»ï¼</span>
        mSettings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>mPermissionManager<span class="token punctuation">.</span><span class="token function">getPermissionSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mPackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// æ·»åŠ systemã€phoneã€logã€nfcã€bluetoothã€shellè¿™å…­ç§ shareUserId åˆ° mSettings</span>
    <span class="token comment" spellcheck="true">// addSharedUserLPw å‡½æ•°åšäº†ä»€ä¹ˆï¼Ÿè¿™æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦åˆ†æçš„é‡ç‚¹ï¼</span>
    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.system"</span><span class="token punctuation">,</span> Process<span class="token punctuation">.</span>SYSTEM_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.phone"</span><span class="token punctuation">,</span> RADIO_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.log"</span><span class="token punctuation">,</span> LOG_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.nfc"</span><span class="token punctuation">,</span> NFC_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.bluetooth"</span><span class="token punctuation">,</span> BLUETOOTH_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.shell"</span><span class="token punctuation">,</span> SHELL_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.se"</span><span class="token punctuation">,</span> SE_UID<span class="token punctuation">,</span>
                ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>åˆšè¿›å…¥æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å°±é‡åˆ°äº†ç¬¬ä¸€ä¸ªè¾ƒä¸ºå¤æ‚çš„æ•°æ®ç»“æ„ <code>Settings</code> ï¼Œä»¥åŠå®ƒçš„ <code>addSharedUserLPw</code> å‡½æ•°ã€‚</p>
<h4 id="3-2-1-æ„é€ å‡½æ•°"><a href="#3-2-1-æ„é€ å‡½æ•°" class="headerlink" title="3.2.1 æ„é€ å‡½æ•°"></a>3.2.1 æ„é€ å‡½æ•°</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Settings</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">Settings</span><span class="token punctuation">(</span>PermissionSettings permissions<span class="token punctuation">,</span> Object lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getDataDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">Settings</span><span class="token punctuation">(</span>File dataDir<span class="token punctuation">,</span> PermissionSettings permission<span class="token punctuation">,</span> Object lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
        mPermissions <span class="token operator">=</span> permission<span class="token punctuation">;</span>
        mRuntimePermissionsPersistence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimePermissionPersistence</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// åˆ›å»ºæŒ‡å‘ /data/system/ ç›®å½•çš„ File</span>
        mSystemDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dataDir<span class="token punctuation">,</span> <span class="token string">"system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºç›®å½•</span>
        mSystemDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        FileUtils<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  FileUtils<span class="token punctuation">.</span>S_IRWXU<span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IRWXG
                  <span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IROTH<span class="token operator">|</span>FileUtils<span class="token punctuation">.</span>S_IXOTH<span class="token punctuation">,</span>
                  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// ç”¨äºæè¿°ç³»ç»Ÿæ‰€å®‰è£…çš„ Package ä¿¡æ¯</span>
        mSettingsFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// packages.xmlçš„å¤‡ä»½ä¿¡æ¯</span>
        mBackupSettingsFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-backup.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// ä¿å­˜ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰éç³»ç»Ÿè‡ªå¸¦çš„ APK ä¿¡æ¯ï¼Œå³ UID å¤§äº 10000 çš„ apk</span>
        mPackageListFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages.list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileUtils<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>mPackageListFilename<span class="token punctuation">,</span> <span class="token number">0640</span><span class="token punctuation">,</span> SYSTEM_UID<span class="token punctuation">,</span> PACKAGE_INFO_GID<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// sdcardfs ç›¸å…³çš„æ–‡ä»¶</span>
        <span class="token keyword">final</span> File kernelDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/config/sdcardfs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mKernelMappingFilename <span class="token operator">=</span> kernelDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> kernelDir <span class="token operator">:</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// è®°å½•ç³»ç»Ÿä¸­è¢«å¼ºåˆ¶åœæ­¢è¿è¡Œçš„ App ä¿¡æ¯ï¼Œå¦‚æœ‰ App è¢«å¼ºåˆ¶åœæ­¢è¿è¡Œï¼Œä¼šå°†ä¸€äº›ä¿¡æ¯è®°å½•åˆ°è¯¥æ–‡ä»¶ä¸­</span>
        mStoppedPackagesFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-stopped.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// packages-stopped.xml çš„å¤‡ä»½ä¿¡æ¯</span>
        mBackupStoppedPackagesFilename <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSystemDir<span class="token punctuation">,</span> <span class="token string">"packages-stopped-backup.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#FF0000">Settings çš„æ„é€ å‡½æ•°çš„ä¸»è¦å·¥ä½œï¼šå»ºç«‹ä¸æŸäº›ç³»ç»Ÿé…ç½®æ–‡ä»¶ã€ç›®å½•ä¹‹é—´çš„å…³è”</font></strong>ã€‚é¦–å…ˆï¼Œå®ƒä¼šåˆ›å»ºæŒ‡å‘ <code>/data/system/</code> ç›®å½•çš„ <code>File</code> å®ä¾‹ï¼Œè¿™ä¸ªç›®å½•ä¸‹ä¼šä¿å­˜å¾ˆå¤šç³»ç»Ÿæ–‡ä»¶ã€‚å…¶æ¬¡ï¼Œå°±æ˜¯åˆ›å»º <code>/data/system/</code> ç›®å½•ä¸‹çš„æŸäº› <code>.xml æ–‡ä»¶</code> æˆ–å…¶ä»–æ–‡ä»¶çš„ <code>File</code> å®ä¾‹ã€‚</p>
<p>ä¸Šé¢æºç ä¸­æ¶‰åŠåˆ° 5 ä¸ªæ–‡ä»¶ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages.xmlï¼š</font> PMS æ‰«æå®Œç›®æ ‡æ–‡ä»¶å¤¹åï¼Œä¼šåˆ›å»ºpackages.xmlã€‚å½“ç³»ç»Ÿè¿›è¡Œç¨‹åºå®‰è£…ã€å¸è½½å’Œæ›´æ–°ç­‰æ“ä½œæ—¶ï¼Œå‡ä¼šæ›´æ–°è¯¥æ–‡ä»¶;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages-backup.xmlï¼š</font>packages.xml æ–‡ä»¶çš„å¤‡ä»½;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages.listï¼š</font>ç”¨äºæè¿°ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰éç³»ç»Ÿè‡ªå¸¦çš„ APK ä¿¡æ¯ã€‚å½“è¿™äº› APK æœ‰å˜åŒ–æ—¶ï¼ŒPKMSå°±ä¼šæ›´æ–°è¯¥æ–‡ä»¶;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages-stopped.xmlï¼š</font>è®°å½•è¢«ç”¨æˆ·å¼ºè¡Œåœæ­¢çš„åº”ç”¨çš„ Package ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œä»è®¾ç½®è¿›å…¥æŸä¸ªåº”ç”¨ï¼Œç„¶åç‚¹å‡»å¼ºè¡Œåœæ­¢ï¼Œé‚£ä¹ˆåº”ç”¨çš„Packageä¿¡æ¯å°±ä¼šè¢«è®°å½•ï¼‰;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ packages-stopped-back.xmlï¼š</font>packages-stopped.xml æ–‡ä»¶çš„å¤‡ä»½ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„ä»‹ç»ä¸­æ¶‰åŠåˆ°äº†ä¸¤ä¸ª <code>back-up</code> æ–‡ä»¶ï¼Œå®ƒä»¬æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿå…¶å® Android ç³»ç»Ÿåœ¨ä¿®æ”¹ <code>packages.xml</code>ã€<code>packages-stopped.xml</code> ä¹‹å‰ï¼Œä¼šå…ˆå¯¹å®ƒä»¬è¿›è¡Œ<code>å¤‡ä»½</code>ã€‚å½“å¯¹å®ƒä»¬çš„ä¿®æ”¹æ“ä½œæ­£å¸¸å®Œæˆï¼Œåˆ™ä¼šåˆ æ‰å¤‡ä»½çš„æ–‡ä»¶ã€‚å¦‚æœåœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­ç³»ç»Ÿå‡ºç°é—®é¢˜é‡å¯äº†ï¼Œä¼šå†æ¬¡å»è¯»å–è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼›å¦‚æœæ­¤æ—¶å‘ç°å®ƒä»¬çš„å¤‡ä»½æ–‡ä»¶è¿˜å­˜åœ¨ï¼Œåˆ™è¯´æ˜ä¸Šä¸€æ¬¡å¯¹ä¸¤ä»½æ–‡ä»¶çš„ä¿®æ”¹æ“ä½œå‘ç”Ÿäº†å¼‚å¸¸ï¼Œè¿™ä¸¤ä»½æ–‡ä»¶çš„å†…å®¹å¯èƒ½å·²ç»ä¸å‡†ç¡®äº†ï¼Œè¿™æ—¶ç³»ç»Ÿä¼šå»ä½¿ç”¨ä¹‹å‰å¤‡ä»½çš„æ–‡ä»¶çš„å†…å®¹ã€‚</p>
</blockquote>
<p>åˆ›å»ºå®Œç›¸å…³ç³»ç»Ÿæ–‡ä»¶ File å®ä¾‹åï¼ŒSettings çš„æ„é€ å·¥ä½œä¹Ÿå°±ç»“æŸäº†ã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼š<strong><font color="#63B8FF">addSharedUserLPw å‡½æ•°åšäº†ä»€ä¹ˆï¼Ÿ</font></strong>ä»ä¸Šé¢æˆªå–ä¸€æ®µä»£ç å›é¡¾ä¸€ä¸‹ï¼š</p>
<pre class=" language-java"><code class="language-java">mSettings<span class="token punctuation">.</span><span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span><span class="token string">"android.uid.system"</span><span class="token punctuation">,</span> Process<span class="token punctuation">.</span>SYSTEM_UID<span class="token punctuation">,</span>
            ApplicationInfo<span class="token punctuation">.</span>FLAG_SYSTEM<span class="token punctuation">,</span> ApplicationInfo<span class="token punctuation">.</span>PRIVATE_FLAG_PRIVILEGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>addSharedUserLPw ä¼ é€’äº† 4 ä¸ªå‚æ•°ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;android.uid.system</font>ï¼šå­—ç¬¦ä¸²ï¼Œname å’Œ uid ä¸€ä¸€å¯¹åº”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>public static final int SYSTEM_UID = 1000;</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;Process.SYSTEM_UID</font>ï¼šå€¼ä¸º 1000ï¼Œname å’Œ uid ä¸€ä¸€å¯¹åº”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>public static final int FLAG_SYSTEM = 1&lt;&lt;0;</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;ApplicationInfo.FLAG_SYSTEM</font>ï¼šæ ‡å¿—</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>public static final int PRIVATE_FLAG_PRIVILEGED = 1&lt;&lt;3;</code><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#63B8FF">âœ¨ &nbsp;ApplicationInfo.PRIVATE_FLAG_PRIVILEGED</font>ï¼šç‰¹æƒApk</p>
<p>å¯¹ addSharedUserLPw å‡½æ•°åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ <code>SYSTEM_UID</code> çš„ç›¸å…³çŸ¥è¯†ã€‚</p>
<hr>
<h3 id="3-2-2-UID-GID"><a href="#3-2-2-UID-GID" class="headerlink" title="3.2.2 UID/GID"></a>3.2.2 UID/GID</h3><p><strong><font color="#FF0000">UID ä¸º <code>ç”¨æˆ· ID</code> çš„ç¼©å†™ï¼ŒGID ä¸º <code>ç”¨æˆ·ç»„ ID</code> çš„ç¼©å†™</font></strong>ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ UIDï¼ˆå³æ ‡ç¤ºè¯¥è¿›ç¨‹å±äºå“ªä¸ªç”¨æˆ·ï¼Œä¸åŒç”¨æˆ·æ‹¥æœ‰ä¸åŒæƒé™ï¼‰ã€‚ä¸€ä¸ªè¿›ç¨‹ä¹Ÿå¯åˆ†å±ä¸ç”¨çš„ç”¨æˆ·ç»„ï¼ˆæ¯ä¸ªç”¨æˆ·éƒ½æœ‰å¯¹åº”çš„æƒé™ï¼‰ã€‚<strong><font color="#FF0000">UID/GID å’Œè¿›ç¨‹çš„æƒé™æœ‰å…³</font></strong>ã€‚</p>
<p>åœ¨ Android å¹³å°ä¸­ï¼Œç³»ç»Ÿå®šä¹‰çš„ UID/GID åœ¨ <strong><font color="#8470FF">Process.java</font></strong> æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼ˆåˆ—ä¸¾éƒ¨åˆ†ï¼‰ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/android/os/Process.java</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYSTEM_UID <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// ç³»ç»Ÿè¿›ç¨‹çš„ UID/GID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PHONE_UID <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// Phone è¿›ç¨‹çš„ UID/GID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHELL_UID <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// shell è¿›ç¨‹çš„ UID/GID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> LOG_UID <span class="token operator">=</span> <span class="token number">1007</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// LOG è¿›ç¨‹çš„ UID/GID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> WIFI_UID <span class="token operator">=</span> <span class="token number">1010</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// WIFI è¿›ç¨‹çš„ UID/GID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MEDIA_UID <span class="token operator">=</span> <span class="token number">1013</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// mediaserver è¿›ç¨‹çš„ UID/GID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NFC_UID <span class="token operator">=</span> <span class="token number">1027</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// NFC è¿›ç¨‹çš„ UID/GID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> FIRST_APPLICATION_UID <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªåº”ç”¨ Package çš„èµ·å§‹ UID</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> LAST_APPLICATION_UID <span class="token operator">=</span> <span class="token number">19999</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç³»ç»Ÿæ‰€æ”¯æŒçš„æœ€å¤§çš„åº”ç”¨ Package çš„ UID</span>
</code></pre>
<h3 id="3-2-3-addSharedUserLPw"><a href="#3-2-3-addSharedUserLPw" class="headerlink" title="3.2.3 addSharedUserLPw"></a>3.2.3 addSharedUserLPw</h3><p>ç°åœ¨æˆ‘ä»¬å¼€å§‹åˆ†æ addSharedUserLPw å‡½æ•°ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/Settings.java</span>

SharedUserSetting <span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgPrivateFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// æ ¹æ® key ä» map ä¸­è·å–å€¼</span>
    SharedUserSetting s <span class="token operator">=</span> mSharedUsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// å¦‚æœå€¼ä¸ä¸º null å¹¶ä¸”ä¿å­˜çš„ uid å’Œä¼ é€’è¿‡æ¥çš„ä¸€è‡´ï¼Œå°±ç›´æ¥è¿”å›ç»“æœ</span>
    <span class="token comment" spellcheck="true">// uid ä¸ä¸€è‡´åˆ™è¿”å› null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>userId <span class="token operator">==</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> s<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>
                    <span class="token string">"Adding duplicate shared user, keeping first: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// è‹¥ s ä¸º nullï¼Œåˆ™æ ¹æ®ä¼ é€’è¿‡æ¥çš„å‚æ•°æ–°åˆ›å»ºå¯¹è±¡</span>
    s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedUserSetting</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pkgFlags<span class="token punctuation">,</span> pkgPrivateFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>userId <span class="token operator">=</span> uid<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// åœ¨ç³»ç»Ÿä¸­ä¿å­˜å€¼ä¸º uid çš„ ç”¨æˆ· idï¼ŒæˆåŠŸè¿”å› true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addUserIdLPw</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> s<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mSharedUsers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// å°† name ä¸ s é”®å€¼å¯¹æ·»åŠ åˆ° mSharedUsers ä¸­ä¿å­˜</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä»æºç ä¸­æˆ‘ä»¬å‘ç°ï¼ŒSettings ä¸­æœ‰ä¸€ä¸ª <code>mSharedUsers</code> æˆå‘˜ï¼Œè¯¥æˆå‘˜å­˜å‚¨çš„æ˜¯ <code>ã€â€œå­—ç¬¦ä¸²â€ ä¸ â€œSharedUserSettingâ€ é”®å€¼å¯¹ã€‘</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡ <code>å­—ç¬¦ä¸²</code> ä¸º <code>key</code> å¾—åˆ°å¯¹åº”çš„ <code>SharedUserSetting</code> å¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆ SharedUserSetting æ˜¯ä»€ä¹ˆï¼Ÿåˆ›å»ºå®ƒçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æï¼</p>
<h4 id="3-2-3-1-SharedUserSetting"><a href="#3-2-3-1-SharedUserSetting" class="headerlink" title="3.2.3.1 SharedUserSetting"></a>3.2.3.1 SharedUserSetting</h4><p>ä¸ºäº†è§£é‡Š SharedUserSettingï¼Œæˆ‘ä»¬æ‹¿ <strong><font color="#1874CD">SystemUI</font></strong> ä½œä¸ºä¾‹å­æ¥è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸‹ SystemUI çš„ <code>AndroidManifest.xml</code>ï¼ˆè¿™ä¸ªæ–‡ä»¶ä½ è‚¯å®šä¸é™Œç”Ÿï¼‰ï¼š</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>androidprv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/prv/res/android<span class="token punctuation">"</span></span>
        <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.android.systemui<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>sharedUserId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.uid.system<span class="token punctuation">"</span></span>
        <span class="token attr-name">coreApp</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre>
<p>åœ¨ <code>AndroidManifest.xml</code> ä¸­ï¼Œå£°æ˜äº†ä¸€ä¸ªåä¸º <code>android:sharedUserId</code> çš„å±æ€§ï¼š<code>android.uid.systemui</code>ã€‚</p>
<p><strong><font color="#FF0000">æœ‰å¿…è¦èŠèŠè¿™ä¸ª â€œsharedUserIdâ€ çš„ä½œç”¨ï¼</font></strong></p>
<p>1ã€ä¸¤ä¸ªæˆ–å¤šä¸ªå£°æ˜äº†åŒä¸€ç§ <code>sharedUserId</code> çš„ <code>APK</code> å¯å…±äº«å½¼æ­¤çš„æ•°æ®ï¼Œå¹¶ä¸”å¯è¿è¡Œåœ¨åŒä¸€è¿›ç¨‹ä¸­ã€‚</p>
<p>2ã€é€šè¿‡å£°æ˜ç‰¹å®šçš„ <code>sharedUserId</code>ï¼Œè¯¥ <code>APK</code> æ‰€åœ¨ <code>è¿›ç¨‹</code> å°†è¢«èµ‹äºˆæŒ‡å®šçš„ <code>UID</code>ï¼ˆæ¯”å¦‚æœ¬ä¾‹ä¸­çš„ SystemUI å£°æ˜äº† system çš„ uidï¼Œè¿è¡Œ SystemUI çš„è¿›ç¨‹å°±å¯äº«å— system ç”¨æˆ·æ‰€å¯¹åº”çš„æƒé™ï¼‰ã€‚</p>
<blockquote>
<p>é™¤äº†åœ¨ <code>AndroidManifest.xml</code> ä¸­å£°æ˜ <code>sharedUserId</code> å¤–ï¼ŒAPK åœ¨ç¼–è¯‘æ—¶è¿˜å¿…é¡»ä½¿ç”¨å¯¹åº”çš„è¯ä¹¦è¿›è¡Œç­¾åã€‚ä¾‹å¦‚æœ¬ä¾‹çš„ <code>SystemUI</code>ï¼Œåœ¨å…¶ <code>Android.mk</code> ä¸­éœ€è¦é¢å¤–ç”³æ˜ <code>LOCAL_CERTIFICATE := platform</code>ï¼Œå¦‚æ­¤æ‰å¯ä»¥è·å¾—æŒ‡å®šçš„ <code>UID</code>ï¼ˆå½“ç„¶è¿™ä¸ªä¸æ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹ï¼Œåœ¨é¡¹ç›®å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šäº†è§£åˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚</p>
</blockquote>
<p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•ç»„ç»‡ä¸€ç§æ•°æ®ç»“æ„æ¥åŒ…æ‹¬ä¸Šé¢çš„å†…å®¹ã€‚</p>
<p><strong><font color="#FF0000">æœ‰ 3 ä¸ªå…³é”®ç‚¹éœ€è¦æ³¨æ„ï¼š</font></strong></p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ &nbsp;XML ä¸­ sharedUserId å±æ€§æŒ‡å®šäº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯ UID çš„å­—ç¬¦ä¸²æè¿°ï¼Œæ•…å¯¹åº”æ•°æ®ç»“æ„ä¸­ä¹Ÿåº”è¯¥æœ‰è¿™æ ·ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™æ ·å°±æŠŠä»£ç å’Œ XML ä¸­çš„å±æ€§è”ç³»èµ·æ¥äº†ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ &nbsp;åœ¨ LINUX ç³»ç»Ÿä¸­ï¼ŒçœŸæ­£çš„ uid æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ‰€ä»¥è¯¥æ•°æ®ç»“æ„ä¸­å¿…ç„¶æœ‰ä¸€ä¸ªæ•´å‹å˜é‡ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ &nbsp;å¤šä¸ª Package å¯å£°æ˜åŒä¸€ä¸ª sharedUserIdï¼Œå› æ­¤è¯¥æ•°æ®ç»“æ„å¿…ç„¶ä¼šä¿å­˜é‚£äº›å£°æ˜äº†ç›¸åŒ sharedUserId çš„ Package çš„æŸäº›ä¿¡æ¯ã€‚</p>
</blockquote>
<p>å¯¹ <strong><font color="#8470FF">SharedUserSetting</font></strong> æˆ‘ä»¬åšä¸ªæ€»ç»“ï¼š</p>
<p>1ã€<code>Settings</code> ç±»å®šä¹‰äº†ä¸€ä¸ª <code>mSharedUsers</code> æˆå‘˜ï¼Œå®ƒæ˜¯ä¸€ä¸ª <code>ArrayMap</code>ï¼Œä»¥ <code>å­—ç¬¦ä¸²</code>ï¼ˆå¦‚ï¼šandroid.uid.systemï¼‰ä¸º <code>key</code>ï¼Œå¯¹åº”çš„ <code>Value</code> æ˜¯ä¸€ä¸ª <code>SharedUserSetting</code> å¯¹è±¡ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> ArrayMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> SharedUserSetting<span class="token operator">></span> mSharedUsers <span class="token operator">=</span> 
                                          <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> SharedUserSetting<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2ã€<code>SharedUserSetting</code> å®šä¹‰äº†ä¸€ä¸ªæˆå‘˜å˜é‡ <code>packages</code>ï¼Œç±»å‹ä¸º <code>ArraySet</code>ï¼Œç”¨äºä¿å­˜å£°æ˜äº†ç›¸åŒ <code>sharedUserId</code> çš„ <code>Package</code> çš„æƒé™è®¾ç½®ä¿¡æ¯ï¼ˆè¿™ä¸€ç‚¹æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ï¼‰ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SharedUserSetting</span> <span class="token keyword">extends</span> <span class="token class-name">SettingBase</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> String name<span class="token punctuation">;</span>

    <span class="token keyword">int</span> userId<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// flags that are associated with this uid, regardless of any package flags</span>
    <span class="token keyword">int</span> uidFlags<span class="token punctuation">;</span>
    <span class="token keyword">int</span> uidPrivateFlags<span class="token punctuation">;</span>

    <span class="token keyword">final</span> ArraySet<span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span> packages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArraySet</span><span class="token operator">&lt;</span>PackageSetting<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>3ã€æ¯ä¸ª <code>Package</code> æœ‰è‡ªå·±çš„æƒé™è®¾ç½®ã€‚æƒé™çš„æ¦‚å¿µç”± <code>PackageSeting</code> ç±»è¡¨è¾¾ã€‚è¯¥ç±»ç»§æ‰¿è‡ª <code>PackageSettingBase</code> ç±»ï¼Œ<code>PackageSettingBase</code> åˆç»§æ‰¿è‡ª <code>SettingBase</code>ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PackageSetting</span> <span class="token keyword">extends</span> <span class="token class-name">PackageSettingBase</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PackageSettingBase</span> <span class="token keyword">extends</span> <span class="token class-name">SettingBase</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<p><code>SettingBase</code> å¯¹è±¡æŒæœ‰ <code>PermissionsState</code> å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºå¯ç”¨çš„æƒé™ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SettingBase</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> PermissionsState mPermissionsState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>4ã€<code>Settings</code> ä¸­è¿˜æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯ <code>mUserIds</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>mOtherUserIds</code>ï¼Œè¿™ä¸¤ä½æˆå‘˜çš„ç±»å‹åˆ†åˆ«æ˜¯ <code>ArrayList</code> å’Œ <code>SparseArray</code>ã€‚å…¶ç›®çš„æ˜¯ä»¥ <code>UID</code> ä¸ºç´¢å¼•ï¼Œå¾—åˆ°å¯¹åº”çš„ <code>SharedUserSeting</code> å¯¹è±¡ã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»¥ <code>ç´¢å¼•</code> è·å–<code>æ•°ç»„å…ƒç´ </code>çš„é€Ÿåº¦ï¼Œæ¯”ä»¥ <code>Key</code> è·å– <code>ArrayMap</code> ä¸­ <code>å…ƒç´ </code> çš„é€Ÿåº¦è¦å¿«å¾ˆå¤šã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Object<span class="token operator">></span> mUserIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> SparseArray<span class="token operator">&lt;</span>Object<span class="token operator">></span> mOtherUserIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="3-2-3-2-addUserIdLPw"><a href="#3-2-3-2-addUserIdLPw" class="headerlink" title="3.2.3.2 addUserIdLPw"></a>3.2.3.2 addUserIdLPw</h4><p>æˆ‘ä»¬å›å¿†ä¸€ä¸‹ addSharedUserLPw æ–¹æ³•ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/Settings.java</span>

SharedUserSetting <span class="token function">addSharedUserLPw</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> pkgPrivateFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SharedUserSetting s <span class="token operator">=</span> mSharedUsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedUserSetting</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pkgFlags<span class="token punctuation">,</span> pkgPrivateFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>userId <span class="token operator">=</span> uid<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addUserIdLPw</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> s<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mSharedUsers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æºç ä¸­è¿˜æœ‰ä¸€ä¸ª <code>addUserIdLPw</code> æ–¹æ³•ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯å°† <code>SharedUserSettings</code> å¯¹è±¡ä¿å­˜åˆ°å¯¹åº”çš„æ•°ç»„ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/services/core/java/com/android/server/pm/Settings.java</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addUserIdLPw</span><span class="token punctuation">(</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span> Object obj<span class="token punctuation">,</span> Object name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ç³»ç»Ÿæ‰€æ”¯æŒçš„æœ€å¤§çš„åº”ç”¨ Package çš„ UIDï¼Œä¸èƒ½è¶…å‡ºé™åˆ¶ 19999</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">></span> Process<span class="token punctuation">.</span>LAST_APPLICATION_UID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªåº”ç”¨ Packageï¼ˆéç³»ç»Ÿå®‰è£…åº”ç”¨ï¼‰çš„èµ·å§‹ UID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token operator">>=</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–æ•°ç»„çš„é•¿åº¦</span>
        <span class="token keyword">int</span> N <span class="token operator">=</span> mUserIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   
        <span class="token comment" spellcheck="true">// è®¡ç®—ç´¢å¼•ï¼Œå…¶å€¼æ˜¯ uid å’Œ FIRST_APPLICATION_UID çš„å·®</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> uid <span class="token operator">-</span> Process<span class="token punctuation">.</span>FIRST_APPLICATION_UID<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> N<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mUserIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            N<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ•°ç»„çš„ç›®æ ‡ç´¢å¼•å€¼ä½ç½®æœ‰ä¸ä¸º null çš„å€¼ï¼Œè¯´æ˜å·²ç»æ·»åŠ è¿‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mUserIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>
                    <span class="token string">"Adding duplicate user id: "</span> <span class="token operator">+</span> uid
                    <span class="token operator">+</span> <span class="token string">" name="</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åº”ç”¨ Package çš„ uid ç”± mUserIds ä¿å­˜</span>
        mUserIds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>                 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOtherUserIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PackageManagerService<span class="token punctuation">.</span><span class="token function">reportSettingsProblem</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span>
                    <span class="token string">"Adding duplicate shared id: "</span> <span class="token operator">+</span> uid
                            <span class="token operator">+</span> <span class="token string">" name="</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç³»ç»Ÿ Package çš„ uid ç”± mOtherUserIds ä¿å­˜</span>
        mOtherUserIds<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#FF0000">è‡³æ­¤å¯¹ Settings çš„åˆ†ææˆ‘ä»¬æš‚æ—¶å‘Šä¸€æ®µè½ã€‚</font></strong></p>
<h3 id="3-2-4-æ€»ç»“"><a href="#3-2-4-æ€»ç»“" class="headerlink" title="3.2.4 æ€»ç»“"></a>3.2.4 æ€»ç»“</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª SharedUserSettings çš„ç±»å›¾ï¼š(ç±»åæ”¹å˜ï¼ŒåæœŸé‡æ–°è¡¥å›¾)<br><br></p>
<p><center><img src="https://upload-images.jianshu.io/upload_images/3517194-6aeecba875f5450b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="20160929092228475.jpg"></center><br></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ<code>Settings</code> å¯¹è±¡ä¸­æŒæœ‰å¤šä¸ª <code>SharedUserSetting</code> å¯¹è±¡ï¼Œæ¯ä¸ª <code>SharedUserSetting</code> å¯¹è±¡åˆä¼šæŒæœ‰å¤šä¸ª <code>PackageSetting</code> å¯¹è±¡ã€‚</p>
<p>ä»ç»§æ‰¿å…³ç³»æ¥çœ‹ï¼Œ<code>SharedUserSetting</code> å’Œ <code>PackageSetting</code> å¯¹è±¡ï¼Œæœ€ç»ˆéƒ½å°†ç»§æ‰¿ <code>SettingBase</code> å¯¹è±¡ã€‚</p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ<code>SettingBase</code> å¯¹è±¡æŒæœ‰ <code>PermissionsState</code> å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºå¯ç”¨çš„æƒé™ã€‚</p>
<p>å› æ­¤ï¼Œ<code>SharedUserSetting</code> å¯¹è±¡å’Œ <code>PackageSetting</code> å¯¹è±¡ä¸­éƒ½å°†åŒ…å«æœ‰ <code>PermissionsState</code>ã€‚</p>
<p>ä»è€Œæˆ‘ä»¬å¯ä»¥æ®æ­¤æ¨æµ‹å‡ºï¼Œ<code>SharedUserSetting</code> ä¸­æŒæœ‰çš„æ˜¯ä¸€ç»„ <code>Package</code> å…±æœ‰çš„æƒé™ï¼›<code>PackageSetting</code> ä¸­æŒæœ‰çš„æ˜¯å•ä¸ª <code>Package</code> ç‹¬æœ‰çš„æƒé™ã€‚</p>
<hr>
<h2 id="3-3-XML-æ–‡ä»¶æ‰«æ"><a href="#3-3-XML-æ–‡ä»¶æ‰«æ" class="headerlink" title="3.3 XML æ–‡ä»¶æ‰«æ"></a>3.3 XML æ–‡ä»¶æ‰«æ</h2><p>åˆ†æå®Œ PMS æ„é€ å‡½æ•°å‰æœŸå·¥ä½œçš„ç¬¬ä¸€é˜¶æ®µåï¼Œæ¥ä¸‹æ¥å°±è¦ç»§ç»­å›åˆ°æ„é€ å‡½æ•°ä¸­åˆ†æå‰©ä¸‹çš„ä»£ç ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç ï¼šframeworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>

<span class="token keyword">public</span> <span class="token function">PackageManagerService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Installer installer<span class="token punctuation">,</span>
              <span class="token keyword">boolean</span> factoryTest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">// ç¬¬ä¸€é˜¶æ®µ</span>

    <span class="token comment" spellcheck="true">// è¯¥å€¼å’Œè°ƒè¯•æœ‰å…³ï¼Œä¸€èˆ¬ä¸è®¾ç½®è¯¥å±æ€§</span>
    String separateProcesses <span class="token operator">=</span> SystemProperties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"debug.separate_processes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>separateProcesses <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> separateProcesses<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>separateProcesses<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDefParseFlags <span class="token operator">=</span> PackageParser<span class="token punctuation">.</span>PARSE_IGNORE_PROCESSES<span class="token punctuation">;</span>
            mSeparateProcesses <span class="token operator">=</span> null<span class="token punctuation">;</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Running with debug.separate_processes: * (ALL)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mDefParseFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            mSeparateProcesses <span class="token operator">=</span> separateProcesses<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Running with debug.separate_processes: "</span> <span class="token operator">+</span> separateProcesses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mDefParseFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        mSeparateProcesses <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// å¯¹åº”ç”¨è¿›è¡Œ dexopt ä¼˜åŒ–çš„è¾…åŠ©ç±»</span>
    mPackageDexOptimizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageDexOptimizer</span><span class="token punctuation">(</span>installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">,</span> context<span class="token punctuation">,</span>
                                                   <span class="token string">"*dexopt*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DexManager<span class="token punctuation">.</span>Listener dexManagerListener <span class="token operator">=</span> DexLogger<span class="token punctuation">.</span><span class="token function">getListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> installer<span class="token punctuation">,</span>
                                                                   mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mDexManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mPackageDexOptimizer<span class="token punctuation">,</span> installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mArtManagerService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArtManagerService</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> installer<span class="token punctuation">,</span> mInstallLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mMoveCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MoveCallbacks</span><span class="token punctuation">(</span>FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mOnPermissionChangeListeners <span class="token operator">=</span> <span class="token keyword">new</span> 
                                   <span class="token class-name">OnPermissionChangeListeners</span><span class="token punctuation">(</span>FgThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// è·å–å½“å‰è®¾å¤‡çš„æ˜¾ç¤ºå±ä¿¡æ¯</span>
    <span class="token function">getDefaultDisplayMetrics</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// é€šè¿‡ SystemConfig è¯»å–ç³»ç»Ÿçš„ featureã€permession ç­‰é…ç½®ï¼Œ</span>
    <span class="token comment" spellcheck="true">// å¹¶åˆå§‹åŒ– mGlobalGids/mAvailableFeatures æˆå‘˜</span>
    SystemConfig systemConfig <span class="token operator">=</span> SystemConfig<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// é‡ç‚¹è®¨è®º</span>
    mAvailableFeatures <span class="token operator">=</span> systemConfig<span class="token punctuation">.</span><span class="token function">getAvailableFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mProtectedPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProtectedPackages</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
 <span class="token punctuation">}</span>
</code></pre>
<p>ä»¥ä¸Šä»£ç é™¤äº†åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„éœ€è¦å…³æ³¨çš„ç±»ï¼š<strong><font color="#FF0000">SystemConfig</font></strong>ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æçš„é‡ç‚¹ï¼ï¼ï¼</p>
<h3 id="3-3-1-SystemConfig"><a href="#3-3-1-SystemConfig" class="headerlink" title="3.3.1 SystemConfig"></a>3.3.1 SystemConfig</h3><p>æˆ‘ä»¬å…ˆæ¥åˆ†æ <strong><font color="#1874CD">SystemConfig systemConfig = SystemConfig.getInstance() </font></strong> å‡½æ•°ï¼</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span>

<span class="token comment" spellcheck="true">/**
 * Loads global system configuration info.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> SystemConfig sInstance<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> SystemConfig <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// å•ä¾‹æ¨¡å¼</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>SystemConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æŸ¥çœ‹å®ƒçš„æ„é€ å‡½æ•°ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span>

<span class="token comment" spellcheck="true">/**
 * é€šè¿‡ readPermissions() è¯»å–å¹¶è§£æ /system/etc/ã€€ç­‰ç›®å½•ä¸‹çš„ sysconfig.xmlã€permission.xml æ–‡ä»¶
 */</span>
<span class="token function">SystemConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Read configuration from system</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ALLOW_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Read configuration from the old permissions dir</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getRootDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ALLOW_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Vendors are only allowed to customze libs, features and privapp permissions</span>
    <span class="token keyword">int</span> vendorPermissionFlag <span class="token operator">=</span> ALLOW_LIBS <span class="token operator">|</span> ALLOW_FEATURES <span class="token operator">|</span> ALLOW_PRIVAPP_PERMISSIONS<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>FIRST_SDK_INT <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O_MR1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// For backward compatibility</span>
        vendorPermissionFlag <span class="token operator">|=</span> <span class="token punctuation">(</span>ALLOW_PERMISSIONS <span class="token operator">|</span> ALLOW_APP_CONFIGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vendorPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getVendorDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vendorPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Allow ODM to customize system configs as much as Vendor, because /odm is another</span>
    <span class="token comment" spellcheck="true">// vendor partition other than /vendor.</span>
    <span class="token keyword">int</span> odmPermissionFlag <span class="token operator">=</span> vendorPermissionFlag<span class="token punctuation">;</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getOdmDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> odmPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getOdmDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> odmPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Allow OEM to customize features and OEM permissions</span>
    <span class="token keyword">int</span> oemPermissionFlag <span class="token operator">=</span> ALLOW_FEATURES <span class="token operator">|</span> ALLOW_OEM_PERMISSIONS<span class="token punctuation">;</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oemPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getOemDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oemPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Allow Product to customize system configs around libs, features, permissions and apps</span>
    <span class="token keyword">int</span> productPermissionFlag <span class="token operator">=</span> ALLOW_LIBS <span class="token operator">|</span> ALLOW_FEATURES <span class="token operator">|</span> ALLOW_PERMISSIONS <span class="token operator">|</span>
            ALLOW_APP_CONFIGS <span class="token operator">|</span> ALLOW_PRIVAPP_PERMISSIONS<span class="token punctuation">;</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getProductDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"sysconfig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readPermissions</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">buildPath</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getProductDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"etc"</span><span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> productPermissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æˆ‘ä»¬å‘ç° <code>SystemConfig</code> çš„æ„é€ å‡½æ•°æ‰€åšçš„å·¥ä½œå°±æ˜¯ï¼š<code>readPermissions()</code>ï¼Œå³ä»æ–‡ä»¶ä¸­<code>è¯»å–æƒé™</code>ï¼</p>
<h3 id="3-3-2-readPermissions"><a href="#3-3-2-readPermissions" class="headerlink" title="3.3.2 readPermissions"></a>3.3.2 readPermissions</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ readPermissions çš„æºç ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span>

<span class="token keyword">void</span> <span class="token function">readPermissions</span><span class="token punctuation">(</span>File libraryDir<span class="token punctuation">,</span> <span class="token keyword">int</span> permissionFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// Iterate over the files in the directory and scan .xml files</span>
    File platformFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>File f <span class="token operator">:</span> libraryDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We'll read platform.xml last</span>
        <span class="token comment" spellcheck="true">// å¤„ç†è¯¥ç›®å½•ä¸‹çš„é platform.xml æ–‡ä»¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"etc/permissions/platform.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            platformFile <span class="token operator">=</span> f<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// è°ƒç”¨ readPermissionsFromXml è§£ææ­¤ XML æ–‡ä»¶</span>
        <span class="token function">readPermissionsFromXml</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> permissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Read platform permissions last so it will take precedence</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>platformFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œplatform.xmlæ–‡ä»¶çš„è§£æä¼˜å…ˆçº§æœ€é«˜ï¼</span>
        <span class="token function">readPermissionsFromXml</span><span class="token punctuation">(</span>platformFile<span class="token punctuation">,</span> permissionFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä»æºç ä¸­ï¼Œæˆ‘ä»¬å‘ç° <code>readPermissions</code> å‡½æ•°ä¸å°±æ˜¯è°ƒç”¨ <code>readPermissionFromXml</code> å‡½æ•°è§£æ <code>&quot;/xxx/etc/permissions/&quot;</code> ç›®å½•ä¸‹çš„æ–‡ä»¶å—ï¼Ÿ</p>
<p>è¿™äº›æ–‡ä»¶ä¼¼ä¹éƒ½æ˜¯ XML æ–‡ä»¶ã€‚ä½ ä¹Ÿè®¸æœ‰ä¸ªç–‘é—®ï¼Ÿè¯¥ç›®å½•ä¸‹éƒ½æœ‰å“ªäº› XML æ–‡ä»¶ï¼Ÿè¿™äº› XML æ–‡ä»¶ä¸­æœ‰äº›ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿ<strong><font color="#63B8FF">ä»¥æˆ‘æ‰‹ä¸­çš„ pixel ä¸ºä¾‹</font></strong>ï¼š</p>
<pre><code>sailfish:/system/etc/permissions $ ls -al
ls -al
total 168
drwxr-xr-x  2 root root  4096 2009-01-01 16:00 .
drwxr-xr-x 14 root root  4096 2009-01-01 16:00 ..
-rw-r--r--  1 root root  1050 2009-01-01 16:00 android.software.live_wallpaper.xml
-rw-r--r--  1 root root   748 2009-01-01 16:00 android.software.webview.xml
-rw-r--r--  1 root root  1778 2009-01-01 16:00 com.android.ims.rcsmanager.xml
-rw-r--r--  1 root root   828 2009-01-01 16:00 com.android.location.provider.xml
-rw-r--r--  1 root root   828 2009-01-01 16:00 com.android.media.remotedisplay.xml
-rw-r--r--  1 root root   820 2009-01-01 16:00 com.android.mediadrm.signer.xml
-rw-r--r--  1 root root   158 2009-01-01 16:00 com.android.omadm.service.xml
-rw-r--r--  1 root root   435 2009-01-01 16:00 com.android.sdm.plugins.connmo.xml
-rw-r--r--  1 root root   701 2009-01-01 16:00 com.android.sdm.plugins.sprintdm.xml
-rw-r--r--  1 root root   234 2009-01-01 16:00 com.android.vzwomatrigger.xml
-rw-r--r--  1 root root  1079 2009-01-01 16:00 com.customermobile.preload.vzw.xml
-rw-r--r--  1 root root   850 2009-01-01 16:00 com.google.android.camera.experimental2016.xml
-rw-r--r--  1 root root   563 2009-01-01 16:00 com.google.android.dialer.support.xml
-rw-r--r--  1 root root   816 2009-01-01 16:00 com.google.android.maps.xml
-rw-r--r--  1 root root   835 2009-01-01 16:00 com.google.android.media.effects.xml
-rw-r--r--  1 root root   811 2009-01-01 16:00 com.google.vr.platform.xml
-rw-r--r--  1 root root   160 2009-01-01 16:00 com.verizon.apn.xml
-rw-r--r--  1 root root   158 2009-01-01 16:00 com.verizon.embms.xml
-rw-r--r--  1 root root   288 2009-01-01 16:00 com.verizon.llkagent.xml
-rw-r--r--  1 root root   174 2009-01-01 16:00 com.verizon.provider.xml
-rw-r--r--  1 root root   220 2009-01-01 16:00 com.verizon.services.xml
-rw-r--r--  1 root root   239 2009-01-01 16:00 features-verizon.xml
-rw-r--r--  1 root root   811 2009-01-01 16:00 obdm_permissions.xml
-rw-r--r--  1 root root  8916 2009-01-01 16:00 platform.xml
-rw-r--r--  1 root root 23092 2009-01-01 16:00 privapp-permissions-google.xml
-rw-r--r--  1 root root  1346 2009-01-01 16:00 privapp-permissions-marlin.xml
-rw-r--r--  1 root root 20848 2009-01-01 16:00 privapp-permissions-platform.xml
-rw-r--r--  1 root root  1587 2009-01-01 16:00 vzw_mvs_permissions.xml
sailfish:/system/etc/permissions $
</code></pre><p>æ—¢ç„¶æˆ‘ä»¬ä¸Šé¢ä¸€ç›´åœ¨è¯´ platform.xml è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£å°±çœ‹ä¸‹ <strong><font color="#FF0000">platform.xml</font></strong> æœ‰ä»€ä¹ˆï¼š</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permissions</span><span class="token punctuation">></span></span>

    <span class="token comment" spellcheck="true">&lt;!-- å»ºç«‹æƒé™åä¸ gid çš„æ˜ å°„å…³ç³»ã€‚å¦‚ä¸‹é¢å£°æ˜çš„ BLUETOOTH_ADMIN æƒé™ï¼Œ
         å®ƒå¯¹åº”çš„ç”¨æˆ·ç»„æ˜¯ net_bt_adminã€‚æ³¨æ„ï¼Œè¯¥æ–‡ä»¶ä¸­çš„ permission æ ‡ç­¾åªå¯¹
         é‚£äº›éœ€è¦é€šè¿‡è¯»å†™è®¾å¤‡ï¼ˆè“ç‰™/cametaï¼‰/åˆ›å»º socket ç­‰è¿›ç¨‹åˆ’åˆ†äº† gidã€‚
         å› ä¸ºè¿™äº›æƒé™æ¶‰åŠå’Œ Linux å†…æ ¸äº¤äº’ï¼Œæ‰€ä»¥éœ€è¦åœ¨åº•å±‚æƒé™ï¼ˆç”±ä¸ç”¨çš„ç”¨æˆ·ç»„ç•Œå®šï¼‰
         å’Œ Android å±‚æƒé™ï¼ˆç”±ä¸åŒçš„å­—ç¬¦ä¸²ç•Œå®šï¼‰ä¹‹é—´å»ºç«‹æ˜ å°„å…³ç³»ã€‚ --></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.BLUETOOTH_ADMIN<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_bt_admin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permission</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.BLUETOOTH<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>net_bt<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permission</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.BLUETOOTH_STACK<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bluetooth<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wakelock<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uhid<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permission</span><span class="token punctuation">></span></span>

    ... ...

    <span class="token comment" spellcheck="true">&lt;!-- èµ‹äºˆå¯¹åº” uid ç›¸åº”çš„æƒé™ã€‚å¦‚æœä¸‹é¢ä¸€è¡Œè¡¨ç¤º uid ä¸º audioserverï¼Œé‚£ä¹ˆå°±
         èµ‹äºˆå®ƒ WAKE_LOCK çš„æƒé™ï¼Œå…¶å®å°±æ˜¯æŠŠå®ƒåŠ åˆ°å¯¹åº”çš„ç”¨æˆ·ç»„ä¸­ --></span>

    ... ...

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.MODIFY_AUDIO_SETTINGS<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.ACCESS_SURFACE_FLINGER<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.WAKE_LOCK<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.UPDATE_DEVICE_STATS<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assign-permission</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.UPDATE_APP_OPS_STATS<span class="token punctuation">"</span></span> <span class="token attr-name">uid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>audioserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

    ... ...

    <span class="token comment" spellcheck="true">&lt;!-- This is a list of all the libraries available for application
         code to link against. --></span>

    <span class="token comment" spellcheck="true">&lt;!-- ç³»ç»Ÿæä¾›çš„ Java åº“ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œæ—¶å¿…é¡»è¦é“¾æ¥è¿™äº›åº“ï¼Œè¯¥å·¥ä½œç”±ç³»ç»Ÿè‡ªåŠ¨å®Œæˆ --></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.test.mock<span class="token punctuation">"</span></span>
            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/android.test.mock.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.test.runner<span class="token punctuation">"</span></span>
            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/android.test.runner.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javax.obex<span class="token punctuation">"</span></span>
            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/javax.obex.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>library</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.http.legacy<span class="token punctuation">"</span></span>
            <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/system/framework/org.apache.http.legacy.jar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

    ... ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>permissions</span><span class="token punctuation">></span></span>
</code></pre>
<p>platform.xml æ–‡ä»¶ä¸­ä¸»è¦ä½¿ç”¨äº†å¦‚ä¸‹ <strong><font color="#FF0000">4 ä¸ªæ ‡ç­¾</font></strong>ï¼š</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#87CEFA">permission</font></strong> å’Œ <strong><font color="#87CEFA">group</font></strong> ç”¨äºå»ºç«‹ Linux å±‚ gid å’Œ Andrid å±‚ permission ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#87CEFA">assign-permission</font></strong> ç”¨äºå‘æŒ‡å®šçš„ uid èµ‹äºˆç›¸åº”çš„æƒé™ã€‚è¿™ä¸ªæƒé™ç”± Android å®šä¹‰ï¼Œç”¨äºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;âœ¨&nbsp;<strong><font color="#87CEFA">library</font></strong> ç”¨äºæŒ‡å®šç³»ç»Ÿåº“ã€‚å½“åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºè¿™äº›è¿›ç¨‹åŠ è½½è¿™äº›åº“ã€‚</p>
<p>ä¸çŸ¥é“ä½ æ˜¯å¦å·²ç»äº§ç”Ÿäº†ç–‘é—®ï¼Ÿè®¾å¤‡ä¸Šçš„ /system/etc/permission ç›®å½•ä¸­çš„æ–‡ä»¶æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿæˆ‘ç›´æ¥å‘Šè¯‰ä½ ç­”æ¡ˆï¼šåœ¨ç¼–è¯‘é˜¶æ®µç”±ä¸ç”¨ç¡¬ä»¶å¹³å°æ ¹æ®è‡ªå·±çš„é…ç½®ä¿¡æ¯å¤åˆ¶ç›¸å…³æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•ä¸­çš„æ¥çš„ã€‚ï¼ˆè¿™ä¸ªå…·ä½“æˆ‘ä»¬ä¸è®¨è®ºï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ï¼‰ </p>
<h3 id="3-3-3-readPermissionFromXML"><a href="#3-3-3-readPermissionFromXML" class="headerlink" title="3.3.3 readPermissionFromXML"></a>3.3.3 readPermissionFromXML</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼š<code>readPermissions</code> å‡½æ•°å…¶å®å°±æ˜¯è°ƒç”¨ <code>readPermissionFromXml</code> å‡½æ•°è§£æ <code>&quot;/xxx/etc/permissions/&quot;</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼</p>
<p>readPermissionFromXml åˆæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿå…¶å®å®ƒçš„ä½œç”¨å°±æ˜¯å°† XML æ–‡ä»¶ä¸­çš„æ ‡ç­¾ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»è½¬æ¢æˆä»£ç ä¸­çš„ç›¸åº”æ•°æ®ç»“æ„ï¼Œç›´æ¥çœ‹æºç ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æºç è·¯å¾„ï¼šframeworks/base/core/java/com/android/server/SystemConfig.java</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readPermissionsFromXml</span><span class="token punctuation">(</span>File permFile<span class="token punctuation">,</span> <span class="token keyword">int</span> permissionFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FileReader permReader <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">final</span> <span class="token keyword">boolean</span> lowRam <span class="token operator">=</span> ActivityManager<span class="token punctuation">.</span><span class="token function">isLowRamDeviceStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        XmlPullParser parser <span class="token operator">=</span> Xml<span class="token punctuation">.</span><span class="token function">newPullParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        parser<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>permReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            String name <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æ group æ ‡ç­¾</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"group"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String gidStr <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"gid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>gidStr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> gid <span class="token operator">=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Process<span class="token punctuation">.</span><span class="token function">getGidForName</span><span class="token punctuation">(</span>gidStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è½¬æ¢ XML ä¸­çš„ gid å­—ç¬¦ä¸²ä¸ºæ•´å‹ï¼Œå¹¶ä¿å­˜åˆ° mGlobalGidsä¸­</span>
                    mGlobalGids <span class="token operator">=</span> <span class="token function">appendInt</span><span class="token punctuation">(</span>mGlobalGids<span class="token punctuation">,</span> gid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Slog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"&lt;group> without gid in "</span> <span class="token operator">+</span> permFile <span class="token operator">+</span> <span class="token string">" at "</span>
                            <span class="token operator">+</span> parser<span class="token punctuation">.</span><span class="token function">getPositionDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æ permissionæ ‡ç­¾</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"permission"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowPermissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String perm <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>perm <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                perm <span class="token operator">=</span> perm<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è°ƒç”¨ readPermission å¤„ç†</span>
                <span class="token function">readPermission</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æ assign-permission æ ‡ç­¾</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"assign-permission"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowPermissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String perm <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                String uidStr <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ assign-permissionï¼Œåˆ™å–å‡º uid å­—ç¬¦ä¸²ï¼Œç„¶åè·å¾— Linux å¹³å°ä¸Šçš„æ•´å‹ uid å€¼</span>
                <span class="token keyword">int</span> uid <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getUidForName</span><span class="token punctuation">(</span>uidStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                perm <span class="token operator">=</span> perm<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// å’Œ assign ç›¸å…³çš„ä¿¡æ¯ä¿å­˜åœ¨ mSystemPermissions ä¸­</span>
                ArraySet<span class="token operator">&lt;</span>String<span class="token operator">></span> perms <span class="token operator">=</span> mSystemPermissions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>perms <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    perms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArraySet</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mSystemPermissions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> perms<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                perms<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æ library æ ‡ç­¾</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"library"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowLibs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String lname <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String lfile <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lname <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lfile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token comment" spellcheck="true">// å°† XML ä¸­çš„ name å’Œ library å±æ€§å€¼å­˜å‚¨åˆ° mSharedLibraries ä¸­</span>
                    mSharedLibraries<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lname<span class="token punctuation">,</span> lfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                XmlUtils<span class="token punctuation">.</span><span class="token function">skipCurrentTag</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æ featureæ ‡ç­¾</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"feature"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowFeatures<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String fname <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">getAttributeValue</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> fversion <span class="token operator">=</span> XmlUtils<span class="token punctuation">.</span><span class="token function">readIntAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> allowed<span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"unavailable-feature"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> allowFeatures<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment" spellcheck="true">// è§£æå…¶å®ƒæ ‡ç­¾</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong><font color="#FF0000">readPermission å‡½æ•°æœç„¶æ˜¯å°† XML ä¸­çš„æ ‡ç­¾è½¬æ¢æˆå¯¹åº”çš„æ•°æ®ç»“æ„ï¼ï¼ï¼</font></strong></p>
<hr>
<h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p>&nbsp;ğŸ“• 01. <a href="https://www.2cto.com/kf/201609/551752.html" target="_blank" rel="noopener">Android 7.0 PackageManagerService (2) â€“ PKMS æ„é€ å‡½æ•°çš„ä¸»è¦å·¥ä½œ</a><br>&nbsp;ğŸ“• 02. <a href="https://www.jianshu.com/p/8e2831428110" target="_blank" rel="noopener">APK å®‰è£…æµç¨‹è¯¦è§£ 7 â€“ PackageManagerService çš„å¯åŠ¨æµç¨‹(ä¸Š)</a></p>
<hr>
<h1 id="ç´¢å¼•é“¾æ¥"><a href="#ç´¢å¼•é“¾æ¥" class="headerlink" title="ç´¢å¼•é“¾æ¥"></a>ç´¢å¼•é“¾æ¥</h1><p>æ¨èè·³è½¬ï¼š<a href="https://superandroid.pro/2019/12/31/%E3%80%8AThinking%20in%20Android%E3%80%8B%20--%2001.%20%E5%8D%9A%E5%AE%A2%E7%B4%A2%E5%BC%95/">åšå®¢ç´¢å¼•ï¼ˆAndroid 9.0ï¼‰</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://superandroid.pro/2019/01/05/%E3%80%90%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E3%80%91Android%20%E6%A1%86%E6%9E%B6%E6%9C%8D%E5%8A%A1%E7%AF%87%20--%20%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6%20PMS%20%E7%B3%BB%E5%88%97%EF%BC%882%EF%BC%89%E4%B9%8B%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/">Framework æ ¸å¿ƒæœåŠ¡ä¹‹ PMS é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</a></p>

            </div>
            <hr>

            

            <!--<link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>å¾®ä¿¡é‡Œç‚¹â€œå‘ç°â€->â€œæ‰«ä¸€æ‰«â€äºŒç»´ç ä¾¿å¯æŸ¥çœ‹åˆ†äº«ã€‚</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>-->

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;è½¬è½½è¯·æ³¨æ˜:
                    </span>
                    <a href="https://superandroid.pro" class="b-link-green">Thinking in Android</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/01/01/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-1-qi-dong-liu-cheng/" class="b-link-green">PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC8zNzY5OS8xNDIzMA">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScriptã€‚</noscript>
    </div>
    <!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
</div>
    

    

    <!--

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2019/01/05/02.kuang-jia-he-xin-fu-wu-android-kuang-jia-fu-wu-pian-packagemanagerservice-zuan-yan-2-gou-zao-han-shu/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/PackageManagerService.jpg" class="responsive-img" alt="PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°">
                        
                        <span class="card-title">PackageManagerService é’»ç ”ï¼ˆ2ï¼‰- æ„é€ å‡½æ•°</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
PackageManagerService ç³»åˆ—æ–‡ç« å¦‚ä¸‹ï¼ˆåŸºäº Android 9.0 æºç ï¼‰



&nbsp;
ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ PackageManagerService é’»ç ”ï¼ˆ1ï¼‰- å¯åŠ¨æµç¨‹





ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ä¹‹ Packag</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-01-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/æ¡†æ¶æœåŠ¡/" class="post-category" target="_blank">
                                    æ¡†æ¶æœåŠ¡
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PackageManagerService/" target="_blank">
                        <span class="chip bg-color">PackageManagerService</span>
                    </a>
                    
                    <a href="/tags/PMS-æ„é€ å‡½æ•°/" target="_blank">
                        <span class="chip bg-color">PMS æ„é€ å‡½æ•°</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/12/26/01.xi-tong-qi-dong-jie-duan-android-xi-tong-qi-dong-pian-shen-ru-zuan-yan-android-qi-dong-jie-duan-zhi-launcher/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/ç³»ç»Ÿå¯åŠ¨-02.jpg" class="responsive-img" alt="æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨å’ŒåŠ è½½">
                        
                        <span class="card-title">æ·±å…¥é’»ç ” Android å¯åŠ¨é˜¶æ®µ ä¹‹ Launcher å¯åŠ¨å’ŒåŠ è½½</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ ğŸ€ Android å¯åŠ¨é˜¶æ®µç³»åˆ—ğŸ€ ğŸ€ ğŸ€ ğŸ€ </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-12-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/ç³»ç»Ÿå¯åŠ¨/" class="post-category" target="_blank">
                                    ç³»ç»Ÿå¯åŠ¨
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Launcher/" target="_blank">
                        <span class="chip bg-color">Launcher</span>
                    </a>
                    
                    <a href="/tags/å¯åŠ¨é˜¶æ®µ/" target="_blank">
                        <span class="chip bg-color">å¯åŠ¨é˜¶æ®µ</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>-->
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: Thinking in Android<br />'
            + 'ä½œè€…: Marco<br />'
            + 'é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>
    

</main>


<footer class="page-footer bg-color-foot-marco">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
		    &copy; 2018 - 2019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In-depth analysis of Android system source code &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-graduation-cap" aria-hidden="true"></i>&nbsp;&nbsp;Marco<br>
            
			
                
                <span id="busuanzi_container_site_pv">
                    Total visits to this site: <span id="busuanzi_value_site_pv"></span> ,&nbsp;
                </span>
				<span id="busuanzi_container_site_uv">
                    Total visitor: <span id="busuanzi_value_site_uv"></span> .
                </span>
			
		</div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/pepsimaxin/pepsimaxin.github.io" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:pepsimaxin@163.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=516749232" class="tooltipped" data-tooltip="QQè”ç³»æˆ‘: 516749232" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


<!--
    <a href="https://blog.csdn.net/pepsimaxin" class="tooltipped" data-tooltip="è®¿é—®æˆ‘çš„CSDN" data-position="top" data-delay="50">
        <i class="fa fa-chain-broken"></i>
    </a>
-->


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<!--<div class="progress-bar"></div>-->

<!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;æ£€ç´¢åšæ–‡</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„æŠ€æœ¯å…³é”®å­—" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<!--<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>-->


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->




    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>